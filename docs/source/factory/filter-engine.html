<!DOCTYPE html>

<html>
<head>
  <title>Scrawl-canvas filter engine</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animation-loop.html">
                  ./source/core/animation-loop.js
                </a>
              
                
                <a class="source" href="../core/display-cycle.html">
                  ./source/core/display-cycle.js
                </a>
              
                
                <a class="source" href="../core/document-root-elements.html">
                  ./source/core/document-root-elements.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/random-seed.html">
                  ./source/core/random-seed.js
                </a>
              
                
                <a class="source" href="../core/shared-vars.html">
                  ./source/core/shared-vars.js
                </a>
              
                
                <a class="source" href="../core/snippets.html">
                  ./source/core/snippets.js
                </a>
              
                
                <a class="source" href="../core/system-flags.html">
                  ./source/core/system-flags.js
                </a>
              
                
                <a class="source" href="../core/user-interaction.html">
                  ./source/core/user-interaction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="array-pool.html">
                  ./source/factory/array-pool.js
                </a>
              
                
                <a class="source" href="bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell-fragment.html">
                  ./source/factory/cell-fragment.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="cog.html">
                  ./source/factory/cog.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="conic-gradient.html">
                  ./source/factory/conic-gradient.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="crescent.html">
                  ./source/factory/crescent.js
                </a>
              
                
                <a class="source" href="drag-zone.html">
                  ./source/factory/drag-zone.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="filter-engine-bluenoise-data.html">
                  ./source/factory/filter-engine-bluenoise-data.js
                </a>
              
                
                <a class="source" href="filter-engine.html">
                  ./source/factory/filter-engine.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="font-attributes.html">
                  ./source/factory/font-attributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="image-asset.html">
                  ./source/factory/image-asset.js
                </a>
              
                
                <a class="source" href="keyboard-zone.html">
                  ./source/factory/keyboard-zone.js
                </a>
              
                
                <a class="source" href="line-spiral.html">
                  ./source/factory/line-spiral.js
                </a>
              
                
                <a class="source" href="line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="mesh.html">
                  ./source/factory/mesh.js
                </a>
              
                
                <a class="source" href="net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="noise-asset.html">
                  ./source/factory/noise-asset.js
                </a>
              
                
                <a class="source" href="observe-update.html">
                  ./source/factory/observe-update.js
                </a>
              
                
                <a class="source" href="oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="particle-force.html">
                  ./source/factory/particle-force.js
                </a>
              
                
                <a class="source" href="particle-history.html">
                  ./source/factory/particle-history.js
                </a>
              
                
                <a class="source" href="particle-spring.html">
                  ./source/factory/particle-spring.js
                </a>
              
                
                <a class="source" href="particle-world.html">
                  ./source/factory/particle-world.js
                </a>
              
                
                <a class="source" href="particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radial-gradient.html">
                  ./source/factory/radial-gradient.js
                </a>
              
                
                <a class="source" href="raw-asset.html">
                  ./source/factory/raw-asset.js
                </a>
              
                
                <a class="source" href="reaction-diffusion-asset.html">
                  ./source/factory/reaction-diffusion-asset.js
                </a>
              
                
                <a class="source" href="rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="render-animation.html">
                  ./source/factory/render-animation.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="sprite-asset.html">
                  ./source/factory/sprite-asset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstacked-element.html">
                  ./source/factory/unstacked-element.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="video-asset.html">
                  ./source/factory/video-asset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset-advanced-functionality.html">
                  ./source/mixin/asset-advanced-functionality.js
                </a>
              
                
                <a class="source" href="../mixin/asset-consumer.html">
                  ./source/mixin/asset-consumer.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/cell-key-functions.html">
                  ./source/mixin/cell-key-functions.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/display-shape.html">
                  ./source/mixin/display-shape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shape-basic.html">
                  ./source/mixin/shape-basic.js
                </a>
              
                
                <a class="source" href="../mixin/shape-curve.html">
                  ./source/mixin/shape-curve.js
                </a>
              
                
                <a class="source" href="../mixin/shape-path-calculation.html">
                  ./source/mixin/shape-path-calculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../scrawl.html">
                  ./source/scrawl.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h1 id="scrawl-canvas-filter-engine">Scrawl-canvas filter engine</h1>
<p>All Scrawl-canvas filters-related image manipulation work happens in this engine code. Note that this functionality is entirely separate from the &lt;canvas&gt; element’s context engine’s native <code>filter</code> functionality, which allows us to add CSS/SVG-based filters to the canvas context</p>
<ul>
<li>Note that prior to v8.5.0 most of this code lived in an (asynchronous) web worker. Web worker functionality has now been removed from Scrawl-canvas as it was not adding sufficient efficiency to rendering speed</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-keyword">import</span> { constructors, filter, filternames, styles, stylesnames } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/library.js&#x27;</span>;

<span class="hljs-keyword">import</span> { seededRandomNumberGenerator } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/random-seed.js&#x27;</span>;

<span class="hljs-keyword">import</span> { correctAngle, doCreate, easeEngines, isa_fn } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/utilities.js&#x27;</span>;

<span class="hljs-keyword">import</span> { makeAnimation } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./animation.js&#x27;</span>;

<span class="hljs-keyword">import</span> { releaseCell, requestCell } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./cell-fragment.js&#x27;</span>;

<span class="hljs-keyword">import</span> { releaseCoordinate, requestCoordinate } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./coordinate.js&#x27;</span>;

<span class="hljs-keyword">import</span> { releaseArray, requestArray } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./array-pool.js&#x27;</span>;

<span class="hljs-keyword">import</span> { makeColor } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./color.js&#x27;</span>;

<span class="hljs-keyword">import</span> { bluenoise } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./filter-engine-bluenoise-data.js&#x27;</span>;

<span class="hljs-keyword">import</span> { _abs, _ceil, _entries, _exp, _floor, _freeze, _isArray, _keys, _max, _min, _now, _round, _sqrt, <span class="hljs-variable constant_">ALPHA_TO_CHANNELS</span>, <span class="hljs-variable constant_">AREA_ALPHA</span>, <span class="hljs-variable constant_">ARG_SPLITTER</span>, <span class="hljs-variable constant_">AVERAGE_CHANNELS</span>, <span class="hljs-variable constant_">BLACK_WHITE</span>, <span class="hljs-variable constant_">BLEND</span>, <span class="hljs-variable constant_">BLUE</span>, <span class="hljs-variable constant_">BLUENOISE</span>, <span class="hljs-variable constant_">BLUR</span>, <span class="hljs-variable constant_">CHANNELS_TO_ALPHA</span>, <span class="hljs-variable constant_">CHROMA</span>, <span class="hljs-variable constant_">CLAMP_CHANNELS</span>, <span class="hljs-variable constant_">CLEAR</span>, <span class="hljs-variable constant_">COLOR</span>, <span class="hljs-variable constant_">COLOR_BURN</span>, <span class="hljs-variable constant_">COLOR_DODGE</span>, <span class="hljs-variable constant_">COLORS_TO_ALPHA</span>, <span class="hljs-variable constant_">COMPOSE</span>, <span class="hljs-variable constant_">CORRODE</span>, <span class="hljs-variable constant_">CURRENT</span>, <span class="hljs-variable constant_">DARKEN</span>, <span class="hljs-variable constant_">DEFAULT_SEED</span>, <span class="hljs-variable constant_">DESTINATION_ATOP</span>, <span class="hljs-variable constant_">DESTINATION_IN</span>, <span class="hljs-variable constant_">DESTINATION_ONLY</span>, <span class="hljs-variable constant_">DESTINATION_OUT</span>, <span class="hljs-variable constant_">DESTINATION_OVER</span>, <span class="hljs-variable constant_">DIFFERENCE</span>, <span class="hljs-variable constant_">DISPLACE</span>, <span class="hljs-variable constant_">DOWN</span>, <span class="hljs-variable constant_">EMBOSS</span>, <span class="hljs-variable constant_">EXCLUSION</span>, <span class="hljs-variable constant_">FLOOD</span>, <span class="hljs-variable constant_">GAUSSIAN_BLUR</span>, <span class="hljs-variable constant_">GLITCH</span>, <span class="hljs-variable constant_">GRAY_PALETTES</span>, <span class="hljs-variable constant_">GRAYSCALE</span>, <span class="hljs-variable constant_">GREEN</span>, <span class="hljs-variable constant_">HARD_LIGHT</span>, <span class="hljs-variable constant_">HEX_GRID</span>, <span class="hljs-variable constant_">HUE</span>, <span class="hljs-variable constant_">INVERT_CHANNELS</span>, <span class="hljs-variable constant_">LIGHTEN</span>, <span class="hljs-variable constant_">LIGHTER</span>, <span class="hljs-variable constant_">LOCK_CHANNELS_TO_LEVELS</span>, <span class="hljs-variable constant_">LUMINOSITY</span>, <span class="hljs-variable constant_">MAP_TO_GRADIENT</span>, <span class="hljs-variable constant_">MATRIX</span>, <span class="hljs-variable constant_">MEAN</span>, <span class="hljs-variable constant_">MODULATE_CHANNELS</span>, <span class="hljs-variable constant_">MONOCHROME_16</span>, <span class="hljs-variable constant_">MONOCHROME_4</span>, <span class="hljs-variable constant_">MONOCHROME_8</span>, <span class="hljs-variable constant_">MULTIPLY</span>, <span class="hljs-variable constant_">NEWSPRINT</span>, <span class="hljs-variable constant_">OFFSET</span>, <span class="hljs-variable constant_">ORDERED</span>, <span class="hljs-variable constant_">OVERLAY</span>, <span class="hljs-variable constant_">PIXELATE</span>, <span class="hljs-variable constant_">POINTS_ARRAY</span>, <span class="hljs-variable constant_">PROCESS_IMAGE</span>, <span class="hljs-variable constant_">RANDOM</span>, <span class="hljs-variable constant_">RANDOM_NOISE</span>, <span class="hljs-variable constant_">RANDOM_POINTS</span>, <span class="hljs-variable constant_">RECT_GRID</span>, <span class="hljs-variable constant_">RED</span>, <span class="hljs-variable constant_">REDUCE_PALETTE</span>, <span class="hljs-variable constant_">ROUND</span>, <span class="hljs-variable constant_">SATURATION</span>, <span class="hljs-variable constant_">SCREEN</span>, <span class="hljs-variable constant_">SET_CHANNEL_TO_LEVEL</span>, <span class="hljs-variable constant_">SOFT_LIGHT</span>, <span class="hljs-variable constant_">SOURCE</span>, <span class="hljs-variable constant_">SOURCE_ALPHA</span>, <span class="hljs-variable constant_">SOURCE_ATOP</span>, <span class="hljs-variable constant_">SOURCE_IN</span>, <span class="hljs-variable constant_">SOURCE_ONLY</span>, <span class="hljs-variable constant_">SOURCE_OUT</span>, <span class="hljs-variable constant_">STEP_CHANNELS</span>, <span class="hljs-variable constant_">SWIRL</span>, <span class="hljs-variable constant_">T_FILTER_ENGINE</span>, <span class="hljs-variable constant_">THRESHOLD</span>, <span class="hljs-variable constant_">TILES</span>, <span class="hljs-variable constant_">TINT_CHANNELS</span>, <span class="hljs-variable constant_">UNSET</span>, <span class="hljs-variable constant_">UP</span>, <span class="hljs-variable constant_">USER_DEFINED_LEGACY</span>, <span class="hljs-variable constant_">VARY_CHANNELS_BY_WEIGHTS</span>, <span class="hljs-variable constant_">XOR</span>, <span class="hljs-variable constant_">ZERO_STR</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/shared-vars.js&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Local constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> orderedNoise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>([<span class="hljs-number">0.00</span>,<span class="hljs-number">0.50</span>,<span class="hljs-number">0.13</span>,<span class="hljs-number">0.63</span>,<span class="hljs-number">0.03</span>,<span class="hljs-number">0.53</span>,<span class="hljs-number">0.16</span>,<span class="hljs-number">0.66</span>,<span class="hljs-number">0.75</span>,<span class="hljs-number">0.25</span>,<span class="hljs-number">0.88</span>,<span class="hljs-number">0.38</span>,<span class="hljs-number">0.78</span>,<span class="hljs-number">0.28</span>,<span class="hljs-number">0.91</span>,<span class="hljs-number">0.41</span>,<span class="hljs-number">0.19</span>,<span class="hljs-number">0.69</span>,<span class="hljs-number">0.06</span>,<span class="hljs-number">0.56</span>,<span class="hljs-number">0.22</span>,<span class="hljs-number">0.72</span>,<span class="hljs-number">0.09</span>,<span class="hljs-number">0.59</span>,<span class="hljs-number">0.94</span>,<span class="hljs-number">0.44</span>,<span class="hljs-number">0.81</span>,<span class="hljs-number">0.31</span>,<span class="hljs-number">0.97</span>,<span class="hljs-number">0.47</span>,<span class="hljs-number">0.84</span>,<span class="hljs-number">0.34</span>,<span class="hljs-number">0.05</span>,<span class="hljs-number">0.55</span>,<span class="hljs-number">0.17</span>,<span class="hljs-number">0.67</span>,<span class="hljs-number">0.02</span>,<span class="hljs-number">0.52</span>,<span class="hljs-number">0.14</span>,<span class="hljs-number">0.64</span>,<span class="hljs-number">0.80</span>,<span class="hljs-number">0.30</span>,<span class="hljs-number">0.92</span>,<span class="hljs-number">0.42</span>,<span class="hljs-number">0.77</span>,<span class="hljs-number">0.27</span>,<span class="hljs-number">0.89</span>,<span class="hljs-number">0.39</span>,<span class="hljs-number">0.23</span>,<span class="hljs-number">0.73</span>,<span class="hljs-number">0.11</span>,<span class="hljs-number">0.61</span>,<span class="hljs-number">0.20</span>,<span class="hljs-number">0.70</span>,<span class="hljs-number">0.08</span>,<span class="hljs-number">0.58</span>,<span class="hljs-number">0.98</span>,<span class="hljs-number">0.48</span>,<span class="hljs-number">0.86</span>,<span class="hljs-number">0.36</span>,<span class="hljs-number">0.95</span>,<span class="hljs-number">0.45</span>,<span class="hljs-number">0.83</span>,<span class="hljs-number">0.33</span>]);

<span class="hljs-keyword">const</span> newspaperPatterns = <span class="hljs-title function_">_freeze</span>([
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">180</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">180</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">180</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">180</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">0</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">255</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">255</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">255</span>,<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">255</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">180</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">180</span>]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>])
]);

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOW_ARRAY</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0</span>]);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HIGH_ARRAY</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>The filter Color object - used by various filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> colorEngine = <span class="hljs-title function_">makeColor</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;SC-system-filter-do-not-remove&#x27;</span>,
});</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <h4 id="filterengine-constructor">FilterEngine constructor</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> <span class="hljs-title class_">FilterEngine</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h3 id="transactional-variables">Transactional variables</h3>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p><strong>cache</strong> - an Object consisting of <code>key:Object</code> pairs where the key is the named input of a <code>process-image</code> action or the output of any action object. This object is cleared and re-initialized each time the <code>engine.action</code> function is invoked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p><strong>actions</strong> - the Array of action objects that the engine needs to process - data supplied by the main thread in its message’s <code>packetFiltersArray</code> attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span> = [];

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h4 id="filterengine-prototype">FilterEngine prototype</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> P = <span class="hljs-title class_">FilterEngine</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title function_">doCreate</span>();
P.<span class="hljs-property">type</span> = <span class="hljs-variable constant_">T_FILTER_ENGINE</span>;

<span class="hljs-keyword">let</span> choke = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> setFilterMemoizationChoke = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) {

    <span class="hljs-keyword">if</span> (val.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(val) &amp;&amp; val &gt;= <span class="hljs-number">200</span> &amp;&amp; val &lt;= <span class="hljs-number">10000</span>) choke = val;
};

P.<span class="hljs-property">action</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">packet</span>) {

    <span class="hljs-keyword">const</span> { identifier, filters, image } = packet;

    <span class="hljs-keyword">const</span> { workstoreLastAccessed, workstore, actions, theBigActionsObject } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">const</span> workstoreKeys = <span class="hljs-title function_">_keys</span>(workstore),
        workstoreChoke = <span class="hljs-title function_">_now</span>() - choke;

    <span class="hljs-keyword">let</span> i, iz, s, actData, a;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = workstoreKeys.<span class="hljs-property">length</span>, s; i &lt; iz; i++) {

        s = workstoreKeys[i];

        <span class="hljs-keyword">if</span> (workstoreLastAccessed[s] &lt; workstoreChoke) {

            <span class="hljs-keyword">delete</span> workstore[s];
            <span class="hljs-keyword">delete</span> workstoreLastAccessed[s];
        }
    }

    <span class="hljs-keyword">if</span> (identifier &amp;&amp; workstore[identifier]) {

        workstoreLastAccessed[identifier] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[identifier];
    }

    actions.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = filters.<span class="hljs-property">length</span>; i &lt; iz; i++) {

        actions.<span class="hljs-title function_">push</span>(...filters[i].<span class="hljs-property">actions</span>)
    }

    <span class="hljs-keyword">const</span> actionsLen = actions.<span class="hljs-property">length</span>;

    <span class="hljs-keyword">if</span> (actionsLen) {

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unknit</span>(image);

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; actionsLen; i++) {

            actData = actions[i];
            a = theBigActionsObject[actData.<span class="hljs-property">action</span>];

            <span class="hljs-keyword">if</span> (a) a.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, actData);
        }

        <span class="hljs-keyword">if</span> (identifier) {

            workstore[identifier] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>;
            workstoreLastAccessed[identifier] = <span class="hljs-title function_">_now</span>();
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>;
    }
    <span class="hljs-keyword">return</span> image;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <h3 id="permanent-variables">Permanent variables</h3>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>The filter engine maintains a semi-permanent storage space - the <strong>workstore</strong> - for some processing objects that are computationally expensive, for instance grids, matrix reference data objects, etc. The engine also maintains a record of when each of these processing objects was last accessed and will remove objects if they have not been accessed in the last three seconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">workstore</span> = {};
P.<span class="hljs-property">workstoreLastAccessed</span> = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>ColorSpaceIndices are used by the reducePalette filter. Hoping to expand this to other filters to allow a wider use of OKLAB/OKLCH color spaces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">colorSpaceIndices</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx</span>) {

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx</span> = <span class="hljs-number">256</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx2</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx</span> * <span class="hljs-number">256</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx3</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx2</span> * <span class="hljs-number">256</span>;

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">indicesLen</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx3</span> * <span class="hljs-number">3</span>;

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">labIndicesMultiplier</span> = <span class="hljs-number">512</span>;

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">rgbIndices</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">indicesLen</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">labIndices</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">indicesLen</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">indicesMemoRecord</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tfx3</span>);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p><code>unknit</code> - called at the start of each new message action chain. Creates and populates the <strong>source</strong> and <strong>work</strong> objects from the image data supplied in the message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">unknit</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">image</span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = {};

    <span class="hljs-keyword">const</span> cache = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>;

    <span class="hljs-keyword">const</span> { width, height, data } = image;

    cache.<span class="hljs-property">source</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(data, width, height);
    cache.<span class="hljs-property">work</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(data, width, height);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p><code>getAlphaData</code> - extract alpha channel data from (usually the source) ImageData object and populate the color channels of a new ImageData object with that data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getAlphaData</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">image</span>) {

    <span class="hljs-keyword">const</span> {width, height, <span class="hljs-attr">data</span>:iData} = image;

    <span class="hljs-keyword">const</span> len = iData.<span class="hljs-property">length</span>;

    <span class="hljs-keyword">const</span> sourceAlpha = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(width, height),
        aData = sourceAlpha.<span class="hljs-property">data</span>;

    <span class="hljs-keyword">let</span> a, i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

        a = iData[i + <span class="hljs-number">3</span>];
        aData[i] = <span class="hljs-number">0</span>;
        aData[i + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
        aData[i + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        aData[i + <span class="hljs-number">3</span>] = (a &gt; <span class="hljs-number">0</span>) ? <span class="hljs-number">255</span> : <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">return</span> sourceAlpha;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h3 id="functions-invoked-by-a-range-of-different-action-functions">Functions invoked by a range of different action functions</h3>
<p><code>buildImageGrid</code> creates an Array of Arrays which contain the indexes of each pixel in the image channel Arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildImageGrid</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">image</span>) {

    <span class="hljs-keyword">const</span> { cache, workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!image) image = cache.<span class="hljs-property">source</span>;

    <span class="hljs-keyword">const</span> { width, height } = image

    <span class="hljs-keyword">if</span> (width &amp;&amp; height) {

        <span class="hljs-keyword">const</span> name = <span class="hljs-string">`grid-<span class="hljs-subst">${width}</span>-<span class="hljs-subst">${height}</span>`</span>;
        <span class="hljs-keyword">if</span> (workstore[name]) {
            workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
            <span class="hljs-keyword">return</span> workstore[name];
        }

        <span class="hljs-keyword">const</span> grid = [];

        <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>,
            row, x, y;

        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; height; y++) {

            row = [];

            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; width; x++) {

                row.<span class="hljs-title function_">push</span>(counter);
                counter++;
            }
            grid.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>(row));
        }
        workstore[name] = <span class="hljs-title function_">_freeze</span>(grid);
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p><code>getOrAddWorkstore</code> creates an Array which can be populated by swirl-related coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getOrAddWorkstore</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) {

    <span class="hljs-keyword">const</span> { workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (workstore[name]) {
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }

    workstore[name] = [];
    workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
    <span class="hljs-keyword">return</span> workstore[name];
};

P.<span class="hljs-property">getRandomNumbers</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) {

    <span class="hljs-keyword">const</span> {
        seed = <span class="hljs-variable constant_">DEFAULT_SEED</span>,
        length = <span class="hljs-number">0</span>,
        imgWidth = <span class="hljs-number">0</span>,
        type = <span class="hljs-variable constant_">RANDOM</span>,
    } = items;

    <span class="hljs-keyword">const</span> name = <span class="hljs-string">`random-<span class="hljs-subst">${seed}</span>-<span class="hljs-subst">${length}</span>-<span class="hljs-subst">${type}</span>`</span>;

    <span class="hljs-keyword">const</span> { workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (workstore[name]) {
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }

    <span class="hljs-keyword">const</span> vals = <span class="hljs-title function_">requestArray</span>();

    <span class="hljs-keyword">let</span> i, j, k, temp, currentRow;

    <span class="hljs-keyword">if</span> (type == <span class="hljs-variable constant_">BLUENOISE</span> &amp;&amp; imgWidth) {

        <span class="hljs-keyword">const</span> bLen = bluenoise.<span class="hljs-property">length</span>,
            blueDims = <span class="hljs-title function_">_sqrt</span>(bLen),
            imgHeight = length / imgWidth,
            bLines = <span class="hljs-title function_">requestArray</span>();

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; bLen; i += blueDims) {

            temp = bluenoise.<span class="hljs-title function_">slice</span>(i, i + blueDims);
            bLines.<span class="hljs-title function_">push</span>(temp);
        }

        <span class="hljs-keyword">for</span> (i = imgHeight; i &gt; <span class="hljs-number">0</span>; i -= blueDims) {

            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; blueDims; j++) {

                currentRow = bLines[j];

                <span class="hljs-keyword">for</span> (k = imgWidth; k &gt; <span class="hljs-number">0</span>; k -= blueDims) {

                    <span class="hljs-keyword">if</span> (k &lt; blueDims) vals.<span class="hljs-title function_">push</span>(...currentRow.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, k));
                    <span class="hljs-keyword">else</span> vals.<span class="hljs-title function_">push</span>(...currentRow);
                }
            }
        }
        <span class="hljs-title function_">releaseArray</span>(bLines);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-variable constant_">ORDERED</span> &amp;&amp; imgWidth) {

        <span class="hljs-keyword">const</span> oLen = orderedNoise.<span class="hljs-property">length</span>,
            oDims = <span class="hljs-title function_">_sqrt</span>(oLen),
            imgHeight = length / imgWidth,
            oLines = <span class="hljs-title function_">requestArray</span>();

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; oLen; i += oDims) {

            temp = orderedNoise.<span class="hljs-title function_">slice</span>(i, i + oDims);
            oLines.<span class="hljs-title function_">push</span>(temp);
        }

        <span class="hljs-keyword">for</span> (i = imgHeight; i &gt; <span class="hljs-number">0</span>; i -= oDims) {

            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; oDims; j++) {

                currentRow = oLines[j];

                <span class="hljs-keyword">for</span> (k = imgWidth; k &gt; <span class="hljs-number">0</span>; k -= oDims) {

                    <span class="hljs-keyword">if</span> (k &lt; oDims) vals.<span class="hljs-title function_">push</span>(...currentRow.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, k));
                    <span class="hljs-keyword">else</span> vals.<span class="hljs-title function_">push</span>(...currentRow);
                }
            }
        }
        <span class="hljs-title function_">releaseArray</span>(oLines);
    }
    <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">const</span> engine = <span class="hljs-title function_">seededRandomNumberGenerator</span>(seed);

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++) {

            vals.<span class="hljs-title function_">push</span>(engine.<span class="hljs-title function_">random</span>());
        }
    }

    workstore[name] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(vals);
    workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();

    <span class="hljs-title function_">releaseArray</span>(vals);

    <span class="hljs-keyword">return</span> workstore[name];
};

P.<span class="hljs-property">buildImageCoordinateLookup</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">image</span>) {

    <span class="hljs-keyword">const</span> { cache, workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!image) image = cache.<span class="hljs-property">source</span>;

    <span class="hljs-keyword">const</span> { width, height } = image

    <span class="hljs-keyword">if</span> (width &amp;&amp; height) {

        <span class="hljs-keyword">const</span> name = <span class="hljs-string">`coords-lookup-<span class="hljs-subst">${width}</span>-<span class="hljs-subst">${height}</span>`</span>;

        <span class="hljs-keyword">if</span> (workstore[name]) {
            workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
            <span class="hljs-keyword">return</span> workstore[name];
        }

        <span class="hljs-keyword">const</span> lookup = []

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) {

                lookup.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>([x, y]));
            }
        }
        workstore[name] = <span class="hljs-title function_">_freeze</span>(lookup);
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p><code>buildAlphaTileSets</code> - creates a record of which pixels belong to which tile - used for manipulating alpha channel values. Resulting object will be cached in the store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildAlphaTileSets</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">tileWidth, tileHeight, gutterWidth, gutterHeight, offsetX, offsetY, areaAlphaLevels, image</span>) {

    <span class="hljs-keyword">const</span> { cache, workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!image) image = cache.<span class="hljs-property">source</span>;

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight } = image;

    <span class="hljs-keyword">if</span> (iWidth &amp;&amp; iHeight) {

        tileWidth = (tileWidth.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileWidth)) ? tileWidth : <span class="hljs-number">1</span>;
        tileHeight = (tileHeight.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileHeight)) ? tileHeight : <span class="hljs-number">1</span>;
        gutterWidth = (gutterWidth.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(gutterWidth)) ? gutterWidth : <span class="hljs-number">1</span>;
        gutterHeight = (gutterHeight.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(gutterHeight)) ? gutterHeight : <span class="hljs-number">1</span>;
        offsetX = (offsetX.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(offsetX)) ? offsetX : <span class="hljs-number">0</span>;
        offsetY = (offsetY.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(offsetY)) ? offsetY : <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (tileWidth &lt; <span class="hljs-number">1</span>) tileWidth = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileHeight &lt; <span class="hljs-number">1</span>) tileHeight = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileWidth + gutterWidth &gt;= iWidth) tileWidth = iWidth - gutterWidth - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileHeight + gutterHeight &gt;= iHeight) tileHeight = iHeight - gutterHeight - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (tileWidth &lt; <span class="hljs-number">1</span>) tileWidth = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileHeight &lt; <span class="hljs-number">1</span>) tileHeight = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileWidth + gutterWidth &gt;= iWidth) gutterWidth = iWidth - tileWidth - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileHeight + gutterHeight &gt;= iHeight) gutterHeight = iHeight - tileHeight - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">const</span> aWidth = tileWidth + gutterWidth,
            aHeight = tileHeight + gutterHeight;

        <span class="hljs-keyword">if</span> (offsetX &lt; <span class="hljs-number">0</span>) offsetX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (offsetX &gt;= aWidth) offsetX = aWidth - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (offsetY &lt; <span class="hljs-number">0</span>) offsetY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (offsetY &gt;= aHeight) offsetY = aHeight - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">const</span> name = <span class="hljs-string">`alphatileset-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileWidth}</span>-<span class="hljs-subst">${tileHeight}</span>-<span class="hljs-subst">${gutterWidth}</span>-<span class="hljs-subst">${gutterHeight}</span>-<span class="hljs-subst">${offsetX}</span>-<span class="hljs-subst">${offsetY}</span>`</span>;

        <span class="hljs-keyword">if</span> (workstore[name]) {
            workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
            <span class="hljs-keyword">return</span> workstore[name];
        }

        <span class="hljs-keyword">const</span> tiles = [];

        <span class="hljs-keyword">let</span> hold, i, iz, j, jz, x, xz, y, yz;

        <span class="hljs-keyword">for</span> (j = offsetY - aHeight, jz = iHeight; j &lt; jz; j += aHeight) {

            <span class="hljs-keyword">for</span> (i = offsetX - aWidth, iz = iWidth; i &lt; iz; i += aWidth) {

                hold = [];
                <span class="hljs-keyword">for</span> (y = j, yz = j + tileHeight; y &lt; yz; y++) {
                    <span class="hljs-keyword">if</span> (y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; iHeight) {
                        <span class="hljs-keyword">for</span> (x = i, xz = i + tileWidth; x &lt; xz; x++) {
                            <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; iWidth) hold.<span class="hljs-title function_">push</span>((((y * iWidth) + x) * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>);
                        }
                    }
                }
                tiles.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>([].<span class="hljs-title function_">concat</span>(hold)));

                hold = [];
                <span class="hljs-keyword">for</span> (y =  j + tileHeight, yz = j + tileHeight + gutterHeight; y &lt; yz; y++) {
                    <span class="hljs-keyword">if</span> (y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; iHeight) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = i, xz = i + tileWidth; x &lt; xz; x++) {
                            <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; iWidth) hold.<span class="hljs-title function_">push</span>((((y * iWidth) + x) * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>);
                        }
                    }
                }
                tiles.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>([].<span class="hljs-title function_">concat</span>(hold)));

                hold = [];
                <span class="hljs-keyword">for</span> (y = j, yz = j + tileHeight; y &lt; yz; y++) {
                    <span class="hljs-keyword">if</span> (y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; iHeight) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = i + tileWidth, xz = i + tileWidth + gutterWidth; x &lt; xz; x++) {
                            <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; iWidth) hold.<span class="hljs-title function_">push</span>((((y * iWidth) + x) * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>);
                        }
                    }
                }
                tiles.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>([].<span class="hljs-title function_">concat</span>(hold)));

                hold = [];
                <span class="hljs-keyword">for</span> (y =  j + tileHeight, yz = j + tileHeight + gutterHeight; y &lt; yz; y++) {
                    <span class="hljs-keyword">if</span> (y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; iHeight) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = i + tileWidth, xz = i + tileWidth + gutterWidth; x &lt; xz; x++) {
                            <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; iWidth) hold.<span class="hljs-title function_">push</span>((((y * iWidth) + x) * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>);
                        }
                    }
                }
                tiles.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>([].<span class="hljs-title function_">concat</span>(hold)));
            }
        }
        workstore[name] = <span class="hljs-title function_">_freeze</span>(tiles);
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p><code>buildImageTileSets</code> - creates a record of which pixels belong to which tile - used for manipulating color channels values. Resulting object will be cached in the store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildImageTileSets</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">tileWidth, tileHeight, offsetX, offsetY, image</span>) {

    <span class="hljs-keyword">const</span> { cache, workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!image) image = cache.<span class="hljs-property">source</span>;

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight } = image;

    <span class="hljs-keyword">if</span> (iWidth &amp;&amp; iHeight) {

        tileWidth = (tileWidth.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileWidth)) ? tileWidth : <span class="hljs-number">1</span>;
        tileHeight = (tileHeight.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileHeight)) ? tileHeight : <span class="hljs-number">1</span>;
        offsetX = (offsetX.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(offsetX)) ? offsetX : <span class="hljs-number">0</span>;
        offsetY = (offsetY.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(offsetY)) ? offsetY : <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (tileWidth &lt; <span class="hljs-number">1</span>) tileWidth = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileWidth &gt;= iWidth) tileWidth = iWidth - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileHeight &lt; <span class="hljs-number">1</span>) tileHeight = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (tileHeight &gt;= iHeight) tileHeight = iHeight - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (offsetX &lt; <span class="hljs-number">0</span>) offsetX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (offsetX &gt;= tileWidth) offsetX = tileWidth - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (offsetY &lt; <span class="hljs-number">0</span>) offsetY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (offsetY &gt;= tileHeight) offsetY = tileHeight - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">const</span> name = <span class="hljs-string">`simple-tileset-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileWidth}</span>-<span class="hljs-subst">${tileHeight}</span>-<span class="hljs-subst">${offsetX}</span>-<span class="hljs-subst">${offsetY}</span>`</span>;

        <span class="hljs-keyword">if</span> (workstore[name]) {
            workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
            <span class="hljs-keyword">return</span> workstore[name];
        }

        <span class="hljs-keyword">const</span> tiles = [];

        <span class="hljs-keyword">let</span> i, iz, j, jz, x, xz, y, yz, hold;

        <span class="hljs-keyword">for</span> (j = offsetY - tileHeight, jz = iHeight; j &lt; jz; j += tileHeight) {

            <span class="hljs-keyword">for</span> (i = offsetX - tileWidth, iz = iWidth; i &lt; iz; i += tileWidth) {

                hold = [];

                <span class="hljs-keyword">for</span> (y = j, yz = j + tileHeight; y &lt; yz; y++) {

                    <span class="hljs-keyword">if</span> (y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; iHeight) {

                        <span class="hljs-keyword">for</span> (x = i, xz = i + tileWidth; x &lt; xz; x++) {

                            <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; iWidth) hold.<span class="hljs-title function_">push</span>(((y * iWidth) + x) * <span class="hljs-number">4</span>);
                        }
                    }
                }
                <span class="hljs-keyword">if</span> (hold.<span class="hljs-property">length</span>) tiles.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>(hold));
            }
        }
        workstore[name] = <span class="hljs-title function_">_freeze</span>(tiles);
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> tiles;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p><code>buildGeneralTileSets</code> - separate the available space into a set of groups (tiles) and assign pixels to each group. Each tile centers on a <code>point</code> - an x/y coordinate; the calculations assign each pixel in the image to the group whose point it is closest to. Resulting object will be cached in the store</p>
<ul>
<li>Used by the <code>tile</code> filter, but separated out as the data it generates may have uses elsewhere</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildGeneralTileSets</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">pointVals, tileWidth, tileHeight, tileRadius, offsetX, offsetY, angle, seed, image</span>) {

    <span class="hljs-keyword">const</span> { cache, workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!image) image = cache.<span class="hljs-property">source</span>;
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight } = image;

    <span class="hljs-keyword">if</span> (iWidth &amp;&amp; iHeight) {

        <span class="hljs-keyword">let</span> tileW = <span class="hljs-number">1</span>,
            tileH = <span class="hljs-number">1</span>,
            tileR = <span class="hljs-number">1</span>,
            offX = <span class="hljs-number">0</span>,
            offY = <span class="hljs-number">0</span>,
            ang = <span class="hljs-number">0</span>,
            req = <span class="hljs-variable constant_">UNSET</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>The <code>pointVals</code> data can be supplied in a number of different formats:</p>
<ul>
<li>As a String: <code>&#39;rect-grid&#39;</code> - the function will calculate a set of suitable points based on the source image’s dimensions, and the user-defined <code>tileWidth</code>, <code>tileHeight</code>, <code>offsetX</code>, <code>offsetY</code> and <code>angle</code> arguments. This results in a rectangular grid of tiles (at most dimensions) which can be rotated to the required angle.</li>
<li>As a String: <code>&#39;hex-grid&#39;</code> - the function will calculate a set of suitable points based on the source image’s dimensions, and the user-defined <code>tileHeight</code>, <code>tileRadius</code>, <code>offsetX</code>, <code>offsetY</code> and <code>angle</code> arguments. This results in a hexagonal grid of tiles (at most dimensions) which can be rotated to the required angle. The shape of the hexagons in the grid depend on the interplay between the <code>tileHeight</code> and <code>tileRadius</code> values.</li>
<li>As a positive integer Number - this is a request by the user for the function to semi-randomly generate a set of points to the given value, constrained to an area determined by the <code>tileRadius</code>, <code>offsetX</code>, <code>offsetY</code> and <code>angle</code> arguments. Unlike other versions, this version will only include pixels within the bounds of circle of the given radius centered on the supplied offset coordinate values. To vary the randomness of point generation, the user can supply a <code>seed</code> argument, used when initializing the pseudo-random number generator.</li>
<li>As an Array of Numbers, which represent user-defined points across the image. Pixel selection for each point is constrained by the supplied <code>tileRadius</code>, <code>offsetX</code> and <code>offsetY</code> arguments.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (pointVals.<span class="hljs-property">substring</span>) req = pointVals;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">_isArray</span>(pointVals)) req = <span class="hljs-variable constant_">POINTS_ARRAY</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pointVals.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(pointVals)) req = <span class="hljs-variable constant_">RANDOM_POINTS</span>;

        <span class="hljs-keyword">if</span> (req == <span class="hljs-variable constant_">UNSET</span>) <span class="hljs-keyword">return</span> [];</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>The <code>tileWidth</code>, <code>tileHeight</code>, <code>tileRadius</code>, <code>offsetX</code> and <code>offsetY</code> arguments can be supplied as absolute Number values (in px), or as a String % value relative to the source image dimensions.</p>
<ul>
<li><code>tileRadius</code> is relative to the source image’s width</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (tileWidth.<span class="hljs-property">substring</span>) tileW = <span class="hljs-title function_">_round</span>((<span class="hljs-built_in">parseFloat</span>(tileWidth) / <span class="hljs-number">100</span>) * iWidth);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tileWidth.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileWidth)) tileW = tileWidth;
        <span class="hljs-keyword">if</span> (tileW &lt; <span class="hljs-number">1</span>) tileW = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (tileHeight.<span class="hljs-property">substring</span>) tileH = <span class="hljs-title function_">_round</span>((<span class="hljs-built_in">parseFloat</span>(tileHeight) / <span class="hljs-number">100</span>) * iHeight);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tileHeight.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileHeight)) tileH = tileHeight;
        <span class="hljs-keyword">if</span> (tileH &lt; <span class="hljs-number">1</span>) tileH = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (tileRadius.<span class="hljs-property">substring</span>) tileR = <span class="hljs-title function_">_round</span>((<span class="hljs-built_in">parseFloat</span>(tileRadius) / <span class="hljs-number">100</span>) * iWidth);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tileRadius.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(tileRadius)) tileR = tileRadius;
        <span class="hljs-keyword">if</span> (tileR &lt; <span class="hljs-number">1</span>) tileR = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (offsetX.<span class="hljs-property">substring</span>) offX = <span class="hljs-title function_">_round</span>((<span class="hljs-built_in">parseFloat</span>(offsetX) / <span class="hljs-number">100</span>) * iWidth);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offsetX.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(offsetX)) offX = offsetX;
        <span class="hljs-keyword">if</span> (offX &lt; <span class="hljs-number">0</span>) offX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offX &gt;= iWidth) offX = iWidth - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (offsetY.<span class="hljs-property">substring</span>) offY = <span class="hljs-title function_">_round</span>((<span class="hljs-built_in">parseFloat</span>(offsetY) / <span class="hljs-number">100</span>) * iHeight);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offsetY.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(offsetY)) offY = offsetY;
        <span class="hljs-keyword">if</span> (offY &lt; <span class="hljs-number">0</span>) offY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offY &gt;= iHeight) offY = iHeight - <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>The <code>angle</code> argument is the rotation applied to the points (using the offset coordinate as the rotation point), measured in degrees.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (angle.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(angle)) ang = angle;

        <span class="hljs-keyword">let</span> name = <span class="hljs-string">`<span class="hljs-subst">${req}</span>-tileset-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileW}</span>-<span class="hljs-subst">${tileH}</span>-<span class="hljs-subst">${tileR}</span>-<span class="hljs-subst">${offX}</span>-<span class="hljs-subst">${offY}</span>-<span class="hljs-subst">${ang}</span>`</span>;
        <span class="hljs-keyword">if</span> (req == <span class="hljs-variable constant_">POINTS_ARRAY</span>) name += <span class="hljs-string">`-<span class="hljs-subst">${pointVals.join(ARG_SPLITTER)}</span>`</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req == <span class="hljs-variable constant_">RANDOM_POINTS</span>) name += <span class="hljs-string">`-<span class="hljs-subst">${pointVals}</span>-<span class="hljs-subst">${seed}</span>`</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>To save time, previous invocations of the function store their end result - an Array of Arrays containing the index position of each pixel in the source image, assigned to each tile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (workstore[name]) {

            workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
            <span class="hljs-keyword">return</span> workstore[name];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>Returning an empty array to the tile filter results in the filter taking no action beyond copying the input image data into the output image data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (req == <span class="hljs-variable constant_">RECT_GRID</span> &amp;&amp; tileW === <span class="hljs-number">1</span> &amp;&amp; tileH === <span class="hljs-number">1</span>) {

            workstore[name] = [];
            workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
            <span class="hljs-keyword">return</span> [];
        }

        <span class="hljs-keyword">const</span> coord = <span class="hljs-title function_">requestCoordinate</span>(),
            origin = [offX, offY],
            test = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>];

        <span class="hljs-keyword">let</span> tiles = [],
            points = [];

        <span class="hljs-keyword">const</span> referencePoints = [],
            neighbourPoints = [];

        <span class="hljs-keyword">let</span> h, hz, w, wz, x, xz, y, yz,
            pointsName = <span class="hljs-variable constant_">ZERO_STR</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>Check to stop the hex grid breaking when user supplies an inappropriately low <code>tileHeight</code> argument value, compared to the value supplied in the <code>tileRadius</code> argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (req == <span class="hljs-variable constant_">HEX_GRID</span> &amp;&amp; tileH / tileR &lt; <span class="hljs-number">1.05</span>) tileH = tileR * <span class="hljs-number">1.05</span>;

        <span class="hljs-keyword">const</span> halfW = <span class="hljs-title function_">_floor</span>(tileW / <span class="hljs-number">2</span>),
            halfH = <span class="hljs-title function_">_floor</span>(tileH / <span class="hljs-number">2</span>),
            doubleR = tileR * <span class="hljs-number">2</span>,
            hexDown = <span class="hljs-title function_">_round</span>((tileH / tileR) * tileR);

        <span class="hljs-keyword">let</span> i, iz, cursor, ref,
            counter = <span class="hljs-number">0</span>,
            hexOffset = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">switch</span> (req) {

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">RECT_GRID</span> :

                pointsName = <span class="hljs-string">`rect-grid-points-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileW}</span>-<span class="hljs-subst">${tileH}</span>-<span class="hljs-subst">${offX}</span>-<span class="hljs-subst">${offY}</span>`</span>;

                <span class="hljs-keyword">if</span> (workstore[pointsName]) {

                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    points = workstore[pointsName];
                }
                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>Generates a set of initial points in an overlarge grid (for square tiles)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">for</span> (y = offY - (iHeight * <span class="hljs-number">2</span>) + halfH, yz = offY + (iHeight * <span class="hljs-number">2</span>) + halfH; y &lt; yz; y += tileH) {

                        <span class="hljs-keyword">for</span> (x = offX - (iWidth * <span class="hljs-number">2</span>) + halfW, xz = offX + (iWidth * <span class="hljs-number">2</span>) + halfW; x &lt; xz; x += tileW) {

                            points.<span class="hljs-title function_">push</span>(x, y);
                        }
                    }
                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    workstore[pointsName] = <span class="hljs-title function_">_freeze</span>(points);
                    points = workstore[pointsName];
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">HEX_GRID</span> :

                pointsName = <span class="hljs-string">`hex-grid-points-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileR}</span>-<span class="hljs-subst">${offX}</span>-<span class="hljs-subst">${offY}</span>`</span>;

                <span class="hljs-keyword">if</span> (workstore[pointsName]) {

                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    points = workstore[pointsName];
                }
                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>Generates a set of initial points in an overlarge grid (for hexagonal tiles)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    counter = <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">for</span> (y = offY - (iHeight * <span class="hljs-number">2</span>) + tileR, yz = offY + (iHeight * <span class="hljs-number">2</span>) + tileR; y &lt; yz; y += hexDown) {

                        hexOffset = (counter % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) ? tileR : <span class="hljs-number">0</span>;

                        <span class="hljs-keyword">for</span> (x = offX - (iWidth * <span class="hljs-number">2</span>) + tileR + hexOffset, xz = offX + (iWidth * <span class="hljs-number">2</span>) + tileR; x &lt; xz; x += doubleR) {

                            points.<span class="hljs-title function_">push</span>(x, y);
                        }
                        counter++;
                    }
                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    workstore[pointsName] = <span class="hljs-title function_">_freeze</span>(points);
                    points = workstore[pointsName];
                }
                tileW = doubleR * <span class="hljs-number">2</span>;
                tileH = hexDown * <span class="hljs-number">2</span>;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">RANDOM_POINTS</span> :

                pointsName = <span class="hljs-string">`random-points-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileR}</span>-<span class="hljs-subst">${offX}</span>-<span class="hljs-subst">${offY}</span>-<span class="hljs-subst">${points}</span>-<span class="hljs-subst">${seed}</span>`</span>;

                <span class="hljs-keyword">if</span> (workstore[pointsName]) {

                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    points = workstore[pointsName];
                }
                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>Generates a set of initial random points withing the given constraints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">const</span> rnd = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRandomNumbers</span>({
                        seed,
                        <span class="hljs-attr">length</span>: pointVals * <span class="hljs-number">3</span>,
                    });
                    <span class="hljs-keyword">let</span> rndCursor = -<span class="hljs-number">1</span>;

                    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; pointVals; i++) {

                        coord.<span class="hljs-title function_">zero</span>().<span class="hljs-title function_">add</span>([rnd[++rndCursor], rnd[++rndCursor]]).<span class="hljs-title function_">rotate</span>(rnd[++rndCursor] * <span class="hljs-number">360</span>).<span class="hljs-title function_">rotate</span>(ang).<span class="hljs-title function_">scalarMultiply</span>(tileR);

                        [x, y] = coord;
                        points.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_round</span>(x), <span class="hljs-title function_">_round</span>(y));
                    }
                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    workstore[pointsName] = <span class="hljs-title function_">_freeze</span>(points);
                    points = workstore[pointsName];
                }
                tileW = tileR;
                tileH = tileR;
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POINTS_ARRAY</span> :

                pointsName = <span class="hljs-string">`defined-points-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${tileR}</span>-<span class="hljs-subst">${pointVals}</span>`</span>;

                <span class="hljs-keyword">if</span> (workstore[pointsName]) {

                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    points = workstore[pointsName];
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>User-generated points are not pre-processed. Note that the positioning of these points is relative to the offset coordinate values; users, when generating the point values, need to take this into account otherwise the end result may unexpectedly move towards (or beyond) the bottom-right part of the final image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">else</span> {

                    points.<span class="hljs-title function_">push</span>(...pointVals);

                    workstoreLastAccessed[pointsName] = <span class="hljs-title function_">_now</span>();
                    workstore[pointsName] = <span class="hljs-title function_">_freeze</span>(points);
                    points = workstore[pointsName];
                }

                tileW = tileR;
                tileH = tileR;
                <span class="hljs-keyword">break</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>Go through initial set of points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        counter = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = points.<span class="hljs-property">length</span>; i &lt; iz; i += <span class="hljs-number">2</span>) {

            test[<span class="hljs-number">0</span>] = points[i];
            test[<span class="hljs-number">1</span>] = points[i + <span class="hljs-number">1</span>];

            coord.<span class="hljs-title function_">zero</span>().<span class="hljs-title function_">add</span>(test).<span class="hljs-title function_">rotate</span>(ang).<span class="hljs-title function_">add</span>(origin);

            [x, y] = coord;
            x = <span class="hljs-title function_">_round</span>(x);
            y = <span class="hljs-title function_">_round</span>(y);

            <span class="hljs-keyword">if</span> ((x &gt; -tileW) &amp;&amp; (x &lt; iWidth + tileW) &amp;&amp; (y &gt; -tileH) &amp;&amp; (y &lt; iHeight + tileH)) {

                cursor = ((iWidth * <span class="hljs-number">2</span>) * (iHeight * <span class="hljs-number">2</span>)) + ((y + <span class="hljs-title function_">_floor</span>(iHeight / <span class="hljs-number">2</span>)) * iWidth) + (x + <span class="hljs-title function_">_floor</span>(iWidth / <span class="hljs-number">2</span>));

                referencePoints[counter] = [x, y, cursor];
                tiles[cursor] = [];

                <span class="hljs-keyword">for</span> (h = y - tileH, hz = y + tileH; h &lt; hz; h++) {

                    <span class="hljs-keyword">for</span> (w = x - tileW, wz = x + tileW; w &lt; wz; w++) {

                        <span class="hljs-keyword">if</span> (w &gt;= <span class="hljs-number">0</span> &amp;&amp; w &lt; iWidth &amp;&amp; h &gt;= <span class="hljs-number">0</span> &amp;&amp; h &lt; iHeight) {

                            <span class="hljs-keyword">if</span> (req == <span class="hljs-variable constant_">RANDOM_POINTS</span>) {

                                <span class="hljs-keyword">if</span> (coord.<span class="hljs-title function_">zero</span>().<span class="hljs-title function_">subtract</span>(origin).<span class="hljs-title function_">add</span>([w, h]).<span class="hljs-title function_">getMagnitude</span>() &gt; tileR) <span class="hljs-keyword">continue</span>;
                            }

                            ref = (h * iWidth) + w;
                            <span class="hljs-keyword">if</span> (!neighbourPoints[ref]) neighbourPoints[ref] = [];
                            neighbourPoints[ref].<span class="hljs-title function_">push</span>(counter);
                        }
                    }
                }
                counter++;
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Sanity check, in case none of the points survived the previous manipulation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!referencePoints.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> referencePoints;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p>Assign pixels to tile buckets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> minref, minlen, pixel, pixelRefs, distance;

        <span class="hljs-keyword">for</span> (h = <span class="hljs-number">0</span>; h &lt; iHeight; h++) {

            <span class="hljs-keyword">for</span> (w = <span class="hljs-number">0</span>; w &lt; iWidth; w++) {

                pixel = (h * iWidth) + w;

                test[<span class="hljs-number">0</span>] = w;
                test[<span class="hljs-number">1</span>] = h;

                pixelRefs = neighbourPoints[pixel];
                minref = -<span class="hljs-number">1</span>;
                minlen = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">if</span> (pixelRefs) {

                    pixelRefs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {

                        [x, y, cursor] = referencePoints[r];

                        distance = coord.<span class="hljs-title function_">zero</span>().<span class="hljs-title function_">add</span>(test).<span class="hljs-title function_">subtract</span>([x, y]).<span class="hljs-title function_">getMagnitude</span>();

                        <span class="hljs-keyword">if</span> (minref &lt; <span class="hljs-number">0</span> || distance &lt; minlen) {

                            minref = cursor;
                            minlen = distance;
                        }
                    });
                }
                <span class="hljs-keyword">if</span> (minref &gt;= <span class="hljs-number">0</span>) tiles[minref].<span class="hljs-title function_">push</span>(pixel);
            }
        }

        <span class="hljs-title function_">releaseCoordinate</span>(coord);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>Filter the tiles Array to remove undefined indexes, then stash the result in the workstore (for future quick-serve) and return the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        tiles = tiles.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t != <span class="hljs-literal">null</span>);

        workstore[name] = <span class="hljs-title function_">_freeze</span>(tiles);
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }
    <span class="hljs-keyword">return</span> [];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p><code>buildHorizontalBlur</code> - creates an Array of Arrays detailing which pixels contribute to the horizontal part of each pixel’s blur calculation. Resulting object will be cached in the store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildHorizontalBlur</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">grid, radius</span>) {

    <span class="hljs-keyword">const</span> { workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!radius || !radius.<span class="hljs-property">toFixed</span> || <span class="hljs-built_in">isNaN</span>(radius)) radius = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">const</span> gridHeight = grid.<span class="hljs-property">length</span>,
        gridWidth = grid[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>;

    <span class="hljs-keyword">const</span> name = <span class="hljs-string">`blur-h-<span class="hljs-subst">${gridWidth}</span>-<span class="hljs-subst">${gridHeight}</span>-<span class="hljs-subst">${radius}</span>`</span>;

    <span class="hljs-keyword">if</span> (workstore[name]) {
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }

    <span class="hljs-keyword">const</span> horizontalBlur = [];

    <span class="hljs-keyword">let</span> x, y, c, cz, cellsToProcess;

    <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; gridHeight; y++) {

        <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; gridWidth; x++) {

            cellsToProcess = [];

            <span class="hljs-keyword">for</span> (c = x - radius, cz = x + radius + <span class="hljs-number">1</span>; c &lt; cz; c++) {

                <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-number">0</span> &amp;&amp; c &lt; gridWidth) cellsToProcess.<span class="hljs-title function_">push</span>(grid[y][c] * <span class="hljs-number">4</span>);
            }
            horizontalBlur[(y * gridWidth) + x] = <span class="hljs-title function_">_freeze</span>(cellsToProcess);
        }
    }
    workstore[name] = <span class="hljs-title function_">_freeze</span>(horizontalBlur);
    workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
    <span class="hljs-keyword">return</span> workstore[name];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p><code>buildVerticalBlur</code> - creates an Array of Arrays detailing which pixels contribute to the vertical part of each pixel’s blur calculation. Resulting object will be cached in the store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildVerticalBlur</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">grid, radius</span>) {

    <span class="hljs-keyword">const</span> { workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!radius || !radius.<span class="hljs-property">toFixed</span> || <span class="hljs-built_in">isNaN</span>(radius)) radius = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">const</span> gridHeight = grid.<span class="hljs-property">length</span>,
        gridWidth = grid[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>;

    <span class="hljs-keyword">const</span> name = <span class="hljs-string">`blur-v-<span class="hljs-subst">${gridWidth}</span>-<span class="hljs-subst">${gridHeight}</span>-<span class="hljs-subst">${radius}</span>`</span>;

    <span class="hljs-keyword">if</span> (workstore[name]) {
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }

    <span class="hljs-keyword">const</span> verticalBlur = [];

    <span class="hljs-keyword">let</span> x, y, c, cz, cellsToProcess;

    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; gridWidth; x++) {

        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; gridHeight; y++) {

            cellsToProcess = [];

            <span class="hljs-keyword">for</span> (c = y - radius, cz = y + radius + <span class="hljs-number">1</span>; c &lt; cz; c++) {

                <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-number">0</span> &amp;&amp; c &lt; gridHeight) cellsToProcess.<span class="hljs-title function_">push</span>(grid[c][x] * <span class="hljs-number">4</span>);
            }
            verticalBlur[(y * gridWidth) + x] = <span class="hljs-title function_">_freeze</span>(cellsToProcess);
        }
    }
    workstore[name] = <span class="hljs-title function_">_freeze</span>(verticalBlur);
    workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
    <span class="hljs-keyword">return</span> workstore[name];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p><code>buildMatrixGrid</code> - creates an Array of Arrays detailing which pixels contribute to each pixel’s matrix calculation. Resulting object will be cached in the store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">buildMatrixGrid</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">mWidth, mHeight, mX, mY, image</span>) {

    <span class="hljs-keyword">const</span> { cache, workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (!image) image = cache.<span class="hljs-property">source</span>;

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight, data } = image;

    <span class="hljs-keyword">if</span> (mWidth == <span class="hljs-literal">null</span> || mWidth &lt; <span class="hljs-number">1</span>) mWidth = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (mHeight == <span class="hljs-literal">null</span> || mHeight &lt; <span class="hljs-number">1</span>) mHeight = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (mX == <span class="hljs-literal">null</span> || mX &lt; <span class="hljs-number">0</span>) mX = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mX &gt;= mWidth) mX = mWidth - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (mY == <span class="hljs-literal">null</span> || mY &lt; <span class="hljs-number">0</span>) mY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mY &gt;= mHeight) mY = mHeight - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">const</span> name = <span class="hljs-string">`matrix-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>-<span class="hljs-subst">${mWidth}</span>-<span class="hljs-subst">${mHeight}</span>-<span class="hljs-subst">${mX}</span>-<span class="hljs-subst">${mY}</span>`</span>;

    <span class="hljs-keyword">if</span> (workstore[name]) {
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }

    <span class="hljs-keyword">const</span> dataLength = data.<span class="hljs-property">length</span>,
        cellsTemplate = [],
        grid = [];

    <span class="hljs-keyword">let</span> x, xz, y, yz, i, iz, pos, cell, val;

    <span class="hljs-keyword">for</span> (y = -mY, yz = mHeight - mY; y &lt; yz; y++) {

        <span class="hljs-keyword">for</span> (x = -mX, xz = mWidth - mX; x &lt; xz; x++) {

            cellsTemplate.<span class="hljs-title function_">push</span>(((y * iWidth) + x) * <span class="hljs-number">4</span>);
        }
    }

    <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {

        <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

            pos = ((y * iWidth) + x) * <span class="hljs-number">4</span>;
            cell = [];

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cellsTemplate.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                val = pos + cellsTemplate[i];

                <span class="hljs-keyword">if</span> (val &lt; <span class="hljs-number">0</span>) val += dataLength;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val &gt;= dataLength) val -= dataLength;

                cell.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>(val));
            }
            grid.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">_freeze</span>(cell));
        }
    }
    workstore[name] = <span class="hljs-title function_">_freeze</span>(grid);
    workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
    <span class="hljs-keyword">return</span> workstore[name];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p><code>checkChannelLevelsParameters</code> - divide each channel into discrete sequences of pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">checkChannelLevelsParameters</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">f</span>) {

    <span class="hljs-keyword">const</span> doCheck = <span class="hljs-keyword">function</span> (<span class="hljs-params">v, isHigh = <span class="hljs-literal">false</span></span>) {

        <span class="hljs-keyword">if</span> (v.<span class="hljs-property">toFixed</span>) {
            <span class="hljs-keyword">if</span> (v &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> [<span class="hljs-variable constant_">LOW_ARRAY</span>];
            <span class="hljs-keyword">if</span> (v &gt; <span class="hljs-number">255</span>) <span class="hljs-keyword">return</span> [<span class="hljs-variable constant_">HIGH_ARRAY</span>];
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(v)) <span class="hljs-keyword">return</span> (isHigh) ? [<span class="hljs-variable constant_">HIGH_ARRAY</span>] : [<span class="hljs-variable constant_">LOW_ARRAY</span>];
            <span class="hljs-keyword">return</span> [[<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, v]];
        }

        <span class="hljs-keyword">if</span> (v.<span class="hljs-property">substring</span>) {
            v = v.<span class="hljs-title function_">split</span>(<span class="hljs-variable constant_">ARG_SPLITTER</span>);
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">_isArray</span>(v)) {

            <span class="hljs-keyword">if</span> (!v.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> v;
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">_isArray</span>(v[<span class="hljs-number">0</span>])) <span class="hljs-keyword">return</span> v;

            v = v.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> <span class="hljs-built_in">parseInt</span>(s, <span class="hljs-number">10</span>));
            v.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);

            <span class="hljs-keyword">if</span> (v.<span class="hljs-property">length</span> == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> [[<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, v[<span class="hljs-number">0</span>]]];

            <span class="hljs-keyword">const</span> res = [];
            <span class="hljs-keyword">let</span> starts, ends, i, iz;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = v.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                starts = <span class="hljs-number">0</span>;
                ends = <span class="hljs-number">255</span>;
                <span class="hljs-keyword">if</span> (i != <span class="hljs-number">0</span>) starts = <span class="hljs-title function_">_ceil</span>(v[i - <span class="hljs-number">1</span>] + ((v[i] - v[i - <span class="hljs-number">1</span>]) / <span class="hljs-number">2</span>));
                <span class="hljs-keyword">if</span> (i != iz - <span class="hljs-number">1</span>) ends = <span class="hljs-title function_">_floor</span>(v[i] + ((v[i + <span class="hljs-number">1</span>] - v[i]) / <span class="hljs-number">2</span>));

                res.<span class="hljs-title function_">push</span>([starts, ends, v[i]]);
            }
            <span class="hljs-keyword">return</span> res;
        }
        <span class="hljs-keyword">return</span> (isHigh) ? [<span class="hljs-variable constant_">HIGH_ARRAY</span>] : [<span class="hljs-variable constant_">LOW_ARRAY</span>];
    }
    f.<span class="hljs-property">red</span> = <span class="hljs-title function_">doCheck</span>(f.<span class="hljs-property">red</span>);
    f.<span class="hljs-property">green</span> = <span class="hljs-title function_">doCheck</span>(f.<span class="hljs-property">green</span>);
    f.<span class="hljs-property">blue</span> = <span class="hljs-title function_">doCheck</span>(f.<span class="hljs-property">blue</span>);
    f.<span class="hljs-property">alpha</span> = <span class="hljs-title function_">doCheck</span>(f.<span class="hljs-property">alpha</span>, <span class="hljs-literal">true</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <p><code>cacheOutput</code> - insert an action function’s output into the filter engine’s cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">cacheOutput</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">name, obj</span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[name] = obj;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p><code>getInputAndOutputLines</code> - determine, and return, the appropriate results object for the lineIn, lineMix and lineOut values supplied to each action function when it gets invoked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getInputAndOutputLines</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

    <span class="hljs-keyword">const</span> { cache } = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> sourceData = cache.<span class="hljs-property">source</span>;

    <span class="hljs-keyword">let</span> lineIn = cache.<span class="hljs-property">work</span>,
        lineMix = <span class="hljs-literal">false</span>,
        alphaData = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineIn</span> == <span class="hljs-variable constant_">SOURCE_ALPHA</span> || requirements.<span class="hljs-property">lineMix</span> == <span class="hljs-variable constant_">SOURCE_ALPHA</span>) alphaData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAlphaData</span>(sourceData);

    <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineIn</span>) {

        <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineIn</span> == <span class="hljs-variable constant_">SOURCE</span>) lineIn = sourceData;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineIn</span> == <span class="hljs-variable constant_">SOURCE_ALPHA</span>) lineIn = alphaData;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cache[requirements.<span class="hljs-property">lineIn</span>]) lineIn = cache[requirements.<span class="hljs-property">lineIn</span>];
    }

    <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineMix</span>) {

        <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineMix</span> == <span class="hljs-variable constant_">SOURCE</span>) lineMix = sourceData;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineMix</span> == <span class="hljs-variable constant_">SOURCE_ALPHA</span>) lineMix = alphaData;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineMix</span> == <span class="hljs-variable constant_">CURRENT</span>) lineMix = cache.<span class="hljs-property">work</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cache[requirements.<span class="hljs-property">lineMix</span>]) lineMix = cache[requirements.<span class="hljs-property">lineMix</span>];
    }

    <span class="hljs-keyword">let</span> lineOut;
    <span class="hljs-keyword">if</span> (!requirements.<span class="hljs-property">lineOut</span> || !cache[requirements.<span class="hljs-property">lineOut</span>]) {

        lineOut = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(lineIn.<span class="hljs-property">width</span>, lineIn.<span class="hljs-property">height</span>);

        <span class="hljs-keyword">if</span> (requirements.<span class="hljs-property">lineOut</span>) cache[requirements.<span class="hljs-property">lineOut</span>] = lineOut;
    }
    <span class="hljs-keyword">else</span> lineOut = cache[requirements.<span class="hljs-property">lineOut</span>];

    <span class="hljs-keyword">return</span> [lineIn, lineOut, lineMix];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p><code>getGrayscaleValue</code> - put here because this calculation is used in several different filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getGrayscaleValue</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">r, g, b</span>) {

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_floor</span>((<span class="hljs-number">0.2126</span> * r) + (<span class="hljs-number">0.7152</span> * g) + (<span class="hljs-number">0.0722</span> * b));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <p><code>processResults</code> - at the conclusion of each action function, combine the results of the function’s manipulations back into the data supplied for manipulation, in line with the value of the action object’s <code>opacity</code> attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">processResults</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">store, incoming, ratio</span>) {

    <span class="hljs-keyword">const</span> sData = store.<span class="hljs-property">data</span>,
        iData = incoming.<span class="hljs-property">data</span>;

    <span class="hljs-keyword">let</span> antiRatio, i, iz;

    <span class="hljs-keyword">if</span> (ratio == <span class="hljs-number">1</span>) {

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = sData.<span class="hljs-property">length</span>; i &lt; iz; i++) {

            sData[i] = iData[i];
        }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ratio &gt; <span class="hljs-number">0</span>) {

        antiRatio = <span class="hljs-number">1</span> - ratio;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = sData.<span class="hljs-property">length</span>; i &lt; iz; i++) {

            sData[i] = (sData[i] * antiRatio) + (iData[i] * ratio);
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <p><code>getGradientData</code> - create an imageData object containing the 256 values from a gradient that we require for doing filters work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getGradientData</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">gradient</span>) {

    <span class="hljs-keyword">const</span> { workstore, workstoreLastAccessed } = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">const</span> name = <span class="hljs-string">`gradient-data-<span class="hljs-subst">${gradient.name}</span>`</span>;

    <span class="hljs-keyword">if</span> (!workstore[name] || gradient.<span class="hljs-property">dirtyFilterIdentifier</span> || gradient.<span class="hljs-property">animateByDelta</span>) {

        <span class="hljs-keyword">const</span> mycell = <span class="hljs-title function_">requestCell</span>();

        <span class="hljs-keyword">const</span> {engine, element} = mycell;

        element.<span class="hljs-property">width</span> = <span class="hljs-number">256</span>;
        element.<span class="hljs-property">height</span> = <span class="hljs-number">1</span>;

        gradient.<span class="hljs-property">palette</span>.<span class="hljs-title function_">recalculate</span>();

        <span class="hljs-keyword">const</span> G = engine.<span class="hljs-title function_">createLinearGradient</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>);

        gradient.<span class="hljs-title function_">addStopsToGradient</span>(G, gradient.<span class="hljs-property">paletteStart</span>, gradient.<span class="hljs-property">paletteEnd</span>, gradient.<span class="hljs-property">cyclePalette</span>);

        engine.<span class="hljs-property">fillStyle</span> = G;
        engine.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">1</span>);

        <span class="hljs-keyword">const</span> data = engine.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">1</span>).<span class="hljs-property">data</span>;

        <span class="hljs-title function_">releaseCell</span>(mycell);

        workstore[name] = data;
    }

    <span class="hljs-keyword">if</span> (workstore[name]) {
        workstoreLastAccessed[name] = <span class="hljs-title function_">_now</span>();
        <span class="hljs-keyword">return</span> workstore[name];
    }
    <span class="hljs-keyword">return</span> [];
};

P.<span class="hljs-property">transferDataUnchanged</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">oData, iData, len</span>) {

    <span class="hljs-keyword">let</span> r, g, b, a, i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

        r = i;
        g = r + <span class="hljs-number">1</span>;
        b = g + <span class="hljs-number">1</span>;
        a = b + <span class="hljs-number">1</span>;

        oData[r] = iData[r];
        oData[g] = iData[g];
        oData[b] = iData[b];
        oData[a] = iData[a];
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <h2 id="filter-action-functions">Filter action functions</h2>
<p>Each function is held in the <code>theBigActionsObject</code> object, for convenience</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">theBigActionsObject</span> = <span class="hljs-title function_">_freeze</span>({</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p><strong>alpha-to-channels</strong> - Copies the alpha channel value over to the selected value or, alternatively, sets that channel’s value to zero, or leaves the channel’s value unchanged. Setting the appropriate “includeChannel” flags will copy the alpha channel value to that channel; when that flag is false, setting the appropriate “excludeChannel” flag will set that channel’s value to zero.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">ALPHA_TO_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            excludeRed = <span class="hljs-literal">true</span>,
            excludeGreen = <span class="hljs-literal">true</span>,
            excludeBlue = <span class="hljs-literal">true</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, aVal, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;
            aVal = iData[a];

            <span class="hljs-keyword">if</span> (aVal) {

                oData[r] = (includeRed) ? aVal : ((excludeRed) ? <span class="hljs-number">0</span> : iData[r]);
                oData[g] = (includeGreen) ? aVal : ((excludeGreen) ? <span class="hljs-number">0</span> : iData[g]);
                oData[b] = (includeBlue) ? aVal : ((excludeBlue) ? <span class="hljs-number">0</span> : iData[b]);
                oData[a] = <span class="hljs-number">255</span>;
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <p><strong>area-alpha</strong> - Places a tile schema across the input, quarters each tile and then sets the alpha channels of the pixels in selected quarters of each tile to zero. Can be used to create horizontal or vertical bars, or chequerboard effects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">AREA_ALPHA</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            tileWidth = <span class="hljs-number">1</span>,
            tileHeight = <span class="hljs-number">1</span>,
            offsetX = <span class="hljs-number">0</span>,
            offsetY = <span class="hljs-number">0</span>,
            gutterWidth = <span class="hljs-number">1</span>,
            gutterHeight = <span class="hljs-number">1</span>,
            areaAlphaLevels = [<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> tiles = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildAlphaTileSets</span>(tileWidth, tileHeight, gutterWidth, gutterHeight, offsetX, offsetY, areaAlphaLevels);

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transferDataUnchanged</span>(oData, iData, len);

        <span class="hljs-keyword">let</span> a, j, jz, tVal;

        tiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">t, index</span>) =&gt;</span> {

            a = areaAlphaLevels[index % <span class="hljs-number">4</span>];

            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = t.<span class="hljs-property">length</span>; j &lt; jz; j++) {

                tVal = t[j];

                <span class="hljs-keyword">if</span> (iData[tVal]) oData[tVal] = a;
            }
        });

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p><strong>average-channels</strong> - Calculates an average value from each pixel’s included channels and applies that value to all channels that have not been specifically excluded; excluded channels have their values set to 0.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">AVERAGE_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            excludeRed = <span class="hljs-literal">false</span>,
            excludeGreen = <span class="hljs-literal">false</span>,
            excludeBlue = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> divisor = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (includeRed) divisor++;
        <span class="hljs-keyword">if</span> (includeGreen) divisor++;
        <span class="hljs-keyword">if</span> (includeBlue) divisor++;

        <span class="hljs-keyword">let</span> i, avg, r, g, b, a;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">if</span> (iData[a]) {

                <span class="hljs-keyword">if</span> (divisor) {

                    avg = <span class="hljs-number">0</span>;

                    <span class="hljs-keyword">if</span> (includeRed) avg += iData[r];
                    <span class="hljs-keyword">if</span> (includeGreen) avg += iData[g];
                    <span class="hljs-keyword">if</span> (includeBlue) avg += iData[b];

                    avg = <span class="hljs-title function_">_floor</span>(avg / divisor);

                    oData[r] = (excludeRed) ? <span class="hljs-number">0</span> : avg;
                    oData[g] = (excludeGreen) ? <span class="hljs-number">0</span> : avg;
                    oData[b] = (excludeBlue) ? <span class="hljs-number">0</span> : avg;
                    oData[a] = iData[a];
                }
                <span class="hljs-keyword">else</span> {

                    oData[r] = (excludeRed) ? <span class="hljs-number">0</span> : iData[r];
                    oData[g] = (excludeGreen) ? <span class="hljs-number">0</span> : iData[g];
                    oData[b] = (excludeBlue) ? <span class="hljs-number">0</span> : iData[b];
                    oData[a] = iData[a];
                }
            }
            <span class="hljs-keyword">else</span> {

                oData[r] = iData[r];
                oData[g] = iData[g];
                oData[b] = iData[b];
                oData[a] = iData[a];
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p>DEPRECATED! <strong>binary</strong> - use the updated <code>threshold</code> filter instead, which now incorporates binary filter functionality</p>
<p><strong>blend</strong> - Using two source images (from the “lineIn” and “lineMix” arguments), combine their color information using various separable and non-separable blend modes (as defined by the W3C Compositing and Blending Level 1 recommendations.</p>
<ul>
<li>The blending method is determined by the String value supplied in the “blend” argument; permitted values are: ‘color-burn’, ‘color-dodge’, ‘darken’, ‘difference’, ‘exclusion’, ‘hard-light’, ‘lighten’, ‘lighter’, ‘multiply’, ‘overlay’, ‘screen’, ‘soft-light’, ‘color’, ‘hue’, ‘luminosity’, and ‘saturation’.</li>
<li>Note that the source images may be of different sizes: the output (lineOut) image size will be the same as the source (NOT lineIn) image; the lineMix image can be moved relative to the lineIn image using the “offsetX” and “offsetY” arguments.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">BLEND</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> copyPixel = <span class="hljs-keyword">function</span> (<span class="hljs-params">fr, tr, data</span>) {

            <span class="hljs-keyword">const</span> fg = fr + <span class="hljs-number">1</span>,
                fb = fg + <span class="hljs-number">1</span>,
                fa = fb + <span class="hljs-number">1</span>,
                tg = tr + <span class="hljs-number">1</span>,
                tb = tg + <span class="hljs-number">1</span>,
                ta = tb + <span class="hljs-number">1</span>;

            oData[tr] = data[fr];
            oData[tg] = data[fg];
            oData[tb] = data[fb];
            oData[ta] = data[fa];
        };

        <span class="hljs-keyword">const</span> getLinePositions = <span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) {

            <span class="hljs-keyword">const</span> ix = x,
                iy = y,
                mx = x - offsetX,
                my = y - offsetY;

            <span class="hljs-keyword">let</span> mPos = -<span class="hljs-number">1</span>;

            <span class="hljs-keyword">const</span> iPos = ((iy * iWidth) + ix) * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">if</span> (mx &gt;= <span class="hljs-number">0</span> &amp;&amp; mx &lt; mWidth &amp;&amp; my &gt;= <span class="hljs-number">0</span> &amp;&amp; my &lt; mHeight) mPos = ((my * mWidth) + mx) * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">return</span> [iPos, mPos];
        };

        <span class="hljs-keyword">const</span> getChannelNormals = <span class="hljs-keyword">function</span> (<span class="hljs-params">irn, mrn</span>) {

            <span class="hljs-keyword">const</span> ign = irn + <span class="hljs-number">1</span>,
                ibn = ign + <span class="hljs-number">1</span>,
                ian = ibn + <span class="hljs-number">1</span>,
                mgn = mrn + <span class="hljs-number">1</span>,
                mbn = mgn + <span class="hljs-number">1</span>,
                man = mbn + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">return</span> [
                iData[irn] / <span class="hljs-number">255</span>,
                iData[ign] / <span class="hljs-number">255</span>,
                iData[ibn] / <span class="hljs-number">255</span>,
                iData[ian] / <span class="hljs-number">255</span>,
                mData[mrn] / <span class="hljs-number">255</span>,
                mData[mgn] / <span class="hljs-number">255</span>,
                mData[mbn] / <span class="hljs-number">255</span>,
                mData[man] / <span class="hljs-number">255</span>
            ];
        };

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">alphaCalc</span> = (<span class="hljs-params">dA, mA</span>) =&gt; (dA + (mA * (<span class="hljs-number">1</span> - dA))) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> [input, output, mix] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight, <span class="hljs-attr">data</span>:iData} = input;
        <span class="hljs-keyword">const</span> {<span class="hljs-attr">data</span>:oData} = output;
        <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:mWidth, <span class="hljs-attr">height</span>:mHeight, <span class="hljs-attr">data</span>:mData} = mix;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            blend = <span class="hljs-variable constant_">ZERO_STR</span>,
            offsetX = <span class="hljs-number">0</span>,
            offsetY = <span class="hljs-number">0</span>,
            lineOut,
        } = requirements;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <p>Pixel calculations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">colorburnCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; {
            <span class="hljs-keyword">if</span> (dmix == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">255</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (din == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">return</span> (<span class="hljs-number">1</span> - <span class="hljs-title function_">_min</span>(<span class="hljs-number">1</span>, ((<span class="hljs-number">1</span> - dmix) / din ))) * <span class="hljs-number">255</span>;
        };

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">colordodgeCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; {
            <span class="hljs-keyword">if</span> (dmix == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (din == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">255</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">_min</span>(<span class="hljs-number">1</span>, (dmix / (<span class="hljs-number">1</span> - din))) * <span class="hljs-number">255</span>;
        };

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">darkenCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (din &lt; dmix) ? din : dmix;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">differenceCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; <span class="hljs-title function_">_abs</span>(din - dmix) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">exclusionCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (din + dmix - (<span class="hljs-number">2</span> * dmix * din)) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">hardlightCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (din &lt;= <span class="hljs-number">0.5</span>) ? (din * dmix) * <span class="hljs-number">255</span> : (dmix + (din - (dmix * din))) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">lightenCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (din &gt; dmix) ? din : dmix;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">lighterCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (din + dmix) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">multiplyCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; din * dmix * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">overlayCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (din &gt;= <span class="hljs-number">0.5</span>) ? (din * dmix) * <span class="hljs-number">255</span> : (dmix + (din - (dmix * din))) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">screenCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; (dmix + (din - (dmix * din))) * <span class="hljs-number">255</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">softlightCalc</span> = (<span class="hljs-params">din, dmix</span>) =&gt; {
            <span class="hljs-keyword">const</span> d = (dmix &lt;= <span class="hljs-number">0.25</span>) ?
                ((((<span class="hljs-number">16</span> * dmix) - <span class="hljs-number">12</span>) * dmix) + <span class="hljs-number">4</span>) * dmix :
                <span class="hljs-title function_">_sqrt</span>(dmix);

            <span class="hljs-keyword">if</span> (din &lt;= <span class="hljs-number">0.5</span>) <span class="hljs-keyword">return</span> (dmix - ((<span class="hljs-number">1</span> - (<span class="hljs-number">2</span> * din)) * dmix * (<span class="hljs-number">1</span> - dmix))) * <span class="hljs-number">255</span>;
            <span class="hljs-keyword">return</span> (dmix + (((<span class="hljs-number">2</span> * din) - <span class="hljs-number">1</span>) * (d - dmix))) * <span class="hljs-number">255</span>;
        };


        <span class="hljs-keyword">const</span> <span class="hljs-title function_">normalCalc</span> = (<span class="hljs-params">Cs, As, Cb, Ab</span>) =&gt; (<span class="hljs-title class_">As</span> * <span class="hljs-title class_">Cs</span>) + (<span class="hljs-title class_">Ab</span> * <span class="hljs-title class_">Cb</span> * (<span class="hljs-number">1</span> - <span class="hljs-title class_">As</span>));

        <span class="hljs-keyword">let</span> x, y, dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA, ir, ig, ib, ia, mr, mg, mb, ma, cr, cg, cb;

        <span class="hljs-keyword">switch</span> (blend) {

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">COLOR_BURN</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;
                        ma = mr + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">colorburnCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">colorburnCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">colorburnCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">COLOR_DODGE</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;
                        ma = mr + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">colordodgeCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">colordodgeCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">colordodgeCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DARKEN</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;
                        ma = mr + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;
                                mg = mr + <span class="hljs-number">1</span>;
                                mb = mg + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">darkenCalc</span>(iData[ir], mData[mr]);
                                oData[ig] = <span class="hljs-title function_">darkenCalc</span>(iData[ig], mData[mg]);
                                oData[ib] = <span class="hljs-title function_">darkenCalc</span>(iData[ib], mData[mb]);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(iData[ia] / <span class="hljs-number">255</span>, mData[ma] / <span class="hljs-number">255</span>);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DIFFERENCE</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">differenceCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">differenceCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">differenceCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">EXCLUSION</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">exclusionCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">exclusionCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">exclusionCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">HARD_LIGHT</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">hardlightCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">hardlightCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">hardlightCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">LIGHTEN</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ir]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;
                                mg = mr + <span class="hljs-number">1</span>;
                                mb = mg + <span class="hljs-number">1</span>;
                                ma = mb + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">lightenCalc</span>(iData[ir], mData[mr]);
                                oData[ig] = <span class="hljs-title function_">lightenCalc</span>(iData[ig], mData[mg]);
                                oData[ib] = <span class="hljs-title function_">lightenCalc</span>(iData[ib], mData[mb]);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(iData[ia] / <span class="hljs-number">255</span>, mData[ma] / <span class="hljs-number">255</span>);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">LIGHTER</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">lighterCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">lighterCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">lighterCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">MULTIPLY</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;
                        ma = mr + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">multiplyCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">multiplyCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">multiplyCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">OVERLAY</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">overlayCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">overlayCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">overlayCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SCREEN</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">screenCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">screenCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">screenCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SOFT_LIGHT</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;
                        ma = mr + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [dinR, dinG, dinB, dinA, dmixR, dmixG, dmixB, dmixA] = <span class="hljs-title function_">getChannelNormals</span>(ir, mr);

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;

                                oData[ir] = <span class="hljs-title function_">softlightCalc</span>(dinR, dmixR);
                                oData[ig] = <span class="hljs-title function_">softlightCalc</span>(dinG, dmixG);
                                oData[ib] = <span class="hljs-title function_">softlightCalc</span>(dinB, dmixB);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">COLOR</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ig = ir + <span class="hljs-number">1</span>;
                        ib = ig + <span class="hljs-number">1</span>;
                        ia = ib + <span class="hljs-number">1</span>;
                        mg = mr + <span class="hljs-number">1</span>;
                        mb = mg + <span class="hljs-number">1</span>;
                        ma = mb + <span class="hljs-number">1</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [cr, cg, cb] = colorEngine.<span class="hljs-title function_">calculateColorBlend</span>(iData[ir], iData[ig], iData[ib], mData[mr], mData[mg], mData[mb]);

                                oData[ir] = cr;
                                oData[ig] = cg;
                                oData[ib] = cb;
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(iData[ia] / <span class="hljs-number">255</span>, mData[ma] / <span class="hljs-number">255</span>);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">HUE</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ig = ir + <span class="hljs-number">1</span>;
                        ib = ig + <span class="hljs-number">1</span>;
                        ia = ib + <span class="hljs-number">1</span>;
                        mg = mr + <span class="hljs-number">1</span>;
                        mb = mg + <span class="hljs-number">1</span>;
                        ma = mb + <span class="hljs-number">1</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [cr, cg, cb] = colorEngine.<span class="hljs-title function_">calculateHueBlend</span>(iData[ir], iData[ig], iData[ib], mData[mr], mData[mg], mData[mb]);

                                oData[ir] = cr;
                                oData[ig] = cg;
                                oData[ib] = cb;
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(iData[ia] / <span class="hljs-number">255</span>, mData[ma] / <span class="hljs-number">255</span>);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">LUMINOSITY</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ig = ir + <span class="hljs-number">1</span>;
                        ib = ig + <span class="hljs-number">1</span>;
                        ia = ib + <span class="hljs-number">1</span>;
                        mg = mr + <span class="hljs-number">1</span>;
                        mb = mg + <span class="hljs-number">1</span>;
                        ma = mb + <span class="hljs-number">1</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [cr, cg, cb] = colorEngine.<span class="hljs-title function_">calculateLuminosityBlend</span>(iData[ir], iData[ig], iData[ib], mData[mr], mData[mg], mData[mb]);

                                oData[ir] = cr;
                                oData[ig] = cg;
                                oData[ib] = cb;
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(iData[ia] / <span class="hljs-number">255</span>, mData[ma] / <span class="hljs-number">255</span>);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SATURATION</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ig = ir + <span class="hljs-number">1</span>;
                        ib = ig + <span class="hljs-number">1</span>;
                        ia = ib + <span class="hljs-number">1</span>;
                        mg = mr + <span class="hljs-number">1</span>;
                        mb = mg + <span class="hljs-number">1</span>;
                        ma = mb + <span class="hljs-number">1</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mData[ma]) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> {

                                [cr, cg, cb] = colorEngine.<span class="hljs-title function_">calculateSaturationBlend</span>(iData[ir], iData[ig], iData[ib], mData[mr], mData[mg], mData[mb]);

                                oData[ir] = cr;
                                oData[ig] = cg;
                                oData[ib] = cb;
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(iData[ia] / <span class="hljs-number">255</span>, mData[ma] / <span class="hljs-number">255</span>);
                            }
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-attr">default</span>:

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        ia = ir + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (iData[ia]) {

                            <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!iData[ia]) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                            <span class="hljs-keyword">else</span> {

                                ig = ir + <span class="hljs-number">1</span>;
                                ib = ig + <span class="hljs-number">1</span>;
                                mg = mr + <span class="hljs-number">1</span>;
                                mb = mg + <span class="hljs-number">1</span>;
                                ma = mb + <span class="hljs-number">1</span>;

                                dinA = iData[ia] / <span class="hljs-number">255</span>;
                                dmixA = mData[ma] / <span class="hljs-number">255</span>;

                                oData[ir] = <span class="hljs-title function_">normalCalc</span>(iData[ir], dinA, mData[mr], dmixA);
                                oData[ig] = <span class="hljs-title function_">normalCalc</span>(iData[ig], dinA, mData[mg], dmixA);
                                oData[ib] = <span class="hljs-title function_">normalCalc</span>(iData[ib], dinA, mData[mb], dmixA);
                                oData[ia] = <span class="hljs-title function_">alphaCalc</span>(dinA, dmixA)
                            }
                        }
                    }
                }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p><strong>blur</strong> - Performs a multi-loop, two-step ‘horizontal-then-vertical averaging sweep’ calculation across all pixels to create a blur effect.
Note that this filter is expensive, thus much slower to complete compared to other filter effects. Where possible, memoize the results this filter produces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">BLUR</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> getUncheckedValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">flag, gridStore, pos, data, offset</span>) {

            <span class="hljs-keyword">if</span> (flag) {

                <span class="hljs-keyword">const</span> h = gridStore[pos];

                <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span>) {

                    <span class="hljs-keyword">const</span> l = h.<span class="hljs-property">length</span>;

                    <span class="hljs-keyword">let</span> valCounter = <span class="hljs-number">0</span>,
                        total = <span class="hljs-number">0</span>,
                        index, t;

                    <span class="hljs-keyword">for</span> (t = <span class="hljs-number">0</span>; t &lt; l; t += step) {

                        index = h[t] + offset;

                        total += data[index];
                        valCounter++
                    }
                    <span class="hljs-keyword">return</span> total / valCounter;
                }
            }
            <span class="hljs-keyword">return</span> data[(pos * <span class="hljs-number">4</span>) + offset];
        };

        <span class="hljs-keyword">const</span> getCheckedValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">flag, gridStore, pos, data, offset</span>) {

            <span class="hljs-keyword">if</span> (flag) {

                <span class="hljs-keyword">const</span> h = gridStore[pos];

                <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span>) {

                    <span class="hljs-keyword">const</span> l = h.<span class="hljs-property">length</span>;

                    <span class="hljs-keyword">let</span> valCounter = <span class="hljs-number">0</span>,
                        total = <span class="hljs-number">0</span>,
                        index, t, a, hVal;

                    <span class="hljs-keyword">for</span> (t = <span class="hljs-number">0</span>; t &lt; l; t += step) {

                        hVal = h[t];
                        a = hVal + <span class="hljs-number">3</span>;

                        <span class="hljs-keyword">if</span> (data[a]) {

                            index = hVal + offset;

                            total += data[index];
                            valCounter++
                        }
                    }
                    <span class="hljs-keyword">if</span> (valCounter) <span class="hljs-keyword">return</span> total / valCounter;
                }
            }
            <span class="hljs-keyword">return</span> data[(pos * <span class="hljs-number">4</span>) + offset];
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>,
            pixelLen = <span class="hljs-title function_">_floor</span>(len / <span class="hljs-number">4</span>);

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            radius = <span class="hljs-number">0</span>,
            passes = <span class="hljs-number">1</span>,
            processVertical = <span class="hljs-literal">true</span>,
            processHorizontal = <span class="hljs-literal">true</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            excludeTransparentPixels = <span class="hljs-literal">false</span>,
            step = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> horizontalBlurGrid, verticalBlurGrid;

        <span class="hljs-keyword">if</span> (processHorizontal || processVertical) {

            <span class="hljs-keyword">const</span> grid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageGrid</span>(input);

            <span class="hljs-keyword">if</span> (processHorizontal)  horizontalBlurGrid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildHorizontalBlur</span>(grid, radius);

            <span class="hljs-keyword">if</span> (processVertical) verticalBlurGrid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildVerticalBlur</span>(grid, radius);
        }

        oData.<span class="hljs-title function_">set</span>(iData);

        <span class="hljs-keyword">const</span> hold = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>(iData);

        <span class="hljs-keyword">const</span> selectedMethod = (excludeTransparentPixels) ? getCheckedValue : getUncheckedValue;

        <span class="hljs-keyword">let</span> counter, r, g, b, a, pass;

        <span class="hljs-keyword">for</span> (pass = <span class="hljs-number">0</span>; pass &lt; passes; pass++) {

            <span class="hljs-keyword">if</span> (processHorizontal) {

                <span class="hljs-keyword">for</span> (counter = <span class="hljs-number">0</span>; counter &lt; pixelLen; counter++) {

                    r = counter * <span class="hljs-number">4</span>;
                    g = r + <span class="hljs-number">1</span>;
                    b = g + <span class="hljs-number">1</span>;
                    a = b + <span class="hljs-number">1</span>;

                    <span class="hljs-keyword">if</span> (includeAlpha || hold[a]) {

                        oData[r] = <span class="hljs-title function_">selectedMethod</span>(includeRed, horizontalBlurGrid, counter, hold, <span class="hljs-number">0</span>);
                        oData[g] = <span class="hljs-title function_">selectedMethod</span>(includeGreen, horizontalBlurGrid, counter, hold, <span class="hljs-number">1</span>);
                        oData[b] = <span class="hljs-title function_">selectedMethod</span>(includeBlue, horizontalBlurGrid, counter, hold, <span class="hljs-number">2</span>);
                        oData[a] = <span class="hljs-title function_">getUncheckedValue</span>(includeAlpha, horizontalBlurGrid, counter, hold, <span class="hljs-number">3</span>);
                    }
                }

                <span class="hljs-keyword">if</span> (processVertical || pass &lt; passes - <span class="hljs-number">1</span>) hold.<span class="hljs-title function_">set</span>(oData);
            }

            <span class="hljs-keyword">if</span> (processVertical) {

                <span class="hljs-keyword">for</span> (counter = <span class="hljs-number">0</span>; counter &lt; pixelLen; counter++) {

                    r = counter * <span class="hljs-number">4</span>;
                    g = r + <span class="hljs-number">1</span>;
                    b = g + <span class="hljs-number">1</span>;
                    a = b + <span class="hljs-number">1</span>;

                    <span class="hljs-keyword">if</span> (includeAlpha || hold[a]) {

                        oData[r] = <span class="hljs-title function_">selectedMethod</span>(includeRed, verticalBlurGrid, counter, hold, <span class="hljs-number">0</span>);
                        oData[g] = <span class="hljs-title function_">selectedMethod</span>(includeGreen, verticalBlurGrid, counter, hold, <span class="hljs-number">1</span>);
                        oData[b] = <span class="hljs-title function_">selectedMethod</span>(includeBlue, verticalBlurGrid, counter, hold, <span class="hljs-number">2</span>);
                        oData[a] = <span class="hljs-title function_">getUncheckedValue</span>(includeAlpha, verticalBlurGrid, counter, hold, <span class="hljs-number">3</span>);
                    }
                }
                <span class="hljs-keyword">if</span> (pass &lt; passes - <span class="hljs-number">1</span>) hold.<span class="hljs-title function_">set</span>(oData);
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <p><strong>channels-to-alpha</strong> - Calculates an average value from each pixel’s included channels and applies that value to the alpha channel.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">CHANNELS_TO_ALPHA</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> divisor = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (includeRed) divisor++;
        <span class="hljs-keyword">if</span> (includeGreen) divisor++;
        <span class="hljs-keyword">if</span> (includeBlue) divisor++;

        <span class="hljs-keyword">let</span> r, g, b, a, vr, vg, vb, i, sum;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            vr = iData[r];
            vg = iData[g];
            vb = iData[b];

            oData[r] = vr;
            oData[g] = vg;
            oData[b] = vb;

            <span class="hljs-keyword">if</span> (divisor) {

                sum = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">if</span> (includeRed) sum += vr;
                <span class="hljs-keyword">if</span> (includeGreen) sum += vg;
                <span class="hljs-keyword">if</span> (includeBlue) sum += vb;

                oData[a] = <span class="hljs-title function_">_floor</span>(sum / divisor);
            }
            <span class="hljs-keyword">else</span> oData[a] = iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <p><strong>chroma</strong> - Using an array of ‘range’ arrays, determine whether a pixel’s values lie entirely within a range’s values and, if true, sets that pixel’s alpha channel value to zero. Each ‘range’ array comprises six Numbers representing [minimum-red, minimum-green, minimum-blue, maximum-red, maximum-green, maximum-blue] values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">CHROMA</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            ranges = [],
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, vr, vg, vb, i, iz, j, flag;

        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; len; j += <span class="hljs-number">4</span>) {

            flag = <span class="hljs-literal">false</span>;

            r = j;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            vr = iData[r];
            vg = iData[g];
            vb = iData[b];

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = ranges.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                <span class="hljs-keyword">const</span> [minR, minG, minB, maxR, maxG, maxB] = ranges[i];

                <span class="hljs-keyword">if</span> (vr &gt;= minR &amp;&amp; vr &lt;= maxR &amp;&amp; vg &gt;= minG &amp;&amp; vg &lt;= maxG &amp;&amp; vb &gt;= minB &amp;&amp; vb &lt;= maxB) {
                    flag = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">break</span>;
                }

            }
            oData[r] = vr;
            oData[g] = vg;
            oData[b] = vb;
            oData[a] = (flag) ? <span class="hljs-number">0</span> : iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <p><strong>clamp-channels</strong> - Clamp each color channel to a range set by lowColor and highColor values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">CLAMP_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            lowRed = <span class="hljs-number">0</span>,
            lowGreen = <span class="hljs-number">0</span>,
            lowBlue = <span class="hljs-number">0</span>,
            highRed = <span class="hljs-number">255</span>,
            highGreen = <span class="hljs-number">255</span>,
            highBlue = <span class="hljs-number">255</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> dR = highRed - lowRed,
            dG = highGreen - lowGreen,
            dB = highBlue - lowBlue;

        <span class="hljs-keyword">let</span> r, g, b, a, vr, vg, vb, va, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            vr = iData[r];
            vg = iData[g];
            vb = iData[b];
            va = iData[a];

            <span class="hljs-keyword">if</span> (va) {

                vr /= <span class="hljs-number">255</span>;
                vg /= <span class="hljs-number">255</span>;
                vb /= <span class="hljs-number">255</span>;

                oData[r] = lowRed + (vr * dR);
                oData[g] = lowGreen + (vg * dG);
                oData[b] = lowBlue + (vb * dB);
            }
            <span class="hljs-keyword">else</span> {
                oData[r] = vr;
                oData[g] = vg;
                oData[b] = vb;
            }
            oData[a] = va;
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              <p><strong>colors-to-alpha</strong> - Determine the alpha channel value for each pixel depending on the closeness to that pixel’s color channel values to a reference color supplied in the “red”, “green” and “blue” arguments. The sensitivity of the effect can be manipulated using the “transparentAt” and “opaqueAt” values, both of which lie in the range 0-1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">COLORS_TO_ALPHA</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> getCTAValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">dr, dg, db</span>) {

            <span class="hljs-keyword">const</span> diff = (<span class="hljs-title function_">_abs</span>(red - dr) + <span class="hljs-title function_">_abs</span>(green - dg) + <span class="hljs-title function_">_abs</span>(blue - db)) / <span class="hljs-number">3</span>;

            <span class="hljs-keyword">if</span> (diff &lt; transparent) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (diff &gt; opaque) <span class="hljs-keyword">return</span> <span class="hljs-number">255</span>;
            <span class="hljs-keyword">return</span> ((diff - transparent) / range) * <span class="hljs-number">255</span>;
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            red = <span class="hljs-number">0</span>,
            green = <span class="hljs-number">255</span>,
            blue = <span class="hljs-number">0</span>,
            opaqueAt = <span class="hljs-number">1</span>,
            transparentAt = <span class="hljs-number">0</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> maxDiff = <span class="hljs-title function_">_max</span>(((red + green + blue) / <span class="hljs-number">3</span>), (((<span class="hljs-number">255</span> - red) + (<span class="hljs-number">255</span> - green) + (<span class="hljs-number">255</span> - blue)) / <span class="hljs-number">3</span>)),
            transparent = transparentAt * maxDiff,
            opaque = opaqueAt * maxDiff,
            range = opaque - transparent;

        <span class="hljs-keyword">let</span> r, g, b, a, vr, vg, vb, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">if</span> (iData[a]) {

                vr = iData[r];
                vg = iData[g];
                vb = iData[b];

                oData[r] = vr;
                oData[g] = vg;
                oData[b] = vb;
                oData[a] = <span class="hljs-title function_">getCTAValue</span>(vr, vg, vb);
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <p><strong>compose</strong> - Using two source images (from the “lineIn” and “lineMix” arguments), combine their color information using alpha compositing rules (as defined by Porter/Duff). The compositing method is determined by the String value supplied in the “compose” argument; permitted values are: ‘destination-only’, ‘destination-over’, ‘destination-in’, ‘destination-out’, ‘destination-atop’, ‘source-only’, ‘source-over’ (default), ‘source-in’, ‘source-out’, ‘source-atop’, ‘clear’, ‘xor’, or ‘lighter’. Note that the source images may be of different sizes: the output (lineOut) image size will be the same as the source (NOT lineIn) image; the lineMix image can be moved relative to the lineIn image using the “offsetX” and “offsetY” arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">COMPOSE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> copyPixel = <span class="hljs-keyword">function</span> (<span class="hljs-params">fr, tr, data</span>) {

            <span class="hljs-keyword">const</span> fg = fr + <span class="hljs-number">1</span>,
                fb = fg + <span class="hljs-number">1</span>,
                fa = fb + <span class="hljs-number">1</span>,
                tg = tr + <span class="hljs-number">1</span>,
                tb = tg + <span class="hljs-number">1</span>,
                ta = tb + <span class="hljs-number">1</span>;

            oData[tr] = data[fr];
            oData[tg] = data[fg];
            oData[tb] = data[fb];
            oData[ta] = data[fa];
        };

        <span class="hljs-keyword">const</span> getLinePositions = <span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) {

            <span class="hljs-keyword">const</span> ix = x,
                iy = y,
                mx = x - offsetX,
                my = y - offsetY;

            <span class="hljs-keyword">let</span> mp = -<span class="hljs-number">1</span>;

            <span class="hljs-keyword">const</span> ip = ((iy * iWidth) + ix) * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">if</span> (mx &gt;= <span class="hljs-number">0</span> &amp;&amp; mx &lt; mWidth &amp;&amp; my &gt;= <span class="hljs-number">0</span> &amp;&amp; my &lt; mHeight) mp = ((my * mWidth) + mx) * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">return</span> [ip, mp];
        };

        <span class="hljs-keyword">const</span> [input, output, mix] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight, <span class="hljs-attr">data</span>:iData} = input;
        <span class="hljs-keyword">const</span> {<span class="hljs-attr">data</span>:oData} = output;
        <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:mWidth, <span class="hljs-attr">height</span>:mHeight, <span class="hljs-attr">data</span>:mData} = mix;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            compose = <span class="hljs-variable constant_">ZERO_STR</span>,
            offsetX = <span class="hljs-number">0</span>,
            offsetY = <span class="hljs-number">0</span>,
            lineOut,
        } = requirements;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <p>Pixel calculations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">sAtopCalc</span> = (<span class="hljs-params">iColor, iAlpha, mColor, mAlpha</span>) =&gt; (iAlpha * iColor * mAlpha) + (mAlpha * mColor * (<span class="hljs-number">1</span> - iAlpha));

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">sInCalc</span> = (<span class="hljs-params">iColor, iAlpha, mAlpha</span>) =&gt; iAlpha * iColor * mAlpha;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">sOutCalc</span> = (<span class="hljs-params">iColor, iAlpha, mAlpha</span>) =&gt; iAlpha * iColor * (<span class="hljs-number">1</span> - mAlpha);

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dAtopCalc</span> = (<span class="hljs-params">iColor, iAlpha, mColor, mAlpha</span>) =&gt; (iAlpha * iColor * (<span class="hljs-number">1</span> - mAlpha)) + (mAlpha * mColor * iAlpha);

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dOverCalc</span> = (<span class="hljs-params">iColor, iAlpha, mColor, mAlpha</span>) =&gt; (iAlpha * iColor * (<span class="hljs-number">1</span> - mAlpha)) + (mAlpha * mColor);

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dInCalc</span> = (<span class="hljs-params">iColor, iAlpha, mAlpha</span>) =&gt; iAlpha * iColor * mAlpha;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">dOutCalc</span> = (<span class="hljs-params">mColor, iAlpha, mAlpha</span>) =&gt; mAlpha * mColor * (<span class="hljs-number">1</span> - iAlpha);

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">xorCalc</span> = (<span class="hljs-params">iColor, iAlpha, mColor, mAlpha</span>) =&gt; (iAlpha * iColor * (<span class="hljs-number">1</span> - mAlpha)) + (mAlpha * mColor * (<span class="hljs-number">1</span> - iAlpha));

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">sOverCalc</span> = (<span class="hljs-params">iColor, iAlpha, mColor, mAlpha</span>) =&gt; (iAlpha * iColor) + (mAlpha * mColor * (<span class="hljs-number">1</span> - iAlpha));

        <span class="hljs-keyword">let</span> ir, ig, ib, ia, mr, mg, mb, ma, x, y, dinA, dmixA;

        <span class="hljs-keyword">switch</span> (compose) {

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SOURCE_ONLY</span> :
                output.<span class="hljs-property">data</span>.<span class="hljs-title function_">set</span>(iData);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SOURCE_ATOP</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &gt;= <span class="hljs-number">0</span>) {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">sAtopCalc</span>(iData[ir], dinA, mData[mr], dmixA);
                            oData[ig] = <span class="hljs-title function_">sAtopCalc</span>(iData[ig], dinA, mData[mg], dmixA);
                            oData[ib] = <span class="hljs-title function_">sAtopCalc</span>(iData[ib], dinA, mData[mb], dmixA);
                            oData[ia] = ((dinA * dmixA) + (dmixA * (<span class="hljs-number">1</span> - dinA))) * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SOURCE_IN</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &gt;= <span class="hljs-number">0</span>) {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            ma = mr + <span class="hljs-number">3</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">sInCalc</span>(iData[ir], dinA, dmixA);
                            oData[ig] = <span class="hljs-title function_">sInCalc</span>(iData[ig], dinA, dmixA);
                            oData[ib] = <span class="hljs-title function_">sInCalc</span>(iData[ib], dinA, dmixA);
                            oData[ia] = dinA * dmixA * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">SOURCE_OUT</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                        <span class="hljs-keyword">else</span> {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            ma = mr + <span class="hljs-number">3</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">sOutCalc</span>(iData[ir], dinA, dmixA);
                            oData[ig] = <span class="hljs-title function_">sOutCalc</span>(iData[ig], dinA, dmixA);
                            oData[ib] = <span class="hljs-title function_">sOutCalc</span>(iData[ib], dinA, dmixA);
                            oData[ia] = dinA * (<span class="hljs-number">1</span> - dmixA) * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DESTINATION_ONLY</span> :
                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &gt;= <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(mr, ir, mData);
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DESTINATION_ATOP</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                        <span class="hljs-keyword">else</span> {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">dAtopCalc</span>(iData[ir], dinA, mData[mr], dmixA);
                            oData[ig] = <span class="hljs-title function_">dAtopCalc</span>(iData[ig], dinA, mData[mg], dmixA);
                            oData[ib] = <span class="hljs-title function_">dAtopCalc</span>(iData[ib], dinA, mData[mb], dmixA);
                            oData[ia] = ((dinA * (<span class="hljs-number">1</span> - dmixA)) + (dmixA * dinA)) * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DESTINATION_OVER</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                        <span class="hljs-keyword">else</span> {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">dOverCalc</span>(iData[ir], dinA, mData[mr], dmixA);
                            oData[ig] = <span class="hljs-title function_">dOverCalc</span>(iData[ig], dinA, mData[mg], dmixA);
                            oData[ib] = <span class="hljs-title function_">dOverCalc</span>(iData[ib], dinA, mData[mb], dmixA);
                            oData[ia] = ((dinA * (<span class="hljs-number">1</span> - dmixA)) + dmixA) * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DESTINATION_IN</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &gt;= <span class="hljs-number">0</span>) {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">dInCalc</span>(mData[mr], dinA, dmixA);
                            oData[ig] = <span class="hljs-title function_">dInCalc</span>(mData[mg], dinA, dmixA);
                            oData[ib] = <span class="hljs-title function_">dInCalc</span>(mData[mb], dinA, dmixA);
                            oData[ia] = dinA * dmixA * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">DESTINATION_OUT</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &gt;= <span class="hljs-number">0</span>) {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">dOutCalc</span>(mData[mr], dinA, dmixA);
                            oData[ig] = <span class="hljs-title function_">dOutCalc</span>(mData[mg], dinA, dmixA);
                            oData[ib] = <span class="hljs-title function_">dOutCalc</span>(mData[mb], dinA, dmixA);
                            oData[ia] = dmixA * (<span class="hljs-number">1</span> - dinA) * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">CLEAR</span> :
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">XOR</span> :

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                        <span class="hljs-keyword">else</span> {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">xorCalc</span>(iData[ir], dinA, mData[mr], dmixA);
                            oData[ig] = <span class="hljs-title function_">xorCalc</span>(iData[ig], dinA, mData[mg], dmixA);
                            oData[ib] = <span class="hljs-title function_">xorCalc</span>(iData[ib], dinA, mData[mb], dmixA);
                            oData[ia] = ((dinA * (<span class="hljs-number">1</span> - dmixA)) + (dmixA * (<span class="hljs-number">1</span> - dinA))) * <span class="hljs-number">255</span>;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-attr">default</span>:

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                        [ir, mr] = <span class="hljs-title function_">getLinePositions</span>(x, y);

                        <span class="hljs-keyword">if</span> (mr &lt; <span class="hljs-number">0</span>) <span class="hljs-title function_">copyPixel</span>(ir, ir, iData);
                        <span class="hljs-keyword">else</span> {

                            ig = ir + <span class="hljs-number">1</span>;
                            ib = ig + <span class="hljs-number">1</span>;
                            ia = ib + <span class="hljs-number">1</span>;
                            mg = mr + <span class="hljs-number">1</span>;
                            mb = mg + <span class="hljs-number">1</span>;
                            ma = mb + <span class="hljs-number">1</span>;

                            dinA = iData[ia] / <span class="hljs-number">255</span>;
                            dmixA = mData[ma] / <span class="hljs-number">255</span>;

                            oData[ir] = <span class="hljs-title function_">sOverCalc</span>(iData[ir], dinA, mData[mr], dmixA);
                            oData[ig] = <span class="hljs-title function_">sOverCalc</span>(iData[ig], dinA, mData[mg], dmixA);
                            oData[ib] = <span class="hljs-title function_">sOverCalc</span>(iData[ib], dinA, mData[mb], dmixA);
                            oData[ia] = (dinA + (dmixA * (<span class="hljs-number">1</span> - dinA))) * <span class="hljs-number">255</span>;
                        }
                    }
                }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <p><strong>corrode</strong> - Performs a special form of matrix operation on each pixel’s color and alpha channels, calculating the new value using neighbouring pixel values. Note that this filter is expensive, thus much slower to complete compared to other filter effects. The matrix dimensions can be set using the “width” and “height” arguments, while setting the home pixel’s position within the matrix can be set using the “offsetX” and “offsetY” arguments. The operation will set the pixel’s channel value to match either the lowest, highest, mean or median values as dictated by its neighbours - this value is set in the “level” attribute. Channels can be selected by setting the “includeRed”, “includeGreen”, “includeBlue” (all false by default) and “includeAlpha” (default: true) flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">CORRODE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> doCalculations = <span class="hljs-keyword">function</span> (<span class="hljs-params">data, matrix, offset</span>) {

            <span class="hljs-keyword">let</span> max = <span class="hljs-number">0</span>,
                min = <span class="hljs-number">255</span>,
                v, c;

            <span class="hljs-keyword">const</span> matlen = matrix.<span class="hljs-property">length</span>;

            <span class="hljs-keyword">for</span> (c = <span class="hljs-number">0</span>; c &lt; matlen; c++) {

                v = data[matrix[c] + offset];

                <span class="hljs-keyword">if</span> (v &lt; min) min = v;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v &gt; max) max = v;
            }

            <span class="hljs-keyword">switch</span> (operation) {

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;lowest&#x27;</span> :
                    <span class="hljs-keyword">return</span> min;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;highest&#x27;</span> :
                    <span class="hljs-keyword">return</span> max;

                <span class="hljs-keyword">default</span> :
                    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_floor</span>(min + ((max - min) / <span class="hljs-number">2</span>));
            }
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">false</span>,
            includeGreen = <span class="hljs-literal">false</span>,
            includeBlue = <span class="hljs-literal">false</span>,
            includeAlpha = <span class="hljs-literal">true</span>,
            operation = <span class="hljs-variable constant_">MEAN</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> width = requirements.<span class="hljs-property">width</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(width) || width &lt; <span class="hljs-number">1</span>) width = <span class="hljs-number">3</span>;
        width = <span class="hljs-title function_">_floor</span>(width);

        <span class="hljs-keyword">let</span> height = requirements.<span class="hljs-property">height</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(height) || height &lt; <span class="hljs-number">1</span>) height = <span class="hljs-number">3</span>;
        height = <span class="hljs-title function_">_floor</span>(height);

        <span class="hljs-keyword">let</span> offsetX = requirements.<span class="hljs-property">offsetX</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(offsetX) || offsetX &lt; <span class="hljs-number">1</span>) offsetX = <span class="hljs-number">1</span>;
        offsetX = <span class="hljs-title function_">_floor</span>(offsetX);

        <span class="hljs-keyword">let</span> offsetY = requirements.<span class="hljs-property">offsetY</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(offsetY) || offsetY &lt; <span class="hljs-number">1</span>) offsetY = <span class="hljs-number">1</span>;
        offsetY = <span class="hljs-title function_">_floor</span>(offsetY);

        <span class="hljs-keyword">const</span> grid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildMatrixGrid</span>(width, height, offsetX, offsetY, input);

        <span class="hljs-keyword">const</span> m = <span class="hljs-title function_">_floor</span>(len / <span class="hljs-number">4</span>);

        <span class="hljs-keyword">let</span> r, g, b, a, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; m; i++) {

            r = i * <span class="hljs-number">4</span>;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            oData[r] = (includeRed) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">0</span>) : iData[r];
            oData[g] = (includeGreen) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">1</span>) : iData[g];
            oData[b] = (includeBlue) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">2</span>) : iData[b];
            oData[a] = (includeAlpha) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">3</span>) : iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <p><strong>displace</strong> - Shift pixels around the image, based on the values supplied in a displacement image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">DISPLACE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> copyPixel = <span class="hljs-keyword">function</span> (<span class="hljs-params">fromPos, toPos, data</span>) {

            <span class="hljs-keyword">if</span> (fromPos &lt; <span class="hljs-number">0</span>) oData[toPos + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">else</span> {

                oData[toPos] = data[fromPos];

                fromPos++;
                toPos++;
                oData[toPos] = data[fromPos];

                fromPos++;
                toPos++;
                oData[toPos] = data[fromPos];

                fromPos++;
                toPos++;
                oData[toPos] = data[fromPos];
            }
        };

        <span class="hljs-keyword">const</span> getLinePositions = <span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) {

            <span class="hljs-keyword">const</span> ix = x,
                iy = y,
                mx = x + offsetX,
                my = y + offsetY;

            <span class="hljs-keyword">let</span> mPos = -<span class="hljs-number">1</span>;

            <span class="hljs-keyword">const</span> iPos = ((iy * iWidth) + ix) * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">if</span> (mx &gt;= <span class="hljs-number">0</span> &amp;&amp; mx &lt; mWidth &amp;&amp; my &gt;= <span class="hljs-number">0</span> &amp;&amp; my &lt; mHeight) mPos = ((my * mWidth) + mx) * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">return</span> [iPos, mPos];
        };

        <span class="hljs-keyword">const</span> [input, output, mix] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:iWidth, <span class="hljs-attr">height</span>:iHeight, <span class="hljs-attr">data</span>:iData} = input;
        <span class="hljs-keyword">const</span> {<span class="hljs-attr">data</span>:oData} = output;
        <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:mWidth, <span class="hljs-attr">height</span>:mHeight, <span class="hljs-attr">data</span>:mData} = mix;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            channelX = <span class="hljs-variable constant_">RED</span>,
            channelY = <span class="hljs-variable constant_">GREEN</span>,
            scaleX = <span class="hljs-number">1</span>,
            scaleY = <span class="hljs-number">1</span>,
            offsetX = <span class="hljs-number">0</span>,
            offsetY = <span class="hljs-number">0</span>,
            transparentEdges = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> offsetForChannelX = <span class="hljs-number">3</span>;
        <span class="hljs-keyword">if</span> (channelX == <span class="hljs-variable constant_">RED</span>) offsetForChannelX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (channelX == <span class="hljs-variable constant_">GREEN</span>) offsetForChannelX = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (channelX == <span class="hljs-variable constant_">BLUE</span>) offsetForChannelX = <span class="hljs-number">2</span>;

        <span class="hljs-keyword">let</span> offsetForChannelY = <span class="hljs-number">3</span>;
        <span class="hljs-keyword">if</span> (channelY == <span class="hljs-variable constant_">RED</span>) offsetForChannelY = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (channelY == <span class="hljs-variable constant_">GREEN</span>) offsetForChannelY = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (channelY == <span class="hljs-variable constant_">BLUE</span>) offsetForChannelY = <span class="hljs-number">2</span>;

        <span class="hljs-keyword">let</span> x, y, dx, dy, dPos, iPos, mPos;

        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; iHeight; y++) {
            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; iWidth; x++) {

                [iPos, mPos] = <span class="hljs-title function_">getLinePositions</span>(x, y);
                <span class="hljs-keyword">if</span> (mPos &gt;= <span class="hljs-number">0</span>) {

                    dx = <span class="hljs-title function_">_floor</span>(x + ((<span class="hljs-number">127</span> - mData[mPos + offsetForChannelX]) / <span class="hljs-number">127</span>) * scaleX);
                    dy = <span class="hljs-title function_">_floor</span>(y + ((<span class="hljs-number">127</span> - mData[mPos + offsetForChannelY]) / <span class="hljs-number">127</span>) * scaleY);

                    <span class="hljs-keyword">if</span> (!transparentEdges) {

                        <span class="hljs-keyword">if</span> (dx &lt; <span class="hljs-number">0</span>) dx = <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">if</span> (dx &gt;= iWidth) dx = iWidth - <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">if</span> (dy &lt; <span class="hljs-number">0</span>) dy = <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">if</span> (dy &gt;= iHeight) dy = iHeight - <span class="hljs-number">1</span>;

                        dPos = ((dy * iWidth) + dx) * <span class="hljs-number">4</span>;
                    }
                    <span class="hljs-keyword">else</span> {

                        <span class="hljs-keyword">if</span> (dx &lt; <span class="hljs-number">0</span> || dx &gt;= iWidth || dy &lt; <span class="hljs-number">0</span> || dy &gt;= iHeight) dPos = -<span class="hljs-number">1</span>;
                        <span class="hljs-keyword">else</span> dPos = ((dy * iWidth) + dx) * <span class="hljs-number">4</span>;
                    }
                    <span class="hljs-title function_">copyPixel</span>(dPos, iPos, iData);
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-title function_">copyPixel</span>(iPos, iPos, iData);
                }
            }
        }
        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-57">&#x00a7;</a>
              </div>
              <p><strong>emboss</strong> - A 3x3 matrix transform; the matrix weights are calculated internally from the values of two arguments: “strength”, and “angle” - which is a value measured in degrees, with 0 degrees pointing to the right of the origin (along the positive x axis). Post-processing options include removing unchanged pixels, or setting then to mid-gray. The convenience method includes additional arguments which will add a choice of grayscale, then channel clamping, then blurring actions before passing the results to this emboss action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">EMBOSS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> doCalculations = <span class="hljs-keyword">function</span> (<span class="hljs-params">data, matrix, offset</span>) {

            <span class="hljs-keyword">let</span> val = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> m = <span class="hljs-number">0</span>, mz = matrix.<span class="hljs-property">length</span>; m &lt; mz; m++) {

                <span class="hljs-keyword">if</span> (weights[m]) val += (data[matrix[m] + offset] * weights[m]);
            }
            <span class="hljs-keyword">return</span> val;
        }

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            tolerance = <span class="hljs-number">0</span>,
            keepOnlyChangedAreas = <span class="hljs-literal">false</span>,
            postProcessResults = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> strength = <span class="hljs-title function_">_abs</span>(requirements.<span class="hljs-property">strength</span> || <span class="hljs-number">1</span>);

        <span class="hljs-keyword">const</span> angle = <span class="hljs-title function_">correctAngle</span>(requirements.<span class="hljs-property">angle</span> || <span class="hljs-number">0</span>);

        <span class="hljs-keyword">const</span> slices = <span class="hljs-title function_">_floor</span>(angle / <span class="hljs-number">45</span>),
            remains = ((angle % <span class="hljs-number">45</span>) / <span class="hljs-number">45</span>) * strength,
            weights = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">9</span>);

        weights.<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
        weights[<span class="hljs-number">4</span>] = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">0</span>) {
            weights[<span class="hljs-number">5</span>] = strength - remains;
            weights[<span class="hljs-number">8</span>] = remains;
            weights[<span class="hljs-number">3</span>] = -weights[<span class="hljs-number">5</span>];
            weights[<span class="hljs-number">0</span>] = -weights[<span class="hljs-number">8</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">1</span>) {
            weights[<span class="hljs-number">8</span>] = strength - remains;
            weights[<span class="hljs-number">7</span>] = remains;
            weights[<span class="hljs-number">0</span>] = -weights[<span class="hljs-number">8</span>];
            weights[<span class="hljs-number">1</span>] = -weights[<span class="hljs-number">7</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">2</span>) {
            weights[<span class="hljs-number">7</span>] = strength - remains;
            weights[<span class="hljs-number">6</span>] = remains;
            weights[<span class="hljs-number">1</span>] = -weights[<span class="hljs-number">7</span>];
            weights[<span class="hljs-number">2</span>] = -weights[<span class="hljs-number">6</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">3</span>) {
            weights[<span class="hljs-number">6</span>] = strength - remains;
            weights[<span class="hljs-number">3</span>] = remains;
            weights[<span class="hljs-number">2</span>] = -weights[<span class="hljs-number">6</span>];
            weights[<span class="hljs-number">5</span>] = -weights[<span class="hljs-number">3</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">4</span>) {
            weights[<span class="hljs-number">3</span>] = strength - remains;
            weights[<span class="hljs-number">0</span>] = remains;
            weights[<span class="hljs-number">5</span>] = -weights[<span class="hljs-number">3</span>];
            weights[<span class="hljs-number">8</span>] = -weights[<span class="hljs-number">0</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">5</span>) {
            weights[<span class="hljs-number">0</span>] = strength - remains;
            weights[<span class="hljs-number">1</span>] = remains;
            weights[<span class="hljs-number">8</span>] = -weights[<span class="hljs-number">0</span>];
            weights[<span class="hljs-number">7</span>] = -weights[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (slices == <span class="hljs-number">6</span>) {
            weights[<span class="hljs-number">1</span>] = strength - remains;
            weights[<span class="hljs-number">2</span>] = remains;
            weights[<span class="hljs-number">7</span>] = -weights[<span class="hljs-number">1</span>];
            weights[<span class="hljs-number">6</span>] = -weights[<span class="hljs-number">2</span>];
        }
        <span class="hljs-keyword">else</span> {
            weights[<span class="hljs-number">2</span>] = strength - remains;
            weights[<span class="hljs-number">5</span>] = remains;
            weights[<span class="hljs-number">6</span>] = -weights[<span class="hljs-number">2</span>];
            weights[<span class="hljs-number">3</span>] = -weights[<span class="hljs-number">5</span>];
        }

        <span class="hljs-keyword">const</span> grid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildMatrixGrid</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, input);

        <span class="hljs-keyword">let</span> i, r, g, b, a, iR, iG, iB, iA, oR, oG, oB, m;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            iR = iData[r];
            iG = iData[g];
            iB = iData[b];
            iA = iData[a];

            <span class="hljs-keyword">if</span> (iA) {

                m = <span class="hljs-title function_">_floor</span>(i / <span class="hljs-number">4</span>);

                oData[r] = <span class="hljs-title function_">doCalculations</span>(iData, grid[m], <span class="hljs-number">0</span>);
                oData[g] = <span class="hljs-title function_">doCalculations</span>(iData, grid[m], <span class="hljs-number">1</span>);
                oData[b] = <span class="hljs-title function_">doCalculations</span>(iData, grid[m], <span class="hljs-number">2</span>);
                oData[a] = iData[a];

                <span class="hljs-keyword">if</span> (postProcessResults) {

                    oR = oData[r];
                    oG = oData[g];
                    oB = oData[b];

                    <span class="hljs-keyword">if</span> (oR &gt;= iR - tolerance &amp;&amp; oR &lt;= iR + tolerance &amp;&amp;
                        oG &gt;= iG - tolerance &amp;&amp; oG &lt;= iG + tolerance &amp;&amp;
                        oB &gt;= iB - tolerance &amp;&amp; oB &lt;= iB + tolerance) {

                        <span class="hljs-keyword">if</span> (keepOnlyChangedAreas) oData[a] = <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">else</span> {
                            oData[r] = <span class="hljs-number">127</span>;
                            oData[g] = <span class="hljs-number">127</span>;
                            oData[b] = <span class="hljs-number">127</span>;
                        }
                    }
                }
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-58">&#x00a7;</a>
              </div>
              <p><strong>flood</strong> - Set all pixels to the channel values supplied in the “red”, “green”, “blue” and “alpha” arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">FLOOD</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            red = <span class="hljs-number">0</span>,
            green = <span class="hljs-number">0</span>,
            blue = <span class="hljs-number">0</span>,
            alpha = <span class="hljs-number">255</span>,
            excludeAlpha = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> i, c, a;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            a = i + <span class="hljs-number">3</span>;

            <span class="hljs-keyword">if</span> (iData[a]) {

                c = i;
                oData[c] = red;

                c++;
                oData[c] = green;

                c++;
                oData[c] = blue;

                c++;
                oData[c] = (excludeAlpha) ? iData[a] : alpha;
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-59">&#x00a7;</a>
              </div>
              <p><strong>gaussian-blur</strong> - from this GitHub repository: <a href="https://github.com/nodeca/glur/blob/master/index.js">https://github.com/nodeca/glur/blob/master/index.js</a> (code accessed 1 June 2021)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">GAUSSIAN_BLUR</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">let</span> a0, a1, a2, a3, b1, b2, left_corner, right_corner;

        <span class="hljs-keyword">const</span> gaussCoef = <span class="hljs-keyword">function</span> (<span class="hljs-params">sigma</span>) {

            <span class="hljs-keyword">if</span> (sigma &lt; <span class="hljs-number">0.5</span>) sigma = <span class="hljs-number">0.5</span>;

            <span class="hljs-keyword">const</span> a = <span class="hljs-title function_">_exp</span>(<span class="hljs-number">0.726</span> * <span class="hljs-number">0.726</span>) / sigma,
                g1 = <span class="hljs-title function_">_exp</span>(-a),
                g2 = <span class="hljs-title function_">_exp</span>(-<span class="hljs-number">2</span> * a),
                k = (<span class="hljs-number">1</span> - g1) * (<span class="hljs-number">1</span> - g1) / (<span class="hljs-number">1</span> + <span class="hljs-number">2</span> * a * g1 - g2);

            a0 = k;
            a1 = k * (a - <span class="hljs-number">1</span>) * g1;
            a2 = k * (a + <span class="hljs-number">1</span>) * g1;
            a3 = -k * g2;
            b1 = <span class="hljs-number">2</span> * g1;
            b2 = -g2;
            left_corner = (a0 + a1) / (<span class="hljs-number">1</span> - b1 - b2);
            right_corner = (a2 + a3) / (<span class="hljs-number">1</span> - b1 - b2);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-60">&#x00a7;</a>
              </div>
              <p>Attempt to force type to FP32.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>([ a0, a1, a2, a3, b1, b2, left_corner, right_corner ]);
        }

        <span class="hljs-keyword">const</span> convolveRGBA = <span class="hljs-keyword">function</span> (<span class="hljs-params">src, out, line, coeff, width, height</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-61">&#x00a7;</a>
              </div>
              <p>takes src image and writes the blurred and transposed result into out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">let</span> rgba;
            <span class="hljs-keyword">let</span> prev_src_r, prev_src_g, prev_src_b, prev_src_a;
            <span class="hljs-keyword">let</span> curr_src_r, curr_src_g, curr_src_b, curr_src_a;
            <span class="hljs-keyword">let</span> curr_out_r, curr_out_g, curr_out_b, curr_out_a;
            <span class="hljs-keyword">let</span> prev_out_r, prev_out_g, prev_out_b, prev_out_a;
            <span class="hljs-keyword">let</span> prev_prev_out_r, prev_prev_out_g, prev_prev_out_b, prev_prev_out_a;

            <span class="hljs-keyword">let</span> src_index, out_index, line_index;
            <span class="hljs-keyword">let</span> i, j;
            <span class="hljs-keyword">let</span> coeff_a0, coeff_a1, coeff_b1, coeff_b2;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; height; i++) {

                src_index = i * width;
                out_index = i;
                line_index = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-62">&#x00a7;</a>
              </div>
              <p>left to right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                rgba = src[src_index];

                prev_src_r = rgba &amp; <span class="hljs-number">0xff</span>;
                prev_src_g = (rgba &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>;
                prev_src_b = (rgba &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>;
                prev_src_a = (rgba &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>;

                prev_prev_out_r = prev_src_r * coeff[<span class="hljs-number">6</span>];
                prev_prev_out_g = prev_src_g * coeff[<span class="hljs-number">6</span>];
                prev_prev_out_b = prev_src_b * coeff[<span class="hljs-number">6</span>];
                prev_prev_out_a = prev_src_a * coeff[<span class="hljs-number">6</span>];

                prev_out_r = prev_prev_out_r;
                prev_out_g = prev_prev_out_g;
                prev_out_b = prev_prev_out_b;
                prev_out_a = prev_prev_out_a;

                coeff_a0 = coeff[<span class="hljs-number">0</span>];
                coeff_a1 = coeff[<span class="hljs-number">1</span>];
                coeff_b1 = coeff[<span class="hljs-number">4</span>];
                coeff_b2 = coeff[<span class="hljs-number">5</span>];

                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; width; j++) {

                    rgba = src[src_index];
                    curr_src_r = rgba &amp; <span class="hljs-number">0xff</span>;
                    curr_src_g = (rgba &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>;
                    curr_src_b = (rgba &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>;
                    curr_src_a = (rgba &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>;

                    curr_out_r = curr_src_r * coeff_a0 + prev_src_r * coeff_a1 + prev_out_r * coeff_b1 + prev_prev_out_r * coeff_b2;
                    curr_out_g = curr_src_g * coeff_a0 + prev_src_g * coeff_a1 + prev_out_g * coeff_b1 + prev_prev_out_g * coeff_b2;
                    curr_out_b = curr_src_b * coeff_a0 + prev_src_b * coeff_a1 + prev_out_b * coeff_b1 + prev_prev_out_b * coeff_b2;
                    curr_out_a = curr_src_a * coeff_a0 + prev_src_a * coeff_a1 + prev_out_a * coeff_b1 + prev_prev_out_a * coeff_b2;

                    prev_prev_out_r = prev_out_r;
                    prev_prev_out_g = prev_out_g;
                    prev_prev_out_b = prev_out_b;
                    prev_prev_out_a = prev_out_a;

                    prev_out_r = curr_out_r;
                    prev_out_g = curr_out_g;
                    prev_out_b = curr_out_b;
                    prev_out_a = curr_out_a;

                    prev_src_r = curr_src_r;
                    prev_src_g = curr_src_g;
                    prev_src_b = curr_src_b;
                    prev_src_a = curr_src_a;

                    line[line_index] = prev_out_r;
                    line[line_index + <span class="hljs-number">1</span>] = prev_out_g;
                    line[line_index + <span class="hljs-number">2</span>] = prev_out_b;
                    line[line_index + <span class="hljs-number">3</span>] = prev_out_a;
                    line_index += <span class="hljs-number">4</span>;
                    src_index++;
                }

                src_index--;
                line_index -= <span class="hljs-number">4</span>;
                out_index += height * (width - <span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-63">&#x00a7;</a>
              </div>
              <p>right to left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                rgba = src[src_index];

                prev_src_r = rgba &amp; <span class="hljs-number">0xff</span>;
                prev_src_g = (rgba &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>;
                prev_src_b = (rgba &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>;
                prev_src_a = (rgba &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>;

                prev_prev_out_r = prev_src_r * coeff[<span class="hljs-number">7</span>];
                prev_prev_out_g = prev_src_g * coeff[<span class="hljs-number">7</span>];
                prev_prev_out_b = prev_src_b * coeff[<span class="hljs-number">7</span>];
                prev_prev_out_a = prev_src_a * coeff[<span class="hljs-number">7</span>];

                prev_out_r = prev_prev_out_r;
                prev_out_g = prev_prev_out_g;
                prev_out_b = prev_prev_out_b;
                prev_out_a = prev_prev_out_a;

                curr_src_r = prev_src_r;
                curr_src_g = prev_src_g;
                curr_src_b = prev_src_b;
                curr_src_a = prev_src_a;

                coeff_a0 = coeff[<span class="hljs-number">2</span>];
                coeff_a1 = coeff[<span class="hljs-number">3</span>];

                <span class="hljs-keyword">for</span> (j = width - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {

                    curr_out_r = curr_src_r * coeff_a0 + prev_src_r * coeff_a1 + prev_out_r * coeff_b1 + prev_prev_out_r * coeff_b2;
                    curr_out_g = curr_src_g * coeff_a0 + prev_src_g * coeff_a1 + prev_out_g * coeff_b1 + prev_prev_out_g * coeff_b2;
                    curr_out_b = curr_src_b * coeff_a0 + prev_src_b * coeff_a1 + prev_out_b * coeff_b1 + prev_prev_out_b * coeff_b2;
                    curr_out_a = curr_src_a * coeff_a0 + prev_src_a * coeff_a1 + prev_out_a * coeff_b1 + prev_prev_out_a * coeff_b2;

                    prev_prev_out_r = prev_out_r;
                    prev_prev_out_g = prev_out_g;
                    prev_prev_out_b = prev_out_b;
                    prev_prev_out_a = prev_out_a;

                    prev_out_r = curr_out_r;
                    prev_out_g = curr_out_g;
                    prev_out_b = curr_out_b;
                    prev_out_a = curr_out_a;

                    prev_src_r = curr_src_r;
                    prev_src_g = curr_src_g;
                    prev_src_b = curr_src_b;
                    prev_src_a = curr_src_a;

                    rgba = src[src_index];
                    curr_src_r = rgba &amp; <span class="hljs-number">0xff</span>;
                    curr_src_g = (rgba &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>;
                    curr_src_b = (rgba &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>;
                    curr_src_a = (rgba &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>;

                    rgba = ((line[line_index] + prev_out_r) &lt;&lt; <span class="hljs-number">0</span>) +
                    ((line[line_index + <span class="hljs-number">1</span>] + prev_out_g) &lt;&lt; <span class="hljs-number">8</span>) +
                    ((line[line_index + <span class="hljs-number">2</span>] + prev_out_b) &lt;&lt; <span class="hljs-number">16</span>) +
                    ((line[line_index + <span class="hljs-number">3</span>] + prev_out_a) &lt;&lt; <span class="hljs-number">24</span>);

                    out[out_index] = rgba;

                    src_index--;
                    line_index -= <span class="hljs-number">4</span>;
                    out_index -= height;
                }
            }
        }

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>;

        <span class="hljs-keyword">const</span> {width, height} = input;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            radius = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> hold = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>(iData);

        <span class="hljs-keyword">const</span> src32 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(hold.<span class="hljs-property">buffer</span>);

        <span class="hljs-keyword">const</span> out = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(src32.<span class="hljs-property">length</span>),
            tmp_line = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-title function_">_max</span>(width, height) * <span class="hljs-number">4</span>);

        <span class="hljs-keyword">const</span> coeff = <span class="hljs-title function_">gaussCoef</span>(radius);

        <span class="hljs-title function_">convolveRGBA</span>(src32, out, tmp_line, coeff, width, height, radius);
        <span class="hljs-title function_">convolveRGBA</span>(out, src32, tmp_line, coeff, height, width, radius);

        oData.<span class="hljs-title function_">set</span>(hold);

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-64">&#x00a7;</a>
              </div>
              <p><strong>glitch</strong> - Swap pixels at random within a given box (width/height) distance of each other, dependent on the level setting - lower levels mean less noise. Uses a pseudo-random numbers generator to ensure consistent results across runs. Takes into account choices to include red, green, blue and alpha channels, and whether to ignore transparent pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">GLITCH</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>,
            iWidth = input.<span class="hljs-property">width</span>,
            iHeight = input.<span class="hljs-property">height</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            useMixedChannel = <span class="hljs-literal">true</span>,
            seed = <span class="hljs-variable constant_">DEFAULT_SEED</span>,
            level = <span class="hljs-number">0</span>,
            offsetMin = <span class="hljs-number">0</span>,
            offsetMax = <span class="hljs-number">0</span>,
            offsetRedMin = <span class="hljs-number">0</span>,
            offsetRedMax = <span class="hljs-number">0</span>,
            offsetGreenMin = <span class="hljs-number">0</span>,
            offsetGreenMax = <span class="hljs-number">0</span>,
            offsetBlueMin = <span class="hljs-number">0</span>,
            offsetBlueMax = <span class="hljs-number">0</span>,
            offsetAlphaMin = <span class="hljs-number">0</span>,
            offsetAlphaMax = <span class="hljs-number">0</span>,
            transparentEdges = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> step = <span class="hljs-title function_">_floor</span>(requirements.<span class="hljs-property">step</span>);
        <span class="hljs-keyword">if</span> (step &lt; <span class="hljs-number">1</span>) step = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">const</span> rnd = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRandomNumbers</span>({
            seed,
            <span class="hljs-attr">length</span>: iHeight * <span class="hljs-number">5</span>,
        });

        <span class="hljs-keyword">const</span> range = offsetMax - offsetMin,
            redRange = offsetRedMax - offsetRedMin,
            greenRange = offsetGreenMax - offsetGreenMin,
            blueRange = offsetBlueMax - offsetBlueMin,
            alphaRange = offsetAlphaMax - offsetAlphaMin;

        <span class="hljs-keyword">let</span> rndCursor = -<span class="hljs-number">1</span>;

        <span class="hljs-keyword">const</span> rows = [];

        <span class="hljs-keyword">let</span> i, j, affectedRow, shift, shiftR, shiftG, shiftB, shiftA,
            r, g, b, a, w, currentRow, currentRowStart, currentRowEnd, cursor,
            dr, dg, db, da, ur, ug, ub, ua;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; iHeight; i += step) {

            affectedRow = (rnd[++rndCursor] &lt; level) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (affectedRow) {

                <span class="hljs-keyword">if</span> (useMixedChannel) {

                    shift = (offsetMin + <span class="hljs-title function_">_floor</span>(rnd[++rndCursor] * range)) * <span class="hljs-number">4</span>;

                    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; step; j++) {

                        rows.<span class="hljs-title function_">push</span>(shift, shift, shift, shift);
                    }
                }
                <span class="hljs-keyword">else</span> {

                    shiftR = (offsetRedMin + <span class="hljs-title function_">_floor</span>(rnd[++rndCursor] * redRange)) * <span class="hljs-number">4</span>;
                    shiftG = (offsetGreenMin + <span class="hljs-title function_">_floor</span>(rnd[++rndCursor] * greenRange)) * <span class="hljs-number">4</span>;
                    shiftB= (offsetBlueMin + <span class="hljs-title function_">_floor</span>(rnd[++rndCursor] * blueRange)) * <span class="hljs-number">4</span>;
                    shiftA= (offsetAlphaMin + <span class="hljs-title function_">_floor</span>(rnd[++rndCursor] * alphaRange)) * <span class="hljs-number">4</span>;

                    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; step; j++) {

                        rows.<span class="hljs-title function_">push</span>(shiftR, shiftG, shiftB, shiftA);
                    }
                }
            }
            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; step; j++) {

                    rows.<span class="hljs-title function_">push</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                }
            }
        }

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            w = iWidth * <span class="hljs-number">4</span>;
            currentRow = <span class="hljs-title function_">_floor</span>(i / w);
            cursor = currentRow * <span class="hljs-number">4</span>;

            dr = rows[cursor];
            dg = rows[++cursor];
            db = rows[++cursor];
            da = rows[++cursor];

            ur = r + dr;
            ug = g + dg;
            ub = b + db;
            ua = a + da;

            oData[r] = iData[ur];
            oData[g] = iData[ug];
            oData[b] = iData[ub];

            <span class="hljs-keyword">if</span> (transparentEdges) {

                currentRowStart = currentRow * w;
                currentRowEnd = currentRowStart + w;

                <span class="hljs-keyword">if</span> (ur &lt; currentRowStart || ur &gt; currentRowEnd || ug &lt; currentRowStart || ug &gt; currentRowEnd || ub &lt; currentRowStart || ub &gt; currentRowEnd || ua &lt; currentRowStart || ua &gt; currentRowEnd) oData[a] = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">else</span> oData[a] = iData[ua];
            }
            <span class="hljs-keyword">else</span> oData[a] = iData[ua];
        }
        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-65">&#x00a7;</a>
              </div>
              <p><strong>grayscale</strong> - For each pixel, averages the weighted color channels and applies the result across all the color channels. This gives a more realistic monochrome effect.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">GRAYSCALE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> gVal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGrayscaleValue</span>;

        <span class="hljs-keyword">let</span> r, g, b, a, i, gray;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            gray = <span class="hljs-title function_">gVal</span>(iData[r], iData[g], iData[b]);

            oData[r] = gray;
            oData[g] = gray;
            oData[b] = gray;
            oData[a] = iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-66">&#x00a7;</a>
              </div>
              <p><strong>invert-channels</strong> - For each pixel, subtracts its current channel values - when included - from 255.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">INVERT_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            oData[r] = (includeRed) ? <span class="hljs-number">255</span> - iData[r] : iData[r];
            oData[g] = (includeGreen) ? <span class="hljs-number">255</span> - iData[g] : iData[g];
            oData[b] = (includeBlue) ? <span class="hljs-number">255</span> - iData[b] : iData[b];
            oData[a] = (includeAlpha) ? <span class="hljs-number">255</span> - iData[a] : iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-67">&#x00a7;</a>
              </div>
              <p><strong>lock-channels-to-levels</strong> - Produces a posterize effect. Takes in four arguments - “red”, “green”, “blue” and “alpha” - each of which is an Array of zero or more integer Numbers (between 0 and 255). The filter works by looking at each pixel’s channel value and determines which of the corresponding Array’s Number values it is closest to; it then sets the channel value to that Number value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">LOCK_CHANNELS_TO_LEVELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> getLCTLValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">val, levels</span>) {

            <span class="hljs-keyword">if</span> (!levels.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> val;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>, jz = levels.<span class="hljs-property">length</span>; j &lt; jz; j++) {

                <span class="hljs-keyword">const</span> [start, end, level] = levels[j];
                <span class="hljs-keyword">if</span> (val &gt;= start &amp;&amp; val &lt;= end) <span class="hljs-keyword">return</span> level;
            }
        };

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkChannelLevelsParameters</span>(requirements);

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            red = [<span class="hljs-number">0</span>],
            green = [<span class="hljs-number">0</span>],
            blue = [<span class="hljs-number">0</span>],
            alpha = [<span class="hljs-number">255</span>],
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            oData[r] = <span class="hljs-title function_">getLCTLValue</span>(iData[r], red);
            oData[g] = <span class="hljs-title function_">getLCTLValue</span>(iData[g], green);
            oData[b] = <span class="hljs-title function_">getLCTLValue</span>(iData[b], blue);
            oData[a] = <span class="hljs-title function_">getLCTLValue</span>(iData[a], alpha);
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-68">&#x00a7;</a>
              </div>
              <p><strong>map-to-gradient</strong> - maps the colors in the supplied (complex) gradient to a grayscaled input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">MAP_TO_GRADIENT</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            useNaturalGrayscale = <span class="hljs-literal">false</span>,
            gradient = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">if</span> (gradient) {

            <span class="hljs-keyword">let</span> i, avg, r, g, b, a, v;

            <span class="hljs-keyword">const</span> rainbowData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGradientData</span>(gradient);

            <span class="hljs-keyword">if</span> (rainbowData.<span class="hljs-property">length</span>) {

                <span class="hljs-keyword">const</span> gVal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGrayscaleValue</span>;

                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

                    r = i;
                    g = r + <span class="hljs-number">1</span>;
                    b = g + <span class="hljs-number">1</span>;
                    a = b + <span class="hljs-number">1</span>;

                    <span class="hljs-keyword">if</span> (iData[a]) {

                        <span class="hljs-keyword">if</span> (useNaturalGrayscale) avg = <span class="hljs-title function_">gVal</span>(iData[r], iData[g], iData[b]);
                        <span class="hljs-keyword">else</span> avg = <span class="hljs-title function_">_floor</span>((<span class="hljs-number">0.3333</span> * iData[r]) + (<span class="hljs-number">0.3333</span> * iData[g]) + (<span class="hljs-number">0.3333</span> * iData[b]));

                        v = avg * <span class="hljs-number">4</span>;

                        oData[r] = rainbowData[v];
                        v++;
                        oData[g] = rainbowData[v];
                        v++;
                        oData[b] = rainbowData[v];
                        v++;
                        oData[a] = rainbowData[v];
                    }
                }
            }
            <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transferDataUnchanged</span>(oData, iData, len);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transferDataUnchanged</span>(oData, iData, len);

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-69">&#x00a7;</a>
              </div>
              <p><strong>matrix</strong> - Performs a matrix operation on each pixel’s channels, calculating the new value using neighbouring pixel weighted values. Also known as a convolution matrix, kernel or mask operation. Note that this filter is expensive, thus much slower to complete compared to other filter effects. The matrix dimensions can be set using the “width” and “height” arguments, while setting the home pixel’s position within the matrix can be set using the “offsetX” and “offsetY” arguments. The weights to be applied need to be supplied in the “weights” argument - an Array listing the weights row-by-row starting from the top-left corner of the matrix. By default all color channels are included in the calculations while the alpha channel is excluded. The ‘edgeDetect’, ‘emboss’ and ‘sharpen’ convenience filter methods all use the matrix action, pre-setting the required weights.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">MATRIX</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> doCalculations = <span class="hljs-keyword">function</span> (<span class="hljs-params">data, matrix, offset</span>) {

            <span class="hljs-keyword">let</span> val = <span class="hljs-number">0</span>,
                c;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> m = <span class="hljs-number">0</span>, mz = matrix.<span class="hljs-property">length</span>; m &lt; mz; m++) {


                <span class="hljs-keyword">if</span> (weights[m]) {

                    c = matrix[m] + offset;
                    val += (data[c] * weights[m]);
                }
            }
            <span class="hljs-keyword">return</span> val;
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            offsetX = <span class="hljs-number">1</span>,
            offsetY = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> width = requirements.<span class="hljs-property">width</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(width) || width &lt; <span class="hljs-number">1</span>) width = <span class="hljs-number">3</span>;
        width = <span class="hljs-title function_">_floor</span>(width);

        <span class="hljs-keyword">let</span> height = requirements.<span class="hljs-property">height</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(height) || height &lt; <span class="hljs-number">1</span>) height = <span class="hljs-number">3</span>;
        height = <span class="hljs-title function_">_floor</span>(height);

        <span class="hljs-keyword">let</span> weights = requirements.<span class="hljs-property">weights</span>;
        <span class="hljs-keyword">if</span> (!weights || weights.<span class="hljs-property">length</span> != (width * height)) {
            weights = [].<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (width * height) - <span class="hljs-number">1</span>);
            weights[<span class="hljs-title function_">_floor</span>(weights.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">const</span> grid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildMatrixGrid</span>(width, height, offsetX, offsetY, input);

        <span class="hljs-keyword">let</span> r, g, b, a, i;

        <span class="hljs-keyword">const</span> pixels = <span class="hljs-title function_">_floor</span>(len / <span class="hljs-number">4</span>);

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; pixels; i++) {

            r = i * <span class="hljs-number">4</span>;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">if</span> (iData[a]) {

                oData[r] = (includeRed) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">0</span>) : iData[r];
                oData[g] = (includeGreen) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">1</span>) : iData[g];
                oData[b] = (includeBlue) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">2</span>) : iData[b];
                oData[a] = (includeAlpha) ? <span class="hljs-title function_">doCalculations</span>(iData, grid[i], <span class="hljs-number">3</span>) : iData[a];
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-70">&#x00a7;</a>
              </div>
              <p><strong>modulate-channels</strong> - Multiplies each channel’s value by the supplied argument value. A channel-argument’s value of ‘0’ will set that channel’s value to zero; a value of ‘1’ will leave the channel value unchanged. If the “saturation” flag is set to ‘true’ the calculation changes to start at that pixel’s grayscale values. The ‘brightness’ and ‘saturation’ filters are special forms of the ‘channels’ filter which use a single “levels” argument to set all three color channel arguments to the same value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">MODULATE_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            red = <span class="hljs-number">1</span>,
            green = <span class="hljs-number">1</span>,
            blue = <span class="hljs-number">1</span>,
            alpha = <span class="hljs-number">1</span>,
            saturation = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, gray, vr, vg, vb, i;

        <span class="hljs-keyword">if</span> (saturation) {

            <span class="hljs-keyword">const</span> gVal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGrayscaleValue</span>;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

                r = i;
                g = r + <span class="hljs-number">1</span>;
                b = g + <span class="hljs-number">1</span>;
                a = b + <span class="hljs-number">1</span>;

                vr = iData[r];
                vg = iData[g];
                vb = iData[b];

                gray = <span class="hljs-title function_">gVal</span>(vr, vg, vb);

                oData[r] = gray + ((vr - gray) * red);
                oData[g] = gray + ((vg - gray) * green);
                oData[b] = gray + ((vb - gray) * blue);
                oData[a] = iData[a] * alpha;
            }
        }
        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

                r = i;
                g = r + <span class="hljs-number">1</span>;
                b = g + <span class="hljs-number">1</span>;
                a = b + <span class="hljs-number">1</span>;

                oData[r] = iData[r] * red;
                oData[g] = iData[g] * green;
                oData[b] = iData[b] * blue;
                oData[a] = iData[a] * alpha;
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-71">&#x00a7;</a>
              </div>
              <p><strong>newsprint</strong> - TODO documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">NEWSPRINT</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> doCalculations = <span class="hljs-keyword">function</span> (<span class="hljs-params">inChannel, outChannel, tile</span>) {

            grays.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
            calcGrays.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">let</span> avg = <span class="hljs-number">0</span>,
                i, r, g, b, a, gray;

            <span class="hljs-keyword">const</span> l = tile.<span class="hljs-property">length</span>;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; l; i++) {

                r = tile[i];
                g = r + <span class="hljs-number">1</span>;
                b = g + <span class="hljs-number">1</span>;

                gray = <span class="hljs-title function_">gVal</span>(inChannel[r], inChannel[g], inChannel[b]);

                avg += gray;
            }
            avg /= l;

            <span class="hljs-keyword">const</span> pattern = patterns[<span class="hljs-title function_">_floor</span>((avg / <span class="hljs-number">255</span>) * <span class="hljs-number">13</span>)];

            <span class="hljs-keyword">if</span> (width == <span class="hljs-number">1</span>) grays.<span class="hljs-title function_">push</span>(...pattern);
            <span class="hljs-keyword">else</span> {

                gray = pattern[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; width; i++) {
                    calcGrays.<span class="hljs-title function_">push</span>(gray);
                }
                gray = pattern[<span class="hljs-number">1</span>];
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; width; i++) {
                    calcGrays.<span class="hljs-title function_">push</span>(gray);
                }
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; width; i++) {
                    grays.<span class="hljs-title function_">push</span>(...calcGrays);
                }
                gray = pattern[<span class="hljs-number">2</span>];
                calcGrays.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; width; i++) {
                    calcGrays.<span class="hljs-title function_">push</span>(gray);
                }
                gray = pattern[<span class="hljs-number">3</span>];
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; width; i++) {
                    calcGrays.<span class="hljs-title function_">push</span>(gray);
                }
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; width; i++) {
                    grays.<span class="hljs-title function_">push</span>(...calcGrays);
                }
            }

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; l; i++) {

                gray = grays[i];

                r = tile[i];
                g = r + <span class="hljs-number">1</span>;
                b = g + <span class="hljs-number">1</span>;
                a = b + <span class="hljs-number">1</span>;

                outChannel[r] = gray;
                outChannel[g] = gray;
                outChannel[b] = gray;
                outChannel[a] = inChannel[a];
            }
        }

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> width = <span class="hljs-title function_">_floor</span>(requirements.<span class="hljs-property">width</span> || <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (width &lt; <span class="hljs-number">1</span>) width = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">const</span> tileDimensions = width * <span class="hljs-number">2</span>;

        <span class="hljs-keyword">const</span> tiles = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageTileSets</span>(tileDimensions, tileDimensions, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">const</span> gVal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGrayscaleValue</span>;
        <span class="hljs-keyword">const</span> patterns = newspaperPatterns;
        <span class="hljs-keyword">const</span> grays = [],
            calcGrays = [];

        tiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> <span class="hljs-title function_">doCalculations</span>(iData, oData, t));

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-72">&#x00a7;</a>
              </div>
              <p><strong>offset</strong> - Offset the input image in the output image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">OFFSET</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            offsetRedX = <span class="hljs-number">0</span>,
            offsetRedY = <span class="hljs-number">0</span>,
            offsetGreenX = <span class="hljs-number">0</span>,
            offsetGreenY = <span class="hljs-number">0</span>,
            offsetBlueX = <span class="hljs-number">0</span>,
            offsetBlueY = <span class="hljs-number">0</span>,
            offsetAlphaX = <span class="hljs-number">0</span>,
            offsetAlphaY = <span class="hljs-number">0</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">if</span> (offsetRedX || offsetGreenX || offsetBlueX || offsetAlphaX || offsetRedY || offsetGreenY || offsetBlueY || offsetAlphaY) {

            <span class="hljs-keyword">let</span> simpleoffset = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (offsetRedX == offsetGreenX &amp;&amp; offsetRedX == offsetBlueX &amp;&amp; offsetRedX == offsetAlphaX &amp;&amp; offsetRedY == offsetGreenY &amp;&amp; offsetRedY == offsetBlueY &amp;&amp; offsetRedY == offsetAlphaY) simpleoffset = <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">const</span> grid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageGrid</span>(input),
                gWidth = grid[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>,
                gHeight = grid.<span class="hljs-property">length</span>;

            <span class="hljs-keyword">let</span> drx, dry, dgx, dgy, dbx, dby, dax, day, inCell, outCell;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; gHeight; y++) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; gWidth; x++) {

                    inCell = grid[y][x] * <span class="hljs-number">4</span>;

                    <span class="hljs-keyword">if</span> (simpleoffset) {

                        drx = x + offsetRedX;
                        dry = y + offsetRedY;

                        <span class="hljs-keyword">if</span> (drx &gt;= <span class="hljs-number">0</span> &amp;&amp; drx &lt; gWidth &amp;&amp; dry &gt;= <span class="hljs-number">0</span> &amp;&amp; dry &lt; gHeight) {

                            outCell = grid[dry][drx] * <span class="hljs-number">4</span>;
                            oData[outCell] = iData[inCell];
                            oData[outCell + <span class="hljs-number">1</span>] = iData[inCell + <span class="hljs-number">1</span>];
                            oData[outCell + <span class="hljs-number">2</span>] = iData[inCell + <span class="hljs-number">2</span>];
                            oData[outCell + <span class="hljs-number">3</span>] = iData[inCell + <span class="hljs-number">3</span>];
                        }
                    }
                    <span class="hljs-keyword">else</span> {

                        drx = x + offsetRedX;
                        dry = y + offsetRedY;
                        dgx = x + offsetGreenX;
                        dgy = y + offsetGreenY;
                        dbx = x + offsetBlueX;
                        dby = y + offsetBlueY;
                        dax = x + offsetAlphaX;
                        day = y + offsetAlphaY;

                        <span class="hljs-keyword">if</span> (drx &gt;= <span class="hljs-number">0</span> &amp;&amp; drx &lt; gWidth &amp;&amp; dry &gt;= <span class="hljs-number">0</span> &amp;&amp; dry &lt; gHeight) {

                            outCell = grid[dry][drx] * <span class="hljs-number">4</span>;
                            oData[outCell] = iData[inCell];
                        }

                        <span class="hljs-keyword">if</span> (dgx &gt;= <span class="hljs-number">0</span> &amp;&amp; dgx &lt; gWidth &amp;&amp; dgy &gt;= <span class="hljs-number">0</span> &amp;&amp; dgy &lt; gHeight) {

                            outCell = grid[dgy][dgx] * <span class="hljs-number">4</span>;
                            oData[outCell + <span class="hljs-number">1</span>] = iData[inCell + <span class="hljs-number">1</span>];
                        }

                        <span class="hljs-keyword">if</span> (dbx &gt;= <span class="hljs-number">0</span> &amp;&amp; dbx &lt; gWidth &amp;&amp; dby &gt;= <span class="hljs-number">0</span> &amp;&amp; dby &lt; gHeight) {

                            outCell = grid[dby][dbx] * <span class="hljs-number">4</span>;
                            oData[outCell + <span class="hljs-number">2</span>] = iData[inCell + <span class="hljs-number">2</span>];
                        }

                        <span class="hljs-keyword">if</span> (dax &gt;= <span class="hljs-number">0</span> &amp;&amp; dax &lt; gWidth &amp;&amp; day &gt;= <span class="hljs-number">0</span> &amp;&amp; day &lt; gHeight) {

                            outCell = grid[day][dax] * <span class="hljs-number">4</span>;
                            oData[outCell + <span class="hljs-number">3</span>] = iData[inCell + <span class="hljs-number">3</span>];
                        }
                    }
                }
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-73">&#x00a7;</a>
              </div>
              <p><strong>pixelate</strong> - Pixelizes the input image by creating a grid of tiles across it and then averaging the color values of each pixel in a tile and setting its value to the average. Tile width and height, and their offset from the top left corner of the image, are set via the “tileWidth”, “tileHeight”, “offsetX” and “offsetY” arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">PIXELATE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> doCalculations = <span class="hljs-keyword">function</span> (<span class="hljs-params">inChannel, outChannel, tile, offset</span>) {

            <span class="hljs-keyword">let</span> avg = tile.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, v</span>) =&gt;</span> a + inChannel[v + offset], <span class="hljs-number">0</span>);

            avg = <span class="hljs-title function_">_floor</span>(avg / tile.<span class="hljs-property">length</span>);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = tile.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                outChannel[tile[i] + offset] = avg;
            }
        }

        <span class="hljs-keyword">const</span> setOutValueToInValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">inChannel, outChannel, tile, offset</span>) {

            <span class="hljs-keyword">let</span> cell;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = tile.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                cell = tile[i];
                outChannel[cell + offset] = inChannel[cell + offset];
            }
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            tileWidth = <span class="hljs-number">1</span>,
            tileHeight = <span class="hljs-number">1</span>,
            offsetX = <span class="hljs-number">0</span>,
            offsetY = <span class="hljs-number">0</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> tiles = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageTileSets</span>(tileWidth, tileHeight, offsetX, offsetY);

        tiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> {

            <span class="hljs-keyword">if</span> (includeRed) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">0</span>);

            <span class="hljs-keyword">if</span> (includeGreen) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">1</span>);

            <span class="hljs-keyword">if</span> (includeBlue) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">2</span>);

            <span class="hljs-keyword">if</span> (includeAlpha) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">3</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">3</span>);
        });

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-74">&#x00a7;</a>
              </div>
              <p><strong>process-image</strong> - Add an asset to the filter, which can then be used by other filters as either their <code>lineIn</code> or <code>lineMix</code> inputs.</p>
<ul>
<li><code>asset</code> - the String name of the asset object. The asset must be pre-loaded before it can be included in the filter; where things go wrong, the system will attempt to load a 1x1 transparent pixel in place of the asset.</li>
<li><code>width</code> and <code>height</code> - arguments are measured in integer Number pixels, or % strings (relative to the source entity/Group/Cell dimensions).</li>
<li><code>copyX</code>, <code>copyY</code>, <code>copyWidth</code>, <code>copyHeight</code> - the start and dimensions of the area of the image to be used in the filter; values are integer Number pixels, or % strings relative to the image’s natural dimensions.</li>
<li>If the image’s dimensions differ from the source entity/Group/Cell dimensions then, where a given dimension is smaller than source, that dimension will be centered; where the image dimension is larger then that dimension will be pinned to the top, or left.</li>
<li>Filters will run faster when the asset’s dimensions match the dimensions of the entity/Group/Cell to which the filter is being applied.</li>
<li><code>lineOut</code> - required. The image will be stored in the filter engine’s cache using this name. Be aware that the filter action does not check for any pre-existing assets cached under this name and, if they exist, will overwrite them with this asset’s data.</li>
<li>Assets are loaded into the filter engine each time the filter runs and are not persisted when the filter completes.</li>
<li>Adding assets to a filter chain will very often disable filter memoization functionality!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">PROCESS_IMAGE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> {assetData, lineOut} = requirements;

        <span class="hljs-keyword">if</span> (lineOut &amp;&amp; lineOut.<span class="hljs-property">substring</span> &amp;&amp; lineOut.<span class="hljs-property">length</span>) {

            <span class="hljs-keyword">let</span> {width, height, data} = assetData;

            <span class="hljs-keyword">if</span> (width &amp;&amp; height &amp;&amp; data) {

                <span class="hljs-keyword">const</span> {<span class="hljs-attr">width</span>:sWidth, <span class="hljs-attr">height</span>:sHeight} = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">source</span>;

                <span class="hljs-keyword">if</span> (sWidth != width || sHeight != height) {

                    <span class="hljs-keyword">const</span> temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(sWidth, sHeight),
                        tempData = temp.<span class="hljs-property">data</span>;

                    <span class="hljs-keyword">let</span> tx, ty, tempCursor, inputCursor,
                        dx = (sWidth - width) / <span class="hljs-number">2</span>,
                        dy = (sHeight - height) / <span class="hljs-number">2</span>;

                    <span class="hljs-keyword">if</span> (dx &lt; <span class="hljs-number">0</span>) dx = <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">if</span> (dy &lt; <span class="hljs-number">0</span>) dy = <span class="hljs-number">0</span>;

                    <span class="hljs-keyword">for</span> (ty = <span class="hljs-number">0</span>; ty &lt; sHeight; ty++) {
                        <span class="hljs-keyword">for</span> (tx = <span class="hljs-number">0</span>; tx &lt; sWidth; tx++) {

                            <span class="hljs-keyword">if</span> (tx &lt; width &amp;&amp; ty &lt; height) {

                                tempCursor = (((ty + dy) * sWidth) + (tx + dx)) * <span class="hljs-number">4</span>;
                                inputCursor = ((ty * width) + tx) * <span class="hljs-number">4</span>;

                                tempData[tempCursor] = data[inputCursor];
                                tempCursor++;
                                inputCursor++;
                                tempData[tempCursor] = data[inputCursor];
                                tempCursor++;
                                inputCursor++;
                                tempData[tempCursor] = data[inputCursor];
                                tempCursor++;
                                inputCursor++;
                                tempData[tempCursor] = data[inputCursor];
                            }
                        }
                    }
                    data = tempData;
                    width = sWidth;
                    height = sHeight;
                }
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[lineOut] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(data, width, height);
            }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-75">&#x00a7;</a>
              </div>
              <p><strong>random-noise</strong> - Swap pixels at random within a given box (width/height) distance of each other, dependent on the level setting - lower levels mean less noise. Uses a pseudo-random numbers generator to ensure consistent results across runs. Takes into account choices to include red, green, blue and alpha channels, and whether to ignore transparent pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">RANDOM_NOISE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>,
            iWidth = input.<span class="hljs-property">width</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            width = <span class="hljs-number">1</span>,
            height = <span class="hljs-number">1</span>,
            level = <span class="hljs-number">0.5</span>,
            seed = <span class="hljs-variable constant_">DEFAULT_SEED</span>,
            noiseType = <span class="hljs-variable constant_">RANDOM</span>,
            noWrap = <span class="hljs-literal">false</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">true</span>,
            excludeTransparentPixels = <span class="hljs-literal">true</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> rnd = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRandomNumbers</span>({
            seed,
            <span class="hljs-attr">length</span>: <span class="hljs-title function_">_ceil</span>((len / <span class="hljs-number">4</span>) * <span class="hljs-number">3</span>),
            <span class="hljs-attr">imgWidth</span>: iWidth,
            <span class="hljs-attr">type</span>: noiseType,
        });

        <span class="hljs-keyword">let</span> rndCursor = -<span class="hljs-number">1</span>,
            rndLevel,
            rndWidth,
            rndHeight,
            r, g, b, a, i, dw, dh, source;

        <span class="hljs-keyword">const</span> halfWidth = width / <span class="hljs-number">2</span>,
            halfHeight = height / <span class="hljs-number">2</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">if</span> (noiseType == <span class="hljs-variable constant_">RANDOM</span>) {

                rndLevel = rnd[++rndCursor];
                rndWidth = rnd[++rndCursor];
                rndHeight = rnd[++rndCursor];
            }
            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">const</span> temp = rnd[++rndCursor];
                rndLevel = temp;
                rndWidth = temp;
                rndHeight = temp;
            }

            <span class="hljs-keyword">if</span> (rndLevel &lt; level) {

                dw = <span class="hljs-title function_">_floor</span>((rndWidth * width) - halfWidth);
                dh = <span class="hljs-title function_">_floor</span>((rndHeight * height) - halfHeight);

                source = i + ((dh * iWidth) + dw) * <span class="hljs-number">4</span>;

                <span class="hljs-keyword">if</span> (noWrap &amp;&amp; (source &lt; <span class="hljs-number">0</span> || source &gt;= len)) {

                    oData[r] = iData[r];
                    oData[g] = iData[g];
                    oData[b] = iData[b];
                    oData[a] = iData[a];
                }
                <span class="hljs-keyword">else</span> {

                    <span class="hljs-keyword">if</span> (source &lt; <span class="hljs-number">0</span>) source += len;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source &gt;= len) source -= len;

                    <span class="hljs-keyword">if</span> (excludeTransparentPixels &amp;&amp; (!iData[a] || !iData[source + <span class="hljs-number">3</span>])) {

                        oData[r] = iData[r];
                        oData[g] = iData[g];
                        oData[b] = iData[b];
                        oData[a] = iData[a];
                    }
                    <span class="hljs-keyword">else</span> {

                        oData[r] = (includeRed) ? iData[source] : iData[r];
                        source++;
                        oData[g] = (includeGreen) ? iData[source] : iData[g];
                        source++;
                        oData[b] = (includeBlue) ? iData[source] : iData[b];
                        source++;
                        oData[a] = (includeAlpha) ? iData[source] : iData[a];
                    }
                }
            }
            <span class="hljs-keyword">else</span> {

                oData[r] = iData[r];
                oData[g] = iData[g];
                oData[b] = iData[b];
                oData[a] = iData[a];
            }
        }
        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-76">&#x00a7;</a>
              </div>
              <p><strong>reducePalette</strong> - Reduce the number of colors in its palette. The <code>palette</code> attribute can be: a Number (for the commonest colors);  an Array of CSS color Strings to use as the palette; or  the String name of a pre-defined palette - default: ‘black-white’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">REDUCE_PALETTE</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-77">&#x00a7;</a>
              </div>
              <p>Check to see if external objects have been set up by a previous run</p>
<ul>
<li>If they are missing, create them</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">predefinedPalette</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">predefinedPalette</span> = {};

        <span class="hljs-keyword">const</span> grayPalettes = <span class="hljs-variable constant_">GRAY_PALETTES</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-78">&#x00a7;</a>
              </div>
              <p>Check to see if colorSpaceIndices have been created; if not, create them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">colorSpaceIndices</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-79">&#x00a7;</a>
              </div>
              <p>Localize some handles to required functions/objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> {rgbIndices, labIndices, <span class="hljs-attr">indicesMemoRecord</span>:memoRecord, predefinedPalette, getGrayscaleValue, tfx, tfx2, labIndicesMultiplier } = <span class="hljs-variable language_">this</span>;

        <span class="hljs-keyword">let</span> lab;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-80">&#x00a7;</a>
              </div>
              <p>Internal function - create and memoize a palette</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">createPalette</span> = (<span class="hljs-params">name, colors</span>) =&gt; {

            <span class="hljs-keyword">if</span> (!name) name = colors.<span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">ARG_SPLITTER</span>);

            <span class="hljs-keyword">if</span> (name &amp;&amp; predefinedPalette[name]) <span class="hljs-keyword">return</span> predefinedPalette[name];

            <span class="hljs-keyword">const</span> p = [];

            colors.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {

                colorEngine.<span class="hljs-title function_">convert</span>(color);

                <span class="hljs-keyword">const</span> [pr, pg, pb] = colorEngine.<span class="hljs-property">rgb</span>;
                <span class="hljs-keyword">const</span> pix = (pr * tfx2) + (pg * tfx) + pb
                p.<span class="hljs-title function_">push</span>(pix);

                <span class="hljs-keyword">if</span> (!memoRecord[pix]) {

                    memoRecord[pix] = <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">const</span> [l0, l1, l2] = colorEngine.<span class="hljs-title function_">convertRGBtoOKLAB</span>(pr, pg, pb);

                    <span class="hljs-keyword">let</span> ic = pix * <span class="hljs-number">3</span>;

                    rgbIndices[ic] = pr;
                    labIndices[ic] = l0 * labIndicesMultiplier;
                    ic++;
                    rgbIndices[ic] = pg;
                    labIndices[ic] = l1 * labIndicesMultiplier;
                    ic++;
                    rgbIndices[ic] = pb;
                    labIndices[ic] = l2 * labIndicesMultiplier;
                }
            });

            predefinedPalette[name] = p.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);

            <span class="hljs-keyword">return</span> p;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-81">&#x00a7;</a>
              </div>
              <p>Setup predefined palettes if not done so by a previous run</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!predefinedPalette[<span class="hljs-variable constant_">BLACK_WHITE</span>]) {

            <span class="hljs-title function_">createPalette</span>(<span class="hljs-variable constant_">BLACK_WHITE</span>, [<span class="hljs-string">&#x27;#000&#x27;</span>, <span class="hljs-string">&#x27;#fff&#x27;</span>]);
            <span class="hljs-title function_">createPalette</span>(<span class="hljs-variable constant_">MONOCHROME_4</span>, [<span class="hljs-string">&#x27;#222&#x27;</span>, <span class="hljs-string">&#x27;#777&#x27;</span>, <span class="hljs-string">&#x27;#bbb&#x27;</span>, <span class="hljs-string">&#x27;#fff&#x27;</span>]);
            <span class="hljs-title function_">createPalette</span>(<span class="hljs-variable constant_">MONOCHROME_8</span>, [<span class="hljs-string">&#x27;#000&#x27;</span>, <span class="hljs-string">&#x27;#333&#x27;</span>, <span class="hljs-string">&#x27;#555&#x27;</span>, <span class="hljs-string">&#x27;#777&#x27;</span>, <span class="hljs-string">&#x27;#999&#x27;</span>, <span class="hljs-string">&#x27;#bbb&#x27;</span>, <span class="hljs-string">&#x27;#ddd&#x27;</span>, <span class="hljs-string">&#x27;#fff&#x27;</span>]);
            <span class="hljs-title function_">createPalette</span>(<span class="hljs-variable constant_">MONOCHROME_16</span>, [<span class="hljs-string">&#x27;#000&#x27;</span>, <span class="hljs-string">&#x27;#111&#x27;</span>, <span class="hljs-string">&#x27;#222&#x27;</span>, <span class="hljs-string">&#x27;#333&#x27;</span>, <span class="hljs-string">&#x27;#444&#x27;</span>, <span class="hljs-string">&#x27;#555&#x27;</span>, <span class="hljs-string">&#x27;#666&#x27;</span>, <span class="hljs-string">&#x27;#777&#x27;</span>, <span class="hljs-string">&#x27;#888&#x27;</span>, <span class="hljs-string">&#x27;#999&#x27;</span>, <span class="hljs-string">&#x27;#aaa&#x27;</span>, <span class="hljs-string">&#x27;#bbb&#x27;</span>, <span class="hljs-string">&#x27;#ccc&#x27;</span>, <span class="hljs-string">&#x27;#ddd&#x27;</span>, <span class="hljs-string">&#x27;#eee&#x27;</span>, <span class="hljs-string">&#x27;#fff&#x27;</span>]);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-82">&#x00a7;</a>
              </div>
              <p>Perform test to discover pixel’s closest palette gray, after dithering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> getGrayPixel = <span class="hljs-keyword">function</span> (<span class="hljs-params">pixel, pal</span>) {

            <span class="hljs-keyword">const</span> pl = pal.<span class="hljs-property">length</span>;

            <span class="hljs-keyword">if</span> (!pl) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (pl === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> pal[<span class="hljs-number">0</span>];

            <span class="hljs-keyword">const</span> pixelRef = rgbIndices[pixel * <span class="hljs-number">3</span>];
            <span class="hljs-keyword">let</span> palRef, pItem, diff;

            <span class="hljs-keyword">const</span> distance = [];

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; pl; j++) {

                pItem = pal[j];
                palRef = rgbIndices[pItem * <span class="hljs-number">3</span>];

                diff = pixelRef - palRef;

                distance.<span class="hljs-title function_">push</span>([pItem, <span class="hljs-title function_">_sqrt</span>(diff * diff * <span class="hljs-number">3</span>)]);
            }

            distance.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a[<span class="hljs-number">1</span>] - b[<span class="hljs-number">1</span>]);

            <span class="hljs-keyword">const</span> [candidate0, distance0] = distance[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">const</span> [candidate1, distance1] = distance[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">const</span> totalscore = distance0 + distance1;
            <span class="hljs-keyword">const</span> propensity0 = totalscore - distance0;

            <span class="hljs-keyword">const</span> test = rnd[rndCursor] * totalscore;

            <span class="hljs-keyword">if</span> (test &lt; propensity0) <span class="hljs-keyword">return</span> candidate0;
            <span class="hljs-keyword">return</span> candidate1;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-83">&#x00a7;</a>
              </div>
              <p>Winnow all colors to recover the commonest, taking into account the minimum color distance between them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> createCommonestColorsPalette = <span class="hljs-keyword">function</span> (<span class="hljs-params">data, distance, limit</span>) {

            <span class="hljs-keyword">const</span> candidates = [],
                final = [];

            <span class="hljs-keyword">let</span> f, fz, fIndex, fr, fg, fb,
                k, kz, kIndex, kr, kg, kb,
                dr, dg, db, dFlag;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title function_">_entries</span>(data)) {

                <span class="hljs-keyword">if</span> (value) candidates.<span class="hljs-title function_">push</span>([key, value]);
            }

            candidates.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b[<span class="hljs-number">1</span>] - a[<span class="hljs-number">1</span>]);

            <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>, kz = candidates.<span class="hljs-property">length</span>; k &lt; kz; k++) {

                <span class="hljs-keyword">const</span> candidate = candidates[k];

                <span class="hljs-keyword">if</span> (!k) final.<span class="hljs-title function_">push</span>(candidate[<span class="hljs-number">0</span>]);
                <span class="hljs-keyword">else</span> {

                    kIndex = candidate[<span class="hljs-number">0</span>] * <span class="hljs-number">3</span>;

                    <span class="hljs-keyword">if</span> (useLabForPaletteDistance) {

                        kr = labIndices[kIndex];
                        kIndex++;
                        kg = labIndices[kIndex];
                        kIndex++;
                        kb = labIndices[kIndex];

                        dFlag = <span class="hljs-literal">true</span>;

                        <span class="hljs-keyword">for</span> (f = <span class="hljs-number">0</span>, fz = final.<span class="hljs-property">length</span>; f &lt; fz; f++) {

                            fIndex = final[f] * <span class="hljs-number">3</span>;

                            fr = labIndices[fIndex];
                            fIndex++;
                            fg = labIndices[fIndex];
                            fIndex++;
                            fb = labIndices[fIndex];

                            dr = kr - fr;
                            dg = kg - fg;
                            db = kb - fb;

                            <span class="hljs-keyword">if</span> ((dr * dr) + (dg * dg) + (db * db) &lt; distance) {

                                dFlag = <span class="hljs-literal">false</span>;
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                        <span class="hljs-keyword">if</span> (dFlag) final.<span class="hljs-title function_">push</span>(candidate[<span class="hljs-number">0</span>]);

                        <span class="hljs-keyword">if</span> (final.<span class="hljs-property">length</span> &gt;= limit) <span class="hljs-keyword">break</span>;
                    }
                    <span class="hljs-keyword">else</span> {

                        kr = rgbIndices[kIndex];
                        kIndex++;
                        kg = rgbIndices[kIndex];
                        kIndex++;
                        kb = rgbIndices[kIndex];

                        dFlag = <span class="hljs-literal">true</span>;

                        <span class="hljs-keyword">for</span> (f = <span class="hljs-number">0</span>, fz = final.<span class="hljs-property">length</span>; f &lt; fz; f++) {

                            fIndex = final[f] * <span class="hljs-number">3</span>;

                            fr = rgbIndices[fIndex];
                            fIndex++;
                            fg = rgbIndices[fIndex];
                            fIndex++;
                            fb = rgbIndices[fIndex];

                            dr = kr - fr;
                            dg = kg - fg;
                            db = kb - fb;

                            <span class="hljs-keyword">if</span> ((dr * dr) + (dg * dg) + (db * db) &lt; distance) {

                                dFlag = <span class="hljs-literal">false</span>;
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                        <span class="hljs-keyword">if</span> (dFlag) final.<span class="hljs-title function_">push</span>(candidate[<span class="hljs-number">0</span>]);

                        <span class="hljs-keyword">if</span> (final.<span class="hljs-property">length</span> &gt;= limit) <span class="hljs-keyword">break</span>;
                    }
                }
            }
            <span class="hljs-keyword">return</span> final;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-84">&#x00a7;</a>
              </div>
              <p>Perform test to discover pixel’s closest palette color, after dithering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> getColorPixel = <span class="hljs-keyword">function</span> (<span class="hljs-params">pixel, pal</span>) {

            <span class="hljs-keyword">const</span> pl = pal.<span class="hljs-property">length</span>;

            <span class="hljs-keyword">let</span> palIndex, counter,
                pixL, pixA, pixB,
                diff, dL, dA, dB,
                j;

            <span class="hljs-keyword">if</span> (!pl) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (pl === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> pal[<span class="hljs-number">0</span>];

            counter = pixel * <span class="hljs-number">3</span>;

            <span class="hljs-keyword">const</span> palL = labIndices[counter];
            counter++;
            <span class="hljs-keyword">const</span> palA = labIndices[counter];
            counter++;
            <span class="hljs-keyword">const</span> palB = labIndices[counter];

            <span class="hljs-keyword">const</span> distArray = [];

            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; pl; j++) {

                palIndex = pal[j];

                counter = palIndex * <span class="hljs-number">3</span>;

                pixL = labIndices[counter];
                counter++;
                pixA = labIndices[counter];
                counter++;
                pixB = labIndices[counter];

                dL = palL - pixL;
                dA = palA - pixA;
                dB = palB - pixB;

                diff = (dL * dL) + (dA * dA) + (dB * dB);

                distArray.<span class="hljs-title function_">push</span>([palIndex, diff]);
            }

            distArray.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a[<span class="hljs-number">1</span>] - b[<span class="hljs-number">1</span>]);

            <span class="hljs-keyword">const</span> [candidate0, distance0] = distArray[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">const</span> [candidate1, distance1] = distArray[<span class="hljs-number">1</span>];

            <span class="hljs-keyword">let</span> test = rnd[rndCursor];

            <span class="hljs-keyword">const</span> totalScore = distance0 + distance1,
                propensity = totalScore - distance0;

            test *= totalScore;

            <span class="hljs-keyword">if</span> (test &lt; propensity) <span class="hljs-keyword">return</span> candidate0;
            <span class="hljs-keyword">return</span> candidate1;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-85">&#x00a7;</a>
              </div>
              <p>Filter generics (as used by all filters)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            iWidth = input.<span class="hljs-property">width</span>,
            iHeight = input.<span class="hljs-property">height</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>,
            quarterLen = len / <span class="hljs-number">4</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            palette = <span class="hljs-variable constant_">BLACK_WHITE</span>,
            seed = <span class="hljs-variable constant_">DEFAULT_SEED</span>,
            useBluenoise = <span class="hljs-literal">false</span>,
            minimumColorDistance = <span class="hljs-number">1000</span>,
            useLabForPaletteDistance = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> noiseType = (useBluenoise) ? <span class="hljs-variable constant_">BLUENOISE</span> : requirements.<span class="hljs-property">noiseType</span> || <span class="hljs-variable constant_">RANDOM</span>;

        <span class="hljs-keyword">let</span> i, index,
            r, g, b, a, red, green, blue, alpha, gray,
            rndCursor, indicesCursor, dataCursor,
            selectedPalette;</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-86">&#x00a7;</a>
              </div>
              <p>Noise - used for dithering the output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> rnd = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRandomNumbers</span>({
            seed,
            <span class="hljs-attr">length</span>: quarterLen,
            <span class="hljs-attr">imgWidth</span>: iWidth,
            <span class="hljs-attr">type</span>: noiseType,
        });
        rndCursor = -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-87">&#x00a7;</a>
              </div>
              <p>Grayscale vs non-grayscale palettes follow different computing paths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> isGray = grayPalettes.<span class="hljs-title function_">includes</span>(palette);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-88">&#x00a7;</a>
              </div>
              <p>Transfer input data over to a temporary object</p>
<ul>
<li>if the palette is grayscale, we grayscale the input at this point</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> tempInput = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(iWidth, iHeight),
            tData = tempInput.<span class="hljs-property">data</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">if</span> (isGray) {

                gray = <span class="hljs-title function_">getGrayscaleValue</span>(iData[r], iData[g], iData[b]);

                tData[r] = gray;
                tData[g] = gray;
                tData[b] = gray;
                tData[a] = iData[a];
            }
            <span class="hljs-keyword">else</span> {

                tData[r] = iData[r];
                tData[g] = iData[g];
                tData[b] = iData[b];
                tData[a] = iData[a];
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-89">&#x00a7;</a>
              </div>
              <p>Parse the input to determine what colors it contains, etc</p>
<ul>
<li>If some LAB color data has not yet been memoized, we do it at this point</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> pixelColorIndices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(len / <span class="hljs-number">4</span>);
        <span class="hljs-keyword">const</span> detectedColors = {};

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; quarterLen; i++) {

            r = i * <span class="hljs-number">4</span>;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            red = tData[r];
            green = tData[g];
            blue = tData[b];
            alpha = tData[a];

            <span class="hljs-keyword">if</span> (alpha) {

                index = (red * tfx2) + (green * tfx) + blue;

                pixelColorIndices[i] = index;

                <span class="hljs-keyword">if</span> (detectedColors[index] == <span class="hljs-literal">null</span>) {

                   detectedColors[index] = <span class="hljs-number">0</span>;

                    <span class="hljs-keyword">if</span> (!memoRecord[index]) {

                        memoRecord[index] = <span class="hljs-number">1</span>;
                        lab = colorEngine.<span class="hljs-title function_">convertRGBtoOKLAB</span>(red, green, blue);

                        indicesCursor = index * <span class="hljs-number">3</span>;

                        rgbIndices[indicesCursor] = red;
                        labIndices[indicesCursor] = lab[<span class="hljs-number">0</span>] * labIndicesMultiplier;
                        indicesCursor++;
                        rgbIndices[indicesCursor] = green;
                        labIndices[indicesCursor] = lab[<span class="hljs-number">1</span>] * labIndicesMultiplier;
                        indicesCursor++;
                        rgbIndices[indicesCursor] = blue;
                        labIndices[indicesCursor] = lab[<span class="hljs-number">2</span>] * labIndicesMultiplier;
                    }
                }
                detectedColors[index] = detectedColors[index] + <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">else</span> pixelColorIndices[i] = -<span class="hljs-number">1</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-90">&#x00a7;</a>
              </div>
              <p>Get the appropriate array of palette colors</p>
<ul>
<li>For commonest colors, we have to calculate a new best-fit palette for this image</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (palette.<span class="hljs-property">substring</span>) selectedPalette = predefinedPalette[palette] || [];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">_isArray</span>(palette)) selectedPalette = <span class="hljs-title function_">createPalette</span>(<span class="hljs-variable constant_">ZERO_STR</span>, palette);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (palette.<span class="hljs-property">toFixed</span>) selectedPalette = <span class="hljs-title function_">createCommonestColorsPalette</span>(detectedColors, minimumColorDistance, palette);
        <span class="hljs-keyword">else</span> selectedPalette = [];

        <span class="hljs-keyword">if</span> (!selectedPalette.<span class="hljs-property">length</span>) selectedPalette = predefinedPalette[<span class="hljs-variable constant_">BLACK_WHITE</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-91">&#x00a7;</a>
              </div>
              <p>Calculate output</p>
<ul>
<li>Grayscale palettes and non-grayscale palettes follow different paths</li>
<li>Both variants will skip processing transparent pixels</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; quarterLen; i++) {

            rndCursor++;

            index = pixelColorIndices[i];

            dataCursor = i * <span class="hljs-number">4</span>;

            <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) {

                oData[dataCursor] = tData[dataCursor];
                dataCursor++;
                oData[dataCursor] = tData[dataCursor];
                dataCursor++;
                oData[dataCursor] = tData[dataCursor];
                dataCursor++;
                oData[dataCursor] = tData[dataCursor];
            }
            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">if</span> (isGray) indicesCursor = <span class="hljs-title function_">getGrayPixel</span>(index, selectedPalette) * <span class="hljs-number">3</span>;
                <span class="hljs-keyword">else</span> indicesCursor = <span class="hljs-title function_">getColorPixel</span>(index, selectedPalette) * <span class="hljs-number">3</span>;

                oData[dataCursor] = rgbIndices[indicesCursor];
                dataCursor++;
                indicesCursor++;
                oData[dataCursor] = rgbIndices[indicesCursor];
                dataCursor++;
                indicesCursor++;
                oData[dataCursor] = rgbIndices[indicesCursor];
                dataCursor++;
                oData[dataCursor] = tData[dataCursor];
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-92">&#x00a7;</a>
              </div>
              <p>Boilerplate filter post-processing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-93">&#x00a7;</a>
              </div>
              <p><strong>set-channel-to-level</strong> - Sets the value of each pixel’s included channel to the value supplied in the “level” argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">SET_CHANNEL_TO_LEVEL</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            includeRed = <span class="hljs-literal">false</span>,
            includeGreen = <span class="hljs-literal">false</span>,
            includeBlue = <span class="hljs-literal">false</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            level = <span class="hljs-number">0</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            oData[r] = (includeRed) ? level : iData[r];
            oData[g] = (includeGreen) ? level : iData[g];
            oData[b] = (includeBlue) ? level : iData[b];
            oData[a] = (includeAlpha) ? level : iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-94">&#x00a7;</a>
              </div>
              <p><strong>step-channels</strong> - Takes three divisor values - “red”, “green”, “blue”. For each pixel, its color channel values are divided by the corresponding color divisor, floored to the integer value and then multiplied by the divisor. For example a divisor value of ‘50’ applied to a channel value of ‘120’ will give a result of ‘100’. The output is a form of posterization.</p>
<p>A new <code>clamp</code> attribute was added in v8.7.0, which can take the following String values:</p>
<ul>
<li><code>down</code> (default) - uses <code>Math.floor()</code> for the calculation</li>
<li><code>up</code> (default) - uses <code>Math.ceil()</code> for the calculation</li>
<li><code>round</code> (default) - uses <code>Math.round()</code> for the calculation</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">STEP_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            red = <span class="hljs-number">1</span>,
            green = <span class="hljs-number">1</span>,
            blue = <span class="hljs-number">1</span>,
            clamp = <span class="hljs-variable constant_">DOWN</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, i;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            <span class="hljs-keyword">switch</span> (clamp) {

                <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">UP</span> :
                    oData[r] = <span class="hljs-title function_">_ceil</span>(iData[r] / red) * red;
                    oData[g] = <span class="hljs-title function_">_ceil</span>(iData[g] / green) * green;
                    oData[b] = <span class="hljs-title function_">_ceil</span>(iData[b] / blue) * blue;
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">ROUND</span> :
                    oData[r] = <span class="hljs-title function_">_round</span>(iData[r] / red) * red;
                    oData[g] = <span class="hljs-title function_">_round</span>(iData[g] / green) * green;
                    oData[b] = <span class="hljs-title function_">_round</span>(iData[b] / blue) * blue;
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">default</span> :
                    oData[r] = <span class="hljs-title function_">_floor</span>(iData[r] / red) * red;
                    oData[g] = <span class="hljs-title function_">_floor</span>(iData[g] / green) * green;
                    oData[b] = <span class="hljs-title function_">_floor</span>(iData[b] / blue) * blue;
                    <span class="hljs-keyword">break</span>;
            }
            oData[a] = iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-95">&#x00a7;</a>
              </div>
              <p><strong>swirl</strong> - For each pixel, move the pixel radially according to its distance from a given coordinate and associated angle for that coordinate.</p>
<ul>
<li>This filter can handle multiple swirls in a single pass</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">SWIRL</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> getValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">val, dim</span>) {

            <span class="hljs-keyword">return</span> (val.<span class="hljs-property">substring</span>) ? <span class="hljs-title function_">_floor</span>((<span class="hljs-built_in">parseFloat</span>(val) / <span class="hljs-number">100</span>) * dim) : val;
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>,
            iWidth = input.<span class="hljs-property">width</span>,
            iHeight = input.<span class="hljs-property">height</span>;

        <span class="hljs-keyword">const</span> tempInput = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(iWidth, iHeight),
            tData = tempInput.<span class="hljs-property">data</span>,
            tWidth = tempInput.<span class="hljs-property">width</span>,
            tHeight = tempInput.<span class="hljs-property">height</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            swirls = [],
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, s, sz, pos, x, y, xz, yz, i, j,
            distance, dr, dg, db, da, dx, dy, dLen;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            tData[r] = iData[r];
            tData[g] = iData[g];
            tData[b] = iData[b];
            tData[a] = iData[a];

            oData[r] = iData[r];
            oData[g] = iData[g];
            oData[b] = iData[b];
            oData[a] = iData[a];
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">_isArray</span>(swirls) &amp;&amp; swirls.<span class="hljs-property">length</span>) {

            <span class="hljs-keyword">const</span> grid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageGrid</span>(input);

            <span class="hljs-keyword">for</span> (s = <span class="hljs-number">0</span>, sz = swirls.<span class="hljs-property">length</span>; s &lt; sz; s++) {

                <span class="hljs-keyword">const</span> [startX, startY, innerRadius, outerRadius, angle, easing] = swirls[s];

                <span class="hljs-keyword">const</span> sx = <span class="hljs-title function_">getValue</span>(startX, iWidth),
                    sy = <span class="hljs-title function_">getValue</span>(startY, iHeight);

                <span class="hljs-keyword">let</span> outer = <span class="hljs-title function_">getValue</span>(outerRadius, iWidth),
                    inner = <span class="hljs-title function_">getValue</span>(innerRadius, iWidth);

                <span class="hljs-keyword">if</span> (inner &gt; outer) {

                    <span class="hljs-keyword">const</span> temp = inner;
                    inner = outer;
                    outer = temp;
                }

                <span class="hljs-keyword">const</span> complexLen = outer - inner;

                x = sx - outer;
                <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) x = <span class="hljs-number">0</span>;
                xz = sx + outer
                <span class="hljs-keyword">if</span> (xz &gt; tWidth) xz = tWidth;
                y = sy - outer;
                <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-number">0</span>) y = <span class="hljs-number">0</span>;
                yz = sy + outer
                <span class="hljs-keyword">if</span> (yz &gt;= tHeight) yz = tHeight;

                <span class="hljs-keyword">if</span> (x &lt; xz &amp;&amp; y &lt; yz &amp;&amp; x &lt; tWidth &amp;&amp; xz &gt; <span class="hljs-number">0</span> &amp;&amp; y &lt; tHeight &amp;&amp; yz &gt; <span class="hljs-number">0</span>) {

                    <span class="hljs-keyword">let</span> e = easing;
                    <span class="hljs-keyword">let</span> ename = easing;

                    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_fn</span>(e)) ename = <span class="hljs-string">`ude-<span class="hljs-subst">${e(<span class="hljs-number">0</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.1</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.2</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.3</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.4</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.5</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.6</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.7</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.8</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">0.9</span>)}</span>-<span class="hljs-subst">${e(<span class="hljs-number">1</span>)}</span>`</span>;
                    <span class="hljs-keyword">else</span> {
                        e = (<span class="hljs-literal">null</span> != easeEngines[e]) ? easeEngines[e] : easeEngines[<span class="hljs-string">&#x27;linear&#x27;</span>];
                    }

                    <span class="hljs-keyword">const</span> swirlName = <span class="hljs-string">`swirl-<span class="hljs-subst">${startX}</span>-<span class="hljs-subst">${startY}</span>-<span class="hljs-subst">${innerRadius}</span>-<span class="hljs-subst">${outerRadius}</span>-<span class="hljs-subst">${angle}</span>-<span class="hljs-subst">${ename}</span>-<span class="hljs-subst">${iWidth}</span>-<span class="hljs-subst">${iHeight}</span>`</span>;

                    <span class="hljs-keyword">const</span> swirlCoords = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOrAddWorkstore</span>(swirlName);

                    <span class="hljs-keyword">if</span> (!swirlCoords.<span class="hljs-property">length</span>) {

                        <span class="hljs-keyword">const</span> start = <span class="hljs-title function_">requestCoordinate</span>();
                        <span class="hljs-keyword">const</span> coord = <span class="hljs-title function_">requestCoordinate</span>();

                        start.<span class="hljs-title function_">setFromArray</span>([sx, sy]);

                        <span class="hljs-keyword">for</span> (i = y; i &lt; yz; i++) {

                            <span class="hljs-keyword">for</span> (j = x; j &lt; xz; j++) {

                                pos = [j, i];

                                r = grid[i][j] * <span class="hljs-number">4</span>;

                                distance = coord.<span class="hljs-title function_">set</span>(pos).<span class="hljs-title function_">subtract</span>(start).<span class="hljs-title function_">getMagnitude</span>();

                                <span class="hljs-keyword">if</span> (distance &gt; outer) dr = r;
                                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (distance &lt; inner) {

                                    coord.<span class="hljs-title function_">rotate</span>(angle).<span class="hljs-title function_">add</span>(start);

                                    dx = <span class="hljs-title function_">_floor</span>(coord[<span class="hljs-number">0</span>]);
                                    dy = <span class="hljs-title function_">_floor</span>(coord[<span class="hljs-number">1</span>]);

                                    <span class="hljs-keyword">if</span> (dx &lt; <span class="hljs-number">0</span>) dx += iWidth;
                                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dx &gt;= iWidth) dx -= iWidth;

                                    <span class="hljs-keyword">if</span> (dy &lt; <span class="hljs-number">0</span>) dy += iHeight;
                                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dy &gt;= iHeight) dy -= iHeight;

                                    dr = grid[dy][dx] * <span class="hljs-number">4</span>;
                                }
                                <span class="hljs-keyword">else</span> {

                                    dLen = <span class="hljs-number">1</span> - ((distance - inner) / complexLen);

                                    dLen = <span class="hljs-title function_">e</span>(dLen);

                                    coord.<span class="hljs-title function_">rotate</span>(angle * dLen).<span class="hljs-title function_">add</span>(start);

                                    dx = <span class="hljs-title function_">_floor</span>(coord[<span class="hljs-number">0</span>]);
                                    dy = <span class="hljs-title function_">_floor</span>(coord[<span class="hljs-number">1</span>]);

                                    <span class="hljs-keyword">if</span> (dx &lt; <span class="hljs-number">0</span>) dx += iWidth;
                                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dx &gt;= iWidth) dx -= iWidth;

                                    <span class="hljs-keyword">if</span> (dy &lt; <span class="hljs-number">0</span>) dy += iHeight;
                                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dy &gt;= iHeight) dy -= iHeight;

                                    dr = grid[dy][dx] * <span class="hljs-number">4</span>;
                                }
                                swirlCoords.<span class="hljs-title function_">push</span>(dr);
                            }
                        }
                        <span class="hljs-title function_">releaseCoordinate</span>(coord);
                        <span class="hljs-title function_">releaseCoordinate</span>(start);
                    }

                    <span class="hljs-keyword">let</span> swirlCursor = -<span class="hljs-number">1</span>;
                    <span class="hljs-keyword">for</span> (i = y; i &lt; yz; i++) {

                        <span class="hljs-keyword">for</span> (j = x; j &lt; xz; j++) {

                            r = grid[i][j] * <span class="hljs-number">4</span>;
                            g = r + <span class="hljs-number">1</span>;
                            b = g + <span class="hljs-number">1</span>;
                            a = b + <span class="hljs-number">1</span>;

                            dr = swirlCoords[++swirlCursor];
                            dg = dr + <span class="hljs-number">1</span>;
                            db = dg + <span class="hljs-number">1</span>;
                            da = db + <span class="hljs-number">1</span>;

                            oData[r] = tData[dr];
                            oData[g] = tData[dg];
                            oData[b] = tData[db];
                            oData[a] = tData[da];
                        }
                    }

                    <span class="hljs-keyword">for</span> (i = y; i &lt; yz; i++) {

                        <span class="hljs-keyword">for</span> (j = x; j &lt; xz; j++) {

                            r = grid[i][j] * <span class="hljs-number">4</span>;
                            g = r + <span class="hljs-number">1</span>;
                            b = g + <span class="hljs-number">1</span>;
                            a = b + <span class="hljs-number">1</span>;

                            tData[r] = oData[r];
                            tData[g] = oData[g];
                            tData[b] = oData[b];
                            tData[a] = oData[a];
                        }
                    }
                }
            }
        }
        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-96">&#x00a7;</a>
              </div>
              <p><strong>threshold</strong> - performs a binary check on each pixel and, according to the result, assigns the pixel to a defined high or low color</p>
<ul>
<li>By default this filter will grayscale the input then, for each pixel, check the color channel values against a <code>level</code> argument: pixels with grayscale values above the level value are assigned to the <code>high</code> color; otherwise they are updated to the <code>low</code> color. The “high” and “low” arguments are <code>[red, green, blue, alpha]</code> integer Number Arrays.</li>
<li>The convenience function will accept the pseudo-attributes <code>highRed</code>, <code>lowRed</code> etc in place of the “high” and “low” Arrays.</li>
<li>When the <code>useMixedChannel</code> flag is set to <code>false</code> then the filter will perform the threshold check on each channel in turn; the threshold levels for these per-channel checks are set in the <code>red</code>, <code>green</code>, <code>blue</code> and <code>alpha</code> arguments</li>
<li>Channels can be excluded from the filter action by setting the <code>includeRed</code> etc flags to false</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">THRESHOLD</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            low = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],
            high = [<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>],
            level = <span class="hljs-number">128</span>,
            red = <span class="hljs-number">128</span>,
            green = <span class="hljs-number">128</span>,
            blue = <span class="hljs-number">128</span>,
            alpha = <span class="hljs-number">128</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            useMixedChannel = <span class="hljs-literal">true</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> [lowR, lowG, lowB, lowA] = low;
        <span class="hljs-keyword">const</span> [highR, highG, highB, highA] = high;

        <span class="hljs-keyword">const</span> gVal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGrayscaleValue</span>;

        <span class="hljs-keyword">let</span> r, g, b, a, i, pr, pg, pb, pa, gray;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            pr = iData[r];
            pg = iData[g];
            pb = iData[b];
            pa = iData[a];

            <span class="hljs-keyword">if</span> (useMixedChannel) {

                gray = <span class="hljs-title function_">gVal</span>(pr, pg, pb);

                <span class="hljs-keyword">if</span> (gray &lt; level) {

                    oData[r] = (includeRed) ? lowR : pr;
                    oData[g] = (includeGreen) ? lowG : pg;
                    oData[b] = (includeBlue) ? lowB : pb;
                    oData[a] = (includeAlpha) ? lowA : pa;
                }
                <span class="hljs-keyword">else</span> {

                    oData[r] = (includeRed) ? highR : pr;
                    oData[g] = (includeGreen) ? highG : pg;
                    oData[b] = (includeBlue) ? highB : pb;
                    oData[a] = (includeAlpha) ? highA : pa;
                }
            }
            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">if</span> (includeRed) {
                    oData[r] = (pr &lt; red) ? lowR : highR;
                }
                <span class="hljs-keyword">else</span> oData[r] = pr;

                <span class="hljs-keyword">if</span> (includeGreen) {
                    oData[g] = (pg &lt; green) ? lowG : highG;
                }
                <span class="hljs-keyword">else</span> oData[g] = pg;

                <span class="hljs-keyword">if</span> (includeBlue) {
                    oData[b] = (pb &lt; blue) ? lowB : highB;
                }
                <span class="hljs-keyword">else</span> oData[b] = pb;

                <span class="hljs-keyword">if</span> (includeAlpha) {
                    oData[a] = (pa &lt; alpha) ? lowA : highA;
                }
                <span class="hljs-keyword">else</span> oData[a] = pa;
            }
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-97">&#x00a7;</a>
              </div>
              <p><strong>tiles</strong> - Cover the image with tiles whose color matches the average channel values for the pixels included in each tile. Has a similarity to the <code>pixelate</code> filter, but uses a set of coordinate points to generate the tiles which results in a Delauney-like output</p>
<ul>
<li><code>points=&#39;rect-grid&#39;</code> - generate a regular grid of tiles, where: <code>offsetX</code>, <code>offsetY</code> represent the origin coordinate from which the grid will be calculated; <code>tileWidth</code>, <code>tileHeight</code> supply the dimensions of the rectangular tiles; <code>angle</code> is the amount of tile rotation.</li>
<li><code>points=&#39;hex-grid&#39;</code> - generate a hexagonal grid of tiles, where: <code>offsetX</code>, <code>offsetY</code> represent the origin coordinate from which the grid will be calculated; <code>tileRadius</code> supplies the radius for each hexagonal tile; <code>angle</code> is the amount of tile rotation.</li>
<li><code>points=50</code> - generate a pseudo-random set of points based on <code>offsetX</code>, <code>offsetY</code> and <code>tileRadius</code> arguments</li>
<li><code>points=[100, 100, 100, 300, 300, 100, 300, 300]</code> - action the points as described in the array</li>
<li>More documentation can be found with the <code>buildGeneralTileSets</code> code, near the top of this file.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">TILES</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> doCalculations = <span class="hljs-keyword">function</span> (<span class="hljs-params">inChannel, outChannel, tile, offset</span>) {

            <span class="hljs-keyword">let</span> avg = tile.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, v</span>) =&gt;</span> a + inChannel[(v * <span class="hljs-number">4</span>) + offset], <span class="hljs-number">0</span>);

            avg = <span class="hljs-title function_">_floor</span>(avg / tile.<span class="hljs-property">length</span>);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = tile.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                outChannel[(tile[i] * <span class="hljs-number">4</span>) + offset] = avg;
            }
        }

        <span class="hljs-keyword">const</span> setOutValueToInValue = <span class="hljs-keyword">function</span> (<span class="hljs-params">inChannel, outChannel, tile, offset</span>) {

            <span class="hljs-keyword">let</span> cell;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = tile.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                cell = (tile[i] * <span class="hljs-number">4</span>) + offset;
                outChannel[cell] = inChannel[cell];
            }
        };

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            tileWidth = <span class="hljs-number">1</span>,
            tileHeight = <span class="hljs-number">1</span>,
            tileRadius = <span class="hljs-number">1</span>,
            offsetX = <span class="hljs-number">0</span>,
            offsetY = <span class="hljs-number">0</span>,
            angle = <span class="hljs-number">0</span>,
            points = <span class="hljs-variable constant_">RECT_GRID</span>,
            seed = <span class="hljs-variable constant_">DEFAULT_SEED</span>,
            includeRed = <span class="hljs-literal">true</span>,
            includeGreen = <span class="hljs-literal">true</span>,
            includeBlue = <span class="hljs-literal">true</span>,
            includeAlpha = <span class="hljs-literal">false</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">const</span> tiles = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildGeneralTileSets</span>(points, tileWidth, tileHeight, tileRadius, offsetX, offsetY, angle, seed);

        <span class="hljs-keyword">if</span> (!tiles.<span class="hljs-property">length</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transferDataUnchanged</span>(oData, iData, len);
        <span class="hljs-keyword">else</span> {

            tiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> {

                <span class="hljs-keyword">if</span> (includeRed) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">0</span>);
                <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">0</span>);

                <span class="hljs-keyword">if</span> (includeGreen) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">1</span>);

                <span class="hljs-keyword">if</span> (includeBlue) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">2</span>);
                <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">2</span>);

                <span class="hljs-keyword">if</span> (includeAlpha) <span class="hljs-title function_">doCalculations</span>(iData, oData, t, <span class="hljs-number">3</span>);
                <span class="hljs-keyword">else</span> <span class="hljs-title function_">setOutValueToInValue</span>(iData, oData, t, <span class="hljs-number">3</span>);
            });
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-98">&#x00a7;</a>
              </div>
              <p><strong>tint-channels</strong> - Has similarities to the SVG &lt;feColorMatrix&gt; filter element, but excludes the alpha channel from calculations. Rather than set a matrix, we set nine arguments to determine how the value of each color channel in a pixel will affect both itself and its fellow color channels. The ‘sepia’ convenience filter presets these values to create a sepia effect.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">TINT_CHANNELS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            redInRed = <span class="hljs-number">1</span>,
            redInGreen = <span class="hljs-number">0</span>,
            redInBlue = <span class="hljs-number">0</span>,
            greenInRed = <span class="hljs-number">0</span>,
            greenInGreen = <span class="hljs-number">1</span>,
            greenInBlue = <span class="hljs-number">0</span>,
            blueInRed = <span class="hljs-number">0</span>,
            blueInGreen = <span class="hljs-number">0</span>,
            blueInBlue = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">let</span> r, g, b, a, i, vr, vg, vb;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            vr = iData[r];
            vg = iData[g];
            vb = iData[b];

            oData[r] = <span class="hljs-title function_">_floor</span>((vr * redInRed) + (vg * greenInRed) + (vb * blueInRed));
            oData[g] = <span class="hljs-title function_">_floor</span>((vr * redInGreen) + (vg * greenInGreen) + (vb * blueInGreen));
            oData[b] = <span class="hljs-title function_">_floor</span>((vr * redInBlue) + (vg * greenInBlue) + (vb * blueInBlue));
            oData[a] = iData[a];
        }

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-99">&#x00a7;</a>
              </div>
              <p><strong>user-defined-legacy</strong> - Previous to version 8.4, filters could be defined with an argument which passed a function string to the filter engine, which the engine would then run against the source input image as-and-when required. This functionality has been removed from the new filter functionality. All such filters will now return the input image unchanged.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    [<span class="hljs-variable constant_">USER_DEFINED_LEGACY</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputChannels</span>(requirements);

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            lineOut,
        } = requirements;

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transferDataUnchanged</span>(input, output);

        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-100">&#x00a7;</a>
              </div>
              <p><strong>vary-channels-by-weights</strong> - manipulate colors using a set of channel curve arrays.</p>
<ul>
<li>The weights Array is (256 * 4) elements long. For each color level, we supply four weights: <code>redweight, greenweight, blueweight, allweight</code></li>
<li>The default weighting for all elements is <code>0</code>. Weights are added to a pixel channel’s value, thus weighting values need to be integer Numbers, either positive or negative</li>
<li>The <code>useMixedChannel</code> flag uses a different calculation, where a pixel’s channel values are combined to give their grayscale value, then that weighting (stored as the <code>allweight</code> weighting value) is added to each channel value, pro-rata in line with the grayscale channel weightings. (Note: this produces a different result compared to tools supplied in various other graphic manipulation software)</li>
<li>Using this method, we can perform a <strong>curve</strong> (image tonality) filter</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [<span class="hljs-variable constant_">VARY_CHANNELS_BY_WEIGHTS</span>]: <span class="hljs-keyword">function</span> (<span class="hljs-params">requirements</span>) {

        <span class="hljs-keyword">const</span> [input, output] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInputAndOutputLines</span>(requirements);

        <span class="hljs-keyword">const</span> iData = input.<span class="hljs-property">data</span>,
            oData = output.<span class="hljs-property">data</span>,
            len = iData.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">const</span> {
            opacity = <span class="hljs-number">1</span>,
            weights = [],
            useMixedChannel = <span class="hljs-literal">true</span>,
            lineOut,
        } = requirements;

        <span class="hljs-keyword">if</span> (weights.<span class="hljs-property">length</span> != <span class="hljs-number">1024</span>) {

            weights.<span class="hljs-property">length</span> = <span class="hljs-number">1024</span>;
            weights.<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
        }

        <span class="hljs-keyword">const</span> gVal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGrayscaleValue</span>;

        <span class="hljs-keyword">let</span> i, r, g, b, a, red, green, blue, alpha, gray, all, allR, allG, allB;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {

            r = i;
            g = r + <span class="hljs-number">1</span>;
            b = g + <span class="hljs-number">1</span>;
            a = b + <span class="hljs-number">1</span>;

            red = iData[r];
            green = iData[g];
            blue = iData[b];
            alpha = iData[a];

            <span class="hljs-keyword">if</span> (useMixedChannel) {

                gray = <span class="hljs-title function_">gVal</span>(red, green, blue);

                all = weights[(gray * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>];

                allR = all * <span class="hljs-number">0.2126</span>;
                allG = all * <span class="hljs-number">0.7152</span>;
                allB = all * <span class="hljs-number">0.0722</span>;

                oData[r] = red + allR;
                oData[g] = green + allG;
                oData[b] = blue + allB;
                oData[a] = iData[a];
            }
            <span class="hljs-keyword">else</span> {

                oData[r] = red + weights[red * <span class="hljs-number">4</span>];
                oData[g] = green + weights[(green * <span class="hljs-number">4</span>) + <span class="hljs-number">1</span>];
                oData[b] = blue + weights[(blue * <span class="hljs-number">4</span>) + <span class="hljs-number">2</span>];
                oData[a] = alpha + weights[(alpha * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>];
            }
        }
        <span class="hljs-keyword">if</span> (lineOut) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(output, input, <span class="hljs-number">1</span> - opacity);
        <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processResults</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">work</span>, output, opacity);
    },

});</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-101">&#x00a7;</a>
              </div>
              <p>We need an animation object to go through all the filters at the very end of the Display cycle RAF (request animation frame) and reset their <code>dirtyFilterIdentifier</code> flag to false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title function_">makeAnimation</span>({

    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;filters-cleanup-action&#x27;</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">999</span>,
    <span class="hljs-attr">fn</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

        filternames.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

            <span class="hljs-keyword">const</span> f = filter[name];

            <span class="hljs-keyword">if</span> (f) f.<span class="hljs-property">dirtyFilterIdentifier</span> = <span class="hljs-literal">false</span>;
        });

        stylesnames.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

            <span class="hljs-keyword">const</span> s = styles[name];

            <span class="hljs-keyword">if</span> (s) s.<span class="hljs-property">dirtyFilterIdentifier</span> = <span class="hljs-literal">false</span>;
        });
    },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-102">&#x00a7;</a>
              </div>
              <h4 id="factory">Factory</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>constructors.<span class="hljs-property">FilterEngine</span> = <span class="hljs-title class_">FilterEngine</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-103">&#x00a7;</a>
              </div>
              <p>Create a singleton filter engine, for export and use within this code base</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> filterEngine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterEngine</span>();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
