<!DOCTYPE html>

<html>
<head>
  <title>Particle factory</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/snippets.html">
                  ./source/core/snippets.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="cog.html">
                  ./source/factory/cog.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="conicGradient.html">
                  ./source/factory/conicGradient.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="filterEngine.html">
                  ./source/factory/filterEngine.js
                </a>
              
                
                <a class="source" href="fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="mesh.html">
                  ./source/factory/mesh.js
                </a>
              
                
                <a class="source" href="net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="noise.html">
                  ./source/factory/noise.js
                </a>
              
                
                <a class="source" href="oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="particleForce.html">
                  ./source/factory/particleForce.js
                </a>
              
                
                <a class="source" href="particleHistory.html">
                  ./source/factory/particleHistory.js
                </a>
              
                
                <a class="source" href="particleSpring.html">
                  ./source/factory/particleSpring.js
                </a>
              
                
                <a class="source" href="particleWorld.html">
                  ./source/factory/particleWorld.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="../mixin/shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h1 id="particle-factory">Particle factory</h1>
<p>The Scrawl-canvas particle physics engine is a simple system designed to allow developers a way to add particle-based effects to their canvas animation scenes. The physics engine is built on top of the following components:</p>
<ul>
<li><a href="./particle.html">Particle objects</a>, which represent a 3-dimensional coordinate - based on a Scrawl-canvas <a href="./vector.html">Vector object</a> - and include a history of recent positions which we can use to determine how to display that particle on screen.</li>
<li><a href="./particleHistory.html">History arrays</a> which can be pooled (reused) to cut down on Array creation and distruction during the animation.</li>
<li><a href="./particleForce.html">Force objects</a> which define the general and occasional forces to be applied to each particle in the system as the animation progresses - a <strong>gravity</strong> force object is pre-defined by Scrawl-canvas.</li>
<li><a href="./particleSpring.html">Spring objects</a> used to define a constraint (connection) between two particles in a system.</li>
<li><a href="./particleWorld.html">World objects</a> where we can store attributes and values used by various objects; these attributes can be set up so that they will be inherited by clones of the World object. We can also influence the speed of the physics animation here.</li>
</ul>
<p>We do not have to handle particle generation and manipulation ourselves. Instead, Scrawl-canvas gives us three dedicated <strong>entitys</strong> which we use to add particle animation effects to the canvas scene. These entitys are:</p>
<ul>
<li><a href="./tracer.html">Tracer</a> - this entity generates a single non-recycled (in other words: long lasting) particle with a history, which we can use to display trace effects in the animation.</li>
<li><a href="./emitter.html">Emitter</a> - an entity which generates a stream of short-lived, recycled particles, each with its own history. Emitters are highly versatile entitys which can generate a wide range of effects.</li>
<li><a href="./net.html">Net</a> - a (generally) larger entity which uses both forces and springs to manage the animation of its non-recycled particles. Note that other artefacts can use Net particles as a reference for their own positioning.</li>
</ul>
<h4 id="particle-physics">Particle physics</h4>
<p>The Scrawl-canvas particle physics engine system is based on a fairly classical understanding of particle <em><strong>kinetics</strong></em> (applying forces and constraints to a small, spherical object in 3D space) and <em><strong>kinematics</strong></em> (the movement of the small object in response to the forces and constraints applied to it).</p>
<p><strong>Particles</strong> are represented in the system by a simple Scrawl-canvas object which wraps a set of Scrawl-canvas Vector objects describing the particle’s position, velocity and load. The object also includes a history array detailing the recent particle’s most recent movements, an array of Force objects, a mass attribute (for gravity calculations), and an engine attribute - particles can use different engines to calculate their movements, depending on the needs of the animation; more precise engines are slower, but more stable.</p>
<ul>
<li>Note that all Particles are positioned using _<strong>absolute</strong> (pixel-based) coordinates; they cannot be positioned relatively (using String% values), or by reference to an artefact or another Particle.</li>
<li>Entitys that use Particles for their display - Emitter, Net, Tracer - can, however, use all the normal entity positioning strategies.</li>
<li>All artefacts (including all entitys) can position themselves by reference to a named (non-recycled) Particle.</li>
</ul>
<h4 id="the-particle-pool">The particle pool</h4>
<p>As part of a particle animation many thousands of Particle objects may need to be generated, used and then discarded. Scrawl-canvas attempts to make this more efficient by pooling particle objects so that they can be reused as the animation progresses. </p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h4 id="demos">Demos:</h4>
<ul>
<li><a href="../../demo/particles-001.html">particles-001</a> - Emitter entity, and Particle World, basic functionality</li>
<li><a href="../../demo/particles-002.html">particles-002</a> - Emitter using artefacts</li>
<li><a href="../../demo/particles-003.html">particles-003</a> - Position Emitter entity: start; pivot; mimic; path; mouse; drag-and-drop</li>
<li><a href="../../demo/particles-004.html">particles-004</a> - Emit particles along the length of a path</li>
<li><a href="../../demo/particles-005.html">particles-005</a> - Emit particles from inside an artefact’s area</li>
<li><a href="../../demo/particles-006.html">particles-006</a> - Fixed number of particles in a field; preAction and postAction functionality</li>
<li><a href="../../demo/particles-007.html">particles-007</a> - Particle Force objects: generation and functionality</li>
<li><a href="../../demo/particles-008.html">particles-008</a> - Net entity: generation and basic functionality, including Spring objects</li>
<li><a href="../../demo/particles-009.html">particles-009</a> - Net particles: drag-and-drop functionality</li>
<li><a href="../../demo/particles-010.html">particles-010</a> - Net entity: using a shape path as a net template</li>
<li><a href="../../demo/particles-011.html">particles-011</a> - Tracer entity: basic functionality</li>
<li><a href="../../demo/particles-012.html">particles-012</a> - Use Net entity particles as reference coordinates for other artefacts</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { <span class="hljs-title">constructors</span>, <span class="hljs-title">force</span>, <span class="hljs-title">spring</span>, <span class="hljs-title">springnames</span> } <span class="hljs-title">from</span> &#x27;../<span class="hljs-title">core</span>/<span class="hljs-title">library</span>.<span class="hljs-title">js</span>&#x27;;
<span class="hljs-keyword">import</span> { mergeOver, pushUnique, λ<span class="hljs-literal">null</span>, Ωempty } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/utilities.js&#x27;</span>;

<span class="hljs-keyword">import</span> { requestParticleHistoryObject, releaseParticleHistoryObject } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./particleHistory.js&#x27;</span>;
<span class="hljs-keyword">import</span> { requestVector, releaseVector, makeVector } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./vector.js&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>The Particle object uses the base mixin, thus it supports all the normal Scrawl-canvas functionality such as <code>get</code>, <code>set</code>, <code>setDelta</code>, <code>clone</code>, <code>kill</code>, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> baseMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/base.js&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h4 id="particle-constructor">Particle constructor</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Particle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = Ωempty</span>) </span>{

    <span class="hljs-built_in">this</span>.makeName(items.name);
    <span class="hljs-built_in">this</span>.register();

    <span class="hljs-built_in">this</span>.set(<span class="hljs-built_in">this</span>.defs);
    <span class="hljs-built_in">this</span>.initializePositions();
    <span class="hljs-built_in">this</span>.set(items);

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h4 id="particle-prototype">Particle prototype</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> P = Particle.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Particles have their own section in the Scrawl-canvas library. They are not artefacts or assets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.type = <span class="hljs-string">&#x27;Particle&#x27;</span>;
P.lib = <span class="hljs-string">&#x27;particle&#x27;</span>;
P.isArtefact = <span class="hljs-literal">false</span>;
P.isAsset = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h4 id="mixins">Mixins</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P = baseMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <h4 id="particle-attributes">Particle attributes</h4>
<ul>
<li>Attributes defined in the <a href="../mixin/base.html">base mixin</a>: <strong>name</strong>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>The <strong>position</strong> attribute represents a particle’s world coordinate, and is held in an <code>{x:value, y:value, z:value}</code> Vector object. The default values are <code>{x:0, y:0, z:0}</code>, placing the artifact at the Cdell canvas’s top-left corner. We can set the position using the <strong>positionX</strong>, <strong>positionY</strong> and <strong>positionZ</strong> pseudo-attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    position: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p><strong>velocity</strong> - Vector object, generally used internally as part of the particle physics calculation. We can give a particle an initial velocity using the <strong>velocityX</strong>, <strong>velocityY</strong> and <strong>velocityZ</strong> pseudo-attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    velocity: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p><strong>load</strong> - Vector object used internally as part of the particle physics calculation. Never attempt to amend this attribute as it gets reset to zero at the start of every Display cycle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    load: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p><strong>history</strong> - Array used to hold ParticleHistory arrays, which in turn include data on the particles position at a given time, and the time remaining for that particle to live. The latest history arrays are added to the start of the array, with the oldest history arrays at the end of the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    history: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p><strong>historyLength</strong> - Number - we control how many ParticleHistory arrays the Particle will retain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    historyLength: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p><strong>engine</strong> - a String value naming the physics engine to be used to calculate this Particle’s movement in response to all the forces applied to it. Scrawl-canvas comes with three in-built engines:</p>
<ul>
<li><strong>‘euler’</strong> - the simplest, quickest and least stable engine (default)</li>
<li><strong>‘runge-kutta’</strong> - the most complex, slowest and most stable engine</li>
<li><strong>‘improved-euler’</strong> - an engine that sits between the other two engines in terms of complexity, speed and stability.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    engine: <span class="hljs-string">&#x27;euler&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p><strong>forces</strong> - an Array to hold Force objects that will be applied to this Particle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    forces: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p><strong>mass</strong> - a Number value representing the Particle’s mass (in kg) - this value is used in the gravity force calculation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mass: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p><strong>fill</strong> and <strong>stroke</strong> - CSS color values which can be used to display the Particle during the animation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fill: <span class="hljs-string">&#x27;#000000&#x27;</span>,
    <span class="hljs-attr">stroke</span>: <span class="hljs-string">&#x27;#000000&#x27;</span>,
};
P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.packetExclusions = pushUnique(P.packetExclusions, []);
P.packetExclusionsByRegex = pushUnique(P.packetExclusionsByRegex, [<span class="hljs-string">&#x27;^(local|dirty|current)&#x27;</span>]);
P.packetCoordinates = pushUnique(P.packetCoordinates, []);
P.packetObjects = pushUnique(P.packetObjects, [<span class="hljs-string">&#x27;position&#x27;</span>, <span class="hljs-string">&#x27;velocity&#x27;</span>, <span class="hljs-string">&#x27;acceleration&#x27;</span>]);
P.packetFunctions = pushUnique(P.packetFunctions, []);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>
<p>In general we don’t need to create or clone Particles objects ourselves; their generation is managed behind the scenes by the physics-related entitys.</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.factoryKill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-built_in">this</span>.history.forEach(<span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> releaseParticleHistoryObject(h));

    <span class="hljs-keyword">let</span> deadSprings = [];

    springnames.forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

        <span class="hljs-keyword">let</span> s = spring[name];

        <span class="hljs-keyword">if</span> (s.particleFrom &amp;&amp; s.particleFrom.name === <span class="hljs-built_in">this</span>.name) deadSprings.push[s];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (s.particleTo &amp;&amp; s.particleTo.name === <span class="hljs-built_in">this</span>.name) deadSprings.push[s];
    });

    deadSprings.forEach(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.kill());
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> G = P.getters,
    S = P.setters,
    D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p><strong>positionX</strong>, <strong>positionY</strong>, <strong>positionZ</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.positionX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.position.x; };
G.positionY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.position.y; };
G.positionZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.position.z; };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>We return the <strong>position</strong> value as an <code>[x, y, z]</code> Array rather than as an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.position = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">this</span>.position;
    <span class="hljs-keyword">return</span> [s.x, s.y, s.z];
};

S.positionX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.position.x = coord; };
S.positionY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.position.y = coord; };
S.positionZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.position.z = coord; };

S.position = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{ <span class="hljs-built_in">this</span>.position.set(item); };

D.positionX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.position.x += coord; };
D.positionY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.position.y += coord; };
D.positionZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.position.z += coord; };

D.position = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p><strong>velocity</strong>, <strong>velocityX</strong>, <strong>velocityY</strong>, <strong>velocityZ</strong></p>
<ul>
<li>There should be no need to access/amend these values</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.velocityX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.velocity.x; };
G.velocityY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.velocity.y; };
G.velocityZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.velocity.z; };

G.velocity = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">this</span>.velocity;
    <span class="hljs-keyword">return</span> [s.x, s.y, s.z];
};

S.velocityX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.velocity.x = coord; };
S.velocityY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.velocity.y = coord; };
S.velocityZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.velocity.z = coord; };

S.velocity = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y, z</span>) </span>{

    <span class="hljs-built_in">this</span>.velocity.set(x, y, z);
};

D.velocityX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.velocity.x += coord; };
D.velocityY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.velocity.y += coord; };
D.velocityZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{ <span class="hljs-built_in">this</span>.velocity.z += coord; };

D.velocity = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p><strong>forces</strong> - generally no need to add forces to Particles ourselves as this is handled by the physics-based entitys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.forces = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(item)) {

            <span class="hljs-built_in">this</span>.forces.length = <span class="hljs-number">0</span>;
            <span class="hljs-built_in">this</span>.forces = <span class="hljs-built_in">this</span>.forces.concat(item);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.forces.push(item);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>Remove certain attributes from the set/deltaSet functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.load = λ<span class="hljs-literal">null</span>;
S.history = λ<span class="hljs-literal">null</span>;

D.load = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>
<p><code>initializePositions</code> - internal function called by all particle factories </p>
<ul>
<li>Setup initial Arrays and Objects.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.initializePositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-built_in">this</span>.initialPosition = makeVector();
    <span class="hljs-built_in">this</span>.position = makeVector();
    <span class="hljs-built_in">this</span>.velocity = makeVector();
    <span class="hljs-built_in">this</span>.load = makeVector();

    <span class="hljs-built_in">this</span>.forces = [];
    <span class="hljs-built_in">this</span>.history = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p><strong>isRunning</strong> - a Boolean flag used as part of internal Particle lifetime management</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">this</span>.isRunning = <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p><code>applyForces</code> - internal function used to calculate the particles’s load vector</p>
<ul>
<li>Requires both a <strong>world</strong> object and a <strong>host</strong> (Cell) object as arguments</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.applyForces = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">world, host</span>) </span>{

    <span class="hljs-built_in">this</span>.load.zero();

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isBeingDragged) {

        <span class="hljs-built_in">this</span>.forces.forEach(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {

            <span class="hljs-keyword">let</span> f = force[key];

            <span class="hljs-keyword">if</span> (f &amp;&amp; f.action) f.action(<span class="hljs-built_in">this</span>, world, host);
        });
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p><code>update</code> - internal function used to calculate the Particles’s position vector from its load and velocity vectors</p>
<ul>
<li>Requires both a <strong>tick</strong> Number (measured in seconds) and a <strong>host</strong> (Cell) object as arguments</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.update = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tick, world</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isBeingDragged) <span class="hljs-built_in">this</span>.position.setFromVector(<span class="hljs-built_in">this</span>.isBeingDragged).vectorAdd(<span class="hljs-built_in">this</span>.dragOffset);
    <span class="hljs-keyword">else</span> particleEngines[<span class="hljs-built_in">this</span>.engine].call(<span class="hljs-built_in">this</span>, tick * world.tickMultiplier);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p><code>manageHistory</code> - internal function. Every particle can retain a history of its previous time and position moments, held in a ParticleHistory Array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.manageHistory = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tick, host</span>) </span>{

    <span class="hljs-keyword">let</span> {history, remainingTime, position, historyLength, hasLifetime, distanceLimit, initialPosition, killBeyondCanvas} = <span class="hljs-built_in">this</span>;

    <span class="hljs-keyword">let</span> addHistoryFlag = <span class="hljs-literal">true</span>,
        remaining = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>A particle can have a lifetime value - a float Number measured in seconds, stored in the <code>remainingTime</code> attribute. This is flagged for action in the <code>hasLifetime</code> attribute. The particle has, in effect, three states:</p>
<ul>
<li><em><strong>alive</strong></em> - on each tick a ParticleHistory object will be generated and added to the particle’s <code>history</code> attribute array; if this addition takes the history array over its permitted length (as detailed in the particle’s <code>historyLength</code> attribute) then the oldest ParticleHistory object is removed from the history array</li>
<li><em><strong>dying</strong></em> - if the particle has existed for longer than its alotted time - as detailed in its <code>remainingTime</code> attribute - then it enters a post-life phase where history objects are no longer generated on each tick, but the oldest ParticleHistory object continues to be removed from the history array</li>
<li><em><strong>dead</strong></em> - when the particle has existed for longer than its alotted time, and its history array is finally empty, then its <code>isRunning</code> flag can be set to false.</li>
</ul>
<p>Particle lifetime values are set by the emitter when creating the particles, based on the emitter’s <code>killAfterTime</code> and <code>killAfterTimeVariation</code> attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (hasLifetime) {

        remaining = remainingTime - tick;

        <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">let</span> last = history.pop();

            releaseParticleHistoryObject(last);

            addHistoryFlag = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (!history.length) <span class="hljs-built_in">this</span>.isRunning = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.remainingTime = remaining;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p>A particle can be killed off under the following additional circumstances:</p>
<ul>
<li>If we set the emitter’s <code>killBeyondCanvas</code> flag to <code>true</code></li>
<li>If we set a kill radius - a distance from the particle’s initial position beyond which the particle will be removed - defined in the emitter’s <code>killRadius</code> and <code>killRadiusVariation</code> attributes</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> oldest = history[history.length - <span class="hljs-number">1</span>];

    <span class="hljs-keyword">if</span> (oldest) {

        <span class="hljs-keyword">let</span> [or, oz, ox, oy] = oldest;

        <span class="hljs-keyword">if</span> (killBeyondCanvas) {

            <span class="hljs-keyword">let</span> w = host.element.width,
                h = host.element.height;

            <span class="hljs-keyword">if</span> (ox &lt; <span class="hljs-number">0</span> || oy &lt; <span class="hljs-number">0</span> || ox &gt; w || oy &gt; h) {

                addHistoryFlag = <span class="hljs-literal">false</span>;
                <span class="hljs-built_in">this</span>.isRunning = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-keyword">if</span> (distanceLimit) {

            <span class="hljs-keyword">let</span> test = requestVector(initialPosition);

            test.vectorSubtractArray([ox, oy, oz]);

            <span class="hljs-keyword">if</span> (test.getMagnitude() &gt; distanceLimit) {

                addHistoryFlag = <span class="hljs-literal">false</span>;
                <span class="hljs-built_in">this</span>.isRunning = <span class="hljs-literal">false</span>;
            }
            releaseVector(test);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p>Generate a new ParticleHistory object, if required, and remove any old ParticleHistory object beyond the history array’s permitted length (as defined in the emitter’s <code>historyLength</code> attribute)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (addHistoryFlag) {

        <span class="hljs-keyword">let</span> {x, y, z} = position;

        <span class="hljs-keyword">let</span> h = requestParticleHistoryObject();

        h.push(remaining, z, x, y);

        history.unshift(h);

        <span class="hljs-keyword">if</span> (history.length &gt; historyLength) {

            <span class="hljs-keyword">let</span> old = history.splice(historyLength);

            old.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> releaseParticleHistoryObject(item));
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p><code>run</code> - internal function. We define the triggers that will kill the particle at the same time as we start it running. This function should only be called by an physics entity (Emitter, Net, Tracer). Note that there is no equivalent <code>halt</code> function; instead, we set the particle’s <code>isRunning</code> attribute to false to get it removed from the system. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.run = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">timeKill, radiusKill, killBeyondCanvas</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <p>We can kill a Particle if it has lasted longer than its alloted lifetime. Lifetime (if required) is assigned to the Particle by its entity when generated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">this</span>.hasLifetime = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (timeKill) {

        <span class="hljs-built_in">this</span>.remainingTime = timeKill;
        <span class="hljs-built_in">this</span>.hasLifetime = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p>We can kill a Particle if it has passed a certain distance beyond its initial position. Kill radius value (if required) is assigned to the Particle by its entity when generated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">this</span>.distanceLimit = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (radiusKill) {
        
        <span class="hljs-built_in">this</span>.initialPosition.set(<span class="hljs-built_in">this</span>.position);
        <span class="hljs-built_in">this</span>.distanceLimit = radiusKill;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p>We can kill a Particle if it has moved beyond the Cell’s canvas’s dimensions. This boolean is set on the Particle by its entity when generated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">this</span>.killBeyondCanvas = killBeyondCanvas;

    <span class="hljs-built_in">this</span>.isRunning = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <h4 id="factory">Factory</h4>
<p>Scrawl-canvas does not expose the particle factory functions in the scrawl object. Instead, particles are consumed by the physics-based entitys: <a href="./tracer.html">Tracer</a>; <a href="./emitter.html">Emitter</a>; <a href="./net.html">Net</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeParticle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">if</span> (!items) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Particle(items);
};

<span class="hljs-title">constructors</span>.<span class="hljs-title">Particle</span> = <span class="hljs-title">Particle</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <h4 id="particle-pool">Particle pool</h4>
<p>An attempt to reuse Particle objects rather than constantly creating and deleting them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> particlePool = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p><code>exported function</code> - retrieve a Particle from the particle pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> requestParticle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">if</span> (!particlePool.length) particlePool.push(<span class="hljs-keyword">new</span> Particle());

    <span class="hljs-keyword">let</span> v = particlePool.shift();

    v.set(items);

    <span class="hljs-keyword">return</span> v
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p><code>exported function</code> - return a Particle to the particle pool. Failing to return Particles to the pool may lead to more inefficient code and possible memory leaks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> releaseParticle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item &amp;&amp; item.type === <span class="hljs-string">&#x27;Particle&#x27;</span>) {

        item.history.forEach(<span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> releaseParticleHistoryObject(h));
        item.history.length = <span class="hljs-number">0</span>;

        item.set(item.defs);
        particlePool.push(item);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <p>Do not keep excessive numbers of under-utilised particle objects in the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (particlePool.length &gt; <span class="hljs-number">50</span>) {

            <span class="hljs-keyword">let</span> temp = [].concat(particlePool);
            particlePool.length = <span class="hljs-number">0</span>;
            temp.forEach(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.kill());
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <h4 id="particle-physics-engines">Particle physics engines</h4>
<p>These functions are called by the <code>update</code> function which assigns the Particle object as <code>this</code> as part of the call. The engines calculate particle acceleration and apply it to particle velocity and then, taking into account the time elapsed since the previous tick, particle position.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> particleEngines = {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p><strong>euler</strong> - the simplest and quickest engine, and the least accurate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">&#x27;euler&#x27;</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tick</span>) </span>{

        <span class="hljs-keyword">let</span> {position, velocity, load, mass} = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">let</span> acc = requestVector(),
            vel = requestVector(velocity);

        acc.setFromVector(load).scalarDivide(mass);

        vel.vectorAdd(acc.scalarMultiply(tick));

        velocity.setFromVector(vel);

        position.vectorAdd(vel.scalarMultiply(tick));

        releaseVector(acc, vel);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <p><strong>improved-euler</strong> is more accurate than the euler engine, but takes longer to calculate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">&#x27;improved-euler&#x27;</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tick</span>) </span>{

        <span class="hljs-keyword">let</span> {position, velocity, load, mass} = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">let</span> acc1 = requestVector(),
            acc2 = requestVector(),
            acc3 = requestVector(),
            vel = requestVector(velocity);

        acc1.setFromVector(load).scalarDivide(mass).scalarMultiply(tick);
        acc2.setFromVector(load).vectorAdd(acc1).scalarDivide(mass).scalarMultiply(tick);
        acc3.setFromVector(acc1).vectorAdd(acc2).scalarDivide(<span class="hljs-number">2</span>);

        vel.vectorAdd(acc3);

        velocity.setFromVector(vel);

        position.vectorAdd(vel.scalarMultiply(tick));

        releaseVector(acc1, acc2, acc3, vel);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p><strong>runge-kutta</strong> is very accurate, but also a lot more computationally expensive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">&#x27;runge-kutta&#x27;</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tick</span>) </span>{

        <span class="hljs-keyword">let</span> {position, velocity, load, mass} = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">let</span> acc1 = requestVector(),
            acc2 = requestVector(),
            acc3 = requestVector(),
            acc4 = requestVector(),
            acc5 = requestVector(),
            vel = requestVector(velocity);

        acc1.setFromVector(load).scalarDivide(mass).scalarMultiply(tick).scalarDivide(<span class="hljs-number">2</span>);
        acc2.setFromVector(load).vectorAdd(acc1).scalarDivide(mass).scalarMultiply(tick).scalarDivide(<span class="hljs-number">2</span>);
        acc3.setFromVector(load).vectorAdd(acc2).scalarDivide(mass).scalarMultiply(tick).scalarDivide(<span class="hljs-number">2</span>);
        acc4.setFromVector(load).vectorAdd(acc3).scalarDivide(mass).scalarMultiply(tick).scalarDivide(<span class="hljs-number">2</span>);

        acc2.scalarMultiply(<span class="hljs-number">2</span>);
        acc3.scalarMultiply(<span class="hljs-number">2</span>);

        acc5.setFromVector(acc1).vectorAdd(acc2).vectorAdd(acc3).vectorAdd(acc4).scalarDivide(<span class="hljs-number">6</span>);

        vel.vectorAdd(acc5);

        velocity.setFromVector(vel);

        position.vectorAdd(vel.scalarMultiply(tick));

        releaseVector(acc1, acc2, acc3, acc4, acc5, vel);
    },
};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <h4 id="exports">Exports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> {
    makeParticle,

    requestParticle,
    releaseParticle,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
