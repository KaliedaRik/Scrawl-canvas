<!DOCTYPE html>

<html>
<head>
  <title>Filter worker</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="../mixin/shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="filter-stringed.html">
                  ./source/worker/filter-stringed.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/worker/filter.js
                </a>
              
                
                <a class="source" href="filter_canvas.html">
                  ./source/worker/filter_canvas.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="filter-worker">Filter worker</h1>
<p>A long-running web worker which, when not in use, gets stored in the filter pool defined in the <a href="../factory/filter.html">filter factory</a></p>
<p>TODO: at the moment the code in this file replicates exactly the code in the worker/filter.js file. However at some point we will be writing filters that can make use of offscreen canvases … in this file!</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>
<p>None used</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="polyfills">Polyfills</h4>
<p>TypedArray.slice() <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/slice">polyfill</a> - for blur filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Uint8Array</span>.prototype.slice) {
    <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-built_in">Uint8Array</span>.prototype, <span class="hljs-string">'slice'</span>, {
        <span class="hljs-attr">value</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">begin, end</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-keyword">this</span>, begin, end));
        }
    });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="worker-wide-variables">Worker-wide variables</h4>
<p>The following variables are defined here so that all filter functions - including user-defined filters - can make use of them:</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>packet</strong> - the <code>e.data</code> object sent to the web worker from the main code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> packet;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>image</strong> - the <code>ImageData</code> object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> image;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>iWidth</strong> - convenience variable - <code>image.width * 4</code> (to cope with moving through the data array by pixel)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> iWidth;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong>data</strong> - the <code>Uint8ClampedArray</code> data component of the ImageData object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> data;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>cache</strong> - an Array of all the starting (ie: red channel) indexes for pixels whose alpha channel is &gt; 0 (and thus not transparent) - speeds up things for pixel-by-pixel filters that don’t need to process transparent pixels. Generated by running the web worker’s <code>getCache</code> function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> cache;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>tiles</strong> - the output from running the web worker’s <code>getTiles</code> function. This effectively divides the image data into a grid of blocks which can be further processed by a filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> tiles;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>localX</strong>, <strong>localY</strong>, <strong>localWidth</strong>, <strong>localHeight</strong> - the start coordinates and dimensions of the box enclosing all the non-transparent pixels in the supplied image data array. Used mainly by the blur filter - but any filter (including user-defined filters) that needs to include transparent pixel values in its calculations, but would waste time processing non-visible areas of the image, can make use of these variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> localX;
<span class="hljs-keyword">let</span> localY;
<span class="hljs-keyword">let</span> localWidth;
<span class="hljs-keyword">let</span> localHeight;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>filters</strong> - the filter objects Array sent to the web worker from the main code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> filters;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong>filter</strong> - the current filter object being processed by the web worker - holds all the settings required for that filter function, for example <code>filter.level</code> for the brightness, saturation and threshold filter functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> filter;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong>action</strong> - internal processing variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> action;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h4 id="messaging-and-error-handling">Messaging and error handling</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

    <span class="hljs-keyword">let</span> i, iz;

    packet = e.data;
    image = packet.image;
    iWidth = image.width * <span class="hljs-number">4</span>;
    data = image.data;
    filters = packet.filters;

    getCache();
    getLocal();

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = filters.length; i &lt; iz; i++) {

        filter = filters[i];

        <span class="hljs-keyword">if</span> (filter.method === <span class="hljs-string">'userDefined'</span> &amp;&amp; filter.userDefined) actions.userDefined = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(filter.userDefined);

        action = actions[filter.method];

        <span class="hljs-keyword">if</span> (action) action();
    }

    postMessage(packet);
};

onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error'</span> + e.message);
    postMessage(packet);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong>getCache</strong> - function that fills the <code>cache</code> worker variable with the starting index position of each non-transparent pixel in the current image’s Uint8ClampedArray Array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> getCache = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> i, iz;

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(cache)) cache.length = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">else</span> cache = [];

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = data.length; i &lt; iz; i += <span class="hljs-number">4</span>) {

        <span class="hljs-keyword">if</span> (data[i + <span class="hljs-number">3</span>]) cache.push(i);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong>getLocal</strong> - function that populates the <code>localX</code>, <code>localY</code>, <code>localWidth</code>, <code>localHeight</code> worker variables with relevant values for the current image data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> getLocal = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> i, iz, w, h, minX, minY, maxX, maxY, x, y, val,
        floor = <span class="hljs-built_in">Math</span>.floor;

    w = image.width;
    h = image.height;
    minX = w;
    minY = h;
    maxX = <span class="hljs-number">0</span>;
    maxY = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

        val = cache[i] / <span class="hljs-number">4</span>;
        y = floor(val / w);
        x = val % w;
        minX = (x &lt; minX) ? x : minX;
        minY = (y &lt; minY) ? y : minY;
        maxX = (x &gt; maxX) ? x : maxX;
        maxY = (y &gt; maxY) ? y : maxY;
    }

    localX = minX;
    localY = minY;
    localWidth = maxX - minX;
    localHeight = maxY - minY;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong>getTiles</strong> - function that populates the <code>tiles</code> worker Array with relevant values for the current image data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> getTiles = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> i, iz, j, jz, x, xz, y, yz, startX, startY, pos, 
        hold = [],
        tileWidth = filter.tileWidth || <span class="hljs-number">1</span>,
        tileHeight = filter.tileHeight || <span class="hljs-number">1</span>,
        offsetX = filter.offsetX,
        offsetY = filter.offsetY,
        w = image.width,
        h = image.height;

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(tiles)) tiles.length = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">else</span> tiles = [];

    offsetX = (offsetX &gt;= tileWidth) ? tileWidth - <span class="hljs-number">1</span> : offsetX;
    offsetY = (offsetY &gt;= tileHeight) ? tileHeight - <span class="hljs-number">1</span> : offsetY;

    startX = (offsetX) ? offsetX - tileWidth : <span class="hljs-number">0</span>;
    startY = (offsetY) ? offsetY - tileHeight : <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (j = startY, jz = h + tileHeight; j &lt; jz; j += tileHeight) {

        <span class="hljs-keyword">for</span> (i = startX, iz = w + tileWidth; i &lt; iz; i += tileWidth) {

            hold.length = <span class="hljs-number">0</span>;
            
            <span class="hljs-keyword">for</span> (y = j, yz = j + tileHeight; y &lt; yz; y++) {

                <span class="hljs-keyword">if</span> (y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; h) {

                    <span class="hljs-keyword">for</span> (x = i, xz = i + tileWidth; x &lt; xz; x++) {

                        <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; w) {

                            pos = (y * iWidth) + (x * <span class="hljs-number">4</span>);

                            <span class="hljs-keyword">if</span> (data[pos + <span class="hljs-number">3</span>]) hold.push(pos);
                        }
                    }
                }
            }
            <span class="hljs-keyword">if</span> (hold.length) tiles.push([].concat(hold));
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong>average</strong> - Returns the average of values in an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> average = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{

    <span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>,
        k, kz,
        l = c.length;

    <span class="hljs-keyword">if</span> (l) {

        <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>, kz = l; k &lt; kz; k++) {

            a +=c[k];
        }
        <span class="hljs-keyword">return</span> a / l;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><strong>checkBounds</strong> - Checks that a position cursor is within the bounds of the data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> checkBounds = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{

    <span class="hljs-keyword">let</span> len = data.length;

    <span class="hljs-keyword">if</span> (p &lt; <span class="hljs-number">0</span>) p += len;
    <span class="hljs-keyword">if</span> (p &gt;= len) p -= len;
    <span class="hljs-keyword">return</span> p;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>All the pre-defined filter functions are held as attributes to the <strong>actions object</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> actions = {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><strong>userDefined</strong> - requires a String function in the <code>filter.userDefined</code> attribute, which will be generated into a working function by the web worker - such filters can make use of any other filter attributes (for example: <code>filter.level</code>) alongside the dedicated userDefined attributes <code>filter.udVariable0 - filter.udVariable9</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    userDefined: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><strong>grayscale</strong> - desaturates the image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    grayscale: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, gray;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            gray = (<span class="hljs-number">0.2126</span> * data[pos]) + (<span class="hljs-number">0.7152</span> * data[pos + <span class="hljs-number">1</span>]) + (<span class="hljs-number">0.0722</span> * data[pos + <span class="hljs-number">2</span>]);
            data[pos] = data[pos + <span class="hljs-number">1</span>] = data[pos + <span class="hljs-number">2</span>] = gray;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong>sepia</strong> - desaturates the image, then ‘antiques’ it by adding back some yellow tone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sepia: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, r, g, b;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            
            r = data[pos];
            g = data[pos + <span class="hljs-number">1</span>];
            b = data[pos + <span class="hljs-number">2</span>];
            
            data[pos] = (r * <span class="hljs-number">0.393</span>) + (g * <span class="hljs-number">0.769</span>) + (b * <span class="hljs-number">0.189</span>);
            data[pos + <span class="hljs-number">1</span>] = (r * <span class="hljs-number">0.349</span>) + (g * <span class="hljs-number">0.686</span>) + (b * <span class="hljs-number">0.168</span>);
            data[pos + <span class="hljs-number">2</span>] = (r * <span class="hljs-number">0.272</span>) + (g * <span class="hljs-number">0.534</span>) + (b * <span class="hljs-number">0.131</span>);
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong>invert</strong> - turns white into black, and similar across the spectrum</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    invert: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] = <span class="hljs-number">255</span> - data[pos];
            
            pos++;
            data[pos] = <span class="hljs-number">255</span> - data[pos];
            
            pos++;
            data[pos] = <span class="hljs-number">255</span> - data[pos];
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong>red</strong> - suppresses the image’s green and blue channels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    red: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
            data[pos + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong>green</strong> - suppresses the image’s red and blue channels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    green: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] = <span class="hljs-number">0</span>;
            data[pos + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong>blue</strong> - suppresses the image’s red and green channels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    blue: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] = <span class="hljs-number">0</span>;
            data[pos + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><strong>notred</strong> - suppresses the image’s red channel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notred: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><strong>notgreen</strong> - suppresses the image’s green channel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notgreen: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><strong>notblue</strong> - suppresses the image’s blue channel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notblue: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><strong>cyan</strong> - averages the image’s blue and green channels, and suppresses the red channel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cyan: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, gray;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            
            gray = (data[pos + <span class="hljs-number">1</span>] + data[pos + <span class="hljs-number">2</span>]) / <span class="hljs-number">2</span>;
            
            data[pos] = <span class="hljs-number">0</span>;
            data[pos + <span class="hljs-number">1</span>] = gray;
            data[pos + <span class="hljs-number">2</span>] = gray;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><strong>magenta</strong> - averages the image’s red and blue channels, and suppresses the green channel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    magenta: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, gray;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];

            gray = (data[pos] + data[pos + <span class="hljs-number">2</span>]) / <span class="hljs-number">2</span>;

            data[pos] = gray;
            data[pos + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
            data[pos + <span class="hljs-number">2</span>] = gray;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><strong>yellow</strong> - averages the image’s red and green channels, and suppresses the blue channel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    yellow: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, gray;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            
            gray = (data[pos] + data[pos + <span class="hljs-number">1</span>]) / <span class="hljs-number">2</span>;
            
            data[pos] = gray;
            data[pos + <span class="hljs-number">1</span>] = gray;
            data[pos + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><strong>brightness</strong> - multiplies the red, green and blue channel values by a value supplied in the filter.level attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    brightness: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, 
            level = filter.level || <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] *= level;
            
            pos++;
            data[pos] *= level;
            
            pos++;
            data[pos] *= level;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><strong>saturation</strong> - multiplies the red, green and blue channel values by a value supplied in the filter.level attribute, then normalizes the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    saturation: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, 
            level = filter.level || <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] = <span class="hljs-number">127</span> + ((data[pos] - <span class="hljs-number">127</span>) * level);
            
            pos++;
            data[pos] = <span class="hljs-number">127</span> + ((data[pos] - <span class="hljs-number">127</span>) * level);
            
            pos++;
            data[pos] = <span class="hljs-number">127</span> + ((data[pos] - <span class="hljs-number">127</span>) * level);
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><strong>threshold</strong> - desaturates each pixel then tests it against filter.level value; those pixels below the level are set to the filter.lowRGB values while the rest are set to the filter.highRGB values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    threshold: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, gray, test,
            level = filter.level || <span class="hljs-number">0</span>,
            lowRed = filter.lowRed,
            lowGreen = filter.lowGreen,
            lowBlue = filter.lowBlue,
            highRed = filter.highRed,
            highGreen = filter.highGreen,
            highBlue = filter.highBlue;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            
            gray = (<span class="hljs-number">0.2126</span> * data[pos]) + (<span class="hljs-number">0.7152</span> * data[pos + <span class="hljs-number">1</span>]) + (<span class="hljs-number">0.0722</span> * data[pos + <span class="hljs-number">2</span>]);
            test = (gray &gt; level) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
            
            <span class="hljs-keyword">if</span> (test) {

                data[pos] = highRed;
                data[pos + <span class="hljs-number">1</span>] = highGreen;
                data[pos + <span class="hljs-number">2</span>] = highBlue;
            }
            <span class="hljs-keyword">else</span> {

                data[pos] = lowRed;
                data[pos + <span class="hljs-number">1</span>] = lowGreen;
                data[pos + <span class="hljs-number">2</span>] = lowBlue;
            }
            
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p><strong>channels</strong> - multiply each pixel’s channel values by the values set in the filter.RGB attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    channels: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos,
            red = filter.red || <span class="hljs-number">0</span>,
            green = filter.green || <span class="hljs-number">0</span>,
            blue = filter.blue || <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            
            data[pos] *= red;
            data[pos + <span class="hljs-number">1</span>] *= green;
            data[pos + <span class="hljs-number">2</span>] *= blue;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><strong>channelstep</strong> - divide, floor, and then multiply each pixel’s channel values by the values set in the filter.RGB attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    channelstep: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos,
            red = filter.red || <span class="hljs-number">1</span>,
            green = filter.green || <span class="hljs-number">1</span>,
            blue = filter.blue || <span class="hljs-number">1</span>,
            floor = <span class="hljs-built_in">Math</span>.floor;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            data[pos] = floor(data[pos] / red) * red;
            
            pos++;
            data[pos] = floor(data[pos] / green) * green;
            
            pos++;
            data[pos] = floor(data[pos] / blue) * blue;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><strong>tint</strong> - a more fine-grained form of the channels filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tint: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, pos, r, g, b,
            redInRed = filter.redInRed || <span class="hljs-number">0</span>,
            redInGreen = filter.redInGreen || <span class="hljs-number">0</span>,
            redInBlue = filter.redInBlue || <span class="hljs-number">0</span>,
            greenInRed = filter.greenInRed || <span class="hljs-number">0</span>,
            greenInGreen = filter.greenInGreen || <span class="hljs-number">0</span>,
            greenInBlue = filter.greenInBlue || <span class="hljs-number">0</span>,
            blueInRed = filter.blueInRed || <span class="hljs-number">0</span>,
            blueInGreen = filter.blueInGreen || <span class="hljs-number">0</span>,
            blueInBlue = filter.blueInBlue || <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            pos = cache[i];
            
            r = data[pos];
            g = data[pos + <span class="hljs-number">1</span>];
            b = data[pos + <span class="hljs-number">2</span>];
            
            data[pos] = (r * redInRed) + (g * greenInRed) + (b * blueInRed);
            data[pos + <span class="hljs-number">1</span>] = (r * redInGreen) + (g * greenInGreen) + (b * blueInGreen);
            data[pos + <span class="hljs-number">2</span>] = (r * redInBlue) + (g * greenInBlue) + (b * blueInBlue);
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><strong>chroma</strong> - will evaluate each pixel against a range array; pixels that fall within the range are set to transparent</p>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>The <strong>ranges</strong> attribute needs to be an array of arrays with the following format:</p>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <pre><code>[[minRed, minGreen, minBlue, maxRed, maxGreen, maxBlue], etc]</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>… multiple ranges can be defined - for instance to key out the lightest and darkest hues:</p>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <pre><code>ranges: [[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>], [<span class="hljs-number">180</span>, <span class="hljs-number">180</span>, <span class="hljs-number">180</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>]]</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    chroma: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> pos, posA,
            ranges = filter.ranges,
            range, min, max, val,
            i, iz, j, jz, flag;

        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = cache.length; j &lt; jz; j++) {

            flag = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = ranges.length; i &lt; iz; i++) {

                posA = cache[j] + <span class="hljs-number">3</span>;
                range = ranges[i];
                min = range[<span class="hljs-number">2</span>];
                pos = posA - <span class="hljs-number">1</span>;
                val = data[pos];

                <span class="hljs-keyword">if</span> (val &gt;= min) {

                    max = range[<span class="hljs-number">5</span>];

                    <span class="hljs-keyword">if</span> (val &lt;= max) {

                        min = range[<span class="hljs-number">1</span>];
                        pos--;
                        val = data[pos];

                        <span class="hljs-keyword">if</span> (val &gt;= min) {

                            max = range[<span class="hljs-number">4</span>];

                            <span class="hljs-keyword">if</span> (val &lt;= max) {

                                min = range[<span class="hljs-number">0</span>];
                                pos--;
                                val = data[pos];

                                <span class="hljs-keyword">if</span> (val &gt;= min) {

                                    max = range[<span class="hljs-number">3</span>];

                                    <span class="hljs-keyword">if</span> (val &lt;= max) {
                                        flag = <span class="hljs-literal">true</span>;
                                        <span class="hljs-keyword">break</span>;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            <span class="hljs-keyword">if</span> (flag) data[posA] = <span class="hljs-number">0</span>;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><strong>pixelate</strong> - create tiles - whose dimensions and positions are determined by values set in the filter tileWidth, tileHeight, offsetX and offsetY attributes - across the image and then average the pixels in each tile to a single color</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pixelate: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, j, jz, pos, r, g, b, a, tile, len;

        getTiles();

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = tiles.length; i &lt; iz; i++) {

            tile = tiles[i];
            r = g = b = a = <span class="hljs-number">0</span>;
            len = tile.length;

            <span class="hljs-keyword">if</span> (len) {

                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = len; j &lt; jz; j++) {

                    pos = tile[j];

                    r += data[pos];
                    g += data[pos + <span class="hljs-number">1</span>];
                    b += data[pos + <span class="hljs-number">2</span>];
                    a += data[pos + <span class="hljs-number">3</span>];
                }

                r /= len;
                g /= len;
                b /= len;
                a /= len;

                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = len; j &lt; jz; j++) {

                    pos = tile[j];

                    data[pos] = r;
                    data[pos + <span class="hljs-number">1</span>] = g;
                    data[pos + <span class="hljs-number">2</span>] = b;
                    data[pos + <span class="hljs-number">3</span>] = a;
                }
            }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><strong>blur</strong> - creates a blurred image. Note: can be slow across larger images! The degree of the blur - which does not follow conventional algorithms such as gaussian - is determined by the filter attribute values for radius (number), passes (number) and shrink (boolean)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    blur: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (data.slice) {

            <span class="hljs-keyword">let</span> radius = filter.radius || <span class="hljs-number">1</span>,
                alpha = filter.includeAlpha || <span class="hljs-literal">false</span>,
                shrink = filter.shrinkingRadius || <span class="hljs-literal">false</span>,
                passes = filter.passes || <span class="hljs-number">1</span>,
                len = data.length,
                imageWidth = image.width,
                imageHeight = image.height,
                tempDataTo, tempDataFrom,
                i, iz, index;

            <span class="hljs-keyword">let</span> processPass = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                <span class="hljs-keyword">let</span> j, jz;

                tempDataFrom = tempDataTo.slice(); 

                <span class="hljs-keyword">for</span> (j = localX * <span class="hljs-number">4</span>, jz = (localX + localWidth) * <span class="hljs-number">4</span>; j &lt; jz; j++) {

                    <span class="hljs-keyword">if</span> (alpha) processColumn(j);
                    <span class="hljs-keyword">else</span> {

                        <span class="hljs-keyword">if</span> (j % <span class="hljs-number">4</span> !== <span class="hljs-number">3</span>) processColumn(j);
                    }
                }

                tempDataFrom = tempDataTo.slice(); 

                <span class="hljs-keyword">for</span> (j = localY, jz = localY + localHeight; j &lt; jz; j++) {

                    <span class="hljs-keyword">if</span> (alpha) processRowWithAlpha(j);
                    <span class="hljs-keyword">else</span> processRowNoAlpha(j);
                }
            };

            <span class="hljs-keyword">let</span> processColumn = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">col</span>) </span>{

                <span class="hljs-keyword">let</span> pos, avg, val, cagePointer, y, yz, q, dataPointer,
                    vLead = radius * iWidth, 
                    cage = [],
                    cageLen;

                <span class="hljs-keyword">for</span> (y = -radius, yz = radius; y &lt; yz; y++) {

                    pos = col + (y * iWidth);
                    pos = checkBounds(pos, len);
                    cage.push(tempDataFrom[pos]);
                }

                tempDataTo[col] = avg = average(cage);

                cageLen = cage.length;

                <span class="hljs-keyword">for</span> (q = <span class="hljs-number">0</span>; q &lt; cageLen; q++) {

                    cage[q] /= cageLen;
                }

                cagePointer = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (y = <span class="hljs-number">1</span>; y &lt; imageHeight; y++) {

                    avg -= cage[cagePointer];

                    dataPointer = col + (y * iWidth);
                    pos = dataPointer + vLead;
                    pos = checkBounds(pos, len);
                    val = tempDataFrom[pos] / cageLen;

                    avg += val;
                    cage[cagePointer] = val;
                    tempDataTo[dataPointer] = avg;

                    cagePointer++;

                    <span class="hljs-keyword">if</span> (cagePointer === cageLen) cagePointer = <span class="hljs-number">0</span>;
                }
            };

            <span class="hljs-keyword">let</span> processRowWithAlpha = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row</span>) </span>{

                <span class="hljs-keyword">let</span> pos, val, x, xz, q, avgQ, cageQ, rowPosX,
                    avg = [],
                    cage = [[], [], [], []],
                    rowPos = row * iWidth, 
                    hLead = radius * <span class="hljs-number">4</span>,
                    dataPointer, cagePointer, cageLen;

                q = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (x = -radius * <span class="hljs-number">4</span>, xz = radius * <span class="hljs-number">4</span>; x &lt; xz; x++) {

                    pos = rowPos + x;
                    pos = checkBounds(pos, len);
                    
                    cage[q].push(tempDataFrom[pos]);
                    
                    q++;
                    <span class="hljs-keyword">if</span> (q === <span class="hljs-number">4</span>) q = <span class="hljs-number">0</span>;
                }

                tempDataTo[rowPos] = avg[<span class="hljs-number">0</span>] = average(cage[<span class="hljs-number">0</span>]);
                tempDataTo[rowPos + <span class="hljs-number">1</span>] = avg[<span class="hljs-number">1</span>] = average(cage[<span class="hljs-number">1</span>]);
                tempDataTo[rowPos + <span class="hljs-number">2</span>] = avg[<span class="hljs-number">2</span>] = average(cage[<span class="hljs-number">2</span>]);
                tempDataTo[rowPos + <span class="hljs-number">3</span>] = avg[<span class="hljs-number">3</span>] = average(cage[<span class="hljs-number">3</span>]);

                cageLen = cage[<span class="hljs-number">0</span>].length;

                <span class="hljs-keyword">for</span> (q = <span class="hljs-number">0</span>; q &lt; <span class="hljs-number">4</span>; q++) {

                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; cageLen; x++) {

                        cage[q][x] /= cageLen;
                    }
                }
                cagePointer = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (x = <span class="hljs-number">1</span>; x &lt; imageHeight; x++) {

                    rowPosX = rowPos + (x * <span class="hljs-number">4</span>);

                    <span class="hljs-keyword">for</span> (q = <span class="hljs-number">0</span>; q &lt; <span class="hljs-number">4</span>; q++) {

                        avgQ = avg[q];
                        cageQ = cage[q];
                        avgQ -= cageQ[cagePointer];

                        dataPointer = rowPosX + q;
                        pos = dataPointer + hLead;
                        pos = checkBounds(pos, len);
                        val = tempDataFrom[pos] / cageLen;

                        avgQ += val;
                        tempDataTo[dataPointer] = avgQ;
                        avg[q] = avgQ;
                        cageQ[cagePointer] = val;
                    }

                    cagePointer++;

                    <span class="hljs-keyword">if</span> (cagePointer === cageLen) cagePointer = <span class="hljs-number">0</span>;
                }
            };

            <span class="hljs-keyword">let</span> processRowNoAlpha = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row</span>) </span>{

                <span class="hljs-keyword">let</span> pos, val, x, xz, q, avgQ, cageQ, rowPosX,
                    avg = [],
                    hLead = radius * <span class="hljs-number">4</span>,
                    cage = [[], [], []],
                    rowPos = row * iWidth, 
                    dataPointer, cagePointer, cageLen;

                q = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (x = -radius * <span class="hljs-number">4</span>, xz = radius * <span class="hljs-number">4</span>; x &lt; xz; x++) {

                    <span class="hljs-keyword">if</span> (q &lt; <span class="hljs-number">3</span>) {

                        pos = rowPos + x;
                        pos = checkBounds(pos, len);
                        cage[q].push(tempDataFrom[pos]);
                        q++;
                    }
                    <span class="hljs-keyword">else</span> q = <span class="hljs-number">0</span>;
                }

                tempDataTo[rowPos] = avg[<span class="hljs-number">0</span>] = average(cage[<span class="hljs-number">0</span>]);
                tempDataTo[rowPos + <span class="hljs-number">1</span>] = avg[<span class="hljs-number">1</span>] = average(cage[<span class="hljs-number">1</span>]);
                tempDataTo[rowPos + <span class="hljs-number">2</span>] = avg[<span class="hljs-number">2</span>] = average(cage[<span class="hljs-number">2</span>]);

                cageLen = cage[<span class="hljs-number">0</span>].length;

                <span class="hljs-keyword">for</span> (q = <span class="hljs-number">0</span>; q &lt; <span class="hljs-number">3</span>; q++) {

                    cageQ = cage[q];
                    
                    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; cageLen; x++) {

                        cageQ[x] /= cageLen;
                    }
                }
                cagePointer = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (x = <span class="hljs-number">1</span>; x &lt; imageHeight; x++) {

                    rowPosX = rowPos + (x * <span class="hljs-number">4</span>);

                    <span class="hljs-keyword">for</span> (q = <span class="hljs-number">0</span>; q &lt; <span class="hljs-number">3</span>; q++) {

                        avgQ = avg[q];
                        cageQ = cage[q];
                        avgQ -= cageQ[cagePointer];

                        dataPointer = rowPosX + q;
                        pos = dataPointer + hLead;
                        pos = checkBounds(pos, len);
                        val = tempDataFrom[pos] / cageLen;

                        avgQ += val;
                        tempDataTo[dataPointer] = avgQ;
                        avg[q] = avgQ;
                        cageQ[cagePointer] = val;
                    }

                    cagePointer++;
                    <span class="hljs-keyword">if</span> (cagePointer === cageLen) cagePointer = <span class="hljs-number">0</span>;
                }
            };

            tempDataTo = data.slice();

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; passes; i++) {

                processPass();
                
                <span class="hljs-keyword">if</span> (shrink) {

                    radius = <span class="hljs-built_in">Math</span>.ceil(radius * <span class="hljs-number">0.3</span>);
                    radius = (radius &lt; <span class="hljs-number">1</span>) ? <span class="hljs-number">1</span> : radius;
                }
            }

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

                index = cache[i];
                data[index] = tempDataTo[index];
                
                index++;
                data[index] = tempDataTo[index];
                
                index++;
                data[index] = tempDataTo[index];
                
                <span class="hljs-keyword">if</span> (alpha) {

                    index++;
                    data[index] = tempDataTo[index];
                }
            }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><strong>matrix</strong> - apply a 3x3 matrix transform to each of the image’s pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    matrix: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, j, jz, pos, weight, sumR, sumG, sumB, sumA, homePos,
            len = data.length,
            alpha = filter.includeAlpha || <span class="hljs-literal">false</span>,
            offset = [],
            weights = filter.weights || [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],
            tempCache = [],
            cursor = <span class="hljs-number">0</span>;

        offset[<span class="hljs-number">0</span>] = -iWidth - <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">1</span>] = -iWidth;
        offset[<span class="hljs-number">2</span>] = -iWidth + <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">3</span>] = <span class="hljs-number">-4</span>;
        offset[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;
        offset[<span class="hljs-number">5</span>] = <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">6</span>] = iWidth - <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">7</span>] = iWidth;
        offset[<span class="hljs-number">8</span>] = iWidth + <span class="hljs-number">4</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            homePos = cache[i];
            sumR = sumG = sumB = sumA = <span class="hljs-number">0</span>;
            
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = offset.length; j &lt; jz; j++) {

                pos = homePos + offset[j];
                
                <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span> &amp;&amp; pos &lt; len) {

                    weight = weights[j];
                    sumR += data[pos] * weight;
                    
                    pos++;
                    sumG += data[pos] * weight;
                    
                    pos++;
                    sumB += data[pos] * weight;
                    
                    <span class="hljs-keyword">if</span> (alpha) {

                        pos++;
                        sumA += data[pos] * weight;
                    }
                }
            }

            tempCache[cursor] = sumR;
            cursor++;

            tempCache[cursor] = sumG;
            cursor++;

            tempCache[cursor] = sumB;
            cursor++;

            <span class="hljs-keyword">if</span> (alpha) {

                tempCache[cursor] = sumA;
                cursor++;
            }
        }

        cursor = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            homePos = cache[i];
            data[homePos] = tempCache[cursor];
            cursor++;

            homePos++;
            data[homePos] = tempCache[cursor];
            cursor++;

            homePos++;
            data[homePos] = tempCache[cursor];
            cursor++;

            <span class="hljs-keyword">if</span> (alpha) {

                homePos++;
                data[homePos] = tempCache[cursor];
                cursor++;
            }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><strong>matrix5</strong> - apply a 5x5 matrix transform to each of the image’s pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-attr">matrix5</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> i, iz, j, jz, pos, weight, sumR, sumG, sumB, sumA, homePos,
            len = data.length,
            alpha = filter.includeAlpha || <span class="hljs-literal">false</span>,
            offset = [],
            weights = filter.weights || [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],
            tempCache = [],
            iWidth2 = iWidth * <span class="hljs-number">2</span>,
            cursor = <span class="hljs-number">0</span>;

        offset[<span class="hljs-number">0</span>] = -iWidth2 - <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">1</span>] = -iWidth2 - <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">2</span>] = -iWidth2;
        offset[<span class="hljs-number">3</span>] = -iWidth2 + <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">4</span>] = -iWidth2 + <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">5</span>] = -iWidth - <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">6</span>] = -iWidth - <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">7</span>] = -iWidth;
        offset[<span class="hljs-number">8</span>] = -iWidth + <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">9</span>] = -iWidth + <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">10</span>] = <span class="hljs-number">-8</span>;
        offset[<span class="hljs-number">11</span>] = <span class="hljs-number">-4</span>;
        offset[<span class="hljs-number">12</span>] = <span class="hljs-number">0</span>;
        offset[<span class="hljs-number">13</span>] = <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">14</span>] = <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">15</span>] = iWidth - <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">16</span>] = iWidth - <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">17</span>] = iWidth;
        offset[<span class="hljs-number">18</span>] = iWidth + <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">19</span>] = iWidth + <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">20</span>] = iWidth2 - <span class="hljs-number">8</span>;
        offset[<span class="hljs-number">21</span>] = iWidth2 - <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">22</span>] = iWidth2;
        offset[<span class="hljs-number">23</span>] = iWidth2 + <span class="hljs-number">4</span>;
        offset[<span class="hljs-number">24</span>] = iWidth2 + <span class="hljs-number">8</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            homePos = cache[i];
            sumR = sumG = sumB = sumA = <span class="hljs-number">0</span>;
            
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = offset.length; j &lt; jz; j++) {

                pos = homePos + offset[j];
                
                <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span> &amp;&amp; pos &lt; len) {

                    weight = weights[j];
                    sumR += data[pos] * weight;

                    pos++;
                    sumG += data[pos] * weight;

                    pos++;
                    sumB += data[pos] * weight;

                    <span class="hljs-keyword">if</span> (alpha) {

                        pos++;
                        sumA += data[pos] * weight;
                    }
                }
            }

            tempCache[cursor] = sumR;
            cursor++;

            tempCache[cursor] = sumG;
            cursor++;

            tempCache[cursor] = sumB;
            cursor++;

            <span class="hljs-keyword">if</span> (alpha) {

                tempCache[cursor] = sumA;
                cursor++;
            }
        }

        cursor = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = cache.length; i &lt; iz; i++) {

            homePos = cache[i];
            data[homePos] = tempCache[cursor];
            cursor++;

            homePos++;
            data[homePos] = tempCache[cursor];
            cursor++;

            homePos++;
            data[homePos] = tempCache[cursor];
            cursor++;

            <span class="hljs-keyword">if</span> (alpha) {
                
                homePos++;
                data[homePos] = tempCache[cursor];
                cursor++;
            }
        }
    },
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
