<!DOCTYPE html>

<html>
<head>
  <title>Position mixin</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter-stringed.html">
                  ./source/worker/filter-stringed.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
                
                <a class="source" href="../worker/filter_canvas.html">
                  ./source/worker/filter_canvas.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="position-mixin">Position mixin</h1>
<p>This mixin defines the key attributes and functionality of Scrawl-canvas <strong>artefact objects</strong>. </p>
<p>We define an artefact as something that can be displayed in a Scrawl-canvas <a href="../factory/stack.html">Canvas</a> or <a href="../factory/stack.html">Stack</a> wrapper - both of which wrap DOM elements in the web page document - &lt;canvas&gt;, and other DOM elements (most commonly a &lt;div&gt; element), respectively.</p>
<ul>
<li>We call canvas based artefacts <strong>entity objects</strong> - these objects represent a shape, path or image drawn in the canvas. </li>
<li>Entitys include: <a href="../factory/block.html">Block</a>; <a href="../factory/grid.html">Grid</a>; <a href="../factory/loom.html">Loom</a>; <a href="../factory/phrase.html">Phrase</a> for text; <a href="../factory/picture.html">Picture</a> for images, videos, etc; <a href="../factory/shape.html">Shape</a>s of various types; and <a href="../factory/wheel.html">Wheel</a>.</li>
<li><strong>Other artefacts</strong> live in stack containers. They include nested Stack wrappers, Canvas wrappers (which can exist outside of a stack); and <a href="../factory/element.html">Element</a> wrappers for other direct child elements.</li>
</ul>
<h5 id="positioning">Positioning</h5>
<p>Artefacts break away from the normal flow mechanisms of the HTML document; instead they are explicitly positioned within their containers in a variety of ways:</p>
<ul>
<li><strong>absolute</strong> positioning - where we give the artefact a coordinate, measured in pixels from the top left corner of the container (<code>[0, 0]</code>, <code>[347, 26.4]</code>, etc). </li>
<li><strong>relative</strong> positioning - where we supply the artefact with percentage coordinates, with <code>[&#39;0%&#39;, &#39;0%&#39;]</code> representing the top left corner of the container, and <code>[&#39;100%&#39;, &#39;100%&#39;]</code> its bottom right corner.</li>
<li><strong>reference</strong> positioning - this is where an artefact will use another artefact’s <strong><em>current</em></strong> (not given) coordinate to determine its own position. We can reference by <code>pivot</code>, or by <code>mimic</code>, or by <code>path</code>.</li>
</ul>
<p>Scrawl-canvas uses <a href="../factory/coordinate.html">Coordinate Arrays</a> - <code>[x, y]</code> - for storing artefact coordinates. The <strong><em>Javascript types</em></strong> of the <code>x</code> and <code>y</code> parts of the coordinate can be either Numbers or Strings, and do not need to match each other: <code>[&#39;5%&#39;, 20]</code> and <code>[10, &#39;15.4%&#39;]</code> are as valid as <code>[10, 20]</code> and <code>[&#39;5%&#39;, &#39;15.4%&#39;]</code>.</p>
<h5 id="the-artefact-rotation-reflection-point">The artefact ‘rotation-reflection’ point</h5>
<p>Every artefact has a <strong>start</strong> coordinate which, by default, is set at the artefact’s top-left corner - even for Wheels and Shapes! </p>
<ul>
<li>When we rotate an artefact, we rotate it around this coordinate. When we <strong><em>flip</em></strong> entity artefacts, we flip them around the artefact’s local horizontal or vertical axis drawn through this coordinate. </li>
<li>Thus what we call a ‘start’ coordinate is in fact the artefact’s <strong>Rotation-Reflection</strong> point.</li>
</ul>
<p>The R-R point does not need to be at the artefact’s top-left corner. We can move it by giving the artefact a <strong>handle</strong> coordinate - a distance measured from the artefact’s top-left corner. Just as for the start coordinate, we can set the handle coordinate using absolute, relative or reference values:</p>
<ul>
<li><strong>absolute</strong> handles - where we give the artefact a distance, measured in pixels from its top left corner . </li>
<li><strong>relative</strong> handles - where we supply the artefact with percentage distances measured against the artefact’s own dimensions.</li>
<li><strong>reference</strong> handles.</li>
<li>In all cases, <strong><em>the distancing effect is along the artefact’s local horizontal and vertical axes</em></strong> - if the artefact is rotated, then those axes will not be perpendicular to the containing Canvas or Stack axes.</li>
</ul>
<p>Normally this is enough information to position an artefact in its container. However there may be times when we need to move the artefact’s R-R point a given distance along the container axes. We can achieve this by giving the artefact an <strong>offset</strong> coordinate.</p>
<ul>
<li><strong>absolute</strong> offsets - where we give the artefact a distance, measured in pixels from its top left corner. </li>
<li><strong>relative</strong> offsets - where we supply the artefact with percentage distances measured against the <strong><em>container’s dimensions</em></strong>.</li>
<li><strong>reference</strong> offsets.</li>
</ul>
<p>An artefact can have both a handle and an offset; handle distances move the R-R point along the artefact’s axes (which may be diagonal lines), while offsets move it along the container’s axes.</p>
<h5 id="artefact-dimensions">Artefact dimensions</h5>
<p>Another use for Coordinate Arrays is to <strong>set the artefact’s dimensions - their width and height values</strong>. In this case we can think of the coordinate in terms of <code>[w, h]</code>. All artefacts, except Shape and Loom entitys, require dimension data.</p>
<p>Just as for positioning data, an artefact’s dimensions data can be supplied in absolute, relative or reference terms:</p>
<ul>
<li><strong>absolute</strong> dimensions - where we give the artefact a width and height, measured in pixels from its top left corner. </li>
<li><strong>relative</strong> dimensions - where we supply the artefact with percentage widths and height values, measured against the <strong><em>container’s dimensions</em></strong>.</li>
<li><strong>reference</strong> dimensions.</li>
</ul>
<h5 id="artefact-pseudo-attributes">Artefact pseudo-attributes</h5>
<p>Scrawl-canvas uses the following pseudo-attributes to make working with Coordinates easier:</p>
<ul>
<li><strong>startX</strong> and <strong>startY</strong> - for getting and setting the <code>start</code> (R-R) Coordinate values</li>
<li><strong>handleX</strong> and <strong>handleY</strong> - for getting and setting the <code>handle</code> Coordinate values</li>
<li><strong>offsetX</strong> and <strong>offsetY</strong> - for getting and setting the <code>offset</code> Coordinate values</li>
<li><strong>width</strong> and <strong>height</strong> - for getting and setting the <code>dimensions</code> Coordinate values</li>
</ul>
<p>Scrawl-canvas also supports the following <strong><em>pseudo-values</em></strong>, which can be used when setting <strong>relative</strong> coordinates:</p>
<ul>
<li><code>[&#39;left&#39;, &#39;top&#39;]</code> == <code>[&#39;0%&#39;, &#39;0%&#39;]</code></li>
<li><code>[&#39;center&#39;, &#39;center&#39;]</code> == <code>[&#39;50%&#39;, &#39;50%&#39;]</code></li>
<li><code>[&#39;bottom&#39;, &#39;right&#39;]</code> == <code>[&#39;100%&#39;, &#39;100%&#39;]</code></li>
</ul>
<pre><code><span class="hljs-comment">// The following code creates a block entity</span>
<span class="hljs-comment">// - half the width and height of its canvas</span>
<span class="hljs-comment">// - positioned in the middle of the canvas:</span>
scrawl.makeBlock({

    <span class="hljs-attr">name</span>: <span class="hljs-string">'my-block'</span>,

    <span class="hljs-attr">startX</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-string">'center'</span>,

    <span class="hljs-attr">handleX</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">handleY</span>: <span class="hljs-string">'center'</span>,

    <span class="hljs-attr">width</span>: <span class="hljs-string">'50%'</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-string">'50%'</span>,

    <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'blue'</span>,
    <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'red'</span>,

    <span class="hljs-attr">method</span>: <span class="hljs-string">'fillThenDraw'</span>,
});</code></pre>
<h5 id="referencing-other-artefacts">Referencing other artefacts</h5>
<p>Scrawl-canvas allows an artefact to reference other artefacts. The referenced objects supply data back to the first artefact, which it then uses to update its position and dimensions. </p>
<ul>
<li>This all happens automatically once the reference is set up, with updates occuring as part of the Scrawl-canvas <strong>Display cycle</strong>.</li>
<li>To move a group of artefacts as a single unit, we can set up one as the reference artefact, with the rest using handles and offsets to supply distancing data from the reference. Updates to the reference artefact will now be transmitted automatically to all artefacts using it as their <code>pivot</code> or <code>mimic</code>.</li>
</ul>
<p>We <strong>create a reference</strong> by setting the value of one or more of the following attributes to a reference artefact’s name-String, or to the object itself:</p>
<ul>
<li><code>pivot</code> - once set, we can then use the referenced artefact’s <strong>start</strong> coordinate as this artefact’s start value. With appropriate flags set, we can add this artefact’s <strong>handle</strong> and <strong>offset</strong> coordinates to the start value.</li>
<li><code>mimic</code> - extends the ‘pivot’ concept to include dimensions, alongside adding this artefact’s data to the referenced artefact’s data in various ways.</li>
<li><code>path</code> - use a Shape entity’s path to determine this artefact’s position and rotation values.</li>
</ul>
<p>We <strong>action a reference</strong> by setting this artefact’s <code>lockTo</code> Array attribute. Ther lock array is similar to coordinate Arrays: it is a two-element array of Strings in the form <code>[x-lock, y-lock]</code>. Five lock strings are supported:</p>
<ul>
<li><code>start</code> - use this artefact’s own start (and other) values</li>
<li><code>pivot</code> - use the pivot reference artefact’s start (and other) values</li>
<li><code>mimic</code> - use the mimic reference artefact’s start (and other) values</li>
<li><code>path</code> - use the Shape entity’s path to calculate this artefact’s start (and rotation) values</li>
<li><code>mouse</code> - use the mouse/touch cursor’s current position as the reference for this artefact’s start value</li>
</ul>
<p>The <strong>lockTo</strong> Array supports the pseudo-attributes <strong>lockXTo</strong> and <strong>lockYTo</strong> to make working with it easier.</p>
<ul>
<li>Setting <code>lockTo</code> sets both elements of the Array to the supplied String</li>
<li><code>lockXTo</code> and <code>lockYTo</code> allow us to separate the x and y coordinates</li>
</ul>
<p>For instance if we set the lock to <code>[&#39;start&#39;, &#39;mouse&#39;]</code> we can make the artefact track the mouse across the container along an (invisible) vertical line, whose position is determined by the artefact’s x coordinate value.</p>
<h5 id="artefact-rotation">Artefact rotation</h5>
<p>Scrawl-canvas artefacts can be rotated around their <strong>Rotation-Reflection point</strong>: </p>
<ul>
<li>Entity artefacts, being representations of 2-dimensional graphical shapes drawn on a &lt;canvas&gt; element, are restricted to rotating around the R-R point’s <strong><em>z-axis</em></strong>.</li>
<li>Other artefacts, when part of a Stack container, can be rotated in 3 dimensions along the R-R point’s <strong><em>x-axis</em></strong>, <strong><em>y-axis</em></strong> and <strong><em>z-axis</em></strong>.</li>
</ul>
<p>Scrawl canvas measures rotations in <strong>degrees</strong>, not radians. An artefact’s rotation values are stored in the following attributes:</p>
<ul>
<li><strong>roll</strong> - for <code>z-axis</code> rotations</li>
<li><strong>yaw</strong> - for <code>y-axis</code> rotations</li>
<li><strong>pitch</strong> - for <code>x-axis</code> rotations</li>
</ul>
<p>These <strong>euler</strong> attributes are named after the <a href="https://en.wikipedia.org/wiki/Aircraft_principal_axes">Aircraft principal axes</a> - mainly because I find it difficult to keep the mathematical representations in my head when thinking about rotations in 3 dimensions, but an image of an aircraft is a lot easier to visualize.</p>
<ul>
<li>Internally, Scrawl-canvas stores rotational data in <a href="../factory/quaternion.html">Quaternion objects</a> rather than in matrices. </li>
</ul>
<p>Instead of 3D rotations, entity artefacts have two Boolean flags - <strong>flipReverse</strong>, <strong>flipUpend</strong> - which determine the orientation of the entity when it stamps itself on the display. </p>
<ul>
<li>a <code>reversed</code> entity is effectively flipped 180&deg; around a vertical line passing through that entity’s rotation-reflection (start) point - a face looking to the right will now look to the left</li>
<li>an <code>upended</code> entity is effectively flipped 180&deg; around a horizontal line passing through that entity’s rotation-reflection (start) point - a normal face will now appear upside-down</li>
</ul>
<p>We can <strong><em>emulate 3D rotations for Picture entity artefacts</em></strong> using the <a href="../factory/loom.html">Loom entity</a> - see Demo <a href="../../demo/dom-015.html">DOM-015</a> for an example of this in action.</p>
<h5 id="collision-detection">Collision detection</h5>
<p>Collision detection functionality - beyond mouse drag-and-drop - has been removed from Scrawl-canvas since v8.2.0</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { artefact, group, tween } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/library.js'</span>;
<span class="hljs-keyword">import</span> { λ<span class="hljs-literal">null</span>, mergeOver, isa_obj, xt, xta, xto, xtGet, addStrings, pushUnique } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/utilities.js'</span>;
<span class="hljs-keyword">import</span> { currentCorePosition } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/userInteraction.js'</span>;

<span class="hljs-keyword">import</span> { makeCoordinate } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/coordinate.js'</span>;
<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/cell.js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="export-function">Export function</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">P = {}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="shared-attributes">Shared attributes</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>group</strong> - every Scrawl-canvas artefact should belong to at least one Group, and can belong to more than one Group. Groups can be used for a variety of purposes, and play a major role in the <strong>Display cycle</strong> and in <strong>collision detection</strong>.</p>
<ul>
<li>Most group-related functionality takes place elsewhere. An artefact’s <code>group</code> attribute is used mainly as a ‘convenience handle’, to make moving an artefact from one Group to another a bit easier.</li>
<li>As part of an artefact’s initialization, the code will assign the artefact to a Group. We can indicate which Group to assign the new artefact to by setting the argument attribute to the Group’s name attribute String, or to the Group itself - the set code will automatically update this attribute to a reference to the Group object:</li>
</ul>
<pre><code><span class="hljs-keyword">let</span> myGroup = scrawl.buildGroup({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'my-first-group'</span>,
});

<span class="hljs-keyword">let</span> myBlock = scrawl.makeBlock({
    <span class="hljs-attr">group</span>: myGroup,
});</code></pre>
<ul>
<li>Similarly the <strong>set</strong> function’s object argument can accept a name String, or the new group’s object itself:</li>
</ul>
<pre><code>myBlock.set({
    <span class="hljs-attr">group</span>: <span class="hljs-string">'my-first-group'</span>,
});</code></pre>
<ul>
<li>If no group value is supplied when building a new <strong>entity</strong>, then the <strong><em>current group</em></strong> will be assigned as the entity’s group. This is a Scrawl-canvas ‘global’ value which will update whenever the user sets a Canvas wrapper as the current canvas:</li>
</ul>
<pre><code>scrawl.setCurrentCanvas(<span class="hljs-string">'my-other-canvas'</span>);</code></pre>
<ul>
<li>For some Canvas and Stack wrappers, the value of their group attribute will be set to <code>root</code> - this indicates that the wrapper’s DOM element is not contained within another Stack.</li>
<li>TODO: we need to decide whether we want a user-available scrawl.setCurrentStack function and, if yes, how that will impact on the core/document.js <strong>currentGroup</strong> variable exported by that module - given that we will then have both currentStack and currentCanvas variables, but only one currentGroup variable shared between them.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        group: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The <strong>visibility</strong> attribute is a boolean flag (default: true); when the flag is set, the Display cycle functionality will run on the artefact. If the attribute’s value is false, then the Display cycle functionality will ignore the artefact. This has the following effects:</p>
<ul>
<li>for DOM-based artefacts, the dom element will have its CSS tweaked to hide the element (<code>display: block</code> switches to <code>display: none</code>).</li>
<li>for canvas-based entitys, the entity will be ignored during the Display cycle’s <code>compile</code> step’s Promise cascade.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        visibility: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <strong>order</strong> attribute - an integer Number (default: 0) - determines the order in which an artefact will be processed as part of a Group. </p>
<ul>
<li>For instance, entity artefacts with higher order values will be processed after those with lower values, with the effect that the entity will be displayed on top of those other entitys (and stamping over them if they overlap)</li>
<li>Note that Group objects also have an order attribute: all artefacts in a Group with a lower order value will be processed before those with a higher order value.</li>
<li>Cell wrappers (a Canvas wrapper can have more than one Cell) have a <code>compileOrder</code> attribute which does the same job.</li>
<li>Finally, Animation objects have order values; the same effect applies.</li>
<li><strong><em>If the display of an artefact does not appear to be following the order value it has been given</em></strong>, the problem may lie in either the order values assigned to that artefact’s Group, or host (Cell, Canvas, Stack), or even the Animation object that contributes to the Display cycle.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        order: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The <strong>start</strong> attribute represents an artefact’s <strong><em>Rotation-Reflexion point</em></strong>, and is held in an <code>[x, y]</code> Coordinate Array. The default values are <code>[0, 0]</code>, placing the artifact at the container object’s (Cell, Stack) top-left corner.</p>
<pre><code><span class="hljs-keyword">let</span> myBlock = scrawl.makeBlock({
    <span class="hljs-attr">startX</span>: <span class="hljs-number">20</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-string">'center'</span>,
});

myBlock.set({
    <span class="hljs-attr">start</span>: [<span class="hljs-number">-100</span>, <span class="hljs-string">'-12%'</span>],
});

myBlock.set({
    <span class="hljs-attr">start</span>: {
        <span class="hljs-attr">x</span>: <span class="hljs-string">'left'</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">388.5</span>,
    },
});

<span class="hljs-comment">// Don't use string labels ('top', 'left', etc) when delta setting</span>
myBlock.setDelta({
    <span class="hljs-attr">startX</span>: <span class="hljs-string">'-0.05%'</span>,
});

myBlock.setDelta({
    <span class="hljs-attr">start</span>: [<span class="hljs-number">1</span>, <span class="hljs-string">'0.5%'</span>],
});</code></pre>
<ul>
<li>Start values DO NOT respect the artefact’s <code>scale</code> attribute.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        start: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The <strong>handle</strong> attribute represents a distance from the artefact’s <strong><em>Rotation-Reflexion</em></strong> point, measured along the <strong><em>artefact’s local axes</em></strong>. It is held in an <code>[x, y]</code> Coordinate Array. The default values are <code>[0, 0]</code>.</p>
<ul>
<li>Handle values WILL respect the artefact’s <code>scale</code> attribute.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        handle: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The <strong>offset</strong> attribute represents an offset from the artefact’s <strong><em>Rotation-Reflexion</em></strong> point, measured along the <strong><em>container’s axes</em></strong>. It is held in an <code>[x, y]</code> Coordinate Array. The default values are <code>[0, 0]</code>.</p>
<ul>
<li>Offset values DO NOT respect the artefact’s <strong>scale</strong> attribute.</li>
<li>the <em>pseudo-values</em> <code>top</code>, <code>center</code>, etc have no meaning in the context of offsets.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        offset: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The <strong>dimensions</strong> attribute represents the artefact’s <strong>width</strong> and <strong>height</strong>. It is held in a <code>[w, h]</code> Coordinate Array. The default values vary between different types of artefact.</p>
<ul>
<li>Dimensions values WILL respect the artefact’s <code>scale</code> attribute.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dimensions: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>pivoted</strong> - internal Array holding details of the artefacts using this artefact as their pivot reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pivoted: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong>mimicked</strong> - internal Array holding details of the artefacts using this artefact as their mimic reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        mimicked: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong>lockTo</strong> - <code>[x-lock, y-lock]</code> Array; locks can be set to: <code>start</code> (the default), <code>pivot</code>, <code>path</code>, <code>mimic</code>, or <code>mouse</code>.</p>
<ul>
<li>The lock values can be set individually using the pseudo-attributes <strong>lockXTo</strong> and <strong>lockYTo</strong>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        lockTo: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>All artefacts (except compound entities such as Loom) can be scaled by setting their <strong>scale</strong> attribute to an appropriate float Number value:</p>
<ul>
<li>A value of <strong>0</strong> effectively makes the artefact disappear from the display (though setting the artefact’s <strong>visibility</strong> flag to false is a more efficient approach).</li>
<li>Scale value <strong>less than 1</strong> will shrink the artefact around its rotation-reflection point.</li>
<li>Setting the value to <strong>1</strong> (the default) removes all scaling effects on the artefact.</li>
<li>Values <strong>greater than 1</strong> will expand the artefact around its rotation-reflection point.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scale: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong>roll</strong> - float Number representing the artefact’s rotation around the <code>z-axis</code> of its <strong><em>Rotation-Reflection point</em></strong>.</p>
<ul>
<li>values represent <strong><em>degrees</em></strong>, not radians.</li>
<li>Some effort is made in the code to keep this value within the bounds of <code>-360</code> and <code>+360</code>. Value is measured in degrees (not radians!)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        roll: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h5 id="animation-speed">Animation speed</h5>
<p>Scrawl-canvas assumes that an artefact will be <em>ready for anything</em>. However if we know beforehand that an artefact will not be requiring certain functionalities, we can switch them off; this will help make the artefact render more quickly. These <strong>noXXX</strong> flags include:</p>
<ul>
<li><p><strong>noUserInteraction</strong> - switch off basic collision functionality (used by ‘drag-and-drop’) and ongoing update calculations.</p>
</li>
<li><p><strong>noPositionDependencies</strong> - short-circuit the position calculations associated with pivot, mimic, path and mouse positioning.</p>
</li>
<li><p><strong>noCanvasEngineUpdates</strong> - specifically for canvas entity artefacts, skip updating the host Cell wrapper’s CanvasRenderingContext2D engine with the entity’s <a href="../factory/state.html">State</a> attributes - meaning that the entity will use the previously stamped entity’s State values.</p>
</li>
<li><p><strong>noFilters</strong> - skip the checks for, and application of, <a href="../factory/filter.html">Filters</a> to the entity artefact - even if filters have been added to the entity.</p>
</li>
<li><p><strong>noPathUpdates</strong> - only calculate the artefact’s path once - this disables updates to the artefact’s handle and scale attributes.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        noUserInteraction: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">noPositionDependencies</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">noCanvasEngineUpdates</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">noFilters</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">noPathUpdates</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong>purge</strong> - ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        purge: <span class="hljs-literal">null</span>,
    };
    P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">'pathObject'</span>, <span class="hljs-string">'mimicked'</span>, <span class="hljs-string">'pivoted'</span>]);
    P.packetExclusionsByRegex = pushUnique(P.packetExclusionsByRegex, [<span class="hljs-string">'^(local|dirty|current)'</span>, <span class="hljs-string">'Subscriber$'</span>]);
    P.packetCoordinates = pushUnique(P.packetCoordinates, [<span class="hljs-string">'start'</span>, <span class="hljs-string">'handle'</span>, <span class="hljs-string">'offset'</span>]);
    P.packetObjects = pushUnique(P.packetObjects, [<span class="hljs-string">'group'</span>]);
    P.packetFunctions = pushUnique(P.packetFunctions, []);

    P.processPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">switch</span> (key) {

            <span class="hljs-keyword">case</span> <span class="hljs-string">'lockTo'</span> :

                <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] === <span class="hljs-string">'start'</span> &amp;&amp; value[<span class="hljs-number">1</span>] === <span class="hljs-string">'start'</span>) {

                    result = (includes.indexOf(<span class="hljs-string">'lockTo'</span>) &gt;= <span class="hljs-number">0</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">default</span> :

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lib === <span class="hljs-string">'entity'</span>) result = <span class="hljs-keyword">this</span>.processEntityPacketOut(key, value, includes);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isArtefact) result = <span class="hljs-keyword">this</span>.processDOMPacketOut(key, value, includes);
        }

        <span class="hljs-keyword">return</span> result;
    };

    P.handlePacketAnchor = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.anchor) {

            <span class="hljs-keyword">let</span> a = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.anchor.saveAsPacket(items))[<span class="hljs-number">3</span>];
            copy.anchor = a;
        }
        <span class="hljs-keyword">return</span> copy;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>
<p>No additional clone functionality defined here</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.kill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> myname = <span class="hljs-keyword">this</span>.name</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Remove artefact from all groups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">Object</span>.entries(group).forEach(<span class="hljs-function">(<span class="hljs-params">[name, grp]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (grp.artefacts.indexOf(myname) &gt;= <span class="hljs-number">0</span>) grp.removeArtefacts(myname);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>If the artefact has an anchor, it needs to be removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.anchor) <span class="hljs-keyword">this</span>.demolishAnchor();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Remove from other artefacts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">Object</span>.entries(artefact).forEach(<span class="hljs-function">(<span class="hljs-params">[name, art]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (art.name !== myname) {

                <span class="hljs-keyword">if</span> (art.pivot &amp;&amp; art.pivot.name === myname) art.set({ <span class="hljs-attr">pivot</span>: <span class="hljs-literal">false</span>});
                <span class="hljs-keyword">if</span> (art.mimic &amp;&amp; art.mimic.name === myname) art.set({ <span class="hljs-attr">mimic</span>: <span class="hljs-literal">false</span>});
                <span class="hljs-keyword">if</span> (art.path &amp;&amp; art.path.name === myname) art.set({ <span class="hljs-attr">path</span>: <span class="hljs-literal">false</span>});

                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(art.pins)) {

                	art.pins.forEach(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {

                		<span class="hljs-keyword">if</span> (isa_obj(item) &amp;&amp; item.name === myname) art.removePinAt(index);
                	});
                }
            }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Remove from tweens and actions targets arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">Object</span>.entries(tween).forEach(<span class="hljs-function">(<span class="hljs-params">[name, t]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (t.checkForTarget(myname)) t.removeFromTargets(<span class="hljs-keyword">this</span>);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Factory-specific actions required to complete the kill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.factoryKill();</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Remove artefact from the Scrawl-canvas library</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.deregister();
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Specific factories can overwrite this function to perform additional actions required to clean themselves from the Scrawl-canvas system</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.factoryKill = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>
<ul>
<li>The getter functions return the <strong>current, pixel-based values</strong> for the <code>start</code>, <code>handle</code>, <code>offset</code> and <code>dimensions</code> attribute Coordinates.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> G = P.getters,
        S = P.setters,
        D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><strong>start</strong>, <strong>startX</strong>, <strong>startY</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    G.startX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentStart[<span class="hljs-number">0</span>];
    };
    G.startY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentStart[<span class="hljs-number">1</span>];
    };
    G.start = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> [].concat(<span class="hljs-keyword">this</span>.currentStart);
    };
    S.startX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.start[<span class="hljs-number">0</span>] = coord;
            <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        }
    };
    S.startY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.start[<span class="hljs-number">1</span>] = coord;
            <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        }
    };
    S.start = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

        <span class="hljs-keyword">this</span>.setCoordinateHelper(<span class="hljs-string">'start'</span>, x, y);
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
    };
    D.startX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.start;
        c[<span class="hljs-number">0</span>] = addStrings(c[<span class="hljs-number">0</span>], coord);
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
    };
    D.startY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.start;
        c[<span class="hljs-number">1</span>] = addStrings(c[<span class="hljs-number">1</span>], coord);
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
    };
    D.start = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

        <span class="hljs-keyword">this</span>.setDeltaCoordinateHelper(<span class="hljs-string">'start'</span>, x, y);
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><strong>handle</strong>, <strong>handleX</strong>, <strong>handleY</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    G.handleX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHandle[<span class="hljs-number">0</span>];
    };
    G.handleY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHandle[<span class="hljs-number">1</span>];
    };
    G.handle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> [].concat(<span class="hljs-keyword">this</span>.currentHandle);
    };
    S.handleX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.handle[<span class="hljs-number">0</span>] = coord;
            <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
        }
    };
    S.handleY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.handle[<span class="hljs-number">1</span>] = coord;
            <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
        }
    };
    S.handle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

        <span class="hljs-keyword">this</span>.setCoordinateHelper(<span class="hljs-string">'handle'</span>, x, y);
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    };
    D.handleX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.handle;
        c[<span class="hljs-number">0</span>] = addStrings(c[<span class="hljs-number">0</span>], coord);
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    };
    D.handleY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.handle;
        c[<span class="hljs-number">1</span>] = addStrings(c[<span class="hljs-number">1</span>], coord);
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    };
    D.handle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

        <span class="hljs-keyword">this</span>.setDeltaCoordinateHelper(<span class="hljs-string">'handle'</span>, x, y);
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><strong>offset</strong>, <strong>offsetX</strong>, <strong>offsetY</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    G.offsetX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentOffset[<span class="hljs-number">0</span>];
    };
    G.offsetY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentOffset[<span class="hljs-number">1</span>];
    };
    G.offset = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> [].concat(<span class="hljs-keyword">this</span>.currentOffset);
    };
    S.offsetX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.offset[<span class="hljs-number">0</span>] = coord;
            <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
        }
    };
    S.offsetY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.offset[<span class="hljs-number">1</span>] = coord;
            <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
        }
    };
    S.offset = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

        <span class="hljs-keyword">this</span>.setCoordinateHelper(<span class="hljs-string">'offset'</span>, x, y);
        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
    };
    D.offsetX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.offset;
        c[<span class="hljs-number">0</span>] = addStrings(c[<span class="hljs-number">0</span>], coord);
        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
    };
    D.offsetY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.offset;
        c[<span class="hljs-number">1</span>] = addStrings(c[<span class="hljs-number">1</span>], coord);
        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
    };
    D.offset = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

        <span class="hljs-keyword">this</span>.setDeltaCoordinateHelper(<span class="hljs-string">'offset'</span>, x, y);
        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><strong>dimensions</strong>, <strong>width</strong>, <strong>height</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    G.width = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentDimensions[<span class="hljs-number">0</span>];
    };
    G.height = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentDimensions[<span class="hljs-number">1</span>];
    };
    G.dimensions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> [].concat(<span class="hljs-keyword">this</span>.currentDimensions);
    };
    S.width = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{

        <span class="hljs-keyword">if</span> (val != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.dimensions[<span class="hljs-number">0</span>] = val;
            <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        }
    };
    S.height = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{

        <span class="hljs-keyword">if</span> (val != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">this</span>.dimensions[<span class="hljs-number">1</span>] = val;
            <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        }
    };
    S.dimensions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">w, h</span>) </span>{

        <span class="hljs-keyword">this</span>.setCoordinateHelper(<span class="hljs-string">'dimensions'</span>, w, h);
        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    };
    D.width = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.dimensions;
        c[<span class="hljs-number">0</span>] = addStrings(c[<span class="hljs-number">0</span>], val);
        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    };
    D.height = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.dimensions;
        c[<span class="hljs-number">1</span>] = addStrings(c[<span class="hljs-number">1</span>], val);
        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    };
    D.dimensions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">w, h</span>) </span>{

        <span class="hljs-keyword">this</span>.setDeltaCoordinateHelper(<span class="hljs-string">'dimensions'</span>, w, h);
        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><strong>lockXTo</strong>, <strong>lockYTo</strong>, <strong>lockTo</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.lockTo = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(item)) {

            <span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">0</span>] = item[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">1</span>] = item[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">0</span>] = item;
            <span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">1</span>] = item;
        }
        <span class="hljs-keyword">this</span>.dirtyLock = <span class="hljs-literal">true</span>;
    };
    S.lockXTo = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">0</span>] = item;
        <span class="hljs-keyword">this</span>.dirtyLock = <span class="hljs-literal">true</span>;
    };
    S.lockYTo = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">1</span>] = item;
        <span class="hljs-keyword">this</span>.dirtyLock = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><strong>roll</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.roll = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.roll = item;
        <span class="hljs-keyword">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };
    D.roll = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.roll += item;
        <span class="hljs-keyword">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><strong>scale</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.scale = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.scale = item;
        <span class="hljs-keyword">this</span>.dirtyScale = <span class="hljs-literal">true</span>;
    };
    D.scale = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.scale += item;
        <span class="hljs-keyword">this</span>.dirtyScale = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><strong>host</strong> - internal function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.host = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item) {

            <span class="hljs-keyword">let</span> host = artefact[item];

            <span class="hljs-keyword">if</span> (host &amp;&amp; host.here) <span class="hljs-keyword">this</span>.host = host.name;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.host = item;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.host = <span class="hljs-string">''</span>;

        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p><strong>group</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">let</span> g;

        <span class="hljs-keyword">if</span> (item) {

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.group &amp;&amp; <span class="hljs-keyword">this</span>.group.type === <span class="hljs-string">'Group'</span>) <span class="hljs-keyword">this</span>.group.removeArtefacts(<span class="hljs-keyword">this</span>.name);

            <span class="hljs-keyword">if</span> (item.substring) {

                g = group[item];

                <span class="hljs-keyword">if</span> (g) <span class="hljs-keyword">this</span>.group = g;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.group = item;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.group = item;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.group &amp;&amp; <span class="hljs-keyword">this</span>.group.type === <span class="hljs-string">'Group'</span>) <span class="hljs-keyword">this</span>.group.addArtefacts(<span class="hljs-keyword">this</span>.name);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><code>purgeArtefact</code> - Artefact objects gather many attributes during their creation. Many of these may not be subsequentlyt used - for instance, if the artefact is never going to mimic another artefact, then it doesn’t need all the attributes and flags associated with mimic functionality. In such cases, we can purge the artefact object of those attributes to free up a tiny bit of extra memory</p>
<ul>
<li>Argument can be a string of value <code>pivot</code>, <code>mimic</code>, <code>path</code>, <code>filter</code>, or an array of such strings.</li>
<li>Passing the argument <code>all</code> will purge all attributes listed in the <code>doPurge</code> internal function.</li>
<li>Clone functionality - include items to be purged</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.purgeArtefact = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    	<span class="hljs-keyword">const</span> doPurge = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">art, val</span>) </span>{

    		<span class="hljs-keyword">switch</span> (val) {

    			<span class="hljs-keyword">case</span> <span class="hljs-string">'pivot'</span> :
                    <span class="hljs-keyword">delete</span> art.pivot;
                    <span class="hljs-keyword">delete</span> art.pivotCorner;
                    <span class="hljs-keyword">delete</span> art.pivotPin;
                    <span class="hljs-keyword">delete</span> art.addPivotHandle;
                    <span class="hljs-keyword">delete</span> art.addPivotOffset;
                    <span class="hljs-keyword">delete</span> art.addPivotRotation;
    				<span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'mimic'</span> :
                    <span class="hljs-keyword">delete</span> art.mimic;
                    <span class="hljs-keyword">delete</span> art.useMimicDimensions;
                    <span class="hljs-keyword">delete</span> art.useMimicScale;
                    <span class="hljs-keyword">delete</span> art.useMimicStart;
                    <span class="hljs-keyword">delete</span> art.useMimicHandle;
                    <span class="hljs-keyword">delete</span> art.useMimicOffset;
                    <span class="hljs-keyword">delete</span> art.useMimicRotation;
                    <span class="hljs-keyword">delete</span> art.useMimicFlip;
                    <span class="hljs-keyword">delete</span> art.addOwnDimensionsToMimic;
                    <span class="hljs-keyword">delete</span> art.addOwnScaleToMimic;
                    <span class="hljs-keyword">delete</span> art.addOwnStartToMimic;
                    <span class="hljs-keyword">delete</span> art.addOwnHandleToMimic;
                    <span class="hljs-keyword">delete</span> art.addOwnOffsetToMimic;
                    <span class="hljs-keyword">delete</span> art.addOwnRotationToMimic;
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'path'</span> :
                    <span class="hljs-keyword">delete</span> art.path;
                    <span class="hljs-keyword">delete</span> art.pathPosition;
                    <span class="hljs-keyword">delete</span> art.addPathHandle;
                    <span class="hljs-keyword">delete</span> art.addPathOffset;
                    <span class="hljs-keyword">delete</span> art.addPathRotation;
                    <span class="hljs-keyword">delete</span> art.constantPathSpeed;
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'filter'</span> :
                    <span class="hljs-keyword">delete</span> art.filter;
                    <span class="hljs-keyword">delete</span> art.filterAlpha;
                    <span class="hljs-keyword">delete</span> art.filterComposite;
                    <span class="hljs-keyword">delete</span> art.isStencil;
                    <span class="hljs-keyword">break</span>;
    		}
    	}

    	<span class="hljs-keyword">if</span> (item.substring) {

            <span class="hljs-keyword">if</span> (item === <span class="hljs-string">'all'</span>) item = [<span class="hljs-string">'pivot'</span>, <span class="hljs-string">'mimic'</span>, <span class="hljs-string">'path'</span>, <span class="hljs-string">'filter'</span>];
            <span class="hljs-keyword">else</span> item = [item];
        }

    	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(item)) item.forEach(<span class="hljs-function"><span class="hljs-params">purge</span> =&gt;</span> doPurge(<span class="hljs-keyword">this</span>, purge));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><code>initializePositions</code> - Internal function called by all artefact factories </p>
<ul>
<li>Setup initial Arrays and Objects, including <code>current...</code> and <code>...Subscriber</code> Arrays.</li>
<li>Create a variety of <code>dirty...</code> flags, setting them all to true. </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.initializePositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dimensions = makeCoordinate();
        <span class="hljs-keyword">this</span>.start = makeCoordinate();
        <span class="hljs-keyword">this</span>.handle = makeCoordinate();
        <span class="hljs-keyword">this</span>.offset = makeCoordinate();

        <span class="hljs-keyword">this</span>.currentDimensions = makeCoordinate();
        <span class="hljs-keyword">this</span>.currentStart = makeCoordinate();
        <span class="hljs-keyword">this</span>.currentHandle = makeCoordinate();
        <span class="hljs-keyword">this</span>.currentOffset = makeCoordinate();

        <span class="hljs-keyword">this</span>.currentDragOffset = makeCoordinate();
        <span class="hljs-keyword">this</span>.currentDragCache = makeCoordinate();
        <span class="hljs-keyword">this</span>.currentStartCache = makeCoordinate();

        <span class="hljs-keyword">this</span>.currentStampPosition = makeCoordinate();
        <span class="hljs-keyword">this</span>.currentStampHandlePosition = makeCoordinate();

        <span class="hljs-keyword">this</span>.delta = {};

        <span class="hljs-keyword">this</span>.lockTo = [<span class="hljs-string">'start'</span>, <span class="hljs-string">'start'</span>];

        <span class="hljs-keyword">this</span>.pivoted = [];
        <span class="hljs-keyword">this</span>.mimicked = [];

        <span class="hljs-keyword">this</span>.dirtyScale = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyLock = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">this</span>.isBeingDragged = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">this</span>.initializeDomPositions();
    };

    P.initializeDomPositions = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><code>setCoordinateHelper</code> - internal helper function used by positional and dimensional setter (S.) functions. Arguments are:</p>
<ul>
<li><strong>label</strong> - either <code>dimensions</code>, <code>start</code>, <code>handle</code> or <code>offset</code></li>
<li><strong>x</strong> - this can be either an <code>[x, y]</code> Array, or an <code>{x: val, y: val}</code> object, or a Number, or %String value</li>
<li>(for dimensions, <code>[w, h]</code>, or <code>{w: val, h: val}</code>, or <code>{width: val, height: val}</code>, etc)</li>
<li><strong>y</strong> - if <code>x</code> is a Number or String, then <code>y</code> should also be a Number or String</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.setCoordinateHelper = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">label, x, y</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>[label];

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(x)) {

            c[<span class="hljs-number">0</span>] = x[<span class="hljs-number">0</span>];
            c[<span class="hljs-number">1</span>] = x[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isa_obj(x)) {

            <span class="hljs-keyword">if</span> (xto(x.x, x.y)) {

                c[<span class="hljs-number">0</span>] = xtGet(x.x, c[<span class="hljs-number">0</span>]);
                c[<span class="hljs-number">1</span>] = xtGet(x.y, c[<span class="hljs-number">1</span>]);
            }
            <span class="hljs-keyword">else</span> {

                c[<span class="hljs-number">0</span>] = xtGet(x.width, x.w, c[<span class="hljs-number">0</span>]);
                c[<span class="hljs-number">1</span>] = xtGet(x.height, x.h, c[<span class="hljs-number">1</span>]);
            }
        }
        <span class="hljs-keyword">else</span> {

            c[<span class="hljs-number">0</span>] = x;
            c[<span class="hljs-number">1</span>] = y;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><code>setCoordinateHelper</code> - internal helper function used by positional and dimensional delta-setter (D.) functions. Arguments are:</p>
<ul>
<li><strong>label</strong> - either <code>dimensions</code>, <code>start</code>, <code>handle</code> or <code>offset</code></li>
<li><strong>x</strong> - this can be either an <code>[x, y]</code> Array, or an <code>{x: val, y: val}</code> object, or a Number, or %String value</li>
<li>(for dimensions, <code>[w, h]</code>, or <code>{w: val, h: val}</code>, or <code>{width: val, height: val}</code>, etc)</li>
<li><strong>y</strong> - if <code>x</code> is a Number or String, then <code>y</code> should also be a Number or String</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.setDeltaCoordinateHelper = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">label, x, y</span>) </span>{

        <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>[label],
            myX = c[<span class="hljs-number">0</span>],
            myY = c[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(x)) {

            c[<span class="hljs-number">0</span>] = addStrings(myX, x[<span class="hljs-number">0</span>]);
            c[<span class="hljs-number">1</span>] = addStrings(myY, x[<span class="hljs-number">1</span>]);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isa_obj(x)) {

            <span class="hljs-keyword">if</span> (xto(x.x, x.y)) {

                c[<span class="hljs-number">0</span>] = addStrings(myX, xtGet(x.x, <span class="hljs-number">0</span>));
                c[<span class="hljs-number">1</span>] = addStrings(myY, xtGet(x.y, <span class="hljs-number">0</span>));
            }
            <span class="hljs-keyword">else</span> {

                c[<span class="hljs-number">0</span>] = addStrings(myX, xtGet(x.width, x.w, <span class="hljs-number">0</span>));
                c[<span class="hljs-number">1</span>] = addStrings(myY, xtGet(x.height, x.h, <span class="hljs-number">0</span>));
            }
        }
        <span class="hljs-keyword">else</span> {

            c[<span class="hljs-number">0</span>] = addStrings(myX, x);
            c[<span class="hljs-number">1</span>] = addStrings(myY, y);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p><code>getHost</code> - internal function - return the <strong>host</strong> object. Hosts can be various things, for instance:</p>
<ul>
<li>Element wrapper will have a Stack as its host</li>
<li>Stack and Canvas wrappers can also have a Stack host</li>
<li>Cells will have either a Canvas, or another Cell, as their host</li>
<li>Entity artefacts will use a Cell as their host</li>
</ul>
<p>All of the above can exist without a host (though in many cases this means they don’t do much). Stack and Canvas wrappers will often be unhosted, sitting as <code>root</code> elements in the web page DOM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.getHost = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentHost) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHost;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.host) {

            <span class="hljs-keyword">let</span> host = artefact[<span class="hljs-keyword">this</span>.host];

            <span class="hljs-keyword">if</span> (host) {

                <span class="hljs-keyword">this</span>.currentHost = host;
                <span class="hljs-keyword">this</span>.dirtyHost = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHost;
            }
        }
        <span class="hljs-keyword">return</span> currentCorePosition;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><code>getHere</code> - the <strong>here</strong> parameter is owned by Canvas, Stack and (if enabled) Element artefacts and is set on them by calling <code>updateUiSubscribedElement</code> - thus not defined or updated by the artefact itself.</p>
<pre><code>here {x, y, w, h, normX, normY, offsetX, offsetY, type, active}</code></pre>
<p>Cell assets also have a <strong>here</strong> parameter, defined and updated by themselves with reference to their current Canvas host</p>
<pre><code>here {x, y, w, h, xRatio, yRatio}</code></pre>
<ul>
<li>NOTE: Canvas, Stack, Element (if enabled) and Cell all need to create their <code>here</code> attribute immediately after they first calculate their <code>currentDimensions</code> Coordinate, which needs to happen as part of the constructor!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.getHere = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.getHost();

        <span class="hljs-keyword">if</span> (host) {

            <span class="hljs-keyword">if</span> (host.here) <span class="hljs-keyword">return</span> host.here;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (host.currentDimensions) {

                <span class="hljs-keyword">let</span> dims = host.currentDimensions;

                <span class="hljs-keyword">if</span> (dims) {

                    <span class="hljs-keyword">return</span> {
                        <span class="hljs-attr">w</span>: dims[<span class="hljs-number">0</span>],
                        <span class="hljs-attr">h</span>: dims[<span class="hljs-number">1</span>]
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> currentCorePosition;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h4 id="clean-functions">Clean functions</h4>
<p>Clean functions are triggered by artefacts as they prepare to stamp themselves into their host environment. The decision to trigger a clean function is mediated by various <code>dirty...</code> flags, which get set when the artefact is updated via <code>set</code> and <code>deltaSet</code> calls.</p>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><code>cleanPosition</code> - internal helper function used by <code>cleanStart</code>, <code>cleanHandle</code> and <code>cleanOffset</code> functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanPosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, source, dimensions</span>) </span>{

        <span class="hljs-keyword">let</span> val, dim;

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) {

            val = source[i];
            dim = dimensions[i];

            <span class="hljs-keyword">if</span> (val.toFixed) current[i] = val;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val === <span class="hljs-string">'left'</span> || val === <span class="hljs-string">'top'</span>) current[i] = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val === <span class="hljs-string">'right'</span> || val === <span class="hljs-string">'bottom'</span>) current[i] = dim;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val === <span class="hljs-string">'center'</span>) current[i] = dim / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">else</span> current[i] = (<span class="hljs-built_in">parseFloat</span>(val) / <span class="hljs-number">100</span>) * dim;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><code>cleanScale</code> - set the artefact’s <strong>currentScale</strong> value.</p>
<ul>
<li>Scaling has widespread effects across a range of the artefact’s other positional and display attributes.</li>
<li>Artefacts may use other artefacts to set their own scale values - <code>mimic</code>, <code>pivot</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanScale = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyScale = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> scale,
            myscale = <span class="hljs-keyword">this</span>.scale,
            mimic = <span class="hljs-keyword">this</span>.mimic,
            oldScale = <span class="hljs-keyword">this</span>.currentScale;

        <span class="hljs-keyword">if</span>(mimic &amp;&amp; <span class="hljs-keyword">this</span>.useMimicScale) {

            <span class="hljs-keyword">if</span> (mimic.currentScale) {

                scale = mimic.currentScale;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addOwnScaleToMimic) scale += myscale;
            }
            <span class="hljs-keyword">else</span> {

                scale = myscale;
                <span class="hljs-keyword">this</span>.dirtyMimicScale = <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">else</span> scale = myscale;

        <span class="hljs-keyword">this</span>.currentScale = scale;

        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (oldScale !== <span class="hljs-keyword">this</span>.currentScale) <span class="hljs-keyword">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mimicked &amp;&amp; <span class="hljs-keyword">this</span>.mimicked.length) <span class="hljs-keyword">this</span>.dirtyMimicScale = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><code>cleanDimensions</code> - calculate the artefact’s <strong>currentDimensions</strong> Array</p>
<ul>
<li>Dimensions DO scale - but scaling happens elsewhere</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanDimensions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.getHost(),
            dims = <span class="hljs-keyword">this</span>.dimensions,
            curDims = <span class="hljs-keyword">this</span>.currentDimensions;

        <span class="hljs-keyword">if</span> (host) {

            <span class="hljs-keyword">let</span> hostDims = (host.currentDimensions) ? host.currentDimensions : [host.w, host.h];

            <span class="hljs-keyword">let</span> [w, h] = dims,
                oldW = curDims[<span class="hljs-number">0</span>],
                oldH = curDims[<span class="hljs-number">1</span>];

            <span class="hljs-keyword">if</span> (w.substring) w = (<span class="hljs-built_in">parseFloat</span>(w) / <span class="hljs-number">100</span>) * hostDims[<span class="hljs-number">0</span>];

            <span class="hljs-keyword">if</span> (h.substring) {

                <span class="hljs-keyword">if</span> (h === <span class="hljs-string">'auto'</span>) h = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">else</span> h = (<span class="hljs-built_in">parseFloat</span>(h) / <span class="hljs-number">100</span>) * hostDims[<span class="hljs-number">1</span>];
            }

            <span class="hljs-keyword">let</span> mimic = <span class="hljs-keyword">this</span>.mimic,
                mimicDims;

            <span class="hljs-keyword">if</span> (mimic &amp;&amp; mimic.name &amp;&amp; <span class="hljs-keyword">this</span>.useMimicDimensions) mimicDims = mimic.currentDimensions;

            <span class="hljs-keyword">if</span> (mimicDims) {

                curDims[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">this</span>.addOwnDimensionsToMimic) ? mimicDims[<span class="hljs-number">0</span>] + w : mimicDims[<span class="hljs-number">0</span>];
                curDims[<span class="hljs-number">1</span>] = (<span class="hljs-keyword">this</span>.addOwnDimensionsToMimic) ? mimicDims[<span class="hljs-number">1</span>] + h : mimicDims[<span class="hljs-number">1</span>];
            }
            <span class="hljs-keyword">else</span> {

                curDims[<span class="hljs-number">0</span>] = w;
                curDims[<span class="hljs-number">1</span>] = h;
            }

            <span class="hljs-keyword">this</span>.cleanDimensionsAdditionalActions();

            <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">if</span> (oldW !== curDims[<span class="hljs-number">0</span>] || oldH !== curDims[<span class="hljs-number">1</span>]) <span class="hljs-keyword">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mimicked &amp;&amp; <span class="hljs-keyword">this</span>.mimicked.length) <span class="hljs-keyword">this</span>.dirtyMimicDimensions = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><code>cleanDimensionsAdditionalActions</code> - overwritten by some artefact factory files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanDimensionsAdditionalActions = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><code>cleanLock</code> - clean function for <strong>lockTo</strong> array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanLock = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyLock = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><code>cleanStart</code> - calculate the artefact’s <strong>currentStart</strong> Array</p>
<ul>
<li>Start values do NOT scale</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> here = <span class="hljs-keyword">this</span>.getHere();

        <span class="hljs-keyword">if</span> (xt(here)) {

            <span class="hljs-keyword">if</span> (xta(here.w, here.h)) {

                <span class="hljs-keyword">this</span>.cleanPosition(<span class="hljs-keyword">this</span>.currentStart, <span class="hljs-keyword">this</span>.start, [here.w, here.h]);
                <span class="hljs-keyword">this</span>.dirtyStampPositions = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><code>cleanOffset</code> - calculate the artefact’s <strong>currentOffset</strong> Array</p>
<ul>
<li>Offset values do NOT scale</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanOffset = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> here = <span class="hljs-keyword">this</span>.getHere();

        <span class="hljs-keyword">if</span> (xt(here)) {

            <span class="hljs-keyword">if</span> (xta(here.w, here.h)) {

                <span class="hljs-keyword">this</span>.cleanPosition(<span class="hljs-keyword">this</span>.currentOffset, <span class="hljs-keyword">this</span>.offset, [here.w, here.h]);
                <span class="hljs-keyword">this</span>.dirtyStampPositions = <span class="hljs-literal">true</span>;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mimicked &amp;&amp; <span class="hljs-keyword">this</span>.mimicked.length) <span class="hljs-keyword">this</span>.dirtyMimicOffset = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyOffset = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p><code>cleanHandle</code> - calculate the artefact’s <strong>currentHandle</strong> Array</p>
<ul>
<li>Handle values DO scale - but scaling happens elsewhere:</li>
<li>DOM elements (Stack, Element, Canvas) manage handle offset in their CSS <code>transform</code> string</li>
<li>Entities manage it as part of each entity’s <code>cleanPath</code> calculation</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanHandle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> current = <span class="hljs-keyword">this</span>.currentHandle;

        <span class="hljs-keyword">this</span>.cleanPosition(current, <span class="hljs-keyword">this</span>.handle, <span class="hljs-keyword">this</span>.currentDimensions);
        <span class="hljs-keyword">this</span>.dirtyStampHandlePositions = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mimicked &amp;&amp; <span class="hljs-keyword">this</span>.mimicked.length) <span class="hljs-keyword">this</span>.dirtyMimicHandle = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><code>cleanRotation</code> - calculate the artefact’s <strong>currentRotation</strong> value</p>
<ul>
<li>For entity artefacts, the value is a Number</li>
<li>For DOM-based artefacts, the value will be a Quaternion object</li>
<li>This function only handles the <strong>roll</strong> attribute; it is overwritten in the <a href="./dom.html">dom mixin</a> to extend coverage to <strong>yaw</strong> and <strong>pitch</strong> attributes</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanRotation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyRotation = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> roll,
            myroll = <span class="hljs-keyword">this</span>.roll,
            oldRoll = <span class="hljs-keyword">this</span>.currentRotation,
            path = <span class="hljs-keyword">this</span>.path,
            mimic = <span class="hljs-keyword">this</span>.mimic,
            pivot = <span class="hljs-keyword">this</span>.pivot,
            lock = <span class="hljs-keyword">this</span>.lockTo;

        <span class="hljs-keyword">if</span> (path &amp;&amp; lock.indexOf(<span class="hljs-string">'path'</span>) &gt;= <span class="hljs-number">0</span>) {

            roll = myroll;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addPathRotation) {

                <span class="hljs-keyword">let</span> pathData = <span class="hljs-keyword">this</span>.getPathData();

                <span class="hljs-keyword">if</span> (pathData) roll += pathData.angle;
            }

        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mimic &amp;&amp; <span class="hljs-keyword">this</span>.useMimicRotation &amp;&amp; lock.indexOf(<span class="hljs-string">'mimic'</span>) &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">if</span> (xt(mimic.currentRotation)) {

                roll = mimic.currentRotation;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addOwnRotationToMimic) roll += myroll;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyMimicRotation = <span class="hljs-literal">true</span>;
        } 
        <span class="hljs-keyword">else</span> {

            roll = myroll;

            <span class="hljs-keyword">if</span> (pivot &amp;&amp; <span class="hljs-keyword">this</span>.addPivotRotation &amp;&amp; lock.indexOf(<span class="hljs-string">'pivot'</span>) &gt;= <span class="hljs-number">0</span>) {

                <span class="hljs-keyword">if</span> (xt(pivot.currentRotation)) roll += pivot.currentRotation;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyPivotRotation = <span class="hljs-literal">true</span>;
            }
            
        }

        <span class="hljs-keyword">this</span>.currentRotation = roll;

        <span class="hljs-keyword">if</span> (roll !== oldRoll) <span class="hljs-keyword">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>If this artefact is being mimicked by other artefacts, it needs to check its rotation values on every iteration of the display cycle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mimicked &amp;&amp; <span class="hljs-keyword">this</span>.mimicked.length) <span class="hljs-keyword">this</span>.dirtyMimicRotation = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p><code>cleanStampPositions</code> </p>
<ul>
<li>the <strong>currentStampPosition</strong> Coordinate represents the combination of <strong>start</strong> and <strong>offset</strong> Coordinates to determine the current value of the artefact’s <em>Rotation-Reflection point</em>.</li>
<li>The calculation does not take into account the <strong>handle</strong> Coordinate which, for entity artefacts, gets applied after the canvas engine transformation is performend for its stamp operation.</li>
<li>DOM-based artefacts will also take handle values into consideration after the fact.</li>
<li>The <code>x</code> and <code>y</code> coordinates are handled separately, and are dependant on the the lock set for each in the <strong>lockTo</strong> Array.</li>
<li>Artefacts that are currently in <strong>drag mode</strong> (whose lock values are temporarily overridden) also need to take into account drag offset values.</li>
<li>Rotation and flip attributes are handled separately, alongside handle values, as part of the actual stamp operation.</li>
<li>If either <strong>currentStampPosition</strong> coordinate changes as a result of this function, the <code>dirtyPositionSubscribers</code> flag will be set so that the change can be cascaded to any artefacts using this one as a <code>pivot</code> or <code>mimic</code> for their start or offset values.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanStampPositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyStampPositions = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> stamp = <span class="hljs-keyword">this</span>.currentStampPosition,
            start = <span class="hljs-keyword">this</span>.currentStart,
            oldX = stamp[<span class="hljs-number">0</span>],
            oldY = stamp[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.noPositionDependencies) {

            stamp[<span class="hljs-number">0</span>] = start[<span class="hljs-number">0</span>];
            stamp[<span class="hljs-number">1</span>] = start[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">let</span> lockArray = <span class="hljs-keyword">this</span>.lockTo,
                localLockArray = [],
                lock, i, coord, here, pathData,
                hereFlag = <span class="hljs-literal">false</span>,
                offset = <span class="hljs-keyword">this</span>.currentOffset,
                isBeingDragged = <span class="hljs-keyword">this</span>.isBeingDragged,
                drag = <span class="hljs-keyword">this</span>.currentDragOffset,
                cache = <span class="hljs-keyword">this</span>.currentStartCache,
                pivot = <span class="hljs-keyword">this</span>.pivot,
                path = <span class="hljs-keyword">this</span>.path,
                mimic = <span class="hljs-keyword">this</span>.mimic;

            <span class="hljs-keyword">if</span> (isBeingDragged) {

                localLockArray = [<span class="hljs-string">'mouse'</span>, <span class="hljs-string">'mouse'</span>];
                hereFlag = <span class="hljs-literal">true</span>;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getCornerCoordinate) <span class="hljs-keyword">this</span>.cleanPathObject();
            }
            <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><code>x</code> and <code>y</code> coordinates can have different lockTo values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) {

                    lock = lockArray[i];

                    <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'pivot'</span> &amp;&amp; !pivot) lock = <span class="hljs-string">'start'</span>;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'path'</span> &amp;&amp; !path) lock = <span class="hljs-string">'start'</span>;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'mimic'</span> &amp;&amp; !mimic) lock = <span class="hljs-string">'start'</span>;

                    <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'mouse'</span>) hereFlag = <span class="hljs-literal">true</span>;

                    localLockArray[i] = lock;
                }
            }

            <span class="hljs-keyword">if</span> (hereFlag) here = <span class="hljs-keyword">this</span>.getHere();</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>We loop twice - once for each coordinate: <code>x</code> is calculated on the first loop (<code>i === 0</code>); <code>y</code> on the second (<code>i === 1</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) {

                lock = localLockArray[i];

                <span class="hljs-keyword">switch</span> (lock) {

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'pivot'</span> :</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>When the pivot is an Element artefact, can use its corner values as pivots</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pivotCorner &amp;&amp; pivot.getCornerCoordinate) {

                            coord = pivot.getCornerCoordinate(<span class="hljs-keyword">this</span>.pivotCorner, (i) ? <span class="hljs-string">'y'</span> : <span class="hljs-string">'x'</span>);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>When the pivot is a Polyline entity, need also to confirm which pin to use (default 0)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pivot.type === <span class="hljs-string">'Polyline'</span>) {

                        	coord = pivot.getPinAt(<span class="hljs-keyword">this</span>.pivotPin, (i) ? <span class="hljs-string">'y'</span> : <span class="hljs-string">'x'</span>);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Everything else</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">else</span> coord = pivot.currentStampPosition[i];

                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.addPivotOffset) coord -= pivot.currentOffset[i];

                        coord += offset[i];

                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'path'</span> :
                        pathData = <span class="hljs-keyword">this</span>.getPathData();

                        <span class="hljs-keyword">if</span> (pathData) {

                            coord = (i) ? pathData.y : pathData.x;

                            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.addPathOffset) coord -= path.currentOffset[i];
                        }
                        <span class="hljs-keyword">else</span> coord = start[i] + offset[i];

                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'mimic'</span> :
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.useMimicStart || <span class="hljs-keyword">this</span>.useMimicOffset) {

                            coord = mimic.currentStampPosition[i];

                            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.useMimicStart &amp;&amp; <span class="hljs-keyword">this</span>.addOwnStartToMimic) coord += start[i];
                            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.useMimicOffset &amp;&amp; <span class="hljs-keyword">this</span>.addOwnOffsetToMimic) coord += offset[i];

                            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.useMimicStart) coord = coord - mimic.currentStart[i] + start[i];
                            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.useMimicOffset) coord = coord - mimic.currentOffset[i] + offset[i];
                        }
                        <span class="hljs-keyword">else</span> coord = start[i] + offset[i];

                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'mouse'</span> :
                        coord = (i === <span class="hljs-number">0</span>) ? here.x : here.y;

                        <span class="hljs-keyword">if</span> (isBeingDragged) {

                            cache[i] = coord;
                            coord += drag[i];
                        }
                        coord += offset[i];

                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">default</span> :
                        coord = start[i] + offset[i];
                }
                stamp[i] = coord;
            }
        }
        <span class="hljs-keyword">if</span> (oldX !== stamp[<span class="hljs-number">0</span>] || oldY !== stamp[<span class="hljs-number">1</span>]) <span class="hljs-keyword">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p><code>cleanStampHandlePositions</code> </p>
<ul>
<li>an entity’s <strong>currentStampHandlePosition</strong> values get applied after the canvas grid has been set up for the stamp operation. </li>
<li>Entities include handle values as part of their ‘path’ calculation.</li>
<li>DOM-based artefacts include handle values as part of their CSS transform string.</li>
<li>Handle values DO scale, but not here; that happens when the transform/path is recalculated.</li>
<li>If either currentStampHandlePosition coordinate changes as a result of this function, the <code>dirtyPositionSubscribers</code> flag will be set so that the change can be cascaded to any artefacts using this one as a pivot or mimic for their start, handle or offset values.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanStampHandlePositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyStampHandlePositions = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> stampHandle = <span class="hljs-keyword">this</span>.currentStampHandlePosition,
            handle = <span class="hljs-keyword">this</span>.currentHandle,
            oldX = stampHandle[<span class="hljs-number">0</span>],
            oldY = stampHandle[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.noPositionDependencies) {

            stampHandle[<span class="hljs-number">0</span>] = handle[<span class="hljs-number">0</span>];
            stampHandle[<span class="hljs-number">1</span>] = handle[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">let</span> lockArray = <span class="hljs-keyword">this</span>.lockTo,
                lock, i, coord, here, myscale,
                pivot = <span class="hljs-keyword">this</span>.pivot,
                path = <span class="hljs-keyword">this</span>.path,
                mimic = <span class="hljs-keyword">this</span>.mimic;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>We loop twice - once for each coordinate: <code>x</code> is calculated on the first loop (<code>i === 0</code>); <code>y</code> on the second (<code>i === 1</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) {

                lock = lockArray[i];

                <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'pivot'</span> &amp;&amp; !pivot) lock = <span class="hljs-string">'start'</span>;
                <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'path'</span> &amp;&amp; !path) lock = <span class="hljs-string">'start'</span>;
                <span class="hljs-keyword">if</span> (lock === <span class="hljs-string">'mimic'</span> &amp;&amp; !mimic) lock = <span class="hljs-string">'start'</span>;

                coord = handle[i];

                <span class="hljs-keyword">switch</span> (lock) {

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'pivot'</span> :
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addPivotHandle) coord += pivot.currentHandle[i];
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'path'</span> :
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addPathHandle) coord += path.currentHandle[i];
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'mimic'</span> :
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.useMimicHandle) {

                            coord = mimic.currentHandle[i];

                            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addOwnHandleToMimic) coord += handle[i];
                        }
                        <span class="hljs-keyword">break</span>;
                }
                stampHandle[i] = coord;
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>At the moment only Shape type artefacts require additional calculations to complete the cleanHandle functionality. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.cleanStampHandlePositionsAdditionalActions();

        <span class="hljs-keyword">if</span> (oldX !== stampHandle[<span class="hljs-number">0</span>] || oldY !== stampHandle[<span class="hljs-number">1</span>]) <span class="hljs-keyword">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">true</span>;
    };
    P.cleanStampHandlePositionsAdditionalActions = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>// <code>getPathData</code>
    P.getPathData = function () {</p>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentPathData) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentPathData;</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">let</span> pathPos = <span class="hljs-keyword">this</span>.pathPosition,
        path = <span class="hljs-keyword">this</span>.path,
        currentPathData;</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">if</span> (path) {</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <pre><code>        currentPathData = path.getPathPositionData(pathPos, <span class="hljs-keyword">this</span>.constantPathSpeed);</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <pre><code>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.addPathRotation) <span class="hljs-keyword">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <pre><code>        <span class="hljs-keyword">this</span>.currentPathData = currentPathData;</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <pre><code>        <span class="hljs-keyword">return</span> currentPathData;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><code>checkHit</code></p>
<ul>
<li>We use pool Cells (see <a href="../factory/cell.html">Cell code</a>) to help calculate whether (any of) the Coordinate(s) supplied in the first argument are colliding with the artefact. </li>
<li>This works both for entitys and for DOM-based artefacts.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.checkHit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = [], mycell</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.noUserInteraction) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.pathObject || <span class="hljs-keyword">this</span>.dirtyPathObject) {

            <span class="hljs-keyword">this</span>.cleanPathObject();
        }

        <span class="hljs-keyword">let</span> tests = (!<span class="hljs-built_in">Array</span>.isArray(items)) ?  [items] : items,
            poolCellFlag = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (!mycell) {

            mycell = requestCell();
            poolCellFlag = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">let</span> engine = mycell.engine,
            stamp = <span class="hljs-keyword">this</span>.currentStampPosition,
            x = stamp[<span class="hljs-number">0</span>],
            y = stamp[<span class="hljs-number">1</span>],
            tx, ty;

        <span class="hljs-keyword">if</span> (tests.some(<span class="hljs-function"><span class="hljs-params">test</span> =&gt;</span> {

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(test)) {

                tx = test[<span class="hljs-number">0</span>];
                ty = test[<span class="hljs-number">1</span>];
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (xta(test, test.x, test.y)) {

                tx = test.x;
                ty = test.y;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (!tx.toFixed || !ty.toFixed || <span class="hljs-built_in">isNaN</span>(tx) || <span class="hljs-built_in">isNaN</span>(ty)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            mycell.rotateDestination(engine, x, y, <span class="hljs-keyword">this</span>);

            <span class="hljs-keyword">return</span> engine.isPointInPath(<span class="hljs-keyword">this</span>.pathObject, tx, ty, <span class="hljs-keyword">this</span>.winding);

        }, <span class="hljs-keyword">this</span>)) {

            <span class="hljs-keyword">let</span> r = <span class="hljs-keyword">this</span>.checkHitReturn(tx, ty, mycell);

            <span class="hljs-keyword">if</span> (poolCellFlag) releaseCell(mycell);

            <span class="hljs-keyword">return</span> r;
        }
        
        <span class="hljs-keyword">if</span> (poolCellFlag) releaseCell(mycell);
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Function overwritten by entitys, if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.checkHitReturn = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y, cell</span>) </span>{

        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">x</span>: x,
            <span class="hljs-attr">y</span>: y,
            <span class="hljs-attr">artefact</span>: <span class="hljs-keyword">this</span>
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p><code>pickupArtefact</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.pickupArtefact = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">let</span> {x, y} = items;

        <span class="hljs-keyword">if</span> (xta(x, y)) {

            <span class="hljs-keyword">this</span>.isBeingDragged = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.currentDragCache.set(<span class="hljs-keyword">this</span>.currentDragOffset);

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">0</span>] === <span class="hljs-string">'start'</span>) {
                <span class="hljs-keyword">this</span>.currentDragOffset[<span class="hljs-number">0</span>] = <span class="hljs-keyword">this</span>.currentStart[<span class="hljs-number">0</span>] - x;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">0</span>] === <span class="hljs-string">'pivot'</span> &amp;&amp; <span class="hljs-keyword">this</span>.pivot) {
                <span class="hljs-keyword">this</span>.currentDragOffset[<span class="hljs-number">0</span>] = <span class="hljs-keyword">this</span>.pivot.get(<span class="hljs-string">'startX'</span>) - x;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">0</span>] === <span class="hljs-string">'mimic'</span> &amp;&amp; <span class="hljs-keyword">this</span>.mimic) {
                <span class="hljs-keyword">this</span>.currentDragOffset[<span class="hljs-number">0</span>] = <span class="hljs-keyword">this</span>.mimic.get(<span class="hljs-string">'startX'</span>) - x;
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">1</span>] === <span class="hljs-string">'start'</span>) {
                <span class="hljs-keyword">this</span>.currentDragOffset[<span class="hljs-number">1</span>] = <span class="hljs-keyword">this</span>.currentStart[<span class="hljs-number">1</span>] - y;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">1</span>] === <span class="hljs-string">'pivot'</span> &amp;&amp; <span class="hljs-keyword">this</span>.pivot) {
                <span class="hljs-keyword">this</span>.currentDragOffset[<span class="hljs-number">1</span>] = <span class="hljs-keyword">this</span>.pivot.get(<span class="hljs-string">'startY'</span>) - y;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lockTo[<span class="hljs-number">1</span>] === <span class="hljs-string">'mimic'</span> &amp;&amp; <span class="hljs-keyword">this</span>.mimic) {
                <span class="hljs-keyword">this</span>.currentDragOffset[<span class="hljs-number">1</span>] = <span class="hljs-keyword">this</span>.mimic.get(<span class="hljs-string">'startY'</span>) - y;
            }

            <span class="hljs-keyword">this</span>.order += <span class="hljs-number">9999</span>;

            <span class="hljs-keyword">this</span>.group.batchResort = <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">if</span> (xt(<span class="hljs-keyword">this</span>.dirtyPathObject)) <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><code>dropArtefact</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.dropArtefact = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.start.set(<span class="hljs-keyword">this</span>.currentStartCache).add(<span class="hljs-keyword">this</span>.currentDragOffset);
        <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">this</span>.currentDragOffset.set(<span class="hljs-keyword">this</span>.currentDragCache);

        <span class="hljs-keyword">this</span>.order = (<span class="hljs-keyword">this</span>.order &gt;= <span class="hljs-number">9999</span>) ? <span class="hljs-keyword">this</span>.order - <span class="hljs-number">9999</span> : <span class="hljs-number">0</span>;

        <span class="hljs-keyword">this</span>.group.batchResort = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (xt(<span class="hljs-keyword">this</span>.dirtyPathObject)) <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">this</span>.isBeingDragged = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <h4 id="subscription-management">Subscription management</h4>
<p>Artefacts can subscribe to other artefacts so that they can be notified when a particular attribute changes. </p>
<ul>
<li>This notification happens when an artefact completes cleaning its attributes and detects that there have been changes which other artefacts need to be aware.</li>
<li>The artefact doesbn’t change any values in artefacts which have subscribed to them - unlike asset objects, which do directly update attribute values in their subscribing artefacts. </li>
<li>Instead, the artefact sets the appropriate <code>dirty</code> flags which the subscribing artefacts can process as they progress through the Display cycle.</li>
<li>Because the update functionality cascades from one controlling function - <code>updatePositionSubscribers</code> - we also define a range of subsidiary functions here </li>
<li>TODO: some of the subsidiary functions should be moved to more appropriate factory code?</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p><code>updatePositionSubscribers</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.updatePositionSubscribers = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pivoted &amp;&amp; <span class="hljs-keyword">this</span>.pivoted.length) <span class="hljs-keyword">this</span>.updatePivotSubscribers();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mimicked &amp;&amp; <span class="hljs-keyword">this</span>.mimicked.length) <span class="hljs-keyword">this</span>.updateMimicSubscribers();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pathed &amp;&amp; <span class="hljs-keyword">this</span>.pathed.length) <span class="hljs-keyword">this</span>.updatePathSubscribers();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p><code>updatePivotSubscribers</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.updatePivotSubscribers = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p><code>updateMimicSubscribers</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.updateMimicSubscribers = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p><code>updatePathSubscribers</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.updatePathSubscribers = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p><code>updateImageSubscribers</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.updateImageSubscribers = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Return the prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> P;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
