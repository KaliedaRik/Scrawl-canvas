<!DOCTYPE html>

<html>
<head>
  <title>Base mixin</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter-stringed.html">
                  ./source/worker/filter-stringed.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
                
                <a class="source" href="../worker/filter_canvas.html">
                  ./source/worker/filter_canvas.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="base-mixin">Base mixin</h1>
<p>This mixin sets up much of the basic functionality of a Scrawl-canvas Object:</p>
<ul>
<li><strong>defs</strong> - every Scrawl-canvas object comes with a set of pre-defined attributes with default values; the specific attributes will vary between factories, but all include a ‘name’ attribute.</li>
<li><strong>getters</strong> - to retrieve values from a given attribute.</li>
<li><strong>setters</strong> - to update a range of attribute values in a Scrawl-canvas object.</li>
<li><strong>deltaSetters</strong> - to add supplied values to a range of attribute values in a Scrawl-canvas object.</li>
<li><strong>name</strong> attribute functionality - all Scrawl-canvas objects are given a name attribute, either supplied by the developer or computer-generated by the system.</li>
<li>Object <strong>registration</strong> functionality - most factory-generated objects get registered in the Scrawl-canvas library object.</li>
<li><strong>packet</strong> generation and use - Scrawl-canvas objects can deliver and consume text-based packets to build new objects or update existing objects.</li>
<li><strong>clone</strong> functionality - most Scrawl-canvas objects can be cloned, to make the development of a canvas (or stack) scene easier.</li>
<li><strong>kill</strong> functionality - remove objects from the Scrawl-canvas system - and, where required, the DOM - in a safe way.</li>
</ul>
<p>Given the fundamental nature of the above functionality the base mixin should always, when coding a Scrawl-canvas factory, be the first to be applied to that factory function’s prototype.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> library <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/library.js'</span>;
<span class="hljs-keyword">import</span> { mergeOver, pushUnique, removeItem, generateUuid, isa_boolean, isa_obj, addStrings, xt, xta, λ<span class="hljs-literal">null</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/utilities.js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="export-function">Export function</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">P = {}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>
<p>The <strong>defs</strong> object supplies default values for a Scrawl-canvas object. Setter functions will check to see that a related defs attribute exists before allowing users to update an object attribute. Similarly the getter function will use the defs object to supply default values for an attribute that has not otherwise been set, or has been deleted by a user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.defs = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The <strong>getters</strong> object holds a suite of functions for given factory object attributes that need to have their values processed before they can be returned to the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.getters = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The <strong>setters</strong> object holds a suite of functions for given factory object attributes that need to process a new value before setting it to the attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.setters = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <strong>deltaSetters</strong> object holds a suite of functions for given factory object attributes that need to process a new value before adding it to the attribute’s existing value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.deltaSetters = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><code>get</code> - Retrieve an attribute value using the <strong>get</strong> function. While many attributes can be retrieved directly - for example, <em>scrawl.artefact.myelement.scale</em> - some attributes should only ever be retrieved using get:</p>
<pre><code>scrawl.artefact.myelement.get(<span class="hljs-string">'startX'</span>);
-&gt; <span class="hljs-number">200</span></code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (xt(item)) {

            <span class="hljs-keyword">let</span> getter = <span class="hljs-keyword">this</span>.getters[item];

            <span class="hljs-keyword">if</span> (getter) <span class="hljs-keyword">return</span> getter.call(<span class="hljs-keyword">this</span>);

            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">let</span> def = <span class="hljs-keyword">this</span>.defs[item];

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">'undefined'</span>) {

                    <span class="hljs-keyword">let</span> val = <span class="hljs-keyword">this</span>[item];
                    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">'undefined'</span>) ? val : def;
                }
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><code>set</code> - Set an attribute value using the <strong>set</strong> function. It is extremely important that all factory object attributes are set using the set function; setting an attribute directly will lead to unexpected behaviour! The set function takes a single object as its argument.</p>
<pre><code>scrawl.artefact.myelement.set({
    <span class="hljs-attr">startX</span>: <span class="hljs-number">50</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">scale</span>: <span class="hljs-number">1.5</span>,
    <span class="hljs-attr">roll</span>: <span class="hljs-number">90</span>,
});</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.set = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(items).length) {

            <span class="hljs-keyword">let</span> setters = <span class="hljs-keyword">this</span>.setters,
                defs = <span class="hljs-keyword">this</span>.defs,
                predefined;

            <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

                <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">'name'</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                    predefined = setters[key];

                    <span class="hljs-keyword">if</span> (predefined) predefined.call(<span class="hljs-keyword">this</span>, value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">this</span>[key] = value;
                }
            }, <span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>setDelta</code> - Add a value to an existing attribute value using the <strong>setDelta</strong> function. It is extremely important that all factory object attributes are updated using the setDelta function; updating an attribute directly will lead to unexpected behaviour! The setDelta function takes a single object as its argument.</p>
<pre><code>scrawl.artefact.myelement.setDelta({
    <span class="hljs-attr">startX</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-number">-20</span>,
    <span class="hljs-attr">scale</span>: <span class="hljs-number">0.05</span>,
    <span class="hljs-attr">roll</span>: <span class="hljs-number">5</span>,
});</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.setDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(items).length) {

            <span class="hljs-keyword">let</span> setters = <span class="hljs-keyword">this</span>.deltaSetters,
                defs = <span class="hljs-keyword">this</span>.defs,
                predefined;

            <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

                <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">'name'</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                    predefined = setters[key];

                    <span class="hljs-keyword">if</span> (predefined) predefined.call(<span class="hljs-keyword">this</span>, value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] != <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">this</span>[key] = addStrings(<span class="hljs-keyword">this</span>[key], value);
                }
            }, <span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h4 id="shared-attributes">Shared attributes</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Scrawl-canvas relies on unique <strong>name</strong> values being present in a factory object for a wide range of functionalities. Most of the library sections store an object by its name value, for example: <em>scrawl.artefact.myelement</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        name: <span class="hljs-string">''</span>,
    };
    P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>
<p><strong>Packets</strong> are Scrawl-canvas’s way of generating and consuming SC object data, both locally and over a network. A packet is a formatted JSON String which can be captured in a variable or saved to a text file.</p>
<p>The packet format is as follows:</p>
<pre><code><span class="hljs-string">"[object-name, object-type, object's-library-section, {object-data-key:value-pairs}]"</span></code></pre>
<ul>
<li>Use <strong>saveAsPacket()</strong> to get a stringified representation of a Scrawl-canvas object, which can then be consumed by other SC objects at a later date.</li>
<li>Use <strong>actionPacket(‘packet-string’)</strong> to apply a previously saved packet to an existing SC object, or to create a new SC object from the packet if it doesn’t exist already</li>
<li>Use <strong>importPacket(url)</strong> to retrieve a packet from a text file (normally kept remotely on a server); the function’s argument can be either the packet file’s url address, or an Array of such addresses.</li>
</ul>
<p>Using <em>JSON.stringify(object)</em>, or <em>object.toString()</em>, to generate String representations of SC objects is not recommended as they will forego the pre-processing that saveAsPacket performs to generate the packet String.</p>
<p>Example:</p>
<pre><code><span class="hljs-keyword">let</span> canvas = scrawl.library.canvas.mycanvas;
canvas.setAsCurrentCanvas();

<span class="hljs-keyword">let</span> box = scrawl.makeBlock({

    <span class="hljs-attr">name</span>: <span class="hljs-string">'my-box'</span>,

    <span class="hljs-attr">startX</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-number">10</span>,

    <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">50</span>,

    <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'red'</span>,

    <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        box.set({
            <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'pink'</span>,
        });
    },

    <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        box.set({
            <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'red'</span>,
        });
    }
});

<span class="hljs-keyword">let</span> boxPacket = box.saveAsPacket();

<span class="hljs-built_in">console</span>.log(boxPacket);
| [
|     <span class="hljs-string">"my-box"</span>,
|     <span class="hljs-string">"Block"</span>,
|     <span class="hljs-string">"entity"</span>,
|     {
|         <span class="hljs-string">"name"</span>:<span class="hljs-string">"my-box"</span>,
|         <span class="hljs-string">"dimensions"</span>:[<span class="hljs-number">100</span>,<span class="hljs-number">50</span>],
|         <span class="hljs-string">"start"</span>:[<span class="hljs-number">10</span>,<span class="hljs-number">10</span>],
|         <span class="hljs-string">"delta"</span>:{},
|         <span class="hljs-string">"onEnter"</span>:<span class="hljs-string">"function () {\n\t\tbox.set({\n\t\t\tfillStyle: 'pink',\n\t\t});\n\t}"</span>,
|         <span class="hljs-string">"onLeave"</span>:<span class="hljs-string">"function () {\n\t\tbox.set({\n\t\t\tfillStyle: 'red',\n\t\t});\n\t}"</span>,
|         <span class="hljs-string">"group"</span>:<span class="hljs-string">"mycanvas_base"</span>,
|         <span class="hljs-string">"fillStyle"</span>:<span class="hljs-string">"black"</span>
|     }
| ]

<span class="hljs-comment">// delete the box</span>
box.kill()

<span class="hljs-comment">// recreate the entity - we can invoke the function on any handy SC object without affecting that object</span>
<span class="hljs-keyword">let</span> resurrectedBox = canvas.actionPacket(boxPacket);

<span class="hljs-comment">// recreate the entity - if we had saved the packet to a file on a server</span>
<span class="hljs-keyword">let</span> fetchedBox = canvas.importPacket(<span class="hljs-string">'https://example.com/path/to/boxPacket.txt'</span>);</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Internal processing Arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.packetExclusions = [];
    P.packetExclusionsByRegex = [];
    P.packetCoordinates = [];
    P.packetObjects = [];
    P.packetFunctions = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>saveAsPacket</code> - accepts an items {key:value} object argument with the following (optional) attributes:</p>
<ul>
<li><strong>includeDefaults</strong> - either a boolean (default: false), or an array of attribute strings listing those attributes whose values should be included in the packet even if those values are the default values; setting this attribute to boolean true will include all of the Scrawl-canvas object’s attribute values in the (much larger) packet.</li>
</ul>
<p>Note: if the argument is supplied as a boolean ‘true’, code will create an items object with an attribute ‘includeDefaults’ set to true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.saveAsPacket = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (isa_boolean(items) &amp;&amp; items) items = {
            <span class="hljs-attr">includeDefaults</span>: <span class="hljs-literal">true</span>,
        }

        <span class="hljs-keyword">let</span> defs = <span class="hljs-keyword">this</span>.defs,
            defKeys = <span class="hljs-built_in">Object</span>.keys(defs),
            packetExclusions = <span class="hljs-keyword">this</span>.packetExclusions,
            packetExclusionsByRegex = <span class="hljs-keyword">this</span>.packetExclusionsByRegex,
            packetCoordinates = <span class="hljs-keyword">this</span>.packetCoordinates,
            packetObjects = <span class="hljs-keyword">this</span>.packetObjects,
            packetFunctions = <span class="hljs-keyword">this</span>.packetFunctions,
            packetDefaultInclusions = items.includeDefaults || <span class="hljs-literal">false</span>,
            copy = {};

        <span class="hljs-keyword">if</span> (packetDefaultInclusions &amp;&amp; !<span class="hljs-built_in">Array</span>.isArray(packetDefaultInclusions)) {

            packetDefaultInclusions = <span class="hljs-built_in">Object</span>.keys(defs);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!packetDefaultInclusions) packetDefaultInclusions = [];

        <span class="hljs-built_in">Object</span>.entries(<span class="hljs-keyword">this</span>).forEach(<span class="hljs-function">(<span class="hljs-params">[key, val]</span>) =&gt;</span> {

            <span class="hljs-keyword">let</span> flag = <span class="hljs-literal">true</span>,
                test;

            <span class="hljs-keyword">if</span> (defKeys.indexOf(key) &lt; <span class="hljs-number">0</span>) flag = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (flag &amp;&amp; packetExclusions.indexOf(key) &gt;= <span class="hljs-number">0</span>) flag = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (flag) {

                test = packetExclusionsByRegex.some(<span class="hljs-function"><span class="hljs-params">reg</span> =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(reg).test(key));
                <span class="hljs-keyword">if</span> (test) flag = <span class="hljs-literal">false</span>;
            }

            <span class="hljs-keyword">if</span> (flag) {

                <span class="hljs-keyword">if</span> (packetFunctions.indexOf(key) &gt;= <span class="hljs-number">0</span>) {

                    <span class="hljs-keyword">if</span> (xt(val) &amp;&amp; val !== <span class="hljs-literal">null</span>) {

                        <span class="hljs-keyword">let</span> func = <span class="hljs-keyword">this</span>.stringifyFunction(val);

                        <span class="hljs-keyword">if</span> (func &amp;&amp; func.length) copy[key] = func;
                    }
                }

                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packetObjects.indexOf(key) &gt;= <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>[key] &amp;&amp; <span class="hljs-keyword">this</span>[key].name) copy[key] = <span class="hljs-keyword">this</span>[key].name;

                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packetCoordinates.indexOf(key) &gt;= <span class="hljs-number">0</span>) {

                    <span class="hljs-keyword">if</span> (packetDefaultInclusions.indexOf(key) &gt;= <span class="hljs-number">0</span>) copy[key] = val;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val[<span class="hljs-number">0</span>] || val[<span class="hljs-number">1</span>]) copy[key] = val;
                }

                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Start cascade down to factory to pick up factory-specific exclusions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    test = <span class="hljs-keyword">this</span>.processPacketOut(key, val, packetDefaultInclusions);
                    <span class="hljs-keyword">if</span> (test) copy[key] = val;
                }
            } 
        }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Start cascade down to factory to complete the copy object’s build</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        copy = <span class="hljs-keyword">this</span>.finalizePacketOut(copy, items);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return a JSON string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify([<span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.type, <span class="hljs-keyword">this</span>.lib, copy]);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Helper functions that get defined in various mixins and factories - localizing the functionality to meet the specific needs of that factory’s object instances</p>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><code>stringifyFunction</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.stringifyFunction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>The dotAll /s regex flag currently not supported by Firefox
let matches = val.toString().match(/((.<em>?)).*?{(.</em>)}/s);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> matches = val.toString().match(<span class="hljs-regexp">/\(([\s\S]*?)\)[\s\S]*?\{([\s\S]*)\}/</span>);
        <span class="hljs-keyword">let</span> vars = matches[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">let</span> func = matches[<span class="hljs-number">2</span>];

        <span class="hljs-keyword">return</span> (xta(vars, func)) ? <span class="hljs-string">`<span class="hljs-subst">${vars}</span>~~~<span class="hljs-subst">${func}</span>`</span> : <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><code>processPacketOut</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.processPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (includes.indexOf(key) &lt; <span class="hljs-number">0</span> &amp;&amp; value === <span class="hljs-keyword">this</span>.defs[key]) result = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">return</span> result;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>finalizePacketOut</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.finalizePacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

        <span class="hljs-keyword">return</span> copy;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>importPacket</code> - Import and unpack a string representation of a factory object using the <strong>saveAsPacket</strong> function.</p>
<ul>
<li>Uses <strong>fetch</strong>, thus is an asynchronous process and returns a promise</li>
<li>Once we have the packet, we can further action it using actionPacket() </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.importPacket = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

        <span class="hljs-keyword">const</span> getPacket = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">url</span>) </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

                <span class="hljs-keyword">let</span> report;

                <span class="hljs-keyword">if</span> (!url.substring) reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Packet url supplied for import is not a string'</span>));

                <span class="hljs-keyword">if</span> (url[<span class="hljs-number">0</span>] === <span class="hljs-string">'['</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Looks like we already have a packet for processing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    report = self.actionPacket(url);
                    <span class="hljs-keyword">if</span> (report &amp;&amp; report.lib) resolve(report);
                    <span class="hljs-keyword">else</span> reject(report);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>This is not much of a test …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url.indexOf(<span class="hljs-string">'"name":'</span>) &gt;= <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Looks like we have a packet for processing, but it’s malformed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Bad packet supplied for import'</span>));
                }
                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Attempt to fetch the packet from a remote server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    fetch(url)
                    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                        <span class="hljs-keyword">if</span> (!res.ok) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Packet import from server failed - <span class="hljs-subst">${res.status}</span>: <span class="hljs-subst">${res.statusText}</span> - <span class="hljs-subst">${res.url}</span>`</span>);
                        <span class="hljs-keyword">return</span> res.text();
                    })
                    .then(<span class="hljs-function"><span class="hljs-params">packet</span> =&gt;</span> {

                        report = self.actionPacket(packet);
                        <span class="hljs-keyword">if</span> (report &amp;&amp; report.lib) resolve(report);
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> report;
                    })
                    .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> reject(error));
                }
            });
        };

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(items)) {

            <span class="hljs-keyword">let</span> promises = [];

            items.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> promises.push(getPacket(item)));

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

                <span class="hljs-built_in">Promise</span>.all(promises)
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> resolve(res))
                .catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> reject(error));
            });
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (items.substring) <span class="hljs-keyword">return</span> getPacket(items);
        <span class="hljs-keyword">else</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Argument supplied for packet import is not a string or array of strings'</span>));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>actionPacket</code> - This function:</p>
<ol>
<li>Unpacks the packet</li>
<li>Determines whether an artefact/asset/style/tween/etc of this packet’s name already exists</li>
<li>If we have existence, set the artefact/asset/style/tween/etc with the packet’s data</li>
<li>If we have no existence, create the artefact/asset/style/tween/etc</li>
<li>Returns the affected artefact/asset/style/tween/etc on success; false otherwise</li>
</ol>
<p>The function can be called directly on any Scrawl-canvas object that uses the base.js mixin - which means that all differing functionality for various types of object have to remain here, in base.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.actionPacketExclusions = [<span class="hljs-string">'Image'</span>, <span class="hljs-string">'Sprite'</span>, <span class="hljs-string">'Video'</span>, <span class="hljs-string">'Canvas'</span>, <span class="hljs-string">'Stack'</span>];
    P.actionPacket = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">packet</span>) </span>{

        <span class="hljs-keyword">try</span> {

            <span class="hljs-keyword">if</span> (packet &amp;&amp; packet.substring) {

                <span class="hljs-keyword">if</span> (packet[<span class="hljs-number">0</span>] === <span class="hljs-string">'['</span>) {

                    <span class="hljs-keyword">let</span> name, type, lib, update;

                    <span class="hljs-keyword">try</span> {

                        [name, type, lib, update] = <span class="hljs-built_in">JSON</span>.parse(packet);
                    }
                    <span class="hljs-keyword">catch</span> (e) {

                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to process packet due to JSON parsing error - <span class="hljs-subst">${e.message}</span>`</span>);
                    }

                    <span class="hljs-keyword">if</span> (xta(name, type, lib, update)) {

                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.actionPacketExclusions.indexOf(type) &gt;= <span class="hljs-number">0</span>) {

                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to process packet - Stacks, Canvases and visual assets are excluded from the packet system`</span>);
                        }

                        <span class="hljs-keyword">let</span> obj = library[lib][name];

                        <span class="hljs-keyword">if</span> (obj) obj.set(update);
                        <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Stack-based artefacts need a DOM element that they can pass into the factory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (update.outerHTML &amp;&amp; update.host) {

                                <span class="hljs-keyword">let</span> myParent = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">`#<span class="hljs-subst">${update.host}</span>`</span>);

                                <span class="hljs-keyword">if</span> (myParent) {

                                    <span class="hljs-keyword">let</span> tempEl = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);

                                    tempEl.innerHTML = update.outerHTML;

                                    <span class="hljs-keyword">let</span> myEl = tempEl.firstElementChild;

                                    <span class="hljs-keyword">if</span> (myEl) {

                                        myEl.id = name;

                                        myParent.appendChild(myEl);

                                        update.domElement = myEl;
                                    }
                                }
                            }

                            obj = <span class="hljs-keyword">new</span> library.constructors[type](update);

                            <span class="hljs-keyword">if</span> (!obj) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Failed to create Scrawl-canvas object from supplied packet'</span>);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>For the main object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        obj.packetFunctions.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-keyword">this</span>.actionPacketFunctions(obj, item));</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>For artefact anchors - I know that anchors only have the one function to worry about, but doing it this way so I don’t forget how to approach it eg for SC sub-objects that have more than one user-settable function (eg timeline actions)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (update.anchor &amp;&amp; obj.anchor) {

                            obj.anchor.packetFunctions.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Anchor.setters.clickAction(arg) explicitly checks that the supplied arg is a function - if it isn’t (like in packet cases) then the attribute doesn’t get updated when we invoke <em>obj.set(update);</em> earlier in this function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                obj.anchor[item] = update.anchor[item];
                                <span class="hljs-keyword">this</span>.actionPacketFunctions(obj.anchor, item)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Anchors are a bit of an exception case because they add a user-interactive and yet otherwise untracked DOM element to the page, which has to be updated in its own sweet, special way…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                obj.anchor.build();
                            });
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Specific to Phrase entitys, which doesn’t include a simple way to set or update glyphStyle objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (update.glyphStyles &amp;&amp; obj.glyphStyles) {

                            update.glyphStyles.forEach(<span class="hljs-function">(<span class="hljs-params">gStyle, index</span>) =&gt;</span> {

                                <span class="hljs-keyword">if</span> (isa_obj(gStyle)) obj.setGlyphStyles(gStyle, index);
                            });
                        }

                        <span class="hljs-keyword">if</span> (obj) <span class="hljs-keyword">return</span> obj;
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Failed to process supplied packet'</span>);
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Failed to process packet - JSON string holds incomplete data'</span>);
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Failed to process packet - JSON string does not represent an array'</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Failed to process packet - not a JSON string'</span>);
        }
        <span class="hljs-keyword">catch</span> (e) { <span class="hljs-built_in">console</span>.log(e); <span class="hljs-keyword">return</span> e }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><code>actionPacketFunctions</code> - internal helper function - creates functions from Strings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.actionPacketFunctions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, item</span>) </span>{

        <span class="hljs-keyword">let</span> fItem = obj[item];

        <span class="hljs-keyword">if</span> (xt(fItem) &amp;&amp; fItem !== <span class="hljs-literal">null</span> &amp;&amp; fItem.substring) {

            <span class="hljs-keyword">if</span> (fItem === <span class="hljs-string">'~~~'</span>) obj[item] = λ<span class="hljs-literal">null</span>;
            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">let</span> args, func, f;

                [args, func] = fItem.split(<span class="hljs-string">'~~~'</span>);

                args = args.split(<span class="hljs-string">','</span>);
                args = args.map(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.trim());</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Native code raises non-terminal errors (because it is native code!) - so we dodge that bullet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (func.indexOf(<span class="hljs-string">'[native code]'</span>) &lt; <span class="hljs-number">0</span>) {

                    f = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(...args, func);

                    obj[item] = f.bind(obj);
                }
                <span class="hljs-keyword">else</span> obj[item] = λ<span class="hljs-literal">null</span>;
            }
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>
<p>Most Scrawl-canvas factory objects can be copied using the <strong>clone</strong> function. The result will be an exact copy of the original, additionally set with values supplied in the argument object.</p>
<pre><code>scrawl.artefact.myelement.clone({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'myclonedelement'</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-number">60</span>,
});</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><code>clone</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.clone = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">let</span> myName = <span class="hljs-keyword">this</span>.name,
            myPacket, myTicker, myAnchor;

        <span class="hljs-keyword">this</span>.name = items.name || <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Tickers are specific to Tween and Action objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (items.useNewTicker) {

            myTicker = <span class="hljs-keyword">this</span>.ticker;
            <span class="hljs-keyword">this</span>.ticker = <span class="hljs-literal">null</span>;
            myPacket = <span class="hljs-keyword">this</span>.saveAsPacket();
            <span class="hljs-keyword">this</span>.ticker = myTicker;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Everything else</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> myPacket = <span class="hljs-keyword">this</span>.saveAsPacket();

        <span class="hljs-keyword">this</span>.name = myName;

        <span class="hljs-keyword">let</span> clone = <span class="hljs-keyword">this</span>.actionPacket(myPacket);

        <span class="hljs-keyword">this</span>.packetFunctions.forEach(<span class="hljs-function"><span class="hljs-params">func</span> =&gt;</span> {

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[func]) clone[func] = <span class="hljs-keyword">this</span>[func];
        });

        clone = <span class="hljs-keyword">this</span>.postCloneAction(clone, items);

        clone.set(items);

        <span class="hljs-keyword">return</span> clone;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><code>postCloneAction</code> - overwritten by a variety of mixins and factories</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.postCloneAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">clone, items</span>) </span>{

        <span class="hljs-keyword">return</span> clone;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p><code>kill</code> - overwritten by various mixins and factories</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.kill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deregister();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>
<p><code>makeName</code> - If the developer doesn’t supply a name value for a factory function, then Scrawl-canvas will generate a random name for the object to use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.makeName = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item &amp;&amp; item.substring &amp;&amp; library[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.lib}</span>names`</span>].indexOf(item) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.name = item;                
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.name = generateUuid();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><code>register</code> - Many (but not all) factory functions will register their result objects in the scrawl lobrary. The section where the object is stored is dependent on the factory function’s type value. </p>
<ul>
<li>Some objects are stored in more than one place - for example the artefacts section will include Stack, Element and Canvas objects in addition to various Entity objects</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.register = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (!xt(<span class="hljs-keyword">this</span>.name)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`core/base error - register() name not set: <span class="hljs-subst">${<span class="hljs-keyword">this</span>}</span>`</span>);

        <span class="hljs-keyword">let</span> arr = library[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.lib}</span>names`</span>],
            mylib = library[<span class="hljs-keyword">this</span>.lib];

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isArtefact){

            pushUnique(library.artefactnames, <span class="hljs-keyword">this</span>.name);
            library.artefact[<span class="hljs-keyword">this</span>.name] = <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isAsset){

            pushUnique(library.assetnames, <span class="hljs-keyword">this</span>.name);
            library.asset[<span class="hljs-keyword">this</span>.name] = <span class="hljs-keyword">this</span>;
        }

        pushUnique(arr, <span class="hljs-keyword">this</span>.name);
        mylib[<span class="hljs-keyword">this</span>.name] = <span class="hljs-keyword">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><code>deregister</code> - Reverse what register() does</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.deregister = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (!xt(<span class="hljs-keyword">this</span>.name)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`core/base error - deregister() name not set: <span class="hljs-subst">${<span class="hljs-keyword">this</span>}</span>`</span>);

        <span class="hljs-keyword">let</span> arr = library[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.lib}</span>names`</span>],
            mylib = library[<span class="hljs-keyword">this</span>.lib];

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isArtefact){

            removeItem(library.artefactnames, <span class="hljs-keyword">this</span>.name);
            <span class="hljs-keyword">delete</span> library.artefact[<span class="hljs-keyword">this</span>.name];
        }

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isAsset){

            removeItem(library.assetnames, <span class="hljs-keyword">this</span>.name);
            <span class="hljs-keyword">delete</span> library.asset[<span class="hljs-keyword">this</span>.name];
        }

        removeItem(arr, <span class="hljs-keyword">this</span>.name);
        <span class="hljs-keyword">delete</span> mylib[<span class="hljs-keyword">this</span>.name];

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Return the prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> P;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
