<!DOCTYPE html>

<html>
<head>
  <title>Core user interaction</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="../mixin/shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter-stringed.html">
                  ./source/worker/filter-stringed.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
                
                <a class="source" href="../worker/filter_canvas.html">
                  ./source/worker/filter_canvas.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="core-user-interaction">Core user interaction</h1>
<p>A set of functions that are closely tied to the <a href="./document.html">core/document.js</a> functionality, and a couple of additional coder convenience functions.</p>
<p>Scrawl-canvas adds some event listeners (mouse movement, screen resize, scrolling) to the window object. These help maintain a centralizerd mouse/touch cursor tracking facility that updates here and then cascades and localizes to artefacts (stacks, canvases and element wrapper objects) which need to keep track of a <strong>local, immediately updated mouse/touch coordinate</strong>.</p>
<p>Checks to see if events have occurred happen once per requestAnimationFrame tick - this is to choke the more eager event listeners which can, at times, fire thousands of times a second.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> library <span class="hljs-keyword">from</span> <span class="hljs-string">"./library.js"</span>;
<span class="hljs-keyword">import</span> { xt, xta, isa_dom, λ<span class="hljs-literal">null</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utilities.js"</span>;
<span class="hljs-keyword">import</span> { addListener, addNativeListener, removeListener, removeNativeListener } <span class="hljs-keyword">from</span> <span class="hljs-string">"./events.js"</span>;

<span class="hljs-keyword">import</span> { makeAnimation } <span class="hljs-keyword">from</span> <span class="hljs-string">"../factory/animation.js"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><code>Exported array</code> (to modules). DOM element wrappers subscribe for updates by adding themselves to the <strong>uiSubscribedElements</strong> array. When an event fires, the updated data will be pushed to them automatically</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> uiSubscribedElements = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Local boolean flags. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> trackMouse = <span class="hljs-literal">false</span>,
    mouseChanged = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>Exported object</code> (to modules and the scrawl object). The <strong>currentCorePosition</strong> object holds the <strong>global</strong> mouse cursor position, alongside browser view dimensions and scroll position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> currentCorePosition = {
    <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollX</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollY</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">w</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">h</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'mouse'</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>resizeAction</strong> function - to check if a view resize has occurred; if yes, flag that currentCorePosition object needs to be updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> resizeAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

    <span class="hljs-keyword">let</span> w = <span class="hljs-built_in">document</span>.documentElement.clientWidth,
        h = <span class="hljs-built_in">document</span>.documentElement.clientHeight;

    <span class="hljs-keyword">if</span> (currentCorePosition.w !== w || currentCorePosition.h !== h) {
        currentCorePosition.w = w;
        currentCorePosition.h = h;
        mouseChanged = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>scrollAction</strong> function - to check if a view scroll has occurred; if yes, flag that currentCorePosition object needs to be updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> scrollAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

    <span class="hljs-keyword">let</span> x = <span class="hljs-built_in">window</span>.pageXOffset,
        y = <span class="hljs-built_in">window</span>.pageYOffset;

    <span class="hljs-keyword">if</span> (currentCorePosition.scrollX !== x || currentCorePosition.scrollY !== y) {
        currentCorePosition.x += (x - currentCorePosition.scrollX);
        currentCorePosition.y += (y - currentCorePosition.scrollY);
        currentCorePosition.scrollX = x;
        currentCorePosition.scrollY = y;
        mouseChanged = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong>moveAction</strong> function - to check if mouse cursor position has changed; if yes, update currentCorePosition object and flag that the updated needs to cascade to subscribed elements at the next RAF invocation.</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The events that trigger this function (pointermove, pointerup, pointerdown, pointerleave, pointerenter; or mousemove, mouseup, mousedown, mouseleave, mouseenter) are tied to the window object, not to any particular DOM element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> moveAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

    <span class="hljs-keyword">let</span> x = <span class="hljs-built_in">Math</span>.round(e.pageX),
        y = <span class="hljs-built_in">Math</span>.round(e.pageY);

    <span class="hljs-keyword">if</span> (currentCorePosition.x !== x || currentCorePosition.y !== y) {
        currentCorePosition.type = (navigator.pointerEnabled) ? <span class="hljs-string">'pointer'</span> : <span class="hljs-string">'mouse'</span>;
        currentCorePosition.x = x;
        currentCorePosition.y = y;
        mouseChanged = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>touchAction</strong> function - maps touch coordinates to the mouse cursor position (via currentCorePosition) and then immediately invokes a cascade update action to all subscribed elements.</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The events that trigger this function (touchstart, touchmove, touchend, touchcancel) are tied to the window object, not to any particular DOM element.</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Note: this is different to mouse moveAction, which is choked via an animation object so update checks happen on each requestAnimationFrame. </p>
<p>TODO: Need to keep an eye on how many times touchAction gets run, for example during a touch-driven drag-and-drop action. If necessary, add a Date.now mediated choke to the check (say minimum 15ms between checks?) to minimize impact on the wider Scrawl-canvas ecosystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> touchAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

    <span class="hljs-keyword">if</span> (e.type === <span class="hljs-string">'touchstart'</span> || e.type === <span class="hljs-string">'touchmove'</span>) {

        <span class="hljs-keyword">if</span> (e.touches &amp;&amp; e.touches[<span class="hljs-number">0</span>]) {

            <span class="hljs-keyword">let</span> touch = e.touches[<span class="hljs-number">0</span>],
                x = <span class="hljs-built_in">Math</span>.round(touch.pageX),
                y = <span class="hljs-built_in">Math</span>.round(touch.pageY);

            <span class="hljs-keyword">if</span> (currentCorePosition.x !== x || currentCorePosition.y !== y) {
                currentCorePosition.type = <span class="hljs-string">'touch'</span>;
                currentCorePosition.x = x;
                currentCorePosition.y = y;
                updateUiSubscribedElements();
            }
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Functions to update uiSubscribedElements attached to specified DOM elements. Each stack or canvas element tracked by Scrawl-canvas will include a local <strong>here</strong> object which includes details of the element’s current dimensions, relative position, and the position of the mouse cursor in relation to its top-left corner. These all need to be updated whenever there’s a resize, scroll or cursor movement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> updateUiSubscribedElements = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    uiSubscribedElements.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> updateUiSubscribedElement(item));
};

<span class="hljs-keyword">const</span> updateUiSubscribedElement = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">art</span>) </span>{

    <span class="hljs-keyword">let</span> dom = library.artefact[art];
    <span class="hljs-keyword">if</span> (!xt(dom)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`core/userInteraction updateUiSubscribedElement() error - artefact does not exist: <span class="hljs-subst">${art}</span>`</span>);

    <span class="hljs-keyword">let</span> el = dom.domElement;
    <span class="hljs-keyword">if</span> (!isa_dom(el)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`core/userInteraction updateUiSubscribedElement() error - DOM element missing: <span class="hljs-subst">${art}</span>`</span>);

    <span class="hljs-keyword">let</span> dims = el.getBoundingClientRect(),
        dox = <span class="hljs-built_in">Math</span>.round(dims.left + <span class="hljs-built_in">window</span>.pageXOffset),
        doy = <span class="hljs-built_in">Math</span>.round(dims.top + <span class="hljs-built_in">window</span>.pageYOffset);

    <span class="hljs-keyword">if</span> (!dom.here) dom.here = {}; 

    <span class="hljs-keyword">let</span> here = dom.here;

    here.x = <span class="hljs-built_in">Math</span>.round(currentCorePosition.x - dox);
    here.y = <span class="hljs-built_in">Math</span>.round(currentCorePosition.y - doy);
    here.w = <span class="hljs-built_in">Math</span>.round(dims.width);
    here.h = <span class="hljs-built_in">Math</span>.round(dims.height);
    here.normX = (here.w) ? here.x / here.w : <span class="hljs-literal">false</span>;
    here.normY = (here.h) ? here.y / here.h : <span class="hljs-literal">false</span>;
    here.offsetX = dox;
    here.offsetY = doy;
    here.type = currentCorePosition.type;
    here.active = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (here.normX &lt; <span class="hljs-number">0</span> || here.normX &gt; <span class="hljs-number">1</span> || here.normY &lt; <span class="hljs-number">0</span> || here.normY &gt; <span class="hljs-number">1</span>) here.active = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (dom.type === <span class="hljs-string">'Canvas'</span>) dom.updateBaseHere(here, dom.fit);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Automatically check for element resize</p>
<ul>
<li>The artefact’s <code>checkForResize</code> flag needs to be set</li>
<li>We ignore resizing actions while dimensions-related dirty flags are set (to prevent getting ourselves into a continuous feedback loop)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (dom.checkForResize &amp;&amp; !dom.dirtyDimensions &amp;&amp; !dom.dirtyDomDimensions) {

        <span class="hljs-keyword">let</span> [w, h] = dom.currentDimensions;

        <span class="hljs-keyword">if</span> (dom.type === <span class="hljs-string">'Canvas'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Regardless of the setting of &lt;canvas&gt; element’s <code>boxSizing</code> style attribute:</p>
<ul>
<li>It will include padding and borders in its <code>getBoundingClientRect</code> object (and its <code>getComputedStyle</code> width/height values), but these are specifically excluded from the element’s <code>width</code> and <code>height</code> attributes</li>
<li>Which leads to the normal resize test - <code>if (w !== here.w || h !== here.h)</code> - triggering on every mouse/scroll/resize event, which in turn leads to the canvas dimensions increasing uncontrollably.</li>
<li>Solved by subtracting padding/border values from the <code>getBoundingClientRect</code> dimension values before performing the test.</li>
<li>Tested in Demo <a href="../../demo/canvas-004.html">Canvas-004</a>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!dom.computedStyles) dom.computedStyles = <span class="hljs-built_in">window</span>.getComputedStyle(dom.domElement);

            <span class="hljs-keyword">let</span> s = dom.computedStyles,
                hw = <span class="hljs-built_in">Math</span>.floor(here.w - <span class="hljs-built_in">parseFloat</span>(s.borderLeftWidth) - <span class="hljs-built_in">parseFloat</span>(s.borderRightWidth) - <span class="hljs-built_in">parseFloat</span>(s.paddingLeft) - <span class="hljs-built_in">parseFloat</span>(s.paddingRight)),
                hh = <span class="hljs-built_in">Math</span>.floor(here.h - <span class="hljs-built_in">parseFloat</span>(s.borderTopWidth) - <span class="hljs-built_in">parseFloat</span>(s.borderBottomWidth) - <span class="hljs-built_in">parseFloat</span>(s.paddingTop) - <span class="hljs-built_in">parseFloat</span>(s.paddingBottom));

            <span class="hljs-keyword">if</span> (w !== hw || h !== hh) {

                dom.set({

                    <span class="hljs-attr">dimensions</span>: [hw, hh],
                });
            }
        }
        <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Stack and Element artefacts resize test.</p>
<ul>
<li>Tested in Demo <a href="../../demo/dom-011.html">DOM-011</a>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (w !== here.w || h !== here.h) {

                dom.set({

                    <span class="hljs-attr">dimensions</span>: [here.w, here.h],
                });
            }
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Animation object which checks whether any window event listeners have fired, and actions accordingly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> coreListenersTracker = makeAnimation({

    <span class="hljs-attr">name</span>: <span class="hljs-string">'coreListenersTracker'</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">delay</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">fn</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (!uiSubscribedElements.length) resolve(<span class="hljs-literal">false</span>);

            <span class="hljs-keyword">if</span> (trackMouse &amp;&amp; mouseChanged) {

                mouseChanged = <span class="hljs-literal">false</span>;
                updateUiSubscribedElements();
            }

            resolve(<span class="hljs-literal">true</span>);
        });
    },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>Exported functions</code> (to modules and the scrawl object). Event listeners can be a drain on web page efficiency. If a web page contains only static canvas (and/or stack) displays, with no requirement for user interaction, we can minimize Scrawl-canvas’s impact on those pages by switching off the core listeners (and also the core animation loop).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> startCoreListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    actionCoreListeners(<span class="hljs-string">'removeEventListener'</span>);
    actionCoreListeners(<span class="hljs-string">'addEventListener'</span>);

    trackMouse = <span class="hljs-literal">true</span>;
    mouseChanged = <span class="hljs-literal">true</span>;
    coreListenersTracker.run();
};

<span class="hljs-keyword">const</span> stopCoreListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    trackMouse = <span class="hljs-literal">false</span>;
    mouseChanged = <span class="hljs-literal">false</span>;
    coreListenersTracker.halt();

    actionCoreListeners(<span class="hljs-string">'removeEventListener'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> actionCoreListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">action</span>) </span>{

    <span class="hljs-keyword">if</span> (navigator.pointerEnabled || navigator.msPointerEnabled) {

        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'pointermove'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'pointerup'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'pointerdown'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'pointerleave'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'pointerenter'</span>, moveAction, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">else</span> {

        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'mousemove'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'mouseup'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'mousedown'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'mouseleave'</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'mouseenter'</span>, moveAction, <span class="hljs-literal">false</span>);

        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'touchmove'</span>, touchAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'touchstart'</span>, touchAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'touchend'</span>, touchAction, <span class="hljs-literal">false</span>);
        <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'touchcancel'</span>, touchAction, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'scroll'</span>, scrollAction, <span class="hljs-literal">false</span>);
    <span class="hljs-built_in">window</span>[action](<span class="hljs-string">'resize'</span>, resizeAction, <span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><code>Exported functions</code> (to modules). Invoke the resize and/or scroll event listeners once, outside the regular requestAnimationFrame tick.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> applyCoreResizeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    resizeAction();
    mouseChanged = <span class="hljs-literal">true</span>;
};

<span class="hljs-keyword">const</span> applyCoreScrollListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    scrollAction();
    mouseChanged = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="convenience-functions">Convenience functions</h4>
<p>Okay, so I got very bored of writing boilerplate to react to various form elements user interactions across the demos. So I wrote some functions to setup (and take down) batches of DOM event listeners to make my life easier. These are:</p>
<ul>
<li>scrawl.addNativeListener()</li>
<li>scrawl.removeNativeListener()</li>
</ul>
<p>Then there was the use case for reacting to various mouse (and touch) events, so I bundled all those up into a set of complementary functions:</p>
<ul>
<li>scrawl.addListener()</li>
<li>scrawl.removeListener()</li>
</ul>
<p>Even so, there was still a lot of boilerplate code to write, in particular to listening for user interaction with form elements (which can be anywhere on the web page). So I further factorised that code into an <strong>observeAndUpdate</strong> function which uses the listener functions internally.</p>
<p>I have no idea how useful the observeAndUpdate function will be to anyone else. All I know is that it works for me and my demos, and that makes me happy.</p>
<p>Note: observeAndUpdate() returns a function that will (in theory) remove all the bundled event listeners from their DOM elements when it is invoked. Not yet tested.</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><code>Exported function</code> (to modules and the scrawl object). Capture changes in a form and apply them to a target Scrawl-canvas artefact, asset, style, group, etc object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> observeAndUpdate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (!xta(items.event, items.origin, items.updates)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> target = (items.target.substring &amp;&amp; items.targetLibrarySection) ?
        library[items.targetLibrarySection][items.target] :
        items.target;

    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> event = items.event,
        origin = items.origin;

    <span class="hljs-keyword">let</span> listener = (items.useNativeListener) ? addNativeListener : addListener,
        killListener = (items.useNativeListener) ? removeNativeListener : removeListener;

    <span class="hljs-keyword">let</span> stop = λ<span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (items.preventDefault) {

        stop = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {

            e.preventDefault();
            e.returnValue = <span class="hljs-literal">false</span>;
        };
    }

    <span class="hljs-keyword">let</span> func = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

        stop(e);

        <span class="hljs-keyword">let</span> id = (e &amp;&amp; e.target) ? e.target.id : <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (id) {

            <span class="hljs-keyword">let</span> updates = items.updates,
                actionArray = updates[id];

            <span class="hljs-keyword">if</span> (actionArray) {

                <span class="hljs-keyword">let</span> actionAttribute = actionArray[<span class="hljs-number">0</span>],
                    action = actionArray[<span class="hljs-number">1</span>],
                    targetVal = e.target.value,
                    actionFlag = <span class="hljs-literal">true</span>,
                    val;

                <span class="hljs-keyword">switch</span> (action) {

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'float'</span> :
                        val = <span class="hljs-built_in">parseFloat</span>(targetVal);
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'int'</span> :
                        val = <span class="hljs-built_in">parseInt</span>(targetVal, <span class="hljs-number">10</span>);
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'round'</span> :
                        val = <span class="hljs-built_in">Math</span>.round(targetVal);
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'roundDown'</span> :
                        val = <span class="hljs-built_in">Math</span>.floor(targetVal);
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'roundUp'</span> :
                        val = <span class="hljs-built_in">Math</span>.ceil(targetVal);
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'raw'</span> :
                        val = targetVal;
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span> :
                        val = <span class="hljs-string">`<span class="hljs-subst">${targetVal}</span>`</span>;
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">'boolean'</span> :
                        <span class="hljs-keyword">if</span> (xt(targetVal)) {

                            <span class="hljs-keyword">if</span> (targetVal.substring) {

                                <span class="hljs-keyword">if</span> (<span class="hljs-string">'true'</span> === targetVal.toLowerCase()) val = <span class="hljs-literal">true</span>;
                                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'false'</span> === targetVal.toLowerCase()) val = <span class="hljs-literal">false</span>;
                                <span class="hljs-keyword">else</span> val = (<span class="hljs-built_in">parseFloat</span>(targetVal)) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                            }
                            <span class="hljs-keyword">else</span> val = (targetVal) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                        }
                        <span class="hljs-keyword">else</span> val = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">default</span> :
                        <span class="hljs-keyword">if</span> (action.substring) val = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">parseFloat</span>(targetVal)}</span><span class="hljs-subst">${action}</span>`</span>;
                        <span class="hljs-keyword">else</span> actionFlag = <span class="hljs-literal">false</span>;
                }

                <span class="hljs-keyword">if</span> (actionFlag) {

                    <span class="hljs-keyword">if</span> (target.type === <span class="hljs-string">'Group'</span>) {

                        target.setArtefacts({
                            [actionAttribute]: val
                        });
                    }
                    <span class="hljs-keyword">else</span> {

                        target.set({
                            [actionAttribute]: val
                        });
                    }
                }
            }
        }
    };

    <span class="hljs-keyword">let</span> kill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        killListener(event, func, origin);
    };

    listener(event, func, origin);

    <span class="hljs-keyword">return</span> kill;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4 id="drag-and-drop-zones">Drag-and-drop zones.</h4>
<p><strong>makeDragZone</strong> is an attempt to make setting up drag-and-drop functionality within a Scrawl-canvas stack or canvas as simple as possible</p>
<p>Required attribute of the argument object:</p>
<ul>
<li><strong>.zone</strong> - either the String name of the Stack or Canvas artefact which will host the zone, or the Stack or Canvas artefact itself</li>
</ul>
<p>Optional argument object attributes:</p>
<ul>
<li><strong>.coodinateSource</strong> - the .here object of whatever artefact/asset (Stack, Canvas, Element or Cell) will be supplying the coordinates. Defaults to the .here object of either the Stack zone, or the .here object of the Canvas zone’s base Cell.</li>
<li><strong>.collisionGroup</strong> - the group containg the draggable artefacts, or that Group object’s name String. Defaults to the Stack zone’s Group object, or the Canvas’s base Cell’s Group object.</li>
<li><strong>.startOn</strong> - one of ‘move’, ‘up’, ‘down’, ‘enter’, ‘leave’, or an array of a selection of those strings. Defaults to ‘down’</li>
<li><strong>.updateOnStart</strong> - an Object containing changes to be made (via set) to the artefact when it is picked up</li>
<li><strong>.endOn</strong> - one of ‘move’, ‘up’, ‘down’, ‘enter’, ‘leave’, or an array of a selection of those strings. Defaults to ‘up’</li>
<li><strong>.updateOnEnd</strong> - an Object containing changes to be made (via set) to the artefact when it is dropped</li>
<li><strong>.exposeCurrentArtefact</strong> boolean. Defaults to false</li>
</ul>
<p>If the exposeCurrentArtefact attribute is true, the function returns a function that can be invoked at any time to get the collision data object (containing x, y, artefact attributes) for the artefact being dragged (false if nothing is being dragged). </p>
<p>Invoking the returned function with a single argument that evaluates to true will trigger the kill function.</p>
<p>If the exposeCurrentArtefact attribute is false, or omitted, the function returns a kill function that can be invoked to remove the event listeners from the Stack or Canvas zone’s DOM element.</p>
<p>NOTE: drag-and-drop functionality using this factory function <strong>is not guaranteed</strong> for artefacts referencing a path, or for artefacts whose reference artefact in turn references another artefact in any way.</p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>Exported function</code> (to modules and the scrawl object). Add drag-and-drop functionality to a canvas or stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeDragZone = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (!items.zone) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> target = (items.zone.substring) ? artefact[items.zone] : items.zone;

    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> targetElement = target.domElement,
        coordinateSource, 
        collisionGroup = (items.collisionGroup &amp;&amp; items.collisionGroup.substring) ? library.group[items.collisionGroup] : items.collisionGroup, 
        startOn = (items.startOn) ? items.startOn : [<span class="hljs-string">'down'</span>],
        endOn = (items.endOn) ? items.endOn : [<span class="hljs-string">'up'</span>];

    <span class="hljs-keyword">if</span> (target.type === <span class="hljs-string">'Stack'</span>) {

        coordinateSource = items.coordinateSource;
        <span class="hljs-keyword">if</span> (!coordinateSource) coordinateSource = target.here;

        collisionGroup = items.collisionGroup;
        <span class="hljs-keyword">if</span> (!collisionGroup) collisionGroup = library.group[target.name];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collisionGroup.substring) collisionGroup = library.group[collisionGroup];
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target.type === <span class="hljs-string">'Canvas'</span>) {

        coordinateSource = items.coordinateSource;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Generally the system won’t have had time to establish target.base.here, if the dragzone is defined as part of setup before a Display cycle has completed - so the test gets repeated in the pickup function below, to capture those cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!coordinateSource) coordinateSource = target.base.here;

        collisionGroup = items.collisionGroup;
        <span class="hljs-keyword">if</span> (!collisionGroup) collisionGroup = library.group[target.base.name];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collisionGroup.substring) collisionGroup = library.group[collisionGroup];
    }

    <span class="hljs-keyword">if</span> (!xta(targetElement, collisionGroup)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> current = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> pickup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

        <span class="hljs-keyword">if</span> (e.cancelable) {
            
            e.preventDefault();
            e.returnValue = <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">let</span> type = e.type;

        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'touchstart'</span> || type === <span class="hljs-string">'touchcancel'</span>) touchAction(e);

        <span class="hljs-keyword">if</span> (!coordinateSource &amp;&amp; target.type === <span class="hljs-string">'Canvas'</span>) coordinateSource = target.base.here;

        current = collisionGroup.getArtefactAt(coordinateSource);

        <span class="hljs-keyword">if</span> (current) {

            current.artefact.pickupArtefact(coordinateSource);
            <span class="hljs-keyword">if</span> (items.updateOnStart) current.artefact.set(items.updateOnStart);
        }
    };

    <span class="hljs-keyword">let</span> drop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{

        <span class="hljs-keyword">if</span> (e.cancelable) {

            e.preventDefault();
            e.returnValue = <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">if</span> (current) {

            current.artefact.dropArtefact();
            <span class="hljs-keyword">if</span> (items.updateOnEnd) current.artefact.set(items.updateOnEnd);
            current = <span class="hljs-literal">false</span>;
        }
    };

    <span class="hljs-keyword">let</span> kill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        removeListener(startOn, pickup, targetElement);
        removeListener(endOn, drop, targetElement);
    };

    <span class="hljs-keyword">let</span> getCurrent = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">actionKill = false</span>) </span>{

        <span class="hljs-keyword">if</span> (actionKill) kill();
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> current;
    };

    addListener(startOn, pickup, targetElement);
    addListener(endOn, drop, targetElement);

    <span class="hljs-keyword">if</span> (items.exposeCurrentArtefact) <span class="hljs-keyword">return</span> getCurrent;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> kill;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h4 id="exports">Exports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> {
    uiSubscribedElements,
    currentCorePosition,
    startCoreListeners,
    stopCoreListeners,
    applyCoreResizeListener,
    applyCoreScrollListener,
    observeAndUpdate,
    makeDragZone,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
