<!DOCTYPE html>

<html>
<head>
  <title>Core user interaction</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="animation-loop.html">
                  ./source/core/animation-loop.js
                </a>
              
                
                <a class="source" href="display-cycle.html">
                  ./source/core/display-cycle.js
                </a>
              
                
                <a class="source" href="document-root-elements.html">
                  ./source/core/document-root-elements.js
                </a>
              
                
                <a class="source" href="document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="random-seed.html">
                  ./source/core/random-seed.js
                </a>
              
                
                <a class="source" href="shared-vars.html">
                  ./source/core/shared-vars.js
                </a>
              
                
                <a class="source" href="snippets.html">
                  ./source/core/snippets.js
                </a>
              
                
                <a class="source" href="system-flags.html">
                  ./source/core/system-flags.js
                </a>
              
                
                <a class="source" href="user-interaction.html">
                  ./source/core/user-interaction.js
                </a>
              
                
                <a class="source" href="utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/array-pool.html">
                  ./source/factory/array-pool.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell-fragment.html">
                  ./source/factory/cell-fragment.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/cog.html">
                  ./source/factory/cog.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/conic-gradient.html">
                  ./source/factory/conic-gradient.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/crescent.html">
                  ./source/factory/crescent.js
                </a>
              
                
                <a class="source" href="../factory/drag-zone.html">
                  ./source/factory/drag-zone.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="../factory/filter-engine-bluenoise-data.html">
                  ./source/factory/filter-engine-bluenoise-data.js
                </a>
              
                
                <a class="source" href="../factory/filter-engine.html">
                  ./source/factory/filter-engine.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/font-attributes.html">
                  ./source/factory/font-attributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/image-asset.html">
                  ./source/factory/image-asset.js
                </a>
              
                
                <a class="source" href="../factory/keyboard-zone.html">
                  ./source/factory/keyboard-zone.js
                </a>
              
                
                <a class="source" href="../factory/line-spiral.html">
                  ./source/factory/line-spiral.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/mesh.html">
                  ./source/factory/mesh.js
                </a>
              
                
                <a class="source" href="../factory/net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="../factory/noise-asset.html">
                  ./source/factory/noise-asset.js
                </a>
              
                
                <a class="source" href="../factory/observe-update.html">
                  ./source/factory/observe-update.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/particle-force.html">
                  ./source/factory/particle-force.js
                </a>
              
                
                <a class="source" href="../factory/particle-history.html">
                  ./source/factory/particle-history.js
                </a>
              
                
                <a class="source" href="../factory/particle-spring.html">
                  ./source/factory/particle-spring.js
                </a>
              
                
                <a class="source" href="../factory/particle-world.html">
                  ./source/factory/particle-world.js
                </a>
              
                
                <a class="source" href="../factory/particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radial-gradient.html">
                  ./source/factory/radial-gradient.js
                </a>
              
                
                <a class="source" href="../factory/raw-asset.html">
                  ./source/factory/raw-asset.js
                </a>
              
                
                <a class="source" href="../factory/reaction-diffusion-asset.html">
                  ./source/factory/reaction-diffusion-asset.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/render-animation.html">
                  ./source/factory/render-animation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/sprite-asset.html">
                  ./source/factory/sprite-asset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstacked-element.html">
                  ./source/factory/unstacked-element.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/video-asset.html">
                  ./source/factory/video-asset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset-advanced-functionality.html">
                  ./source/mixin/asset-advanced-functionality.js
                </a>
              
                
                <a class="source" href="../mixin/asset-consumer.html">
                  ./source/mixin/asset-consumer.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/cell-key-functions.html">
                  ./source/mixin/cell-key-functions.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/display-shape.html">
                  ./source/mixin/display-shape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shape-basic.html">
                  ./source/mixin/shape-basic.js
                </a>
              
                
                <a class="source" href="../mixin/shape-curve.html">
                  ./source/mixin/shape-curve.js
                </a>
              
                
                <a class="source" href="../mixin/shape-path-calculation.html">
                  ./source/mixin/shape-path-calculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h1 id="core-user-interaction">Core user interaction</h1>
<p>A set of functions that are closely tied to the <a href="./document.html">core/document.js</a> functionality, and a couple of additional coder convenience functions.</p>
<p>Scrawl-canvas adds some event listeners (mouse movement, screen resize, scrolling) to the window object. These help maintain a centralizerd mouse/touch cursor tracking facility that updates here and then cascades and localizes to artefacts (stacks, canvases and element wrapper objects) which need to keep track of a <strong>local, immediately updated mouse/touch coordinate</strong>.</p>
<p>Checks to see if events have occurred happen once per requestAnimationFrame tick - this is to choke the more eager event listeners which can, at times, fire thousands of times a second.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> library <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./library.js&quot;</span>;

<span class="hljs-keyword">import</span> { isa_obj } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utilities.js&quot;</span>;

<span class="hljs-keyword">import</span> { addListener } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./events.js&quot;</span>;

<span class="hljs-keyword">import</span> { makeAnimation } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../factory/animation.js&quot;</span>;

<span class="hljs-keyword">import</span> { getTrackMouse, setTrackMouse, getMouseChanged, setMouseChanged, getViewportChanged, setViewportChanged, getPrefersContrastChanged, setPrefersContrastChanged, getPrefersReducedMotionChanged, setPrefersReducedMotionChanged, getPrefersDarkColorSchemeChanged, setPrefersDarkColorSchemeChanged, getPrefersReduceTransparencyChanged, setPrefersReduceTransparencyChanged, getPrefersReduceDataChanged, setPrefersReduceDataChanged } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./system-flags.js&#x27;</span>;

<span class="hljs-keyword">import</span> { _computed, _floor, _now, _round, _seal, _values, <span class="hljs-variable constant_">ADD_EVENT_LISTENER</span>, <span class="hljs-variable constant_">CHANGE</span>, <span class="hljs-variable constant_">MOUSE</span>, <span class="hljs-variable constant_">MOUSE_DOWN</span>, <span class="hljs-variable constant_">MOUSE_ENTER</span>, <span class="hljs-variable constant_">MOUSE_LEAVE</span>, <span class="hljs-variable constant_">MOUSE_MOVE</span>, <span class="hljs-variable constant_">MOUSE_UP</span>, <span class="hljs-variable constant_">MOVE</span>, <span class="hljs-variable constant_">POINTER</span>, <span class="hljs-variable constant_">POINTER_DOWN</span>, <span class="hljs-variable constant_">POINTER_ENTER</span>, <span class="hljs-variable constant_">POINTER_LEAVE</span>, <span class="hljs-variable constant_">POINTER_MOVE</span>, <span class="hljs-variable constant_">POINTER_UP</span>, <span class="hljs-variable constant_">REMOVE_EVENT_LISTENER</span>, <span class="hljs-variable constant_">RESIZE</span>, <span class="hljs-variable constant_">SCROLL</span>, <span class="hljs-variable constant_">T_CANVAS</span>, <span class="hljs-variable constant_">T_PHRASE</span>, <span class="hljs-variable constant_">TOUCH</span>, <span class="hljs-variable constant_">TOUCH_CANCEL</span>, <span class="hljs-variable constant_">TOUCH_END</span>, <span class="hljs-variable constant_">TOUCH_MOVE</span>, <span class="hljs-variable constant_">TOUCH_START</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./shared-vars.js&#x27;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p><code>Exported array</code> (to modules). DOM element wrappers subscribe for updates by adding themselves to the <strong>uiSubscribedElements</strong> array. When an event fires, the updated data will be pushed to them automatically</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> uiSubscribedElements = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p><code>Exported object</code> (to modules and the scrawl object). The <strong>currentCorePosition</strong> object holds the <strong>global</strong> mouse cursor position, alongside browser view dimensions and scroll position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> currentCorePosition = <span class="hljs-title function_">_seal</span>({
    <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollX</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollY</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">w</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">h</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">MOUSE</span>,
    <span class="hljs-attr">prefersReducedMotion</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersDarkColorScheme</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersReduceTransparency</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersContrast</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersReduceData</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">rawTouches</span>: [],
});</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h3 id="accessibility-preferences">Accessibility preferences</h3>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p><strong>contrastMediaQuery</strong> - real-time check on the <code>prefers-reduced-motion</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> contrastMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-contrast: more)&quot;</span>);

contrastMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-variable constant_">CHANGE</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">const</span> res = contrastMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersContrast</span> != res) {

        currentCorePosition.<span class="hljs-property">prefersContrast</span> = res;
        <span class="hljs-title function_">setPrefersContrastChanged</span>(<span class="hljs-literal">true</span>);
    }
});
currentCorePosition.<span class="hljs-property">prefersContrast</span> = contrastMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p><strong>reducedMotionMediaQuery</strong> - real-time check on the <code>prefers-reduced-motion</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> reducedMotionMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-reduced-motion: reduce)&quot;</span>);

reducedMotionMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-variable constant_">CHANGE</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">const</span> res = reducedMotionMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersReducedMotion</span> != res) {

        currentCorePosition.<span class="hljs-property">prefersReducedMotion</span> = res;
        <span class="hljs-title function_">setPrefersReducedMotionChanged</span>(<span class="hljs-literal">true</span>);
    }
});
currentCorePosition.<span class="hljs-property">prefersReducedMotion</span> = reducedMotionMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p><strong>colorSchemeMediaQuery</strong> - real-time check on the <code>prefers-color-scheme</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> colorSchemeMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-color-scheme: dark)&quot;</span>);

colorSchemeMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-variable constant_">CHANGE</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">const</span> res = colorSchemeMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span> != res) {

        currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span> = res;
        <span class="hljs-title function_">setPrefersDarkColorSchemeChanged</span>(<span class="hljs-literal">true</span>);
    }
});
currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span> = colorSchemeMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p><strong>reducedTransparencyMediaQuery</strong> - real-time check on the <code>prefers-reduced-transparency</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> reducedTransparencyMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-reduced-transparency: reduce)&quot;</span>);

reducedTransparencyMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-variable constant_">CHANGE</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">const</span> res = reducedTransparencyMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span> != res) {

        currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span> = res;
        <span class="hljs-title function_">setPrefersReduceTransparencyChanged</span>(<span class="hljs-literal">true</span>);
    }
});
currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span> = reducedTransparencyMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p><strong>reducedDataMediaQuery</strong> - real-time check on the <code>prefers-reduced-data</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> reducedDataMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-reduced-data: reduce)&quot;</span>);

reducedDataMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-variable constant_">CHANGE</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">const</span> res = reducedDataMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersReduceData</span> != res) {

        currentCorePosition.<span class="hljs-property">prefersReduceData</span> = res;
        <span class="hljs-title function_">setPrefersReduceDataChanged</span>(<span class="hljs-literal">true</span>);
    }
});
currentCorePosition.<span class="hljs-property">prefersReduceData</span> = reducedDataMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h3 id="watch-for-browser-window-resize-or-device-rotation-which-trigger-changes-in-the-viewport-dimensions">Watch for browser window resize, or device rotation, which trigger changes in the viewport dimensions</h3>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p><strong>resizeAction</strong> function - to check if a view resize has occurred; if yes, flag that currentCorePosition object needs to be updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> resizeAction = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">const</span> w = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>,
        h = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientHeight</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">w</span> != w || currentCorePosition.<span class="hljs-property">h</span> != h) {

        currentCorePosition.<span class="hljs-property">w</span> = w;
        currentCorePosition.<span class="hljs-property">h</span> = h;
        <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">setViewportChanged</span>(<span class="hljs-literal">true</span>);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h3 id="watch-for-scrolling-interactions">Watch for scrolling interactions</h3>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p><strong>scrollAction</strong> function - to check if a view scroll has occurred; if yes, flag that currentCorePosition object needs to be updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> scrollAction = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">const</span> x = <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageXOffset</span>,
        y = <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">scrollX</span> != x || currentCorePosition.<span class="hljs-property">scrollY</span> != y) {
        currentCorePosition.<span class="hljs-property">x</span> += (x - currentCorePosition.<span class="hljs-property">scrollX</span>);
        currentCorePosition.<span class="hljs-property">y</span> += (y - currentCorePosition.<span class="hljs-property">scrollY</span>);
        currentCorePosition.<span class="hljs-property">scrollX</span> = x;
        currentCorePosition.<span class="hljs-property">scrollY</span> = y;
        <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">true</span>);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h3 id="watch-for-mouse-pointer-and-touch-movement">Watch for mouse, pointer and touch movement</h3>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p><strong>moveAction</strong> function - to check if mouse cursor position has changed; if yes, update currentCorePosition object and flag that the updated needs to cascade to subscribed elements at the next RAF invocation.</p>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>The events that trigger this function (pointermove, pointerup, pointerdown, pointerleave, pointerenter; or mousemove, mouseup, mousedown, mouseleave, mouseenter) are tied to the window object, not to any particular DOM element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> moveAction = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

    <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">_round</span>(e.<span class="hljs-property">pageX</span>),
        y = <span class="hljs-title function_">_round</span>(e.<span class="hljs-property">pageY</span>);

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">x</span> != x || currentCorePosition.<span class="hljs-property">y</span> != y) {
        currentCorePosition.<span class="hljs-property">type</span> = (navigator.<span class="hljs-property">pointerEnabled</span>) ? <span class="hljs-variable constant_">POINTER</span> : <span class="hljs-variable constant_">MOUSE</span>;
        currentCorePosition.<span class="hljs-property">x</span> = x;
        currentCorePosition.<span class="hljs-property">y</span> = y;
        <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">true</span>);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p><strong>touchAction</strong> function - maps touch coordinates to the mouse cursor position (via currentCorePosition) and then immediately invokes a cascade update action to all subscribed elements.</p>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>The events that trigger this function (touchstart, touchmove, touchend, touchcancel) are tied to the window object, not to any particular DOM element.</p>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Note: this is different to mouse moveAction, which is choked via an animation object so update checks happen on each requestAnimationFrame.</p>
<p>TODO: Need to keep an eye on how many times touchAction gets run, for example during a touch-driven drag-and-drop action. If necessary, add a Date.now mediated choke to the check (say minimum 15ms between checks?) to minimize impact on the wider Scrawl-canvas ecosystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> touchActionLastChecked = <span class="hljs-number">0</span>,
    touchActionChoke = <span class="hljs-number">16</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getTouchActionChoke = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">return</span> touchActionChoke;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> setTouchActionChoke = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) {

    <span class="hljs-keyword">if</span> (val &amp;&amp; val.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(val)) touchActionChoke = val;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> touchAction = <span class="hljs-keyword">function</span> (<span class="hljs-params">e, resetCoordsToZeroOnTouchEnd = <span class="hljs-literal">true</span></span>) {

    currentCorePosition.<span class="hljs-property">rawTouches</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">touches</span> &amp;&amp; e.<span class="hljs-property">touches</span>.<span class="hljs-property">length</span>) {

        currentCorePosition.<span class="hljs-property">rawTouches</span>.<span class="hljs-title function_">push</span>(...e.<span class="hljs-property">touches</span>);

        <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>],
            x = <span class="hljs-title function_">_round</span>(touch.<span class="hljs-property">pageX</span>),
            y = <span class="hljs-title function_">_round</span>(touch.<span class="hljs-property">pageY</span>);

        <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">x</span> !== x || currentCorePosition.<span class="hljs-property">y</span> !== y) {

            currentCorePosition.<span class="hljs-property">type</span> = <span class="hljs-variable constant_">TOUCH</span>;
            currentCorePosition.<span class="hljs-property">x</span> = x;
            currentCorePosition.<span class="hljs-property">y</span> = y;
        }
    }
    <span class="hljs-keyword">else</span> {

        currentCorePosition.<span class="hljs-property">type</span> = <span class="hljs-variable constant_">TOUCH</span>;

        <span class="hljs-keyword">if</span> (resetCoordsToZeroOnTouchEnd) {

            currentCorePosition.<span class="hljs-property">x</span> = <span class="hljs-number">0</span>;
            currentCorePosition.<span class="hljs-property">y</span> = <span class="hljs-number">0</span>;
        }
    }

    <span class="hljs-keyword">const</span> now = <span class="hljs-title function_">_now</span>();

    <span class="hljs-keyword">if</span> (now &gt; touchActionLastChecked + touchActionChoke) {

        touchActionLastChecked = now;
        <span class="hljs-title function_">updateUiSubscribedElements</span>();
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <h2 id="cascade-interaction-results-down-to-subscribed-elements">Cascade interaction results down to subscribed elements</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>Functions to update uiSubscribedElements attached to specified DOM elements. Each stack or canvas element tracked by Scrawl-canvas will include a local <strong>here</strong> object which includes details of the element’s current dimensions, relative position, and the position of the mouse cursor in relation to its top-left corner. These all need to be updated whenever there’s a resize, scroll or cursor movement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> updateUiSubscribedElements = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = uiSubscribedElements.<span class="hljs-property">length</span>; i &lt; iz; i++) {

        <span class="hljs-title function_">updateUiSubscribedElement</span>(uiSubscribedElements[i]);
    }
};

<span class="hljs-keyword">const</span> updateUiSubscribedElement = <span class="hljs-keyword">function</span> (<span class="hljs-params">art</span>) {

    <span class="hljs-keyword">const</span> dom = library.<span class="hljs-property">artefact</span>[art];

    <span class="hljs-keyword">if</span> (dom) {

        <span class="hljs-keyword">if</span> (!dom.<span class="hljs-property">here</span>) dom.<span class="hljs-property">here</span> = {};

        <span class="hljs-keyword">const</span> { here, <span class="hljs-attr">domElement</span>:el } = dom;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>Accessibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        here.<span class="hljs-property">prefersContrast</span> = currentCorePosition.<span class="hljs-property">prefersContrast</span>;
        here.<span class="hljs-property">prefersReducedMotion</span> = currentCorePosition.<span class="hljs-property">prefersReducedMotion</span>;
        here.<span class="hljs-property">prefersDarkColorScheme</span> = currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span>;
        here.<span class="hljs-property">prefersReduceTransparency</span> = currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span>;
        here.<span class="hljs-property">prefersReduceData</span> = currentCorePosition.<span class="hljs-property">prefersReduceData</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getPrefersContrastChanged</span>()) dom.<span class="hljs-title function_">contrastActions</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getPrefersReducedMotionChanged</span>()) dom.<span class="hljs-title function_">reducedMotionActions</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getPrefersDarkColorSchemeChanged</span>()) dom.<span class="hljs-title function_">colorSchemeActions</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getPrefersReduceTransparencyChanged</span>()) dom.<span class="hljs-title function_">reducedTransparencyActions</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getPrefersReduceDataChanged</span>()) dom.<span class="hljs-title function_">reducedDataActions</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>DOM-element-dependant values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (el) {

            <span class="hljs-keyword">const</span> dims = el.<span class="hljs-title function_">getBoundingClientRect</span>(),
                dox = <span class="hljs-title function_">_round</span>(dims.<span class="hljs-property">left</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageXOffset</span>),
                doy = <span class="hljs-title function_">_round</span>(dims.<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span>),
                dot = dims.<span class="hljs-property">top</span>,
                doh = dims.<span class="hljs-property">height</span>,
                wih = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;

            here.<span class="hljs-property">w</span> = <span class="hljs-title function_">_round</span>(dims.<span class="hljs-property">width</span>);
            here.<span class="hljs-property">h</span> = <span class="hljs-title function_">_round</span>(doh);

            here.<span class="hljs-property">type</span> = currentCorePosition.<span class="hljs-property">type</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>Position of the artefact in the browser/device viewport</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">const</span> ivpt = dot / wih,
                ivpb = (dot + doh) / wih,
                ivpc = (ivpt + ivpb) / <span class="hljs-number">2</span>;

            here.<span class="hljs-property">inViewportTop</span> = ivpt;
            here.<span class="hljs-property">inViewportBase</span> = ivpb;
            here.<span class="hljs-property">inViewportCenter</span> = ivpc;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>DOM-based artefacts have the option of creating a local mouse move event listener, which better tracks mouse movements across them when their element has been rotated in three dimensions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!dom.<span class="hljs-property">localMouseListener</span>) {

                here.<span class="hljs-property">localListener</span> = <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;

                here.<span class="hljs-property">x</span> = <span class="hljs-title function_">_round</span>(currentCorePosition.<span class="hljs-property">x</span> - dox);
                here.<span class="hljs-property">y</span> = <span class="hljs-title function_">_round</span>(currentCorePosition.<span class="hljs-property">y</span> - doy);

                here.<span class="hljs-property">normX</span> = (here.<span class="hljs-property">w</span>) ? here.<span class="hljs-property">x</span> / here.<span class="hljs-property">w</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">normY</span> = (here.<span class="hljs-property">h</span>) ? here.<span class="hljs-property">y</span> / here.<span class="hljs-property">h</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">offsetX</span> = dox;
                here.<span class="hljs-property">offsetY</span> = doy;

                <span class="hljs-keyword">if</span> (here.<span class="hljs-property">normX</span> &lt; <span class="hljs-number">0</span> || here.<span class="hljs-property">normX</span> &gt; <span class="hljs-number">1</span> || here.<span class="hljs-property">normY</span> &lt; <span class="hljs-number">0</span> || here.<span class="hljs-property">normY</span> &gt; <span class="hljs-number">1</span>) here.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>Default mouse tracking behaviour</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {

                here.<span class="hljs-property">localListener</span> = <span class="hljs-literal">true</span>;
                here.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;

                here.<span class="hljs-property">normX</span> = (here.<span class="hljs-property">originalWidth</span>) ? here.<span class="hljs-property">x</span> / here.<span class="hljs-property">originalWidth</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">normY</span> = (here.<span class="hljs-property">originalHeight</span>) ? here.<span class="hljs-property">y</span> / here.<span class="hljs-property">originalHeight</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">offsetX</span> = dox;
                here.<span class="hljs-property">offsetY</span> = doy;

                <span class="hljs-keyword">if</span> (here.<span class="hljs-property">x</span> &gt; dom.<span class="hljs-property">activePadding</span> &amp;&amp; here.<span class="hljs-property">x</span> &lt; here.<span class="hljs-property">originalWidth</span> - dom.<span class="hljs-property">activePadding</span> &amp;&amp; here.<span class="hljs-property">y</span> &gt; <span class="hljs-number">0</span> + dom.<span class="hljs-property">activePadding</span> &amp;&amp; here.<span class="hljs-property">y</span> &lt; here.<span class="hljs-property">originalHeight</span> - dom.<span class="hljs-property">activePadding</span>) here.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">const</span> touches = currentCorePosition.<span class="hljs-property">rawTouches</span>;

            <span class="hljs-keyword">if</span> (touches.<span class="hljs-property">length</span>) {

                <span class="hljs-keyword">if</span> (!here.<span class="hljs-property">touches</span>) here.<span class="hljs-property">touches</span> = [];

                here.<span class="hljs-property">touches</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = touches.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                    <span class="hljs-keyword">const</span> touch = touches[i];

                    here.<span class="hljs-property">touches</span>.<span class="hljs-title function_">push</span>([<span class="hljs-title function_">_round</span>(touch.<span class="hljs-property">pageX</span> - dox), <span class="hljs-title function_">_round</span>(touch.<span class="hljs-property">pageY</span> - doy)]);
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Canvas <code>fit</code> attribute adjustments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (dom.<span class="hljs-property">type</span> == <span class="hljs-variable constant_">T_CANVAS</span>) dom.<span class="hljs-title function_">updateBaseHere</span>(here, dom.<span class="hljs-property">fit</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>Automatically check for element resize</p>
<ul>
<li>The artefact’s <code>checkForResize</code> flag needs to be set</li>
<li>We ignore resizing actions while dimensions-related dirty flags are set (to prevent getting ourselves into a continuous feedback loop)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (dom.<span class="hljs-property">checkForResize</span> &amp;&amp; !dom.<span class="hljs-property">dirtyDimensions</span> &amp;&amp; !dom.<span class="hljs-property">dirtyDomDimensions</span>) {

                <span class="hljs-keyword">const</span> [w, h] = dom.<span class="hljs-property">currentDimensions</span>;

                <span class="hljs-keyword">if</span> (dom.<span class="hljs-property">type</span> == <span class="hljs-variable constant_">T_CANVAS</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Regardless of the setting of &lt;canvas&gt; element’s <code>boxSizing</code> style attribute:</p>
<ul>
<li>It will include padding and borders in its <code>getBoundingClientRect</code> object (and its <code>getComputedStyle</code> width/height values), but these are specifically excluded from the element’s <code>width</code> and <code>height</code> attributes</li>
<li>Which leads to the normal resize test - <code>if (w !== here.w || h !== here.h)</code> - triggering on every mouse/scroll/resize event, which in turn leads to the canvas dimensions increasing uncontrollably.</li>
<li>Solved by subtracting padding/border values from the <code>getBoundingClientRect</code> dimension values before performing the test.</li>
<li>Tested in Demo <a href="../../demo/canvas-004.html">Canvas-004</a>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (!dom.<span class="hljs-property">computedStyles</span>) dom.<span class="hljs-property">computedStyles</span> = <span class="hljs-title function_">_computed</span>(dom.<span class="hljs-property">domElement</span>);

                    <span class="hljs-keyword">const</span> s = dom.<span class="hljs-property">computedStyles</span>,
                        hw = <span class="hljs-title function_">_floor</span>(here.<span class="hljs-property">w</span> - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderLeftWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderRightWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingLeft</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingRight</span>)),
                        hh = <span class="hljs-title function_">_floor</span>(here.<span class="hljs-property">h</span> - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderTopWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderBottomWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingTop</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingBottom</span>));

                    <span class="hljs-keyword">if</span> (w !== hw || h !== hh) {

                        dom.<span class="hljs-title function_">set</span>({

                            <span class="hljs-attr">dimensions</span>: [hw, hh],
                        });
                    }
                }
                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p>Stack and Element artefacts resize test.</p>
<ul>
<li>Tested in Demo <a href="../../demo/dom-011.html">DOM-011</a>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (w !== here.<span class="hljs-property">w</span> || h !== here.<span class="hljs-property">h</span>) {

                        dom.<span class="hljs-title function_">set</span>({

                            <span class="hljs-attr">dimensions</span>: [here.<span class="hljs-property">w</span>, here.<span class="hljs-property">h</span>],
                        });
                    }
                }
            }
        }
    }
};

<span class="hljs-keyword">const</span> updatePhraseEntitys = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">_values</span>(library.<span class="hljs-property">entity</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">ent</span> =&gt;</span> {

        <span class="hljs-keyword">if</span> (ent.<span class="hljs-property">type</span> == <span class="hljs-variable constant_">T_PHRASE</span>) {

            ent.<span class="hljs-property">dirtyDimensions</span> = <span class="hljs-literal">true</span>;
            ent.<span class="hljs-property">dirtyFont</span> = <span class="hljs-literal">true</span>;
        }
    })
};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>Internal functions that get triggered when setting a DOM-based artefact’s <code>trackHere</code> attribute. They add/remove an event listener to the artefact’s domElement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> addLocalMouseMoveListener = <span class="hljs-keyword">function</span> (<span class="hljs-params">wrapper</span>) {

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(wrapper)) {

        <span class="hljs-keyword">if</span> (wrapper.<span class="hljs-property">localMouseListener</span>) wrapper.<span class="hljs-title function_">localMouseListener</span>();

        <span class="hljs-keyword">if</span> (!wrapper.<span class="hljs-property">here</span>) wrapper.<span class="hljs-property">here</span> = {};

        wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">originalWidth</span> = wrapper.<span class="hljs-property">currentDimensions</span>[<span class="hljs-number">0</span>];
        wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">originalHeight</span> = wrapper.<span class="hljs-property">currentDimensions</span>[<span class="hljs-number">1</span>];

        wrapper.<span class="hljs-property">localMouseListener</span> = <span class="hljs-title function_">addListener</span>(<span class="hljs-variable constant_">MOVE</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

            <span class="hljs-keyword">if</span> (wrapper.<span class="hljs-property">here</span>) {

                wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">x</span> = <span class="hljs-title function_">_round</span>(<span class="hljs-built_in">parseFloat</span>(e.<span class="hljs-property">offsetX</span>));
                wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">y</span> = <span class="hljs-title function_">_round</span>(<span class="hljs-built_in">parseFloat</span>(e.<span class="hljs-property">offsetY</span>));
            }
        }, wrapper.<span class="hljs-property">domElement</span>);
    }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> removeLocalMouseMoveListener = <span class="hljs-keyword">function</span> (<span class="hljs-params">wrapper</span>) {

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(wrapper)) {

        <span class="hljs-keyword">if</span> (wrapper.<span class="hljs-property">localMouseListener</span>) wrapper.<span class="hljs-title function_">localMouseListener</span>();

        wrapper.<span class="hljs-property">localMouseListener</span> = <span class="hljs-literal">false</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>Animation object which checks whether any window event listeners have fired, and actions accordingly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> coreListenersTracker = <span class="hljs-title function_">makeAnimation</span>({

    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;coreListenersTracker&#x27;</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">delay</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">fn</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

        <span class="hljs-keyword">const</span> trackMouse = <span class="hljs-title function_">getTrackMouse</span>();
        <span class="hljs-keyword">const</span> mouseChanged = <span class="hljs-title function_">getMouseChanged</span>();
        <span class="hljs-keyword">const</span> viewportChanged = <span class="hljs-title function_">getViewportChanged</span>();
        <span class="hljs-keyword">const</span> prefersReducedMotionChanged = <span class="hljs-title function_">getPrefersReducedMotionChanged</span>();
        <span class="hljs-keyword">const</span> prefersDarkColorSchemeChanged = <span class="hljs-title function_">getPrefersDarkColorSchemeChanged</span>();
        <span class="hljs-keyword">const</span> prefersReduceTransparencyChanged = <span class="hljs-title function_">getPrefersReduceTransparencyChanged</span>();
        <span class="hljs-keyword">const</span> prefersReduceDataChanged = <span class="hljs-title function_">getPrefersReduceDataChanged</span>();

        <span class="hljs-keyword">if</span> (!uiSubscribedElements.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> ((trackMouse &amp;&amp; mouseChanged) || prefersReducedMotionChanged || prefersDarkColorSchemeChanged || prefersReduceTransparencyChanged || prefersReduceDataChanged) {

            <span class="hljs-title function_">updateUiSubscribedElements</span>();

            <span class="hljs-keyword">if</span> (trackMouse &amp;&amp; mouseChanged) {

                <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">false</span>);
            }

            <span class="hljs-keyword">if</span> (prefersReducedMotionChanged || prefersDarkColorSchemeChanged || prefersReduceTransparencyChanged || prefersReduceDataChanged) {

                <span class="hljs-title function_">setPrefersReducedMotionChanged</span>(<span class="hljs-literal">false</span>);
                <span class="hljs-title function_">setPrefersDarkColorSchemeChanged</span>(<span class="hljs-literal">false</span>);
                <span class="hljs-title function_">setPrefersReduceTransparencyChanged</span>(<span class="hljs-literal">false</span>);
                <span class="hljs-title function_">setPrefersReduceDataChanged</span>(<span class="hljs-literal">false</span>);
            }
        }

        <span class="hljs-keyword">if</span> (viewportChanged) {

            <span class="hljs-title function_">setViewportChanged</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">updatePhraseEntitys</span>();
        }
    },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p><code>Exported functions</code> (to modules and the scrawl object). Event listeners can be a drain on web page efficiency. If a web page contains only static canvas (and/or stack) displays, with no requirement for user interaction, we can minimize Scrawl-canvas’s impact on those pages by switching off the core listeners (and also the core animation loop).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> startCoreListeners = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">actionCoreListeners</span>(<span class="hljs-variable constant_">REMOVE_EVENT_LISTENER</span>);
    <span class="hljs-title function_">actionCoreListeners</span>(<span class="hljs-variable constant_">ADD_EVENT_LISTENER</span>);

    <span class="hljs-title function_">setTrackMouse</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">true</span>);
    coreListenersTracker.<span class="hljs-title function_">run</span>();
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> stopCoreListeners = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">setTrackMouse</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">false</span>);
    coreListenersTracker.<span class="hljs-title function_">halt</span>();

    <span class="hljs-title function_">actionCoreListeners</span>(<span class="hljs-variable constant_">REMOVE_EVENT_LISTENER</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p>Helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> actionCoreListeners = <span class="hljs-keyword">function</span> (<span class="hljs-params">action</span>) {

    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">pointerEnabled</span> || navigator.<span class="hljs-property">msPointerEnabled</span>) {

        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">POINTER_MOVE</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">POINTER_UP</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">POINTER_DOWN</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">POINTER_LEAVE</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">POINTER_ENTER</span>, moveAction, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">else</span> {

        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">MOUSE_MOVE</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">MOUSE_UP</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">MOUSE_DOWN</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">MOUSE_LEAVE</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">MOUSE_ENTER</span>, moveAction, <span class="hljs-literal">false</span>);

        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">TOUCH_MOVE</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">TOUCH_START</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">TOUCH_END</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">TOUCH_CANCEL</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
    }

    <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">SCROLL</span>, scrollAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
    <span class="hljs-variable language_">window</span>[action](<span class="hljs-variable constant_">RESIZE</span>, resizeAction, <span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p><code>Exported functions</code> (to modules). Invoke the resize and/or scroll event listeners once, outside the regular requestAnimationFrame tick.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> applyCoreResizeListener = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">resizeAction</span>();
    <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setViewportChanged</span>(<span class="hljs-literal">true</span>);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> applyCoreScrollListener = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">scrollAction</span>();
    <span class="hljs-title function_">setMouseChanged</span>(<span class="hljs-literal">true</span>);
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
