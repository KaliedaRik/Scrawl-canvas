const t={},e={},i={},s=[],n={},r=[],o={},a={},h=[],c={},l={},u={},d={},f={},p=[],m={},g={},y=Math.PI/180,b=new Set(["all","background","backgroundAttachment","backgroundBlendMode","backgroundClip","backgroundColor","backgroundOrigin","backgroundPosition","backgroundRepeat","border","borderBottom","borderBottomColor","borderBottomStyle","borderBottomWidth","borderCollapse","borderColor","borderLeft","borderLeftColor","borderLeftStyle","borderLeftWidth","borderRight","borderRightColor","borderRightStyle","borderRightWidth","borderSpacing","borderStyle","borderTop","borderTopColor","borderTopStyle","borderTopWidth","borderWidth","clear","color","columns","content","counterIncrement","counterReset","cursor","direction","display","emptyCells","float","font","fontFamily","fontSize","fontSizeAdjust","fontStretch","fontStyle","fontSynthesis","fontVariant","fontVariantAlternates","fontVariantCaps","fontVariantEastAsian","fontVariantLigatures","fontVariantNumeric","fontVariantPosition","fontWeight","grid","gridArea","gridAutoColumns","gridAutoFlow","gridAutoPosition","gridAutoRows","gridColumn","gridColumnStart","gridColumnEnd","gridRow","gridRowStart","gridRowEnd","gridTemplate","gridTemplateAreas","gridTemplateRows","gridTemplateColumns","imageResolution","imeMode","inherit","inlineSize","isolation","letterSpacing","lineBreak","lineHeight","listStyle","listStyleImage","listStylePosition","listStyleType","margin","marginBlockStart","marginBlockEnd","marginInlineStart","marginInlineEnd","marginBottom","marginLeft","marginRight","marginTop","marks","mask","maskType","maxWidth","maxHeight","maxBlockSize","maxInlineSize","maxZoom","minWidth","minHeight","minBlockSize","minInlineSize","minZoom","mixBlendMode","objectFit","objectPosition","offsetBlockStart","offsetBlockEnd","offsetInlineStart","offsetInlineEnd","orphans","overflow","overflowWrap","overflowX","overflowY","pad","padding","paddingBlockStart","paddingBlockEnd","paddingInlineStart","paddingInlineEnd","paddingBottom","paddingLeft","paddingRight","paddingTop","pageBreakAfter","pageBreakBefore","pageBreakInside","pointerEvents","position","prefix","quotes","rubyAlign","rubyMerge","rubyPosition","scrollBehavior","scrollSnapCoordinate","scrollSnapDestination","scrollSnapPointsX","scrollSnapPointsY","scrollSnapType","scrollSnapTypeX","scrollSnapTypeY","shapeImageThreshold","shapeMargin","shapeOutside","tableLayout","textAlign","textDecoration","textIndent","textOrientation","textOverflow","textRendering","textShadow","textTransform","textUnderlinePosition","unicodeRange","unset","verticalAlign","widows","willChange","wordBreak","wordSpacing","wordWrap","zIndex"]),P=new Set(["alignContent","alignItems","alignSelf","animation","animationDelay","animationDirection","animationDuration","animationFillMode","animationIterationCount","animationName","animationPlayState","animationTimingFunction","backfaceVisibility","backgroundImage","backgroundSize","borderBottomLeftRadius","borderBottomRightRadius","borderImage","borderImageOutset","borderImageRepeat","borderImageSlice","borderImageSource","borderImageWidth","borderRadius","borderTopLeftRadius","borderTopRightRadius","boxDecorationBreak","boxShadow","boxSizing","columnCount","columnFill","columnGap","columnRule","columnRuleColor","columnRuleStyle","columnRuleWidth","columnSpan","columnWidth","filter","flex","flexBasis","flexDirection","flexFlow","flexGrow","flexShrink","flexWrap","fontFeatureSettings","fontKerning","fontLanguageOverride","hyphens","imageRendering","imageOrientation","initial","justifyContent","linearGradient","opacity","order","orientation","outline","outlineColor","outlineOffset","outlineStyle","outlineWidth","resize","tabSize","textAlignLast","textCombineUpright","textDecorationColor","textDecorationLine","textDecorationStyle","touchAction","transformStyle","transition","transitionDelay","transitionDuration","transitionProperty","transitionTimingFunction","unicodeBidi","whiteSpace","writingMode"]);var S=Object.freeze({__proto__:null,version:"8.2.1",anchor:{},anchornames:[],animation:t,animationnames:[],asset:n,assetnames:r,animationtickers:e,animationtickersnames:[],artefact:i,artefactnames:s,canvas:o,canvasnames:[],cell:a,cellnames:h,element:{},elementnames:[],entity:c,entitynames:[],filter:l,filternames:[],fontattribute:{},fontattributenames:[],group:u,groupnames:[],palette:{},palettenames:[],stack:{},stacknames:[],styles:f,stylesnames:p,tween:d,tweennames:[],unstackedelement:m,unstackedelementnames:[],constructors:g,radian:y,css:b,xcss:P});let v=!1,k=!0,x=[],w=[];const C=function(){k=!0},O=function(){let e=[];k&&function(){if(k){k=!1;let e=Math.floor,i=[];w.forEach(s=>{let n=t[s];if(n){let t=e(n.order)||0;i[t]||(i[t]=[]),i[t].push(n)}}),x=i.reduce((t,e)=>t.concat(e),[])}}(),x.forEach(t=>{t&&t.fn&&e.push(t.fn())}),Promise.all(e).then(()=>{v&&window.requestAnimationFrame(()=>O())}).catch(t=>console.log("animationLoop error: ",t))},D=function(){v=!0,O()},A=(t,e)=>{if(!q(e))throw new Error(`core/utilities addStrings() error - no delta argument supplied ${t}, ${e}`);if(null!=e){let i=!(!t.substring&&!e.substring);return z(t)?t+=z(e)?e:parseFloat(e):t=parseFloat(t)+(z(e)?e:parseFloat(e)),i?t+"%":t}return t},E=t=>{let e,i,s;if(!q(t))throw new Error("core/utilities convertTime() error - no argument supplied");if(z(t))return["ms",t];if(!t.substring)throw new Error("core/utilities convertTime() error - invalid argument: "+t);if(e=t.match(/^\d+\.?\d*(\D*)/),i=e[1].toLowerCase?e[1].toLowerCase():"ms",s=parseFloat(t),!z(s))throw new Error("core/base error - convertTime() argument converts to NaN: "+t);switch(i){case"s":s*=1e3;break;case"%":break;default:i="ms"}return[i,s]},T=()=>{},H=function(){return this},R=()=>Promise.resolve(!0),F=()=>{function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return`${t()}${t()}-${t()}-${t()}-${t()}-${t()}${t()}${t()}`},B=t=>"boolean"==typeof t,j=t=>"[object HTMLCanvasElement]"===Object.prototype.toString.call(t),L=t=>!!(t&&t.querySelector&&t.dispatchEvent),M=t=>"function"==typeof t,z=t=>!(void 0===t||!t.toFixed||Number.isNaN(t)),I=t=>"[object Object]"===Object.prototype.toString.call(t),X=t=>!(!t||!t.type||"Quaternion"!==t.type),Y=(t,e)=>{if(!I(t)||!I(e))throw new Error(`core/utilities mergeOver() error - insufficient arguments supplied ${t}, ${e}`);for(let i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},$=(t,e)=>{if(!I(t)||!I(e))throw new Error(`core/utilities mergeDiscard() error - insufficient arguments supplied ${t}, ${e}`);return Object.entries(e).forEach(([i,s])=>{null===s?delete t[i]:t[i]=e[i]}),t},N=(t,e)=>{if(!V(t,e))throw new Error(`core/utilities pushUnique() error - insufficient arguments supplied ${t}, ${e}`);if(!Array.isArray(t))throw new Error("core/utilities pushUnique() error - argument not an array "+t);return Array.isArray(e)?e.forEach(e=>N(t,e)):t.indexOf(e)<0&&t.push(e),t},W=(t,e)=>{if(!V(t,e))throw new Error(`core/utilities removeItem() error - insufficient arguments supplied ${t}, ${e}`);if(!Array.isArray(t))throw new Error("core/utilities removeItem() error - argument not an array "+t);let i=t.indexOf(e);return i>=0&&t.splice(i,1),t},q=t=>void 0!==t,V=(...t)=>t.every(t=>void 0!==t),G=(...t)=>t.find(t=>void 0!==t),U=(...t)=>!!t.find(t=>void 0!==t),_=function(t,e,i={}){if("function"==typeof window.IntersectionObserver&&t&&t.run){let s=new IntersectionObserver((e,i)=>{e.forEach(e=>{e.isIntersecting?!t.isRunning()&&t.run():e.isIntersecting||t.isRunning()&&t.halt()})},i);return e&&e.domElement&&s.observe(e.domElement),function(){s.disconnect()}}return T},Q=function(t,e,i){if(!M(e))throw new Error(`core/document addListener() error - no function supplied: ${t}, ${i}`);return Z(t,e,i,"removeEventListener"),Z(t,e,i,"addEventListener"),function(){K(t,e,i)}},K=function(t,e,i){if(!M(e))throw new Error(`core/document removeListener() error - no function supplied: ${t}, ${i}`);Z(t,e,i,"removeEventListener")},Z=function(t,e,i,s){let n,r=[].concat(t);n=i.substring?document.body.querySelectorAll(i):Array.isArray(i)?i:[i],navigator.pointerEnabled||navigator.msPointerEnabled?tt(r,e,n,s):J(r,e,n,s)},J=function(t,e,i,s){t.forEach(t=>{i.forEach(i=>{if(!L(i))throw new Error(`core/document actionMouseListener() error - bad target: ${t}, ${i}`);switch(t){case"move":i[s]("mousemove",e,!1),i[s]("touchmove",e,!1),i[s]("touchfollow",e,!1);break;case"up":i[s]("mouseup",e,!1),i[s]("touchend",e,!1);break;case"down":i[s]("mousedown",e,!1),i[s]("touchstart",e,!1);break;case"leave":i[s]("mouseleave",e,!1),i[s]("touchleave",e,!1);break;case"enter":i[s]("mouseenter",e,!1),i[s]("touchenter",e,!1)}})})},tt=function(t,e,i,s){t.forEach(t=>{i.forEach(i=>{if(!L(i))throw new Error(`core/document actionPointerListener() error - bad target: ${t}, ${i}`);switch(t){case"move":i[s]("pointermove",e,!1);break;case"up":i[s]("pointerup",e,!1);break;case"down":i[s]("pointerdown",e,!1);break;case"leave":i[s]("pointerleave",e,!1);break;case"enter":i[s]("pointerenter",e,!1)}})})},et=function(t,e,i){if(!M(e))throw new Error(`core/document addNativeListener() error - no function supplied: ${t}, ${i}`);return st(t,e,i,"removeEventListener"),st(t,e,i,"addEventListener"),function(){it(t,e,i)}},it=function(t,e,i){if(!M(e))throw new Error(`core/document removeNativeListener() error - no function supplied: ${t}, ${i}`);st(t,e,i,"removeEventListener")},st=function(t,e,i,s){let n,r=[].concat(t);n=i.substring?document.body.querySelectorAll(i):Array.isArray(i)?i:[i],r.forEach(t=>{n.forEach(i=>{if(!L(i))throw new Error(`core/document actionNativeListener() error - bad target: ${t}, ${i}`);i[s](t,e,!1)})})};function nt(t={}){t.defs={},t.getters={},t.setters={},t.deltaSetters={},t.get=function(t){if(q(t)){let e=this.getters[t];if(e)return e.call(this);{let e=this.defs[t];if(void 0!==e){let i=this[t];return void 0!==i?i:e}}}return null},t.set=function(t={}){if(t){let e=this.setters,i=this.defs;Object.entries(t).forEach(([t,s])=>{if(t&&"name"!==t&&null!=s){let n=e[t];n?n.call(this,s):void 0!==i[t]&&(this[t]=s)}},this)}return this},t.setDelta=function(t={}){if(t){let e=this.deltaSetters,i=this.defs;Object.entries(t).forEach(([t,s])=>{if(t&&"name"!==t&&null!=s){let n=e[t];n?n.call(this,s):void 0!==i[t]&&(this[t]=A(this[t],s))}},this)}return this};return t.defs=Y(t.defs,{name:""}),t.packetExclusions=[],t.packetExclusionsByRegex=[],t.packetCoordinates=[],t.packetObjects=[],t.packetFunctions=[],t.saveAsPacket=function(t={}){B(t)&&t&&(t={includeDefaults:!0});let e=this.defs,i=Object.keys(e),s=this.packetExclusions,n=this.packetExclusionsByRegex,r=this.packetCoordinates,o=this.packetObjects,a=this.packetFunctions,h=t.includeDefaults||!1,c={};return h&&!Array.isArray(h)?h=Object.keys(e):h||(h=[]),Object.entries(this).forEach(([t,e])=>{let l,u=!0;if(i.indexOf(t)<0&&(u=!1),u&&s.indexOf(t)>=0&&(u=!1),u&&(l=n.some(e=>new RegExp(e).test(t)),l&&(u=!1)),u)if(a.indexOf(t)>=0){if(q(e)&&null!==e){let i=this.stringifyFunction(e);i&&i.length&&(c[t]=i)}}else o.indexOf(t)>=0&&this[t]&&this[t].name?c[t]=this[t].name:r.indexOf(t)>=0?(h.indexOf(t)>=0||e[0]||e[1])&&(c[t]=e):(l=this.processPacketOut(t,e,h),l&&(c[t]=e))},this),c=this.finalizePacketOut(c,t),JSON.stringify([this.name,this.type,this.lib,c])},t.stringifyFunction=function(t){let e=t.toString().match(/\(([\s\S]*?)\)[\s\S]*?\{([\s\S]*)\}/),i=e[1],s=e[2];return!!V(i,s)&&`${i}~~~${s}`},t.processPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},t.finalizePacketOut=function(t,e){return t},t.importPacket=function(t){let e=this;const i=function(t){return new Promise((i,s)=>{let n;t.substring||s(new Error("Packet url supplied for import is not a string")),"["===t[0]?(n=e.actionPacket(t),n&&n.lib?i(n):s(n)):t.indexOf('"name":')>=0?s(new Error("Bad packet supplied for import")):fetch(t).then(t=>{if(!t.ok)throw new Error(`Packet import from server failed - ${t.status}: ${t.statusText} - ${t.url}`);return t.text()}).then(t=>{if(n=e.actionPacket(t),!n||!n.lib)throw n;i(n)}).catch(t=>s(t))})};if(Array.isArray(t)){let e=[];return t.forEach(t=>e.push(i(t))),new Promise((t,i)=>{Promise.all(e).then(e=>t(e)).catch(t=>i(t))})}if(t.substring)return i(t);Promise.reject(new Error("Argument supplied for packet import is not a string or array of strings"))},t.actionPacketExclusions=["Image","Sprite","Video","Canvas","Stack"],t.actionPacket=function(t){try{if(t&&t.substring){if("["===t[0]){let e,i,s,n;try{[e,i,s,n]=JSON.parse(t)}catch(t){throw new Error("Failed to process packet due to JSON parsing error - "+t.message)}if(V(e,i,s,n)){if(this.actionPacketExclusions.indexOf(i)>=0)throw new Error("Failed to process packet - Stacks, Canvases and visual assets are excluded from the packet system");let t=S[s][e];if(t)t.set(n);else{if(n.outerHTML&&n.host){let t=document.querySelector("#"+n.host);if(t){let i=document.createElement("div");i.innerHTML=n.outerHTML;let s=i.firstElementChild;s&&(s.id=e,t.appendChild(s),n.domElement=s)}}if(t=new g[i](n),!t)throw new Error("Failed to create Scrawl-canvas object from supplied packet")}if(t.packetFunctions.forEach(e=>this.actionPacketFunctions(t,e)),n.anchor&&t.anchor&&t.anchor.packetFunctions.forEach(e=>{t.anchor[e]=n.anchor[e],this.actionPacketFunctions(t.anchor,e),t.anchor.build()}),n.glyphStyles&&t.glyphStyles&&n.glyphStyles.forEach((e,i)=>{I(e)&&t.setGlyphStyles(e,i)}),t)return t;throw new Error("Failed to process supplied packet")}throw new Error("Failed to process packet - JSON string holds incomplete data")}throw new Error("Failed to process packet - JSON string does not represent an array")}throw new Error("Failed to process packet - not a JSON string")}catch(t){return console.log(t),t}},t.actionPacketFunctions=function(t,e){let i=t[e];if(q(i)&&null!==i&&i.substring)if("~~~"===i)t[e]=T;else{let s,n,r;[s,n]=i.split("~~~"),s=s.split(","),s=s.map(t=>t.trim()),n.indexOf("[native code]")<0?(r=new Function(...s,n),t[e]=r.bind(t)):t[e]=T}},t.clone=function(t={}){let e,i,s=this.name;this.name=t.name||"",t.useNewTicker?(i=this.ticker,this.ticker=null,e=this.saveAsPacket(),this.ticker=i):e=this.saveAsPacket(),this.name=s;let n=this.actionPacket(e);return this.packetFunctions.forEach(t=>{this[t]&&(n[t]=this[t])}),n=this.postCloneAction(n,t),n.set(t),n},t.postCloneAction=function(t,e){return t},t.kill=function(){return this.deregister()},t.makeName=function(t){return t&&t.substring&&S[this.lib+"names"].indexOf(t)<0?this.name=t:this.name=F(),this},t.register=function(){if(!q(this.name))throw new Error("core/base error - register() name not set: "+this);let t=S[this.lib+"names"],e=S[this.lib];return this.isArtefact&&(N(s,this.name),i[this.name]=this),this.isAsset&&(N(r,this.name),n[this.name]=this),N(t,this.name),e[this.name]=this,this},t.deregister=function(){if(!q(this.name))throw new Error("core/base error - deregister() name not set: "+this);let t=S[this.lib+"names"],e=S[this.lib];return this.isArtefact&&(W(s,this.name),delete i[this.name]),this.isAsset&&(W(r,this.name),delete n[this.name]),W(t,this.name),delete e[this.name],this},t}const Animation=function(t={}){return this.makeName(t.name),this.order=q(t.order)?t.order:this.defs.order,this.fn=t.fn||R,this.onRun=t.onRun||T,this.onHalt=t.onHalt||T,this.onKill=t.onKill||T,this.register(),t.delay||this.run(),this};let rt=Animation.prototype=Object.create(Object.prototype);rt.type="Animation",rt.lib="animation",rt.isArtefact=!1,rt.isAsset=!1,rt=nt(rt);rt.defs=Y(rt.defs,{order:1,fn:null,onRun:null,onHalt:null,onKill:null}),rt.stringifyFunction=T,rt.processPacketOut=T,rt.finalizePacketOut=T,rt.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},rt.clone=H,rt.run=function(){return this.onRun(),N(w,this.name),C(),this},rt.isRunning=function(){return w.indexOf(this.name)>=0},rt.halt=function(){return this.onHalt(),W(w,this.name),C(),this},rt.kill=function(){return this.onKill(),W(w,this.name),C(),this.deregister(),!0};const ot=function(t){return new Animation(t)};g.Animation=Animation;const at=[];let ht=!1,ct=!1;const lt={x:0,y:0,scrollX:0,scrollY:0,w:0,h:0,type:"mouse"},ut=function(t){let e=document.documentElement.clientWidth,i=document.documentElement.clientHeight;lt.w===e&&lt.h===i||(lt.w=e,lt.h=i,ct=!0)},dt=function(t){let e=window.pageXOffset,i=window.pageYOffset;lt.scrollX===e&&lt.scrollY===i||(lt.x+=e-lt.scrollX,lt.y+=i-lt.scrollY,lt.scrollX=e,lt.scrollY=i,ct=!0)},ft=function(t){let e=Math.round(t.pageX),i=Math.round(t.pageY);lt.x===e&&lt.y===i||(lt.type=navigator.pointerEnabled?"pointer":"mouse",lt.x=e,lt.y=i,ct=!0)},pt=function(t){if(("touchstart"===t.type||"touchmove"===t.type)&&t.touches&&t.touches[0]){let e=t.touches[0],i=Math.round(e.pageX),s=Math.round(e.pageY);lt.x===i&&lt.y===s||(lt.type="touch",lt.x=i,lt.y=s,mt())}},mt=function(){at.forEach(t=>gt(t))},gt=function(t){let e=i[t];if(!q(e))throw new Error("core/userInteraction updateUiSubscribedElement() error - artefact does not exist: "+t);let s=e.domElement;if(!L(s))throw new Error("core/userInteraction updateUiSubscribedElement() error - DOM element missing: "+t);let n=s.getBoundingClientRect(),r=Math.round(n.left+window.pageXOffset),o=Math.round(n.top+window.pageYOffset);e.here||(e.here={});let a=e.here;if(a.x=Math.round(lt.x-r),a.y=Math.round(lt.y-o),a.w=Math.round(n.width),a.h=Math.round(n.height),a.normX=!!a.w&&a.x/a.w,a.normY=!!a.h&&a.y/a.h,a.offsetX=r,a.offsetY=o,a.type=lt.type,a.active=!0,(a.normX<0||a.normX>1||a.normY<0||a.normY>1)&&(a.active=!1),"Canvas"===e.type&&e.updateBaseHere(a,e.fit),e.checkForResize&&!e.dirtyDimensions&&!e.dirtyDomDimensions){let[t,i]=e.currentDimensions;if("Canvas"===e.type){e.computedStyles||(e.computedStyles=window.getComputedStyle(e.domElement));let s=e.computedStyles,n=Math.floor(a.w-parseFloat(s.borderLeftWidth)-parseFloat(s.borderRightWidth)-parseFloat(s.paddingLeft)-parseFloat(s.paddingRight)),r=Math.floor(a.h-parseFloat(s.borderTopWidth)-parseFloat(s.borderBottomWidth)-parseFloat(s.paddingTop)-parseFloat(s.paddingBottom));t===n&&i===r||e.set({dimensions:[n,r]})}else t===a.w&&i===a.h||e.set({dimensions:[a.w,a.h]})}},yt=ot({name:"coreListenersTracker",order:0,delay:!0,fn:function(){return new Promise(t=>{at.length||t(!1),ht&&ct&&(ct=!1,mt()),t(!0)})}}),bt=function(){Pt("removeEventListener"),Pt("addEventListener"),ht=!0,ct=!0,yt.run()},Pt=function(t){navigator.pointerEnabled||navigator.msPointerEnabled?(window[t]("pointermove",ft,!1),window[t]("pointerup",ft,!1),window[t]("pointerdown",ft,!1),window[t]("pointerleave",ft,!1),window[t]("pointerenter",ft,!1)):(window[t]("mousemove",ft,!1),window[t]("mouseup",ft,!1),window[t]("mousedown",ft,!1),window[t]("mouseleave",ft,!1),window[t]("mouseenter",ft,!1),window[t]("touchmove",pt,!1),window[t]("touchstart",pt,!1),window[t]("touchend",pt,!1),window[t]("touchcancel",pt,!1)),window[t]("scroll",dt,!1),window[t]("resize",ut,!1)},St=function(){ut(),ct=!0},vt=URL.createObjectURL(new Blob(["\nif (!Uint8Array.prototype.slice) {\n    Object.defineProperty(Uint8Array.prototype, 'slice', {\n        value: function (begin, end) {\n            return new Uint8Array(Array.prototype.slice.call(this, begin, end));\n        }\n    });\n}\n\nlet packet;\nlet image;\nlet iWidth;\nlet data;\nlet cache;\nlet tiles;\nlet localX;\nlet localY;\nlet localWidth;\nlet localHeight;\nlet filters;\nlet filter;\nlet action;\n\nonmessage = function (e) {\n\n    let i, iz;\n\n    packet = e.data;\n    image = packet.image;\n    iWidth = image.width * 4;\n    data = image.data;\n    filters = packet.filters;\n\n    getCache();\n    getLocal();\n\n    for (i = 0, iz = filters.length; i < iz; i++) {\n\n        filter = filters[i];\n\n        if (filter.method === 'userDefined' && filter.userDefined) actions.userDefined = new Function(filter.userDefined);\n\n        action = actions[filter.method];\n\n        if (action) action();\n    }\n\n    postMessage(packet);\n};\n\nonerror = function (e) {\n\n    console.log('error' + e.message);\n    postMessage(packet);\n};\n\nconst getCache = function () {\n\n    let i, iz;\n\n    if (Array.isArray(cache)) cache.length = 0;\n    else cache = [];\n\n    for (i = 0, iz = data.length; i < iz; i += 4) {\n\n        if (data[i + 3]) cache.push(i);\n    }\n};\n\nconst getLocal = function () {\n\n    let i, iz, w, h, minX, minY, maxX, maxY, x, y, val,\n        floor = Math.floor;\n\n    w = image.width;\n    h = image.height;\n    minX = w;\n    minY = h;\n    maxX = 0;\n    maxY = 0;\n\n    for (i = 0, iz = cache.length; i < iz; i++) {\n\n        val = cache[i] / 4;\n        y = floor(val / w);\n        x = val % w;\n        minX = (x < minX) ? x : minX;\n        minY = (y < minY) ? y : minY;\n        maxX = (x > maxX) ? x : maxX;\n        maxY = (y > maxY) ? y : maxY;\n    }\n\n    localX = minX;\n    localY = minY;\n    localWidth = maxX - minX;\n    localHeight = maxY - minY;\n};\n\nconst getTiles = function () {\n\n    let i, iz, j, jz, x, xz, y, yz, startX, startY, pos, \n        hold = [],\n        tileWidth = filter.tileWidth || 1,\n        tileHeight = filter.tileHeight || 1,\n        offsetX = filter.offsetX,\n        offsetY = filter.offsetY,\n        w = image.width,\n        h = image.height;\n\n    if (Array.isArray(tiles)) tiles.length = 0;\n    else tiles = [];\n\n    offsetX = (offsetX >= tileWidth) ? tileWidth - 1 : offsetX;\n    offsetY = (offsetY >= tileHeight) ? tileHeight - 1 : offsetY;\n\n    startX = (offsetX) ? offsetX - tileWidth : 0;\n    startY = (offsetY) ? offsetY - tileHeight : 0;\n\n    for (j = startY, jz = h + tileHeight; j < jz; j += tileHeight) {\n\n        for (i = startX, iz = w + tileWidth; i < iz; i += tileWidth) {\n\n            hold.length = 0;\n            \n            for (y = j, yz = j + tileHeight; y < yz; y++) {\n\n                if (y >= 0 && y < h) {\n\n                    for (x = i, xz = i + tileWidth; x < xz; x++) {\n\n                        if (x >= 0 && x < w) {\n\n                            pos = (y * iWidth) + (x * 4);\n\n                            if (data[pos + 3]) hold.push(pos);\n                        }\n                    }\n                }\n            }\n            if (hold.length) tiles.push([].concat(hold));\n        }\n    }\n};\n\nconst average = function (c) {\n\n    let a = 0,\n        k, kz,\n        l = c.length;\n\n    if (l) {\n\n        for (k = 0, kz = l; k < kz; k++) {\n\n            a +=c[k];\n        }\n        return a / l;\n    }\n    return 0;\n};\n\nconst checkBounds = function (p) {\n\n    let len = data.length;\n\n    if (p < 0) p += len;\n    if (p >= len) p -= len;\n    return p;\n};\n\nconst actions = {\n\n\n    userDefined: function () {},\n\n    grayscale: function () {\n\n        let i, iz, pos, gray;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            gray = (0.2126 * data[pos]) + (0.7152 * data[pos + 1]) + (0.0722 * data[pos + 2]);\n            data[pos] = data[pos + 1] = data[pos + 2] = gray;\n        }\n    },\n\n    sepia: function () {\n\n        let i, iz, pos, r, g, b;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            \n            r = data[pos];\n            g = data[pos + 1];\n            b = data[pos + 2];\n            \n            data[pos] = (r * 0.393) + (g * 0.769) + (b * 0.189);\n            data[pos + 1] = (r * 0.349) + (g * 0.686) + (b * 0.168);\n            data[pos + 2] = (r * 0.272) + (g * 0.534) + (b * 0.131);\n        }\n    },\n\n    invert: function () {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] = 255 - data[pos];\n            \n            pos++;\n            data[pos] = 255 - data[pos];\n            \n            pos++;\n            data[pos] = 255 - data[pos];\n        }\n    },\n\n    red: function () {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos + 1] = 0;\n            data[pos + 2] = 0;\n        }\n    },\n\n    green: function () {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] = 0;\n            data[pos + 2] = 0;\n        }\n    },\n\n    blue: function () {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] = 0;\n            data[pos + 1] = 0;\n        }\n    },\n\n    notred: function() {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] = 0;\n        }\n    },\n\n    notgreen: function () {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos + 1] = 0;\n        }\n    },\n\n    notblue: function () {\n\n        let i, iz, pos;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos + 2] = 0;\n        }\n    },\n\n    cyan: function () {\n\n        let i, iz, pos, gray;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            \n            gray = (data[pos + 1] + data[pos + 2]) / 2;\n            \n            data[pos] = 0;\n            data[pos + 1] = gray;\n            data[pos + 2] = gray;\n        }\n    },\n\n    magenta: function () {\n\n        let i, iz, pos, gray;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n\n            gray = (data[pos] + data[pos + 2]) / 2;\n\n            data[pos] = gray;\n            data[pos + 1] = 0;\n            data[pos + 2] = gray;\n        }\n    },\n\n    yellow: function () {\n\n        let i, iz, pos, gray;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            \n            gray = (data[pos] + data[pos + 1]) / 2;\n            \n            data[pos] = gray;\n            data[pos + 1] = gray;\n            data[pos + 2] = 0;\n        }\n    },\n\n    brightness: function () {\n\n        let i, iz, pos, \n            level = filter.level || 0;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] *= level;\n            \n            pos++;\n            data[pos] *= level;\n            \n            pos++;\n            data[pos] *= level;\n        }\n    },\n\n    saturation: function () {\n\n        let i, iz, pos, \n            level = filter.level || 0;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] = 127 + ((data[pos] - 127) * level);\n            \n            pos++;\n            data[pos] = 127 + ((data[pos] - 127) * level);\n            \n            pos++;\n            data[pos] = 127 + ((data[pos] - 127) * level);\n        }\n    },\n\n    threshold: function () {\n\n        let i, iz, pos, gray, test,\n            level = filter.level || 0,\n            lowRed = filter.lowRed,\n            lowGreen = filter.lowGreen,\n            lowBlue = filter.lowBlue,\n            highRed = filter.highRed,\n            highGreen = filter.highGreen,\n            highBlue = filter.highBlue;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            \n            gray = (0.2126 * data[pos]) + (0.7152 * data[pos + 1]) + (0.0722 * data[pos + 2]);\n            test = (gray > level) ? true : false;\n            \n            if (test) {\n\n                data[pos] = highRed;\n                data[pos + 1] = highGreen;\n                data[pos + 2] = highBlue;\n            }\n            else {\n\n                data[pos] = lowRed;\n                data[pos + 1] = lowGreen;\n                data[pos + 2] = lowBlue;\n            }\n            \n        }\n    },\n\n    channels: function () {\n\n        let i, iz, pos,\n            red = filter.red || 0,\n            green = filter.green || 0,\n            blue = filter.blue || 0;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            \n            data[pos] *= red;\n            data[pos + 1] *= green;\n            data[pos + 2] *= blue;\n        }\n    },\n\n    channelstep: function () {\n\n        let i, iz, pos,\n            red = filter.red || 1,\n            green = filter.green || 1,\n            blue = filter.blue || 1,\n            floor = Math.floor;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            data[pos] = floor(data[pos] / red) * red;\n            \n            pos++;\n            data[pos] = floor(data[pos] / green) * green;\n            \n            pos++;\n            data[pos] = floor(data[pos] / blue) * blue;\n        }\n    },\n\n    tint: function () {\n\n        let i, iz, pos, r, g, b,\n            redInRed = filter.redInRed || 0,\n            redInGreen = filter.redInGreen || 0,\n            redInBlue = filter.redInBlue || 0,\n            greenInRed = filter.greenInRed || 0,\n            greenInGreen = filter.greenInGreen || 0,\n            greenInBlue = filter.greenInBlue || 0,\n            blueInRed = filter.blueInRed || 0,\n            blueInGreen = filter.blueInGreen || 0,\n            blueInBlue = filter.blueInBlue || 0;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            pos = cache[i];\n            \n            r = data[pos];\n            g = data[pos + 1];\n            b = data[pos + 2];\n            \n            data[pos] = (r * redInRed) + (g * greenInRed) + (b * blueInRed);\n            data[pos + 1] = (r * redInGreen) + (g * greenInGreen) + (b * blueInGreen);\n            data[pos + 2] = (r * redInBlue) + (g * greenInBlue) + (b * blueInBlue);\n        }\n    },\n\n    chroma: function () {\n\n        let pos, posA,\n            ranges = filter.ranges,\n            range, min, max, val,\n            i, iz, j, jz, flag;\n\n        for (j = 0, jz = cache.length; j < jz; j++) {\n\n            flag = false;\n\n            for (i = 0, iz = ranges.length; i < iz; i++) {\n\n                posA = cache[j] + 3;\n                range = ranges[i];\n                min = range[2];\n                pos = posA - 1;\n                val = data[pos];\n\n                if (val >= min) {\n\n                    max = range[5];\n\n                    if (val <= max) {\n\n                        min = range[1];\n                        pos--;\n                        val = data[pos];\n\n                        if (val >= min) {\n\n                            max = range[4];\n\n                            if (val <= max) {\n\n                                min = range[0];\n                                pos--;\n                                val = data[pos];\n\n                                if (val >= min) {\n\n                                    max = range[3];\n\n                                    if (val <= max) {\n                                        flag = true;\n                                        break;\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n            if (flag) data[posA] = 0;\n        }\n    },\n\n    pixelate: function () {\n\n        let i, iz, j, jz, pos, r, g, b, a, tile, len;\n\n        getTiles();\n\n        for (i = 0, iz = tiles.length; i < iz; i++) {\n\n            tile = tiles[i];\n            r = g = b = a = 0;\n            len = tile.length;\n\n            if (len) {\n\n                for (j = 0, jz = len; j < jz; j++) {\n\n                    pos = tile[j];\n\n                    r += data[pos];\n                    g += data[pos + 1];\n                    b += data[pos + 2];\n                    a += data[pos + 3];\n                }\n\n                r /= len;\n                g /= len;\n                b /= len;\n                a /= len;\n\n                for (j = 0, jz = len; j < jz; j++) {\n\n                    pos = tile[j];\n\n                    data[pos] = r;\n                    data[pos + 1] = g;\n                    data[pos + 2] = b;\n                    data[pos + 3] = a;\n                }\n            }\n        }\n    },\n\n    blur: function () {\n\n        if (data.slice) {\n\n            let radius = filter.radius || 1,\n                alpha = filter.includeAlpha || false,\n                shrink = filter.shrinkingRadius || false,\n                passes = filter.passes || 1,\n                len = data.length,\n                imageWidth = image.width,\n                imageHeight = image.height,\n                tempDataTo, tempDataFrom,\n                i, iz, index;\n\n            let processPass = function () {\n\n                let j, jz;\n\n                tempDataFrom = tempDataTo.slice(); \n\n                for (j = localX * 4, jz = (localX + localWidth) * 4; j < jz; j++) {\n\n                    if (alpha) processColumn(j);\n                    else {\n\n                        if (j % 4 !== 3) processColumn(j);\n                    }\n                }\n\n                tempDataFrom = tempDataTo.slice(); \n\n                for (j = localY, jz = localY + localHeight; j < jz; j++) {\n\n                    if (alpha) processRowWithAlpha(j);\n                    else processRowNoAlpha(j);\n                }\n            };\n\n            let processColumn = function (col) {\n\n                let pos, avg, val, cagePointer, y, yz, q, dataPointer,\n                    vLead = radius * iWidth, \n                    cage = [],\n                    cageLen;\n\n                for (y = -radius, yz = radius; y < yz; y++) {\n\n                    pos = col + (y * iWidth);\n                    pos = checkBounds(pos, len);\n                    cage.push(tempDataFrom[pos]);\n                }\n\n                tempDataTo[col] = avg = average(cage);\n\n                cageLen = cage.length;\n\n                for (q = 0; q < cageLen; q++) {\n\n                    cage[q] /= cageLen;\n                }\n\n                cagePointer = 0;\n\n                for (y = 1; y < imageHeight; y++) {\n\n                    avg -= cage[cagePointer];\n\n                    dataPointer = col + (y * iWidth);\n                    pos = dataPointer + vLead;\n                    pos = checkBounds(pos, len);\n                    val = tempDataFrom[pos] / cageLen;\n\n                    avg += val;\n                    cage[cagePointer] = val;\n                    tempDataTo[dataPointer] = avg;\n\n                    cagePointer++;\n\n                    if (cagePointer === cageLen) cagePointer = 0;\n                }\n            };\n\n            let processRowWithAlpha = function (row) {\n\n                let pos, val, x, xz, q, avgQ, cageQ, rowPosX,\n                    avg = [],\n                    cage = [[], [], [], []],\n                    rowPos = row * iWidth, \n                    hLead = radius * 4,\n                    dataPointer, cagePointer, cageLen;\n\n                q = 0;\n\n                for (x = -radius * 4, xz = radius * 4; x < xz; x++) {\n\n                    pos = rowPos + x;\n                    pos = checkBounds(pos, len);\n                    \n                    cage[q].push(tempDataFrom[pos]);\n                    \n                    q++;\n                    if (q === 4) q = 0;\n                }\n\n                tempDataTo[rowPos] = avg[0] = average(cage[0]);\n                tempDataTo[rowPos + 1] = avg[1] = average(cage[1]);\n                tempDataTo[rowPos + 2] = avg[2] = average(cage[2]);\n                tempDataTo[rowPos + 3] = avg[3] = average(cage[3]);\n\n                cageLen = cage[0].length;\n\n                for (q = 0; q < 4; q++) {\n\n                    for (x = 0; x < cageLen; x++) {\n\n                        cage[q][x] /= cageLen;\n                    }\n                }\n                cagePointer = 0;\n\n                for (x = 1; x < imageHeight; x++) {\n\n                    rowPosX = rowPos + (x * 4);\n\n                    for (q = 0; q < 4; q++) {\n\n                        avgQ = avg[q];\n                        cageQ = cage[q];\n                        avgQ -= cageQ[cagePointer];\n\n                        dataPointer = rowPosX + q;\n                        pos = dataPointer + hLead;\n                        pos = checkBounds(pos, len);\n                        val = tempDataFrom[pos] / cageLen;\n\n                        avgQ += val;\n                        tempDataTo[dataPointer] = avgQ;\n                        avg[q] = avgQ;\n                        cageQ[cagePointer] = val;\n                    }\n\n                    cagePointer++;\n\n                    if (cagePointer === cageLen) cagePointer = 0;\n                }\n            };\n\n            let processRowNoAlpha = function (row) {\n\n                let pos, val, x, xz, q, avgQ, cageQ, rowPosX,\n                    avg = [],\n                    hLead = radius * 4,\n                    cage = [[], [], []],\n                    rowPos = row * iWidth, \n                    dataPointer, cagePointer, cageLen;\n\n                q = 0;\n\n                for (x = -radius * 4, xz = radius * 4; x < xz; x++) {\n\n                    if (q < 3) {\n\n                        pos = rowPos + x;\n                        pos = checkBounds(pos, len);\n                        cage[q].push(tempDataFrom[pos]);\n                        q++;\n                    }\n                    else q = 0;\n                }\n\n                tempDataTo[rowPos] = avg[0] = average(cage[0]);\n                tempDataTo[rowPos + 1] = avg[1] = average(cage[1]);\n                tempDataTo[rowPos + 2] = avg[2] = average(cage[2]);\n\n                cageLen = cage[0].length;\n\n                for (q = 0; q < 3; q++) {\n\n                    cageQ = cage[q];\n                    \n                    for (x = 0; x < cageLen; x++) {\n\n                        cageQ[x] /= cageLen;\n                    }\n                }\n                cagePointer = 0;\n\n                for (x = 1; x < imageHeight; x++) {\n\n                    rowPosX = rowPos + (x * 4);\n\n                    for (q = 0; q < 3; q++) {\n\n                        avgQ = avg[q];\n                        cageQ = cage[q];\n                        avgQ -= cageQ[cagePointer];\n\n                        dataPointer = rowPosX + q;\n                        pos = dataPointer + hLead;\n                        pos = checkBounds(pos, len);\n                        val = tempDataFrom[pos] / cageLen;\n\n                        avgQ += val;\n                        tempDataTo[dataPointer] = avgQ;\n                        avg[q] = avgQ;\n                        cageQ[cagePointer] = val;\n                    }\n\n                    cagePointer++;\n                    if (cagePointer === cageLen) cagePointer = 0;\n                }\n            };\n\n            tempDataTo = data.slice();\n\n            for (i = 0; i < passes; i++) {\n\n                processPass();\n                \n                if (shrink) {\n\n                    radius = Math.ceil(radius * 0.3);\n                    radius = (radius < 1) ? 1 : radius;\n                }\n            }\n\n            for (i = 0, iz = cache.length; i < iz; i++) {\n\n                index = cache[i];\n                data[index] = tempDataTo[index];\n                \n                index++;\n                data[index] = tempDataTo[index];\n                \n                index++;\n                data[index] = tempDataTo[index];\n                \n                if (alpha) {\n\n                    index++;\n                    data[index] = tempDataTo[index];\n                }\n            }\n        }\n    },\n\n    matrix: function () {\n\n        let i, iz, j, jz, pos, weight, sumR, sumG, sumB, sumA, homePos,\n            len = data.length,\n            alpha = filter.includeAlpha || false,\n            offset = [],\n            weights = filter.weights || [0, 0, 0, 0, 1, 0, 0, 0, 0],\n            tempCache = [],\n            cursor = 0;\n\n        offset[0] = -iWidth - 4;\n        offset[1] = -iWidth;\n        offset[2] = -iWidth + 4;\n        offset[3] = -4;\n        offset[4] = 0;\n        offset[5] = 4;\n        offset[6] = iWidth - 4;\n        offset[7] = iWidth;\n        offset[8] = iWidth + 4;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            homePos = cache[i];\n            sumR = sumG = sumB = sumA = 0;\n            \n            for (j = 0, jz = offset.length; j < jz; j++) {\n\n                pos = homePos + offset[j];\n                \n                if (pos >= 0 && pos < len) {\n\n                    weight = weights[j];\n                    sumR += data[pos] * weight;\n                    \n                    pos++;\n                    sumG += data[pos] * weight;\n                    \n                    pos++;\n                    sumB += data[pos] * weight;\n                    \n                    if (alpha) {\n\n                        pos++;\n                        sumA += data[pos] * weight;\n                    }\n                }\n            }\n\n            tempCache[cursor] = sumR;\n            cursor++;\n\n            tempCache[cursor] = sumG;\n            cursor++;\n\n            tempCache[cursor] = sumB;\n            cursor++;\n\n            if (alpha) {\n\n                tempCache[cursor] = sumA;\n                cursor++;\n            }\n        }\n\n        cursor = 0;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            homePos = cache[i];\n            data[homePos] = tempCache[cursor];\n            cursor++;\n\n            homePos++;\n            data[homePos] = tempCache[cursor];\n            cursor++;\n\n            homePos++;\n            data[homePos] = tempCache[cursor];\n            cursor++;\n\n            if (alpha) {\n\n                homePos++;\n                data[homePos] = tempCache[cursor];\n                cursor++;\n            }\n        }\n    },\n\n    matrix5: function () {\n\n        let i, iz, j, jz, pos, weight, sumR, sumG, sumB, sumA, homePos,\n            len = data.length,\n            alpha = filter.includeAlpha || false,\n            offset = [],\n            weights = filter.weights || [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 1, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0],\n            tempCache = [],\n            iWidth2 = iWidth * 2,\n            cursor = 0;\n\n        offset[0] = -iWidth2 - 8;\n        offset[1] = -iWidth2 - 4;\n        offset[2] = -iWidth2;\n        offset[3] = -iWidth2 + 4;\n        offset[4] = -iWidth2 + 8;\n        offset[5] = -iWidth - 8;\n        offset[6] = -iWidth - 4;\n        offset[7] = -iWidth;\n        offset[8] = -iWidth + 4;\n        offset[9] = -iWidth + 8;\n        offset[10] = -8;\n        offset[11] = -4;\n        offset[12] = 0;\n        offset[13] = 4;\n        offset[14] = 8;\n        offset[15] = iWidth - 8;\n        offset[16] = iWidth - 4;\n        offset[17] = iWidth;\n        offset[18] = iWidth + 4;\n        offset[19] = iWidth + 8;\n        offset[20] = iWidth2 - 8;\n        offset[21] = iWidth2 - 4;\n        offset[22] = iWidth2;\n        offset[23] = iWidth2 + 4;\n        offset[24] = iWidth2 + 8;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            homePos = cache[i];\n            sumR = sumG = sumB = sumA = 0;\n            \n            for (j = 0, jz = offset.length; j < jz; j++) {\n\n                pos = homePos + offset[j];\n                \n                if (pos >= 0 && pos < len) {\n\n                    weight = weights[j];\n                    sumR += data[pos] * weight;\n\n                    pos++;\n                    sumG += data[pos] * weight;\n\n                    pos++;\n                    sumB += data[pos] * weight;\n\n                    if (alpha) {\n\n                        pos++;\n                        sumA += data[pos] * weight;\n                    }\n                }\n            }\n\n            tempCache[cursor] = sumR;\n            cursor++;\n\n            tempCache[cursor] = sumG;\n            cursor++;\n\n            tempCache[cursor] = sumB;\n            cursor++;\n\n            if (alpha) {\n\n                tempCache[cursor] = sumA;\n                cursor++;\n            }\n        }\n\n        cursor = 0;\n\n        for (i = 0, iz = cache.length; i < iz; i++) {\n\n            homePos = cache[i];\n            data[homePos] = tempCache[cursor];\n            cursor++;\n\n            homePos++;\n            data[homePos] = tempCache[cursor];\n            cursor++;\n\n            homePos++;\n            data[homePos] = tempCache[cursor];\n            cursor++;\n\n            if (alpha) {\n                \n                homePos++;\n                data[homePos] = tempCache[cursor];\n                cursor++;\n            }\n        }\n    },\n};"],{type:"text/javascript"})),Filter=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this};let kt=Filter.prototype=Object.create(Object.prototype);kt.type="Filter",kt.lib="filter",kt.isArtefact=!1,kt.isAsset=!1,kt=nt(kt);kt.defs=Y(kt.defs,{method:"",level:0,lowRed:0,lowGreen:0,lowBlue:0,highRed:255,highGreen:255,highBlue:255,red:0,green:0,blue:0,redInRed:0,redInGreen:0,redInBlue:0,greenInRed:0,greenInGreen:0,greenInBlue:0,blueInRed:0,blueInGreen:0,blueInBlue:0,offsetX:0,offsetY:0,tileWidth:1,tileHeight:1,radius:1,passes:1,shrinkingRadius:!1,includeAlpha:!1,weights:null,ranges:null,userDefined:"",udVariable0:"",udVariable1:"",udVariable2:"",udVariable3:"",udVariable4:"",udVariable5:"",udVariable6:"",udVariable7:"",udVariable8:"",udVariable9:""}),kt.kill=function(){let t=this.name;return Object.entries(c).forEach(([e,i])=>{let s=i.filters;s&&s.indexOf(t)>=0&&W(s,t)}),Object.entries(u).forEach(([e,i])=>{let s=i.filters;s&&s.indexOf(t)>=0&&W(s,t)}),Object.entries(a).forEach(([e,i])=>{let s=i.filters;s&&s.indexOf(t)>=0&&W(s,t)}),this.deregister(),this};const wt=[],Ct=function(){return wt.length||wt.push(Dt()),wt.shift()},Ot=function(t){wt.push(t)},Dt=function(){return new Worker(vt)},At=function(t,e){return new Promise((i,s)=>{t.onmessage=t=>{t&&t.data&&t.data.image?i(t.data.image):i(!1)},t.onerror=t=>{console.log("error",t.lineno,t.message),i(!1)},t.postMessage(e)})};g.Filter=Filter;const State=function(t={}){return this.set(this.defs),this.lineDash=[],this.set(t),this};let Et=State.prototype=Object.create(Object.prototype);Et.type="State",Et=nt(Et),Et.defs={fillStyle:"rgba(0,0,0,1)",strokeStyle:"rgba(0,0,0,1)",globalAlpha:1,globalCompositeOperation:"source-over",lineWidth:1,lineCap:"butt",lineJoin:"miter",lineDash:null,lineDashOffset:0,miterLimit:10,shadowOffsetX:0,shadowOffsetY:0,shadowBlur:0,shadowColor:"rgba(0,0,0,0)",font:"12px sans-serif",textAlign:"left",textBaseline:"top"},Et.processPacketOut=function(t,e,i){let s=!0;switch(t){case"lineDash":e.length||(s=i.indexOf("lineDash")>=0);break;default:i.indexOf(t)<0&&e===this.defs[t]&&(s=!1)}return s},Et.finalizePacketOut=function(t,e){let i=t.fillStyle,s=t.strokeStyle;return i&&!i.substring&&(t.fillStyle=i.name),s&&!s.substring&&(t.strokeStyle=s.name),t},Et.set=function(t){let e,i,s,n=Object.keys(t),r=this.defs;for(i=0,s=n.length;i<s;i++)e=n[i],"name"!==e&&void 0!==r[e]&&(this[e]=t[e]);return this},Et.get=function(t){let e,i;return e=this.defs[t],void 0!==e?(i=this[t],void 0!==i?i:e):void 0};Et.getters;let Tt=Et.setters;Et.deltaSetters;Tt.fillStyle=function(t){let e;I(t)&&"styles"===t.lib?this.fillStyle=t:(e=f[t],this.fillStyle=e||t)},Tt.strokeStyle=function(t){let e;I(t)&&"styles"===t.lib?this.strokeStyle=t:(e=f[t],this.strokeStyle=e||t)},Et.allKeys=Object.keys(Et.defs),Et.mainKeys=["globalAlpha","globalCompositeOperation","shadowOffsetX","shadowOffsetY","shadowBlur"],Et.lineKeys=["lineWidth","lineCap","lineJoin","lineDash","lineDashOffset","miterLimit"],Et.styleKeys=["fillStyle","strokeStyle","shadowColor"],Et.textKeys=["font"],Et.getChanges=function(t,e){let i,s,n,r,o,a,h,l,u,d=this.mainKeys,f=this.lineKeys,p=this.styleKeys,m=this.textKeys,g=this.defs,y={},b=function(t,e){return void 0!==t[e]?t[e]:g[e]};for(t.substring&&(t=c[t]),n=0,r=d.length;n<r;n++)i=d[n],l=b(this,i),u=b(e,i),u!==l&&(y[i]=l);if(this.lineWidth||e.lineWidth)for(n=0,r=f.length;n<r;n++)if(i=f[n],l=b(this,i),u=b(e,i),"lineDash"==i){if(l.length||u.length)if(l.length!=u.length)y.lineDash=l;else{for(h=!1,o=0,a=l.length;o<a;o++)if(l[o]!=u[o]){h=!0;break}h&&(y.lineDash=l)}}else"lineWidth"==i?t.scaleOutline?(s=(l||1)*(t.scale||1),s!==u&&(y.lineWidth=s)):l!==u&&(y.lineWidth=l):u!==l&&(y[i]=l);for(n=0,r=p.length;n<r;n++)i=p[n],u=b(e,i),l=b(this,i),l.substring&&u!==l?y[i]=l:"Color"===l.type?(l=l.getData(),u!==l&&(y[i]=l)):y[i]=l;if("Phrase"===t.type)for(n=0,r=m.length;n<r;n++)i=m[n],l=b(this,i),u=b(e,i),u!==l&&(y[i]=l);return y},Et.setStateFromEngine=function(t){let e,i=this.allKeys;for(let s=0,n=i.length;s<n;s++)e=i[s],this[e]=t[e];return this.lineDash=q(t.lineDash)?t.lineDash:[],this.lineDashOffset=G(t.lineDashOffset,0),t.textAlign=this.textAlign="left",t.textBaseline=this.textBaseline="top",this};const Ht=function(t){return new State(t)};g.State=State;const Coordinate=function(t,e){let i=[0,0];return Object.setPrototypeOf(i,Coordinate.prototype),t&&i.set(t,e),i};let Rt=Coordinate.prototype=Object.create(Array.prototype);Rt.constructor=Coordinate,Rt.type="Coordinate",Rt.set=function(t,e){return"Coordinate"===t.type?this.setFromArray(t):"Vector"===t.type?this.setFromVector(t):"Quaternion"===t.type?this.setFromVector(t.v):Array.isArray(t)?this.setFromArray(t):q(e)&&this.setFromArray([t,e]),this},Rt.setFromArray=function(t){return this[0]=t[0],this[1]=t[1],this},Rt.setFromVector=function(t){let{x:e,y:i}=t;return this[0]=e,this[1]=i,this},Rt.zero=function(){return this[0]=0,this[1]=0,this},Rt.vectorAdd=function(t){let{x:e,y:i}=t;return this[0]+=e,this[1]+=i,this},Rt.vectorSubtract=function(t){let{x:e,y:i}=t;return this[0]-=e,this[1]-=i,this},Rt.add=function(t){let[e,i]=t;return this[0]+=e,this[1]+=i,this},Rt.subtract=function(t){let[e,i]=t;return this[0]-=e,this[1]-=i,this},Rt.multiply=function(t){let[e,i]=t;return this[0]*=e,this[1]*=i,this},Rt.divide=function(t){let[e,i]=t;return e&&i&&(this[0]/=e,this[1]/=i),this},Rt.scalarMultiply=function(t){return this[0]*=t,this[1]*=t,this},Rt.scalarDivide=function(t){return t&&t.toFixed&&(this[0]/=t,this[1]/=t),this},Rt.getMagnitude=function(){let t=this[0],e=this[1];return Math.sqrt(t*t+e*e)},Rt.rotate=function(t){let e=[0,0],i=this[0],s=this[1];return e[0]=Math.atan2(s,i),e[0]+=.01745329251*t,e[1]=Math.sqrt(i*i+s*s),this[0]=e[1]*Math.cos(e[0]),this[1]=e[1]*Math.sin(e[0]),this},Rt.reverse=function(){return this[0]=-this[0],this[1]=-this[1],this},Rt.getDotProduct=function(t){return this[0]*t[0]+this[1]*t[1]},Rt.normalize=function(){let t=this.getMagnitude();return t>0&&(this[0]/=t,this[1]/=t),this};const Ft=[],Bt=function(t){return new Coordinate(t)};function jt(t={}){t.defs=Y(t.defs,{sourceLoaded:!1,source:null,subscribers:null}),t.packetExclusions=N(t.packetExclusions,["sourceLoaded","source","subscribers"]),t.finalizePacketOut=function(t,e){return this.subscribers&&this.subscribers.length&&(t.subscribers=this.subscribers.map(t=>t.name)),t};t.getters;let e=t.setters;t.deltaSetters;return e.source=function(t={}){t&&this.sourceLoaded&&this.notifySubscribers()},e.subscribers=T,t.assetConstructor=function(t={}){return this.makeName(t.name),this.register(),this.subscribers=[],this.set(this.defs),this.set(t),t.subscribe&&this.subscribers.push(t.subscribe),this},t.subscribe=function(t={}){if(t&&t.name){let e=t.name;this.subscribers.every(t=>t.name!==e)&&this.subscribeAction(t)}},t.subscribeAction=function(t={}){this.subscribers.push(t),t.asset=this,t.source=this.source,this.notifySubscriber(t)},t.unsubscribe=function(t={}){if(t.name){let e=t.name,i=this.subscribers.findIndex(t=>t.name===e);i>=0&&(t.source=null,t.asset=null,t.sourceNaturalHeight=0,t.sourceNaturalWidth=0,t.sourceLoaded=!1,this.subscribers.splice(i,1))}},t.notifySubscribers=function(){this.subscribers.forEach(t=>this.notifySubscriber(t),this)},t.notifySubscriber=function(t){t.sourceNaturalWidth=this.sourceNaturalWidth,t.sourceNaturalHeight=this.sourceNaturalHeight,t.sourceLoaded=this.sourceLoaded,t.source=this.source,t.dirtyImage=!0,t.dirtyCopyStart=!0,t.dirtyCopyDimensions=!0,t.dirtyImageSubscribers=!0},t}g.Coordinate=Coordinate;const ImageAsset=function(t={}){return this.assetConstructor(t)};let Lt=ImageAsset.prototype=Object.create(Object.prototype);Lt.type="Image",Lt.lib="asset",Lt.isArtefact=!1,Lt.isAsset=!0,Lt=nt(Lt),Lt=jt(Lt);Lt.defs=Y(Lt.defs,{intrinsicDimensions:null}),Lt.saveAsPacket=function(){return[this.name,this.type,this.lib,{}]},Lt.stringifyFunction=T,Lt.processPacketOut=T,Lt.finalizePacketOut=T,Lt.clone=H;Lt.getters;let Mt=Lt.setters;Lt.deltaSetters;Mt.source=function(t={}){t&&(["IMG","PICTURE"].indexOf(t.tagName.toUpperCase())>=0&&(this.source=t,this.sourceNaturalWidth=t.naturalWidth,this.sourceNaturalHeight=t.naturalHeight,this.sourceLoaded=t.complete),this.sourceLoaded&&this.notifySubscribers())},Mt.currentSrc=function(t){this.currentSrc=t,this.currentFile=this.currentSrc.split("/").pop()},Lt.checkSource=function(t,e){let i=this.source,s="element";if(this.sourceLoaded){let n=this.intrinsicDimensions[this.currentFile];switch(this.currentSrc!==i.currentSrc?(this.set({currentSrc:i.currentSrc}),n=this.intrinsicDimensions[this.currentFile],s=n?"intrinsic":"zero"):n&&(s="intrinsic"),s){case"zero":this.sourceNaturalWidth=0,this.sourceNaturalHeight=0,this.notifySubscribers();break;case"intrinsic":this.sourceNaturalWidth===n[0]&&this.sourceNaturalHeight===n[1]||(this.sourceNaturalWidth=n[0],this.sourceNaturalHeight=n[1],this.notifySubscribers());break;default:this.sourceNaturalWidth===i.naturalWidth&&this.sourceNaturalHeight===i.naturalHeight&&this.sourceNaturalWidth===t&&this.sourceNaturalHeight===e||(this.sourceNaturalWidth=i.naturalWidth,this.sourceNaturalHeight=i.naturalHeight,this.notifySubscribers())}}};const zt=[],It=[],Xt=function(...t){let e=/.*\/(.*?)\./,i=[];return t.forEach(t=>{let s,n,r,o,a=!1,h=!1;if(t.substring){let i=e.exec(t);s=i&&i[1]?i[1]:"",n=t,r="",o=!1,h=!0}else(t=!!I(t)&&t)&&t.src&&(s=t.name||"",n=t.src,r=t.className||"",o=t.visibility||!1,t.parent&&(a=document.querySelector(t.parent)),h=!0);if(h){let t=$t({name:s,intrinsicDimensions:{}}),e=document.createElement("img");e.name=s,e.className=r,e.crossorigin="anonymous",e.style.display=o?"block":"none",a&&a.appendChild(e),e.onload=()=>{t.set({source:e})},e.src=n,t.set({source:e}),i.push(s)}else i.push(!1)}),i},Yt=function(t){let e=/.*\/(.*?)\./;document.querySelectorAll(t).forEach(t=>{let i;if(["IMG","PICTURE"].indexOf(t.tagName.toUpperCase())>=0){if(t.id||t.name)i=t.id||t.name;else{let s=e.exec(t.src);i=s&&s[1]?s[1]:""}let s=t.dataset.dimensions||{};s.substring&&(s=JSON.parse(s));let n=$t({name:i,source:t,intrinsicDimensions:s,currentSrc:t.currentSrc});t.onload=()=>{n.set({source:t})}}})},$t=function(t){return new ImageAsset(t)};function Nt(t={}){t.defs=Y(t.defs,{group:null,visibility:!0,order:0,start:null,handle:null,offset:null,dimensions:null,pivoted:null,mimicked:null,lockTo:null,scale:1,roll:0,noUserInteraction:!1,noPositionDependencies:!1,noCanvasEngineUpdates:!1,noFilters:!1,noPathUpdates:!1,purge:null}),t.packetExclusions=N(t.packetExclusions,["pathObject","mimicked","pivoted"]),t.packetExclusionsByRegex=N(t.packetExclusionsByRegex,["^(local|dirty|current)","Subscriber$"]),t.packetCoordinates=N(t.packetCoordinates,["start","handle","offset"]),t.packetObjects=N(t.packetObjects,["group"]),t.packetFunctions=N(t.packetFunctions,[]),t.processPacketOut=function(t,e,i){let s=!0;switch(t){case"lockTo":"start"===e[0]&&"start"===e[1]&&(s=i.indexOf("lockTo")>=0);break;default:"entity"===this.lib?s=this.processEntityPacketOut(t,e,i):this.isArtefact&&(s=this.processDOMPacketOut(t,e,i))}return s},t.handlePacketAnchor=function(t,e){if(this.anchor){let i=JSON.parse(this.anchor.saveAsPacket(e))[3];t.anchor=i}return t},t.kill=function(){let t=this.name;return Object.entries(u).forEach(([e,i])=>{i.artefacts.indexOf(t)>=0&&i.removeArtefacts(t)}),this.anchor&&this.demolishAnchor(),Object.entries(i).forEach(([e,i])=>{i.name!==t&&(i.pivot&&i.pivot.name===t&&i.set({pivot:!1}),i.mimic&&i.mimic.name===t&&i.set({mimic:!1}),i.path&&i.path.name===t&&i.set({path:!1}),Array.isArray(i.pins)&&i.pins.forEach((e,s)=>{I(e)&&e.name===t&&i.removePinAt(s)}))}),Object.entries(d).forEach(([e,i])=>{i.checkForTarget(t)&&i.removeFromTargets(this)}),this.factoryKill(),this.deregister(),this},t.factoryKill=T;let e=t.getters,s=t.setters,n=t.deltaSetters;return e.startX=function(){return this.currentStart[0]},e.startY=function(){return this.currentStart[1]},e.start=function(){return[].concat(this.currentStart)},s.startX=function(t){null!=t&&(this.start[0]=t,this.dirtyStart=!0)},s.startY=function(t){null!=t&&(this.start[1]=t,this.dirtyStart=!0)},s.start=function(t,e){this.setCoordinateHelper("start",t,e),this.dirtyStart=!0},n.startX=function(t){let e=this.start;e[0]=A(e[0],t),this.dirtyStart=!0},n.startY=function(t){let e=this.start;e[1]=A(e[1],t),this.dirtyStart=!0},n.start=function(t,e){this.setDeltaCoordinateHelper("start",t,e),this.dirtyStart=!0},e.handleX=function(){return this.currentHandle[0]},e.handleY=function(){return this.currentHandle[1]},e.handle=function(){return[].concat(this.currentHandle)},s.handleX=function(t){null!=t&&(this.handle[0]=t,this.dirtyHandle=!0)},s.handleY=function(t){null!=t&&(this.handle[1]=t,this.dirtyHandle=!0)},s.handle=function(t,e){this.setCoordinateHelper("handle",t,e),this.dirtyHandle=!0},n.handleX=function(t){let e=this.handle;e[0]=A(e[0],t),this.dirtyHandle=!0},n.handleY=function(t){let e=this.handle;e[1]=A(e[1],t),this.dirtyHandle=!0},n.handle=function(t,e){this.setDeltaCoordinateHelper("handle",t,e),this.dirtyHandle=!0},e.offsetX=function(){return this.currentOffset[0]},e.offsetY=function(){return this.currentOffset[1]},e.offset=function(){return[].concat(this.currentOffset)},s.offsetX=function(t){null!=t&&(this.offset[0]=t,this.dirtyOffset=!0)},s.offsetY=function(t){null!=t&&(this.offset[1]=t,this.dirtyOffset=!0)},s.offset=function(t,e){this.setCoordinateHelper("offset",t,e),this.dirtyOffset=!0},n.offsetX=function(t){let e=this.offset;e[0]=A(e[0],t),this.dirtyOffset=!0},n.offsetY=function(t){let e=this.offset;e[1]=A(e[1],t),this.dirtyOffset=!0},n.offset=function(t,e){this.setDeltaCoordinateHelper("offset",t,e),this.dirtyOffset=!0},e.width=function(){return this.currentDimensions[0]},e.height=function(){return this.currentDimensions[1]},e.dimensions=function(){return[].concat(this.currentDimensions)},s.width=function(t){null!=t&&(this.dimensions[0]=t,this.dirtyDimensions=!0)},s.height=function(t){null!=t&&(this.dimensions[1]=t,this.dirtyDimensions=!0)},s.dimensions=function(t,e){this.setCoordinateHelper("dimensions",t,e),this.dirtyDimensions=!0},n.width=function(t){let e=this.dimensions;e[0]=A(e[0],t),this.dirtyDimensions=!0},n.height=function(t){let e=this.dimensions;e[1]=A(e[1],t),this.dirtyDimensions=!0},n.dimensions=function(t,e){this.setDeltaCoordinateHelper("dimensions",t,e),this.dirtyDimensions=!0},s.lockTo=function(t){Array.isArray(t)?(this.lockTo[0]=t[0],this.lockTo[1]=t[1]):(this.lockTo[0]=t,this.lockTo[1]=t),this.dirtyLock=!0},s.lockXTo=function(t){this.lockTo[0]=t,this.dirtyLock=!0},s.lockYTo=function(t){this.lockTo[1]=t,this.dirtyLock=!0},s.roll=function(t){this.roll=t,this.dirtyRotation=!0},n.roll=function(t){this.roll+=t,this.dirtyRotation=!0},s.scale=function(t){this.scale=t,this.dirtyScale=!0},n.scale=function(t){this.scale+=t,this.dirtyScale=!0},s.host=function(t){if(t){let e=i[t];e&&e.here?this.host=e.name:this.host=t}else this.host="";this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyStart=!0,this.dirtyOffset=!0},s.group=function(t){let e;t&&(this.group&&"Group"===this.group.type&&this.group.removeArtefacts(this.name),t.substring?(e=u[t],this.group=e||t):this.group=t),this.group&&"Group"===this.group.type&&this.group.addArtefacts(this.name)},t.purgeArtefact=function(t){return t.substring&&(t="all"===t?["pivot","mimic","path","filter"]:[t]),Array.isArray(t)&&t.forEach(t=>function(t,e){switch(e){case"pivot":delete t.pivot,delete t.pivotCorner,delete t.pivotPin,delete t.addPivotHandle,delete t.addPivotOffset,delete t.addPivotRotation;break;case"mimic":delete t.mimic,delete t.useMimicDimensions,delete t.useMimicScale,delete t.useMimicStart,delete t.useMimicHandle,delete t.useMimicOffset,delete t.useMimicRotation,delete t.useMimicFlip,delete t.addOwnDimensionsToMimic,delete t.addOwnScaleToMimic,delete t.addOwnStartToMimic,delete t.addOwnHandleToMimic,delete t.addOwnOffsetToMimic,delete t.addOwnRotationToMimic;break;case"path":delete t.path,delete t.pathPosition,delete t.addPathHandle,delete t.addPathOffset,delete t.addPathRotation,delete t.constantPathSpeed;break;case"filter":delete t.filter,delete t.filterAlpha,delete t.filterComposite,delete t.isStencil}}(this,t)),this},t.initializePositions=function(){this.dimensions=Bt(),this.start=Bt(),this.handle=Bt(),this.offset=Bt(),this.currentDimensions=Bt(),this.currentStart=Bt(),this.currentHandle=Bt(),this.currentOffset=Bt(),this.currentDragOffset=Bt(),this.currentDragCache=Bt(),this.currentStartCache=Bt(),this.currentStampPosition=Bt(),this.currentStampHandlePosition=Bt(),this.delta={},this.lockTo=["start","start"],this.pivoted=[],this.mimicked=[],this.dirtyScale=!0,this.dirtyDimensions=!0,this.dirtyLock=!0,this.dirtyStart=!0,this.dirtyOffset=!0,this.dirtyHandle=!0,this.dirtyRotation=!0,this.isBeingDragged=!1,this.initializeDomPositions()},t.initializeDomPositions=T,t.setCoordinateHelper=function(t,e,i){let s=this[t];Array.isArray(e)?(s[0]=e[0],s[1]=e[1]):I(e)?U(e.x,e.y)?(s[0]=G(e.x,s[0]),s[1]=G(e.y,s[1])):(s[0]=G(e.width,e.w,s[0]),s[1]=G(e.height,e.h,s[1])):(s[0]=e,s[1]=i)},t.setDeltaCoordinateHelper=function(t,e,i){let s=this[t],n=s[0],r=s[1];Array.isArray(e)?(s[0]=A(n,e[0]),s[1]=A(r,e[1])):I(e)?U(e.x,e.y)?(s[0]=A(n,G(e.x,0)),s[1]=A(r,G(e.y,0))):(s[0]=A(n,G(e.width,e.w,0)),s[1]=A(r,G(e.height,e.h,0))):(s[0]=A(n,e),s[1]=A(r,i))},t.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=i[this.host];if(t)return this.currentHost=t,this.dirtyHost=!0,this.currentHost}return lt},t.getHere=function(){let t=this.getHost();if(t){if(t.here)return t.here;if(t.currentDimensions){let e=t.currentDimensions;if(e)return{w:e[0],h:e[1]}}}return lt},t.cleanPosition=function(t,e,i){let s,n;for(let r=0;r<2;r++)s=e[r],n=i[r],s.toFixed?t[r]=s:t[r]="left"===s||"top"===s?0:"right"===s||"bottom"===s?n:"center"===s?n/2:parseFloat(s)/100*n},t.cleanScale=function(){this.dirtyScale=!1;let t,e=this.scale,i=this.mimic,s=this.currentScale;i&&this.useMimicScale?i.currentScale?(t=i.currentScale,this.addOwnScaleToMimic&&(t+=e)):(t=e,this.dirtyMimicScale=!0):t=e,this.currentScale=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,s!==this.currentScale&&(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicScale=!0)},t.cleanDimensions=function(){this.dirtyDimensions=!1;let t=this.getHost(),e=this.dimensions,i=this.currentDimensions;if(t){let s=t.currentDimensions?t.currentDimensions:[t.w,t.h],[n,r]=e,o=i[0],a=i[1];n.substring&&(n=parseFloat(n)/100*s[0]),r.substring&&(r="auto"===r?0:parseFloat(r)/100*s[1]);let h,c=this.mimic;c&&c.name&&this.useMimicDimensions&&(h=c.currentDimensions),h?(i[0]=this.addOwnDimensionsToMimic?h[0]+n:h[0],i[1]=this.addOwnDimensionsToMimic?h[1]+r:h[1]):(i[0]=n,i[1]=r),this.cleanDimensionsAdditionalActions(),this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyOffset=!0,o===i[0]&&a===i[1]||(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicDimensions=!0)}else this.dirtyDimensions=!0},t.cleanDimensionsAdditionalActions=T,t.cleanLock=function(){this.dirtyLock=!1,this.dirtyStart=!0,this.dirtyHandle=!0},t.cleanStart=function(){this.dirtyStart=!1;let t=this.getHere();q(t)&&V(t.w,t.h)?(this.cleanPosition(this.currentStart,this.start,[t.w,t.h]),this.dirtyStampPositions=!0):this.dirtyStart=!0},t.cleanOffset=function(){this.dirtyOffset=!1;let t=this.getHere();q(t)&&V(t.w,t.h)?(this.cleanPosition(this.currentOffset,this.offset,[t.w,t.h]),this.dirtyStampPositions=!0,this.mimicked&&this.mimicked.length&&(this.dirtyMimicOffset=!0)):this.dirtyOffset=!0},t.cleanHandle=function(){this.dirtyHandle=!1;let t=this.currentHandle;this.cleanPosition(t,this.handle,this.currentDimensions),this.dirtyStampHandlePositions=!0,this.mimicked&&this.mimicked.length&&(this.dirtyMimicHandle=!0)},t.cleanRotation=function(){this.dirtyRotation=!1;let t,e=this.roll,i=this.currentRotation,s=this.path,n=this.mimic,r=this.pivot,o=this.lockTo;if(s&&o.indexOf("path")>=0){if(t=e,this.addPathRotation){let e=this.getPathData();e&&(t+=e.angle)}}else n&&this.useMimicRotation&&o.indexOf("mimic")>=0?q(n.currentRotation)?(t=n.currentRotation,this.addOwnRotationToMimic&&(t+=e)):this.dirtyMimicRotation=!0:(t=e,r&&this.addPivotRotation&&o.indexOf("pivot")>=0&&(q(r.currentRotation)?t+=r.currentRotation:this.dirtyPivotRotation=!0));this.currentRotation=t,t!==i&&(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicRotation=!0)},t.cleanStampPositions=function(){this.dirtyStampPositions=!1;let t=this.currentStampPosition,e=this.currentStart,i=t[0],s=t[1];if(this.noPositionDependencies)t[0]=e[0],t[1]=e[1];else{let i,s,n,r,o,a=this.lockTo,h=[],c=!1,l=this.currentOffset,u=this.isBeingDragged,d=this.currentDragOffset,f=this.currentStartCache,p=this.pivot,m=this.path,g=this.mimic;if(u)h=["mouse","mouse"],c=!0,this.getCornerCoordinate&&this.cleanPathObject();else for(s=0;s<2;s++)i=a[s],("pivot"!==i||p)&&("path"!==i||m)&&("mimic"!==i||g)||(i="start"),"mouse"===i&&(c=!0),h[s]=i;for(c&&(r=this.getHere()),s=0;s<2;s++){switch(i=h[s],i){case"pivot":n=this.pivotCorner&&p.getCornerCoordinate?p.getCornerCoordinate(this.pivotCorner,s?"y":"x"):"Polyline"===p.type?p.getPinAt(this.pivotPin,s?"y":"x"):p.currentStampPosition[s],this.addPivotOffset||(n-=p.currentOffset[s]),n+=l[s];break;case"path":o=this.getPathData(),o?(n=s?o.y:o.x,this.addPathOffset||(n-=m.currentOffset[s])):n=e[s]+l[s];break;case"mimic":this.useMimicStart||this.useMimicOffset?(n=g.currentStampPosition[s],this.useMimicStart&&this.addOwnStartToMimic&&(n+=e[s]),this.useMimicOffset&&this.addOwnOffsetToMimic&&(n+=l[s]),this.useMimicStart||(n=n-g.currentStart[s]+e[s]),this.useMimicOffset||(n=n-g.currentOffset[s]+l[s])):n=e[s]+l[s];break;case"mouse":n=0===s?r.x:r.y,u&&(f[s]=n,n+=d[s]),n+=l[s];break;default:n=e[s]+l[s]}t[s]=n}}i===t[0]&&s===t[1]||(this.dirtyPositionSubscribers=!0)},t.cleanStampHandlePositions=function(){this.dirtyStampHandlePositions=!1;let t=this.currentStampHandlePosition,e=this.currentHandle,i=t[0],s=t[1];if(this.noPositionDependencies)t[0]=e[0],t[1]=e[1];else{let i,s,n,r=this.lockTo,o=this.pivot,a=this.path,h=this.mimic;for(s=0;s<2;s++){switch(i=r[s],"pivot"!==i||o||(i="start"),"path"!==i||a||(i="start"),"mimic"!==i||h||(i="start"),n=e[s],i){case"pivot":this.addPivotHandle&&(n+=o.currentHandle[s]);break;case"path":this.addPathHandle&&(n+=a.currentHandle[s]);break;case"mimic":this.useMimicHandle&&(n=h.currentHandle[s],this.addOwnHandleToMimic&&(n+=e[s]))}t[s]=n}}this.cleanStampHandlePositionsAdditionalActions(),i===t[0]&&s===t[1]||(this.dirtyPositionSubscribers=!0)},t.cleanStampHandlePositionsAdditionalActions=T,t.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let i=Array.isArray(t)?t:[t],s=!1;e||(e=ne(),s=!0);let n,r,o=e.engine,a=this.currentStampPosition,h=a[0],c=a[1];if(i.some(t=>{if(Array.isArray(t))n=t[0],r=t[1];else{if(!V(t,t.x,t.y))return!1;n=t.x,r=t.y}return!(!n.toFixed||!r.toFixed||isNaN(n)||isNaN(r))&&(e.rotateDestination(o,h,c,this),o.isPointInPath(this.pathObject,n,r,this.winding))},this)){let t=this.checkHitReturn(n,r,e);return s&&re(e),t}return s&&re(e),!1},t.checkHitReturn=function(t,e,i){return{x:t,y:e,artefact:this}},t.pickupArtefact=function(t={}){let{x:e,y:i}=t;return V(e,i)&&(this.isBeingDragged=!0,this.currentDragCache.set(this.currentDragOffset),"start"===this.lockTo[0]?this.currentDragOffset[0]=this.currentStart[0]-e:"pivot"===this.lockTo[0]&&this.pivot?this.currentDragOffset[0]=this.pivot.get("startX")-e:"mimic"===this.lockTo[0]&&this.mimic&&(this.currentDragOffset[0]=this.mimic.get("startX")-e),"start"===this.lockTo[1]?this.currentDragOffset[1]=this.currentStart[1]-i:"pivot"===this.lockTo[1]&&this.pivot?this.currentDragOffset[1]=this.pivot.get("startY")-i:"mimic"===this.lockTo[1]&&this.mimic&&(this.currentDragOffset[1]=this.mimic.get("startY")-i),this.order+=9999,this.group.batchResort=!0,q(this.dirtyPathObject)&&(this.dirtyPathObject=!0)),this},t.dropArtefact=function(){return this.start.set(this.currentStartCache).add(this.currentDragOffset),this.dirtyStart=!0,this.currentDragOffset.set(this.currentDragCache),this.order=this.order>=9999?this.order-9999:0,this.group.batchResort=!0,q(this.dirtyPathObject)&&(this.dirtyPathObject=!0),this.isBeingDragged=!1,this},t.updatePositionSubscribers=function(){this.dirtyPositionSubscribers=!1,this.pivoted&&this.pivoted.length&&this.updatePivotSubscribers(),this.mimicked&&this.mimicked.length&&this.updateMimicSubscribers(),this.pathed&&this.pathed.length&&this.updatePathSubscribers()},t.updatePivotSubscribers=T,t.updateMimicSubscribers=T,t.updatePathSubscribers=T,t.updateImageSubscribers=T,t}function Wt(t={}){let e={delta:null,noDeltaUpdates:!1};t.defs=Y(t.defs,e),Y(t,e);let i=t.setters;t.deltaSetters;return i.delta=function(t={}){t&&(this.delta=$(this.delta,t))},t.updateByDelta=function(){return"kaliedoscope-clock-background"==this.name&&console.log(this.name,"updateByDelta"),this.setDelta(this.delta),this},t.reverseByDelta=function(){let t={};return Object.entries(this.delta).forEach(([e,i])=>{i=i.substring?-parseFloat(i)+"%":-i,t[e]=i}),this.setDelta(t),this},t.setDeltaValues=function(t={}){let e,i,s=this.delta;return Object.entries(t).forEach(([t,n])=>{if(q(s[t]))switch(i=n,e=s[t],i){case"reverse":e.toFixed&&(s[t]=-e);break;case"zero":e.toFixed&&(s[t]=0)}}),this},t}function qt(t={}){let e={pivot:"",pivotCorner:"",pivotPin:0,addPivotHandle:!1,addPivotOffset:!0,addPivotRotation:!1};t.defs=Y(t.defs,e),Y(t,e),t.packetObjects=N(t.packetObjects,["pivot"]);t.getters;let s=t.setters;t.deltaSetters;return s.pivot=function(t){if(B(t)&&!t)this.pivot=null,"pivot"===this.lockTo[0]&&(this.lockTo[0]="start"),"pivot"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.pivot,s=t.substring?i[t]:t,n=this.name;s&&s.name&&(e&&e.name!==s.name&&W(e.pivoted,n),N(s.pivoted,n),this.pivot=s,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}},t.pivotCorners=["topLeft","topRight","bottomRight","bottomLeft"],s.pivotCorner=function(t){this.pivotCorners.indexOf(t)>=0&&(this.pivotCorner=t)},s.addPivotHandle=function(t){this.addPivotHandle=t,this.dirtyHandle=!0},s.addPivotOffset=function(t){this.addPivotOffset=t,this.dirtyOffset=!0},s.addPivotRotation=function(t){this.addPivotRotation=t,this.dirtyRotation=!0},t.updatePivotSubscribers=function(){this.pivoted.forEach(t=>{let e=i[t];e&&(e.dirtyStart=!0,e.addPivotHandle&&(e.dirtyHandle=!0),e.addPivotOffset&&(e.dirtyOffset=!0),e.addPivotRotation&&(e.dirtyRotation=!0),"Polyline"===e.type?e.dirtyPins=!0:"Line"!==e.type&&"Quadratic"!==e.type&&"Bezier"!==e.type||e.dirtyPins.push(this.name))},this)},t}function Vt(t={}){let e={mimic:"",useMimicDimensions:!1,useMimicScale:!1,useMimicStart:!1,useMimicHandle:!1,useMimicOffset:!1,useMimicRotation:!1,useMimicFlip:!1,addOwnDimensionsToMimic:!1,addOwnScaleToMimic:!1,addOwnStartToMimic:!1,addOwnHandleToMimic:!1,addOwnOffsetToMimic:!1,addOwnRotationToMimic:!1};t.defs=Y(t.defs,e),Y(t,e),t.packetObjects=N(t.packetObjects,["mimic"]);t.getters;let s=t.setters;t.deltaSetters;return s.mimic=function(t){if(B(t)&&!t)this.mimic=null,"mimic"===this.lockTo[0]&&(this.lockTo[0]="start"),"mimic"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.mimic,s=t.substring?i[t]:t,n=this.name;s&&s.name&&(e&&e.name!==s.name&&removeItem(e.mimicked,n),N(s.mimicked,n),this.mimic=s,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}},s.useMimicDimensions=function(t){this.useMimicDimensions=t,this.dirtyDimensions=!0},s.useMimicScale=function(t){this.useMimicScale=t,this.dirtyScale=!0},s.useMimicStart=function(t){this.useMimicStart=t,this.dirtyStart=!0},s.useMimicHandle=function(t){this.useMimicHandle=t,this.dirtyHandle=!0},s.useMimicOffset=function(t){this.useMimicOffset=t,this.dirtyOffset=!0},s.useMimicRotation=function(t){this.useMimicRotation=t,this.dirtyRotation=!0},s.addOwnDimensionsToMimic=function(t){this.addOwnDimensionsToMimic=t,this.dirtyDimensions=!0},s.addOwnScaleToMimic=function(t){this.addOwnScaleToMimic=t,this.dirtyScale=!0},s.addOwnStartToMimic=function(t){this.addOwnStartToMimic=t,this.dirtyStart=!0},s.addOwnHandleToMimic=function(t){this.addOwnHandleToMimic=t,this.dirtyHandle=!0},s.addOwnOffsetToMimic=function(t){this.addOwnOffsetToMimic=t,this.dirtyOffset=!0},s.addOwnRotationToMimic=function(t){this.addOwnRotationToMimic=t,this.dirtyRotation=!0},t.updateMimicSubscribers=function(){let t=this.dirtyMimicHandle,e=this.dirtyMimicOffset,s=this.dirtyMimicRotation,n=this.dirtyMimicScale,r=this.dirtyMimicDimensions;this.mimicked.forEach(o=>{let a=i[o];a&&(a.useMimicStart&&(a.dirtyStart=!0),t&&a.useMimicHandle&&(a.dirtyHandle=!0),e&&a.useMimicOffset&&(a.dirtyOffset=!0),s&&a.useMimicRotation&&(a.dirtyRotation=!0),n&&a.useMimicScale&&(a.dirtyScale=!0),r&&a.useMimicDimensions&&(a.dirtyDimensions=!0))}),this.dirtyMimicHandle=!1,this.dirtyMimicOffset=!1,this.dirtyMimicRotation=!1,this.dirtyMimicScale=!1,this.dirtyMimicDimensions=!1},t}function Gt(t={}){let e={path:"",pathPosition:0,addPathHandle:!1,addPathOffset:!0,addPathRotation:!1,constantPathSpeed:!1};t.defs=Y(t.defs,e),Y(t,e),t.packetObjects=N(t.packetObjects,["path"]);let s=t.setters,n=t.deltaSetters;return s.path=function(t){if(B(t)&&!t)this.path=null,"path"===this.lockTo[0]&&(this.lockTo[0]="start"),"path"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.path,s=t.substring?i[t]:t,n=this.name;s&&s.name&&s.useAsPath&&(e&&e.name!==s.name&&W(e.pathed,n),N(s.pathed,n),this.path=s,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}},s.pathPosition=function(t){t<0&&(t=Math.abs(t)),t>1&&(t%=1),this.pathPosition=parseFloat(t.toFixed(6)),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0,this.currentPathData=!1},n.pathPosition=function(t){let e=this.pathPosition+t;e<0&&(e+=1),e>1&&(e%=1),this.pathPosition=parseFloat(e.toFixed(6)),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0,this.currentPathData=!1},s.addPathHandle=function(t){this.addPathHandle=t,this.dirtyHandle=!0},s.addPathOffset=function(t){this.addPathOffset=t,this.dirtyOffset=!0},s.addPathRotation=function(t){this.addPathRotation=t,this.dirtyRotation=!0},t.getPathData=function(){if(this.currentPathData)return this.currentPathData;let t,e=this.pathPosition,i=this.path;return!!i&&(t=i.getPathPositionData(e,this.constantPathSpeed),this.addPathRotation&&(this.dirtyRotation=!0),this.currentPathData=t,t)},t}g.ImageAsset=ImageAsset;const Anchor=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.build(),this};let Ut=Anchor.prototype=Object.create(Object.prototype);Ut.type="Anchor",Ut.lib="anchor",Ut.isArtefact=!1,Ut.isAsset=!1,Ut=nt(Ut);Ut.defs=Y(Ut.defs,{host:null,description:"",download:"",href:"",hreflang:"",ping:"",referrerpolicy:"",rel:"noreferrer",target:"_blank",anchorType:"",clickAction:null,focusAction:!1,blurAction:!1}),Ut.packetExclusions=N(Ut.packetExclusions,["domElement"]),Ut.packetObjects=N(Ut.packetExclusions,["host"]),Ut.packetFunctions=N(Ut.packetFunctions,["clickAction"]),Ut.demolish=function(){this.domElement&&this.hold&&this.hold.removeChild(this.domElement),this.deregister()};let _t=Ut.setters;_t.host=function(t){let e=t.substring?i[t]:t;e&&e.name&&(this.host=e)},_t.hold=function(t){L(t)&&(this.domElement&&this.hold&&this.hold.removeChild(this.domElement),this.hold=t,this.domElement&&this.hold.appendChild(this.domElement))},_t.download=function(t){this.download=t,this.domElement&&this.update("download")},_t.href=function(t){this.href=t,this.domElement&&this.update("href")},_t.hreflang=function(t){this.hreflang=t,this.domElement&&this.update("hreflang")},_t.ping=function(t){this.ping=t,this.domElement&&this.update("ping")},_t.referrerpolicy=function(t){this.referrerpolicy=t,this.domElement&&this.update("referrerpolicy")},_t.rel=function(t){this.rel=t,this.domElement&&this.update("rel")},_t.target=function(t){this.target=t,this.domElement&&this.update("target")},_t.anchorType=function(t){this.anchorType=t,this.domElement&&this.update("type")},_t.description=function(t){this.description=t,this.domElement&&(this.domElement.textContent=t)},_t.clickAction=function(t){M(t)&&(this.clickAction=t,this.domElement&&this.domElement.setAttribute("onclick",t()))},Ut.build=function(){this.domElement&&this.hold&&this.hold.removeChild(this.domElement);let t=document.createElement("a");t.id=this.name,this.download&&t.setAttribute("download",this.download),this.href&&t.setAttribute("href",this.href),this.hreflang&&t.setAttribute("hreflang",this.hreflang),this.ping&&t.setAttribute("ping",this.ping),this.referrerpolicy&&t.setAttribute("referrerpolicy",this.referrerpolicy),this.rel&&t.setAttribute("rel",this.rel),this.target&&t.setAttribute("target",this.target),this.anchorType&&t.setAttribute("type",this.anchorType),this.clickAction&&M(this.clickAction)&&t.setAttribute("onclick",this.clickAction()),this.description&&(t.textContent=this.description),this.focusAction&&t.addEventListener("focus",t=>this.host.onEnter(),!1),this.blurAction&&t.addEventListener("blur",t=>this.host.onLeave(),!1),this.domElement=t,this.hold&&this.hold.appendChild(t)},Ut.update=function(t){this.domElement&&this.domElement.setAttribute(t,this[t])},Ut.click=function(){let t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});return this.domElement.dispatchEvent(t)};function Qt(t={}){t.defs=Y(t.defs,{anchor:null}),t.demolishAnchor=function(){this.anchor&&this.anchor.demolish()};let e=t.getters,i=t.setters;t.deltaSetters;return e.anchorDescription=function(){return this.anchor?this.anchor.get("description"):""},i.anchorDescription=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.description(t)},e.anchorType=function(){return this.anchor?this.anchor.get("type"):""},i.anchorType=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.anchorType(t)},e.anchorTarget=function(){return this.anchor?this.anchor.get("target"):""},i.anchorTarget=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.target(t)},e.anchorRel=function(){return this.anchor?this.anchor.get("rel"):""},i.anchorRel=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.rel(t)},e.anchorReferrerPolicy=function(){return this.anchor?this.anchor.get("referrerpolicy"):""},i.anchorReferrerPolicy=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.referrerpolicy(t)},e.anchorPing=function(){return this.anchor?this.anchor.get("ping"):""},i.anchorPing=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.ping(t)},e.anchorHreflang=function(){return this.anchor?this.anchor.get("hreflang"):""},i.anchorHreflang=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.hreflang(t)},e.anchorHref=function(){return this.anchor?this.anchor.get("href"):""},i.anchorHref=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.href(t)},e.anchorDownload=function(){return this.anchor?this.anchor.get("download"):""},i.anchorDownload=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.download(t)},i.anchorFocusAction=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.focusAction(t)},i.anchorBlurAction=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.blurAction(t)},i.anchor=function(t={}){this.anchor?this.anchor.set(t):this.buildAnchor(t)},t.buildAnchor=function(t={}){this.anchor&&this.anchor.demolish(),t.name||(t.name=this.name+"-anchor"),t.description||(t.description=`Anchor link for ${this.name} ${this.type}`),t.host=this,t.hold=this.getAnchorHold(),this.anchor=function(t){return new Anchor(t)}(t)},t.getAnchorHold=function(){let t=this.currentHost;if(t){if("Canvas"===t.type)return t.navigation;if("Cell"===t.type){let e=t.currentHost?t.currentHost:o[t.host];if(e&&"Canvas"===e.type)return e.navigation}}return this.dirtyAnchorHold=!0,ei},t.rebuildAnchor=function(){this.anchor&&this.anchor.build()},t.clickAnchor=function(){this.anchor&&this.anchor.click()},t}function Kt(t={}){t.defs=Y(t.defs,{groups:null,groupBuckets:null,batchResort:!0});let e=t.getters,i=t.setters;return e.groups=function(){return[].concat(this.groups)},i.groups=function(t){this.groups=[],this.addGroups(t)},t.sortGroups=function(t=!1){if(this.batchResort){this.batchResort=!1;let t=Math.floor,e=this.groups,i=[];e.forEach(e=>{let s=u[e],n=s?t(s.order):0;i[n]||(i[n]=[]),i[n].push(s)}),this.groupBuckets=i.reduce((t,e)=>t.concat(e),[])}},t.initializeCascade=function(){this.groups=[],this.groupBuckets=[]},t.addGroups=function(...t){return t.forEach(t=>{t&&t.substring?N(this.groups,t):u[t]&&N(this.groups,t.name)},this),this.batchResort=!0,this},t.removeGroups=function(...t){return t.forEach(t=>{t&&t.substring?W(this.groups,t):u[t]&&W(this.groups,t.name)},this),this.batchResort=!0,this},t.cascadeAction=function(t,e){return this.groups.forEach(i=>{let s=u[i];s&&s[e](t)},this),this},t.updateArtefacts=function(t){return this.cascadeAction(t,"updateArtefacts"),this},t.setArtefacts=function(t){return this.cascadeAction(t,"setArtefacts"),this},t.addArtefactClasses=function(t){return this.cascadeAction(t,"addArtefactClasses"),this},t.removeArtefactClasses=function(t){return this.cascadeAction(t,"removeArtefactClasses"),this},t.updateByDelta=function(){return this.cascadeAction(!1,"updateByDelta"),this},t.reverseByDelta=function(){return this.cascadeAction(!1,"reverseByDelta"),this},t.getArtefactAt=function(t){if(t=G(t,this.here,!1)){let e,i;for(let s=this.groups.length-1;s>=0;s--)if(e=u[this.groups[s]],e&&(i=e.getArtefactAt(t),i))return i}return!1},t.getAllArtefactsAt=function(t){if(t=G(t,this.here,!1)){let e,i,s=[];for(let n=this.groups.length-1;n>=0;n--)e=u[this.groups[n]],e&&(i=e.getAllArtefactsAt(t),i&&(s=s.concat(i)));return s}return[]},t}function Zt(t={}){return t.defs=Y(t.defs,{filters:null,isStencil:!1,filterAlpha:1,filterComposite:"source-over"}),t.setters.filters=function(t){Array.isArray(this.filters)||(this.filters=[]),t&&(Array.isArray(t)?(this.filters=t,this.dirtyFilters=!0,this.dirtyImageSubscribers=!0):t.substring&&(N(this.filters,t),this.dirtyFilters=!0,this.dirtyImageSubscribers=!0))},t.cleanFilters=function(){this.dirtyFilters=!1,this.filters||(this.filters=[]);let t=this.filters,e=Math.floor,i=[];t.forEach(t=>{let s=l[t],n=e(s.order)||0;i[n]||(i[n]=[]),i[n].push(s)}),this.currentFilters=i.reduce((t,e)=>t.concat(e),[])},t.addFilters=function(...t){return Array.isArray(this.filters)||(this.filters=[]),t.forEach(t=>{this.name,t&&(t.substring?N(this.filters,t):"Filter"===t.type&&N(this.filters,t.name))},this),this.dirtyFilters=!0,this.dirtyImageSubscribers=!0,this},t.removeFilters=function(...t){return Array.isArray(this.filters)||(this.filters=[]),t.forEach(t=>{t&&(t.substring?W(this.filters,t):"Filter"===t.type&&W(this.filters,t.name))},this),this.dirtyFilters=!0,this.dirtyImageSubscribers=!0,this},t.clearFilters=function(){return Array.isArray(this.filters)||(this.filters=[]),this.filters.length=0,this.dirtyFilters=!0,this.dirtyImageSubscribers=!0,this},t}g.Anchor=Anchor;const Cell=function(t={}){if(this.makeName(t.name),t.isPool||this.register(),this.initializePositions(),this.initializeCascade(),!j(t.element)){let e=document.createElement("canvas");e.id=this.name,e.width=300,e.height=150,t.element=e}return this.installElement(t.element),t.isPool?this.set(this.poolDefs):this.set(this.defs),this.set(t),this.state.setStateFromEngine(this.engine),t.isPool||le({name:this.name,host:this.name}),this.subscribers=[],this.sourceNaturalDimensions=Bt(),this.sourceLoaded=!0,this};let Jt=Cell.prototype=Object.create(Object.prototype);Jt.type="Cell",Jt.lib="cell",Jt.isArtefact=!1,Jt.isAsset=!0,Jt=nt(Jt),Jt=Nt(Jt),Jt=Wt(Jt),Jt=qt(Jt),Jt=Vt(Jt),Jt=Gt(Jt),Jt=Qt(Jt),Jt=Kt(Jt),Jt=jt(Jt),Jt=Zt(Jt);Jt.defs=Y(Jt.defs,{cleared:!0,compiled:!0,shown:!0,compileOrder:0,showOrder:0,backgroundColor:"",alpha:1,composite:"source-over",scale:1,localizeHere:!1,repeat:"repeat",isBase:!1,controller:null}),delete Jt.defs.source,delete Jt.defs.sourceLoaded,Jt.stringifyFunction=T,Jt.processPacketOut=T,Jt.finalizePacketOut=T,Jt.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},Jt.clone=H,Jt.kill=function(){let t=this.name;return Object.entries(o).forEach(([e,i])=>{i.cells.indexOf(t)>=0&&i.removeCell(t),i.base&&i.base.name===t&&i.set({visibility:!1})}),this.anchor&&this.demolishAnchor(),Object.entries(i).forEach(([e,i])=>{if(i.name!==t){i.pivot&&i.pivot.name===t&&i.set({pivot:!1}),i.mimic&&i.mimic.name===t&&i.set({mimic:!1}),i.path&&i.path.name===t&&i.set({path:!1});let e=i.state;if(e){let i=e.fillStyle,s=e.strokeStyle;i.name&&i.name===t&&(e.fillStyle=e.defs.fillStyle),s.name&&s.name===t&&(e.strokeStyle=e.defs.strokeStyle)}}}),Object.entries(d).forEach(([e,i])=>{i.checkForTarget(t)&&i.removeFromTargets(this)}),u[this.name]&&u[this.name].kill(),this.deregister(),this};let te=Jt.getters,ee=Jt.setters,ie=Jt.deltaSetters;Jt.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},te.width=function(){return this.currentDimensions[0]||this.element.getAttribute("width")},ee.width=function(t){this.dimensions[0]=t,this.dirtyDimensions=!0},te.height=function(){return this.currentDimensions[1]||this.element.getAttribute("height")},ee.height=function(t){this.dimensions[1]=t,this.dirtyDimensions=!0},ee.source=function(){},ee.engine=function(t){},ee.state=function(t){},ee.element=function(t){j(t)&&this.installElement(t)},ee.cleared=function(t){this.cleared=t,this.updateControllerCells()},ee.compiled=function(t){this.compiled=t,this.updateControllerCells()},ee.shown=function(t){this.shown=t,this.updateControllerCells()},ee.compileOrder=function(t){this.compileOrder=t,this.updateControllerCells()},ee.showOrder=function(t){this.showOrder=t,this.updateControllerCells()},ee.stashX=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]),this.stashCoordinates[0]=t},ee.stashY=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]),this.stashCoordinates[1]=t},ee.stashWidth=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}this.stashDimensions[0]=t},ee.stashHeight=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}this.stashDimensions[1]=t},ie.stashX=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]);let e=this.stashCoordinates;e[0]=addStrings(e[0],t)},ie.stashY=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]);let e=this.stashCoordinates;e[1]=addStrings(e[1],t)},ie.stashWidth=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}let e=this.stashDimensions;e[0]=addStrings(e[0],t)},ie.stashHeight=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}let e=this.stashDimensions;e[1]=addStrings(e[1],t)},Jt.repeatValues=["repeat","repeat-x","repeat-y","no-repeat"],ee.repeat=function(t){this.repeatValues.indexOf(t)>=0?this.repeat=t:this.repeat=this.defs.repeat},Jt.checkSource=function(t,e){this.currentDimensions[0]===t&&this.currentDimensions[1]===e||this.notifySubscribers()},Jt.getData=function(t,e){return this.checkSource(this.sourceNaturalDimensions[0],this.sourceNaturalDimensions[1]),this.buildStyle(e)},Jt.buildStyle=function(t={}){if(t){let e=!1;if(t.substring){let i=a[t];i&&i.engine&&(e=i.engine)}else t.engine&&(e=t.engine);if(e)return e.createPattern(this.element,this.repeat)}return"rgba(0,0,0,0)"},Jt.updateArtefacts=function(t={}){this.groupBuckets.forEach(e=>{e.artefactBuckets.forEach(e=>{t.dirtyScale&&(e.dirtyScale=!0),t.dirtyDimensions&&(e.dirtyDimensions=!0),t.dirtyLock&&(e.dirtyLock=!0),t.dirtyStart&&(e.dirtyStart=!0),t.dirtyOffset&&(e.dirtyOffset=!0),t.dirtyHandle&&(e.dirtyHandle=!0),t.dirtyRotation&&(e.dirtyRotation=!0),t.dirtyPathObject&&(e.dirtyPathObject=!0)})})},Jt.cleanDimensionsAdditionalActions=function(){let t=this.element;if(t){let e=this.controller,i=this.currentDimensions,s=this.isBase;if(s&&e&&e.isComponent){let t=this.controller.currentDimensions,e=this.dimensions;e[0]=i[0]=t[0],e[1]=i[1]=t[1]}let[n,r]=i;t.width=n,t.height=r,this.setEngineFromState(this.engine),s&&e&&e.updateBaseHere(),this.groupBuckets&&this.updateArtefacts({dirtyDimensions:!0})}},Jt.notifySubscriber=function(t){t.sourceNaturalDimensions||(t.sourceNaturalDimensions=[]),t.sourceNaturalWidth=this.currentDimensions[0],t.sourceNaturalHeight=this.currentDimensions[1],t.sourceLoaded=!0,t.dirtyImage=!0,t.dirtyCopyStart=!0,t.dirtyCopyDimensions=!0},Jt.subscribeAction=function(t={}){this.subscribers.push(t),t.asset=this,t.source=this.element,this.notifySubscriber(t)},Jt.installElement=function(t){return this.element=t,this.engine=this.element.getContext("2d"),this.state=Ht({engine:this.engine}),this},Jt.updateControllerCells=function(){this.controller&&(this.controller.dirtyCells=!0)},Jt.setEngineFromState=function(t){let e=this.state;return e.allKeys.forEach(i=>{"lineDash"===i?(t.lineDash=e.lineDash,t.setLineDash(t.lineDash)):t[i]=e[i]},e),t.textAlign=e.textAlign,t.textBaseline=e.textBaseline,this},Jt.setToDefaults=function(){let t=this.state.defs,e=this.state,i=this.engine,s=Array.isArray;return Object.entries(t).forEach(([t,n])=>{"lineDash"===t?(s(i.lineDash)?i.lineDash.length=0:i.lineDash=[],s(e.lineDash)?e.lineDash.length=0:e.lineDash=[]):(i[t]=n,e[t]=n)}),i.textAlign=e.textAlign="left",i.textBaseline=e.textBaseline="top",this},Jt.stylesArray=["Gradient","RadialGradient","Pattern"],Jt.setEngine=function(t){let e,i,s=this.state,n=t.state.getChanges(t,s),r=this.setEngineActions,o=this.stylesArray;if(Object.keys(n).length)for(i in e=this.engine,n)r[i](n[i],e,o,t,this),s[i]=n[i];return t},Jt.setEngineActions={fillStyle:function(t,e,i,s,n){if(t.substring){let i=!1;p.indexOf(t)>=0?i=f[t]:h.indexOf(t)>=0&&(i=a[t]),i?(s.state.fillStyle=i,e.fillStyle=i.getData(s,n)):e.fillStyle=t}else e.fillStyle=t.getData(s,n)},font:function(t,e){e.font=t},globalAlpha:function(t,e){e.globalAlpha=t},globalCompositeOperation:function(t,e){e.globalCompositeOperation=t},lineCap:function(t,e){e.lineCap=t},lineDash:function(t,e){e.lineDash=t,e.setLineDash&&e.setLineDash(t)},lineDashOffset:function(t,e){e.lineDashOffset=t},lineJoin:function(t,e){e.lineJoin=t},lineWidth:function(t,e){e.lineWidth=t},miterLimit:function(t,e){e.miterLimit=t},shadowBlur:function(t,e){e.shadowBlur=t},shadowColor:function(t,e){e.shadowColor=t},shadowOffsetX:function(t,e){e.shadowOffsetX=t},shadowOffsetY:function(t,e){e.shadowOffsetY=t},strokeStyle:function(t,e,i,s,n){if(t.substring){let i=!1;p.indexOf(t)>=0?i=f[t]:h.indexOf(t)>=0&&(i=a[t]),i?(s.state.strokeStyle=i,e.strokeStyle=i.getData(s,n)):e.strokeStyle=t}else e.strokeStyle=t.getData(s,n)}},Jt.clearShadow=function(){return this.engine.shadowOffsetX=0,this.engine.shadowOffsetY=0,this.engine.shadowBlur=0,this.state.shadowOffsetX=0,this.state.shadowOffsetY=0,this.state.shadowBlur=0,this},Jt.restoreShadow=function(t){let e=t.state;return this.engine.shadowOffsetX=e.shadowOffsetX,this.engine.shadowOffsetY=e.shadowOffsetY,this.engine.shadowBlur=e.shadowBlur,this.state.shadowOffsetX=e.shadowOffsetX,this.state.shadowOffsetY=e.shadowOffsetY,this.state.shadowBlur=e.shadowBlur,this},Jt.setToClearShape=function(){return this.engine.fillStyle="rgba(0,0,0,0)",this.engine.strokeStyle="rgba(0,0,0,0)",this.engine.shadowColor="rgba(0,0,0,0)",this.state.fillStyle="rgba(0,0,0,0)",this.state.strokeStyle="rgba(0,0,0,0)",this.state.shadowColor="rgba(0,0,0,0)",this},Jt.saveEngine=function(){return this.engine.save(),this},Jt.restoreEngine=function(){return this.engine.restore(),this},Jt.clear=function(){let t=this;return new Promise(e=>{let i=t.engine,s=t.backgroundColor;t.prepareStamp();let n=t.currentDimensions[0],r=t.currentDimensions[1];if(i.setTransform(1,0,0,1,0,0),s){let t=i.fillStyle,e=i.globalCompositeOperation,o=i.globalAlpha;i.fillStyle=s,i.globalCompositeOperation="source-over",i.globalAlpha=1,i.fillRect(0,0,n,r),i.fillStyle=t,i.globalCompositeOperation=e,i.globalAlpha=o}else i.clearRect(0,0,n,r);e(!0)})},Jt.compile=function(){this.stashOutput;this.sortGroups(),this.prepareStamp(),!this.dirtyFilters&&this.currentFilters||this.cleanFilters();let t=this,e=i=>new Promise((s,n)=>{let r=t.groupBuckets[i];r&&r.stamp?r.stamp().then(t=>{e(i+1).then(t=>{s(!0)}).catch(t=>n(t))}).catch(t=>n(t)):!t.noFilters&&t.filters&&t.filters.length?t.applyFilters().then(e=>t.stashOutputAction()).then(t=>s(!0)).catch(t=>n(t)):t.stashOutputAction().then(t=>s(!0)).catch(t=>n(t))});return e(0)},Jt.show=function(){var t=this;return new Promise(e=>{let i=t.getHost(),s=!(!i||!i.engine)&&i.engine;if(s){let n,r=Math.floor,o=t.currentScale,a=t.currentDimensions,h=r(a[0]),c=r(a[1]),l=i.currentDimensions,u=r(l[0]),d=r(l[1]),f=t.composite,p=t.alpha,m=t.controller,g=t.element;if(s.save(),s.setTransform(1,0,0,1,0,0),t.isBase){let e,i;switch(t.basePaste||(t.basePaste=[]),n=t.basePaste,t.prepareStamp(),s.globalCompositeOperation="source-over",s.globalAlpha=1,s.clearRect(0,0,u,d),s.globalCompositeOperation=f,s.globalAlpha=p,m?m.fit:"none"){case"contain":e=u/(h||1),i=d/(c||1),e>i?(n[0]=r((u-h*i)/2),n[1]=0,n[2]=r(h*i),n[3]=r(c*i)):(n[0]=0,n[1]=r((d-c*e)/2),n[2]=r(h*e),n[3]=r(c*e));break;case"cover":e=u/(h||1),i=d/(c||1),e<i?(n[0]=r((u-h*i)/2),n[1]=0,n[2]=r(h*i),n[3]=r(c*i)):(n[0]=0,n[1]=r((d-c*e)/2),n[2]=r(h*e),n[3]=r(c*e));break;case"fill":n[0]=0,n[1]=0,n[2]=r(u),n[3]=r(d);break;case"none":default:n[0]=r((u-h)/2),n[1]=r((d-c)/2),n[2]=h,n[3]=c}}else if(o>0){t.paste||(t.paste=[]),n=t.paste,t.noDeltaUpdates||t.setDelta(t.delta),t.prepareStamp(),s.globalCompositeOperation=f,s.globalAlpha=p;let e=t.currentStampHandlePosition,i=t.currentStampPosition;n[0]=r(-e[0]*o),n[1]=r(-e[1]*o),n[2]=r(h*o),n[3]=r(c*o),t.rotateDestination(s,i[0],i[1])}s.drawImage(g,0,0,h,c,...n),s.restore(),e(!0)}else e(!1)})},Jt.applyFilters=function(){let t=this;return new Promise((function(e){let i,s,n=t.engine,r=n.globalCompositeOperation,o=n.globalAlpha;i=n.getImageData(0,0,t.currentDimensions[0],t.currentDimensions[1]),s=Ct(),At(s,{image:i,filters:t.currentFilters}).then(i=>{Ot(s),i?(n.globalCompositeOperation=t.filterComposite||"source-over",n.globalAlpha=t.filterAlpha||1,n.putImageData(i,0,0),n.globalCompositeOperation=r,n.globalAlpha=o,e(!0)):e(!1)}).catch(t=>{Ot(s),e(!1)})}))},Jt.stashOutputAction=function(){let t=this;return this.stashOutput?(this.stashOutput=!1,new Promise((e,i)=>{let[s,n]=t.currentDimensions,r=t.stashCoordinates,o=t.stashDimensions,a=r?r[0]:0,h=r?r[1]:0,c=o?o[0]:s,l=o?o[1]:n;if((c.substring||l.substring||a.substring||h.substring||a||h||c!==s||l!==n)&&(c.substring&&(c=parseFloat(c)/100*s),(isNaN(c)||c<=0)&&(c=1),c>s&&(c=s),l.substring&&(l=parseFloat(l)/100*n),(isNaN(l)||l<=0)&&(l=1),l>n&&(l=n),a.substring&&(a=parseFloat(a)/100*s),(isNaN(a)||a<0)&&(a=0),a+c>s&&(a=s-c),h.substring&&(h=parseFloat(h)/100*n),(isNaN(h)||h<0)&&(h=0),h+l>n&&(h=n-l)),t.engine.save(),t.engine.setTransform(1,0,0,1,0,0),t.stashedImageData=t.engine.getImageData(a,h,c,l),t.engine.restore(),t.stashOutputAsAsset){let e,i;if(t.stashOutputAsAsset=!1,i=ne(),e=i.element,e.width=c,e.height=l,i.engine.putImageData(t.stashedImageData,0,0),t.stashedImage)t.stashedImage.src=e.toDataURL();else{let i=t.stashedImage=document.createElement("img");i.id=t.name+"-image",i.onload=function(){ti.appendChild(i),Yt("#"+i.id)},i.src=e.toDataURL()}re(i)}e(!0)})):Promise.resolve(!1)},Jt.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=n[this.host]||i[this.host];return t&&(this.currentHost=t),t?this.currentHost:currentCorePosition}return currentCorePosition},Jt.updateBaseHere=function(t,e){if(this.isBase){this.here||(this.here={});let i=this.here,s=this.currentDimensions,n=t.active;if(s[0]!==t.w||s[1]!==t.h){this.basePaste||(this.basePaste=[]);let r,o,a=this.basePaste[0],h=s[0],c=s[1],l=t.w,u=t.h,d=t.x,f=t.y,p=h/l||1,m=c/u||1,g=Math.round;switch(i.w=h,i.h=c,e){case"contain":case"cover":a?(r=(l-h/m)/2,i.x=g((d-r)*m),i.y=g(f*m)):(o=(u-c/p)/2,i.x=g(d*p),i.y=g((f-o)*p));break;case"fill":i.x=g(d*p),i.y=g(f*m);break;case"none":default:r=(l-h)/2,o=(u-c)/2,i.x=g(d-r),i.y=g(f-o)}(i.x<0||i.x>h)&&(n=!1),(i.y<0||i.y>c)&&(n=!1),i.active=n}else i.x=t.x,i.y=t.y,i.w=t.w,i.h=t.h,i.active=n;t.baseActive=n}},Jt.prepareStamp=function(){this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&(this.cleanDimensions(),this.dirtyAssetSubscribers=!0),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers(),this.dirtyAssetSubscribers&&(this.dirtyAssetSubscribers=!1,this.notifySubscribers())},Jt.updateHere=function(){let t,e,i,s,n=this.controller,r=Math.round,[o,a]=this.currentDimensions;n&&n.here&&(this.here||(this.here={}),i=n.here,s=this.here,t=o/i.w,e=a/i.h,s.xRatio=t,s.x=r(i.x*t),s.yRatio=e,s.y=r(i.y*e),s.w=o,s.h=a)},Jt.getEntityHits=function(){let t=[],e=[],i=[];return this.groupBuckets&&this.groupBuckets.forEach(t=>{t.visibility&&e.push(t.getAllArtefactsAt(this.here))},this),e.length&&(e=e.reduce((t,e)=>t.concat(e),[]),e.forEach(e=>{let s=e.artefact;s.visibility&&i.indexOf(s.name)<0&&(i.push(s.name),t.push(s))})),t},Jt.rotateDestination=function(t,e,i,s){let n,r,o=s||this,a=o.mimic,h=o.currentRotation;if(a&&a.name&&o.useMimicFlip?(n=a.flipReverse?-1:1,r=a.flipUpend?-1:1):(n=o.flipReverse?-1:1,r=o.flipUpend?-1:1),h){h*=y;let s=Math.cos(h),o=Math.sin(h);t.setTransform(s*n,o*n,-o*r,s*r,e,i)}else t.setTransform(n,0,0,r,e,i);return this};const se=[];Jt.poolDefs={element:null,engine:null,state:null,width:300,height:100,alpha:1,composite:"source-over"};const ne=function(){return se.length||se.push(oe({name:"pool_"+F(),isPool:!0})),se.shift()},re=function(t){t&&"Cell"===t.type&&(t.engine.setTransform(1,0,0,1,0,0),se.push(t.setToDefaults()))},oe=function(t){return new Cell(t)};g.Cell=Cell;const Group=function(t={}){return this.makeName(t.name),this.register(),this.artefacts=[],this.artefactBuckets=[],this.set(this.defs),this.set(t),this};let ae=Group.prototype=Object.create(Object.prototype);ae.type="Group",ae.lib="group",ae.isArtefact=!1,ae.isAsset=!1,ae=nt(ae),ae=Zt(ae);ae.defs=Y(ae.defs,{artefacts:null,order:0,visibility:!0,regionRadius:0}),ae.packetExclusions=N(ae.packetExclusions,["artefactBuckets","batchResort"]),ae.postCloneAction=function(t,e){let s;return s=e.host?i[e.host]:this.currentHost?this.currentHost:!!this.host&&i[this.host],s&&(s.addGroups(t.name),t.host||(t.host=s.name)),t},ae.kill=function(t=!1){let e=this.name;return Object.entries(i).forEach(([t,i])=>{Array.isArray(i.groups)&&i.groups.indexOf(e)>=0&&(W(i.groups,e),i.batchResort=!0)}),Object.entries(a).forEach(([t,i])=>{Array.isArray(i.groups)&&i.groups.indexOf(e)>=0&&(W(i.groups,e),i.batchResort=!0)}),t&&this.artefactBuckets.forEach(t=>t.kill()),this.deregister()};let he=ae.getters,ce=ae.setters;he.artefacts=function(){return[].concat(this.artefacts)},ce.artefacts=function(t){this.artefacts=[],this.addArtefacts(t)},ce.host=function(t){let e=this.getHost(t);e&&e.addGroups&&(this.host=t,e.addGroups(this.name),this.dirtyHost=!0)},ce.order=function(t){let e=this.getHost(this.host);this.order=t,e&&e.set({batchResort:!0})},ae.getHost=function(t){let e=this.currentHost;return!e||e.substring?i[t]||a[t]||i[e]||a[e]||null:e},ae.forceStamp=function(){var t=this;return new Promise(e=>{let i=t.visibility;t.visibility=!0,t.stamp().then(s=>{t.visibility=i,e(s)}).catch(s=>{t.visibility=i,e(s)})})},ae.stamp=function(){if(this.dirtyHost||!this.currentHost){this.dirtyHost=!1;let t=this.getHost(this.host);t?this.currentHost=t:this.dirtyHost=!0}let t=this;return new Promise((e,i)=>{if(t.visibility){let s=t.currentHost;if(s){t.sortArtefacts();let n=!!(t.stashOutput||!t.noFilters&&t.filters&&t.filters.length)&&ne();if(n&&n.element){let t=s.currentDimensions;t&&(n.element.width=t[0],n.element.height=t[1])}t.prepareStamp(n),t.stampAction(n).then(i=>{n&&re(n),e(t.name)}).catch(t=>{n&&re(n),i(t)})}else e(!1)}else e(!1)})},ae.sortArtefacts=function(){if(this.batchResort){this.batchResort=!1;let t=Math.floor,e=[];this.artefacts.forEach(s=>{let n=i[s],r=t(n.order)||0;e[r]||(e[r]=[]),e[r].push(n)}),this.artefactBuckets=e.reduce((t,e)=>t.concat(e),[])}},ae.prepareStamp=function(t){let e=this.currentHost;t&&(e=t),this.artefactBuckets.forEach(i=>{"entity"===i.lib&&(i.currentHost&&i.currentHost.name===e.name||(i.currentHost=e,t||(i.dirtyHost=!0))),i.noDeltaUpdates||i.updateByDelta(),i.prepareStamp()})},ae.stampAction=function(t){!this.currentHost||this.currentHost.stashOutput;!this.dirtyFilters&&this.currentFilters||this.cleanFilters();let e=this,i=s=>new Promise((n,r)=>{let o=e.artefactBuckets[s];if(o&&o.stamp)o.stamp().then(()=>{i(s+1).then(t=>n(!0)).catch(t=>r(t))}).catch(t=>r(t));else if(t)if(!e.noFilters&&e.filters&&e.filters.length)e.applyFilters(t).then(t=>e.stashAction(t)).then(t=>n(!0)).catch(t=>r(t));else if(e.stashOutput){let i=t.element,s=t.engine,o=!(!e.currentHost||!e.currentHost.engine)&&e.currentHost.engine;if(o){o.save(),o.globalCompositeOperation="source-over",o.globalAlpha=1,o.setTransform(1,0,0,1,0,0),o.drawImage(i,0,0),o.restore();let t=s.getImageData(0,0,i.width,i.height);e.stashAction(t).then(t=>n(!0)).catch(t=>r(t))}else r("Could not find real engine")}else n(!0);else n(!0)});return i(0)},ae.applyFilters=function(t){let e=this;return new Promise((i,s)=>{let n=e.currentHost,r=t;n&&r||s("Group.applyFilters - no host");let o=function(){Ot(d),h.save(),h.globalCompositeOperation=e.filterComposite,h.globalAlpha=e.filterAlpha,h.setTransform(1,0,0,1,0,0),h.drawImage(c,0,0),h.restore()},a=n.element,h=n.engine,c=r.element,l=r.engine;e.isStencil&&(l.save(),l.globalCompositeOperation="source-in",l.globalAlpha=1,l.setTransform(1,0,0,1,0,0),l.drawImage(a,0,0),l.restore()),l.setTransform(1,0,0,1,0,0);let u=l.getImageData(0,0,c.width,c.height),d=Ct();At(d,{image:u,filters:e.currentFilters}).then(t=>{if(!t)throw new Error("image issue");l.globalCompositeOperation="source-over",l.globalAlpha=1,l.setTransform(1,0,0,1,0,0),l.putImageData(t,0,0),o(),i(t)}).catch(t=>{o(),s(t)})})},ae.stashAction=function(t){if(!t)return Promise.reject("No image data supplied to stashAction");if(this.stashOutput){this.stashOutput=!1;let e=this;return new Promise((i,s)=>{let[n,r,o,a]=e.getCellCoverage(t),h=ne(),c=h.engine,l=h.element;if(l.width=o,l.height=a,c.putImageData(t,-n,-r),e.stashedImageData=c.getImageData(0,0,o,a),e.stashOutputAsAsset)if(e.stashOutputAsAsset=!1,e.stashedImage)e.stashedImage.src=l.toDataURL();else{let t=e.stashedImage=document.createElement("img");t.id=e.name+"-groupimage",t.onload=function(){ti.appendChild(t),Yt("#"+t.id)},t.src=l.toDataURL()}re(h),i(!0)})}return Promise.resolve(!1)},ae.getCellCoverage=function(t){let e,i,s=t.width,n=t.height,r=t.data,o=0,a=0,h=s,c=n,l=3;for(i=0;i<n;i++)for(e=0;e<s;e++)r[l]&&(h>e&&(h=e),o<e&&(o=e),c>i&&(c=i),a<i&&(a=i)),l+=4;return h<o&&c<a?[h,c,o-h,a-c]:[0,0,s,n]},ae.addArtefacts=function(...t){return t&&Array.isArray(t[0])&&(t=t[0]),t.forEach(t=>{t&&(t.substring?N(this.artefacts,t):t.name&&N(this.artefacts,t.name))},this),this.batchResort=!0,this},ae.removeArtefacts=function(...t){return t.forEach(t=>{t&&(t.substring?W(this.artefacts,t):t.name&&W(this.artefacts,t.name))},this),this.batchResort=!0,this},ae.moveArtefactsIntoGroup=function(...t){let e,s;return t.forEach(t=>{t&&(s=t.substring?i[t]:t,s&&s.isArtefact&&(e=s.group?s.group:!!s.host&&u[s.host]),e&&(e.removeArtefacts(t),e.batchResort=!0),N(this.artefacts,t))},this),this.batchResort=!0,this},ae.clearArtefacts=function(){return this.artefacts.length=0,this.artefactBuckets.length=0,this.batchResort=!0,this},ae.updateArtefacts=function(t){return this.cascadeAction(t,"setDelta"),this},ae.setArtefacts=function(t){return this.cascadeAction(t,"set"),this},ae.updateByDelta=function(){return this.cascadeAction(!1,"updateByDelta"),this},ae.reverseByDelta=function(){return this.cascadeAction(!1,"reverseByDelta"),this},ae.addArtefactClasses=function(t){return this.cascadeAction(t,"addClasses"),this},ae.removeArtefactClasses=function(t){return this.cascadeAction(t,"removeClasses"),this},ae.cascadeAction=function(t,e){return this.artefacts.forEach(s=>{let n=i[s];n&&n[e]&&n[e](t)}),this},ae.setDeltaValues=function(t={}){return this.artefactBuckets.forEach(e=>e.setDeltaValues(t)),this},ae.addFiltersToEntitys=function(...t){return this.artefacts.forEach(e=>{let i=c[e];i&&i.addFilters&&i.addFilters(t)}),this},ae.removeFiltersFromEntitys=function(...t){return this.artefacts.forEach(e=>{let i=c[e];i&&i.removeFilters&&i.removeFilters(t)}),this},ae.clearFiltersFromEntitys=function(){return this.artefacts.forEach(t=>{let e=c[t];e&&e.clearFilters&&e.clearFilters()}),this},ae.getArtefactAt=function(t){let e=ne(),i=this.artefactBuckets;this.sortArtefacts();for(let s=i.length-1;s>=0;s--){let n=i[s];if(n){let i=n.checkHit(t,e);if(i)return re(e),i}}return re(e),!1},ae.getAllArtefactsAt=function(t){let e=ne(),i=this.artefactBuckets,s=[],n=[];this.sortArtefacts();for(let r=i.length-1;r>=0;r--){let o=i[r];if(o){let i=o.checkHit(t,e);if(i&&i.artefact){let t=i.artefact;s.indexOf(t.name)<0&&(s.push(t.name),n.push(i))}}}return re(e),n},ae.getArtefactCollisions=function(t){if(!t||!t.isArtefact||!this.artefactBuckets.length)return[];if(t.substring&&(t=i[t]),!t.collides)return[];let e,s,n,r=this.artefactBuckets,o=[],[a,h]=t.cleanCollisionData();for(s=0,n=r.length;s<n;s++)e=r[s],e&&e.cleanCollisionData&&t.name!==e.name?o.push(e):o.push(!1);let c,l,u,d,f,[p,m]=t.currentStampPosition;for(s=0,n=o.length;s<n;s++)if(e=o[s],e){let[t,i]=e.currentStampPosition;l=e.cleanCollisionData(),c=a+l[0],u=p-t,d=m-i,f=Math.sqrt(u*u+d*d),f>c&&(o[s]=!1)}let g=ne();for(s=0,n=o.length;s<n;s++)e=o[s],e&&(o[s]=e.checkHit(h,g));return re(g),o.filter(t=>!!t)};const le=function(t){return new Group(t)};g.Group=Group;const Vector=function(t,e,i){return this.x=0,this.y=0,this.z=0,q(t)&&this.set(t,e,i),this};let ue=Vector.prototype=Object.create(Object.prototype);ue.type="Vector",ue.getXYCoordinate=function(){return[this.x,this.y]},ue.getXYZCoordinate=function(){return[this.x,this.y,this.z]},ue.setX=function(t){if(!q(t))throw new Error(`${this.name} Vector error - setX() arguments error: ${t}`);return this.x=t,this},ue.setY=function(t){if(!q(t))throw new Error(`${this.name} Vector error - setY() arguments error: ${t}`);return this.y=t,this},ue.setZ=function(t){if(!q(t))throw new Error(`${this.name} Vector error - setZ() arguments error: ${t}`);return this.z=t,this},ue.setXY=function(t,e){if(!V(t,e))throw new Error(`${this.name} Vector error - setXY() arguments error: ${t}, ${e}`);return this.x=t,this.y=e,this},ue.set=function(t,e,i){return I(t)?this.setFromVector(t):Array.isArray(t)?this.setFromArray(t):V(t,e)?this.setFromArray([t,e,i]):this},ue.setFromArray=function(t){if(!Array.isArray(t))throw new Error(`${this.name} Vector error - setFromArray() arguments error: ${t}`);let[e,i,s]=t;return z(e)&&(this.x=e),z(i)&&(this.y=i),z(s)&&(this.z=s),this},ue.setFromVector=function(t){if(!I(t))throw new Error(`${this.name} Vector error - setFromVector() arguments error: ${JSON.stringify(t)}`);let{x:e,y:i,z:s}=t;return z(e)&&(this.x=e),z(i)&&(this.y=i),z(s)&&(this.z=s),this},ue.zero=function(){return this.x=0,this.y=0,this.z=0,this},ue.vectorAdd=function(t={}){if(Array.isArray(t))return this.vectorAddArray(t);let{x:e,y:i,z:s}=t;return z(e)&&(this.x+=e),z(i)&&(this.y+=i),z(s)&&(this.z+=s),this},ue.vectorAddArray=function(t=[]){let[e,i,s]=t;return z(e)&&(this.x+=e),z(i)&&(this.y+=i),z(s)&&(this.z+=s),this},ue.vectorSubtract=function(t={}){if(Array.isArray(t))return this.vectorSubtractArray(t);let{x:e,y:i,z:s}=t;return z(e)&&(this.x-=e),z(i)&&(this.y-=i),z(s)&&(this.z-=s),this},ue.vectorSubtractArray=function(t){let[e,i,s]=t;return z(e)&&(this.x-=e),z(i)&&(this.y-=i),z(s)&&(this.z-=s),this},ue.scalarMultiply=function(t){if(!z(t))throw new Error(`${this.name} Vector error - scalarMultiply() argument not a number: ${t}`);return this.x*=t,this.y*=t,this.z*=t,this},ue.scalarDivide=function(t){if(!z(t))throw new Error(`${this.name} Vector error - scalarDivide() argument not a number: ${t}`);if(!t)throw new Error(`${this.name} Vector error - scalarDivide() division by zero: ${t}`);return this.x/=t,this.y/=t,this.z/=t,this},ue.getMagnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},ue.rotate=function(t){if(!z(t))throw new Error(`${this.name} Vector error - rotate() argument not a number: ${t}`);let e=Math.atan2(this.y,this.x);e+=.01745329251*t;let i=this.getMagnitude();return this.x=i*Math.cos(e),this.y=i*Math.sin(e),this},ue.reverse=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},ue.normalize=function(){let t=this.getMagnitude();return t>0&&(this.x/=t,this.y/=t,this.z/=t),this};const de=[],fe=function(t,e,i){de.length||de.push(new Vector);let s=de.shift();return s.set(t,e,i),s},pe=function(t){t&&"Vector"===t.type&&de.push(t.zero())};g.Vector=Vector;const Quaternion=function(t={}){var e,i,s;return this.name=t.name||"generic",this.n=t.n||1,this.v=new Vector(e,i,s),this.set(t),this};let me=Quaternion.prototype=Object.create(Object.prototype);me.type="Quaternion",me.set=function(t={}){if(X(t))return this.setFromQuaternion(t);if(t&&t.type&&"Vector"===t.type)return this.setFromVector(t);if(U(t.pitch,t.yaw,t.roll))return this.setFromEuler(t);let e,i,s,n,r,o=this.v;return r=!(!q(t.vector)&&!q(t.v))&&(t.vector||t.v),n=!(!q(t.scalar)&&!q(t.n))&&(t.scalar||t.n||0),e=r?r.x||0:t.x||!1,i=r?r.y||0:t.y||!1,s=r?r.z||0:t.z||!1,this.n=z(n)?n:this.n,o.x=z(e)?e:o.x,o.y=z(i)?i:o.y,o.z=z(s)?s:o.z,this},me.setFromQuaternion=function(t){if(!X(t))throw new Error(`${this.name} Quaternion error - setFromQuaternion() bad argument: ${t}`);let e=this.v,i=t.v;return this.n=t.n,e.x=i.x,e.y=i.y,e.z=i.z,this},me.setFromEuler=function(t={}){let e,i,s,n,r,o,a,h,c,l=Math.cos,u=Math.sin,d=this.v;return e=(t.pitch||t.x||0)*y,i=(t.yaw||t.y||0)*y,s=(t.roll||t.z||0)*y,n=l(e/2),r=l(i/2),o=l(s/2),a=u(e/2),h=u(i/2),c=u(s/2),d.x=a*r*o+n*h*c,d.y=n*h*o+a*r*c,d.z=n*r*c-a*h*o,this.n=n*r*o-a*h*c,this},me.zero=function(){let t=this.v;return this.n=1,t.x=0,t.y=0,t.z=0,this},me.getMagnitude=function(){let t=this.v;return Math.sqrt(this.n*this.n+t.x*t.x+t.y*t.y+t.z*t.z)},me.normalize=function(){let t=this.getMagnitude(),e=this.v;if(!t)throw new Error(`${this.name} Quaternion error - normalize() division by zero: ${t}`);return this.n/=t,this.n=this.n>-1e-6&&this.n<1e-6?0:this.n,e.x/=t,e.x=e.x>-1e-6&&e.x<1e-6?0:e.x,e.y/=t,e.y=e.y>-1e-6&&e.y<1e-6?0:e.y,e.z/=t,e.z=e.z>-1e-6&&e.z<1e-6?0:e.z,this},me.quaternionMultiply=function(t){if(!X(t))throw new Error(`${this.name} Quaternion error - quaternionMultiply() bad argument: ${t}`);let e=this.v,i=t.v,s=this.n,n=e.x,r=e.y,o=e.z,a=t.n,h=i.x,c=i.y,l=i.z;return this.n=s*a-n*h-r*c-o*l,e.x=s*h+n*a+r*l-o*c,e.y=s*c+r*a+o*h-n*l,e.z=s*l+o*a+n*c-r*h,this},me.getAngle=function(t){let e;return t=!!q(t)&&t,e=2*Math.acos(this.n),t&&(e*=1/y),e>-1e-6&&e<1e-6?0:e},me.quaternionRotate=function(t){if(!X(t))throw new Error(`${this.name} Quaternion error - quaternionRotate() bad argument: ${t}`);let e=ye(t),i=ye(this);return this.setFromQuaternion(e.quaternionMultiply(i)),be(e),be(i),this};const ge=[],ye=function(t){ge.length||ge.push(Pe({name:"pool"}));let e=ge.shift();return e.set(t),e},be=function(t){t&&"Quaternion"===t.type&&ge.push(t.zero())},Pe=function(t={}){return new Quaternion(t)};function Se(t={}){(t=Qt(t=Gt(t=Vt(t=qt(t=Wt(t=Nt(t))))))).defs=Y(t.defs,{domElement:"",pitch:0,yaw:0,offsetZ:0,css:null,classes:"",position:"absolute",checkForResize:!1,trackHere:!1}),t.packetExclusions=N(t.packetExclusions,["domElement","pathCorners","rotation"]),t.packetFunctions=N(t.packetFunctions,["onEnter","onLeave","onDown","onUp"]),t.processDOMPacketOut=function(t,e,i){return this.processFactoryPacketOut(t,e,i)},t.processFactoryPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},t.finalizePacketOut=function(t,e){if(L(this.domElement)){let e=this.domElement,i=e.cloneNode(!0);i.querySelectorAll('[data-corner-div="sc"]').forEach(t=>i.removeChild(t)),t.outerHTML=i.outerHTML,t.host=e.parentElement.id}return t=this.handlePacketAnchor(t,e)},t.postCloneAction=function(t,e){return this.onEnter&&(t.onEnter=this.onEnter),this.onLeave&&(t.onLeave=this.onLeave),this.onDown&&(t.onDown=this.onDown),this.onUp&&(t.onUp=this.onUp),t};let e=t.setters,s=t.deltaSetters;return e.trackHere=function(t){this.trackHere=t,t?N(at,this.name):W(at,this.name)},e.position=function(t){this.position=t,this.dirtyPosition=!0},e.visibility=function(t){this.visibility=t,this.dirtyVisibility=!0},e.offsetZ=function(t){this.offsetZ=t,this.dirtyOffsetZ=!0},s.offsetZ=function(t){this.offsetZ+=t,this.dirtyOffsetZ=!0},e.roll=function(t){this.roll=this.checkRotationAngle(t),this.dirtyRotation=!0},s.roll=function(t){this.roll=this.checkRotationAngle(this.roll+t),this.dirtyRotation=!0},e.pitch=function(t){this.pitch=this.checkRotationAngle(t),this.dirtyRotation=!0},s.pitch=function(t){this.pitch=this.checkRotationAngle(this.pitch+t),this.dirtyRotation=!0},e.yaw=function(t){this.yaw=this.checkRotationAngle(t),this.dirtyRotation=!0},s.yaw=function(t){this.yaw=this.checkRotationAngle(this.yaw+t),this.dirtyRotation=!0},e.css=function(t){this.css=this.css?Y(this.css,t):t,this.dirtyCss=!0},e.classes=function(t){this.classes=t,this.dirtyClasses=!0},e.domAttributes=function(t){this.updateDomAttributes(t)},t.checkRotationAngle=function(t){return(t<-180||t>180)&&(t+=t>0?-360:360),t},t.updateDomAttributes=function(t,e){if(this.domElement){let i=this.domElement;t.substring&&q(e)?e?i.setAttribute(t,e):i.removeAttribute(t):I(t)&&Object.entries(t).forEach(([t,e])=>{e?i.setAttribute(t,e):i.removeAttribute(t)})}return this},t.initializeDomLayout=function(t){let e=t.domElement,s=e.style;if(s.boxSizing="border-box",e&&t.setInitialDimensions){let n,r=e.getBoundingClientRect(),o=(e.style.transform,e.style.transformOrigin,!1);if(t&&t.host&&(o=t.host,o.substring&&i[o]&&(o=i[o])),this.currentDimensions[0]=r.width,this.currentDimensions[1]=r.height,t.width=r.width,t.height=r.height,e.className&&(t.classes=e.className),o&&o.domElement&&(n=o.domElement.getBoundingClientRect(),n&&(t.startX=r.left-n.left,t.startY=r.top-n.top)),"Stack"===this.type){q(t.perspective)||q(t.perspectiveZ)||(t.perspectiveZ=q(s.perspective)&&s.perspective?parseFloat(s.perspective):0);let e=s.perspectiveOrigin;e.length&&(e=e.split(" "),e.length>0&&!q(t.perspective)&&!q(t.perspectiveX)&&(t.perspectiveX=e[0]),q(t.perspective)||q(t.perspectiveY)||(e.length>1?t.perspectiveY=e[1]:t.perspectiveY=e[0]))}}},t.addClasses=function(t){if(t.substring){let e=this.classes;e+=" "+t,e=e.trim(),e=e.replace(/[\s\uFEFF\xA0]+/g," "),e!==this.classes&&(this.classes=e,this.dirtyClasses=!0)}return this},t.removeClasses=function(t){if(t.substring){let e,i=this.classes;t.split().forEach(t=>{e=new RegExp(" ?"+t+" ?"),i=i.replace(e," "),i=i.trim(),i=i.replace(/[\s\uFEFF\xA0]+/g," ")}),i!==this.classes&&(this.classes=i,this.dirtyClasses=!0)}return this},t.addPathCorners=function(){if(this.domElement&&!this.noUserInteraction){let t=function(){let t=document.createElement("div");return t.style.width=0,t.style.height=0,t.style.position="absolute",t},e=t(),i=t(),s=t(),n=t();e.style.top="0%",e.style.left="0%",e.setAttribute("data-corner-div","sc"),i.style.top="0%",i.style.left="100%",i.setAttribute("data-corner-div","sc"),s.style.top="100%",s.style.left="100%",s.setAttribute("data-corner-div","sc"),n.style.top="100%",n.style.left="0%",n.setAttribute("data-corner-div","sc");let r=this.domElement;r.appendChild(e),r.appendChild(i),r.appendChild(s),r.appendChild(n),this.pathCorners.push(e),this.pathCorners.push(i),this.pathCorners.push(s),this.pathCorners.push(n),this.currentCornersData||(this.currentCornersData=[])}return this},t.checkCornerPositions=function(t){let e=this.pathCorners;if(4===e.length){let i,s=this.getHere(),n=lt.scrollX-(s.offsetX||0),r=lt.scrollY-(s.offsetY||0),o=Math.round,a=[];const h=function(t){let e=t[0];e?(a.push(o(e.left+n)),a.push(o(e.top+r))):a.push(0,0)};switch(t){case"topLeft":return i=e[0].getClientRects(),h(i),a;case"topRight":return i=e[1].getClientRects(),h(i),a;case"bottomRight":return i=e[2].getClientRects(),h(i),a;case"bottomLeft":return i=e[3].getClientRects(),h(i),a;default:return e.forEach(t=>{L(t)&&(i=t.getClientRects(),h(i))}),a}}},t.getCornerCoordinate=function(t,e){let i,s;switch(t){case"topLeft":[i,s]=this.checkCornerPositions("topLeft");break;case"topRight":[i,s]=this.checkCornerPositions("topRight");break;case"bottomRight":[i,s]=this.checkCornerPositions("bottomRight");break;case"bottomLeft":[i,s]=this.checkCornerPositions("bottomLeft");break;default:[i,s]=this.currentStampPosition}if(e){if("x"===e)return i;if("y"===e)return s}return[i,s]},t.cleanPathObject=function(){if(this.dirtyPathObject=!1,this.domElement&&!this.noUserInteraction){this.pathCorners.length||this.addPathCorners(),this.currentCornersData||(this.currentCornersData=[]);let t=this.currentCornersData;t.length=0,t.push(...this.checkCornerPositions());let e=this.pathObject=new Path2D;e.moveTo(t[0],t[1]),e.lineTo(t[2],t[3]),e.lineTo(t[4],t[5]),e.lineTo(t[6],t[7]),e.closePath()}},t.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let i=Array.isArray(t)?t:[t],s=!1;e||(e=requestCell(),s=!0);let n,r,o=e.engine,a=this.currentStampPosition;a[0],a[1];return i.some(t=>{if(Array.isArray(t))n=t[0],r=t[1];else{if(!V(t,t.x,t.y))return!1;n=t.x,r=t.y}return!(!n.toFixed||!r.toFixed||isNaN(n)||isNaN(r))&&o.isPointInPath(this.pathObject,n,r)},this)?(s&&releaseCell(e),{x:n,y:r,artefact:this}):(s&&releaseCell(e),!1)},t.cleanRotation=function(){this.dirtyRotation=!1,this.rotation&&X(this.rotation)||(this.rotation=Pe()),this.currentRotation&&X(this.rotation)||(this.currentRotation=Pe());let t=this.rotation;t.setFromEuler({pitch:this.pitch||0,yaw:this.yaw||0,roll:this.roll||0}),1!==t.getMagnitude()&&t.normalize();let e=ye(),i=this.path,s=this.mimic,n=this.pivot,r=this.lockTo;i&&r.indexOf("path")>=0?e.set(t):s&&this.useMimicRotation&&r.indexOf("mimic")>=0?q(s.currentRotation)?(e.set(s.currentRotation),this.addOwnRotationToMimic&&e.quaternionRotate(t)):this.dirtyMimicRotation=!0:(e.set(t),n&&this.addPivotRotation&&r.indexOf("pivot")>=0&&(q(n.currentRotation)?e.quaternionRotate(n.currentRotation):this.dirtyPivotRotation=!0)),this.currentRotation.set(e),be(e),this.dirtyPositionSubscribers=!0,this.mimicked&&this.mimicked.length&&(this.dirtyMimicRotation=!0)},t.cleanOffsetZ=function(){this.dirtyOffsetZ=!1},t.cleanContent=function(){this.dirtyContent=!1,this.domElement&&(this.dirtyDimensions=!0)},t.prepareStamp=function(){(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle||this.dirtyRotation)&&(this.dirtyPathObject=!0),this.dirtyContent&&this.cleanContent(),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyOffsetZ&&this.cleanOffsetZ(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.pivoted.length&&(this.dirtyStampPositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyPathObject&&this.cleanPathObject()},t.stamp=function(){let t=this;return new Promise((e,i)=>{t.domElement||i(!1);let s,n,r,o,a,[h,c]=t.currentStampPosition,[l,u]=t.currentStampHandlePosition,d=t.currentScale,f=t.currentRotation,p=`${l}px ${u}px 0`,m=`translate(${h-l}px,${c-u}px)`;(t.yaw||t.pitch||t.roll||t.pivot&&t.addPivotRotation||t.mimic&&t.useMimicRotation||t.path&&t.addPathRotation)&&(s=f.v,n=s.x,r=s.y,o=s.z,a=f.getAngle(!1),m+=` rotate3d(${n},${r},${o},${a}rad)`),t.offsetZ&&(m+=` translateZ(${t.offsetZ}px)`),1!==d&&(m+=` scale(${d},${d})`),m!==t.currentTransformString&&(t.currentTransformString=m,t.dirtyTransform=!0),p!==t.currentTransformOriginString&&(t.currentTransformOriginString=p,t.dirtyTransformOrigin=!0),(t.dirtyTransform||t.dirtyPerspective||t.dirtyPosition||t.dirtyDomDimensions||t.dirtyTransformOrigin||t.dirtyVisibility||t.dirtyCss||t.dirtyClasses||t.domShowRequired)&&(Qe(t.name),Ze(!0)),t.dirtyPositionSubscribers&&t.updatePositionSubscribers(),(t.dirtyMimicRotation||t.dirtyPivotRotation)&&(t.dirtyMimicRotation=!1,t.dirtyPivotRotation=!1,t.dirtyRotation=!0),t.dirtyMimicScale&&(t.dirtyMimicScale=!1,t.dirtyScale=!0),e(!0)})},t.apply=function(){St(),this.prepareStamp();let t=this;this.stamp().then(()=>{Je(t.name),t.dirtyPathObject=!0,t.cleanPathObject()}).catch(t=>console.log(t))},t}g.Quaternion=Quaternion;const Canvas=function(t={}){let e;if(this.makeName(t.name),this.register(),this.initializePositions(),this.dimensions[0]=300,this.dimensions[1]=150,this.pathCorners=[],this.css={},this.here={},this.perspective={x:"50%",y:"50%",z:0},this.dirtyPerspective=!0,this.initializeDomLayout(t),this.set(this.defs),t.label||(t.label=this.name+" canvas element"),this.set(t),this.cleanDimensions(),e=this.domElement,e){this.trackHere&&N(at,this.name),this.engine=this.domElement.getContext("2d"),this.state=Ht({engine:this.engine}),this.cells=[],this.cellBatchesClear=[],this.cellBatchesCompile=[],this.cellBatchesShow=[];let t={name:this.name+"_base",element:!1,width:this.currentDimensions[0],height:this.currentDimensions[1],cleared:!0,compiled:!0,shown:!1,isBase:!0,localizeHere:!0,host:this.name,controller:this,order:10};this.base=this.buildCell(t),N(Be,this.name),je(),e.getAttribute("role")||e.setAttribute("role","img");let i=document.createElement("nav");i.id=this.name+"-navigation",i.style.width="0px",i.style.height="0px",i.style.maxWidth="0px",i.style.maxHeight="0px",i.style.border="0px",i.style.padding="0px",i.style.margin="0px",i.style.overflow="hidden",this.navigation=i,e.parentNode.insertBefore(i,e.nextSibling);let s=document.createElement("div");s.id=this.name+"-text-hold",s.style.width="0px",s.style.height="0px",s.style.maxWidth="0px",s.style.maxHeight="0px",s.style.border="0px",s.style.padding="0px",s.style.margin="0px",s.style.overflow="hidden",this.textHold=s,e.parentNode.insertBefore(s,e.nextSibling);let n=document.createElement("div");n.id=this.name+"-ARIA-label",n.textContent=this.label,this.ariaLabelElement=n,ti.appendChild(n),e.setAttribute("aria-labelledby",n.id);let r=document.createElement("div");r.id=this.name+"-ARIA-description",r.textContent=this.description,this.ariaDescriptionElement=r,ti.appendChild(r),e.setAttribute("aria-describedby",r.id),this.cleanAria()}return this.dirtyCells=!0,this.apply(),t.setAsCurrentCanvas&&this.setAsCurrentCanvas(),this};let ve=Canvas.prototype=Object.create(Object.prototype);ve.type="Canvas",ve.lib="canvas",ve.isArtefact=!0,ve.isAsset=!1,ve=nt(ve),ve=Se(ve);ve.defs=Y(ve.defs,{position:"relative",trackHere:!0,fit:"none",isComponent:!1,title:"",label:"",description:""}),ve.stringifyFunction=T,ve.processPacketOut=T,ve.finalizePacketOut=T,ve.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},ve.clone=H,ve.kill=function(){let t,e,s=this.name,n=this.host;return W(Be,s),je(),W(at,s),n&&"root"!==n&&(t=this.currentHost?this.currentHost:i[n],t&&(t.removeGroups(s),e=u[t.name],e&&e.removeArtefacts(s))),u[s]&&u[s].kill(),this.base.kill(),this.navigation.remove(),this.textHold.remove(),this.ariaLabelElement.remove(),this.ariaDescriptionElement.remove(),this.domElement.remove(),this.deregister()};let ke=ve.getters,xe=ve.setters,we=ve.deltaSetters;ve.fitDefaults=["fill","contain","cover"],xe.fit=function(t){this.fit=this.fitDefaults.indexOf(t)>=0?t:"none"},xe.title=function(t){this.title=t,this.dirtyAria=!0},xe.label=function(t){this.label=t,this.dirtyAria=!0},xe.description=function(t){this.description=t,this.dirtyAria=!0},xe.trackHere=function(t){q(t)&&(t?N(at,this.name):W(at,this.name),this.trackHere=t)},ke.backgroundColor=function(){return this.base.backgroundColor},xe.backgroundColor=function(t){this.base&&this.base.set({backgroundColor:t})},ke.alpha=function(){return this.base.alpha},xe.alpha=function(t){this.base&&this.base.set({alpha:t})},we.alpha=function(t){this.base&&this.base.deltaSet({alpha:t})},ke.composite=function(){return this.base.composite},xe.composite=function(t){this.base&&this.base.set({composite:t})},ve.setAsCurrentCanvas=function(){return this.base&&Ne(this),this},ve.setBase=function(t){return this.base&&(this.base.set(t),this.setBaseHelper()),this},ve.deltaSetBase=function(t){return this.base&&(this.base.deltaSet(t),this.setBaseHelper()),this},ve.updateBaseHere=function(){this.base&&this.base.updateBaseHere(this.here,this.fit)},ve.setBaseHelper=function(){let t={};this.base.dirtyScale&&(t.dirtyScale=!0),this.base.dirtyDimensions&&(t.dirtyDimensions=!0),this.base.dirtyLock&&(t.dirtyLock=!0),this.base.dirtyStart&&(t.dirtyStart=!0),this.base.dirtyOffset&&(t.dirtyOffset=!0),this.base.dirtyHandle&&(t.dirtyHandle=!0),this.base.dirtyRotation&&(t.dirtyRotation=!0),this.cleanCells(),this.base.prepareStamp(),this.updateCells(t)},ve.updateCells=function(t={}){this.cells.forEach(e=>{let i=a[e];i&&(t.dirtyScale&&(i.dirtyScale=!0),t.dirtyDimensions&&(i.dirtyDimensions=!0),t.dirtyLock&&(i.dirtyLock=!0),t.dirtyStart&&(i.dirtyStart=!0),t.dirtyOffset&&(i.dirtyOffset=!0),t.dirtyHandle&&(i.dirtyHandle=!0),t.dirtyRotation&&(i.dirtyRotation=!0))})},ve.buildCell=function(t={}){t.host||!1||(t.host=this.base.name);let e=oe(t);return this.addCell(e),this.cleanCells(),e},ve.cleanDimensionsAdditionalActions=function(){this.cells&&this.updateCells({dirtyDimensions:!0}),this.dirtyDomDimensions=!0},ve.addCell=function(t){return(t=t.substring?t:t.name||!1)&&(N(this.cells,t),a[t].prepareStamp(),this.dirtyCells=!0),t},ve.removeCell=function(t){return(t=t.substring?t:t.name||!1)&&(W(this.cells,t),this.dirtyCells=!0),this},ve.killCell=function(t){let e=t.substring?a[t]:t;return e&&e.kill(),this.dirtyCells=!0,this},ve.clear=function(){let t=this;t.dirtyCells&&t.cleanCells();let e=i=>new Promise((s,n)=>{let r=t.cellBatchesClear[i];r?r.clear().then(t=>{e(i+1).then(t=>s(!0)).catch(t=>n(t))}).catch(t=>n(t)):s(!0)});return e(0)},ve.compile=function(){let t=this;t.dirtyCells&&t.cleanCells();let e=i=>new Promise((s,n)=>{let r=t.cellBatchesCompile[i];r?r.compile().then(t=>{e(i+1).then(t=>s(!0)).catch(t=>n(t))}).catch(t=>n(t)):(t.prepareStamp(),t.stamp().then(t=>s(!0)).catch(t=>n(t)))});return e(0)},ve.show=function(){let t=this;t.dirtyCells&&t.cleanCells();let e=i=>new Promise((s,n)=>{let r=t.cellBatchesShow[i];r?r.show().then(t=>{e(i+1).then(t=>s(!0)).catch(t=>n(t))}).catch(t=>n(t)):(t.engine.clearRect(0,0,t.localWidth,t.localHeight),t.base.show().then(t=>{Je(),this.dirtyAria&&this.cleanAria(),s(!0)}).catch(()=>n(err)))});return e(0)},ve.render=function(){let t=this;return new Promise(e=>{t.clear().then(()=>t.compile()).then(()=>t.show()).then(()=>e(!0)).catch(()=>e(!1))})},ve.cleanCells=function(){this.dirtyCells=!1;let t,e=[],i=[],s=[];this.cells.forEach(n=>{let r=a[n];r&&(r.cleared&&e.push(r),r.compiled&&(t=r.compileOrder,i[t]||(i[t]=[]),i[t].push(r)),r.shown&&(t=r.showOrder,s[t]||(s[t]=[]),s[t].push(r)))}),this.cellBatchesClear=[].concat(e),this.cellBatchesCompile=i.reduce((t,e)=>t.concat(e),[]),this.cellBatchesShow=s.reduce((t,e)=>t.concat(e),[])},ve.cascadeEventAction=function(t){this.currentActiveEntityNames||(this.currentActiveEntityNames=[]);let e=this.currentActiveEntityNames,s=[],n=[],r=[],o=[],h=[],c=[];this.cells.forEach(t=>{let e=a[t];e&&(e.shown||e.isBase)&&s.push(e.getEntityHits())}),s=s.reduce((t,e)=>t.concat(e),[]),s.forEach(t=>{let i=t.name;n.indexOf(i)<0&&(n.push(i),e.indexOf(i)<0?(r.push(t),o.push(i)):(h.push(t),c.push(i)))});let l=r.concat(h),u=function(){e.length&&(o.forEach(t=>W(e,t)),c.forEach(t=>W(e,t)),e.forEach(t=>{let e=i[t];e&&e.onLeave()}))};switch(t){case"down":l.forEach(t=>t.onDown());break;case"up":l.forEach(t=>t.onUp());break;case"enter":r.forEach(t=>t.onEnter());break;case"leave":u();break;case"move":u(),r.forEach(t=>t.onEnter())}return this.currentActiveEntityNames=o.concat(c),this.currentActiveEntityNames},ve.cleanAria=function(){this.dirtyAria=!1,this.domElement.setAttribute("title",this.title),this.ariaLabelElement.textContent=this.label,this.ariaDescriptionElement.textContent=this.description};const Ce=function(t){return new Canvas(t)};g.Canvas=Canvas;const Element=function(t={}){let e=t.domElement;return this.makeName(t.name),this.register(),e&&(t.text?e.textContent=t.text:t.content&&(e.innerHTML=t.content)),this.initializePositions(),this.dimensions[0]=this.dimensions[1]=100,this.pathCorners=[],this.css={},this.here={},this.initializeDomLayout(t),this.set(this.defs),this.set(t),e=this.domElement,e&&(e.id=this.name,this.trackHere&&N(at,this.name)),this.apply(),this};let Oe=Element.prototype=Object.create(Object.prototype);Oe.type="Element",Oe.lib="element",Oe.isArtefact=!0,Oe.isAsset=!1,Oe=nt(Oe),Oe=Se(Oe),Oe.factoryKill=function(){W(at,this.name),this.domElement.remove()};let De=Oe.setters;De.text=function(t){if(L(this.domElement)){let e=this.domElement,i=e.querySelectorAll('[data-corner-div="sc"]');e.textContent=t,i.forEach(t=>e.appendChild(t)),this.dirtyContent=!0}},De.content=function(t){if(this.domElement){let e=this.domElement,i=e.querySelectorAll('[data-corner-div="sc"]');e.innerHTML=t,i.forEach(t=>e.appendChild(t)),this.dirtyContent=!0}},Oe.cleanDimensionsAdditionalActions=function(){this.dirtyDomDimensions=!0},Oe.addCanvas=function(t={}){if(!this.canvas){let e=document.createElement("canvas"),i=this.domElement,s=i.getBoundingClientRect();window.getComputedStyle(i);i.parentNode.insertBefore(e,this.domElement);let n=Ce({name:this.name+"-canvas",domElement:e,position:"absolute",width:s.width,height:s.height,mimic:this.name,lockTo:"mimic",useMimicDimensions:!0,useMimicScale:!0,useMimicStart:!0,useMimicHandle:!0,useMimicOffset:!0,useMimicRotation:!0,addOwnDimensionsToMimic:!1,addOwnScaleToMimic:!1,addOwnStartToMimic:!1,addOwnHandleToMimic:!1,addOwnOffsetToMimic:!1,addOwnRotationToMimic:!1});return n.set(t),this.canvas=n,n}};const Ae=function(t){return new Element(t)};g.Element=Element;const Stack=function(t={}){let e,i;return this.makeName(t.name),this.register(),this.initializePositions(),this.initializeCascade(),this.dimensions[0]=300,this.dimensions[1]=150,this.pathCorners=[],this.css={},this.here={},this.perspective={x:"50%",y:"50%",z:0},this.dirtyPerspective=!0,this.initializeDomLayout(t),e=le({name:this.name,host:this.name}),this.addGroups(e.name),this.set(this.defs),this.set(t),i=this.domElement,i&&(this.trackHere&&N(at,this.name),"root"===i.getAttribute("data-group")&&(N(Be,this.name),je())),this};let Ee=Stack.prototype=Object.create(Object.prototype);Ee.type="Stack",Ee.lib="stack",Ee.isArtefact=!0,Ee.isAsset=!1,Ee=nt(Ee),Ee=Kt(Ee),Ee=Se(Ee);Ee.defs=Y(Ee.defs,{position:"relative",perspective:null,trackHere:!0,isResponsive:!1,containElementsInHeight:!1}),Ee.stringifyFunction=T,Ee.processPacketOut=T,Ee.finalizePacketOut=T,Ee.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},Ee.clone=H,Ee.kill=function(){let t=this.name;return W(Be,t),je(),W(at,t),u[t]&&u[t].kill(),Object.entries(i).forEach(([e,i])=>{i.host===t&&i.kill()}),this.domElement.remove(),this.deregister()};let Te=Ee.getters,He=Ee.setters,Re=Ee.deltaSetters;Te.perspectiveX=function(){return this.perspective.x},Te.perspectiveY=function(){return this.perspective.y},Te.perspectiveZ=function(){return this.perspective.z},He.perspectiveX=function(t){this.perspective.x=t,this.dirtyPerspective=!0},He.perspectiveY=function(t){this.perspective.y=t,this.dirtyPerspective=!0},He.perspectiveZ=function(t){this.perspective.z=t,this.dirtyPerspective=!0},He.perspective=function(t={}){this.perspective.x=q(t.x)?t.x:this.perspective.x,this.perspective.y=q(t.y)?t.y:this.perspective.y,this.perspective.z=q(t.z)?t.z:this.perspective.z,this.dirtyPerspective=!0},Re.perspectiveX=function(t){this.perspective.x=A(this.perspective.x,t),this.dirtyPerspective=!0},Re.perspectiveY=function(t){this.perspective.y=A(this.perspective.y,t),this.dirtyPerspective=!0},Ee.updateArtefacts=function(t={}){this.groupBuckets.forEach(e=>{e.artefactBuckets.forEach(e=>{t.dirtyScale&&(e.dirtyScale=!0),t.dirtyDimensions&&(e.dirtyDimensions=!0),t.dirtyLock&&(e.dirtyLock=!0),t.dirtyStart&&(e.dirtyStart=!0),t.dirtyOffset&&(e.dirtyOffset=!0),t.dirtyHandle&&(e.dirtyHandle=!0),t.dirtyRotation&&(e.dirtyRotation=!0),t.dirtyPathObject&&(e.dirtyPathObject=!0)})})},Ee.cleanDimensionsAdditionalActions=function(){this.groupBuckets&&this.updateArtefacts({dirtyDimensions:!0,dirtyPath:!0,dirtyStart:!0,dirtyHandle:!0}),this.dirtyDomDimensions=!0,this.dirtyPath=!0,this.dirtyStart=!0,this.dirtyHandle=!0},Ee.cleanPerspective=function(){this.dirtyPerspective=!1;let t=this.perspective;this.domPerspectiveString=`perspective-origin: ${t.x} ${t.y}; perspective: ${t.z}px;`,this.domShowRequired=!0,this.groupBuckets&&this.updateArtefacts({dirtyHandle:!0,dirtyPathObject:!0})},Ee.checkResponsive=function(){this.isResponsive&&this.trackHere&&(this.currentVportWidth||(this.currentVportWidth=lt.w),this.currentVportHeight||(this.currentVportHeight=lt.h),this.dirtyHeight&&this.containElementsInHeight&&(console.log("stack height final fixes need to be done"),this.dirtyHeight=!1),this.currentVportWidth!==lt.w&&(console.log("need to update for resized viewport width"),this.currentVportWidth=lt.w,this.containElementsInHeight&&(this.dirtyHeight=!0)),this.currentVportHeight!==lt.h&&(console.log("need to update for resized viewport height"),this.currentVportHeight=lt.h))},Ee.clear=function(){return this.checkResponsive(),Promise.resolve(!0)},Ee.compile=function(){let t=this;return new Promise((e,i)=>{t.sortGroups(),t.prepareStamp(),t.stamp().then(()=>{let e=[];return t.groupBuckets.forEach(t=>e.push(t.stamp())),Promise.all(e)}).then(()=>e(!0)).catch(t=>i(!1))})},Ee.show=function(){return new Promise(t=>{Je(),t(!0)})},Ee.render=function(){let t=this;return new Promise((e,i)=>{t.compile().then(()=>t.show()).then(()=>e(!0)).catch(t=>i(!1))})},Ee.addExistingDomElements=function(t){let e,i,s,n,r;if(q(t))for(e=t.substring?document.querySelectorAll(t):[].concat(t),n=0,r=e.length;n<r;n++)i=e[n],L(i)&&(s=Ae({name:i.id||i.name,domElement:i,group:this.name,host:this.name,position:"absolute",setInitialDimensions:!0}),s&&s.domElement&&this.domElement.appendChild(s.domElement));return this},Ee.addNewElement=function(t={}){if(t.tag){t.domElement=document.createElement(t.tag),t.domElement.setAttribute("data-group",this.name),q(t.group)||(t.group=this.name),t.host=this.name,t.position||(t.position="absolute"),q(t.width)||(t.width=100),q(t.height)||(t.height=100);let e=Ae(t);return e&&e.domElement&&(q(t.boxSizing)||(e.domElement.style.boxSizing="border-box"),this.domElement.appendChild(e.domElement)),e}return!1};const Fe=function(t){return new Stack(t)};g.Stack=Stack;let Be=[],je=()=>{Me=!0},Le=[],Me=!0;const ze=function(t){let e=t.getAttribute("data-group"),i=t.id||t.getAttribute("name"),s="absolute";e||(t.setAttribute("data-group","root"),e="root",s="relative"),i||(i=F(),t.id=i);let n=Fe({name:i,domElement:t,group:e,host:e,position:s,setInitialDimensions:!0});return Ie(t,i),n},Ie=function(t,e){let i=t.getBoundingClientRect(),s=0;Array.from(t.children).forEach(t=>{if(null!=t.getAttribute("data-stack")||j(t)||"SCRIPT"===t.tagName)t.setAttribute("data-group",e);else{let n=t.getBoundingClientRect(),r=window.getComputedStyle(t),o=parseFloat(r.marginTop)+parseFloat(r.borderTopWidth)+parseFloat(r.paddingTop)+parseFloat(r.paddingBottom)+parseFloat(r.borderBottomWidth)+parseFloat(r.marginBottom);s=s||n.top-i.top;let a={name:t.id||t.getAttribute("name"),domElement:t,group:e,host:e,position:"absolute",width:n.width,height:n.height,startX:n.left-i.left,startY:s,classes:t.className?t.className:""};s+=o+n.height,Ae(a)}})},Xe=function(t){let e=t.getAttribute("data-group"),i=t.id||t.getAttribute("name"),s="absolute";return e||(t.setAttribute("data-group","root"),e="root",s=t.style.position),i||(i=F(),t.id=i),Ce({name:i,domElement:t,group:e,host:e,position:s,setInitialDimensions:!0})};let Ye=null,$e=null;const Ne=function(t){let e=!1;if(t)if(t.substring){let i=o[t];i&&(Ye=i,e=!0)}else"Canvas"===t.type&&(Ye=t,e=!0);if(e&&Ye.base){let t=u[Ye.base.name];t&&($e=t)}},We=function(...t){return Ge(t),Ue("clear")},qe=function(...t){return Ge(t),Ue("compile")},Ve=function(...t){return Ge(t),Ue("show")},Ge=function(t){t.length?Le=t:Me&&function(){let t=Math.floor;if(Me){Me=!1;let e=[];Be.forEach(s=>{let n=i[s];if(n){let i=t(n.order)||0;e[i]||(e[i]=[]),e[i].push(n.name)}}),Le=e.reduce((t,e)=>t.concat(e),[])}}()},Ue=function(t){return new Promise((e,s)=>{let n=[];Le.forEach(e=>{let s=i[e];s&&s[t]&&n.push(s[t]())}),Promise.all(n).then(()=>e(!0)).catch(t=>s(t))})},_e=[],Qe=function(t=""){if(!t)throw new Error("core/document addDomShowElement() error - false argument supplied: "+t);if(!t.substring)throw new Error("core/document addDomShowElement() error - argument not a string: "+t);N(_e,t)};let Ke=!1;const Ze=function(t=!0){Ke=t},Je=function(t=""){if(Ke||t){let e,s,n,r,o,a,h,c,l,u,d,f,p,m,g,y,S,v;for(t?e=[t]:(Ke=!1,e=[].concat(_e),_e.length=0),s=0,n=e.length;s<n;s++){if(r=e[s],o=i[r],!o)throw new Error("core/document domShow() error - artefact missing: "+r);if(a=o.domElement,!a)throw new Error("core/document domShow() error - DOM element missing: "+r);if(h=a.style,o.dirtyPerspective&&(o.dirtyPerspective=!1,c=o.perspective,h.perspectiveOrigin=`${c.x} ${c.y}`,h.perspective=c.z+"px"),o.dirtyPosition&&(o.dirtyPosition=!1,h.position=o.position),o.dirtyDomDimensions&&(o.dirtyDomDimensions=!1,l=o.currentDimensions,u=l[0],d=l[1],"Canvas"===o.type?(a.width=u,a.height=d):(h.width=u+"px",h.height=d?d+"px":"auto")),o.dirtyTransformOrigin&&(o.dirtyTransformOrigin=!1,h.transformOrigin=o.currentTransformOriginString),o.dirtyTransform&&(o.dirtyTransform=!1,h.transform=o.currentTransformString),o.dirtyVisibility&&(o.dirtyVisibility=!1,h.display=o.visibility?"block":"none"),o.dirtyCss)for(o.dirtyCss=!1,m=o.css||{},g=Object.keys(m),f=0,p=g.length;f<p;f++)y=g[f],v=m[y],P.has(y)?(S=`${y[0].toUpperCase}${y.substr(1)}`,h["webkit"+S]=v,h["moz"+S]=v,h["ms"+S]=v,h["o"+S]=v,h[y]=v):b.has(y)&&(h[y]=v);o.dirtyClasses&&(o.dirtyClasses=!1,a.className.substring&&(a.className=o.classes))}}};let ti=document.createElement("div");ti.style.padding=0,ti.style.border=0,ti.style.margin=0,ti.style.width="4500px",ti.style.boxSizing="border-box",ti.style.position="absolute",ti.style.top="-5000px",ti.style.left="-5000px",ti.id="Scrawl-ARIA-default-hold",document.body.appendChild(ti);let ei=document.createElement("nav");ei.style.position="absolute",ei.style.top="-5000px",ei.style.left="-5000px",ei.id="Scrawl-navigation-default-hold",document.body.prepend(ei);const RenderAnimation=function(t={}){let e;if(t.target){if(Array.isArray(t.target)){let e=[];return t.target.forEach(i=>{let s=Object.assign({},t);s.name=`${s.name}_${i.name}`,s.target=i,e.push(new RenderAnimation(s))}),e}e=t.target.substring?i[t.target]:t.target}else e={clear:We,compile:qe,show:Ve};if(!(e&&e.clear&&e.compile&&e.show))return!1;this.makeName(t.name),this.order=q(t.order)?t.order:this.defs.order,this.onRun=t.onRun||T,this.onHalt=t.onHalt||T,this.onKill=t.onKill||T,this.target=e,this.commence=t.commence||T,this.afterClear=t.afterClear||T,this.afterCompile=t.afterCompile||T,this.afterShow=t.afterShow||T,this.afterCreated=t.afterCreated||T,this.error=t.error||T,this.readyToInitialize=!0;let s=this;return this.fn=function(){return new Promise((t,e)=>{Promise.resolve(s.commence()).then(()=>s.target.clear()).then(()=>Promise.resolve(s.afterClear())).then(()=>s.target.compile()).then(()=>Promise.resolve(s.afterCompile())).then(()=>s.target.show()).then(()=>Promise.resolve(s.afterShow())).then(()=>{s.readyToInitialize&&(s.afterCreated(),s.readyToInitialize=!1),t(!0)}).catch(t=>{s.error(t),e(t)})})},this.register(),t.observer&&(this.observer=_(this,this.target)),t.delay||this.run(),this};let ii=RenderAnimation.prototype=Object.create(Object.prototype);ii.type="RenderAnimation",ii.lib="animation",ii.isArtefact=!1,ii.isAsset=!1,ii=nt(ii);ii.defs=Y(ii.defs,{order:1,onRun:null,onHalt:null,onKill:null,commence:null,afterClear:null,afterCompile:null,afterShow:null,afterCreated:null,error:null,target:null}),ii.stringifyFunction=T,ii.processPacketOut=T,ii.finalizePacketOut=T,ii.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},ii.clone=H,ii.kill=function(){return this.onKill(),W(w,this.name),C(),this.deregister(),!0},ii.run=function(){return this.onRun(),N(w,this.name),C(),this},ii.isRunning=function(){return w.indexOf(this.name)>=0},ii.halt=function(){return this.onHalt(),W(w,this.name),C(),this};const si=function(t){return new RenderAnimation(t)};g.RenderAnimation=RenderAnimation;const UnstackedElement=function(t){let e=t.id||t.name;return this.makeName(e),this.register(),t.setAttribute("data-scrawl-name",this.name),this.domElement=t,this.elementComputedStyles=window.getComputedStyle(t),this.hostStyles={},this.canvasStartX=0,this.canvasStartY=0,this.canvasWidth=0,this.canvasHeight=0,this.canvasZIndex=0,this};let ni=UnstackedElement.prototype=Object.create(Object.prototype);ni.type="UnstackedElement",ni.lib="unstackedelement",ni.isArtefact=!1,ni.isAsset=!1,ni=nt(ni);ni.defs=Y(ni.defs,{canvasOnTop:!1});ni.getters,ni.setters,ni.deltaSetters;ni.demolish=function(t=!1){return!0},ni.addCanvas=function(t={}){if(!this.canvas){let e=document.createElement("canvas"),i=this.domElement,s=i.style;"static"===s.position&&(s.position="relative"),i.prepend(e);let n=Ce({name:this.name+"-canvas",domElement:e,position:"absolute"});return this.canvas=n,n.set(t),this.updateCanvas(),n}},ni.includedStyles=["width","height","zIndex","borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius"],ni.mimickedStyles=["borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius"],ni.checkElementStyleValues=function(){let t={},e=this.domElement,i=this.canvas;if(e&&i&&i.domElement){let s=this.hostStyles,n=this.elementComputedStyles,r=i.domElement,o=this.includedStyles,a=Math.max,{x:h,y:c,width:l,height:u}=e.getBoundingClientRect(),{x:d,y:f}=r.getBoundingClientRect();o.forEach(e=>{switch(e){case"width":let i=a(parseFloat(n.width),l);this.canvasWidth!==i&&(this.canvasWidth=i,this.dirtyDimensions=!0);break;case"height":let r=a(parseFloat(n.height),u);this.canvasHeight!==r&&(this.canvasHeight=r,this.dirtyDimensions=!0);break;case"zIndex":let o="auto"===n.zIndex?0:parseInt(n.zIndex,10);o=this.canvasOnTop?o+1:o-1,this.canvasZIndex!==o&&(this.canvasZIndex=o,this.dirtyZIndex=!0);break;default:let h=s[e],c=n[e];q(h)&&h===c||(s[e]=c,t[e]=c)}});let p=h-d,m=c-f;(p||m)&&(this.canvasStartX+=p,this.canvasStartY+=m,this.dirtyStart=!0)}return t},ni.updateCanvas=function(){if(this.canvas&&this.canvas.domElement){let t=this.canvas,e=t.domElement.style,i=this.mimickedStyles,s=this.checkElementStyleValues();for(let[t,n]of Object.entries(s))i.indexOf(t)>=0&&(e[t]=n);if(this.dirtyStart&&(this.dirtyStart=!1,t.set({startX:this.canvasStartX,startY:this.canvasStartY})),this.dirtyDimensions){this.dirtyDimensions=!1;let e=this.canvasWidth,i=this.canvasHeight;t.set({width:e,height:i}),t.dirtyDimensions=!0,t.base.set({width:e,height:i}),t.base.dirtyDimensions=!0,t.cleanDimensions(),t.base.cleanDimensions()}this.dirtyZIndex&&(this.dirtyZIndex=!1,e.zIndex=this.canvasZIndex)}};g.UnstackedElement=UnstackedElement;const ri=function(t,e,s,n){let r=i[t.id];if(!r)return!1;e.isComponent=!0;let o=r.addCanvas(e);s.name=r.name+"-animation",s.target=o;let a=si(s),h=_(a,r,n);return{element:r,canvas:o,animation:a,demolish:()=>{h(),a.kill(),o.demolish(),r.demolish(!0)}}},oi=function(t,e,i,s,n){let r,o=t.id;o&&m[o]?r=m[o]:r=new UnstackedElement(t),e.isComponent=!0;let a=!!n&&r.addCanvas(e);i.name=r.name+"-animation",a&&(i.afterClear||(i.afterClear=()=>r.updateCanvas()),i.target=a);let h=si(i),c=_(h,r,s);return{element:r,canvas:a,animation:h,demolish:()=>{c(),h.kill(),a&&a.demolish(),r.demolish(!0)}}},ai=["artefact","group","animation","tween","styles"],hi=t=>{if(t&&t.substring){let e;return!!ai.some(i=>(e=S[i][t],e))&&e}return!1};function ci(t={}){t.defs=Y(t.defs,{order:1,ticker:"",targets:null,time:0,action:null,reverseOnCycleEnd:!1,reversed:!1}),t.kill=function(){let t,i=this.ticker;return i===this.name+"_ticker"?(t=e[i],t&&t.kill()):i&&this.removeFromTicker(i),this.deregister(),!0};let i=t.getters,s=t.setters;return i.targets=function(){return[].concat(this.targets)},s.targets=function(t=[]){this.setTargets(t)},s.action=function(t){this.action=t,"function"!=typeof this.action&&(this.action=T)},t.calculateEffectiveTime=function(t){let i,s=G(t,this.time),n=E(s),r=n[1],o=n[0],a=0;return this.effectiveTime=0,"%"===o&&r<=100?this.ticker&&(i=e[this.ticker],i&&(a=i.effectiveDuration,this.effectiveTime=a*(r/100))):this.effectiveTime=r,this},t.addToTicker=function(t){let i;return q(t)&&(this.ticker&&this.ticker!==t&&this.removeFromTicker(this.ticker),i=e[t],q(i)&&(this.ticker=t,i.subscribe(this.name),this.calculateEffectiveTime())),this},t.removeFromTicker=function(t){let i;return(t=q(t)?t:this.ticker)&&(i=e[t],q(i)&&(this.ticker="",i.unsubscribe(this.name))),this},t.setTargets=function(t){t=[].concat(t);let e=[];return t.forEach(t=>{if(M(t))M(t.set)&&e.push(t);else if(I(t)&&q(t.name))e.push(t);else{let i=hi(t);i&&e.push(i)}}),this.targets=e,this},t.addToTargets=function(t){return(t=[].concat(t)).forEach(t=>{"function"==typeof t?"function"==typeof t.set&&this.targets.push(t):(result=hi(t),result&&this.targets.push(result))},this),this},t.removeFromTargets=function(t){t=[].concat(t);let e=[],i=[].concat(this.targets);return i.forEach(t=>{let i=t.type||"unknown",s=t.name||"unnamed";"unknown"!==i&&"unnamed"!==s&&e.push(`${i}_${s}`)}),t.forEach(t=>{let s;if(s="function"==typeof t?t:hi(t),s){let t=s.type||"unknown",n=s.name||"unnamed";if("unknown"!==t&&"unnamed"!==n){let s=`${t}_${n}`,r=e.indexOf(s);r>=0&&(i[r]=!1)}}}),this.targets=[],i.forEach(t=>{t&&this.targets.push(t)},this),this},t.checkForTarget=function(t){return!!t.substring&&this.targets.some(e=>e.name===t)},t}const Action=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.calculateEffectiveTime(),q(t.ticker)&&this.addToTicker(t.ticker),this};let li=Action.prototype=Object.create(Object.prototype);li.type="Action",li.lib="tween",li.isArtefact=!1,li.isAsset=!1,li=nt(li),li=ci(li);li.defs=Y(li.defs,{revert:null}),li.packetExclusions=N(li.packetExclusions,["targets"]),li.packetFunctions=N(li.packetFunctions,["revert","action"]),li.finalizePacketOut=function(t,e){return Array.isArray(this.targets)&&(t.targets=this.targets.map(t=>t.name)),t};let ui=li.setters;ui.revert=function(t){this.revert=t,"function"!=typeof this.revert&&(this.revert=T)},ui.triggered=function(t){this.triggered!==t&&(t?this.action():this.revert(),this.triggered=t)},li.set=function(t={}){if(t){let e=this.setters,i=this.defs,s=!!q(t.ticker)&&this.ticker;Object.entries(t).forEach(([t,s])=>{if("name"!==t){let n=e[t];n?n.call(this,s):void 0!==i[t]&&(this[t]=s)}},this),s?(this.ticker=s,this.addToTicker(t.ticker)):q(t.time)&&this.calculateEffectiveTime()}return this},li.getEndTime=function(){return this.effectiveTime},li.update=function(t){let e=this.reversed,i=this.effectiveTime,s=this.triggered,n=(this.reverseOnCycleEnd,t.tick),r=t.reverseTick,o=t.willLoop;t.next;return e?r>=i?s||(this.action(),this.triggered=!0):s&&(this.revert(),this.triggered=!1):n>=i?s||(this.action(),this.triggered=!0):s&&(this.revert(),this.triggered=!1),o&&(this.triggered=!this.triggered),!0};function di(t={}){(t=Zt(t=Qt(t=Gt(t=Vt(t=qt(t=Wt(t=Nt(t)))))))).defs=Y(t.defs,{method:"fill",pathObject:null,winding:"nonzero",flipReverse:!1,flipUpend:!1,scaleOutline:!0,lockFillStyleToEntity:!1,lockStrokeStyleToEntity:!1,onEnter:null,onLeave:null,onDown:null,onUp:null}),t.packetExclusions=N(t.packetExclusions,["state"]),t.packetFunctions=N(t.packetFunctions,["onEnter","onLeave","onDown","onUp"]),t.processEntityPacketOut=function(t,e,i){return this.processFactoryPacketOut(t,e,i)},t.processFactoryPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},t.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=Y(t,i),t=this.handlePacketAnchor(t,e)},t.postCloneAction=function(t,e){return this.onEnter&&(t.onEnter=this.onEnter),this.onLeave&&(t.onLeave=this.onLeave),this.onDown&&(t.onDown=this.onDown),this.onUp&&(t.onUp=this.onUp),e.sharedState&&(t.state=this.state),e.anchor&&(e.anchor.host=t,q(e.anchor.focusAction)||(e.anchor.focusAction=this.anchor.focusAction),q(e.anchor.blurAction)||(e.anchor.blurAction=this.anchor.blurAction),t.buildAnchor(e.anchor),e.anchor.clickAction||(t.anchor.clickAction=this.anchor.clickAction)),t};let e=t.getters,i=t.setters;t.deltaSetters;return e.group=function(){return this.group?this.group.name:""},i.lockStylesToEntity=function(t){this.lockFillStyleToEntity=t,this.lockStrokeStyleToEntity=t},t.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},t.set=function(t={}){if(t){let e=this.setters,i=this.defs,s=this.state,n=s?s.setters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],h=!1;a||(a=n[t],h=!0),a?a.call(h?this.state:this,o):void 0!==i[t]?this[t]=o:void 0!==r[t]&&(s[t]=o)}},this)}return this},t.setDelta=function(t={}){if(t){let e=this.deltaSetters,i=this.defs,s=this.state,n=s?s.deltaSetters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],h=!1;a||(a=n[t],h=!0),a?a.call(h?this.state:this,o):void 0!==i[t]?this[t]=A(this[t],o):void 0!==r[t]&&(s[t]=A(s[t],o))}},this)}return this},t.entityInit=function(t={}){this.makeName(t.name),this.register(),this.initializePositions(),this.set(this.defs),this.state=Ht(),t.group||(t.group=$e),this.onEnter=T,this.onLeave=T,this.onDown=T,this.onUp=T,this.set(t),this.midInitActions(t),this.purge&&this.purgeArtefact(this.purge)},t.midInitActions=T,t.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1,this.dirtyDimensions=!0),(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle)&&(this.dirtyPathObject=!0),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers(),this.anchor&&this.dirtyAnchorHold&&(this.dirtyAnchorHold=!1,this.buildAnchor(this.anchor))},t.cleanPathObject=T,t.stamp=function(t=!1,e,i){let s=!(this.noFilters||!this.filters||!this.filters.length);return t?(e&&"Cell"===e.type&&(this.currentHost=e),i&&(this.set(i),this.prepareStamp()),s?this.filteredStamp():this.regularStamp()):this.visibility?this.stashOutput||s?this.filteredStamp():this.regularStamp():Promise.resolve("entity.stamp")},t.regularStamp=function(){let t=this;return new Promise((e,i)=>{t.currentHost&&(t.regularStampSynchronousActions(),e("entity.regularStamp resolving")),i("entity.regularStamp - no currentHost")})},t.filteredStamp=function(){!this.dirtyFilters&&this.currentFilters||this.cleanFilters();let t=this;return new Promise((e,i)=>{let s=function(){if(u&&Ot(u),o.save(),o.globalCompositeOperation=t.filterComposite,o.globalAlpha=t.filterAlpha,o.setTransform(1,0,0,1,0,0),o.drawImage(c,0,0),t.stashOutput){t.stashOutput=!1;let[e,i,s,n]=t.getCellCoverage(l.getImageData(0,0,c.width,c.height));if(t.stashedImageData=l.getImageData(e,i,s,n),t.stashOutputAsAsset)if(t.stashOutputAsAsset=!1,c.width=s,c.height=n,l.putImageData(t.stashedImageData,0,0),t.stashedImage)t.stashedImage.src=c.toDataURL();else{let e=t.stashedImage=document.createElement("img");e.id=t.name+"-image",e.onload=function(){ti.appendChild(e),Yt("#"+e.id)},e.src=c.toDataURL()}}re(h),o.restore(),t.currentHost=n,t.noCanvasEngineUpdates=m},n=t.currentHost,r=n.element,o=n.engine,a=n.currentDimensions,h=ne(),c=h.element,l=h.engine;t.currentHost=h;let u,d,f=c.width=a[0]||r.width,p=c.height=a[1]||r.height,m=t.noCanvasEngineUpdates;t.noCanvasEngineUpdates=!1,t.regularStampSynchronousActions(),!t.noFilters&&t.filters&&t.filters.length?(t.isStencil&&(l.save(),l.globalCompositeOperation="source-in",l.globalAlpha=1,l.setTransform(1,0,0,1,0,0),l.drawImage(r,0,0),l.restore()),l.setTransform(1,0,0,1,0,0),d=l.getImageData(0,0,f,p),u=Ct(),At(u,{image:d,filters:t.currentFilters}).then(t=>{if(!t)throw new Error("image issue");l.globalCompositeOperation="source-over",l.globalAlpha=1,l.setTransform(1,0,0,1,0,0),l.putImageData(t,0,0),s(),e(!0)}).catch(t=>{s(),i(t)})):(s(),e(!0))})},t.getCellCoverage=function(t){let e,i,s=t.width,n=t.height,r=t.data,o=0,a=0,h=s,c=n,l=3;for(i=0;i<n;i++)for(e=0;e<s;e++)r[l]&&(h>e&&(h=e),o<e&&(o=e),c>i&&(c=i),a<i&&(a=i)),l+=4;return h<o&&c<a?[h,c,o-h,a-c]:[0,0,s,n]},t.simpleStamp=function(t,e={}){t&&"Cell"===t.type&&(this.currentHost=t,this.set(e),this.prepareStamp(),this.regularStampSynchronousActions())},t.regularStampSynchronousActions=function(){let t=this.currentHost;if(t){let e=t.engine,i=this.currentStampPosition,s=i[0],n=i[1];t.rotateDestination(e,s,n,this),this.noCanvasEngineUpdates||t.setEngine(this),this[this.method](e)}},t.draw=function(t){t.stroke(this.pathObject)},t.fill=function(t){t.fill(this.pathObject,this.winding)},t.drawAndFill=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding)},t.fillAndDraw=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding),t.stroke(e)},t.drawThenFill=function(t){let e=this.pathObject;t.stroke(e),t.fill(e,this.winding)},t.fillThenDraw=function(t){let e=this.pathObject;t.fill(e,this.winding),t.stroke(e)},t.clear=function(t){let e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fill(this.pathObject,this.winding),t.globalCompositeOperation=e},t.none=function(t){},t}g.Action=Action;const Block=function(t={}){return this.entityInit(t),t.dimensions||(t.width||(this.currentDimensions[0]=this.dimensions[0]=10),t.height||(this.currentDimensions[1]=this.dimensions[1]=10)),this};let fi=Block.prototype=Object.create(Object.prototype);fi.type="Block",fi.lib="entity",fi.isArtefact=!0,fi.isAsset=!1,fi=nt(fi),fi=di(fi),fi.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=this.currentStampHandlePosition,i=this.currentScale,s=this.currentDimensions,n=-e[0]*i,r=-e[1]*i,o=s[0]*i,a=s[1]*i;t.rect(n,r,o,a)}};g.Block=Block;const pi={x:0,y:0},mi=function(t,e,i){t.x=e,t.y=i},gi=function(t,e){let i=Math.atan2(t.y,t.x);i+=.01745329251*e;let s=Math.sqrt(t.x*t.x+t.y*t.y);t.x=s*Math.cos(i),t.y=s*Math.sin(i)},yi=function(t,e,i){let s,n,r=[],o=[],a=[],h=[],c=0;if("linear"===t){let[t,e,a,h]=i;s=a-t,n=h-e,c=Math.sqrt(s*s+n*n),r=r.concat([t,a]),o=o.concat([e,h])}else if("bezier"===t||"quadratic"===t){let l,u,d,f,p,m,g="bezier"===t?"getBezierXY":"getQuadraticXY",y=!1,b=.25,P=0;for(;!y;){for(r.length=0,o.length=0,P=0,a.length=0,h.length=0,m=bi[g](0,...i),l=m.x,u=m.y,r.push(l),o.push(u),p=b;p<=1;p+=b)m=bi[g](p,...i),({x:d,y:f}=m),r.push(d),o.push(f),s=d-l,n=f-u,P+=Math.sqrt(s*s+n*n),l=d,u=f,a.push(P),h.push(p);P<c+e&&(y=!0),c=P,b/=2,b<.004&&(y=!0)}}return{length:c,xPoints:r,yPoints:o,positions:h,progression:a}},bi={getBezierXY:function(t,e,i,s,n,r,o,a,h){let c=1-t;return{x:Math.pow(c,3)*e+3*t*Math.pow(c,2)*s+3*t*t*c*r+t*t*t*a,y:Math.pow(c,3)*i+3*t*Math.pow(c,2)*n+3*t*t*c*o+t*t*t*h}},getQuadraticXY:function(t,e,i,s,n,r,o){let a=1-t;return{x:a*a*e+2*a*t*s+t*t*r,y:a*a*i+2*a*t*n+t*t*o}}};function Pi(t={}){(t=di(t)).defs=Y(t.defs,{species:"",useAsPath:!1,precision:10,constantPathSpeed:!1,pathDefinition:"",showBoundingBox:!1,boundingBoxColor:"rgba(0,0,0,0.5)",minimumBoundingBoxDimensions:20}),t.packetExclusions=N(t.packetExclusions,["dimensions","pathed"]),t.packetExclusionsByRegex=N(t.packetExclusionsByRegex,[]),t.packetCoordinates=N(t.packetCoordinates,[]),t.packetObjects=N(t.packetObjects,[]),t.packetFunctions=N(t.packetFunctions,[]),t.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=Y(t,i),t=this.handlePacketAnchor(t,e)};t.getters;let e=t.setters,s=t.deltaSetters;return e.species=function(t){q(t)&&(this.species=t,this.updateDirty())},e.precision=function(t){q(t)&&t.toFixed&&(this.precision=t,this.updateDirty())},e.constantPathSpeed=function(t){this.constantPathSpeed=t,this.updateDirty()},e.width=T,e.height=T,e.dimensions=T,s.width=T,s.height=T,s.dimensions=T,e.pathDefinition=function(t){t.substring&&(this.pathDefinition=t),this.dirtyPathObject=!0},t.updateDirty=function(){this.dirtySpecies=!0,this.dirtyPathObject=!0},t.midInitActions=function(t){this.set(t)},t.shapeInit=function(t){this.entityInit(t),this.units=[],this.unitLengths=[],this.unitPartials=[],this.pathed=[],this.localBox=[]},t.positionPointOnPath=function(t){let e=fe(t);e.vectorSubtract(this.currentStampHandlePosition),this.flipReverse&&(e.x=-e.x),this.flipUpend&&(e.y=-e.y),e.rotate(this.roll),e.vectorAdd(this.currentStampPosition);let i={x:e.x,y:e.y};return pe(e),i},t.getBezierXY=function(t,e,i,s,n,r,o,a,h){let c=1-t;return{x:Math.pow(c,3)*e+3*t*Math.pow(c,2)*s+3*t*t*c*r+t*t*t*a,y:Math.pow(c,3)*i+3*t*Math.pow(c,2)*n+3*t*t*c*o+t*t*t*h}},t.getQuadraticXY=function(t,e,i,s,n,r,o){let a=1-t;return{x:a*a*e+2*a*t*s+t*t*r,y:a*a*i+2*a*t*n+t*t*o}},t.getLinearXY=function(t,e,i,s,n){return{x:e+(s-e)*t,y:i+(n-i)*t}},t.getBezierAngle=function(t,e,i,s,n,r,o,a,h){let c=1-t,l=Math.pow(c,2)*(s-e)+2*t*c*(r-s)+t*t*(a-r),u=Math.pow(c,2)*(n-i)+2*t*c*(o-n)+t*t*(h-o);return(-Math.atan2(l,u)+.5*Math.PI)/y},t.getQuadraticAngle=function(t,e,i,s,n,r,o){let a=1-t,h=2*a*(s-e)+2*t*(r-s),c=2*a*(n-i)+2*t*(o-n);return(-Math.atan2(h,c)+.5*Math.PI)/y},t.getLinearAngle=function(t,e,i,s,n){let r=s-e,o=n-i;return(-Math.atan2(r,o)+.5*Math.PI)/y},t.getConstantPosition=function(t){if(!t||!t.toFixed||isNaN(t))return 0;if(t>=1)return.9999;let e=this.unitPositions;if(e&&e.length){let e,i,s,n,r,o,a,h=this.length,c=this.unitProgression,l=this.unitPositions,u=t*h,d=-1;for(let t=0,e=c.length;t<e;t++)if(u<=c[t]){d=t-1;break}return d<0?(e=c[0],n=u/e*l[0]):(e=c[d],i=d?c[d-1]:0,s=e-i,r=l[d],o=l[d+1],a=o-r,n=r+(u-e)/s*a),n}return t},t.buildPathPositionObject=function(t,e){if(t){let i,s,[n,...r]=t;switch(n){case"linear":i=this.positionPointOnPath(this.getLinearXY(e,...r)),s=this.getLinearAngle(e,...r);break;case"quadratic":i=this.positionPointOnPath(this.getQuadraticXY(e,...r)),s=this.getQuadraticAngle(e,...r);break;case"bezier":i=this.positionPointOnPath(this.getBezierXY(e,...r)),s=this.getBezierAngle(e,...r)}let o=0;return this.flipReverse&&o++,this.flipUpend&&o++,1===o&&(s=-s),s+=this.roll,i.angle=s,i}return!1},t.getPathPositionData=function(t,e=!1){if(this.useAsPath&&q(t)&&t.toFixed){let i,s,n,r,o,a,h=t%1,c=this.unitPartials,l=0;for(0===t?h=0:1===t&&(h=.9999),e&&(h=this.getConstantPosition(h)),n=0,r=c.length;n<r;n++)if(a=this.units[n][0],"move"!==a&&"close"!==a&&"unknown"!==a){if(i=c[n],h<=i){o=this.units[n],s=(h-l)/(i-l);break}l=i}return this.buildPathPositionObject(o,s)}return!1},t.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1),(this.dirtyScale||this.dirtySpecies||this.dirtyDimensions||this.dirtyStart||this.dirtyHandle)&&(this.dirtyPathObject=!0,(this.dirtyScale||this.dirtySpecies)&&(this.pathCalculatedOnce=!1)),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0),this.dirtyScale&&this.cleanScale(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyRotation&&this.cleanRotation(),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtySpecies&&this.cleanSpecies(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers()},t.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyOffset=!0},t.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){this.calculateLocalPath(this.pathDefinition),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyHandle&&this.cleanHandle(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions();let t=this.currentStampHandlePosition;this.pathObject=new Path2D(`m${-t[0]},${-t[1]}${this.localPath}`)}},t.calculateLocalPath=function(t,e){let i;if(this.pathCalculatedOnce||(i=function(t,e,i,s,n){let r,o,a,h,c=[],l=[],u="",d="",f=[],p=[],m=[],g=t.match(/([A-Za-z][0-9. ,\-]*)/g),y=0,b={},P=0,S=0,v=0,k=0,x=[],w=[],C=[],O=[],D=0,A=0,E=t=>{l.push({c:u.toLowerCase(),p:t||null,x:v,y:k,cx:P,cy:S,rx:D,ry:A}),s||(x.push(P),w.push(S)),v=P,k=S};for(r=0,o=g.length;r<o;r++)if(u=g[r][0],c=g[r].match(/(-?[0-9.]+\b)/g)||[],c.length){for(a=0,h=c.length;a<h;a++)c[a]=parseFloat(c[a]);switch(0===r?"M"===u&&(v=c[0]*e-i.x,k=c[1]*e-i.y,u="m"):(v=P,k=S),u){case"H":for(a=0,h=c.length;a<h;a++)c[a]=c[a]*e-v,P+=c[a],D=A=0,E(c.slice(a,a+1));break;case"V":for(a=0,h=c.length;a<h;a++)c[a]=c[a]*e-k,S+=c[a],D=A=0,E(c.slice(a,a+1));break;case"M":for(a=0,h=c.length;a<h;a+=2)c[a]=c[a]*e-v,c[a+1]=c[a+1]*e-k,P+=c[a],S+=c[a+1],D=A=0,E(c.slice(a,a+2));break;case"L":case"T":for(a=0,h=c.length;a<h;a+=2)c[a]=c[a]*e-v,c[a+1]=c[a+1]*e-k,P+=c[a],S+=c[a+1],"T"===u?(D=c[a]+v,A=c[a+1]+k):D=A=0,E(c.slice(a,a+2));break;case"Q":case"S":for(a=0,h=c.length;a<h;a+=4)c[a]=c[a]*e-v,c[a+1]=c[a+1]*e-k,c[a+2]=c[a+2]*e-v,c[a+3]=c[a+3]*e-k,P+=c[a+2],S+=c[a+3],D=c[a]+v,A=c[a+1]+k,E(c.slice(a,a+4));break;case"C":for(a=0,h=c.length;a<h;a+=6)c[a]=c[a]*e-v,c[a+1]=c[a+1]*e-k,c[a+2]=c[a+2]*e-v,c[a+3]=c[a+3]*e-k,c[a+4]=c[a+4]*e-v,c[a+5]=c[a+5]*e-k,P+=c[a+4],S+=c[a+5],D=c[a+2]+v,A=c[a+3]+k,E(c.slice(a,a+6));break;case"A":for(a=0,h=c.length;a<h;a+=7)c[a+5]=c[a+5]*e-v,c[a+6]=c[a+6]*e-k,P+=c[a+5],S+=c[a+6],D=A=0,E(c.slice(a,a+7));break;case"h":for(a=0,h=c.length;a<h;a++)c[a]*=e,P+=c[a],D=A=0,E(c.slice(a,a+1));break;case"v":for(a=0,h=c.length;a<h;a++)c[a]*=e,S+=c[a],D=A=0,E(c.slice(a,a+1));break;case"m":case"l":case"t":for(a=0,h=c.length;a<h;a+=2)c[a]*=e,c[a+1]*=e,P+=c[a],S+=c[a+1],"t"===u?(D=c[a]+v,A=c[a+1]+k):D=A=0,E(c.slice(a,a+2));break;case"q":case"s":for(a=0,h=c.length;a<h;a+=4)c[a]*=e,c[a+1]*=e,c[a+2]*=e,c[a+3]*=e,P+=c[a+2],S+=c[a+3],D=c[a]+v,A=c[a+1]+k,E(c.slice(a,a+4));break;case"c":for(a=0,h=c.length;a<h;a+=6)c[a]*=e,c[a+1]*=e,c[a+2]*=e,c[a+3]*=e,c[a+4]*=e,c[a+5]*=e,P+=c[a+4],S+=c[a+5],D=c[a+2]+v,A=c[a+3]+k,E(c.slice(a,a+6));break;case"a":for(a=0,h=c.length;a<h;a+=7)c[a]*=e,c[a+1]*=e,c[a+5]*=e,c[a+6]*=e,P+=c[a+5],S+=c[a+6],D=A=0,E(c.slice(a,a+7))}}else D=A=0,E();for(r=0,o=l.length;r<o;r++){let t=l[r],e=t.p;if(e){for(a=0,h=e.length;a<h;a++)e[a]=e[a].toFixed(1);for(d+=`${t.c}${t.p.join()}`,a=0,h=e.length;a<h;a++)e[a]=parseFloat(e[a])}else d+=""+t.c}if(b.localPath=d,s){let t=pi;for(r=0,o=l.length;r<o;r++){let e=l[r],i=r>0&&l[r-1],{c:s,p:n,x:o,y:a,cx:h,cy:c,rx:u,ry:d}=e;if(n)switch(s){case"h":f[r]=["linear",o,a,n[0]+o,a];break;case"v":f[r]=["linear",o,a,o,n[0]+a];break;case"m":f[r]=["move",o,a];break;case"l":f[r]=["linear",o,a,n[0]+o,n[1]+a];break;case"t":i&&(i.rx||i.ry)?(mi(t,i.rx-h,i.ry-c),gi(t,180),f[r]=["quadratic",o,a,t.x+h,t.y+c,n[0]+o,n[1]+a]):f[r]=["quadratic",o,a,o,a,n[0]+o,n[1]+a];break;case"q":f[r]=["quadratic",o,a,n[0]+o,n[1]+a,n[2]+o,n[3]+a];break;case"s":i&&(i.rx||i.ry)?(mi(t,i.rx-h,i.ry-c),gi(t,180),f[r]=["bezier",o,a,t.x+h,t.y+c,n[0]+o,n[1]+a,n[2]+o,n[3]+a]):f[r]=["bezier",o,a,o,a,n[0]+o,n[1]+a,n[2]+o,n[3]+a];break;case"c":f[r]=["bezier",o,a,n[0]+o,n[1]+a,n[2]+o,n[3]+a,n[4]+o,n[5]+a];break;case"a":f[r]=["linear",o,a,n[5]+o,n[6]+a];break;case"z":isNaN(o)&&(o=0),isNaN(a)&&(a=0),f[r]=["close",o,a];break;default:isNaN(o)&&(o=0),isNaN(a)&&(a=0),f[r]=["unknown",o,a]}else f[r]=["no-points-"+s,o,a]}for(b.units=f,r=0,o=f.length;r<o;r++){let t,[e,...i]=f[r];switch(e){case"linear":case"quadratic":case"bezier":t=yi(e,n,i),p[r]=t.length,x=x.concat(t.xPoints),w=w.concat(t.yPoints),C.push(t.progression),O.push(t.positions);break;default:p[r]=0}}y=p.reduce((t,e)=>t+e,0);let e=0;for(r=0,o=p.length;r<o;r++)e+=p[r]/y,m[r]=parseFloat(e.toFixed(6))}b.unitLengths=p,b.unitPartials=m,b.length=parseFloat(y.toFixed(1)),b.unitPositions=O,b.unitProgression=C;let T=Math.max(...x),H=Math.max(...w),R=Math.min(...x),F=Math.min(...w);return b.maxX=T,b.maxY=H,b.minX=R,b.minY=F,b.xRange=x,b.yRange=w,b}(t,this.currentScale,this.currentStart,this.useAsPath,this.precision),this.pathCalculatedOnce=!0),i){this.localPath=i.localPath,this.length=i.length;let t=i.maxX,s=i.maxY,n=i.minX,r=i.minY,o=this.dimensions,a=this.currentDimensions,h=this.localBox;if(o[0]=parseFloat((t-n).toFixed(1)),o[1]=parseFloat((s-r).toFixed(1)),o[0]===a[0]&&o[1]===a[1]||(a[0]=o[0],a[1]=o[1],this.dirtyHandle=!0),h.length=0,h.push(parseFloat(n.toFixed(1)),parseFloat(r.toFixed(1)),o[0],o[1]),this.useAsPath){const{units:t,unitLengths:e,unitPartials:s,unitProgression:n,unitPositions:r}=i;let o,a,h,c,l,u,d,f,p,m,g=0,y=[],b=[];for(l=0,u=e.length;l<u;l++)if(g+=e[l],h=n[l],h)for(a=s[l],o=s[l+1]-a,c=r[l],d=0,f=h.length;d<f;d++)p=g+h[d],y.push(parseFloat(p.toFixed(1))),m=a+c[d]*o,b.push(parseFloat(m.toFixed(6)));this.units=t,this.unitLengths=e,this.unitPartials=s,this.unitProgression=y,this.unitPositions=b}e||this.calculateLocalPathAdditionalActions()}},t.calculateLocalPathAdditionalActions=T,t.updatePathSubscribers=function(){this.pathed.forEach(t=>{let e=i[t];e&&(e.currentPathData=!1,e.dirtyStart=!0,e.addPathHandle&&(e.dirtyHandle=!0),e.addPathOffset&&(e.dirtyOffset=!0),e.addPathRotation&&(e.dirtyRotation=!0),"Polyline"===e.type?e.dirtyPins=!0:"Line"!==e.type&&"Quadratic"!==e.type&&"Bezier"!==e.type||e.dirtyPins.push(this.name))},this)},t.draw=function(t){t.stroke(this.pathObject),this.showBoundingBox&&this.drawBoundingBox(t)},t.fill=function(t){t.fill(this.pathObject,this.winding),this.showBoundingBox&&this.drawBoundingBox(t)},t.drawAndFill=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding),this.showBoundingBox&&this.drawBoundingBox(t)},t.fillAndDraw=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding),t.stroke(e),this.showBoundingBox&&this.drawBoundingBox(t)},t.drawThenFill=function(t){let e=this.pathObject;t.stroke(e),t.fill(e,this.winding),this.showBoundingBox&&this.drawBoundingBox(t)},t.fillThenDraw=function(t){let e=this.pathObject;t.fill(e,this.winding),t.stroke(e),this.showBoundingBox&&this.drawBoundingBox(t)},t.clear=function(t){let e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fill(this.pathObject,this.winding),t.globalCompositeOperation=e,this.showBoundingBox&&this.drawBoundingBox(t)},t.drawBoundingBox=function(t){t.save(),t.strokeStyle=this.boundingBoxColor,t.lineWidth=1,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.strokeRect(...this.getBoundingBox()),t.restore()},t.getBoundingBox=function(){let t=Math.floor,e=Math.ceil,i=this.minimumBoundingBoxDimensions,[s,n,r,o]=this.localBox,[a,h]=this.currentStampHandlePosition,[c,l]=this.currentStampPosition;return r<i&&(r=i),o<i&&(o=i),[t(s-a),t(n-h),e(r),e(o),c,l]},t}const Si=t=>"string"!=typeof t?"":t.charAt(0).toUpperCase()+t.slice(1);function vi(t={}){t.defs=Y(t.defs,{end:null,endPivot:"",endPivotCorner:"",addEndPivotHandle:!1,addEndPivotOffset:!1,endPath:"",endPathPosition:0,addEndPathHandle:!1,addEndPathOffset:!0,endLockTo:"",useStartAsControlPoint:!1}),t.packetExclusions=N(t.packetExclusions,["controlledLineOffset"]),t.packetExclusionsByRegex=N(t.packetExclusionsByRegex,[]),t.packetCoordinates=N(t.packetCoordinates,["end"]),t.packetObjects=N(t.packetObjects,["endPivot","endPath"]),t.packetFunctions=N(t.packetFunctions,[]),t.factoryKill=function(){Object.entries(i).forEach(([t,e])=>{e.name!==this.name&&(e.startControlPivot&&e.startControlPivot.name===this.name&&e.set({startControlPivot:!1}),e.controlPivot&&e.controlPivot.name===this.name&&e.set({controlPivot:!1}),e.endControlPivot&&e.endControlPivot.name===this.name&&e.set({endControlPivot:!1}),e.endPivot&&e.endPivot.name===this.name&&e.set({endPivot:!1}),e.startControlPath&&e.startControlPath.name===this.name&&e.set({startControlPath:!1}),e.controlPath&&e.controlPath.name===this.name&&e.set({controlPath:!1}),e.endControlPath&&e.endControlPath.name===this.name&&e.set({endControlPath:!1}),e.endPath&&e.endPath.name===this.name&&e.set({endPath:!1}))})};t.getters;let e=t.setters,s=t.deltaSetters;return e.useStartAsControlPoint=function(t){if(this.useStartAsControlPoint=t,!t){let t=this.controlledLineOffset;t[0]=0,t[1]=0}this.updateDirty()},e.endPivot=function(t){this.setControlHelper(t,"endPivot","end"),this.updateDirty(),this.dirtyEnd=!0},e.endPath=function(t){this.setControlHelper(t,"endPath","end"),this.updateDirty(),this.dirtyEnd=!0},e.endPathPosition=function(t){this.endPathPosition=t,this.dirtyEnd=!0,this.currentEndPathData=!1},s.endPathPosition=function(t){this.endPathPosition+=t,this.dirtyEnd=!0,this.currentEndPathData=!1},e.endX=function(t){null!=t&&(this.end[0]=t,this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1)},e.endY=function(t){null!=t&&(this.end[1]=t,this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1)},e.end=function(t,e){this.setCoordinateHelper("end",t,e),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},s.endX=function(t){let e=this.end;e[0]=A(e[0],t),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},s.endY=function(t){let e=this.end;e[1]=A(e[1],t),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},s.end=function(t,e){this.setDeltaCoordinateHelper("end",t,e),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},e.endLockTo=function(t){this.endLockTo=t,this.updateDirty(),this.dirtyEndLock=!0,this.currentEndPathData=!1},t.curveInit=function(t){this.end=Bt(),this.currentEnd=Bt(),this.endLockTo="coord",this.dirtyEnd=!0,this.dirtyPins=[],this.controlledLineOffset=Bt()},t.setControlHelper=function(t,e,s){let n=e.indexOf("Pivot")>0;if(B(t)&&!t)this[e]=null,n?"pivot"===this[s+"LockTo"]&&(this[s+"LockTo"]="start","startControl"===s?this.dirtyStartControlLock=!0:"control"===s?this.dirtyControlLock=!0:"endControl"===s?this.dirtyEndControlLock=!0:this.dirtyEndLock=!0):"path"===this[s+"LockTo"]&&(this[s+"LockTo"]="start","startControl"===s?this.dirtyStartControlLock=!0:"control"===s?this.dirtyControlLock=!0:"endControl"===s?this.dirtyEndControlLock=!0:this.dirtyEndLock=!0);else if(t){let s=this[e],r=t.substring?i[t]:t;r&&r.isArtefact&&(s&&s.isArtefact&&W(n?s.pivoted:s.pathed,this.name),N(n?r.pivoted:r.pathed,this.name),this[e]=r)}},t.buildPathPositionObject=function(t,e){if(t){let i,s,[n,...r]=t;switch(n){case"linear":i=this.positionPointOnPath(this.getLinearXY(e,...r)),s=this.getLinearAngle(e,...r);break;case"quadratic":i=this.positionPointOnPath(this.getQuadraticXY(e,...r)),s=this.getQuadraticAngle(e,...r);break;case"bezier":i=this.positionPointOnPath(this.getBezierXY(e,...r)),s=this.getBezierAngle(e,...r)}let o=0;this.flipReverse&&o++,this.flipUpend&&o++,1===o&&(s=-s),s+=this.roll;this.currentStampPosition;let a=this.controlledLineOffset;this.localBox;return i.x+=a[0],i.y+=a[1],i.angle=s,i}return!1},t.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1),this.dirtyPins.length&&this.preparePinsForStamp(),this.dirtyLock&&this.cleanLock(),this.dirtyStartControlLock&&this.cleanControlLock("startControl"),this.dirtyEndControlLock&&this.cleanControlLock("endControl"),this.dirtyControlLock&&this.cleanControlLock("control"),this.dirtyEndLock&&this.cleanControlLock("end"),(this.dirtyScale||this.dirtySpecies||this.dirtyDimensions||this.dirtyStart||this.dirtyStartControl||this.dirtyEndControl||this.dirtyControl||this.dirtyEnd||this.dirtyHandle)&&(this.dirtyPathObject=!0,this.useStartAsControlPoint&&this.dirtyStart&&(this.dirtySpecies=!0,this.pathCalculatedOnce=!1),(this.dirtyScale||this.dirtySpecies||this.dirtyStartControl||this.dirtyEndControl||this.dirtyControl||this.dirtyEnd)&&(this.pathCalculatedOnce=!1)),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0,this.useStartAsControlPoint&&(this.dirtySpecies=!0,this.dirtyPathObject=!0,this.pathCalculatedOnce=!1)),this.dirtyScale&&this.cleanScale(),this.dirtyStart&&this.cleanStart(),this.dirtyStartControl&&this.cleanControl("startControl"),this.dirtyEndControl&&this.cleanControl("endControl"),this.dirtyControl&&this.cleanControl("control"),this.dirtyEnd&&this.cleanControl("end"),this.dirtyOffset&&this.cleanOffset(),this.dirtyRotation&&this.cleanRotation(),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtySpecies&&this.cleanSpecies(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&(this.updatePositionSubscribers(),this.updateControlPathSubscribers())},t.cleanControlLock=function(t){let e=Si(t);this[`dirty${e}Lock`]=!1,this["dirty"+e]=!0},t.cleanControl=function(t){let e=Si(t);this["dirty"+e]=!1;let s,n,r=t+"Path",o=this[t+"Pivot"],a=this[r];o&&o.substring&&(s=i[o],s&&(o=s)),a&&a.substring&&(s=i[a],s&&(a=s));let h,c,l,u,d,f=this[t+"LockTo"],p=this[t],m=this["current"+e];switch(("pivot"!==f||o&&!o.substring)&&("path"!==f||a&&!a.substring)||(f="coord"),f){case"pivot":this.pivotCorner&&o.getCornerCoordinate?[h,c]=o.getCornerCoordinate(this[t+"PivotCorner"]):[h,c]=o.currentStampPosition,this.addPivotOffset||([l,u]=o.currentOffset,h-=l,c-=u);break;case"path":n=this.getControlPathData(a,t,e),h=n.x,c=n.y,this.addPathOffset||(h-=a.currentOffset[0],c-=a.currentOffset[1]);break;case"mouse":d=this.getHere(),h=d.x||0,c=d.y||0;break;default:h=c=0,d=this.getHere(),q(d)&&V(d.w,d.h)&&(this.cleanPosition(m,p,[d.w,d.h]),[h,c]=m)}m[0]=h,m[1]=c,this.dirtySpecies=!0,this.dirtyPathObject=!0,this.dirtyPositionSubscribers=!0},t.getControlPathData=function(t,e,i){let s=this[`current${i}PathData`];if(s)return s;let n=this[e+"PathPosition"],r=n,o=t.getPathPositionData(n);if(n<0&&(n+=1),n>1&&(n%=1),n=parseFloat(n.toFixed(6)),n!==r&&(this[e+"PathPosition"]=n),o)return this[`current${i}PathData`]=o,o;{let t=this.getHere();if(q(t)&&V(t.w,t.h)){let s=this["current"+i];return this.cleanPosition(s,this[e],[t.w,t.h]),{x:s[0],y:s[1]}}return{x:0,y:0}}},t.updateControlPathSubscribers=function(){[].concat(this.endSubscriber,this.endControlSubscriber,this.controlSubscriber,this.startControlSubscriber).forEach(t=>{let e=i[t];e&&("Line"!==e.type&&"Quadratic"!==e.type&&"Bezier"!==e.type||("Quadratic"===e.type?(e.dirtyControl=!0,e.currentControlPathData=!1):"Bezier"===e.type&&(e.dirtyStartControl=!0,e.dirtyEndControl=!0,e.currentStartControlPathData=!1,e.currentEndControlPathData=!1),e.currentEndPathData=!1,e.dirtyEnd=!0),e.currentPathData=!1,e.dirtyStart=!0)})},t}const Bezier=function(t={}){return this.startControl=Bt(),this.endControl=Bt(),this.currentStartControl=Bt(),this.currentEndControl=Bt(),this.startControlLockTo="coord",this.endControlLockTo="coord",this.curveInit(t),this.shapeInit(t),this.dirtyStartControl=!0,this.dirtyEndControl=!0,this};let ki=Bezier.prototype=Object.create(Object.prototype);ki.type="Bezier",ki.lib="entity",ki.isArtefact=!0,ki.isAsset=!1,ki=nt(ki),ki=Pi(ki),ki=vi(ki);ki.defs=Y(ki.defs,{startControl:null,startControlPivot:"",startControlPivotCorner:"",addStartControlPivotHandle:!1,addStartControlPivotOffset:!1,startControlPath:"",startControlPathPosition:0,addStartControlPathHandle:!1,addStartControlPathOffset:!0,endControl:null,endControlPivot:"",endControlPivotCorner:"",addEndControlPivotHandle:!1,addEndControlPivotOffset:!1,endControlPath:"",endControlPathPosition:0,addEndControlPathHandle:!1,addEndControlPathOffset:!0,startControlLockTo:"",endControlLockTo:""}),ki.packetExclusions=N(ki.packetExclusions,[]),ki.packetExclusionsByRegex=N(ki.packetExclusionsByRegex,[]),ki.packetCoordinates=N(ki.packetCoordinates,["startControl","endControl"]),ki.packetObjects=N(ki.packetObjects,["startControlPivot","startControlPath","endControlPivot","endControlPath"]),ki.packetFunctions=N(ki.packetFunctions,[]);ki.getters;let xi=ki.setters,wi=ki.deltaSetters;xi.endControlPivot=function(t){this.setControlHelper(t,"endControlPivot","endControl"),this.updateDirty(),this.dirtyEndControl=!0},xi.endControlPath=function(t){this.setControlHelper(t,"endControlPath","endControl"),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},xi.endControlPathPosition=function(t){this.endControlPathPosition=t,this.dirtyEndControl=!0,this.currentEndControlPathData=!1},wi.endControlPathPosition=function(t){this.endControlPathPosition+=t,this.dirtyEndControl=!0,this.currentEndControlPathData=!1},xi.startControlPivot=function(t){this.setControlHelper(t,"startControlPivot","startControl"),this.updateDirty(),this.dirtyStartControl=!0},xi.startControlPath=function(t){this.setControlHelper(t,"startControlPath","startControl"),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},xi.startControlPathPosition=function(t){this.startControlPathPosition=t,this.dirtyStartControl=!0,this.currentStartControlPathData=!1},wi.startControlPathPosition=function(t){this.startControlPathPosition+=t,this.dirtyStartControl=!0,this.currentStartControlPathData=!1},xi.startControlX=function(t){null!=t&&(this.startControl[0]=t,this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1)},xi.startControlY=function(t){null!=t&&(this.startControl[1]=t,this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1)},xi.startControl=function(t,e){this.setCoordinateHelper("startControl",t,e),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},wi.startControlX=function(t){let e=this.startControl;e[0]=A(e[0],t),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},wi.startControlY=function(t){let e=this.startControl;e[1]=A(e[1],t),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},wi.startControl=function(t,e){this.setDeltaCoordinateHelper("startControl",t,e),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},xi.endControlX=function(t){null!=t&&(this.endControl[0]=t,this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1)},xi.endControlY=function(t){null!=t&&(this.endControl[1]=t,this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1)},xi.endControl=function(t,e){this.setCoordinateHelper("endControl",t,e),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},wi.endControlX=function(t){let e=this.endControl;e[0]=A(e[0],t),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},wi.endControlY=function(t){let e=this.endControl;e[1]=A(e[1],t),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},wi.endControl=function(t,e){this.setDeltaCoordinateHelper("endControl",t,e),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},xi.startControlLockTo=function(t){this.startControlLockTo=t,this.updateDirty(),this.dirtyStartControlLock=!0},xi.endControlLockTo=function(t){this.endControlLockTo=t,this.updateDirty(),this.dirtyEndControlLock=!0,this.currentEndControlPathData=!1},ki.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeBezierPath(),this.pathDefinition=t},ki.makeBezierPath=function(){let[t,e]=this.currentStampPosition,[i,s]=this.currentStartControl,[n,r]=this.currentEndControl,[o,a]=this.currentEnd;return`m0,0c${(i-t).toFixed(2)},${(s-e).toFixed(2)} ${(n-t).toFixed(2)},${(r-e).toFixed(2)} ${(o-t).toFixed(2)},${(a-e).toFixed(2)}`},ki.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyHandle=!0,this.dirtyOffset=!0,this.dirtyStart=!0,this.dirtyStartControl=!0,this.dirtyEndControl=!0,this.dirtyEnd=!0},ki.preparePinsForStamp=function(){let t=this.endPivot,e=this.endPath,i=this.startControlPivot,s=this.startControlPath,n=this.endControlPivot,r=this.endControlPath;this.dirtyPins.forEach(o=>{(i&&i.name===o||s&&s.name===o)&&(this.dirtyStartControl=!0,this.startControlLockTo.includes("path")&&(this.currentStartControlPathData=!1)),(n&&n.name===o||r&&r.name===o)&&(this.dirtyEndControl=!0,this.endControlLockTo.includes("path")&&(this.currentEndControlPathData=!1)),(t&&t.name===o||e&&e.name===o)&&(this.dirtyEnd=!0,this.endLockTo.includes("path")&&(this.currentEndPathData=!1))}),this.dirtyPins.length=0};g.Bezier=Bezier;const Color=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),q(t.color)&&this.convert(t.color),t.random&&this.generateRandomColor(t),this.checkValues(),this};let Ci=Color.prototype=Object.create(Object.prototype);Ci.type="Color",Ci.lib="styles",Ci.isArtefact=!1,Ci.isAsset=!1,Ci=nt(Ci);Ci.defs=Y(Ci.defs,{r:0,g:0,b:0,a:1,rMax:255,gMax:255,bMax:255,aMax:1,rMin:0,gMin:0,bMin:0,aMin:0,rShift:0,gShift:0,bShift:0,aShift:0,rBounce:!1,gBounce:!1,bBounce:!1,aBounce:!1,opaque:!0,autoUpdate:!1}),Ci.kill=function(){let t=this.name;return Object.entries(c).forEach(([e,i])=>{let s=i.state;if(s){let e=s.fillStyle,i=s.strokeStyle;I(e)&&e.name===t&&(s.fillStyle=s.defs.fillStyle),I(i)&&i.name===t&&(s.strokeStyle=s.defs.strokeStyle)}}),this.deregister(),this},Ci.get=function(t){if(q(t)){if("random"===t)return this.generateRandomColor(),this.get();{let e=this.getters[t];if(e)return e.call(this);{let e=this.defs[t];if(void 0!==e){let i=this[t];return void 0!==i?i:e}return undef}}}return this.opaque?`rgb(${this.r||0}, ${this.g||0}, ${this.b||0})`:`rgba(${this.r||0}, ${this.g||0}, ${this.b||0}, ${this.a||1})`},Ci.set=function(t={}){if(t){let e=this.setters,i=this.defs;Object.entries(t).forEach(([t,s])=>{if("name"!==t){let n=e[t];n?n.call(this,s):void 0!==i[t]&&(this[t]=s)}},this)}return t.random?this.generateRandomColor(t):t.color?this.convert(t.color):this.checkValues(),this},Ci.getData=function(){return this.autoUpdate&&this.update(),this.checkValues(),this.get()},Ci.generateRandomColor=function(t={}){let e=Math.round,i=Math.random,s=this.rMax=G(t.rMax,this.rMax,255),n=this.gMax=G(t.gMax,this.gMax,255),r=this.bMax=G(t.bMax,this.bMax,255),o=this.rMin=G(t.rMin,this.rMin,0),a=this.gMin=G(t.gMin,this.gMin,0),h=this.bMin=G(t.bMin,this.bMin,0);return this.r=t.r||e(i()*(s-o)+o),this.g=t.g||e(i()*(n-a)+a),this.b=t.b||e(i()*(r-h)+h),this.opaque||(aMax=this.aMax=G(t.aMax,this.aMax,1),aMin=this.aMin=G(t.aMin,this.aMin,0),this.a=t.a||i()*(aMax-aMin)+aMin),this.checkValues(),this},Ci.checkValues=function(){let t=Math.floor,e=t(this.r)||0,i=t(this.g)||0,s=t(this.b)||0,n=this.a||1;return this.r=e>255?255:e<0?0:e,this.g=i>255?255:i<0?0:i,this.b=s>255?255:s<0?0:s,this.a=n>1?1:n<0?0:n,this},Ci.updateArray=["r","g","b","a"],Ci.update=function(){q(this.rCurrent)||(this.rCurrent=this.r),q(this.gCurrent)||(this.gCurrent=this.g),q(this.bCurrent)||(this.bCurrent=this.b),q(this.aCurrent)||(this.aCurrent=this.a);let t=this.updateArray;return(this.rShift||this.gShift||this.bShift||this.aShift)&&t.forEach(t=>{let e=this[t+"Shift"];if(e){this[t+"Current"]+=e;let i=this[t],s=this[t+"Min"],n=this[t+"Max"],r=this[t+"Bounce"],o=this[t+"Current"],a=Math.floor(o+e);(a>n||a<s)&&(r?e=-e:(i=i>(n+s)/2?n:s,e=0)),this[t]=a,this[t+"Shift"]=e}},this),this},Ci.updateByDelta=Ci.update,Ci.convert=function(t){let e,i,s,n,r,o=this.toDecimal,a=Math.round;return(t=t.substring?t:"").length&&(t.toLowerCase(),e=0,i=0,s=0,n=1,"#"===t[0]?t.length<5?(e=o(t[1]+t[1]),i=o(t[2]+t[2]),s=o(t[3]+t[3])):t.length<8&&(e=o(t[1]+t[2]),i=o(t[3]+t[4]),s=o(t[5]+t[6])):/rgb\(/.test(t)?(r=t.match(/([0-9.]+\b)/g),/%/.test(t)?(e=a(r[0]/100*255),i=a(r[1]/100*255),s=a(r[2]/100*255)):(e=a(r[0]),i=a(r[1]),s=a(r[2]))):/rgba\(/.test(t)?(r=t.match(/([0-9.]+\b)/g),/%/.test(t)?(e=a(r[0]/100*255),i=a(r[1]/100*255),s=a(r[2]/100*255),n=a(r[3]/100)):(e=a(r[0]),i=a(r[1]),s=a(r[2]),n=a(r[3]))):/hsl\(/.test(t)||/hsla\(/.test(t)||"transparent"===t?e=i=s=n=0:(r=this.colorLibrary[t],r&&(e=parseInt(r[0]+r[1],16),i=parseInt(r[2]+r[3],16),s=parseInt(r[4]+r[5],16),n=1)),this.r=e,this.g=i,this.b=s,this.a=n,this.checkValues()),this},Ci.colorLibrary={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffe4c4",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};const Oi=function(t){return new Color(t)};g.Color=Color;const Palette=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.colors=t.colors||{"0 ":[0,0,0,1],"999 ":[255,255,255,1]},this.stops=Array(1e3),this.set(t),this.dirtyPalette=!0,this};let Di=Palette.prototype=Object.create(Object.prototype);Di.type="Palette",Di.lib="palette",Di.isArtefact=!1,Di.isAsset=!1,Di=nt(Di);Di.defs=Y(Di.defs,{colors:null,stops:null,cyclic:!1}),Di.packetExclusions=N(Di.packetExclusions,["stops"]);Di.getters;let Ai=Di.setters;Ai.colors=function(t){if(I(t)){let e=this.factory;Object.entries(t).forEach(([i,s])=>{s.substring&&(e.convert(s),t[i]=[e.r,e.g,e.b,e.a])}),this.colors=t,this.dirtyPalette=!0}},Ai.stops=T,Di.recalculateHold=[],Di.recalculate=function(){let t,e,i,s,n,r,o,a,h,c,l,u,d,f,p,m=this.colors,g=this.stops,y=this.makeColorString,b=this.recalculateHold;for(t=Object.keys(m),t=t.map(t=>parseInt(t,10)),t.sort((t,e)=>t-e),g.fill("rgba(0,0,0,0)"),this.dirtyPalette=!1,e=0,i=t.length-1;e<i;e++)for(r=t[e],c=t[e+1],o=c-r,a=m[r+" "],h=m[c+" "],u=(h[0]-a[0])/o,d=(h[1]-a[1])/o,f=(h[2]-a[2])/o,p=(h[3]-a[3])/o,s=0,n=o;s<n;s++)b[0]=a[0]+u*s,b[1]=a[1]+d*s,b[2]=a[2]+f*s,b[3]=a[3]+p*s,g[r]=y(b),r++;if(g[r]=y(h),this.cyclic)for(r=t[t.length-1],c=t[0],o=c+1e3-r,a=m[r+" "],h=m[c+" "],u=(h[0]-a[0])/o,d=(h[1]-a[1])/o,f=(h[2]-a[2])/o,p=(h[3]-a[3])/o,s=0,n=o;s<n;s++)b[0]=a[0]+u*s,b[1]=a[1]+d*s,b[2]=a[2]+f*s,b[3]=a[3]+p*s,g[r]=y(b),r++,r>999&&(r-=1e3);else{if(r=t[0],r>0)for(l=g[r],e=0,i=r;e<i;e++)g[e]=l;if(r=t[t.length-1],r<999)for(l=g[r],e=r,i=1e3;e<i;e++)g[e]=l}},Di.makeColorString=function(t){let e,i,s,n,r=Math.floor,o=(t,e,i)=>t=(t=t<e?e:t)>i?i:t;return e=o(r(t[0]),0,255),i=o(r(t[1]),0,255),s=o(r(t[2]),0,255),n=o(t[3],0,1),`rgba(${e},${i},${s},${n})`},Di.updateColor=function(t,e){let i=this.factory;V(t,e)&&(t=t.substring?parseInt(t,10):Math.floor(t))>=0&&t<=999&&(i.convert(e),t+=" ",this.colors[t]=[i.r,i.g,i.b,i.a],this.dirtyPalette=!0)},Di.removeColor=function(t){q(t)&&(t=t.substring?parseInt(t,10):Math.floor(t))>=0&&t<=999&&(t+=" ",delete this.colors[t],this.dirtyPalette=!0)},Di.addStopsToGradient=function(t,e,i,s){let n,r,o,a,h,c,l=this.stops,u=Object.keys(this.colors);if(t){if(u=u.map(t=>parseInt(t,10)),u.sort((t,e)=>t-e),V(e,i)||(e=0,i=999),e===i)return l[e]||"rgba(0,0,0,0)";if(e<i)for(t.addColorStop(0,l[e]),t.addColorStop(1,l[i]),n=i-e,o=0,a=u.length;o<a;o++)h=u[o],h>e&&h<i&&(r=(h-e)/n,r>0&&r<1&&t.addColorStop(r,l[h]));else if(s)for(t.addColorStop(0,l[e]),t.addColorStop(1,l[i]),c=999-e,n=c+i,o=0,a=u.length;o<a;o++){if(h=u[o],h>e)r=(h-e)/n;else{if(!(h<i))continue;r=(h+c)/n}r>0&&r<1&&t.addColorStop(r,l[h])}else for(t.addColorStop(0,l[e]),t.addColorStop(1,l[i]),n=e-i,o=0,a=u.length;o<a;o++)h=u[o],h<e&&h>i&&(r=1-(h-i)/n,r>0&&r<1&&t.addColorStop(r,l[h]));return t}return"rgba(0,0,0,0)"},Di.factory=Oi({name:"palette-factory-color-calculator",opaque:!1});function Ei(t={}){t.defs=Y(t.defs,{start:null,end:null,palette:null,paletteStart:0,paletteEnd:999,cyclePalette:!1}),t.finalizePacketOut=function(t,e){return e.colors?t.colors=e.colors:this.palette&&this.palette.colors?t.colors=this.palette.colors:t.colors={"0 ":[0,0,0,1],"999 ":[255,255,255,1]},t},t.kill=function(){let t=this.name;return this.palette&&this.palette.kill&&this.palette.kill(),Object.entries(c).forEach(([e,i])=>{let s=i.state;if(s){let e=s.fillStyle,i=s.strokeStyle;I(e)&&e.name===t&&(s.fillStyle=s.defs.fillStyle),I(i)&&i.name===t&&(s.strokeStyle=s.defs.strokeStyle)}}),this.deregister(),this};let e=t.getters,i=t.setters,s=t.deltaSetters;return e.startX=function(){return this.currentStart[0]},e.startY=function(){return this.currentStart[1]},i.startX=function(t){null!=t&&(this.start[0]=t,this.dirtyStart=!0)},i.startY=function(t){null!=t&&(this.start[1]=t,this.dirtyStart=!0)},i.start=function(t,e){this.setCoordinateHelper("start",t,e),this.dirtyStart=!0},s.startX=function(t){let e=this.start;e[0]=A(e[0],t),this.dirtyStart=!0},s.startY=function(t){let e=this.start;e[1]=A(e[1],t),this.dirtyStart=!0},s.start=function(t,e){this.setDeltaCoordinateHelper("start",t,e),this.dirtyStart=!0},e.endX=function(){return this.currentEnd[0]},e.endY=function(){return this.currentEnd[1]},i.endX=function(t){null!=t&&(this.end[0]=t,this.dirtyEnd=!0)},i.endY=function(t){null!=t&&(this.end[1]=t,this.dirtyEnd=!0)},i.end=function(t,e){this.setCoordinateHelper("end",t,e),this.dirtyEnd=!0},s.endX=function(t){let e=this.end;e[0]=A(e[0],t),this.dirtyEnd=!0},s.endY=function(t){let e=this.end;e[1]=A(e[1],t),this.dirtyEnd=!0},s.end=function(t,e){this.setDeltaCoordinateHelper("end",t,e),this.dirtyEnd=!0},i.palette=function(t={}){"Palette"===t.type&&(this.palette=t)},i.paletteStart=function(t){t.toFixed&&(this.paletteStart=t,(t<0||t>999)&&(this.paletteStart=t>500?999:0))},s.paletteStart=function(t){let e;t.toFixed&&(e=this.paletteStart+t,(e<0||e>999)&&(e=this.cyclePalette?e>500?e-1e3:e+1e3:t>500?999:0),this.paletteStart=e)},i.paletteEnd=function(t){t.toFixed&&(this.paletteEnd=t,(t<0||t>999)&&(this.paletteEnd=t>500?999:0))},s.paletteEnd=function(t){let e;t.toFixed&&(e=this.paletteEnd+t,(e<0||e>999)&&(e=this.cyclePalette?e>500?e-1e3:e+1e3:t>500?999:0),this.paletteEnd=e)},i.colors=function(t){let e=this.palette;e&&e.colors&&e.set({colors:t})},i.delta=function(t={}){t&&(this.delta=$(this.delta,t))},t.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.palette;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},t.set=function(t={}){if(t){let e=this.setters,i=this.defs,s=this.palette,n=s?s.setters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],h=!1;a||(a=n[t],h=!0),a?a.call(h?this.palette:this,o):void 0!==i[t]?this[t]=o:void 0!==r[t]&&(s[t]=o)}},this)}return this},t.setDelta=function(t={}){if(t){let e=this.deltaSetters,i=this.defs,s=this.palette,n=s?s.deltaSetters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],h=!1;a||(a=n[t],h=!0),a?a.call(h?this.palette:this,o):void 0!==i[t]?this[t]=A(this[t],o):void 0!==r[t]&&(s[t]=A(this[t],o))}},this)}return this},t.setCoordinateHelper=function(t,e,i){let s=this[t];Array.isArray(e)?(s[0]=e[0],s[1]=e[1]):(s[0]=e,s[1]=i)},t.setDeltaCoordinateHelper=function(t,e,i){let s=this[t],n=s[0],r=s[1];Array.isArray(e)?(s[0]=A(n,e[0]),s[1]=A(r,e[1])):(s[0]=A(n,e),s[1]=A(r,i))},t.updateByDelta=function(){return this.setDelta(this.delta),this},t.stylesInit=function(t={}){this.makeName(t.name),this.register(),this.gradientArgs=[],this.start=Bt(),this.end=Bt(),this.currentStart=Bt(),this.currentEnd=Bt(),this.palette=function(t){return new Palette(t)}({name:this.name+"_palette"}),this.delta={},this.set(this.defs),this.set(t)},t.getData=function(t,e){return this.palette&&this.palette.dirtyPalette&&this.palette.recalculate(),this.cleanStyle(t,e),this.finalizeCoordinates(t),this.buildStyle(e)},t.cleanStyle=function(t={},e={}){let i,s,n,r;t.lockFillStyleToEntity||t.lockStrokeStyleToEntity?(i=t.currentDimensions,r=t.currentScale,s=i[0]*r,n=i[1]*r):(i=e.currentDimensions,s=i[0],n=i[1]),this.cleanPosition(this.currentStart,this.start,[s,n]),this.cleanPosition(this.currentEnd,this.end,[s,n]),this.cleanRadius(s)},t.cleanPosition=function(t,e,i){let s,n;for(let r=0;r<2;r++)s=e[r],n=i[r],s.toFixed?t[r]=s:t[r]="left"===s||"top"===s?0:"right"===s||"bottom"===s?n:"center"===s?n/2:parseFloat(s)/100*n},t.finalizeCoordinates=function(t={}){this.currentStart,this.currentEnd;let e,i,s=t.currentStampPosition,n=t.currentStampHandlePosition,r=t.currentScale;t.lockFillStyleToEntity||t.lockStrokeStyleToEntity?(e=-n[0]*r||0,i=-n[1]*r||0):(e=-s[0]||0,i=-s[1]||0),this.updateGradientArgs(e,i)},t.cleanRadius=T,t.buildStyle=function(t){return"rgba(0,0,0,0)"},t.addStopsToGradient=function(t,e,i,s){return this.palette?this.palette.addStopsToGradient(t,e,i,s):t},t.updateColor=function(t,e){return this.palette&&this.palette.updateColor(t,e),this},t.removeColor=function(t){return this.palette&&this.palette.removeColor(t),this},t}g.Palette=Palette;const Gradient=function(t={}){return this.stylesInit(t),this};let Ti=Gradient.prototype=Object.create(Object.prototype);Ti.type="Gradient",Ti.lib="styles",Ti.isArtefact=!1,Ti.isAsset=!1,Ti=nt(Ti),Ti=Ei(Ti),Ti.packetObjects=N(Ti.packetObjects,["palette"]),Ti.buildStyle=function(t={}){if(t){let e=t.engine;if(e){let t=e.createLinearGradient(...this.gradientArgs);return this.addStopsToGradient(t,this.paletteStart,this.paletteEnd,this.cyclePalette)}}return"rgba(0,0,0,0)"},Ti.updateGradientArgs=function(t,e){let i=this.gradientArgs,s=this.currentStart,n=this.currentEnd,r=s[0]+t,o=s[1]+e,a=n[0]+t,h=n[1]+e;r===a&&o===h&&a++,i.length=0,i.push(r,o,a,h)};g.Gradient=Gradient;const Grid=function(t={}){return this.tileFill=[],this.tileSources=[],this.entityInit(t),t.tileSources||(this.tileSources=[].concat([{type:"color",source:"#000000"},{type:"color",source:"#ffffff"}])),t.tileFill?Array.isArray(t.tileFill)&&this.tileFill.length===t.tileFill.length&&(this.tileFill=t.tileFill):(this.tileFill.length=this.columns*this.rows,this.tileFill.fill(0)),this.tilePaths=[],this.tileRealCoordinates=[],this.tileVirtualCoordinates=[],t.dimensions||(t.width||(this.currentDimensions[0]=this.dimensions[0]=20),t.height||(this.currentDimensions[1]=this.dimensions[1]=20)),this};let Hi=Grid.prototype=Object.create(Object.prototype);Hi.type="Grid",Hi.lib="entity",Hi.isArtefact=!0,Hi.isAsset=!1,Hi=nt(Hi),Hi=di(Hi);Hi.defs=Y(Hi.defs,{columns:2,rows:2,columnGutterWidth:1,rowGutterWidth:1,tileSources:null,tileFill:null,gutterColor:"#808080"}),Hi.packetExclusions=N(Hi.packetExclusions,["tileSources"]),Hi.finalizePacketOut=function(t,e){let i=t.tileSources=[];this.tileSources.forEach(t=>{i.push({type:t.type,source:I(t.source)?t.source.name:t.source})}),I(t.gutterColor)&&(t.gutterColor=t.gutterColor.name);let s=JSON.parse(this.state.saveAsPacket(e))[3];return t=Y(t,s),t=this.handlePacketAnchor(t,e)};Hi.getters;let Ri=Hi.setters,Fi=Hi.deltaSetters;Ri.columns=function(t){if(z(t)&&(Number.isInteger(t)||(t=parseInt(t,10)),t!==this.columns)){let e,i,s,n=this.tileFill,r=this.columns,o=[];for(this.columns=t,e=0,i=this.rows;e<i;e++)for(s=0;s<t;s++)s<r?o.push(n[e*r+s]):o.push(0);this.tileFill=o}this.dirtyPathObject=!0},Fi.columns=T,Ri.rows=function(t){if(z(t)&&(Number.isInteger(t)||(t=parseInt(t,10)),t!==this.rows)){let e=this.rows;this.rows=t,this.tileFill.length=this.columns*t,e<t&&this.tileFill.fill(0,e*this.columns)}this.dirtyPathObject=!0},Fi.rows=T,Hi.setAllTilesTo=function(t){z(t)&&(Number.isInteger(t)||(t=parseInt(t,10)),this.tileFill.fill(t))},Hi.setTilesTo=function(t,e){let i=this.tileFill;q(t)&&z(e)&&(Number.isInteger(e)||(e=parseInt(e,10)),z(t)?i[t]=e:Array.isArray(t)&&t.forEach(t=>{z(t)&&(i[t]=e)}))},Hi.setTileSourceTo=function(t,e){z(t)&&I(e)&&e.type&&e.source&&(this.tileSources[t]=e)},Hi.removeTileSource=function(t){z(t)&&t&&(this.tileSources[t]=null,this.tileFill=this.tileFill.map(e=>e===t?0:e))},Hi.getTileSource=function(t,e){if(z(t))return z(e)?this.tileFill[t*this.rows+e]:this.tileFill[t]},Hi.getTilesUsingSource=function(t){z(t)&&this.tileFill.map(e=>e===t?1:0)},Hi.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=new Path2D,i=new Path2D,s=this.currentStampHandlePosition,n=this.currentScale,r=this.currentDimensions,o=-s[0]*n,a=-s[1]*n,h=r[0]*n,c=r[1]*n;t.rect(o,a,h,c);let l,u,d,f,p=this.columns,m=this.rows,g=h/p,y=c/m,b=this.tilePaths,P=this.tileRealCoordinates,S=this.tileVirtualCoordinates;for(e.moveTo(o,a),e.lineTo(o+h,a),l=1;l<=m;l++){let t=a+l*y;e.moveTo(o,t),e.lineTo(o+h,t)}for(this.rowLines=e,i.moveTo(o,a),i.lineTo(o,a+c),u=1;u<=p;u++){let t=o+u*g;i.moveTo(t,a),i.lineTo(t,a+c)}for(this.columnLines=i,b.length=0,P.length=0,S.length=0,l=0;l<m;l++)for(u=0;u<p;u++){let t=new Path2D;d=u*g,f=l*y,t.rect(o+d,a+f,g,y),b.push(t),S.push([d,f]),P.push([o+d,a+f])}this.currentTileWidth=g,this.currentTileHeight=y}},Hi.performFill=function(t){t.save();let e,i=ne(),s=i.engine,n=i.element,r=this.tileSources,o=this.tileFill,a=this.tilePaths,h=this.tileRealCoordinates,l=this.tileVirtualCoordinates,u=this.winding,d=this.currentTileWidth,f=this.currentTileHeight,p=this.scale,m=this.currentDimensions;r.forEach((r,g)=>{if(r&&r.type)switch(r.type){case"color":t.fillStyle=r.source;break;case"cellGradient":this.lockFillStyleToEntity=!1,t.fillStyle=r.source.getData(this,this.currentHost);break;case"gridGradient":this.lockFillStyleToEntity=!0,t.fillStyle=r.source.getData(this,this.currentHost)}let y=o.map(t=>t===g);if(y.length)switch(r.type){case"gridPicture":e=r.source.substring?c[r.source]:r.source,e.simpleStamp&&(n.width=m[0]*p,n.height=m[1]*p,s.globalCompositeOperation="source-over",s.fillStyle="#000000",y.forEach((t,e)=>{t&&s.fillRect(l[e][0],l[e][1],d,f)}),s.globalCompositeOperation="source-in",e.simpleStamp(i,{startX:0,startY:0,width:m[0]*p,height:m[1]*p,method:"fill"}),t.drawImage(n,h[0][0],h[0][1]));break;case"tilePicture":e=r.source.substring?c[r.source]:r.source,e.simpleStamp&&(n.width=d,n.height=f,s.globalCompositeOperation="source-over",e.simpleStamp(i,{startX:0,startY:0,width:d,height:f,method:"fill"}),y.forEach((e,i)=>e&&t.drawImage(n,h[i][0],h[i][1])));break;default:y.forEach((e,i)=>e&&t.fill(a[i],u))}});let g,y=this.gutterColor,b=this.rowGutterWidth,P=this.columnGutterWidth;if(q(y)){switch(y.substring?g={type:"color",source:this.gutterColor}:I(y)?g=y:z(y)&&I(r[y])&&(g=r[y]),g.type){case"cellGradient":this.lockFillStyleToEntity=!1,t.strokeStyle=g.source.getData(this,this.currentHost);break;case"gridGradient":this.lockFillStyleToEntity=!0,t.strokeStyle=g.source.getData(this,this.currentHost);break;case"color":t.strokeStyle=g.source}switch(g.type){case"gridPicture":case"tilePicture":if((b||P)&&(e=g.source.substring?c[g.source]:g.source,e.simpleStamp)){let r=this.currentStampHandlePosition,o=this.currentScale,a=r[0]*o,c=r[1]*o;n.width=m[0]*o,n.height=m[1]*o,s.globalCompositeOperation="source-over",s.strokeStyle="#000000",s.translate(a,c),b&&(s.lineWidth=b,s.stroke(this.rowLines)),P&&(s.lineWidth=P,s.stroke(this.columnLines)),s.globalCompositeOperation="source-in",e.simpleStamp(i,{startX:0,startY:0,width:m[0]*o,height:m[1]*o,method:"fill"}),t.drawImage(n,h[0][0],h[0][1]),s.translate(0,0)}break;default:b&&(t.lineWidth=b,t.stroke(this.rowLines)),P&&(t.lineWidth=P,t.stroke(this.columnLines))}}re(i),t.restore()},Hi.fill=function(t){this.performFill(t)},Hi.drawAndFill=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),this.performFill(t)},Hi.fillAndDraw=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),this.performFill(t),t.stroke(e)},Hi.drawThenFill=function(t){let e=this.pathObject;t.stroke(e),this.performFill(t)},Hi.fillThenDraw=function(t){let e=this.pathObject;this.performFill(t),t.stroke(e)},Hi.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let i=Array.isArray(t)?t:[t],s=!1;e||(e=ne(),s=!0);let n,r,o,a=e.engine,h=this.currentStampPosition,c=h[0],l=h[1],u=new Set,d=this.tilePaths;const f=t=>{let e,i;if(Array.isArray(t))e=t[0],i=t[1];else{if(!V(t,t.x,t.y))return[!1];e=t.x,i=t.y}return!e.toFixed||!i.toFixed||isNaN(e)||isNaN(i)?[!1]:[!0,e,i]};return e.rotateDestination(a,c,l,this),i.some(t=>([n,r,o]=f(t),!!n&&a.isPointInPath(this.pathObject,r,o,this.winding)),this)?(i.forEach(t=>{[n,r,o]=f(t),n&&d.some((t,e)=>!!a.isPointInPath(t,r,o,this.winding)&&(u.add(e),!0))}),s&&re(e),{x:r,y:o,tiles:[...u],artefact:this}):(s&&re(e),!1)};g.Grid=Grid;const Line=function(t={}){return this.curveInit(t),this.shapeInit(t),this};let Bi=Line.prototype=Object.create(Object.prototype);Bi.type="Line",Bi.lib="entity",Bi.isArtefact=!0,Bi.isAsset=!1,Bi=nt(Bi),Bi=Pi(Bi),Bi=vi(Bi),Bi.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeLinePath(),this.pathDefinition=t},Bi.makeLinePath=function(){let[t,e]=this.currentStampPosition,[i,s]=this.currentEnd;return`m0,0l${(i-t).toFixed(2)},${(s-e).toFixed(2)}`},Bi.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyHandle=!0,this.dirtyOffset=!0,this.dirtyStart=!0,this.dirtyEnd=!0},Bi.preparePinsForStamp=function(){let t=this.endPivot,e=this.endPath;this.dirtyPins.forEach(i=>{(t&&t.name===i||e&&e.name===i)&&(this.dirtyEnd=!0,this.endLockTo.includes("path")&&(this.currentEndPathData=!1))}),this.dirtyPins.length=0};g.Line=Line;const Loom=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.state=Ht(),t.group||(t.group=$e),this.onEnter=T,this.onLeave=T,this.onDown=T,this.onUp=T,this.delta={},this.set(t),this.fromPathData=[],this.toPathData=[],this.watchFromPath=null,this.watchIndex=-1,this.engineInstructions=[],this.engineDeltaLengths=[],this};let ji=Loom.prototype=Object.create(Object.prototype);ji.type="Loom",ji.lib="entity",ji.isArtefact=!0,ji.isAsset=!1,ji=nt(ji),ji=Qt(ji);ji.defs=Y(ji.defs,{fromPath:null,toPath:null,fromPathStart:0,fromPathEnd:1,toPathStart:0,toPathEnd:1,synchronizePathCursors:!0,loopPathCursors:!0,constantPathSpeed:!0,isHorizontalCopy:!0,showBoundingBox:!1,boundingBoxColor:"#000000",source:null,sourceIsVideoOrSprite:!1,interferenceLoops:2,interferenceFactor:1.03,visibility:!0,order:0,delta:null,host:null,group:null,anchor:null,noCanvasEngineUpdates:!1,noDeltaUpdates:!1,onEnter:null,onLeave:null,onDown:null,onUp:null,noUserInteraction:!1,method:"fill"}),ji.packetExclusions=N(ji.packetExclusions,["pathObject","state"]),ji.packetExclusionsByRegex=N(ji.packetExclusionsByRegex,["^(local|dirty|current)","Subscriber$"]),ji.packetCoordinates=N(ji.packetCoordinates,[]),ji.packetObjects=N(ji.packetObjects,["group","fromPath","toPath","source"]),ji.packetFunctions=N(ji.packetFunctions,["onEnter","onLeave","onDown","onUp"]),ji.processPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},ji.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=Y(t,i),t=this.handlePacketAnchor(t,e)},ji.handlePacketAnchor=function(t,e){if(this.anchor){let i=JSON.parse(this.anchor.saveAsPacket(e))[3];t.anchor=i}return t},ji.clone=H;let Li=ji.getters,Mi=ji.setters,zi=ji.deltaSetters;ji.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},ji.set=function(t={}){if(t){let e=this.setters,i=this.defs,s=this.state,n=s?s.setters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],h=!1;a||(a=n[t],h=!0),a?a.call(h?this.state:this,o):void 0!==i[t]?this[t]=o:void 0!==r[t]&&(s[t]=o)}},this)}return this},ji.setDelta=function(t={}){if(t){let e=this.deltaSetters,i=this.defs,s=this.state,n=s?s.deltaSetters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],h=!1;a||(a=n[t],h=!0),a?a.call(h?this.state:this,o):void 0!==i[t]?this[t]=addStrings(this[t],o):void 0!==r[t]&&(s[t]=addStrings(s[t],o))}},this)}return this},Mi.host=function(t){if(t){let e=i[t];e&&e.here?this.host=e.name:this.host=t}else this.host=""},Li.group=function(){return this.group?this.group.name:""},Mi.group=function(t){let e;t&&(this.group&&"Group"===this.group.type&&this.group.removeArtefacts(this.name),t.substring?(e=group[t],this.group=e||t):this.group=t),this.group&&"Group"===this.group.type&&this.group.addArtefacts(this.name)},ji.getHere=function(){return currentCorePosition},Mi.delta=function(t={}){t&&(this.delta=$(this.delta,t))},Mi.fromPath=function(t){if(t){let e=this.fromPath,s=t.substring?i[t]:t,n=this.name;s&&s.name&&s.useAsPath&&(e&&e.name!==s.name&&removeItem(e.pathed,n),N(s.pathed,n),this.fromPath=s,this.dirtyStart=!0)}},Mi.toPath=function(t){if(t){let e=this.toPath,s=t.substring?i[t]:t,n=this.name;s&&s.name&&s.useAsPath&&(e&&e.name!==s.name&&removeItem(e.pathed,n),N(s.pathed,n),this.toPath=s,this.dirtyStart=!0)}},Mi.source=function(t){if((t=t.substring?i[t]:t)&&"Picture"===t.type){let e=this.source;e&&"Picture"===e.type&&e.imageUnsubscribe(this.name),this.source=t,t.imageSubscribe(this.name),this.dirtyInput=!0}},Mi.isHorizontalCopy=function(t){this.isHorizontalCopy=!!t,this.dirtyPathData=!0},Mi.synchronizePathCursors=function(t){this.synchronizePathCursors=!!t,t&&(this.toPathStart=this.fromPathStart,this.toPathEnd=this.fromPathEnd),this.dirtyPathData=!0},Mi.loopPathCursors=function(t){if(this.loopPathCursors=!!t,t){let t,e=Math.floor;t=this.fromPathStart,(t<0||t>1)&&(this.fromPathStart=t-e(t)),t=this.fromPathEnd,(t<0||t>1)&&(this.fromPathEnd=t-e(t)),t=this.toPathStart,(t<0||t>1)&&(this.toPathStart=t-e(t)),t=this.toPathEnd,(t<0||t>1)&&(this.toPathEnd=t-e(t))}this.dirtyOutput=!0},Mi.fromPathStart=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.fromPathStart=t,this.synchronizePathCursors&&(this.toPathStart=t),this.dirtyPathData=!0},zi.fromPathStart=function(t){let e=this.fromPathStart+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.fromPathStart=e,this.synchronizePathCursors&&(this.toPathStart=e),this.dirtyPathData=!0},Mi.fromPathEnd=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.fromPathEnd=t,this.synchronizePathCursors&&(this.toPathEnd=t),this.dirtyPathData=!0},zi.fromPathEnd=function(t){let e=this.fromPathEnd+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.fromPathEnd=e,this.synchronizePathCursors&&(this.toPathEnd=e),this.dirtyPathData=!0},Mi.toPathStart=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.toPathStart=t,this.synchronizePathCursors&&(this.fromPathStart=t),this.dirtyPathData=!0},zi.toPathStart=function(t){let e=this.toPathStart+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.toPathStart=e,this.synchronizePathCursors&&(this.fromPathStart=e),this.dirtyPathData=!0},Mi.toPathEnd=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.toPathEnd=t,this.synchronizePathCursors&&(this.fromPathEnd=t),this.dirtyPathData=!0},zi.toPathEnd=function(t){let e=this.toPathEnd+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.toPathEnd=e,this.synchronizePathCursors&&(this.fromPathEnd=e),this.dirtyPathData=!0},ji.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=i[this.host];if(t)return this.currentHost=t,this.dirtyHost=!0,this.currentHost}return currentCorePosition},ji.updateByDelta=function(){return this.setDelta(this.delta),this},ji.reverseByDelta=function(){let t={};return Object.entries(this.delta).forEach(([e,i])=>{i=i.substring?-parseFloat(i)+"%":-i,t[e]=i}),this.setDelta(t),this},ji.setDeltaValues=function(t={}){let e,i,s=this.delta;return Object.entries(t).forEach(([t,n])=>{if(xt(s[t]))switch(i=n,e=s[t],i){case"reverse":e.toFixed&&(s[t]=-e);break;case"zero":e.toFixed&&(s[t]=0)}}),this},ji.midInitActions=T,ji.cleanCollisionData=function(){return[0,[]]},ji.getSensors=function(){return[]},ji.prepareStamp=function(){let t=this.fromPath,e=this.toPath,[i,s,n,r]=this.getBoundingBox();if(!this.dirtyPathData){let{x:i,y:s}=t.getPathPositionData(0),{x:n,y:r}=t.getPathPositionData(1),{x:o,y:a}=e.getPathPositionData(0),{x:h,y:c}=e.getPathPositionData(1),l=[i,s,n,r,o,a,h,c];this.pathTests&&!this.pathTests.some((t,e)=>t!==l[e])||(this.pathTests=l,this.dirtyPathData=!0)}if(this.dirtyPathData||!this.fromPathData.length){this.dirtyPathData=!1,this.watchIndex=-1,this.engineInstructions.length=0,this.engineDeltaLengths.length=0;let n=Math.ceil,r=Math.max,o=Math.min,a=this.fromPathData;a.length=0;let h=this.toPathData;if(h.length=0,t&&e){let c,l,u,d,f=n(t.length),p=n(e.length);c=this.setSourceDimension(r(f,p));let m,g,y,b=this.fromPathStart,P=this.fromPathEnd,S=this.toPathStart,v=this.toPathEnd,k=this.constantPathSpeed;m=b<P?P-b:P+(1-b),m<.005&&(m=.005),g=S<v?v-S:v+(1-S),g<.005&&(g=.005),y=n(o(m,g)),l=1/(c*(1/y));for(let n=0;n<=1;n+=l)({x:u,y:d}=t.getPathPositionData(n,k)),a.push([u-i,d-s]),({x:u,y:d}=e.getPathPositionData(n,k)),h.push([u-i,d-s]);this.fromPathSteps=m/y,this.toPathSteps=g/y,this.watchFromPath=1===this.fromPathSteps,this.dirtyOutput=!0}else this.dirtyPathData=!0}this.sourceIsVideoOrSprite&&(this.dirtyInput=!0)},ji.setSourceDimension=function(t){if(t)this.sourceDimension!==t&&(this.sourceDimension=t,this.dirtyInput=!0);else{let t=this.fromPath,e=this.toPath;if(t&&e){let i=Math.ceil,s=i(t.length),n=i(e.length),r=Math.max(s,n);this.sourceDimension!==r&&(this.sourceDimension=r)}else this.sourceDimension=0}return this.sourceDimension},ji.simpleStamp=function(t,e={}){t&&"Cell"===t.type&&(this.currentHost=t,e&&(this.set(e),this.prepareStamp()),this.regularStampSynchronousActions())},ji.stamp=function(t=!1,e,i){if(t)return e&&"Cell"===e.type&&(this.currentHost=e),i&&(this.set(i),this.prepareStamp()),this.regularStamp();if(this.visibility){let t=this,e=this.dirtyInput,i=this.dirtyOutput;return e?new Promise((e,i)=>{t.cleanInput().then(e=>(t.sourceImageData=e,t.cleanOutput())).catch(t=>{console.log(t),e(t)}).then(e=>(t.output=e,t.regularStamp())).then(t=>{e(!0)}).catch(t=>{i(t)})}):i?new Promise((e,i)=>{t.cleanOutput().then(e=>(t.output=e,t.regularStamp())).then(t=>{e(!0)}).catch(t=>{i(t)})}):this.regularStamp()}return Promise.resolve(!1)},ji.cleanInput=function(){let t=this;return new Promise((e,i)=>{t.dirtyInput=!1,t.setSourceDimension();let s=t.sourceDimension;s||(t.dirtyInput=!0,i(new Error(t.name+" - cleanInput Error: source has a zero dimension")));let n=ne(),r=n.engine,o=n.element;o.width=s,o.height=s,r.setTransform(1,0,0,1,0,0),t.source.stamp(!0,n,{startX:0,startY:0,handleX:0,handleY:0,offsetX:0,offsetY:0,roll:0,scale:1,width:s,height:s,method:"fill"}).then(t=>{let i=r.getImageData(0,0,s,s);re(n),e(i)}).catch(t=>{re(n),i(t)})})},ji.cleanOutput=function(){let t=this;return new Promise((e,i)=>{t.dirtyOutput=!1,t.setSourceDimension();let s=t.sourceDimension,n=t.sourceImageData;if(s&&n){let i,r,o,a,h,c,l,u,d,f,p,m=Math.hypot,g=Math.floor,y=Math.ceil,b=Math.atan2,P=Math.cos,S=Math.sin,v=t.fromPathData,k=t.toPathData,x=v.length,w=t.fromPathStart*x,C=t.fromPathSteps||1,O=t.toPathStart*x,D=t.toPathSteps||1,A=.5*Math.PI,E=A-1.5708,T=t.isHorizontalCopy,H=t.loopPathCursors,R=t.watchFromPath,F=t.watchIndex,B=t.engineInstructions,j=t.engineDeltaLengths,[L,M,z,I]=t.getBoundingBox(),X=ne(),Y=X.engine,$=X.element;$.width=s,$.height=s,Y.setTransform(1,0,0,1,0,0),Y.putImageData(n,0,0);let N=ne(),W=N.engine,q=N.element;if(q.width=z,q.height=I,W.globalAlpha=t.state.globalAlpha,W.setTransform(1,0,0,1,0,0),!B.length){for(let t=0;t<s;t++)F<0&&(R&&w<1||!R&&O<1)&&(F=t),w<x&&O<x&&w>=0&&O>=0?([i,r]=v[g(w)],[o,a]=k[g(O)],h=o-i,c=a-r,l=m(h,c),T?(u=-b(h,c)+A,d=P(u),f=S(u),B.push([d,f,-f,d,i,r]),j.push(l)):(u=-b(h,c)+E,d=P(u),f=S(u),B.push([d,f,-f,d,i,r,l]),j.push(l))):(B.push(!1),j.push(!1)),w+=C,O+=D,H&&(w>=x&&(w-=x),O>=x&&(O-=x));F<0&&(F=0),t.watchIndex=F}if(T)for(let t=0;t<s;t++)p=B[F],p&&(W.setTransform(...p),W.drawImage($,0,F,s,1,0,0,j[F],1)),F++,F>=s&&(F=0);else for(let t=0;t<s;t++)p=B[F],p&&(W.setTransform(...p),W.drawImage($,F,0,1,s,0,0,1,j[F])),F++,F>=s&&(F=0);let V=t.interferenceFactor,G=t.interferenceLoops,U=y(z*V),_=y(I*V);$.width=U,$.height=_,W.setTransform(1,0,0,1,0,0),Y.setTransform(1,0,0,1,0,0);for(let t=0;t<G;t++)Y.drawImage(q,0,0,z,I,0,0,U,_),W.drawImage($,0,0,U,_,0,0,z,I);let Q=W.getImageData(0,0,z,I);re(X),re(N),t.dirtyTargetImage=!0,e(Q)}else i(new Error(this.name+" - cleanOutput Error: source has a zero dimension, or no data"))})},ji.regularStamp=function(){let t=this;return new Promise((e,i)=>{t.currentHost&&(t.regularStampSynchronousActions(),e(!0)),i(new Error(t.name+" has no current host"))})},ji.regularStampSynchronousActions=function(){let t=this.currentHost;if(t){let e=t.engine;this.noCanvasEngineUpdates||t.setEngine(this),this[this.method](e)}},ji.getBoundingBox=function(){let t=this.fromPath,e=this.toPath;if(t&&e){if(this.dirtyStart)if(t.getBoundingBox&&e.getBoundingBox){this.dirtyStart=!1;let[i,s,n,r,o,a]=t.getBoundingBox(),[h,c,l,u,d,f]=e.getBoundingBox();(isNaN(i)||isNaN(s)||isNaN(n)||isNaN(r)||isNaN(o)||isNaN(a)||isNaN(h)||isNaN(c)||isNaN(l)||isNaN(u)||isNaN(d)||isNaN(f))&&(this.dirtyStart=!0),i==h&&s==c&&n==l&&r==u&&o==d&&a==f&&(this.dirtyStart=!0),i+=o,s+=a,h+=d,c+=f;let p=Math.min(i,h),m=Math.max(i+n,h+l),g=Math.min(s,c),y=Math.max(s+r,c+u);this.boundingBox=[p,g,m-p,y-g],this.dirtyPathData=!0}else this.boundingBox=[0,0,0,0]}else this.boundingBox=[0,0,0,0];return this.boundingBox},ji.fill=function(t){this.doFill(t),this.showBoundingBox&&this.drawBoundingBox(t)},ji.draw=function(t){this.doStroke(t),this.showBoundingBox&&this.drawBoundingBox(t)},ji.drawAndFill=function(t){this.doStroke(t),this.currentHost.clearShadow(),this.doFill(t),this.showBoundingBox&&this.drawBoundingBox(t)},ji.fillAndDraw=function(t){this.doFill(t),this.currentHost.clearShadow(),this.doStroke(t),this.showBoundingBox&&this.drawBoundingBox(t)},ji.drawThenFill=function(t){this.doStroke(t),this.doFill(t),this.showBoundingBox&&this.drawBoundingBox(t)},ji.fillThenDraw=function(t){this.doFill(t),this.doStroke(t),this.showBoundingBox&&this.drawBoundingBox(t)},ji.clear=function(t){let e=this.output,i=!!this.currentHost&&this.currentHost.element,s=t.globalCompositeOperation;if(e&&i){let i=ne(),n=i.engine,r=i.element,[o,a,h,c]=this.getBoundingBox();r.width=h,r.height=c,n.putImageData(e,0,0),t.setTransform(1,0,0,1,0,0),t.globalCompositeOperation="destination-out",t.drawImage(r,0,0,h,c,o,a,h,c),t.globalCompositeOperation=s,re(i),this.showBoundingBox&&this.drawBoundingBox(t)}},ji.none=T,ji.doStroke=function(t){let e=this.fromPath,i=this.toPath;if(e&&e.getBoundingBox&&i&&i.getBoundingBox){let s=this.currentHost;if(s){let n=e.currentStampPosition,r=e.getPathPositionData(1),o=i.currentStampPosition,a=i.getPathPositionData(1);s.rotateDestination(t,n[0],n[1],e),t.stroke(e.pathObject),s.rotateDestination(t,o[0],o[1],e),t.stroke(i.pathObject),t.setTransform(1,0,0,1,0,0),t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(a.x,a.y),t.moveTo(...o),t.lineTo(...n),t.closePath(),t.stroke()}}},ji.doFill=function(t){let e=this.output,i=!!this.currentHost&&this.currentHost.element;if(e&&i){let i=ne(),s=i.engine,n=i.element,[r,o,a,h]=this.getBoundingBox();n.width=a,n.height=h,s.putImageData(e,0,0),t.setTransform(1,0,0,1,0,0),t.drawImage(n,0,0,a,h,r,o,a,h),re(i)}},ji.drawBoundingBox=function(t){this.dirtyStart&&this.getBoundingBox(),t.save();let e=t.getTransform();t.setTransform(1,0,0,1,0,0),t.strokeStyle=this.boundingBoxColor,t.lineWidth=1,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.strokeRect(...this.boundingBox),t.restore(),t.setTransform(e)},ji.checkHit=function(t=[]){if(this.noUserInteraction)return!1;let e,i,s,n,r,o=Array.isArray(t)?t:[t],a=!(!this.output||!this.output.data)&&this.output.data;if(a){let[t,h,c,l]=this.getBoundingBox();if(o.some(o=>{if(Array.isArray(o))e=o[0],i=o[1];else{if(!V(o,o.x,o.y))return!1;e=o.x,i=o.y}return!(!e.toFixed||!i.toFixed||isNaN(e)||isNaN(i))&&(s=e-t,n=i-h,!(s<0||s>c||n<0||n>l)&&(r=4*(n*c+s)+3,!!a&&a[r]>0))},this))return{x:e,y:i,artefact:this}}return!1};g.Loom=Loom;const Oval=function(t={}){return this.shapeInit(t),this};let Ii=Oval.prototype=Object.create(Object.prototype);Ii.type="Oval",Ii.lib="entity",Ii.isArtefact=!0,Ii.isAsset=!1,Ii=nt(Ii),Ii=Pi(Ii);Ii.defs=Y(Ii.defs,{radiusX:5,radiusY:5,intersectX:.5,intersectY:.5,offshootA:.55,offshootB:0});let Xi=Ii.setters,Yi=Ii.deltaSetters;Xi.radius=function(t){this.setRectHelper(t,["radiusX","radiusY"])},Xi.radiusX=function(t){this.setRectHelper(t,["radiusX"])},Xi.radiusY=function(t){this.setRectHelper(t,["radiusY"])},Yi.radius=function(t){this.deltaRectHelper(t,["radiusX","radiusY"])},Yi.radiusX=function(t){this.deltaRectHelper(t,["radiusX"])},Yi.radiusY=function(t){this.deltaRectHelper(t,["radiusY"])},Xi.offshootA=function(t){this.offshootA=t,this.updateDirty()},Xi.offshootB=function(t){this.offshootB=t,this.updateDirty()},Yi.offshootA=function(t){t.toFixed&&(this.offshootA+=t,this.updateDirty())},Yi.offshootB=function(t){t.toFixed&&(this.offshootB+=t,this.updateDirty())},Xi.intersectA=function(t){this.intersectA=t,this.updateDirty()},Xi.intersectB=function(t){this.intersectB=t,this.updateDirty()},Yi.intersectA=function(t){t.toFixed&&(this.intersectA+=t,this.updateDirty())},Yi.intersectB=function(t){t.toFixed&&(this.intersectB+=t,this.updateDirty())},Ii.setRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=t},this)},Ii.deltaRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=addStrings(this[e],t)},this)},Ii.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeOvalPath(),this.pathDefinition=t},Ii.makeOvalPath=function(){let t,e,i=parseFloat(this.offshootA.toFixed(6)),s=parseFloat(this.offshootB.toFixed(6)),n=this.radiusX,r=this.radiusY;if(n.substring||r.substring){let i=this.getHere();t=2*(n.substring?parseFloat(n)/100*i.w:n),e=2*(r.substring?parseFloat(r)/100*i.h:r)}else t=2*n,e=2*r;let o=parseFloat((t*this.intersectX).toFixed(2)),a=parseFloat((t-o).toFixed(2)),h=parseFloat((e*this.intersectY).toFixed(2)),c=parseFloat((e-h).toFixed(2)),l="m0,0";return l+=`c${a*i},${h*s} ${a-a*s},${h-h*i}, ${a},${h} `,l+=`${-a*s},${c*i} ${a*i-a},${c-c*s} ${-a},${c} `,l+=`${-o*i},${-c*s} ${o*s-o},${c*i-c} ${-o},${-c} `,l+=`${o*s},${-h*i} ${o-o*i},${h*s-h} ${o},${-h}z`,l},Ii.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};g.Oval=Oval;const VideoAsset=function(t={}){return this.assetConstructor(t)};let $i=VideoAsset.prototype=Object.create(Object.prototype);$i.type="Video",$i.lib="asset",$i.isArtefact=!1,$i.isAsset=!0,$i=nt($i),$i=jt($i),$i.saveAsPacket=function(){return[this.name,this.type,this.lib,{}]},$i.stringifyFunction=T,$i.processPacketOut=T,$i.finalizePacketOut=T,$i.clone=H;$i.getters;let Ni=$i.setters;$i.deltaSetters;Ni.source=function(t={}){t&&("VIDEO"===t.tagName.toUpperCase()&&(this.source=t,this.sourceNaturalWidth=t.videoWidth||0,this.sourceNaturalHeight=t.videoHeight||0,this.sourceLoaded=t.readyState>2),this.sourceLoaded&&this.notifySubscribers())},$i.checkSource=function(t,e){let i=this.source;i&&i.readyState>2?(this.sourceLoaded=!0,this.sourceNaturalWidth===i.videoWidth&&this.sourceNaturalHeight===i.videoHeight&&this.sourceNaturalWidth===t&&this.sourceNaturalHeight===e||(this.sourceNaturalWidth=i.videoWidth,this.sourceNaturalHeight=i.videoHeight,this.notifySubscribers())):this.sourceLoaded=!1},$i.addTextTrack=function(t,e,i){let s=this.source;s&&s.addTextTrack&&s.addTextTrack(t,e,i)},$i.captureStream=function(){let t=this.source;return!(!t||!t.captureStream)&&t.captureStream()},$i.canPlayType=function(t){let e=this.source;return e?e.canPlayType(t):"maybe"},$i.fastSeek=function(t){let e=this.source;e&&e.fastSeek&&e.fastSeek(t)},$i.load=function(){let t=this.source;t&&t.load()},$i.pause=function(){let t=this.source;t&&t.pause()},$i.play=function(){let t=this.source;return t?t.play().catch(t=>console.log(t.code,t.name,t.message)):Promise.reject("Source not defined")},$i.setMediaKeys=function(t){let e=this.source;return e?e.setMediaKeys?e.setMediaKeys(t):Promise.reject("setMediaKeys not supported"):Promise.reject("Source not defined")},$i.setSinkId=function(){let t=this.source;return t?t.setSinkId?t.setSinkId():Promise.reject("setSinkId not supported"):Promise.reject("Source not defined")};const Wi=["video_audioTracks","video_autoPlay","video_buffered","video_controller","video_controls","video_controlsList","video_crossOrigin","video_currentSrc","video_currentTime","video_defaultMuted","video_defaultPlaybackRate","video_disableRemotePlayback","video_duration","video_ended","video_error","video_loop","video_mediaGroup","video_mediaKeys","video_muted","video_networkState","video_paused","video_playbackRate","video_readyState","video_seekable","video_seeking","video_sinkId","video_src","video_srcObject","video_textTracks","video_videoTracks","video_volume"],qi=["video_autoPlay","video_controller","video_controls","video_crossOrigin","video_currentTime","video_defaultMuted","video_defaultPlaybackRate","video_disableRemotePlayback","video_loop","video_mediaGroup","video_muted","video_playbackRate","video_src","video_srcObject","video_volume"],Vi=function(...t){let e=/.*\/(.*?)\./,i="";if(t.length){let s,n,r,o,a,h,c=!1,l=t[0];if(l.substring){let i=e.exec(l);s=i&&i[1]?i[1]:"",a=[...t],n="",r=!1,o=null,h="auto",c=!0}else l&&l.src&&(s=l.name||"",a=[...l.src],n=l.className||"",r=l.visibility||!1,o=document.querySelector(o),h=l.preload||"auto",c=!0);let u=Gi({name:s});if(c){let t=document.createElement("video");t.name=s,t.className=n,t.style.display=r?"block":"none",t.crossOrigin="anonymous",t.preload=h,a.forEach(e=>{let i=document.createElement("source");i.src=e,t.appendChild(i)}),t.onload=()=>{u.set({source:t}),o&&o.appendChild(t)},u.set({source:t}),i=s}}return i},Gi=function(t){return new VideoAsset(t)};g.VideoAsset=VideoAsset;const SpriteAsset=function(t={}){return this.assetConstructor(t),this};let Ui=SpriteAsset.prototype=Object.create(Object.prototype);Ui.type="Sprite",Ui.lib="asset",Ui.isArtefact=!1,Ui.isAsset=!0,Ui=nt(Ui),Ui=jt(Ui);Ui.defs=Y(Ui.defs,{manifest:null}),Ui.saveAsPacket=function(){return[this.name,this.type,this.lib,{}]},Ui.stringifyFunction=T,Ui.processPacketOut=T,Ui.finalizePacketOut=T,Ui.clone=H;Ui.getters;let _i=Ui.setters;Ui.deltaSetters;_i.source=function(t=[]){if(t&&t[0]){this.sourceHold||(this.sourceHold={});let e=this.sourceHold;t.forEach(t=>{let i=t.id||t.name;i&&(e[i]=t)}),this.source=t[0],this.sourceNaturalWidth=t[0].naturalWidth,this.sourceNaturalHeight=t[0].naturalHeight,this.sourceLoaded=t[0].complete}},Ui.checkSource=T;const Qi=function(...t){let e=/.*\/(.*?)\./,i=/\.(jpeg|jpg|png|gif|webp|svg|JPEG|JPG|PNG|GIF|WEBP|SVG)/,s=[];return t.forEach(t=>{let n,r,o,a,h,c=!1,l=!1;if(t.substring){let s=e.exec(t);n=s&&s[1]?s[1]:"",r=[t],o="",a=!1,h=t.replace(i,".json"),l=!0}else I(t)&&t.imageSrc&&t.manifestSrc?(n=t.name||"",r=Array.isArray(t.imageSrc)?t.imageSrc:[t.imageSrc],h=t.manifestSrc,o=t.className||"",a=t.visibility||!1,c=document.querySelector(t.parent),l=!0):s.push(!1);if(l){let t=Ki({name:n});I(h)?t.manifest=h:fetch(h).then(t=>{if(200!==t.status)throw new Error("Failed to load manifest");return t.json()}).then(e=>t.manifest=e).catch(t=>console.log(t.message));let l=[];r.forEach(t=>{let s,r,h=document.createElement("img");i.test(t)&&(r=e.exec(t),s=r&&r[1]?r[1]:""),h.name=s||n,h.className=o,h.crossorigin="anonymous",h.style.display=a?"block":"none",c&&c.appendChild(h),h.src=t,l.push(h)}),t.set({source:l}),s.push(n)}else s.push(!1)}),s},Ki=function(t){return new SpriteAsset(t)};function Zi(t={}){t.defs=Y(t.defs,{asset:null,spriteIsRunning:!1,spriteLastFrameChange:0,spriteCurrentFrame:0,spriteTrack:"default",spriteForward:!0,spriteFrameDuration:100,spriteWillLoop:!0});let e=t.setters;return e.asset=function(t){let e=this.asset,i=t&&t.name?t.name:t;e&&!e.substring&&e.unsubscribe(this),this.asset=i,this.dirtyAsset=!0},e.imageSource=function(t){let e=Xt(t);if(e){let t=n[e[0]];if(t){let e=this.asset;e&&e.unsubscribe&&e.unsubscribe(this),t.subscribe(this)}}},e.videoSource=function(t){let e=Vi(t);if(e){let t=n[e];if(t){let e=this.asset;e&&e.unsubscribe&&e.unsubscribe(this),t.subscribe(this)}}},e.spriteSource=function(t){let e=Qi(t);if(e){let t=n[e];if(t){let e=this.asset;e&&e.unsubscribe&&e.unsubscribe(this),t.subscribe(this)}}},t.cleanAsset=function(){let t=this.asset;if(t&&t.substring){let e=n[t];e&&(this.dirtyAsset=!1,e.subscribe(this))}},t.videoAction=function(t,...e){let i=this.asset;if(i&&"Video"===i.type)return i[t](...e)},t.videoPromiseAction=function(t,...e){let i=this.asset;return i&&"Video"===i.type?i[t](...e):Promise.reject("Asset not a video")},t.videoAddTextTrack=function(t,e,i){return this.videoAction("addTextTrack",t,e,i)},t.videoCaptureStream=function(){return this.videoAction("captureStream")},t.videoCanPlayType=function(t){return this.videoAction("canPlayType",t)},t.videoFastSeek=function(t){return this.videoAction("fastSeek",t)},t.videoLoad=function(){return this.videoAction("load")},t.videoPause=function(){return this.videoAction("pause")},t.videoPlay=function(){return this.videoPromiseAction("play")},t.videoSetMediaKeys=function(t){return this.videoPromiseAction("setMediaKeys",t)},t.videoSetSinkId=function(){return this.videoPromiseAction("setSinkId")},t.checkSpriteFrame=function(){let t=this.asset;if(t&&"Sprite"===t.type){let e=this.copyArray;if(this.spriteIsRunning){let i=this.spriteLastFrameChange,s=this.spriteFrameDuration,n=Date.now();if(n>i+s){let i=t.manifest;if(i){let s=i[this.spriteTrack],r=s.length,o=this.spriteCurrentFrame,a=this.spriteWillLoop;o=this.spriteForward?o+1:o-1,o<0&&(o=a?r-1:0),o>=r&&(o=a?0:r-1);let[h,c,l,u,d]=s[o];if(e.length=0,e.push(c,l,u,d),this.dirtyCopyStart=!1,this.dirtyCopyDimensions=!1,h!==(this.source.id||this.source.name)){let e=t.sourceHold[h];e&&(this.source=e)}this.spriteCurrentFrame=o,this.spriteLastFrameChange=n}}}else{let[i,s,n,r,o]=t.manifest[this.spriteTrack][this.spriteCurrentFrame],[a,h,c,l]=e;a===s&&h===n&&c===r&&l===o||(e.length=0,e.push(s,n,r,o),this.dirtyCopyStart=!1,this.dirtyCopyDimensions=!1)}}},t.playSprite=function(t,e,i,s,n){q(t)&&(this.spriteFrameDuration=t),q(e)&&(this.spriteWillLoop=e),q(i)&&(this.spriteTrack=i),q(s)&&(this.spriteForward=s),q(n)&&(this.spriteCurrentFrame=n),this.spriteLastFrameChange=Date.now(),this.spriteIsRunning=!0},t.haltSprite=function(t,e,i,s,n){q(t)&&(this.spriteFrameDuration=t),q(e)&&(this.spriteWillLoop=e),q(i)&&(this.spriteTrack=i),q(s)&&(this.spriteForward=s),q(n)&&(this.spriteCurrentFrame=n),this.spriteIsRunning=!1},t}g.SpriteAsset=SpriteAsset;const Pattern=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this};let Ji=Pattern.prototype=Object.create(Object.prototype);Ji.type="Pattern",Ji.lib="styles",Ji.isArtefact=!1,Ji.isAsset=!1,Ji=nt(Ji),Ji=Zi(Ji);Ji.defs=Y(Ji.defs,{repeat:"repeat"}),Ji.packetObjects=N(Ji.packetObjects,["asset"]),Ji.kill=function(){let t=this.name;return I(this.asset)&&this.asset.unsubscribe(this),Object.entries(c).forEach(([e,i])=>{let s=i.state;if(s){let e=s.fillStyle,i=s.strokeStyle;I(e)&&e.name===t&&(s.fillStyle=s.defs.fillStyle),I(i)&&i.name===t&&(s.strokeStyle=s.defs.strokeStyle)}}),this.deregister(),this};Ji.getters;let ts=Ji.setters;Ji.deltaSetters;Ji.repeatValues=["repeat","repeat-x","repeat-y","no-repeat"],ts.repeat=function(t){this.repeatValues.indexOf(t)>=0?this.repeat=t:this.repeat=this.defs.repeat},Ji.buildStyle=function(t={}){if(this.sourceLoaded&&t){let e=!1;if(t.substring){let i=a[t];i&&i.engine&&(e=i.engine)}else t.engine&&(e=t.engine);if(e)return e.createPattern(this.source,this.repeat)}return"rgba(0,0,0,0)"},Ji.getData=function(t,e){return this.dirtyAsset&&this.cleanAsset(),this.asset.checkSource(this.sourceNaturalWidth,this.sourceNaturalHeight),this.buildStyle(e)};g.Pattern=Pattern;const FontAttributes=function(t={}){return this.makeName(t.name),this.set(this.defs),this.set(t),this};let es=FontAttributes.prototype=Object.create(Object.prototype);es.type="FontAttributes",es.lib="fontattribute",es=nt(es);es.defs=Y(es.defs,{style:"normal",variant:"normal",weight:"normal",stretch:"normal",sizeValue:12,sizeMetric:"px",family:"sans-serif"});let is=es.getters,ss=es.setters;es.deltaSetters;is.size=function(){return this.sizeValue?`${this.sizeValue}${this.sizeMetric}`:this.sizeMetric},ss.size=function(t){if(q(t)){let e,i=0,s="medium";t.indexOf("xx-small")>=0?s="xx-small":t.indexOf("x-small")>=0?s="x-small":t.indexOf("smaller")>=0?s="smaller":t.indexOf("small")>=0?s="small":t.indexOf("xx-large")>=0?s="xx-large":t.indexOf("x-large")>=0?s="x-large":t.indexOf("larger")>=0?s="larger":t.indexOf("large")>=0?s="large":t.indexOf("medium")>=0?s="medium":(i=12,s="px"),/.* (\d+\.\d+|\d+|\.\d+)(%|em|ch|ex|rem|vh|vw|vmin|vmax|px|cm|mm|in|pc|pt)?/i.test(t)?(e=t.match(/.* (\d+\.\d+|\d+|\.\d+)(%|em|ch|ex|rem|vh|vw|vmin|vmax|px|cm|mm|in|pc|pt)?/i),i="."!==e[1]?parseFloat(e[1]):12,s=e[2]):/^(\d+\.\d+|\d+|\.\d+)(%|em|ch|ex|rem|vh|vw|vmin|vmax|px|cm|mm|in|pc|pt)?/i.test(t)&&(e=t.match(/^(\d+\.\d+|\d+|\.\d+)(%|em|ch|ex|rem|vh|vw|vmin|vmax|px|cm|mm|in|pc|pt)?/i),i="."!==e[1]?parseFloat(e[1]):12,s=e[2]),this.sizeValue=i,this.sizeMetric=s}},ss.font=function(t){q(t)&&(ss.style.call(this,t),ss.variant.call(this,t),ss.weight.call(this,t),ss.stretch.call(this,t),ss.size.call(this,t),ss.family.call(this,t))},ss.style=function(t){let e="normal";q(t)&&(e=t.indexOf("italic")>=0?"italic":e,e=t.indexOf("oblique")>=0?"oblique":e),this.style=e},ss.variant=function(t){let e="normal";e=t.indexOf("small-caps")>=0?"small-caps":e,this.variant=e},ss.weight=function(t){let e="normal";q(t)&&(t.toFixed?e=t:(e=t.indexOf("bold")>=0?"bold":e,e=t.indexOf("lighter")>=0?"lighter":e,e=t.indexOf("bolder")>=0?"bolder":e,e=t.indexOf(" 100 ")>=0?"100":e,e=t.indexOf(" 200 ")>=0?"200":e,e=t.indexOf(" 300 ")>=0?"300":e,e=t.indexOf(" 400 ")>=0?"400":e,e=t.indexOf(" 500 ")>=0?"500":e,e=t.indexOf(" 600 ")>=0?"600":e,e=t.indexOf(" 700 ")>=0?"700":e,e=t.indexOf(" 800 ")>=0?"800":e,e=t.indexOf(" 900 ")>=0?"900":e,e=/^\d00$/.test(t)?t:e)),this.weight=e},ss.stretch=function(t){let e="normal";q(t)&&(e=t.indexOf("semi-condensed")>=0?"semi-condensed":e,e=t.indexOf("condensed")>=0?"condensed":e,e=t.indexOf("extra-condensed")>=0?"extra-condensed":e,e=t.indexOf("ultra-condensed")>=0?"ultra-condensed":e,e=t.indexOf("semi-condensed")>=0?"semi-condensed":e,e=t.indexOf("condensed")>=0?"condensed":e,e=t.indexOf("extra-condensed")>=0?"extra-condensed":e,e=t.indexOf("ultra-condensed")>=0?"ultra-condensed":e),this.stretch=e},ss.family=function(t){if(q(t)){let e=t.match(/( xx-small| x-small| small| medium| large| x-large| xx-large| smaller| larger|\d%|\dem|\dch|\dex|\drem|\dvh|\dvw|\dvmin|\dvmax|\dpx|\dcm|\dmm|\din|\dpc|\dpt) (.*)$/i);this.family=e&&e[2]?e[2]:t}},es.buildFont=function(t=1){let e="";"normal"!==this.style&&(e+=this.style+" "),"normal"!==this.variant&&(e+=this.variant+" "),"normal"!==this.weight&&(e+=this.weight+" "),"normal"!==this.stretch&&(e+=this.stretch+" "),this.sizeValue?e+=`${this.sizeValue*t}${this.sizeMetric} `:e+=this.sizeMetric+" ",e+=""+this.family;let i=ne();return i.engine.font=e,e=i.engine.font,re(i),e},es.update=function(t=1,e){return e&&this.set(e),this.buildFont(t)};g.FontAttributes=FontAttributes;const ns=document.createElement("div");ns.style.padding=0,ns.style.border=0,ns.style.margin=0,ns.style.height="auto",ns.style.lineHeight=1,ns.style.boxSizing="border-box",ns.innerHTML="|/}qwertyd0123456789QWERTY",ti.appendChild(ns);const rs=document.createElement("textarea"),os=(t,e)=>(t=parseFloat(t),z(t)||(t=0),z(e)||(e=0),parseFloat(t.toFixed(e))),as=(t,e)=>(t=parseFloat(t),z(t)||(t=0),z(e)||(e=0),Math.abs(parseFloat(t.toFixed(e)))),Phrase=function(t={}){return this.fontAttributes=function(t){return new FontAttributes(t)}(t),delete t.font,delete t.style,delete t.variant,delete t.weight,delete t.stretch,delete t.size,delete t.sizeValue,delete t.sizeMetric,delete t.family,this.entityInit(t),this.sectionStyles=[],this.sectionClasses={DEFAULTS:{defaults:!0},BOLD:{weight:"bold"},ITALIC:{style:"italic"},"SMALL-CAPS":{variant:"small-caps"},HIGHLIGHT:{highlight:!0},UNDERLINE:{underline:!0},OVERLINE:{overline:!0},"/BOLD":{weight:"normal"},"/ITALIC":{style:"normal"},"/SMALL-CAPS":{variant:"normal"},"/HIGHLIGHT":{highlight:!1},"/UNDERLINE":{underline:!1},"/OVERLINE":{overline:!1}},this.dirtyDimensions=!0,this.dirtyText=!0,this.dirtyFont=!0,this.dirtyPathObject=!0,this};let hs=Phrase.prototype=Object.create(Object.prototype);hs.type="Phrase",hs.lib="entity",hs.isArtefact=!0,hs.isAsset=!1,hs=nt(hs),hs=di(hs);hs.defs=Y(hs.defs,{text:"",width:"auto",exposeText:!0,lineHeight:1.15,letterSpacing:0,justify:"left",sectionClassMarker:"",sectionClasses:null,overlinePosition:-.1,overlineStyle:"rgb(250,0,0)",underlinePosition:.6,underlineStyle:"rgb(250,0,0)",highlightStyle:"rgba(250,218,94,0.4)",boundingBoxColor:"rgba(0,0,0,0.5)",showBoundingBox:!1,textPath:"",textPathPosition:0,textPathLoop:!0,addTextPathRoll:!0,textPathDirection:"ltr",treatWordAsGlyph:!1}),hs.packetExclusions=N(hs.packetExclusions,["textPositions","textLines","textLineWidths","textLineWords","textGlyphs","textGlyphWidths","fontAttributes"]),hs.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];t=Y(t,i);let s=JSON.parse(this.fontAttributes.saveAsPacket(e))[3];return delete s.name,t=Y(t,s),t=this.handlePacketAnchor(t,e)},hs.factoryKill=function(){this.exposedTextHold&&this.exposedTextHold.remove()};let cs=hs.getters,ls=hs.setters,us=hs.deltaSetters;ls.handleX=function(t){null!=t&&(this.handle[0]=t,this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0)},ls.handleY=function(t){null!=t&&(this.handle[1]=t,this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0)},ls.handle=function(t,e){this.setCoordinateHelper("handle",t,e),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},us.handleX=function(t){let e=this.handle;e[0]=addStrings(e[0],t),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},us.handleY=function(t){let e=this.handle;e[1]=addStrings(e[1],t),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},us.handle=function(t,e){this.setDeltaCoordinateHelper("handle",t,e),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},cs.text=function(){return this.currentText||this.text||""},ls.text=function(t){var e;this.text=(e=t).substring?e:e.toString,this.dirtyText=!0,this.dirtyPathObject=!0,this.dirtyDimensions=!0},hs.permittedJustifications=["left","right","center","full"],ls.justify=function(t){this.permittedJustifications.indexOf(t)>=0&&(this.justify=t),this.dirtyText=!0,this.dirtyPathObject=!0},ls.width=function(t){this.dimensions[0]=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyPathObject=!0,this.dirtyText=!0},us.width=function(t){let e=this.dimensions;e[0]=addStrings(e[0],t),this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyPathObject=!0,this.dirtyText=!0},ls.scale=function(t){this.scale=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyFont=!0,this.dirtyPathObject=!0,this.dirtyScale=!0},us.scale=function(t){this.scale+=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyFont=!0,this.dirtyPathObject=!0,this.dirtyScale=!0},ls.lineHeight=function(t){this.lineHeight=as(t,3),this.lineHeight<.5&&(this.lineHeight=.5),this.dirtyPathObject=!0,this.dirtyText=!0},us.lineHeight=function(t){this.lineHeight+=os(t,3),this.lineHeight<.5&&(this.lineHeight=.5),this.dirtyPathObject=!0,this.dirtyText=!0},ls.letterSpacing=function(t){this.letterSpacing=as(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},us.letterSpacing=function(t){this.letterSpacing+=os(t,3),this.letterSpacing<0&&(this.letterSpacing=0),this.dirtyPathObject=!0,this.dirtyText=!0},ls.overlinePosition=function(t){this.overlinePosition=os(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},us.overlinePosition=function(t){this.overlinePosition+=os(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},ls.underlinePosition=function(t){this.underlinePosition=os(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},us.underlinePosition=function(t){this.underlinePosition+=os(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},ls.textPath=function(t){this.textPath=t,this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},ls.textPathPosition=function(t){this.textPathLoop?(t<0&&(t=Math.abs(t)),t>1&&(t%=1),this.textPathPosition=parseFloat(t.toFixed(6))):this.textPathPosition=t},us.textPathPosition=function(t){let e=this.textPathPosition+t;this.textPathLoop?(e<0&&(e+=1),e>1&&(e%=1),this.textPathPosition=parseFloat(e.toFixed(6))):this.textPathPosition=e},cs.font=function(){return this.fontAttributes.get("font")},ls.font=function(t){this.fontAttributes.set({font:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.style=function(){return this.fontAttributes.get("style")},ls.style=function(t){this.fontAttributes.set({style:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.variant=function(){return this.fontAttributes.get("variant")},ls.variant=function(t){this.fontAttributes.set({variant:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.weight=function(){return this.fontAttributes.get("weight")},ls.weight=function(t){this.fontAttributes.set({weight:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.stretch=function(){return this.fontAttributes.get("stretch")},ls.stretch=function(t){this.fontAttributes.set({stretch:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.size=function(){return this.fontAttributes.get("size")},ls.size=function(t){this.fontAttributes.set({size:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.sizeValue=function(){return this.fontAttributes.get("sizeValue")},ls.sizeValue=function(t){this.fontAttributes.set({sizeValue:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},us.sizeValue=function(t){this.fontAttributes.deltaSet({sizeValue:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.sizeMetric=function(){return this.fontAttributes.get("sizeMetric")},ls.sizeMetric=function(t){this.fontAttributes.set({sizeMetric:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},cs.family=function(){return this.fontAttributes.get("family")},ls.family=function(t){this.fontAttributes.set({family:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},hs.cleanDimensionsAdditionalActions=function(){if("auto"===this.dimensions[0]){this.buildText();let t=ne(),e=t.engine;e.font=this.fontAttributes.buildFont(),this.currentDimensions[0]=Math.ceil(e.measureText(this.currentText).width),re(t)}this.textLines?this.currentDimensions[1]=Math.ceil(this.textHeight*this.textLines.length*this.lineHeight/this.scale):this.dirtyDimensions=!0},hs.setSectionStyles=function(t){let e,i,s,n=new RegExp(this.sectionClassMarker),r=t.split(n),o=this.sectionStyles,a=this.sectionClasses,h="";return o.length=0,r.forEach(t=>{e=a[t],e?(i=h.length,s=o[i],s?Object.assign(s,e):o[i]=Object.assign({},e)):q(t)&&(h+=t)}),h},hs.addSectionClass=function(t,e){return V(t,e)&&t.substring&&I(e)&&(this.sectionClasses[t]=e),this.dirtyText=!0,this.dirtyPathObject=!0,this},hs.removeSectionClass=function(t){return delete this.sectionClasses[t],this.dirtyText=!0,this.dirtyPathObject=!0,this},hs.getTextPath=function(){let t=this.textPath;return t&&t.substring&&(t=this.textPath=i[this.textPath],"Shape"===t.type&&t.useAsPath?t.pathed.push(this.name):t=this.path=!1),t},hs.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){this.dirtyFont&&this.fontAttributes&&(this.dirtyFont=!1,this.fontAttributes.buildFont(this.scale),this.dirtyText=!0,this.dirtyMimicDimensions=!0,this.dirtyPositionSubscribers=!0),this.dirtyText&&this.buildText(),this.dirtyHandle&&this.cleanHandle();let t=this.pathObject=new Path2D,e=this.currentHandle,i=this.currentDimensions,s=this.currentScale,n=-e[0]*s,r=-e[1]*s,o=i[0]*s,a=i[1]*s;this.boxStartValues=[n,r],t.rect(n,r,o,a)}},hs.buildText=function(){this.dirtyText=!1;let t=this.convertTextEntityCharacters(this.text);if(t=this.setSectionStyles(t),this.currentText=t,isNaN(this.currentDimensions[0]))this.dirtyText=!0;else if(this.calculateTextPositions(t),this.exposeText){if(!this.exposedTextHold){let t=document.createElement("div");t.id=this.name+"-text-hold",this.exposedTextHold=t,this.exposedTextHoldAttached=!1}this.exposedTextHold.textContent=t,this.exposedTextHoldAttached||this.currentHost&&this.currentHost.controller&&this.currentHost.controller.textHold&&(this.currentHost.controller.textHold.appendChild(this.exposedTextHold),this.exposedTextHoldAttached=!0)}},hs.convertTextEntityCharacters=function(t){let e=t.trim();return e=e.replace(/[\s\uFEFF\xA0]+/g," "),rs.innerHTML=e,rs.value},hs.calculateTextPositions=function(t){const e=function(t){if(!F)return R.dirtyPathObject=!0,R.dirtyText=!0,"black";if(t.substring){let e=!1;if(p.indexOf(t)>=0?e=f[t]:h.indexOf(t)>=0&&(e=a[t]),e)return e}return t};let i,s,n,r,o,c,l,u,d,m,g,y,b,P,S,v,k,x,w,C,O,D,A,E,T=ne(),H=T.engine,R=this,F=!(!this.group||!this.group.getHost)&&this.group.getHost(),B=[],j=[],L=[],M=[],z=[],I=[],X=[],Y=this.getTextPath(),$=this.fontAttributes,N=$.clone({}),W=this.sectionStyles,V=this.state,G={},U=[],_=this.currentScale,Q=this.currentDimensions,K=Q[0]*_,Z=this.treatWordAsGlyph,J=this.lineHeight,tt=this.justify,et=$.update(_),it=e(V.fillStyle),st=e(V.strokeStyle),nt=this.letterSpacing*_,rt=et,ot=it,at=st,ht=nt,ct=(!!this.highlightStyle&&e(this.highlightStyle),!1),lt=(!!this.underlineStyle&&e(this.underlineStyle),this.underlinePosition,!1),ut=(!!this.overlineStyle&&e(this.overlineStyle),this.overlinePosition,!1),dt=0;for(i=Z?t.split(" "):t.split(""),U.push(rt),m=0,g=i.length;m<g;m++)r=i[m],z[m]=[,,,,,,r,0,0,0];for(W[0]||(W[0]={family:N.family,size:N.sizeValue?`${N.sizeValue}${N.sizeMetric}`:N.sizeMetric,stretch:N.stretch,style:N.style,variant:N.variant,weight:N.weight}),m=0,g=W.length;m<g;m++)s=W[m],s&&(n=z[m],n&&(0===m&&(n[0]=rt,n[3]=ct,n[4]=lt,n[5]=ut),s.defaults&&(rt=N.update(_,$),at=st,ot=it,ht=nt,n[0]=rt,n[1]=at,n[2]=ot,n[3]=ct,n[4]=lt,n[5]=ut),r=s.stroke,r&&r!==at&&(at=e(s.stroke),n[1]=at),r=s.fill,r&&r!==ot&&(ot=e(s.fill),n[2]=ot),r=s.space,q(r)&&r!==ht&&(ht=r*_),r=s.highlight,q(r)&&r!==ct&&(ct=r,n[3]=ct),r=s.underline,q(r)&&r!==lt&&(lt=r,n[4]=lt),r=s.overline,q(r)&&r!==ut&&(ut=r,n[5]=ut),0!==m&&(s.variant||s.weight||s.style||s.stretch||s.size||s.sizeValue||s.sizeMetric||s.family||s.font)&&(r=N.update(_,s),r!==rt&&(rt=r,n[0]=rt,U.indexOf(rt)<0&&U.push(rt))))),B[m]=ht;for(m=0,g=i.length;m<g;m++)q(B[m])&&(ht=B[m]),B[m]=ht;for(U.forEach(t=>{ns.style.font=t,r=ns.clientHeight,G[t]=r}),dt=Math.max(...Object.values(G)),O=C=o=c=0,m=0,g=z.length;m<g;m++)v=z[m],k=v[6],v[0]&&(H.font=v[0]),I.push(H.measureText(k).width),x=z[m+1],x=!(Z||!x)&&x[6],S=!!x&&H.measureText(`${k}${x}`).width,X.push(S);for(m=0,g=X.length;m<g;m++)k=X[m],k&&(S=I[m]+I[m+1],n=z[m+1],S>k&&!n[0]&&(I[m]-=S-k));for(m=0,g=z.length;m<g;m++)v=z[m],k=v[6],w=I[m]+B[m],B[m]=w,(Z||" "===k)&&(c=m),C+=w,O+=w,C>=K&&o<c&&(P=i.slice(o,c).join(""),j.push(P),S=Z?P.split(" ").length-1:P.split(" ").length,M.push(S),S=B.slice(o,c).reduce((t,e)=>t+e,0),L.push(S),C-=S,o=c+1),m+1===g&&(C===O?(P=t,j.push(P),M.push(Z?P.split(" ").length-1:P.split(" ").length),L.push(O)):(P=i.slice(o).join(""),j.push(P),S=Z?P.split(" ").length-1:P.split(" ").length,M.push(S),S=B.slice(o).reduce((t,e)=>t+e,0),L.push(S))),q(v[3])&&(ct=v[3]),q(v[4])&&(lt=v[4]),q(v[5])&&(ut=v[5]),v[3]=ct,v[4]=lt,v[5]=ut;if(_<=0&&(_=1),Q[1]=Math.ceil(dt*j.length*J/_),this.cleanHandle(),this.dirtyHandle=!1,D=this.currentHandle,A=-D[0]*_,E=-D[1]*_,!Y)if("full"===tt)for(l=0,u=E,m=0,g=L.length;m<g;m++){for(S=A,d=M[m]>1?(K-L[m])/(M[m]-1):0,y=0,b=j[m].length;y<b;y++)r=z[l]," "===r[6]&&(B[l]+=d),r[7]=Math.floor(S),r[8]=Math.floor(u),r[9]=B[l],S+=B[l],l++;l++,u+=dt*J}else for(l=0,u=E,m=0,g=L.length;m<g;m++){for(S="right"===tt?K-L[m]+A:"center"===tt?(K-L[m])/2+A:A,y=0,b=j[m].length;y<b;y++)r=z[l],r[7]=Math.floor(S),r[8]=Math.floor(u),r[9]=B[l],S+=B[l],l++;l++,u+=dt*J}this.textGlyphs=i,this.textGlyphWidths=B,this.textLines=j,this.textLineWidths=L,this.textLineWords=M,this.textPositions=z,this.textHeight=dt,this.textLength=O,this.fontLibrary=G,re(T)},hs.regularStampSynchronousActions=function(){let t,e,i,s,n,r=this.currentHost,o=this.method,a=this.preStamper,h=this.stamper;if(r)if(t=r.engine,"none"===this.method)this.performRotation(t);else if(this.textPath){this.noCanvasEngineUpdates||r.setEngine(this),this.getTextPath(),this.calculateGlyphPathPositions(),s=this.textPositions;let c,l,u=this.addTextPathRoll,d=this.addPathRotation,f=this.currentRotation,p=this.currentHandle;for(this.addPathRotation=u,e=0,i=s.length;e<i;e++)c=s[e],l=c[10],l&&(this.currentPathData=l,u&&(this.currentRotation=l.angle),r.rotateDestination(t,l.x,l.y,this),t.translate(-p[0],-p[1]),n=a(r,t,this,c),h[o](t,this,n));this.addPathRotation=d,this.currentRotation=f}else{for(this.performRotation(t),this.noCanvasEngineUpdates||r.setEngine(this),s=this.textPositions,e=0,i=s.length;e<i;e++)n=a(r,t,this,s[e]),h[o](t,this,n);this.showBoundingBox&&this.drawBoundingBox(t)}},hs.calculateGlyphPathPositions=function(){let t,e,i,s,n,r=this.getTextPath(),o=r.length,a=this.textPositions,h=this.textGlyphWidths,c="ltr"===this.textPathDirection,l=this.textPathPosition,u=this.justify,d=this.textPathLoop,f=this.constantPathSpeed;for(e=0,i=a.length;e<i;e++){switch(t=a[e],s=h[e],u){case"center":n=l+s/2/o,t[7]=-s/2;break;case"right":n=l+s/o,t[7]=-s;break;default:n=l}d&&(n>1||n<0)&&(n=n>.5?n-1:n+1),t[10]=n<=1&&n>=0&&r.getPathPositionData(n,f),t[9]=s,c?l+=s/o:l-=s/o,d&&(l>1||l<0)&&(l=l>.5?l-1:l+1)}},hs.preStamper=function(t,e,i,s){const n=function(e){return e.getData?e.getData(i,t):e};let[r,o,a,h,c,l,...u]=s;if(r&&(e.font=r),h||c||l){let t=i.highlightStyle,s=i.textHeight,r=i.underlineStyle,o=i.underlinePosition,a=i.overlineStyle,d=i.overlinePosition;e.save(),h&&(e.fillStyle=n(t),e.fillRect(u[1],u[2],u[3],s)),c&&(e.strokeStyle=n(r),e.strokeRect(u[1],u[2]+s*o,u[3],1)),l&&(e.strokeStyle=n(a),e.strokeRect(u[1],u[2]+s*d,u[3],1)),e.restore()}return o&&(e.strokeStyle=n(o)),a&&(e.fillStyle=n(a)),u},hs.stamper={draw:function(t,e,i){t.strokeText(...i)},fill:function(t,e,i){t.fillText(...i)},drawAndFill:function(t,e,i){t.strokeText(...i),e.currentHost.clearShadow(),t.fillText(...i),e.currentHost.restoreShadow(e)},fillAndDraw:function(t,e,i){t.strokeText(...i),e.currentHost.clearShadow(),t.fillText(...i),t.strokeText(...i),e.currentHost.restoreShadow(e)},drawThenFill:function(t,e,i){t.strokeText(...i),t.fillText(...i)},fillThenDraw:function(t,e,i){t.fillText(...i),t.strokeText(...i)},clear:function(t,e,i){let s=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fillText(...i),t.globalCompositeOperation=s}},hs.drawBoundingBox=function(t){t.save(),t.strokeStyle=this.boundingBoxColor,t.lineWidth=1,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.stroke(this.pathObject),t.restore()},hs.performRotation=function(t){let e=this.currentHost;if(e){let[i,s]=this.currentStampPosition;e.rotateDestination(t,i,s,this)}};g.Phrase=Phrase;const Picture=function(t={}){return this.copyStart=Bt(),this.currentCopyStart=Bt(),this.copyDimensions=Bt(),this.currentCopyDimensions=Bt(),this.copyArray=[],this.pasteArray=[],this.entityInit(t),t.copyStart||(t.copyStartX||(this.copyStart[0]=0),t.copyStartY||(this.copyStart[1]=0)),t.copyDimensions||(t.copyWidth||(this.copyDimensions[0]=1),t.copyHeight||(this.copyDimensions[1]=1)),this.imageSubscribers=[],this.dirtyCopyStart=!0,this.dirtyCopyDimensions=!0,this.dirtyImage=!0,this};let ds=Picture.prototype=Object.create(Object.prototype);ds.type="Picture",ds.lib="entity",ds.isArtefact=!0,ds.isAsset=!1,ds=nt(ds),ds=di(ds),ds=Zi(ds);ds.defs=Y(ds.defs,{copyStart:null,copyDimensions:null,checkHitIgnoreTransparency:!1}),ds.packetCoordinates=N(ds.packetCoordinates,["copyStart","copyDimensions"]),ds.packetObjects=N(ds.packetObjects,["asset"]),ds.kill=function(){return this.asset.unsubscribe(this),this.group&&this.group.name&&this.group.removeArtefacts(this.name),this.demolishAnchor(),this.deregister(),this};let fs=ds.getters,ps=ds.setters,ms=ds.deltaSetters;fs.copyStartX=function(){return this.currentCopyStart[0]},fs.copyStartY=function(){return this.currentCopyStart[1]},ps.copyStartX=function(t){null!=t&&(this.copyStart[0]=t,this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0)},ps.copyStartY=function(t){null!=t&&(this.copyStart[1]=t,this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0)},ps.copyStart=function(t,e){this.setCoordinateHelper("copyStart",t,e),this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0},ms.copyStartX=function(t){let e=this.copyStart;e[0]=A(e[0],t),this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0},ms.copyStartY=function(t){let e=this.copyStart;e[1]=A(e[1],t),this.dirtyCopyStart=!0},ms.copyStart=function(t,e){this.setDeltaCoordinateHelper("copyStart",t,e),this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0},fs.copyWidth=function(){return this.currentCopyDimensions[0]},fs.copyHeight=function(){return this.currentCopyDimensions[1]},ps.copyWidth=function(t){null!=t&&(this.copyDimensions[0]=t,this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0)},ps.copyHeight=function(t){null!=t&&(this.copyDimensions[1]=t,this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0)},ps.copyDimensions=function(t,e){this.setCoordinateHelper("copyDimensions",t,e),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},ms.copyWidth=function(t){let e=this.copyDimensions;e[0]=A(e[0],t),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},ms.copyHeight=function(t){let e=this.copyDimensions;e[1]=A(e[1],t),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},ms.copyDimensions=function(t,e){this.setDeltaCoordinateHelper("copyDimensions",t,e),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},ps.checkHitIgnoreTransparency=function(t){this.checkHitIgnoreTransparency=t,t&&(this.stashOutput=!0)},ds.get=function(t){let e=this.source;if(0!==t.indexOf("video_")&&0!==t.indexOf("image_")||!e){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}}return Wi.indexOf(t)>=0||zt.indexOf(t)>=0?e[t.substring(6)]:void 0},ds.set=function(t={}){if(t){let e=this.setters,i=this.defs,s=this.state,n=this.source,r=s?s.setters:{},o=s?s.defs:{};Object.entries(t).forEach(([t,a])=>{if(0!==t.indexOf("video_")&&0!==t.indexOf("image_")||!n){if(t&&"name"!==t&&null!=a){let n=e[t],h=!1;n||(n=r[t],h=!0),n?n.call(h?this.state:this,a):void 0!==i[t]?this[t]=a:void 0!==o[t]&&(s[t]=a)}}else(qi.indexOf(t)>=0||It.indexOf(t)>=0)&&(n[t.substring(6)]=a)},this)}return this},ds.updateImageSubscribers=function(){this.dirtyImageSubscribers=!1,this.imageSubscribers.length&&this.imageSubscribers.forEach(t=>{let e=i[t];e&&(e.dirtyInput=!0)})},ds.imageSubscribe=function(t){t&&t.substring&&N(this.imageSubscribers,t)},ds.imageUnsubscribe=function(t){t&&t.substring&&W(this.imageSubscribers,t)},ds.cleanImage=function(){let t=this.sourceNaturalWidth,e=this.sourceNaturalHeight;if(V(t,e)){this.dirtyImage=!1;let i=this.currentCopyStart,s=i[0],n=i[1],r=this.currentCopyDimensions,o=r[0],a=r[1];s+o>t&&(i[0]=t-o),n+a>e&&(i[1]=e-a);let h=this.copyArray;h.length=0,h.push(i[0],i[1],o,a)}},ds.cleanCopyStart=function(){let t=this.sourceNaturalWidth,e=this.sourceNaturalHeight;if(V(t,e)){this.dirtyCopyStart=!1,this.cleanPosition(this.currentCopyStart,this.copyStart,[t,e]);let i=this.currentCopyStart,s=i[0],n=i[1];(s<0||s>t)&&(i[0]=s<0?0:t-1),(n<0||n>e)&&(i[1]=n<0?0:e-1),this.dirtyImage=!0}},ds.cleanCopyDimensions=function(){let t=this.sourceNaturalWidth,e=this.sourceNaturalHeight;if(V(t,e)){this.dirtyCopyDimensions=!1;let i=this.copyDimensions,s=this.currentCopyDimensions,n=i[0],r=i[1];n.substring?s[0]=parseFloat(n)/100*t:s[0]=n,r.substring?s[1]=parseFloat(r)/100*e:s[1]=r;let o=s[0],a=s[1];(o<=0||o>t)&&(s[0]=o<=0?1:t),(a<=0||a>e)&&(s[1]=a<=0?1:e),this.dirtyImage=!0}},ds.prepareStamp=function(){this.dirtyAsset&&this.cleanAsset(),this.asset&&("Sprite"===this.asset.type?this.checkSpriteFrame(this):this.asset.checkSource?this.asset.checkSource(this.sourceNaturalWidth,this.sourceNaturalHeight):this.dirtyAsset=!0),(this.dirtyDimensions||this.dirtyHandle||this.dirtyScale)&&(this.dirtyPaste=!0),(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle)&&(this.dirtyPathObject=!0),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyCopyStart&&this.cleanCopyStart(),this.dirtyCopyDimensions&&this.cleanCopyDimensions(),this.dirtyImage&&this.cleanImage(),this.dirtyPaste&&this.preparePasteObject(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers(),this.dirtyImageSubscribers&&this.updateImageSubscribers()},ds.preparePasteObject=function(){this.dirtyPaste=!1;let t=this.currentStampHandlePosition,e=this.currentDimensions,i=this.currentScale,s=-t[0]*i,n=-t[1]*i,r=e[0]*i,o=e[1]*i,a=this.pasteArray;a.length=0,a.push(s,n,r,o),this.dirtyPathObject=!0},ds.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){this.pasteArray||this.preparePasteObject(),(this.pathObject=new Path2D).rect(...this.pasteArray)}},ds.draw=function(t){t.stroke(this.pathObject)},ds.fill=function(t){this.source&&t.drawImage(this.source,...this.copyArray,...this.pasteArray)},ds.drawAndFill=function(t){t.stroke(this.pathObject),this.source&&(this.currentHost.clearShadow(),t.drawImage(this.source,...this.copyArray,...this.pasteArray))},ds.fillAndDraw=function(t){t.stroke(this.pathObject),this.source&&(this.currentHost.clearShadow(),t.drawImage(this.source,...this.copyArray,...this.pasteArray)),t.stroke(this.pathObject)},ds.drawThenFill=function(t){t.stroke(this.pathObject),this.source&&t.drawImage(this.source,...this.copyArray,...this.pasteArray)},ds.fillThenDraw=function(t){this.source&&t.drawImage(this.source,...this.copyArray,...this.pasteArray),t.stroke(this.pathObject)},ds.checkHitReturn=function(t,e,i){if(this.checkHitIgnoreTransparency&&i&&i.engine){let[s,n,r,o]=this.copyArray,[a,h,c,l]=this.pasteArray,[u,d]=this.currentStampPosition,f=4*((e-d)*c+(t-u))+3;return!!i.engine.getImageData(s,n,r,o).data[f]&&{x:t,y:e,artefact:this}}return{x:t,y:e,artefact:this}};g.Picture=Picture;const Polygon=function(t={}){return this.shapeInit(t),this};let gs=Polygon.prototype=Object.create(Object.prototype);gs.type="Polygon",gs.lib="entity",gs.isArtefact=!0,gs.isAsset=!1,gs=nt(gs),gs=Pi(gs);gs.defs=Y(gs.defs,{sides:0,radius:0});let ys=gs.setters,bs=gs.deltaSetters;ys.sides=function(t){this.sides=t,this.updateDirty()},bs.sides=function(t){this.sides+=t,this.updateDirty()},ys.radius=function(t){this.radius=t,this.updateDirty()},bs.radius=function(t){this.radius+=t,this.updateDirty()},gs.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makePolygonPath(),this.pathDefinition=t},gs.makePolygonPath=function(){let t,e,i,s=this.radius,n=this.sides,r=360/n,o="",a=[],h=0,c=fe({x:0,y:-s});for(let t=0;t<n;t++)c.rotate(r),h+=c.y,a.push(h),o+=`${c.x.toFixed(1)},${c.y.toFixed(1)} `;return pe(c),e=Math.min(...a),t=Math.max(...a),i=((Math.abs(e)+Math.abs(t)-s)/2).toFixed(1),o=`m0,${i}l${o}z`,o};g.Polygon=Polygon;const Polyline=function(t={}){return this.pins=[],this.currentPins=[],this.controlledLineOffset=Bt(),this.shapeInit(t),this};let Ps=Polyline.prototype=Object.create(Object.prototype);Ps.type="Polyline",Ps.lib="entity",Ps.isArtefact=!0,Ps.isAsset=!1,Ps=nt(Ps),Ps=Pi(Ps);Ps.defs=Y(Ps.defs,{pins:null,tension:0,closed:!1,mapToPins:!1}),Ps.packetExclusions=N(Ps.packetExclusions,["controlledLineOffset"]),Ps.packetExclusionsByRegex=N(Ps.packetExclusionsByRegex,[]),Ps.packetCoordinates=N(Ps.packetCoordinates,[]),Ps.packetObjects=N(Ps.packetObjects,[]),Ps.packetFunctions=N(Ps.packetFunctions,[]),Ps.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=Y(t,i),t=this.handlePacketAnchor(t,e),Object.keys(t).forEach(e=>{if("pins"===e){let e=[];t.pins.forEach(t=>{I(t)?e.push(t.name):Array.isArray(t)?e.push([].concat(t)):e.push(t)}),t.pins=e}}),t};let Ss=Ps.getters,vs=Ps.setters,ks=Ps.deltaSetters;Ss.pins=function(t){return q(t)?this.getPinAt(t):this.currentPins.concat()},vs.pins=function(t){if(q(t)){let e=this.pins;if(Array.isArray(t))e.forEach((t,e)=>this.removePinAt(e)),e.length=0,e.push(...t),this.updateDirty();else if(I(t)&&q(t.index)){let i=e[t.index];Array.isArray(i)&&(q(t.x)&&(i[0]=t.x),q(t.y)&&(i[1]=t.y),this.updateDirty())}}},ks.pins=function(t){if(q(t)){let e=this.pins;if(I(t)&&q(t.index)){let i=e[t.index];Array.isArray(i)&&(q(t.x)&&(i[0]=addStrings(i[0],t.x)),q(t.y)&&(i[1]=addStrings(i[1],t.y)),this.updateDirty())}}},vs.tension=function(t){t.toFixed&&(this.tension=t,this.updateDirty())},ks.tension=function(t){t.toFixed&&(this.tension+=t,this.updateDirty())},vs.closed=function(t){this.closed=t,this.updateDirty()},vs.mapToPins=function(t){this.mapToPins=t,this.updateDirty()},vs.flipUpend=function(t){this.flipUpend=t,this.updateDirty()},vs.flipReverse=function(t){this.flipReverse=t,this.updateDirty()},vs.useAsPath=function(t){this.useAsPath=t,this.updateDirty()},vs.pivot=function(t){if(B(t)&&!t)this.pivot=null,"pivot"===this.lockTo[0]&&(this.lockTo[0]="start"),"pivot"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.pivot,s=t.substring?i[t]:t,n=this.name;s&&s.name&&(e&&e.name!==s.name&&W(e.pivoted,n),N(s.pivoted,n),this.pivot=s,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}this.updateDirty()},Ps.updateDirty=function(){this.dirtySpecies=!0,this.dirtyPathObject=!0,this.dirtyPins=!0},Ps.getPinAt=function(t,e){let i=Math.floor(t);if(this.useAsPath){let t=this.getPathPositionData(this.unitPartials[i]);if(e){if("x"===e)return t.x;if("y"===e)return t.y}return[t.x,t.y]}{let t,s,n=this.currentPins,r=n[i],[o,a,h,c]=this.localBox,[l,u]=r,[d,f]=n[0],[p,m]=this.localOffset,[g,y]=this.currentStampPosition;if(this.mapToPins?(t=l-d+o,s=u-d+a):(t=l-p,s=u-m),e){if("x"===e)return g+t;if("y"===e)return y+s}return[g+t,y+s]}},Ps.updatePinAt=function(t,e){if(V(t,e)){e=Math.floor(e);let i=this.pins;if(e<i.length&&e>=0){let s=i[e];I(s)&&s.pivoted&&W(s.pivoted,this.name),i[e]=t,this.updateDirty()}}},Ps.removePinAt=function(t){t=Math.floor(t);let e=this.pins;if(t<e.length&&t>=0){let i=e[t];I(i)&&i.pivoted&&W(i.pivoted,this.name),e[t]=null,this.updateDirty()}},Ps.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1),(this.dirtyPins||this.dirtyLock)&&(this.dirtySpecies=!0),(this.dirtyScale||this.dirtySpecies||this.dirtyDimensions||this.dirtyStart||this.dirtyHandle)&&(this.dirtyPathObject=!0,(this.dirtyScale||this.dirtySpecies)&&(this.pathCalculatedOnce=!1)),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0),this.dirtyScale&&this.cleanScale(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyRotation&&this.cleanRotation(),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtySpecies&&this.cleanSpecies(),this.dirtyPathObject&&(this.cleanPathObject(),this.updatePathSubscribers()),this.dirtyPositionSubscribers&&this.updatePositionSubscribers()},Ps.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makePolylinePath(),this.pathDefinition=t},Ps.getPathParts=function(t,e,i,s,n,r,o){let a=Math.sqrt,h=Math.pow,c=a(h(i-t,2)+h(s-e,2)),l=a(h(n-i,2)+h(r-s,2)),u=o*c/(c+l),d=o*l/(c+l);return[i-u*(n-t),s-u*(r-e),i,s,i+d*(n-t),s+d*(r-e)]},Ps.buildLine=function(t,e,i){let s="m0,0l";for(let n=2;n<i.length;n+=6)s+=`${i[n]-t},${i[n+1]-e} `,t=i[n],e=i[n+1];return s},Ps.buildCurve=function(t,e,i){let s="m0,0c",n=0;for(let r=0;r<i.length;r+=2)s+=`${i[r]-t},${i[r+1]-e} `,n++,n>2&&(t=i[r],e=i[r+1],n=0);return s},Ps.cleanCoordinate=function(t,e){return t.toFixed?t:"left"===t||"top"===t?0:"right"===t||"bottom"===t?e:"center"===t?e/2:parseFloat(t)/100*e},Ps.cleanPinsArray=function(){this.dirtyPins=!1;let t=this.pins,e=this.currentPins;e.length=0;let s,n,r=1,o=1,a=this.getHere(),h=this.cleanCoordinate;V(a,a.w,a.h)&&(r=a.w,o=a.h),t.forEach((a,c)=>{let l;if(a&&a.substring?(l=i[a],t[c]=l):l=a,l)if(Array.isArray(l))[s,n]=l,e.push([h(s,r),h(n,o)]);else if(I(l)&&l.currentStart){let t=this.name;l.pivoted.indexOf(t)<0&&N(l.pivoted,t),e.push([...l.currentStampPosition])}});let c=e[0][0],l=e[0][1];e.forEach(t=>{t[0]<c&&(c=t[0]),t[1]<l&&(l=t[1])}),this.localOffset=[c,l],this.updatePivotSubscribers()},Ps.makePolylinePath=function(){let t=this.getPathParts,e=this.buildLine,i=this.buildCurve,s=(this.pins,this.currentPins),n=this.tension,r=this.closed;this.dirtyPins&&this.cleanPinsArray();let o=s.length,a=s[0],h=s[o-1],c=[],l="m0,0";if(r){let r=[].concat(...t(...h,...a,...s[1],n));for(let e=0;e<o-2;e++)c=c.concat(...t(...s[e],...s[e+1],...s[e+2],n));c=c.concat(...t(...s[o-2],...h,...a,n)),c.unshift(r[4],r[5]),c.push(r[0],r[1],r[2],r[3]),l=n?i(a[0],a[1],c)+"z":e(a[0],a[1],c)+"z"}else{c.push(a[0],a[1]);for(let e=0;e<o-2;e++)c=c.concat(...t(...s[e],...s[e+1],...s[e+2],n));c.push(h[0],h[1],h[0],h[1]),l=n?i(a[0],a[1],c):e(a[0],a[1],c)}return l},Ps.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox,n=this.pathDefinition;this.mapToPins?this.set({start:this.currentPins[0]}):this.pathDefinition=n.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)},Ps.updatePathSubscribers=function(){this.pathed.forEach(t=>{let e=i[t];e&&(e.dirtyStart=!0)})};g.Polyline=Polyline;const Quadratic=function(t={}){return this.control=Bt(),this.currentControl=Bt(),this.controlLockTo="coord",this.curveInit(t),this.shapeInit(t),this.dirtyControl=!0,this};let xs=Quadratic.prototype=Object.create(Object.prototype);xs.type="Quadratic",xs.lib="entity",xs.isArtefact=!0,xs.isAsset=!1,xs=nt(xs),xs=Pi(xs),xs=vi(xs);xs.defs=Y(xs.defs,{control:null,controlPivot:"",controlPivotCorner:"",addControlPivotHandle:!1,addControlPivotOffset:!1,controlPath:"",controlPathPosition:0,addControlPathHandle:!1,addControlPathOffset:!0,controlLockTo:""}),xs.packetExclusions=N(xs.packetExclusions,[]),xs.packetExclusionsByRegex=N(xs.packetExclusionsByRegex,[]),xs.packetCoordinates=N(xs.packetCoordinates,["control"]),xs.packetObjects=N(xs.packetObjects,["controlPivot","controlPath"]),xs.packetFunctions=N(xs.packetFunctions,[]);xs.getters;let ws=xs.setters,Cs=xs.deltaSetters;ws.controlPivot=function(t){this.setControlHelper(t,"controlPivot","control"),this.updateDirty(),this.dirtyControl=!0},ws.controlPath=function(t){this.setControlHelper(t,"controlPath","control"),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},ws.controlPathPosition=function(t){this.controlPathPosition=t,this.dirtyControl=!0,this.currentControlPathData=!1},Cs.controlPathPosition=function(t){this.controlPathPosition+=t,this.dirtyControl=!0,this.currentControlPathData=!1},ws.controlX=function(t){null!=t&&(this.control[0]=t,this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1)},ws.controlY=function(t){null!=t&&(this.control[1]=t,this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1)},ws.control=function(t,e){this.setCoordinateHelper("control",t,e),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},Cs.controlX=function(t){let e=this.control;e[0]=A(e[0],t),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},Cs.controlY=function(t){let e=this.control;e[1]=A(e[1],t),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},Cs.control=function(t,e){this.setDeltaCoordinateHelper("control",t,e),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},ws.controlLockTo=function(t){this.controlLockTo=t,this.updateDirty(),this.dirtyControlLock=!0,this.currentControlPathData=!1},xs.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeQuadraticPath(),this.pathDefinition=t},xs.makeQuadraticPath=function(){let[t,e]=this.currentStampPosition,[i,s]=this.currentControl,[n,r]=this.currentEnd;return`m0,0q${(i-t).toFixed(2)},${(s-e).toFixed(2)} ${(n-t).toFixed(2)},${(r-e).toFixed(2)}`},xs.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyHandle=!0,this.dirtyOffset=!0,this.dirtyStart=!0,this.dirtyControl=!0,this.dirtyEnd=!0},xs.preparePinsForStamp=function(){let t=this.endPivot,e=this.endPath,i=this.controlPivot,s=this.controlPath;this.dirtyPins.forEach(n=>{(i&&i.name===n||s&&s.name===n)&&(this.dirtyControl=!0,this.controlLockTo.includes("path")&&(this.currentControlPathData=!1)),(t&&t.name===n||e&&e.name===n)&&(this.dirtyEnd=!0,this.endLockTo.includes("path")&&(this.currentEndPathData=!1))}),this.dirtyPins.length=0};g.Quadratic=Quadratic;const RadialGradient=function(t={}){return this.stylesInit(t),this};let Os=RadialGradient.prototype=Object.create(Object.prototype);Os.type="RadialGradient",Os.lib="styles",Os.isArtefact=!1,Os.isAsset=!1,Os=nt(Os),Os=Ei(Os);Os.defs=Y(Os.defs,{startRadius:0,endRadius:0}),Os.packetObjects=N(Os.packetObjects,["palette"]);let Ds=Os.getters,As=Os.setters,Es=Os.deltaSetters;Ds.startRadius=function(t){return this.currentStartRadius},Ds.endRadius=function(t){return this.currentEndRadius},As.startRadius=function(t){this.startRadius=t,this.dirtyStyle=!0},As.endRadius=function(t){this.endRadius=t,this.dirtyStyle=!0},Es.startRadius=function(t){this.startRadius=A(this.startRadius,t),this.dirtyStyle=!0},Es.endRadius=function(t){this.endRadius=A(this.endRadius,t),this.dirtyStyle=!0},Os.cleanRadius=function(t){const e=(t,e)=>{if(z(t))return t;switch(t){case"top":case"left":return 0;case"bottom":case"right":return e;case"center":return e/2;default:return t=parseFloat(t),z(t)?t/100*e:0}};this.currentStartRadius=t?e(this.startRadius,t):this.defs.startRadius,this.currentEndRadius=t?e(this.endRadius,t):this.defs.endRadius},Os.buildStyle=function(t={}){if(t){let e=t.engine;if(e){let t=e.createRadialGradient(...this.gradientArgs);return this.addStopsToGradient(t,this.paletteStart,this.paletteEnd,this.cyclePalette)}}return"rgba(0,0,0,0)"},Os.updateGradientArgs=function(t,e){let i=this.gradientArgs,s=this.currentStart,n=this.currentEnd,r=this.currentStartRadius,o=this.currentEndRadius,a=s[0]+t,h=s[1]+e,c=n[0]+t,l=n[1]+e;a===c&&h===l&&r===o&&o++,i.length=0,i.push(a,h,r,c,l,o)};g.RadialGradient=RadialGradient;const Rectangle=function(t={}){return this.shapeInit(t),this.currentRectangleWidth=1,this.currentRectangleHeight=1,this};let Ts=Rectangle.prototype=Object.create(Object.prototype);Ts.type="Rectangle",Ts.lib="entity",Ts.isArtefact=!0,Ts.isAsset=!1,Ts=nt(Ts),Ts=Pi(Ts);Ts.defs=Y(Ts.defs,{rectangleWidth:10,rectangleHeight:10,radiusTLX:0,radiusTLY:0,radiusTRX:0,radiusTRY:0,radiusBRX:0,radiusBRY:0,radiusBLX:0,radiusBLY:0,offshootA:.55,offshootB:0});let Hs=Ts.setters,Rs=Ts.deltaSetters;Hs.radius=function(t){this.setRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX","radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},Hs.radiusX=function(t){this.setRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX"])},Hs.radiusY=function(t){this.setRectHelper(t,["radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},Hs.radiusT=function(t){this.setRectHelper(t,["radiusTLX","radiusTLY","radiusTRX","radiusTRY"])},Hs.radiusB=function(t){this.setRectHelper(t,["radiusBRX","radiusBRY","radiusBLX","radiusBLY"])},Hs.radiusL=function(t){this.setRectHelper(t,["radiusTLX","radiusTLY","radiusBLX","radiusBLY"])},Hs.radiusR=function(t){this.setRectHelper(t,["radiusTRX","radiusTRY","radiusBRX","radiusBRY"])},Hs.radiusTX=function(t){this.setRectHelper(t,["radiusTLX","radiusTRX"])},Hs.radiusBX=function(t){this.setRectHelper(t,["radiusBRX","radiusBLX"])},Hs.radiusLX=function(t){this.setRectHelper(t,["radiusTLX","radiusBLX"])},Hs.radiusRX=function(t){this.setRectHelper(t,["radiusTRX","radiusBRX"])},Hs.radiusTY=function(t){this.setRectHelper(t,["radiusTLY","radiusTRY"])},Hs.radiusBY=function(t){this.setRectHelper(t,["radiusBRY","radiusBLY"])},Hs.radiusLY=function(t){this.setRectHelper(t,["radiusTLY","radiusBLY"])},Hs.radiusRY=function(t){this.setRectHelper(t,["radiusTRY","radiusBRY"])},Hs.radiusTL=function(t){this.setRectHelper(t,["radiusTLX","radiusTLY"])},Hs.radiusTR=function(t){this.setRectHelper(t,["radiusTRX","radiusTRY"])},Hs.radiusBL=function(t){this.setRectHelper(t,["radiusBLX","radiusBLY"])},Hs.radiusBR=function(t){this.setRectHelper(t,["radiusBRX","radiusBRY"])},Hs.radiusTLX=function(t){this.setRectHelper(t,["radiusTLX"])},Hs.radiusTLY=function(t){this.setRectHelper(t,["radiusTLY"])},Hs.radiusTRX=function(t){this.setRectHelper(t,["radiusTRX"])},Hs.radiusTRY=function(t){this.setRectHelper(t,["radiusTRY"])},Hs.radiusBRX=function(t){this.setRectHelper(t,["radiusBRX"])},Hs.radiusBRY=function(t){this.setRectHelper(t,["radiusBRY"])},Hs.radiusBLX=function(t){this.setRectHelper(t,["radiusBLX"])},Hs.radiusBLY=function(t){this.setRectHelper(t,["radiusBLY"])},Rs.radius=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX","radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},Rs.radiusX=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX"])},Rs.radiusY=function(t){this.deltaRectHelper(t,["radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},Rs.radiusT=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTLY","radiusTRX","radiusTRY"])},Rs.radiusB=function(t){this.deltaRectHelper(t,["radiusBRX","radiusBRY","radiusBLX","radiusBLY"])},Rs.radiusL=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTLY","radiusBLX","radiusBLY"])},Rs.radiusR=function(t){this.deltaRectHelper(t,["radiusTRX","radiusTRY","radiusBRX","radiusBRY"])},Rs.radiusTX=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTRX"])},Rs.radiusBX=function(t){this.deltaRectHelper(t,["radiusBRX","radiusBLX"])},Rs.radiusLX=function(t){this.deltaRectHelper(t,["radiusTLX","radiusBLX"])},Rs.radiusRX=function(t){this.deltaRectHelper(t,["radiusTRX","radiusBRX"])},Rs.radiusTY=function(t){this.deltaRectHelper(t,["radiusTLY","radiusTRY"])},Rs.radiusBY=function(t){this.deltaRectHelper(t,["radiusBRY","radiusBLY"])},Rs.radiusLY=function(t){this.deltaRectHelper(t,["radiusTLY","radiusBLY"])},Rs.radiusRY=function(t){this.deltaRectHelper(t,["radiusTRY","radiusBRY"])},Rs.radiusTL=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTLY"])},Rs.radiusTR=function(t){this.deltaRectHelper(t,["radiusTRX","radiusTRY"])},Rs.radiusBL=function(t){this.deltaRectHelper(t,["radiusBLX","radiusBLY"])},Rs.radiusBR=function(t){this.deltaRectHelper(t,["radiusBRX","radiusBRY"])},Rs.radiusTLX=function(t){this.deltaRectHelper(t,["radiusTLX"])},Rs.radiusTLY=function(t){this.deltaRectHelper(t,["radiusTLY"])},Rs.radiusTRX=function(t){this.deltaRectHelper(t,["radiusTRX"])},Rs.radiusTRY=function(t){this.deltaRectHelper(t,["radiusTRY"])},Rs.radiusBRX=function(t){this.deltaRectHelper(t,["radiusBRX"])},Rs.radiusBRY=function(t){this.deltaRectHelper(t,["radiusBRY"])},Rs.radiusBLX=function(t){this.deltaRectHelper(t,["radiusBLX"])},Rs.radiusBLY=function(t){this.deltaRectHelper(t,["radiusBLY"])},Hs.offshootA=function(t){this.offshootA=t,this.updateDirty()},Hs.offshootB=function(t){this.offshootB=t,this.updateDirty()},Rs.offshootA=function(t){t.toFixed&&(this.offshootA+=t,this.updateDirty())},Rs.offshootB=function(t){t.toFixed&&(this.offshootB+=t,this.updateDirty())},Hs.rectangleWidth=function(t){null!=t&&(this.rectangleWidth=t,this.dirtyDimensions=!0)},Hs.rectangleHeight=function(t){null!=t&&(this.rectangleHeight=t,this.dirtyDimensions=!0)},Rs.rectangleWidth=function(t){this.rectangleWidth=A(this.rectangleWidth,t),this.dirtyDimensions=!0},Rs.rectangleHeight=function(t){this.rectangleHeight=A(this.rectangleHeight,t),this.dirtyDimensions=!0},Ts.setRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=t},this)},Ts.deltaRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=A(this[e],t)},this)},Ts.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeRectanglePath(),this.pathDefinition=t},Ts.cleanDimensions=function(){let t=this.getHost();if(t){let e=t.currentDimensions?t.currentDimensions:[t.w,t.h],i=this.rectangleWidth,s=this.rectangleHeight,n=this.currentRectangleWidth||1,r=this.currentRectangleHeight||1;i.substring&&(i=parseFloat(i)/100*e[0]),s.substring&&(s=parseFloat(s)/100*e[1]);let o,a=this.mimic;a&&a.name&&this.useMimicDimensions&&(o=a.currentDimensions),o?(this.currentRectangleWidth=this.addOwnDimensionsToMimic?o[0]+i:o[0],this.currentRectangleHeight=this.addOwnDimensionsToMimic?o[1]+s:o[1]):(this.currentRectangleWidth=i,this.currentRectangleHeight=s),this.currentDimensions[0]=this.currentRectangleWidth,this.currentDimensions[1]=this.currentRectangleHeight,this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyOffset=!0,n===this.currentRectangleWidth&&r===this.currentRectangleHeight||(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicDimensions=!0)}else this.dirtyDimensions=!0},Ts.makeRectanglePath=function(){this.dirtyDimensions&&this.cleanDimensions();let t=this.currentRectangleWidth,e=this.currentRectangleHeight,i=this.offshootA,s=this.offshootB,n=this.radiusTLX,r=this.radiusTLY,o=this.radiusTRX,a=this.radiusTRY,h=this.radiusBRX,c=this.radiusBRY,l=this.radiusBLX,u=this.radiusBLY;(n.substring||r.substring||o.substring||a.substring||h.substring||c.substring||l.substring||u.substring)&&(n=n.substring?parseFloat(n)/100*t:n,r=r.substring?parseFloat(r)/100*e:r,o=o.substring?parseFloat(o)/100*t:o,a=a.substring?parseFloat(a)/100*e:a,h=h.substring?parseFloat(h)/100*t:h,c=c.substring?parseFloat(c)/100*e:c,l=l.substring?parseFloat(l)/100*t:l,u=u.substring?parseFloat(u)/100*e:u);let d="m0,0";return t-n-o!=0&&(d+="h"+(t-n-o)),o+a!==0&&(d+=`c${o*i},${a*s} ${o-o*s},${a-a*i}, ${o},${a}`),e-a-c!=0&&(d+="v"+(e-a-c)),h+c!==0&&(d+=`c${-h*s},${c*i} ${h*i-h},${c-c*s} ${-h},${c}`),-t+l+h!==0&&(d+="h"+(-t+l+h)),l+u!==0&&(d+=`c${-l*i},${-u*s} ${l*s-l},${u*i-u} ${-l},${-u}`),-e+r+u!==0&&(d+="v"+(-e+r+u)),n+r!==0&&(d+=`c${n*s},${-r*i} ${n-n*i},${r*s-r} ${n},${-r}`),d+="z",d},Ts.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};g.Rectangle=Rectangle;const Shape=function(t={}){return this.shapeInit(t),this};let Fs=Shape.prototype=Object.create(Object.prototype);Fs.type="Shape",Fs.lib="entity",Fs.isArtefact=!0,Fs.isAsset=!1,Fs=nt(Fs),Fs=Pi(Fs);Fs.defs=Y(Fs.defs,{}),Fs.cleanSpecies=function(){this.dirtySpecies=!1},Fs.cleanStampHandlePositionsAdditionalActions=function(){let t=this.localBox,e=this.currentStampHandlePosition;e[0]+=t[0],e[1]+=t[1]};g.Shape=Shape;const Spiral=function(t={}){return this.shapeInit(t),this};let Bs=Spiral.prototype=Object.create(Object.prototype);Bs.type="Spiral",Bs.lib="entity",Bs.isArtefact=!0,Bs.isAsset=!1,Bs=nt(Bs),Bs=Pi(Bs);Bs.defs=Y(Bs.defs,{loops:1,loopIncrement:1,drawFromLoop:0});let js=Bs.setters,Ls=Bs.deltaSetters;js.loops=function(t){this.loops=t,this.updateDirty()},Ls.loops=function(t){this.loops+=t,this.updateDirty()},js.loopIncrement=function(t){this.loopIncrement=t,this.updateDirty()},Ls.loopIncrement=function(t){this.loopIncrement+=t,this.updateDirty()},js.drawFromLoop=function(t){this.drawFromLoop=Math.floor(t),this.updateDirty()},Ls.drawFromLoop=function(t){this.drawFromLoop=Math.floor(this.drawFromLoop+t),this.updateDirty()},Bs.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeSpiralPath(),this.pathDefinition=t},Bs.firstTurn=[[.043,0,.082,-.035,.088,-.088],[.007,-.057,-.024,-.121,-.088,-.162],[-.07,-.045,-.169,-.054,-.265,-.015],[-.106,.043,-.194,.138,-.235,.265],[-.044,.139,-.026,.3,.058,.442],[.091,.153,.25,.267,.442,.308],[.206,.044,.431,-.001,.619,-.131],[.2,-.139,.34,-.361,.381,-.619]],Bs.subsequentTurns=[[0,-.27,-.11,-.52,-.29,-.71],[-.19,-.19,-.44,-.29,-.71,-.29],[-.27,0,-.52,.11,-.71,.29],[-.19,.19,-.29,.44,-.29,.71],[0,.27,.11,.52,.29,.71],[.19,.19,.44,.29,.71,.29],[.27,0,.52,-.11,.71,-.29],[.19,-.19,.29,-.44,.29,-.71]],Bs.makeSpiralPath=function(){let t,e,i,s,n,r,o,a,h,c,l,u,d=Math.floor(this.loops),f=this.loopIncrement,p=Math.floor(this.drawFromLoop),m=this.firstTurn,g=this.subsequentTurns,y=[];for(let o=0;o<m.length;o++)[t,e,i,s,n,r]=m[o],y.push([t*f,e*f,i*f,s*f,n*f,r*f]);let b="m0,0";for(let m=0;m<d;m++)for(let d=0;d<y.length;d++)[t,e,i,s,n,r]=y[d],m>=p&&(b+=`c${t},${e} ${i},${s} ${n},${r}`),[o,a,h,c,l,u]=g[d],y[d]=[t+o*f,e+a*f,i+h*f,s+c*f,n+l*f,r+u*f];return b},Bs.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox,n=this.scale;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t/n},${-e/n}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};g.Spiral=Spiral;const Star=function(t={}){return this.shapeInit(t),this};let Ms=Star.prototype=Object.create(Object.prototype);Ms.type="Star",Ms.lib="entity",Ms.isArtefact=!0,Ms.isAsset=!1,Ms=nt(Ms),Ms=Pi(Ms);Ms.defs=Y(Ms.defs,{radius1:0,radius2:0,points:0,twist:0});let zs=Ms.setters,Is=Ms.deltaSetters;zs.radius1=function(t){this.radius1=t,this.updateDirty()},Is.radius1=function(t){this.radius1+=t,this.updateDirty()},zs.radius2=function(t){this.radius2=t,this.updateDirty()},Is.radius2=function(t){this.radius2+=t,this.updateDirty()},zs.points=function(t){this.points=t,this.updateDirty()},Is.points=function(t){this.points+=t,this.updateDirty()},zs.twist=function(t){this.twist=t,this.updateDirty()},Is.twist=function(t){this.twist+=t,this.updateDirty()},Ms.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeStarPath(),this.pathDefinition=t},Ms.makeStarPath=function(){let t,e,i,s,n,r,o,a=this.points,h=this.twist,c=this.radius1,l=this.radius2,u=360/a,d=[],f="",p=fe({x:0,y:-c}),m=fe({x:0,y:-l});for(t=p.x,e=p.y,d.push(t),m.rotate(-u/2),m.rotate(h),o=0;o<a;o++)m.rotate(u),i=parseFloat((m.x-t).toFixed(1)),t+=i,d.push(t),s=parseFloat((m.y-e).toFixed(1)),e+=s,f+=`${i},${s} `,p.rotate(u),i=parseFloat((p.x-t).toFixed(1)),t+=i,d.push(t),s=parseFloat((p.y-e).toFixed(1)),e+=s,f+=`${i},${s} `;return pe(p),pe(m),n=Math.min(...d),r=Math.abs(n).toFixed(1),f=`m${r},0l${f}z`,f};g.Star=Star;const Tetragon=function(t={}){return this.shapeInit(t),this};let Xs=Tetragon.prototype=Object.create(Object.prototype);Xs.type="Tetragon",Xs.lib="entity",Xs.isArtefact=!0,Xs.isAsset=!1,Xs=nt(Xs),Xs=Pi(Xs);Xs.defs=Y(Xs.defs,{radiusX:5,radiusY:5,intersectX:.5,intersectY:.5});let Ys=Xs.setters,$s=Xs.deltaSetters;Ys.radius=function(t){this.setRectHelper(t,["radiusX","radiusY"])},Ys.radiusX=function(t){this.setRectHelper(t,["radiusX"])},Ys.radiusY=function(t){this.setRectHelper(t,["radiusY"])},$s.radius=function(t){this.deltaRectHelper(t,["radiusX","radiusY"])},$s.radiusX=function(t){this.deltaRectHelper(t,["radiusX"])},$s.radiusY=function(t){this.deltaRectHelper(t,["radiusY"])},Ys.intersectA=function(t){this.intersectA=t,this.updateDirty()},Ys.intersectB=function(t){this.intersectB=t,this.updateDirty()},$s.intersectA=function(t){t.toFixed&&(this.intersectA+=t,this.updateDirty())},$s.intersectB=function(t){t.toFixed&&(this.intersectB+=t,this.updateDirty())},Xs.setRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=t},this)},Xs.deltaRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=addStrings(this[e],t)},this)},Xs.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeTetragonPath(),this.pathDefinition=t},Xs.makeTetragonPath=function(){let t,e,i=this.radiusX,s=this.radiusY;if(i.substring||s.substring){let n=this.getHere();t=2*(i.substring?parseFloat(i)/100*n.w:i),e=2*(s.substring?parseFloat(s)/100*n.h:s)}else t=2*i,e=2*s;let n=parseFloat((t*this.intersectX).toFixed(2)),r=parseFloat((t-n).toFixed(2)),o=parseFloat((e*this.intersectY).toFixed(2)),a=parseFloat((e-o).toFixed(2)),h="m0,0";return h+=`l${r},${o} ${-r},${a} ${-n},${-a} ${n},${-o}z`,h},Xs.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};g.Tetragon=Tetragon;const Ticker=function(t={}){return this.makeName(t.name),this.register(),this.subscribers=[],this.subscriberObjects=[],this.set(this.defs),this.set(t),this.cycleCount=0,this.active=!1,this.effectiveDuration=0,this.startTime=0,this.currentTime=0,this.tick=0,this.lastEvent=0,t.subscribers&&this.subscribe(t.subscribers),this.setEffectiveDuration(),this};let Ns=Ticker.prototype=Object.create(Object.prototype);Ns.type="Ticker",Ns.lib="animationtickers",Ns.isArtefact=!1,Ns.isAsset=!1,Ns=nt(Ns);Ns.defs=Y(Ns.defs,{order:1,duration:0,subscribers:null,killOnComplete:!1,cycles:1,eventChoke:0,onRun:null,onHalt:null,onReverse:null,onResume:null,onSeekTo:null,onSeekFor:null,onComplete:null,onReset:null}),Ns.packetExclusions=N(Ns.packetExclusions,["subscribers"]),Ns.packetFunctions=N(Ns.packetFunctions,["onRun","onHalt","onReverse","onResume","onSeekTo","onSeekFor","onComplete","onReset"]),Ns.kill=function(){return this.active&&this.halt(),W(Vs,this.name),Gs=!0,this.deregister(),!0},Ns.killTweens=function(t=!1){let e,i,s;for(e=0,i=this.subscribers.length;e<i;e++)s=d[this.subscribers[e]],s.completeAction(),s.kill();return t?(this.kill(),!0):this};let Ws=Ns.getters,qs=Ns.setters;Ws.subscribers=function(){return[].concat(this.subscribers)},qs.subscribers=function(t){this.subscribers=[],this.subscribe(t)},qs.order=function(t){this.order=t,this.active&&(Gs=!0)},qs.cycles=function(t){this.cycles=t,this.cycles||(this.cycleCount=0)},qs.duration=function(t){let e,i,s,n=this.subscribers;if(this.duration=t,this.setEffectiveDuration(),q(n))for(e=0,i=n.length;e<i;e++)s=d[n[e]],s&&(s.calculateEffectiveTime(),"Tween"===s.type&&s.calculateEffectiveDuration())},Ns.subscribe=function(t){let e,i,s,n,r=[].concat(t);for(e=0,i=r.length;e<i;e++)s=r[e],null!=s&&(n=s.substring?s:!(!I(s)||!s.name)&&s.name,n&&N(this.subscribers,n));return r.length&&(this.sortSubscribers(),this.recalculateEffectiveDuration()),this},Ns.unsubscribe=function(t){var e,i,s,n,r=[].concat(t);for(e=0,i=r.length;e<i;e++)(n=(s=t[e]).substring?s:!(!I(s)||!s.name)&&s.name)&&W(this.subscribers,n);return r.length&&(this.sortSubscribers(),this.recalculateEffectiveDuration()),this},Ns.repopulateSubscriberObjects=function(){let t,e=this.subscriberObjects,i=this.subscribers;e.length=0,i.forEach(i=>{t=d[i],t&&e.push(t)})},Ns.getSubscriberObjects=function(){return this.subscribers.length&&!this.subscriberObjects.length&&this.repopulateSubscriberObjects(),this.subscriberObjects},Ns.sortSubscribers=function(){let t=this.subscribers;if(t.length>1){let e=[].concat(t),i=Math.floor,s=[];e.forEach(t=>{let e=i(t.effectiveTime)||0;s[e]||(s[e]=[]),s[e].push(t)}),this.subscribers=s.reduce((t,e)=>t.concat(e),[])}this.repopulateSubscriberObjects()},Ns.updateSubscribers=function(t,e){e=!!q(e)&&e;let i,s,n=this.getSubscriberObjects();if(e)for(i=n.length-1;i>=0;i--)n[i].set(t);else for(i=0,s=n.length;i<s;i++)n[i].set(t);return this},Ns.changeSubscriberDirection=function(){return this.getSubscriberObjects().forEach(t=>t.reversed=!t.reversed),this},Ns.makeTickerUpdateEvent=function(){return new CustomEvent("tickerupdate",{detail:{name:this.name,type:"Ticker",tick:this.tick,reverseTick:this.effectiveDuration-this.tick},bubbles:!0,cancelable:!0})},Ns.recalculateEffectiveDuration=function(){let t,e=this.getSubscriberObjects(),i=0;return this.duration?this.setEffectiveDuration():(e.forEach(e=>{t=e.getEndTime(),t>i&&(i=t)}),this.effectiveDuration=i),this},Ns.setEffectiveDuration=function(){let t;return this.duration&&(t=E(this.duration),"%"===t[0]?(this.duration=0,this.recalculateEffectiveDuration()):this.effectiveDuration=t[1]),this},Ns.fn=function(t){let e=_s();t=!!q(t)&&t;let i,s,n,r,o,a,h,c,l=this.active,u=this.startTime,d=this.cycles,f=this.cycleCount,p=this.effectiveDuration,m=this.eventChoke;if(l&&u&&(!d||f<d)){if(h=this.currentTime=Date.now(),c=this.tick=h-u,!d||f+1<d?(c>=p?(c=this.tick=0,this.startTime=this.currentTime,e.tick=p,e.reverseTick=0,e.willLoop=!0,d&&(f++,this.cycleCount=f)):(e.tick=c,e.reverseTick=p-c),e.next=!0):c>=p?(e.tick=p,e.reverseTick=0,l=this.active=!1,d&&(f++,this.cycleCount=f)):(e.tick=c,e.reverseTick=p-c,e.next=!0),n=this.getSubscriberObjects(),t)for(i=n.length-1;i>=0;i--)n[i].update(e);else for(i=0,s=n.length;i<s;i++)n[i].update(e);m&&(r=this.lastEvent+m,o=Date.now(),r<o&&(a=this.makeTickerUpdateEvent(),window.dispatchEvent(a),this.lastEvent=o)),l||this.halt(),this.killOnComplete&&f>=d&&this.killTweens(!0)}Qs(e)},Ns.run=function(){return this.active||(this.startTime=this.currentTime=Date.now(),this.cycleCount=0,this.updateSubscribers({reversed:!1}),this.active=!0,N(Vs,this.name),Gs=!0,"function"==typeof this.onRun&&this.onRun()),this},Ns.isRunning=function(){return this.active},Ns.reset=function(){return this.active&&this.halt(),this.startTime=this.currentTime=Date.now(),this.cycleCount=0,this.updateSubscribers({reversed:!1}),this.active=!0,this.fn(!0),this.active=!1,"function"==typeof this.onReset&&this.onReset(),this},Ns.complete=function(){return this.active&&this.halt(),this.startTime=this.currentTime=Date.now(),this.cycleCount=0,this.updateSubscribers({reversed:!0}),this.active=!0,this.fn(),this.active=!1,"function"==typeof this.onComplete&&this.onComplete(),this},Ns.reverse=function(t=!1){let e;return t=G(t,!1),this.active&&this.halt(),e=this.currentTime-this.startTime,this.startTime=this.currentTime-(this.effectiveDuration-e),this.changeSubscriberDirection(),this.active=!0,this.fn(),this.active=!1,"function"==typeof this.onReverse&&this.onReverse(),t&&this.resume(),this},Ns.halt=function(){return this.active=!1,N(Vs,this.name),Gs=!0,"function"==typeof this.onHalt&&this.onHalt(),this},Ns.resume=function(){let t,e,i;return this.active||(t=Date.now(),e=this.currentTime,i=this.startTime,this.startTime=t-(e-i),this.currentTime=t,this.active=!0,N(Vs,this.name),Gs=!0,"function"==typeof this.onResume&&this.onResume()),this},Ns.seekTo=function(t,e=!1){let i=!1;return t=G(t,0),this.active&&this.halt(),this.cycles&&this.cycleCount>=this.cycles&&(this.cycleCount=this.cycles-1),t<this.tick&&(i=!0),this.currentTime=Date.now(),this.startTime=this.currentTime-t,this.active=!0,this.fn(i),this.active=!1,"function"==typeof this.onSeekTo&&this.onSeekTo(),e&&this.resume(),this},Ns.seekFor=function(t,e=!1){let i=!1;return t=__xtGet(t,0),this.active&&this.halt(),this.cycles&&this.cycleCount>=this.cycles&&(this.cycleCount=this.cycles-1),this.startTime-=t,t<0&&(i=!0),this.active=!0,this.fn(i),this.active=!1,"function"==typeof this.onSeekFor&&this.onSeekFor(),e&&this.resume(),this};let Vs=[],Gs=!0;ot({name:"coreTickersAnimation",order:0,fn:function(){return new Promise(t=>{if(Gs){Gs=!1;let t=[].concat(Vs),i=Math.floor,s=[];t.forEach(t=>{let n=e[t];if(q(n)){let t=i(n.order)||0;s[t]||(s[t]=[]),s[t].push(n.name)}}),Vs=s.reduce((t,e)=>t.concat(e),[])}Vs.forEach(t=>{let i=e[t];i&&i.fn&&i.fn()}),t(!0)})}});const Us=[],_s=function(){return Us.length||Us.push({tick:0,reverseTick:0,willLoop:!1,next:!1}),Us.shift()},Qs=function(t){t&&(t.tick=0,t.reverseTick=0,t.willLoop=!1,t.next=!1,Us.push(t))},Ks=function(t){return new Ticker(t)};g.Ticker=Ticker;const Tween=function(t={}){let i;return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.setDefinitionsValues(),this.status=-1,this.calculateEffectiveTime(),this.calculateEffectiveDuration(),e[t.ticker]?this.addToTicker(t.ticker):(i=this.name+"_ticker",Ks({name:i,order:this.order,subscribers:this.name,duration:this.effectiveDuration,eventChoke:G(t.eventChoke,0),cycles:G(t.cycles,1),killOnComplete:G(t.killOnComplete,!1)}),this.ticker=i,e[i].recalculateEffectiveDuration()),this};let Zs=Tween.prototype=Object.create(Object.prototype);Zs.type="Tween",Zs.lib="tween",Zs.isArtefact=!1,Zs.isAsset=!1,Zs=nt(Zs),Zs=ci(Zs);Zs.defs=Y(Zs.defs,{definitions:null,duration:0,killOnComplete:!1,commenceAction:null,onRun:null,onHalt:null,onResume:null,onReverse:null,onSeekTo:null,onSeekFor:null,completeAction:null}),Zs.packetExclusions=N(Zs.packetExclusions,["definitions","targets"]),Zs.packetFunctions=N(Zs.packetFunctions,["commenceAction","completeAction","onRun","onHalt","onResume","onReverse","onSeekTo","onSeekFor","action"]),Zs.finalizePacketOut=function(t,e){return Array.isArray(this.targets)&&(t.targets=this.targets.map(t=>t.name)),Array.isArray(this.definitions)&&(t.definitions=this.definitions.map(t=>{let e={};if(e.attribute=t.attribute,e.start=t.start,e.end=t.end,t.engine&&t.engine.substring)e.engine=t.engine.substring;else if(q(t.engine)&&null!==t.engine){let i=this.stringifyFunction(t.engine);i&&(e.engine=i,e.engineIsFunction=!0)}return e})),t},Zs.postCloneAction=function(t,i){if(i.useNewTicker){let s=e[this.ticker];q(i.cycles)?t.cycles=i.cycles:t.cycles=s?s.cycles:1;let n=e[t.ticker];n.cycles=t.cycles,q(i.duration)&&(t.duration=i.duration,t.calculateEffectiveDuration(),n&&n.recalculateEffectiveDuration())}return Array.isArray(t.definitions)&&t.definitions.forEach((t,e)=>{t.engineIsFunction&&(t.engine=this.definitions[e].engine)}),t};let Js=Zs.getters,tn=Zs.setters;Js.definitions=function(){return[].concat(this.definitions)},tn.definitions=function(t){this.definitions=[].concat(t),this.setDefinitionsValues()},tn.commenceAction=function(t){this.commenceAction=t,"function"!=typeof this.commenceAction&&(this.commenceAction=T)},tn.completeAction=function(t){this.completeAction=t,"function"!=typeof this.completeAction&&(this.completeAction=T)},Zs.set=function(t){let e,i,s,n,r=this.setters,o=Object.keys(t),a=this.defs,h=!!q(t.ticker)&&this.ticker;for(i=0,s=o.length;i<s;i++)e=o[i],"name"!==e&&(n=r[e],n?n.call(this,t[e]):void 0!==a[e]&&(this[e]=t[e]));return h?(this.ticker=h,this.addToTicker(t.ticker)):U(t.time,t.duration)&&(this.calculateEffectiveTime(),this.calculateEffectiveDuration()),this},Zs.getEndTime=function(){return this.effectiveTime+this.effectiveDuration},Zs.calculateEffectiveDuration=function(t){let i,s=G(t,this.duration),n=E(s),r=n[1],o=n[0],a=this.ticker,h=0;return this.effectiveDuration=0,"%"===o?a&&(i=e[a],i&&(h=i.effectiveDuration,this.effectiveDuration=h*(r/100))):this.effectiveDuration=r,this},Zs.update=function(t={}){let e,i,s=t.tick||0,n=t.reverseTick||0,r=0,o=this.effectiveTime,a=this.effectiveDuration,h=this.reversed;h?(e=o+a,i=o,n>e?r=1:n<i&&(r=-1)):(e=o,i=o+a,s<e?r=-1:s>i&&(r=1)),a?r&&r==this.status||(this.status=r,this.doSimpleUpdate(t),t.next||(this.status=h?-1:1)):r!=this.status&&(this.status=r,this.doSimpleUpdate(t),t.next||(this.status=h?-1:1)),t.willLoop&&(this.reverseOnCycleEnd?this.reversed=!h:this.status=-1)},Zs.doSimpleUpdate=function(t={}){let e,i,s,n,r,o,a,h,c,l,u,d,f,p,m=this.effectiveTime,g=this.engineActions,y=this.effectiveDuration,b=this.status,P=this.definitions,S=this.targets,v=this.action,k=this.setObj||{},x=Math.round;for(e=this.reversed?t.reverseTick-m:t.tick-m,o=y&&!b?e/y:b>0?1:0,i=0,s=P.length;i<s;i++)a=P[i],h=a.engine,l=a.effectiveStart,u=a.effectiveChange,d=a.integer,f=a.suffix,p=a.attribute,c=h.substring?g[h](l,u,o):h(l,u,o),d&&(c=x(c)),f&&(c+=f),k[p]=c;for(n=0,r=S.length;n<r;n++)S[n].set(k);this.setObj=k,v&&v()},Zs.engineActions={out:function(t,e,i){return t+e+Math.cos(90*i*y)*-e},in:function(t,e,i){return t+Math.sin(90*i*y)*e},easeIn:function(t,e,i){let s=1-i;return t+e+s*s*-e},easeIn3:function(t,e,i){let s=1-i;return t+e+s*s*s*-e},easeIn4:function(t,e,i){let s=1-i;return t+e+s*s*s*s*-e},easeIn5:function(t,e,i){let s=1-i;return t+e+s*s*s*s*s*-e},easeOutIn:function(t,e,i){let s=1-i;return i<.5?t+i*i*e*2:t+e+s*s*-e*2},easeOutIn3:function(t,e,i){let s=1-i;return i<.5?t+i*i*i*e*4:t+e+s*s*s*-e*4},easeOutIn4:function(t,e,i){let s=1-i;return i<.5?t+i*i*i*i*e*8:t+e+s*s*s*s*-e*8},easeOutIn5:function(t,e,i){let s=1-i;return i<.5?t+i*i*i*i*i*e*16:t+e+s*s*s*s*s*-e*16},easeOut:function(t,e,i){return t+i*i*e},easeOut3:function(t,e,i){return t+i*i*i*e},easeOut4:function(t,e,i){return t+i*i*i*i*e},easeOut5:function(t,e,i){return t+i*i*i*i*i*e},linear:function(t,e,i){return t+i*e}},Zs.setDefinitionsValues=function(){let t,e,i,s,n=this.parseDefinitionsValue,r=this.definitions;for(t=0,e=r.length;t<e;t++)s=r[t],s&&(i=n(s.start),s.effectiveStart=i[1],s.suffix=i[0],i=n(s.end),s.effectiveEnd=i[1],q(s.engine)||(s.engine="linear"),s.effectiveChange=s.effectiveEnd-s.effectiveStart);return this},Zs.parseDefinitionsValue=function(t){let e,i=["",0];return q(t)&&(t.toFixed?i[1]=t:t.substring&&(e=t.match(/^-?\d+\.?\d*(\D*)/),q(e[0])&&(i[1]=parseFloat(e)),q(e[1])&&(i[0]=e[1]))),i},Zs.run=function(){let t=e[this.ticker];return t&&(this.commenceAction(),t.run(),"function"==typeof this.onRun&&this.onRun()),this},Zs.isRunning=function(){let t=e[this.ticker];return!!t&&t.isRunning()},Zs.halt=function(){let t=e[this.ticker];return t&&(t.halt(),"function"==typeof this.onHalt&&this.onHalt()),this},Zs.reverse=function(){let t=e[this.ticker];return t&&(t.reverse(),"function"==typeof this.onReverse&&this.onReverse()),this},Zs.resume=function(){let t=e[this.ticker];return t&&(t.resume(),"function"==typeof this.onResume&&this.onResume()),this},Zs.seekTo=function(t){let i=e[this.ticker];return i&&(i.seekTo(t),"function"==typeof this.onSeekTo&&this.onSeekTo()),this},Zs.seekFor=function(t){let i=e[this.ticker];return i&&(i.seekFor(t),"function"==typeof this.onSeekFor&&this.onSeekFor()),this};g.Tween=Tween;const en=(t,e)=>(t=parseFloat(t),z(t)||(t=0),z(e)||(e=0),parseFloat(t.toFixed(e))),Wheel=function(t={}){return U(t.dimensions,t.width,t.height,t.radius)||(t.radius=5),this.entityInit(t),this};let sn=Wheel.prototype=Object.create(Object.prototype);sn.type="Wheel",sn.lib="entity",sn.isArtefact=!0,sn.isAsset=!1,sn=nt(sn),sn=di(sn);sn.defs=Y(sn.defs,{radius:5,startAngle:0,endAngle:360,clockwise:!0,includeCenter:!1,closed:!0});sn.getters;let nn=sn.setters,rn=sn.deltaSetters;nn.width=function(t){if(null!=t){let e=this.dimensions;e[0]=e[1]=t,this.dimensionsHelper()}},rn.width=function(t){let e=this.dimensions;e[0]=e[1]=addStrings(e[0],t),this.dimensionsHelper()},nn.height=function(t){if(null!=t){let e=this.dimensions;e[0]=e[1]=t,this.dimensionsHelper()}},rn.height=function(t){let e=this.dimensions;e[0]=e[1]=addStrings(e[0],t),this.dimensionsHelper()},nn.dimensions=function(t,e){this.setCoordinateHelper("dimensions",t,e),this.dimensionsHelper()},rn.dimensions=function(t,e){this.setDeltaCoordinateHelper("dimensions",t,e),this.dimensionsHelper()},nn.radius=function(t){this.radius=t,this.radiusHelper()},rn.radius=function(t){this.radius=addStrings(this.radius,t),this.radiusHelper()},nn.startAngle=function(t){this.startAngle=en(t,4),this.dirtyPathObject=!0},rn.startAngle=function(t){this.startAngle+=en(t,4),this.dirtyPathObject=!0},nn.endAngle=function(t){this.endAngle=en(t,4),this.dirtyPathObject=!0},rn.endAngle=function(t){this.endAngle+=en(t,4),this.dirtyPathObject=!0},nn.closed=function(t){q(t)&&(this.closed=!!t,this.dirtyPathObject=!0)},nn.includeCenter=function(t){q(t)&&(this.includeCenter=!!t,this.dirtyPathObject=!0)},nn.clockwise=function(t){q(t)&&(this.clockwise=!!t,this.dirtyPathObject=!0)},sn.dimensionsHelper=function(){let t=this.dimensions[0];t.substring?this.radius=parseFloat(t)/2+"%":this.radius=t/2,this.dirtyDimensions=!0},sn.radiusHelper=function(){let t=this.radius,e=this.dimensions;t.substring?e[0]=e[1]=2*parseFloat(t)+"%":e[0]=e[1]=2*t,this.dirtyDimensions=!0},sn.cleanDimensionsAdditionalActions=function(){let t=this.radius,e=this.currentDimensions,i=t.substring?parseFloat(t)/100*e[0]:t;e[0]!==2*i?(e[1]=e[0],this.currentRadius=e[0]/2):this.currentRadius=i},sn.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=this.currentStampHandlePosition,i=this.currentScale,s=this.currentRadius*i,n=s-e[0]*i,r=s-e[1]*i,o=this.startAngle*y,a=this.endAngle*y;t.arc(n,r,s,o,a,!this.clockwise),this.includeCenter?(t.lineTo(n,r),t.closePath()):this.closed&&t.closePath()}};g.Wheel=Wheel;window.scrawlEnvironmentTouchSupported=!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch),window.scrawlEnvironmentOffscreenCanvasSupported="OffscreenCanvas"in window,document.querySelectorAll("[data-stack]").forEach(t=>ze(t)),document.querySelectorAll("canvas").forEach((t,e)=>{let i=Xe(t);e||Ne(i)}),D(),St(),dt(),ct=!0,bt();var on={library:S,startCoreAnimationLoop:D,stopCoreAnimationLoop:function(){v=!1},currentCorePosition:lt,startCoreListeners:bt,stopCoreListeners:function(){ht=!1,ct=!1,yt.halt(),Pt("removeEventListener")},observeAndUpdate:function(t={}){if(!V(t.event,t.origin,t.updates))return!1;let e=t.target.substring&&t.targetLibrarySection?S[t.targetLibrarySection][t.target]:t.target;if(!e)return!1;let i=t.event,s=t.origin,n=t.useNativeListener?et:Q,r=t.useNativeListener?it:K,o=T;t.preventDefault&&(o=t=>{t.preventDefault(),t.returnValue=!1});let a=function(i){o(i);let s=!(!i||!i.target)&&i.target.id;if(s){let n=t.updates[s];if(n){let t,s=n[0],r=n[1],o=i.target.value,a=!0;switch(r){case"float":t=parseFloat(o);break;case"int":t=parseInt(o,10);break;case"round":t=Math.round(o);break;case"roundDown":t=Math.floor(o);break;case"roundUp":t=Math.ceil(o);break;case"raw":t=o;break;case"boolean":t=!!q(o)&&(o.substring?"true"===o.toLowerCase()||"false"!==o.toLowerCase()&&!!parseFloat(o):!!o);break;default:r.substring?t=`${parseFloat(o)}${r}`:a=!1}a&&("Group"===e.type?e.setArtefacts({[s]:t}):e.set({[s]:t}))}}};return n(i,a,s),function(){r(i,a,s)}},makeDragZone:function(t={}){if(!t.zone)return!1;let e=t.zone.substring?artefact[t.zone]:t.zone;if(!e)return!1;let i,s=e.domElement,n=t.collisionGroup&&t.collisionGroup.substring?u[t.collisionGroup]:t.collisionGroup,r=t.startOn?t.startOn:["down"],o=t.endOn?t.endOn:["up"];if("Stack"===e.type?(i=t.coordinateSource,i||(i=e.here),n=t.collisionGroup,n?n.substring&&(n=u[n]):n=u[e.name]):"Canvas"===e.type&&(i=t.coordinateSource,i||(i=e.base.here),n=t.collisionGroup,n?n.substring&&(n=u[n]):n=u[e.base.name]),!V(s,n))return!1;let a=!1,h=function(s){s.cancelable&&(s.preventDefault(),s.returnValue=!1);let r=s.type;"touchstart"!==r&&"touchcancel"!==r||pt(s),i||"Canvas"!==e.type||(i=e.base.here),a=n.getArtefactAt(i),a&&(a.artefact.pickupArtefact(i),t.updateOnStart&&a.artefact.set(t.updateOnStart))},c=function(e){e.cancelable&&(e.preventDefault(),e.returnValue=!1),a&&(a.artefact.dropArtefact(),t.updateOnEnd&&a.artefact.set(t.updateOnEnd),a=!1)},l=function(){K(r,h,s),K(o,c,s)};return Q(r,h,s),Q(o,c,s),t.exposeCurrentArtefact?function(t=!1){if(!t)return a;l()}:l},makeComponent:function(t){let e=!!L(t.domElement)&&t.domElement,s=I(t.animationHooks)?t.animationHooks:{},n=I(t.canvasSpecs)?t.canvasSpecs:{},r=I(t.observerSpecs)?t.observerSpecs:{},o=!B(t.includeCanvas)||t.includeCanvas;return e&&e.id&&i[e.id]?ri(e,n,s,r):oi(e,n,s,r,o)},addStack:function(t={}){let e,s,n,r,o,a,h="absolute";return e=t.element&&t.element.substring?document.querySelector(t.element):L(t.element)?t.element:document.createElement("div"),t.host&&t.host.substring?(s=document.querySelector(t.host),s||(s=document.body)):s=L(t.host)?t.host:q(e.parentElement)?e.parentElement:document.body,q(t.width)&&(e.style.width=t.width.toFixed?t.width+"px":t.width),q(t.height)&&(e.style.height=t.height.toFixed?t.height+"px":t.height),a=t.name||e.id||e.getAttribute("name")||"",a||(a=F()),e.id=a,e.setAttribute("data-stack","data-stack"),s&&null!=s.getAttribute("data-stack")?(n=i[s.id],o=n?n.name:"root"):o="root",e.setAttribute("data-group",o),"root"===o&&(h="relative"),e.parentElement&&s.id===e.parentElement.id||s.appendChild(e),r=Fe({name:a,domElement:e,group:o,host:o,position:h,setInitialDimensions:!0}),Ie(e,a),Array.from(e.childNodes).forEach(t=>{t.id&&Be.indexOf(t.id)>=0&&W(Be,t.id)}),delete t.name,delete t.element,delete t.host,delete t.width,delete t.height,r.set(t),Me=!0,r},getStack:function(t){let e,i=document.querySelector(t);return i&&(e=ze(i)),e},addCanvas:function(t={}){let e=document.createElement("canvas"),s=t.name?t.name:F(),n=t.host,r="root",o=t.width||300,a=t.height||150,h="relative";if(n.substring){let t=i[n];!t&&n?(n=document.querySelector(n),n&&(r=n.id)):n=t}n?"Stack"===n.type?(r=n.name,h="absolute",n=n.domElement):L(n)||(n=document.body):n=document.body,e.id=s,e.setAttribute("data-group",r),e.width=o,e.height=a,e.style.position=h,n.appendChild(e);let c=Ce({name:s,domElement:e,group:r,host:r,position:h,setInitialDimensions:!1,setAsCurrentCanvas:!q(t.setAsCurrentCanvas)||t.setAsCurrentCanvas,trackHere:!q(t.trackHere)||t.trackHere});return delete t.group,delete t.host,delete t.name,delete t.element,delete t.position,delete t.setInitialDimensions,delete t.setAsCurrentCanvas,delete t.trackHere,c.set(t),c},getCanvas:function(t){let e=document.querySelector(t),i=!1;return e&&(i=Xe(e)),Ne(i),i},setCurrentCanvas:Ne,clear:We,compile:qe,show:Ve,render:function(...t){return Ge(t),Ue("render")},addListener:Q,removeListener:K,addNativeListener:et,removeNativeListener:it,makeAnimationObserver:_,makeAction:function(t){return new Action(t)},makeAnimation:ot,makeBezier:function(t={}){return t.species="bezier",new Bezier(t)},makeBlock:function(t){return new Block(t)},makeColor:Oi,requestCoordinate:function(t,e){Ft.length||Ft.push(new Coordinate);let i=Ft.shift();return i.set(t,e),i},releaseCoordinate:function(t){t&&"Coordinate"===t.type&&Ft.push(t.zero())},makeFilter:function(t){return new Filter(t)},makeGradient:function(t){return new Gradient(t)},makeGrid:function(t){return new Grid(t)},makeGroup:le,importImage:Xt,importDomImage:Yt,createImageFromCell:function(t,e=!1){let i=t.substring?a[t]||o[t]:t;"Canvas"===i.type&&(i=i.base),"Cell"===i.type&&(i.stashOutput=!0,e&&(i.stashOutputAsAsset=!0))},createImageFromGroup:function(t,e=!1){let i;t&&!t.substring?"Group"===t.type?i=t:"Cell"===t.type?i=u[t.name]:"Canvas"===t.type&&(i=u[t.base.name]):t&&t.substring&&(i=u[t]),i&&(i.stashOutput=!0,e&&(i.stashOutputAsAsset=!0))},createImageFromEntity:function(t,e=!1){let s=t.substring?i[t]:t;s.isArtefact&&(s.stashOutput=!0,e&&(s.stashOutputAsAsset=!0))},makeLine:function(t={}){return t.species="line",new Line(t)},makeLoom:function(t){return new Loom(t)},makeOval:function(t={}){return t.species="oval",new Oval(t)},makePattern:function(t){return new Pattern(t)},makePhrase:function(t){return new Phrase(t)},makePicture:function(t){return new Picture(t)},makePolygon:function(t={}){return t.species="polygon",new Polygon(t)},makePolyline:function(t={}){return t.species="polyline",new Polyline(t)},makeQuadratic:function(t={}){return t.species="quadratic",new Quadratic(t)},requestQuaternion:ye,releaseQuaternion:be,makeRadialGradient:function(t){return new RadialGradient(t)},makeRectangle:function(t={}){return t.species="rectangle",new Rectangle(t)},makeRender:si,makeShape:function(t){return new Shape(t)},makeSpiral:function(t={}){return t.species="spiral",new Spiral(t)},importSprite:Qi,makeStar:function(t={}){return t.species="star",new Star(t)},makeTetragon:function(t={}){return t.species="tetragon",new Tetragon(t)},makeTicker:Ks,makeTween:function(t){return new Tween(t)},requestVector:fe,releaseVector:pe,importDomVideo:function(t){let e=/.*\/(.*?)\./;document.querySelectorAll(t).forEach(t=>{let i;if("VIDEO"===t.tagName.toUpperCase()){if(t.id||t.name)i=t.id||t.name;else{let s=e.exec(t.src);i=s&&s[1]?s[1]:""}let s=Gi({name:i,source:t});t.readyState<=2&&(t.oncanplay=()=>{s.set({source:t})})}})},importVideo:Vi,importMediaStream:function(t={}){let e={};e.audio=!q(t.audio)||t.audio,e.video={};let i=e.video.width={};t.minWidth&&(i.min=t.minWidth),t.maxWidth&&(i.max=t.maxWidth),i.ideal=t.width?t.width:1280;let s=e.video.height={};t.minHeight&&(s.min=t.minHeight),t.maxHeight&&(s.max=t.maxHeight),s.ideal=t.height?t.height:720,t.facing&&(e.video.facingMode=t.facing);let n=t.name||F(),r=document.createElement("video"),o=Gi({name:n,source:r});return new Promise((t,i)=>{navigator&&navigator.mediaDevices?navigator.mediaDevices.getUserMedia(e).then(e=>{let i,s=e.getVideoTracks();Array.isArray(s)&&s[0]&&(i=s[0].getConstraints()),r.id=o.name,i&&(r.width=i.width,r.height=i.height),r.srcObject=e,r.onloadedmetadata=function(t){r.play()},t(o)}).catch(e=>{console.log(e.message),t(o)}):i("Navigator.mediaDevices object not found")})},makeWheel:function(t){return new Wheel(t)}};export default on;
