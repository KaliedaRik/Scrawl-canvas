const t={},e={},i={},s=[],n={},r=[],o={},a={},l=[],h={},c={},u={},d={},f={},p={},m=[],g={},y={},b={},k=[],S={},O={},P=Math.PI/180,v=new Set(["all","background","backgroundAttachment","backgroundBlendMode","backgroundClip","backgroundColor","backgroundOrigin","backgroundPosition","backgroundRepeat","border","borderBottom","borderBottomColor","borderBottomStyle","borderBottomWidth","borderCollapse","borderColor","borderLeft","borderLeftColor","borderLeftStyle","borderLeftWidth","borderRight","borderRightColor","borderRightStyle","borderRightWidth","borderSpacing","borderStyle","borderTop","borderTopColor","borderTopStyle","borderTopWidth","borderWidth","clear","color","columns","content","counterIncrement","counterReset","cursor","direction","display","emptyCells","float","font","fontFamily","fontSize","fontSizeAdjust","fontStretch","fontStyle","fontSynthesis","fontVariant","fontVariantAlternates","fontVariantCaps","fontVariantEastAsian","fontVariantLigatures","fontVariantNumeric","fontVariantPosition","fontWeight","grid","gridArea","gridAutoColumns","gridAutoFlow","gridAutoPosition","gridAutoRows","gridColumn","gridColumnStart","gridColumnEnd","gridRow","gridRowStart","gridRowEnd","gridTemplate","gridTemplateAreas","gridTemplateRows","gridTemplateColumns","imageResolution","imeMode","inherit","inlineSize","isolation","letterSpacing","lineBreak","lineHeight","listStyle","listStyleImage","listStylePosition","listStyleType","margin","marginBlockStart","marginBlockEnd","marginInlineStart","marginInlineEnd","marginBottom","marginLeft","marginRight","marginTop","marks","mask","maskType","maxWidth","maxHeight","maxBlockSize","maxInlineSize","maxZoom","minWidth","minHeight","minBlockSize","minInlineSize","minZoom","mixBlendMode","objectFit","objectPosition","offsetBlockStart","offsetBlockEnd","offsetInlineStart","offsetInlineEnd","orphans","overflow","overflowWrap","overflowX","overflowY","pad","padding","paddingBlockStart","paddingBlockEnd","paddingInlineStart","paddingInlineEnd","paddingBottom","paddingLeft","paddingRight","paddingTop","pageBreakAfter","pageBreakBefore","pageBreakInside","pointerEvents","position","prefix","quotes","rubyAlign","rubyMerge","rubyPosition","scrollBehavior","scrollSnapCoordinate","scrollSnapDestination","scrollSnapPointsX","scrollSnapPointsY","scrollSnapType","scrollSnapTypeX","scrollSnapTypeY","shapeImageThreshold","shapeMargin","shapeOutside","tableLayout","textAlign","textDecoration","textIndent","textOrientation","textOverflow","textRendering","textShadow","textTransform","textUnderlinePosition","unicodeRange","unset","verticalAlign","widows","willChange","wordBreak","wordSpacing","wordWrap","zIndex"]),w=new Set(["alignContent","alignItems","alignSelf","animation","animationDelay","animationDirection","animationDuration","animationFillMode","animationIterationCount","animationName","animationPlayState","animationTimingFunction","backfaceVisibility","backgroundImage","backgroundSize","borderBottomLeftRadius","borderBottomRightRadius","borderImage","borderImageOutset","borderImageRepeat","borderImageSlice","borderImageSource","borderImageWidth","borderRadius","borderTopLeftRadius","borderTopRightRadius","boxDecorationBreak","boxShadow","boxSizing","columnCount","columnFill","columnGap","columnRule","columnRuleColor","columnRuleStyle","columnRuleWidth","columnSpan","columnWidth","filter","flex","flexBasis","flexDirection","flexFlow","flexGrow","flexShrink","flexWrap","fontFeatureSettings","fontKerning","fontLanguageOverride","hyphens","imageRendering","imageOrientation","initial","justifyContent","linearGradient","opacity","order","orientation","outline","outlineColor","outlineOffset","outlineStyle","outlineWidth","resize","tabSize","textAlignLast","textCombineUpright","textDecorationColor","textDecorationLine","textDecorationStyle","touchAction","transformStyle","transition","transitionDelay","transitionDuration","transitionProperty","transitionTimingFunction","unicodeBidi","whiteSpace","writingMode"]);var x=Object.freeze({__proto__:null,version:"8.4.0",anchor:{},anchornames:[],animation:t,animationnames:[],asset:n,assetnames:r,animationtickers:e,animationtickersnames:[],artefact:i,artefactnames:s,canvas:o,canvasnames:[],cell:a,cellnames:l,element:{},elementnames:[],entity:h,entitynames:[],filter:c,filternames:[],fontattribute:{},fontattributenames:[],force:f,forcenames:[],group:u,groupnames:[],palette:{},palettenames:[],particle:d,particlenames:[],spring:p,springnames:m,stack:{},stacknames:[],styles:b,stylesnames:k,tween:y,tweennames:[],unstackedelement:S,unstackedelementnames:[],world:g,worldnames:[],constructors:O,radian:P,css:v,xcss:w});let A=!1,C=!0,D=[],R=[];const E=function(){C=!0},F=function(){let e=[];C&&function(){if(C){C=!1;let e,i,s=Math.floor,n=[];R.forEach(r=>{e=t[r],e&&(i=s(e.order)||0,n[i]||(n[i]=[]),n[i].push(e))}),D=n.reduce((t,e)=>t.concat(e),[])}}(),D.forEach(t=>{t&&t.fn&&e.push(t.fn())}),Promise.all(e).then(()=>{A&&window.requestAnimationFrame(()=>F())}).catch(t=>console.log("animationLoop error: ",t))},T=function(){A=!0,F()},H=(t,e)=>{if(!J(e))throw new Error(`core/utilities addStrings() error - no delta argument supplied ${t}, ${e}`);if(null!=e){let i=!(!t.substring&&!e.substring);return V(t)?t+=V(e)?e:parseFloat(e):t=parseFloat(t)+(V(e)?e:parseFloat(e)),i?t+"%":t}return t},M=t=>{let e,i,s;if(!J(t))throw new Error("core/utilities convertTime() error - no argument supplied");if(V(t))return["ms",t];if(!t.substring)throw new Error("core/utilities convertTime() error - invalid argument: "+t);if(e=t.match(/^\d+\.?\d*(\D*)/),i=e[1].toLowerCase?e[1].toLowerCase():"ms",s=parseFloat(t),!V(s))throw new Error("core/base error - convertTime() argument converts to NaN: "+t);switch(i){case"s":s*=1e3;break;case"%":break;default:i="ms"}return[i,s]},I=t=>t.toFixed?0==t?t:isNaN(t)?0:t<-1e-6||t>1e-6?t:0:t,B=()=>{},L=function(t){return t},$=function(){return this},j=()=>Promise.resolve(!0),N=()=>performance.now().toString(36)+Math.random().toString(36).substr(2),X=function(t,e,i){return e+t*(i-e)},Y=t=>"boolean"==typeof t,z=t=>"[object HTMLCanvasElement]"===Object.prototype.toString.call(t),G=t=>!!(t&&t.querySelector&&t.dispatchEvent),W=t=>"function"==typeof t,V=t=>!(void 0===t||!t.toFixed||Number.isNaN(t)),U=t=>"[object Object]"===Object.prototype.toString.call(t),q=t=>!(!t||!t.type||"Quaternion"!==t.type),_=(t,e)=>{if(!U(t)||!U(e))throw new Error(`core/utilities mergeOver() error - insufficient arguments supplied ${t}, ${e}`);for(let i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},Z=(t,e)=>{if(!U(t)||!U(e))throw new Error(`core/utilities mergeDiscard() error - insufficient arguments supplied ${t}, ${e}`);return Object.entries(e).forEach(([i,s])=>{null===s?delete t[i]:t[i]=e[i]}),t},Q=(t,e)=>{if(!tt(t,e))throw new Error(`core/utilities pushUnique() error - insufficient arguments supplied ${t}, ${e}`);if(!Array.isArray(t))throw new Error("core/utilities pushUnique() error - argument not an array "+t);return Array.isArray(e)?e.forEach(e=>Q(t,e)):t.indexOf(e)<0&&t.push(e),t},K=(t,e)=>{if(!tt(t,e))throw new Error(`core/utilities removeItem() error - insufficient arguments supplied ${t}, ${e}`);if(!Array.isArray(t))throw new Error("core/utilities removeItem() error - argument not an array "+t);let i=t.indexOf(e);return i>=0&&t.splice(i,1),t},J=t=>void 0!==t,tt=(...t)=>t.every(t=>void 0!==t),et=(...t)=>t.find(t=>void 0!==t),it=(...t)=>!!t.find(t=>void 0!==t);var st=function(){var t=4022871197;return function(e){if(e){e=e.toString();for(var i=0;i<e.length;i++){var s=.02519603282416938*(t+=e.charCodeAt(i));s-=t=s>>>0,t=(s*=t)>>>0,t+=4294967296*(s-=t)}return 2.3283064365386963e-10*(t>>>0)}t=4022871197}},nt=function(t){return function(){var e,i,s=48,n=1,r=s,o=new Array(s),a=0,l=new st;for(e=0;e<s;e++)o[e]=l(Math.random());var h=function(){++r>=s&&(r=0);var t=1768863*o[r]+2.3283064365386963e-10*n;return o[r]=t-(n=0|t)},c=function(t){return Math.floor(t*(h()+11102230246251565e-32*(2097152*h()|0)))};c.string=function(t){var e,i="";for(e=0;e<t;e++)i+=String.fromCharCode(33+c(94));return i};var u=function(){var t=Array.prototype.slice.call(arguments);for(e=0;e<t.length;e++)for(i=0;i<s;i++)o[i]-=l(t[e]),o[i]<0&&(o[i]+=1)};return c.cleanString=function(t){return t=(t=(t=t.replace(/(^\s*)|(\s*$)/gi,"")).replace(/[\x00-\x1F]/gi,"")).replace(/\n /,"\n")},c.hashString=function(t){for(t=c.cleanString(t),l(t),e=0;e<t.length;e++)for(a=t.charCodeAt(e),i=0;i<s;i++)o[i]-=l(a),o[i]<0&&(o[i]+=1)},c.seed=function(t){var e,i,s,n;null==t&&(t=Math.random()),"string"!=typeof t&&(e=t,i=function(t,e){return"function"==typeof e?e.toString():e},t=JSON.stringify(e,function(t,e){var i=[],s=[];return null==e&&(e=function(t,e){return i[0]===e?"[Circular ~]":"[Circular ~."+s.slice(0,i.indexOf(e)).join(".")+"]"}),function(n,r){if(i.length>0){var o=i.indexOf(this);~o?i.splice(o+1):i.push(this),~o?s.splice(o,1/0,n):s.push(n),~i.indexOf(r)&&(r=e.call(this,n,r))}else i.push(r);return null==t?r:t.call(this,n,r)}}(i,n),s)),c.initState(),c.hashString(t)},c.addEntropy=function(){var t=[];for(e=0;e<arguments.length;e++)t.push(arguments[e]);u(a+++(new Date).getTime()+t.join("")+Math.random())},c.initState=function(){for(l(),e=0;e<s;e++)o[e]=l(" ");n=1,r=s},c.done=function(){l=null},void 0!==t&&c.seed(t),c.range=function(t){return c(t)},c.random=function(){return c(Number.MAX_VALUE-1)/Number.MAX_VALUE},c.floatBetween=function(t,e){return c.random()*(e-t)+t},c.intBetween=function(t,e){return Math.floor(c.random()*(e-t+1))+t},c}()};const rt=function(t){return 1-Math.cos(t*Math.PI/2)},ot=function(t){return Math.sin(t*Math.PI/2)},at=function(t){return-(Math.cos(Math.PI*t)-1)/2},lt=function(t){return t*t},ht=function(t){return 1-(1-t)*(1-t)},ct=function(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2},ut=function(t){return t*t*t},dt=function(t){return 1-Math.pow(1-t,3)},ft=function(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2},pt=function(t){return t*t*t*t},mt=function(t){return 1-Math.pow(1-t,4)},gt=function(t){return t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2},yt=function(t){return t*t*t*t*t},bt=function(t){return 1-Math.pow(1-t,5)},kt=function(t){return t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2},St=function(t){return 0===t?0:Math.pow(2,10*t-10)},Ot=function(t){return 1===t?1:1-Math.pow(2,-10*t)},Pt=function(t){return 0===t||1===t?t:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2},vt=function(t){return 1-Math.sqrt(1-Math.pow(t,2))},wt=function(t){return Math.sqrt(1-Math.pow(t-1,2))},At=function(t){return t<.5?(1-Math.sqrt(1-Math.pow(2*t,2)))/2:(Math.sqrt(1-Math.pow(-2*t+2,2))+1)/2},Ct=function(t){return 2.70158*t*t*t-1.70158*t*t},Dt=function(t){return 1+2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2)},Rt=function(t){let e=2.5949095;return t<.5?Math.pow(2*t,2)*(7.189819*t-e)/2:(Math.pow(2*t-2,2)*((e+1)*(2*t-2)+e)+2)/2},Et=function(t){const e=2*Math.PI/3;return 0===t||1===t?t:-Math.pow(2,10*t-10)*Math.sin((10*t-10.75)*e)},Ft=function(t){const e=2*Math.PI/3;return 0===t||1===t?t:Math.pow(2,-10*t)*Math.sin((10*t-.75)*e)+1},Tt=function(t){const e=2*Math.PI/4.5;return 0===t||1===t?t:t<.5?-Math.pow(2,20*t-10)*Math.sin((20*t-11.125)*e)/2:Math.pow(2,-20*t+10)*Math.sin((20*t-11.125)*e)/2+1},Ht=function(t){const e=7.5625,i=2.75;return(t=1-t)<1/i?1-e*t*t:t<2/i?1-(e*(t-=1.5/i)*t+.75):t<2.5/i?1-(e*(t-=2.25/i)*t+.9375):1-(e*(t-=2.625/i)*t+.984375)},Mt=function(t){const e=7.5625,i=2.75;return t<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375},It=function(t){const e=7.5625,i=2.75;let s;return t<.5?(s=(t=1-2*t)<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375,(1-s)/2):(s=(t=2*t-1)<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375,(1+s)/2)},Bt=function(t,e,i={}){if("function"==typeof window.IntersectionObserver&&t&&t.run){let s=new IntersectionObserver((e,i)=>{e.forEach(e=>{e.isIntersecting?!t.isRunning()&&t.run():e.isIntersecting||t.isRunning()&&t.halt()})},i);return e&&e.domElement&&s.observe(e.domElement),function(){s.disconnect()}}return B},Lt=function(t,e,i){if(!W(e))throw new Error(`core/document addListener() error - no function supplied: ${t}, ${i}`);return jt(t,e,i,"removeEventListener"),jt(t,e,i,"addEventListener"),function(){$t(t,e,i)}},$t=function(t,e,i){if(!W(e))throw new Error(`core/document removeListener() error - no function supplied: ${t}, ${i}`);jt(t,e,i,"removeEventListener")},jt=function(t,e,i,s){let n,r=[].concat(t);n=i.substring?document.body.querySelectorAll(i):Array.isArray(i)?i:[i],navigator.pointerEnabled||navigator.msPointerEnabled?Xt(r,e,n,s):Nt(r,e,n,s)},Nt=function(t,e,i,s){t.forEach(t=>{i.forEach(i=>{if(!(G(i)||i.document||i.characterSet))throw new Error(`core/document actionMouseListener() error - bad target: ${t}, ${i}`);switch(t){case"move":i[s]("mousemove",e,!1),i[s]("touchmove",e,!1),i[s]("touchfollow",e,!1);break;case"up":i[s]("mouseup",e,!1),i[s]("touchend",e,!1);break;case"down":i[s]("mousedown",e,!1),i[s]("touchstart",e,!1);break;case"leave":i[s]("mouseleave",e,!1),i[s]("touchleave",e,!1);break;case"enter":i[s]("mouseenter",e,!1),i[s]("touchenter",e,!1)}})})},Xt=function(t,e,i,s){t.forEach(t=>{i.forEach(i=>{if(!(G(i)||i.document||i.characterSet))throw new Error(`core/document actionPointerListener() error - bad target: ${t}, ${i}`);switch(t){case"move":i[s]("pointermove",e,!1);break;case"up":i[s]("pointerup",e,!1);break;case"down":i[s]("pointerdown",e,!1);break;case"leave":i[s]("pointerleave",e,!1);break;case"enter":i[s]("pointerenter",e,!1)}})})},Yt=function(t,e,i){if(!W(e))throw new Error(`core/document addNativeListener() error - no function supplied: ${t}, ${i}`);return Gt(t,e,i,"removeEventListener"),Gt(t,e,i,"addEventListener"),function(){zt(t,e,i)}},zt=function(t,e,i){if(!W(e))throw new Error(`core/document removeNativeListener() error - no function supplied: ${t}, ${i}`);Gt(t,e,i,"removeEventListener")},Gt=function(t,e,i,s){let n,r=[].concat(t);n=i.substring?document.body.querySelectorAll(i):Array.isArray(i)?i:[i],r.forEach(t=>{n.forEach(i=>{if(!(G(i)||i.document||i.characterSet))throw new Error(`core/document actionNativeListener() error - bad target: ${t}, ${i}`);i[s](t,e,!1)})})},Wt=window.matchMedia("(prefers-reduced-motion: reduce)");let Vt=Wt.matches,Ut=B,qt=B;const _t=()=>{Vt?Ut():qt()};Wt.addEventListener("change",()=>{Vt=Wt.matches,_t()});const Zt=window.matchMedia("(prefers-color-scheme: dark)");let Qt=Zt.matches,Kt=B,Jt=B;const te=()=>{Qt?Kt():Jt()};Zt.addEventListener("change",()=>{Qt=Zt.matches,te()});function ee(t={}){t.defs={},t.getters={},t.setters={},t.deltaSetters={},t.get=function(t){if(J(t)){let e=this.getters[t];if(e)return e.call(this);{let e=this.defs[t];if(void 0!==e){let i=this[t];return void 0!==i?i:e}}}return null},t.set=function(t={}){if(Object.keys(t).length){let e,i=this.setters,s=this.defs;Object.entries(t).forEach(([t,n])=>{t&&"name"!==t&&null!=n&&(e=i[t],e?e.call(this,n):void 0!==s[t]&&(this[t]=n))},this)}return this},t.setDelta=function(t={}){if(Object.keys(t).length){let e,i=this.deltaSetters,s=this.defs;Object.entries(t).forEach(([t,n])=>{t&&"name"!==t&&null!=n&&(e=i[t],e?e.call(this,n):void 0!==s[t]&&(this[t]=H(this[t],n)))},this)}return this};return t.defs=_(t.defs,{name:""}),t.packetExclusions=[],t.packetExclusionsByRegex=[],t.packetCoordinates=[],t.packetObjects=[],t.packetFunctions=[],t.saveAsPacket=function(t={}){Y(t)&&t&&(t={includeDefaults:!0});let e=this.defs,i=Object.keys(e),s=this.packetExclusions,n=this.packetExclusionsByRegex,r=this.packetCoordinates,o=this.packetObjects,a=this.packetFunctions,l=t.includeDefaults||!1,h={};return l&&!Array.isArray(l)?l=Object.keys(e):l||(l=[]),Object.entries(this).forEach(([t,e])=>{let c,u=!0;if(i.indexOf(t)<0&&(u=!1),u&&s.indexOf(t)>=0&&(u=!1),u&&(c=n.some(e=>new RegExp(e).test(t)),c&&(u=!1)),u)if(a.indexOf(t)>=0){if(J(e)&&null!==e){let i=this.stringifyFunction(e);i&&i.length&&(h[t]=i)}}else o.indexOf(t)>=0&&this[t]&&this[t].name?h[t]=this[t].name:r.indexOf(t)>=0?(l.indexOf(t)>=0||e[0]||e[1])&&(h[t]=e):(c=this.processPacketOut(t,e,l),c&&(h[t]=e))},this),h=this.finalizePacketOut(h,t),JSON.stringify([this.name,this.type,this.lib,h])},t.stringifyFunction=function(t){let e=t.toString().match(/\(([\s\S]*?)\)[\s\S]*?\{([\s\S]*)\}/),i=e[1],s=e[2];return!!tt(i,s)&&`${i}~~~${s}`},t.processPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},t.finalizePacketOut=function(t,e){return t},t.importPacket=function(t){let e=this;const i=function(t){return new Promise((i,s)=>{let n;t.substring||s(new Error("Packet url supplied for import is not a string")),"["===t[0]?(n=e.actionPacket(t),n&&n.lib?i(n):s(n)):t.indexOf('"name":')>=0?s(new Error("Bad packet supplied for import")):fetch(t).then(t=>{if(!t.ok)throw new Error(`Packet import from server failed - ${t.status}: ${t.statusText} - ${t.url}`);return t.text()}).then(t=>{if(n=e.actionPacket(t),!n||!n.lib)throw n;i(n)}).catch(t=>s(t))})};if(Array.isArray(t)){let e=[];return t.forEach(t=>e.push(i(t))),new Promise((t,i)=>{Promise.all(e).then(e=>t(e)).catch(t=>i(t))})}if(t.substring)return i(t);Promise.reject(new Error("Argument supplied for packet import is not a string or array of strings"))},t.actionPacketExclusions=["Image","Sprite","Video","Canvas","Stack"],t.actionPacket=function(t){try{if(t&&t.substring){if("["===t[0]){let e,i,s,n;try{[e,i,s,n]=JSON.parse(t)}catch(t){throw new Error("Failed to process packet due to JSON parsing error - "+t.message)}if(tt(e,i,s,n)){if(this.actionPacketExclusions.indexOf(i)>=0)throw new Error("Failed to process packet - Stacks, Canvases and visual assets are excluded from the packet system");let t=x[s][e];if(t)t.set(n);else{if(n.outerHTML&&n.host){let t=document.querySelector("#"+n.host);if(t){let i=document.createElement("div");i.innerHTML=n.outerHTML;let s=i.firstElementChild;s&&(s.id=e,t.appendChild(s),n.domElement=s)}}if(t=new O[i](n),!t)throw new Error("Failed to create Scrawl-canvas object from supplied packet")}if(t.packetFunctions.forEach(e=>this.actionPacketFunctions(t,e)),n.anchor&&t.anchor&&t.anchor.packetFunctions.forEach(e=>{t.anchor[e]=n.anchor[e],this.actionPacketFunctions(t.anchor,e),t.anchor.build()}),n.glyphStyles&&t.glyphStyles&&n.glyphStyles.forEach((e,i)=>{U(e)&&t.setGlyphStyles(e,i)}),t)return t;throw new Error("Failed to process supplied packet")}throw new Error("Failed to process packet - JSON string holds incomplete data")}throw new Error("Failed to process packet - JSON string does not represent an array")}throw new Error("Failed to process packet - not a JSON string")}catch(t){return console.log(t),t}},t.actionPacketFunctions=function(t,e){let i=t[e];if(J(i)&&null!==i&&i.substring)if("~~~"===i)t[e]=B;else{let s,n,r;[s,n]=i.split("~~~"),s=s.split(","),s=s.map(t=>t.trim()),n.indexOf("[native code]")<0?(r=new Function(...s,n),t[e]=r.bind(t)):t[e]=B}},t.clone=function(t={}){let e,i,s=this.name;this.name=t.name||"",t.useNewTicker?(i=this.ticker,this.ticker=null,e=this.saveAsPacket(),this.ticker=i):e=this.saveAsPacket(),this.name=s;let n=this.actionPacket(e);return this.packetFunctions.forEach(t=>{this[t]&&(n[t]=this[t])}),n=this.postCloneAction(n,t),n.set(t),n},t.postCloneAction=function(t,e){return t},t.kill=function(){return this.deregister()},t.makeName=function(t){return t&&t.substring&&x[this.lib+"names"].indexOf(t)<0?this.name=t:this.name=N(),this},t.register=function(){if(!J(this.name))throw new Error("core/base error - register() name not set: "+this);let t=x[this.lib+"names"],e=x[this.lib];return this.isArtefact&&(Q(s,this.name),i[this.name]=this),this.isAsset&&(Q(r,this.name),n[this.name]=this),Q(t,this.name),e[this.name]=this,this},t.deregister=function(){if(!J(this.name))throw new Error("core/base error - deregister() name not set: "+this);let t=x[this.lib+"names"],e=x[this.lib];return this.isArtefact&&(K(s,this.name),delete i[this.name]),this.isAsset&&(K(r,this.name),delete n[this.name]),K(t,this.name),delete e[this.name],this},t}const Animation=function(t={}){return this.makeName(t.name),this.order=J(t.order)?t.order:this.defs.order,this.fn=t.fn||j,this.onRun=t.onRun||B,this.onHalt=t.onHalt||B,this.onKill=t.onKill||B,this.register(),t.delay||this.run(),this};let ie=Animation.prototype=Object.create(Object.prototype);ie.type="Animation",ie.lib="animation",ie.isArtefact=!1,ie.isAsset=!1,ie=ee(ie);ie.defs=_(ie.defs,{order:1,fn:null,onRun:null,onHalt:null,onKill:null}),ie.stringifyFunction=B,ie.processPacketOut=B,ie.finalizePacketOut=B,ie.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},ie.clone=$,ie.run=function(){return this.onRun(),Q(R,this.name),E(),this},ie.isRunning=function(){return R.indexOf(this.name)>=0},ie.halt=function(){return this.onHalt(),K(R,this.name),E(),this},ie.kill=function(){return this.onKill(),K(R,this.name),E(),this.deregister(),!0};const se=function(t){return new Animation(t)};O.Animation=Animation;const ne=[];let re=!1,oe=!1,ae=!1;const le={x:0,y:0,scrollX:0,scrollY:0,w:0,h:0,type:"mouse"},he=function(t){let e=document.documentElement.clientWidth,i=document.documentElement.clientHeight;le.w===e&&le.h===i||(le.w=e,le.h=i,oe=!0,ae=!0)},ce=function(t){let e=window.pageXOffset,i=window.pageYOffset;le.scrollX===e&&le.scrollY===i||(le.x+=e-le.scrollX,le.y+=i-le.scrollY,le.scrollX=e,le.scrollY=i,oe=!0)},ue=function(t){let e=Math.round(t.pageX),i=Math.round(t.pageY);le.x===e&&le.y===i||(le.type=navigator.pointerEnabled?"pointer":"mouse",le.x=e,le.y=i,oe=!0)},de=function(t){if(("touchstart"===t.type||"touchmove"===t.type)&&t.touches&&t.touches[0]){let e=t.touches[0],i=Math.round(e.pageX),s=Math.round(e.pageY);le.x===i&&le.y===s||(le.type="touch",le.x=i,le.y=s,fe())}},fe=function(){ne.forEach(t=>pe(t))},pe=function(t){let e=i[t];if(!J(e))throw new Error("core/userInteraction updateUiSubscribedElement() error - artefact does not exist: "+t);let s=e.domElement;if(!G(s))throw new Error("core/userInteraction updateUiSubscribedElement() error - DOM element missing: "+t);let n=s.getBoundingClientRect(),r=Math.round(n.left+window.pageXOffset),o=Math.round(n.top+window.pageYOffset);e.here||(e.here={});let a=e.here;if(a.w=Math.round(n.width),a.h=Math.round(n.height),a.type=le.type,e.localMouseListener?(a.localListener=!0,a.active=!1,a.normX=!!a.originalWidth&&a.x/a.originalWidth,a.normY=!!a.originalHeight&&a.y/a.originalHeight,a.offsetX=r,a.offsetY=o,a.x>e.activePadding&&a.x<a.originalWidth-e.activePadding&&a.y>0+e.activePadding&&a.y<a.originalHeight-e.activePadding&&(a.active=!0)):(a.localListener=!1,a.active=!0,a.x=Math.round(le.x-r),a.y=Math.round(le.y-o),a.normX=!!a.w&&a.x/a.w,a.normY=!!a.h&&a.y/a.h,a.offsetX=r,a.offsetY=o,(a.normX<0||a.normX>1||a.normY<0||a.normY>1)&&(a.active=!1)),"Canvas"===e.type&&e.updateBaseHere(a,e.fit),e.checkForResize&&!e.dirtyDimensions&&!e.dirtyDomDimensions){let[t,i]=e.currentDimensions;if("Canvas"===e.type){e.computedStyles||(e.computedStyles=window.getComputedStyle(e.domElement));let s=e.computedStyles,n=Math.floor(a.w-parseFloat(s.borderLeftWidth)-parseFloat(s.borderRightWidth)-parseFloat(s.paddingLeft)-parseFloat(s.paddingRight)),r=Math.floor(a.h-parseFloat(s.borderTopWidth)-parseFloat(s.borderBottomWidth)-parseFloat(s.paddingTop)-parseFloat(s.paddingBottom));t===n&&i===r||e.set({dimensions:[n,r]})}else t===a.w&&i===a.h||e.set({dimensions:[a.w,a.h]})}},me=se({name:"coreListenersTracker",order:0,delay:!0,fn:function(){return new Promise(t=>{ne.length||t(!1),re&&oe&&(oe=!1,fe()),ae&&(ae=!1,function(){for(const[t,e]of Object.entries(h))"Phrase"===e.type&&(e.dirtyDimensions=!0,e.dirtyFont=!0)}()),t(!0)})}}),ge=function(){ye("removeEventListener"),ye("addEventListener"),re=!0,oe=!0,me.run()},ye=function(t){navigator.pointerEnabled||navigator.msPointerEnabled?(window[t]("pointermove",ue,!1),window[t]("pointerup",ue,!1),window[t]("pointerdown",ue,!1),window[t]("pointerleave",ue,!1),window[t]("pointerenter",ue,!1)):(window[t]("mousemove",ue,!1),window[t]("mouseup",ue,!1),window[t]("mousedown",ue,!1),window[t]("mouseleave",ue,!1),window[t]("mouseenter",ue,!1),window[t]("touchmove",de,!1),window[t]("touchstart",de,!1),window[t]("touchend",de,!1),window[t]("touchcancel",de,!1)),window[t]("scroll",ce,!1),window[t]("resize",he,!1)},be=function(){he(),oe=!0},ke=URL.createObjectURL(new Blob(['let packet,packetFiltersArray,source,work,cache,actions,workstore={},workstoreLastAccessed={};const createResultObject=function(e){return{r:new Uint8ClampedArray(e),g:new Uint8ClampedArray(e),b:new Uint8ClampedArray(e),a:new Uint8ClampedArray(e)}},unknit=function(e){let t=e.data,l=Math.floor(t.length/4);source=createResultObject(l),e.channels=source;let n=source.r,r=source.g,o=source.b,s=source.a,u=(work=createResultObject(l)).r,a=work.g,c=work.b,i=work.a,f=0;for(let e=0,l=t.length;e<l;e+=4)n[f]=t[e],r[f]=t[e+1],o[f]=t[e+2],s[f]=t[e+3],u[f]=t[e],a[f]=t[e+1],c[f]=t[e+2],i[f]=t[e+3],f++},knit=function(){let e=packet.image.data,t=work.r,l=work.g,n=work.b,r=work.a,o=0;for(let s=0,u=e.length;s<u;s+=4)e[s]=t[o],e[s+1]=l[o],e[s+2]=n[o],e[s+3]=r[o],o++};onmessage=function(e){packet=e.data,packetFiltersArray=packet.filters;let t=Object.keys(workstore),l=Date.now()-3e3;t.forEach(e=>{workstoreLastAccessed[e]<l&&(delete workstore[e],delete workstoreLastAccessed[e])}),actions=[],(cache={}).source=packet.image,packetFiltersArray.forEach(e=>actions.push(...e.actions)),actions.length&&(unknit(cache.source),actions.forEach(e=>theBigActionsObject[e.action]&&theBigActionsObject[e.action](e)),knit()),postMessage(packet)},onerror=function(e){console.log("error"+e.message),postMessage(packet)};const buildImageGrid=function(e){if(e||(e=cache.source),e&&e.width&&e.height){let t=`grid-${e.width}-${e.height}`;if(workstore[t])return workstoreLastAccessed[t]=Date.now(),workstore[t];let l=[],n=0;for(let t=0,r=e.height;t<r;t++){let t=[];for(let l=0,r=e.width;l<r;l++)t.push(n),n++;l.push(t)}return workstore[t]=l,workstoreLastAccessed[t]=Date.now(),l}return!1},buildAlphaTileSets=function(e,t,l,n,r,o,s,u){if(u||(u=cache.source),u&&u.width&&u.height){let s=u.width,a=u.height;(e=e.toFixed&&!isNaN(e)?e:1)<1&&(e=1),(t=t.toFixed&&!isNaN(t)?t:1)<1&&(t=1),e+(l=l.toFixed&&!isNaN(l)?l:1)>=s&&(e=s-l-1),t+(n=n.toFixed&&!isNaN(n)?n:1)>=a&&(t=a-n-1),e<1&&(e=1),t<1&&(t=1),e+l>=s&&(l=s-e-1),t+n>=a&&(n=a-t-1);let c=e+l,i=t+n;(r=r.toFixed&&!isNaN(r)?r:0)<0&&(r=0),r>=c&&(r=c-1),(o=o.toFixed&&!isNaN(o)?o:0)<0&&(o=0),o>=i&&(o=i-1);let f=`alphatileset-${s}-${a}-${e}-${t}-${l}-${n}-${r}-${o}`;if(workstore[f])return workstoreLastAccessed[f]=Date.now(),workstore[f];let h,g,p,d,b,k,w,R=[];for(d=o-i,b=a;d<b;d+=i)for(g=r-c,p=s;g<p;g+=c){for(h=[],k=d,w=d+t;k<w;k++)if(k>=0&&k<a)for(let t=g,l=g+e;t<l;t++)t>=0&&t<s&&h.push(k*s+t);for(R.push([].concat(h)),h=[],k=d+t,w=d+t+n;k<w;k++)if(k>=0&&k<a)for(let t=g,l=g+e;t<l;t++)t>=0&&t<s&&h.push(k*s+t);for(R.push([].concat(h)),h=[],k=d,w=d+t;k<w;k++)if(k>=0&&k<a)for(let t=g+e,n=g+e+l;t<n;t++)t>=0&&t<s&&h.push(k*s+t);for(R.push([].concat(h)),h=[],k=d+t,w=d+t+n;k<w;k++)if(k>=0&&k<a)for(let t=g+e,n=g+e+l;t<n;t++)t>=0&&t<s&&h.push(k*s+t);R.push([].concat(h))}return workstore[f]=R,workstoreLastAccessed[f]=Date.now(),R}return!1},buildImageTileSets=function(e,t,l,n,r){if(r||(r=cache.source),r&&r.width&&r.height){let o=r.width,s=r.height;(e=e.toFixed&&!isNaN(e)?e:1)<1&&(e=1),e>=o&&(e=o-1),(t=t.toFixed&&!isNaN(t)?t:1)<1&&(t=1),t>=s&&(t=s-1),(l=l.toFixed&&!isNaN(l)?l:0)<0&&(l=0),l>=e&&(l=e-1),(n=n.toFixed&&!isNaN(n)?n:0)<0&&(n=0),n>=t&&(n=t-1);let u=`imagetileset-${o}-${s}-${e}-${t}-${l}-${n}`;if(workstore[u])return workstoreLastAccessed[u]=Date.now(),workstore[u];let a=[];for(let r=n-t,u=s;r<u;r+=t)for(let n=l-e,u=o;n<u;n+=e){let l=[];for(y=r,yz=r+t;y<yz;y++)if(y>=0&&y<s)for(let t=n,r=n+e;t<r;t++)t>=0&&t<o&&l.push(y*o+t);l.length&&a.push(l)}return workstore[u]=a,workstoreLastAccessed[u]=Date.now(),a}return!1},buildHorizontalBlur=function(e,t){t&&t.toFixed&&!isNaN(t)||(t=0);let l=e.length,n=e[0].length,r=`blur-h-${n}-${l}-${t}`;if(workstore[r])return workstoreLastAccessed[r]=Date.now(),workstore[r];let o=[];for(let r=0;r<l;r++)for(let l=0;l<n;l++){let s=[];for(let o=l-t,u=l+t+1;o<u;o++)o>=0&&o<n&&s.push(e[r][o]);o[r*n+l]=s}return workstore[r]=o,workstoreLastAccessed[r]=Date.now(),o},buildVerticalBlur=function(e,t){t&&t.toFixed&&!isNaN(t)||(t=0);let l=e.length,n=e[0].length,r=`blur-v-${n}-${l}-${t}`;if(workstore[r])return workstoreLastAccessed[r]=Date.now(),workstore[r];let o=[];for(let r=0;r<n;r++)for(let s=0;s<l;s++){let u=[];for(let n=s-t,o=s+t+1;n<o;n++)n>=0&&n<l&&u.push(e[n][r]);o[s*n+r]=u}return workstore[r]=o,workstoreLastAccessed[r]=Date.now(),o},buildMatrixGrid=function(e,t,l,n,r,o){o||(o=cache.source),(null==e||e<1)&&(e=1),(null==t||t<1)&&(t=1),null==l||l<0?l=0:l>=e&&(l=e-1),null==n||n<0?n=0:n>=t&&(n=t-1);let s=o.width,u=o.height,a=`matrix-${s}-${u}-${e}-${t}-${l}-${n}`;if(workstore[a])return workstoreLastAccessed[a]=Date.now(),workstore[a];let c,i,f,h,g,p,d=o.data.length,b=[],k=[];for(f=-n,h=t-n;f<h;f++)for(c=-l,i=e-l;c<i;c++)b.push(f*s+c);for(f=0;f<u;f++)for(c=0;c<s;c++){let e=f*s+c,t=[];for(g=0,p=b.length;g<p;g++){let l=e+b[g];l<0?l+=d:l>=d&&(l-=d),t.push(l)}k.push(t)}return workstore[a]=k,workstoreLastAccessed[a]=Date.now(),k},checkChannelLevelsParameters=function(e){const t=function(e,t=!1){if(e.toFixed)return e<0?[[0,255,0]]:e>255?[[0,255,255]]:isNaN(e)?t?[[0,255,255]]:[[0,255,0]]:[[0,255,e]];if(e.substring&&(e=e.split(",")),Array.isArray(e)){if(!e.length)return e;if(Array.isArray(e[0]))return e;if((e=e.map(e=>parseInt(e,10))).sort((e,t)=>e-t),1==e.length)return[[0,255,e[0]]];let t,l,n=[];for(let r=0,o=e.length;r<o;r++)t=0,l=255,0!=r&&(t=Math.ceil(e[r-1]+(e[r]-e[r-1])/2)),r!=o-1&&(l=Math.floor(e[r]+(e[r+1]-e[r])/2)),n.push([t,l,e[r]]);return n}return t?[[0,255,255]]:[[0,255,0]]};e.red=t(e.red),e.green=t(e.green),e.blue=t(e.blue),e.alpha=t(e.alpha,!0)},cacheOutput=function(e,t,l){cache[e]=t},copyOver=function(e,t){let{r:l,g:n,b:r,a:o}=e,{r:s,g:u,b:a,a:c}=t;for(let e=0;e<l.length;e++)s[e]=l[e],u[e]=n[e],a[e]=r[e],c[e]=o[e]},getInputAndOutputDimensions=function(e){let t=cache.source,l=[];return e.lineIn&&"source"!=e.lineIn&&"source-alpha"!=e.lineIn&&cache[e.lineIn]&&(t=cache[e.lineIn]),l.push(t.width,t.height),e.lineOut&&cache[e.lineOut]&&(t=cache[e.lineOut]),l.push(t.width,t.height),t=cache.source,e.lineMix&&"source"!=e.lineMix&&"source-alpha"!=e.lineMix&&cache[e.lineMix]&&(t=cache[e.lineMix]),l.push(t.width,t.height),l},getInputAndOutputChannels=function(e){let t=work,l=t.r.length,n=cache.source;if(e.lineIn)if("source"==e.lineIn)t=n.channels;else if("source-alpha"==e.lineIn){let e=(t=createResultObject(l)).a,r=n.channels.a;for(let t=0;t<l;t++)e[t]=r[t]}else cache[e.lineIn]&&(t=(n=cache[e.lineIn]).channels);let r,o=!1;if(e.lineMix)if("source"==e.lineMix)o=cache.source.channels;else if("source-alpha"==e.lineMix){let e=(o=createResultObject(l)).a,t=cache.source.channels.a;for(let n=0;n<l;n++)e[n]=t[n]}else cache[e.lineMix]&&(o=cache[e.lineMix].channels);return e.lineOut?cache[e.lineOut]?r=cache[e.lineOut].channels:(r=createResultObject(l),cache[e.lineOut]={width:n.width,height:n.height,channels:r}):r=createResultObject(l),[t,r,o]},processResults=function(e,t,l){let n=e.r,r=e.g,o=e.b,s=e.a,u=t.r,a=t.g,c=t.b,i=t.a;if(1===l)copyOver(t,e);else if(l>0){antiRatio=1-l;for(let e=0,t=n.length;e<t;e++)n[e]=Math.floor(n[e]*antiRatio+u[e]*l),r[e]=Math.floor(r[e]*antiRatio+a[e]*l),o[e]=Math.floor(o[e]*antiRatio+c[e]*l),s[e]=Math.floor(s[e]*antiRatio+i[e]*l)}},getHSLfromRGB=function(e,t,l){let n=Math.min(e,t,l),r=Math.max(e,t,l),o=(n+r)/2,s=0;n!==r&&(s=o<=.5?(r-n)/(r+n):(r-n)/(2-r-n));let u=0;return u=r===e?(t-l)/(r-n):r===t?2+(l-e)/(r-n):4+(e-t)/(r-n),(u*=60)<0&&(u+=360),[u,s,o]},getRGBfromHSL=function(e,t,l){if(!t){let e=Math.floor(255*l);return[e,e,e]}let n=l<.5?l*(t+1):l+t-l*t,r=2*l-n;const o=function(e,t,l){return 6*e<1?l+6*(t-l)*e:2*e<1?t:2*e<2?l+6*(t-l)*(.666*e):l};let s=(e/=360)+.333,u=e,a=e-.333;return s<0&&(s+=1),s>1&&(s-=1),u<0&&(u+=1),u>1&&(u-=1),a<0&&(a+=1),a>1&&(a-=1),[255*o(s,n,r),255*o(u,n,r),255*o(a,n,r)]},theBigActionsObject={"alpha-to-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,includeRed:o,includeGreen:s,includeBlue:u,excludeRed:a,excludeGreen:c,excludeBlue:i,lineOut:f}=e;null==r&&(r=1),null==o&&(o=!0),null==s&&(s=!0),null==u&&(u=!0),null==a&&(a=!0),null==c&&(c=!0),null==i&&(i=!0);const{r:h,g:g,b:p,a:d}=t,{r:b,g:k,b:w,a:R}=l;for(let e=0;e<n;e++)b[e]=o?d[e]:a?0:h[e],k[e]=s?d[e]:c?0:g[e],w[e]=u?d[e]:i?0:p[e];R.fill(255,0,R.length-1),f?processResults(l,work,1-r):processResults(work,l,r)},"area-alpha":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,tileWidth:o,tileHeight:s,offsetX:u,offsetY:a,gutterWidth:c,gutterHeight:i,areaAlphaLevels:f,lineOut:h}=e;null==r&&(r=1),null==o&&(o=1),null==s&&(s=1),null==u&&(u=0),null==a&&(a=0),null==c&&(c=1),null==i&&(i=1),null==f&&(f=[255,0,0,0]);let g=buildAlphaTileSets(o,s,c,i,u,a);Array.isArray(f)||(f=[255,0,0,0]);const{r:p,g:d,b:b,a:k}=t,{r:w,g:R,b:O,a:A}=l;for(let e=0;e<n;e++)w[e]=p[e],R[e]=d[e],O[e]=b[e];g.forEach((e,t)=>{for(let l=0,n=e.length;l<n;l++)k[e[l]]&&(A[e[l]]=f[t%4])}),h?processResults(l,work,1-r):processResults(work,l,r)},"average-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,includeRed:o,includeGreen:s,includeBlue:u,excludeRed:a,excludeGreen:c,excludeBlue:i,lineOut:f}=e;null==r&&(r=1),null==o&&(o=!0),null==s&&(s=!0),null==u&&(u=!0),null==a&&(a=!1),null==c&&(c=!1),null==i&&(i=!1);let h=0;o&&h++,s&&h++,u&&h++;const{r:g,g:p,b:d,a:b}=t,{r:k,g:w,b:R,a:O}=l;for(let e=0;e<n;e++)if(b[e])if(h){let t=0;o&&(t+=g[e]),s&&(t+=p[e]),u&&(t+=d[e]),t=Math.floor(t/h),k[e]=a?0:t,w[e]=c?0:t,R[e]=i?0:t,O[e]=b[e]}else k[e]=a?0:g[e],w[e]=c?0:p[e],R[e]=i?0:d[e],O[e]=b[e];else k[e]=g[e],w[e]=p[e],R[e]=d[e],O[e]=b[e];f?processResults(l,work,1-r):processResults(work,l,r)},binary:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,red:o,green:s,blue:u,alpha:a,lineOut:c}=e;null==r&&(r=1),null==o&&(o=0),null==s&&(s=0),null==u&&(u=0),null==a&&(a=0);const{r:i,g:f,b:h,a:g}=t,{r:p,g:d,b:b,a:k}=l;for(let e=0;e<n;e++)p[e]=o?i[e]>o?255:0:i[e],d[e]=s?f[e]>s?255:0:f[e],b[e]=u?h[e]>u?255:0:h[e],k[e]=a?g[e]>a?255:0:g[e];c?processResults(l,work,1-r):processResults(work,l,r)},blend:function(e){let[t,l,n]=getInputAndOutputChannels(e),{opacity:r,blend:o,offsetX:s,offsetY:u,lineOut:a}=(l.r.length,e);null==r&&(r=1),null==o&&(o=""),null==s&&(s=0),null==u&&(u=0);const{r:c,g:i,b:f,a:h}=t,{r:g,g:p,b:d,a:b}=l,{r:k,g:w,b:R,a:O}=n;let[A,y,I,m,M,x]=getInputAndOutputDimensions(e);const B=function(e,t,l){g[t]=l.r[e],p[t]=l.g[e],d[t]=l.b[e],b[t]=l.a[e]},G=function(e,t){let l=e-s,n=t-u,r=-1;return l>=0&&l<M&&n>=0&&n<x&&(r=n*M+l),[t*A+e,r]},C=function(e,l){return[t.r[e]/255,t.g[e]/255,t.b[e]/255,t.a[e]/255,n.r[l]/255,n.g[l]/255,n.b[l]/255,n.a[l]/255]},L=(e,t)=>255*(e+t*(1-e));switch(o){case"color-burn":const e=(e,t)=>1==t?255:0==e?0:255*(1-Math.min(1,(1-t)/e));for(let l=0;l<y;l++)for(let r=0;r<A;r++){let[o,s]=G(r,l);if(s<0)B(o,o,t);else if(h[o])if(O[s]){let[t,l,n,r,u,a,c,i]=C(o,s);g[o]=e(t,u),p[o]=e(l,a),d[o]=e(n,c),b[o]=L(r,i)}else B(o,o,t);else B(s,o,n)}break;case"color-dodge":const l=(e,t)=>0==t?0:1==e?255:255*Math.min(1,t/(1-e));for(let e=0;e<y;e++)for(let r=0;r<A;r++){let[o,s]=G(r,e);if(s<0)B(o,o,t);else if(h[o])if(O[s]){let[e,t,n,r,u,a,c,i]=C(o,s);g[o]=l(e,u),p[o]=l(t,a),d[o]=l(n,c),b[o]=L(r,i)}else B(o,o,t);else B(s,o,n)}break;case"darken":const r=(e,t)=>e<t?e:t;for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[o,s]=G(l,e);s<0?B(o,o,t):h[o]?O[s]?(g[o]=r(c[o],k[s]),p[o]=r(i[o],w[s]),d[o]=r(f[o],R[s]),b[o]=L(h[o]/255,O[s]/255)):B(o,o,t):B(s,o,n)}break;case"difference":const s=(e,t)=>255*Math.abs(e-t);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let[e,t,l,n,u,a,c,i]=C(r,o);g[r]=s(e,u),p[r]=s(t,a),d[r]=s(l,c),b[r]=L(n,i)}else B(o,r,n)}break;case"exclusion":const u=(e,t)=>255*(e+t-2*t*e);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let[e,t,l,n,s,a,c,i]=C(r,o);g[r]=u(e,s),p[r]=u(t,a),d[r]=u(l,c),b[r]=L(n,i)}else B(o,r,n)}break;case"hard-light":const a=(e,t)=>e<=.5?e*t*255:255*(t+(e-t*e));for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let[e,t,l,n,s,u,c,i]=C(r,o);g[r]=a(e,s),p[r]=a(t,u),d[r]=a(l,c),b[r]=L(n,i)}else B(o,r,n)}break;case"lighten":const I=(e,t)=>e>t?e:t;for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);o<0?B(r,r,t):h[r]?(g[r]=I(c[r],k[o]),p[r]=I(i[r],w[o]),d[r]=I(f[r],R[o]),b[r]=L(h[r]/255,O[o]/255)):B(o,r,n)}break;case"lighter":const m=(e,t)=>255*(e+t);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let[e,t,l,n,s,u,a,c]=C(r,o);g[r]=m(e,s),p[r]=m(t,u),d[r]=m(l,a),b[r]=L(n,c)}else B(o,r,n)}break;case"multiply":const M=(e,t)=>e*t*255;for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r])if(O[o]){let[e,t,l,n,s,u,a,c]=C(r,o);g[r]=M(e,s),p[r]=M(t,u),d[r]=M(l,a),b[r]=L(n,c)}else B(r,r,t);else B(o,r,n)}break;case"overlay":const x=(e,t)=>e>=.5?e*t*255:255*(t+(e-t*e));for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let[e,t,l,n,s,u,a,c]=C(r,o);g[r]=x(e,s),p[r]=x(t,u),d[r]=x(l,a),b[r]=L(n,c)}else B(o,r,n)}break;case"screen":const $=(e,t)=>255*(t+(e-t*e));for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let[e,t,l,n,s,u,a,c]=C(r,o);g[r]=$(e,s),p[r]=$(t,u),d[r]=$(l,a),b[r]=L(n,c)}else B(o,r,n)}break;case"soft-light":const N=(e,t)=>{let l=t<=.25?((16*t-12)*t+4)*t:Math.sqrt(t);return e<=.5?255*(t-(1-2*e)*t*(1-t)):255*(t+(2*e-1)*(l-t))};for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r])if(O[o]){let[e,t,l,n,s,u,a,c]=C(r,o);g[r]=N(e,s),p[r]=N(t,u),d[r]=N(l,a),b[r]=L(n,c)}else B(r,r,t);else B(o,r,n)}break;case"color":const v=(e,t,l,n,r,o)=>{let[s,u,a]=getHSLfromRGB(e,t,l),[c,i,f]=getHSLfromRGB(n,r,o);return getRGBfromHSL(s,u,f)};for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r])if(O[o]){let[e,t,l,n,s,u,a,c]=C(r,o),[i,f,h]=v(e,t,l,s,u,a);g[r]=i,p[r]=f,d[r]=h,b[r]=L(n,c)}else B(r,r,t);else B(o,r,n)}break;case"hue":const H=(e,t,l,n,r,o)=>{let[s,u,a]=getHSLfromRGB(e,t,l),[c,i,f]=getHSLfromRGB(n,r,o);return getRGBfromHSL(s,i,f)};for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r])if(O[o]){let[e,t,l,n,s,u,a,c]=C(r,o),[i,f,h]=H(e,t,l,s,u,a);g[r]=i,p[r]=f,d[r]=h,b[r]=L(n,c)}else B(r,r,t);else B(o,r,n)}break;case"luminosity":const D=(e,t,l,n,r,o)=>{let[s,u,a]=getHSLfromRGB(e,t,l),[c,i,f]=getHSLfromRGB(n,r,o);return getRGBfromHSL(c,i,a)};for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r])if(O[o]){let[e,t,l,n,s,u,a,c]=C(r,o),[i,f,h]=D(e,t,l,s,u,a);g[r]=i,p[r]=f,d[r]=h,b[r]=L(n,c)}else B(r,r,t);else B(o,r,n)}break;case"saturation":const S=(e,t,l,n,r,o)=>{let[s,u,a]=getHSLfromRGB(e,t,l),[c,i,f]=getHSLfromRGB(n,r,o);return getRGBfromHSL(c,u,f)};for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r])if(O[o]){let[e,t,l,n,s,u,a,c]=C(r,o),[i,f,h]=S(e,t,l,s,u,a);g[r]=i,p[r]=f,d[r]=h,b[r]=L(n,c)}else B(r,r,t);else B(o,r,n)}break;default:const F=(e,t,l,n)=>t*e+n*l*(1-t);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[r,o]=G(l,e);if(o<0)B(r,r,t);else if(h[r]){let e=h[r]/255,t=O[o]/255;g[r]=F(c[r],e,k[o],t),p[r]=F(i[r],e,w[o],t),d[r]=F(f[r],e,R[o],t),b[r]=L(e,t)}else B(o,r,n)}}a?processResults(l,work,1-r):processResults(work,l,r)},blur:function(e){let t,l,[n,r]=getInputAndOutputChannels(e),o=n.r.length,{opacity:s,radius:u,passes:a,processVertical:c,processHorizontal:i,includeRed:f,includeGreen:h,includeBlue:g,includeAlpha:p,step:d,lineOut:b}=e;if(null==s&&(s=1),null==u&&(u=0),null==a&&(a=1),null==c&&(c=!0),null==i&&(i=!0),null==f&&(f=!0),null==h&&(h=!0),null==g&&(g=!0),null==p&&(p=!1),null==d&&(d=1),i||c){let e=buildImageGrid();i&&(t=buildHorizontalBlur(e,u)),c&&(l=buildVerticalBlur(e,u))}const{r:k,g:w,b:R,a:O}=n,{r:A,g:y,b:I,a:m}=r,M=function(e,t,l,n,r){if(e){let e=t[l];if(null!=e){let t=e.length,l=0,o=0;if(r){for(let s=0;s<t;s+=d)r[e[s]]&&(o+=n[e[s]],l++);return o/l}for(let l=0;l<t;l++)o+=n[e[l]];return o/t}}return n[l]};if(a&&(i||c)){const e=createResultObject(o),{r:s,g:u,b:d,a:b}=e;copyOver(n,e);for(let n=0;n<a;n++){if(i){for(let e=0;e<o;e++)(p||b[e])&&(A[e]=M(f,t,e,s,b),y[e]=M(h,t,e,u,b),I[e]=M(g,t,e,d,b),m[e]=M(p,t,e,b,!1));(c||n<a-1)&&copyOver(r,e)}if(c){for(let e=0;e<o;e++)(p||b[e])&&(A[e]=M(f,l,e,s,b),y[e]=M(h,l,e,u,b),I[e]=M(g,l,e,d,b),m[e]=M(p,l,e,b,!1));n<a-1&&copyOver(r,e)}}}else copyOver(n,r);b?processResults(r,work,1-s):processResults(work,r,s)},"channels-to-alpha":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,includeRed:o,includeGreen:s,includeBlue:u,lineOut:a}=e;null==r&&(r=1),null==o&&(o=!0),null==s&&(s=!0),null==u&&(u=!0);let c=0;o&&c++,s&&c++,u&&c++;const{r:i,g:f,b:h,a:g}=t,{r:p,g:d,b:b,a:k}=l;for(let e=0;e<n;e++)if(p[e]=i[e],d[e]=f[e],b[e]=h[e],c){let t=0;o&&(t+=i[e]),s&&(t+=f[e]),u&&(t+=h[e]),t=Math.floor(t/c),k[e]=t}else k[e]=g[e];a?processResults(l,work,1-r):processResults(work,l,r)},chroma:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,ranges:o,lineOut:s}=e;null==r&&(r=1),null==o&&(o=[]);const{r:u,g:a,b:c,a:f}=t,{r:h,g:g,b:p,a:d}=l;for(let e=0;e<n;e++){let t=!1,l=u[e],n=a[e],r=c[e];for(i=0,iz=o.length;i<iz;i++){o[i];let[e,s,u,a,c,f]=o[i];if(l>=e&&l<=a&&n>=s&&n<=c&&r>=u&&r<=f){t=!0;break}}h[e]=u[e],g[e]=a[e],p[e]=c[e],d[e]=t?0:f[e]}s?processResults(l,work,1-r):processResults(work,l,r)},"clamp-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,lowRed:o,lowGreen:s,lowBlue:u,highRed:a,highGreen:c,highBlue:i,lineOut:f}=e;null==r&&(r=1),null==o&&(o=0),null==s&&(s=0),null==u&&(u=0),null==a&&(a=255),null==c&&(c=255),null==i&&(i=255);const h=a-o,g=c-s,p=i-u,{r:d,g:b,b:k,a:w}=t,{r:R,g:O,b:A,a:y}=l;for(let e=0;e<n;e++)if(w[e]){let t=d[e]/255,l=b[e]/255,n=k[e]/255;R[e]=o+t*h,O[e]=s+l*g,A[e]=u+n*p,y[e]=w[e]}else R[e]=d[e],O[e]=b[e],A[e]=k[e],y[e]=w[e];f?processResults(l,work,1-r):processResults(work,l,r)},"colors-to-alpha":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,red:o,green:s,blue:u,opaqueAt:a,transparentAt:c,lineOut:i}=e;null==r&&(r=1),null==o&&(o=0),null==s&&(s=255),null==u&&(u=0),null==a&&(a=1),null==c&&(c=0);const f=Math.max((o+s+u)/3,(255-o+(255-s)+(255-u))/3),h=c*f,g=a*f,p=g-h,d=function(e,t,l){let n=(Math.abs(o-e)+Math.abs(s-t)+Math.abs(u-l))/3;return n<h?0:n>g?255:(n-h)/p*255},{r:b,g:k,b:w,a:R}=t,{r:O,g:A,b:y,a:I}=l;for(let e=0;e<n;e++)O[e]=b[e],A[e]=k[e],y[e]=w[e],I[e]=d(b[e],k[e],w[e]);i?processResults(l,work,1-r):processResults(work,l,r)},compose:function(e){let[t,l,n]=getInputAndOutputChannels(e),{opacity:r,compose:o,offsetX:s,offsetY:u,lineOut:a}=(l.r.length,e);null==r&&(r=1),null==o&&(o=""),null==s&&(s=0),null==u&&(u=0);const{r:c,g:i,b:f,a:h}=t,{r:g,g:p,b:d,a:b}=l,{r:k,g:w,b:R,a:O}=n;let[A,y,I,m,M,x]=getInputAndOutputDimensions(e);const B=function(e,t,l){g[t]=l.r[e],p[t]=l.g[e],d[t]=l.b[e],b[t]=l.a[e]},G=function(e,t){let l=e-s,n=t-u,r=-1;return l>=0&&l<M&&n>=0&&n<x&&(r=n*M+l),[t*A+e,r]};switch(o){case"source-only":copyOver(t,l);break;case"source-atop":const e=(e,t,l,n)=>t*e*n+n*l*(1-t);for(let t=0;t<y;t++)for(let l=0;l<A;l++){let[n,r]=G(l,t);if(r>=0){let t=h[n]/255,l=O[r]/255;g[n]=e(c[n],t,k[r],l),p[n]=e(i[n],t,w[r],l),d[n]=e(f[n],t,R[r],l),b[n]=255*(t*l+l*(1-t))}}break;case"source-in":const r=(e,t,l)=>t*e*l;for(let e=0;e<y;e++)for(let t=0;t<A;t++){let[l,n]=G(t,e);if(n>=0){let e=h[l]/255,t=O[n]/255;g[l]=r(c[l],e,t),p[l]=r(i[l],e,t),d[l]=r(f[l],e,t),b[l]=e*t*255}}break;case"source-out":const s=(e,t,l)=>t*e*(1-l);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[n,r]=G(l,e);if(r<0)B(n,n,t);else{let e=h[n]/255,t=O[r]/255;g[n]=s(c[n],e,t),p[n]=s(i[n],e,t),d[n]=s(f[n],e,t),b[n]=e*(1-t)*255}}break;case"destination-only":for(let e=0;e<y;e++)for(let t=0;t<A;t++){let[l,r]=G(t,e);r>=0&&B(r,l,n)}break;case"destination-atop":const u=(e,t,l,n)=>t*e*(1-n)+n*l*t;for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[n,r]=G(l,e);if(r<0)B(n,n,t);else{let e=h[n]/255,t=O[r]/255;g[n]=u(c[n],e,k[r],t),p[n]=u(i[n],e,w[r],t),d[n]=u(f[n],e,R[r],t),b[n]=255*(e*(1-t)+t*e)}}break;case"destination-over":const a=(e,t,l,n)=>t*e*(1-n)+n*l;for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[n,r]=G(l,e);if(r<0)B(n,n,t);else{let e=h[n]/255,t=O[r]/255;g[n]=a(c[n],e,k[r],t),p[n]=a(i[n],e,w[r],t),d[n]=a(f[n],e,R[r],t),b[n]=255*(e*(1-t)+t)}}break;case"destination-in":const I=(e,t,l)=>t*e*l;for(let e=0;e<y;e++)for(let t=0;t<A;t++){let[l,n]=G(t,e);if(n>=0){let e=h[l]/255,t=O[n]/255;g[l]=I(k[n],t,e),p[l]=I(w[n],t,e),d[l]=I(R[n],t,e),b[l]=e*t*255}}break;case"destination-out":const m=(e,t,l)=>l*e*(1-t);for(let e=0;e<y;e++)for(let t=0;t<A;t++){let[l,n]=G(t,e);if(n>=0){let e=h[l]/255,t=O[n]/255;g[l]=m(k[n],e,t),p[l]=m(w[n],e,t),d[l]=m(R[n],e,t),b[l]=t*(1-e)*255}}break;case"clear":break;case"xor":const M=(e,t,l,n)=>t*e*(1-n)+n*l*(1-t);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[n,r]=G(l,e);if(r<0)B(n,n,t);else{let e=h[n]/255,t=O[r]/255;g[n]=M(c[n],e,k[r],t),p[n]=M(i[n],e,w[r],t),d[n]=M(f[n],e,R[r],t),b[n]=255*(e*(1-t)+t*(1-e))}}break;default:const x=(e,t,l,n)=>t*e+n*l*(1-t);for(let e=0;e<y;e++)for(let l=0;l<A;l++){let[n,r]=G(l,e);if(r<0)B(n,n,t);else{let e=h[n]/255,t=O[r]/255;g[n]=x(c[n],e,k[r],t),p[n]=x(i[n],e,w[r],t),d[n]=x(f[n],e,R[r],t),b[n]=255*(e+t*(1-e))}}}a?processResults(l,work,1-r):processResults(work,l,r)},displace:function(e){let[t,l,n]=getInputAndOutputChannels(e),{opacity:r,channelX:o,channelY:s,scaleX:u,scaleY:a,offsetX:c,offsetY:i,transparentEdges:f,lineOut:h}=(t.r.length,e);null==r&&(r=1),null==o&&(o="red"),null==s&&(s="green"),null==u&&(u=1),null==a&&(a=1),null==c&&(c=0),null==i&&(i=0),null==f&&(f=!1);const{r:g,g:p,b:d,a:b}=t,{r:k,g:w,b:R,a:O}=l,{r:A,g:y,b:I,a:m}=n;o="red"==o?A:"green"==o?y:"blue"==o?I:m,s="red"==s?A:"green"==s?y:"blue"==s?I:m;let[M,x,B,G,C,L]=getInputAndOutputDimensions(e);const $=function(e,t,l){e<0?O[t]=0:(k[t]=l.r[e],w[t]=l.g[e],R[t]=l.b[e],O[t]=l.a[e])},N=function(e,t){let l=e+c,n=t+i,r=-1;return l>=0&&l<C&&n>=0&&n<L&&(r=n*C+l),[t*M+e,r]};for(let e=0;e<x;e++)for(let l=0;l<M;l++){let[n,r]=N(l,e);if(r>=0){let c,i=Math.floor(l+(127-o[r])/127*u),h=Math.floor(e+(127-s[r])/127*a);f?c=i<0||i>=M||h<0||h>=x?-1:h*M+i:(i<0&&(i=0),i>=M&&(i=M-1),h<0&&(h=0),h>=x&&(h=x-1),c=h*M+i),$(c,n,t)}else $(n,n,t)}h?processResults(l,work,1-r):processResults(work,l,r)},emboss:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,strength:o,angle:s,tolerance:u,keepOnlyChangedAreas:a,postProcessResults:c,lineOut:i}=e;for(null==r&&(r=1),null==o&&(o=1),null==s&&(s=0),null==u&&(u=0),null==a&&(a=!1),null==c&&(c=!1),o=Math.abs(o);s<0;)s+=360;s%=360;let f=Math.floor(s/45),h=s%45/45*o,g=new Array(9);(g=g.fill(0,0,9))[4]=1,0==f?(g[5]=o-h,g[8]=h,g[3]=-g[5],g[0]=-g[8]):1==f?(g[8]=o-h,g[7]=h,g[0]=-g[8],g[1]=-g[7]):2==f?(g[7]=o-h,g[6]=h,g[1]=-g[7],g[2]=-g[6]):3==f?(g[6]=o-h,g[3]=h,g[2]=-g[6],g[5]=-g[3]):4==f?(g[3]=o-h,g[0]=h,g[5]=-g[3],g[8]=-g[0]):5==f?(g[0]=o-h,g[1]=h,g[8]=-g[0],g[7]=-g[1]):6==f?(g[1]=o-h,g[2]=h,g[7]=-g[1],g[6]=-g[2]):(g[2]=o-h,g[5]=h,g[6]=-g[2],g[3]=-g[5]);const{r:p,g:d,b:b,a:k}=t,{r:w,g:R,b:O,a:A}=l;grid=buildMatrixGrid(3,3,1,1);const y=function(e,t){let l=0;for(let n=0,r=t.length;n<r;n++)g[n]&&(l+=e[t[n]]*g[n]);return l};for(let e=0;e<n;e++)k[e]&&(w[e]=y(p,grid[e]),R[e]=y(d,grid[e]),O[e]=y(b,grid[e]),A[e]=k[e],c&&w[e]>=p[e]-u&&w[e]<=p[e]+u&&R[e]>=d[e]-u&&R[e]<=d[e]+u&&O[e]>=b[e]-u&&O[e]<=b[e]+u&&(a?A[e]=0:(w[e]=127,R[e]=127,O[e]=127)));i?processResults(l,work,1-r):processResults(work,l,r)},flood:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,red:o,green:s,blue:u,alpha:a,lineOut:c}=(Math.floor,e);null==r&&(r=1),null==o&&(o=0),null==s&&(s=0),null==u&&(u=0),null==a&&(a=255);const{r:i,g:f,b:h,a:g}=l;i.fill(o,0,n-1),f.fill(s,0,n-1),h.fill(u,0,n-1),g.fill(a,0,n-1),c?processResults(l,work,1-r):processResults(work,l,r)},grayscale:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,lineOut:o}=e;null==r&&(r=1);const{r:s,g:u,b:a,a:c}=t,{r:i,g:f,b:h,a:g}=l;for(let e=0;e<n;e++){let t=Math.floor(.2126*s[e]+.7152*u[e]+.0722*a[e]);i[e]=t,f[e]=t,h[e]=t,g[e]=c[e]}o?processResults(l,work,1-r):processResults(work,l,r)},"invert-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,includeRed:o,includeGreen:s,includeBlue:u,includeAlpha:a,lineOut:c}=e;null==r&&(r=1),null==o&&(o=!0),null==s&&(s=!0),null==u&&(u=!0),null==a&&(a=!1);const{r:i,g:f,b:h,a:g}=t,{r:p,g:d,b:b,a:k}=l;for(let e=0;e<n;e++)p[e]=o?255-i[e]:i[e],d[e]=s?255-f[e]:f[e],b[e]=u?255-h[e]:h[e],k[e]=a?255-g[e]:g[e];c?processResults(l,work,1-r):processResults(work,l,r)},"lock-channels-to-levels":function(e){checkChannelLevelsParameters(e);const t=function(e,t){if(!t.length)return e;for(let l=0,n=t.length;l<n;l++){let[n,r,o]=t[l];if(e>=n&&e<=r)return o}};let[l,n]=getInputAndOutputChannels(e),r=l.r.length,{opacity:o,red:s,green:u,blue:a,alpha:c,lineOut:i}=e;null==o&&(o=1),null==s&&(s=[0]),null==u&&(u=[0]),null==a&&(a=[0]),null==c&&(c=[255]);const{r:f,g:h,b:g,a:p}=l,{r:d,g:b,b:k,a:w}=n;for(let e=0;e<r;e++)d[e]=t(f[e],s),b[e]=t(h[e],u),k[e]=t(g[e],a),w[e]=t(p[e],c);i?processResults(n,work,1-o):processResults(work,n,o)},matrix:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,includeRed:o,includeGreen:s,includeBlue:u,includeAlpha:a,width:c,height:i,offsetX:f,offsetY:h,weights:g,lineOut:p}=e;null==r&&(r=1),null==o&&(o=!0),null==s&&(s=!0),null==u&&(u=!0),null==a&&(a=!1),(null==c||c<1)&&(c=3),(null==i||i<1)&&(i=3),null==f&&(f=1),null==h&&(h=1),null==g&&((g=[].fill(0,0,c*i-1))[Math.floor(g.length/2)+1]=1),grid=buildMatrixGrid(c,i,f,h,t.a);const d=function(e,t){let l=0;for(let n=0,r=t.length;n<r;n++)g[n]&&(l+=e[t[n]]*g[n]);return l},{r:b,g:k,b:w,a:R}=t,{r:O,g:A,b:y,a:I}=l;for(let e=0;e<n;e++)R[e]&&(O[e]=o?d(b,grid[e]):b[e],A[e]=s?d(k,grid[e]):k[e],y[e]=u?d(w,grid[e]):w[e],I[e]=a?d(R,grid[e]):R[e]);p?processResults(l,work,1-r):processResults(work,l,r)},"modulate-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,red:o,green:s,blue:u,alpha:a,saturation:c,lineOut:i}=e;null==r&&(r=1),null==o&&(o=1),null==s&&(s=1),null==u&&(u=1),null==a&&(a=1),null==c&&(c=!1);const{r:f,g:h,b:g,a:p}=t,{r:d,g:b,b:k,a:w}=l;if(c)for(let e=0;e<n;e++)d[e]=127+(f[e]-127)*o,b[e]=127+(h[e]-127)*s,k[e]=127+(g[e]-127)*u,w[e]=127+(p[e]-127)*a;else for(let e=0;e<n;e++)d[e]=f[e]*o,b[e]=h[e]*s,k[e]=g[e]*u,w[e]=p[e]*a;i?processResults(l,work,1-r):processResults(work,l,r)},offset:function(e){let[t,l]=getInputAndOutputChannels(e),{opacity:n,offsetRedX:r,offsetRedY:o,offsetGreenX:s,offsetGreenY:u,offsetBlueX:a,offsetBlueY:c,offsetAlphaX:i,offsetAlphaY:f,lineOut:h}=e;null==n&&(n=1),null==r&&(r=0),null==o&&(o=0),null==s&&(s=0),null==u&&(u=0),null==a&&(a=0),null==c&&(c=0),null==i&&(i=0),null==f&&(f=0);let g=!1;r==s&&r==a&&r==i&&o==u&&o==c&&o==f&&(g=!0);const{r:p,g:d,b:b,a:k}=t,{r:w,g:R,b:O,a:A}=l;let y,I,m,M,x,B,G,C,L,$,N=buildImageGrid(),v=N[0].length,H=N.length;for(let e=0;e<H;e++)for(let t=0;t<v;t++)k[L=N[e][t]]&&(g?(I=e+o,(y=t+r)>=0&&y<v&&I>=0&&I<H&&(w[$=N[I][y]]=p[L],R[$]=d[L],O[$]=b[L],A[$]=k[L])):(I=e+o,m=t+s,M=e+u,x=t+a,B=e+c,G=t+i,C=e+f,(y=t+r)>=0&&y<v&&I>=0&&I<H&&(w[$=N[I][y]]=p[L]),m>=0&&m<v&&M>=0&&M<H&&(R[$=N[M][m]]=d[L]),x>=0&&x<v&&B>=0&&B<H&&(O[$=N[B][x]]=b[L]),G>=0&&G<v&&C>=0&&C<H&&(A[$=N[C][G]]=k[L])));h?processResults(l,work,1-n):processResults(work,l,n)},pixelate:function(e){const t=function(e,t,l){let n=l.reduce((t,l)=>t+e[l],0);n=Math.floor(n/l.length);for(let e=0,r=l.length;e<r;e++)t[l[e]]=n},l=function(e,t,l){let n;for(let r=0,o=l.length;r<o;r++)t[n=l[r]]=e[n]};let[n,r]=getInputAndOutputChannels(e),{opacity:o,tileWidth:s,tileHeight:u,offsetX:a,offsetY:c,includeRed:i,includeGreen:f,includeBlue:h,includeAlpha:g,lineOut:p}=(n.r.length,e);null==o&&(o=1),null==i&&(i=!0),null==f&&(f=!0),null==h&&(h=!0),null==g&&(g=!1),null==s&&(s=1),null==u&&(u=1),null==a&&(a=0),null==c&&(c=0);const d=buildImageTileSets(s,u,a,c),{r:b,g:k,b:w,a:R}=n,{r:O,g:A,b:y,a:I}=r;d.forEach(e=>{i?t(b,O,e):l(b,O,e),f?t(k,A,e):l(k,A,e),h?t(w,y,e):l(w,y,e),g?t(R,I,e):l(R,I,e)}),p?processResults(r,work,1-o):processResults(work,r,o)},"process-image":function(e){const{assetData:t,lineOut:l}=e;if(l&&l.substring&&l.length&&t&&t.width&&t.height&&t.data){let e=t.data,n=e.length,r=createResultObject(n/4),o=r.r,s=r.g,u=r.b,a=r.a,c=0;for(let t=0;t<n;t+=4)o[c]=e[t],s[c]=e[t+1],u[c]=e[t+2],a[c]=e[t+3],c++;t.channels=r,cache[l]=t}},"set-channel-to-level":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,includeRed:o,includeGreen:s,includeBlue:u,includeAlpha:a,level:c,lineOut:i}=e;null==r&&(r=1),null==o&&(o=!1),null==s&&(s=!1),null==u&&(u=!1),null==a&&(a=!1),null==c&&(c=0);const{r:f,g:h,b:g,a:p}=t,{r:d,g:b,b:k,a:w}=l;for(let e=0;e<n;e++)d[e]=o?c:f[e],b[e]=s?c:h[e],k[e]=u?c:g[e],w[e]=a?c:p[e];i?processResults(l,work,1-r):processResults(work,l,r)},"step-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,r=Math.floor,{opacity:o,red:s,green:u,blue:a,lineOut:c}=e;null==o&&(o=1),null==s&&(s=1),null==u&&(u=1),null==a&&(a=1),null==s&&(s=1),null==u&&(u=1),null==a&&(a=1);const{r:i,g:f,b:h,a:g}=t,{r:p,g:d,b:b,a:k}=l;for(let e=0;e<n;e++)p[e]=r(i[e]/s)*s,d[e]=r(f[e]/u)*u,b[e]=r(h[e]/a)*a,k[e]=g[e];c?processResults(l,work,1-o):processResults(work,l,o)},threshold:function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,low:o,high:s,level:u,lineOut:a}=e;null==r&&(r=1),null==o&&(o=[0,0,0]),null==s&&(s=[255,255,255]),null==u&&(u=128);const{r:c,g:i,b:f,a:h}=t,{r:g,g:p,b:d,a:b}=l;let[k,w,R]=o,[O,A,y]=s;for(let e=0;e<n;e++){Math.floor(.2126*c[e]+.7152*i[e]+.0722*f[e])<u?(g[e]=k,p[e]=w,d[e]=R):(g[e]=O,p[e]=A,d[e]=y),b[e]=h[e]}a?processResults(l,work,1-r):processResults(work,l,r)},"tint-channels":function(e){let[t,l]=getInputAndOutputChannels(e),n=t.r.length,{opacity:r,redInRed:o,redInGreen:s,redInBlue:u,greenInRed:a,greenInGreen:c,greenInBlue:i,blueInRed:f,blueInGreen:h,blueInBlue:g,lineOut:p}=e;null==r&&(r=1),null==o&&(o=1),null==s&&(s=0),null==u&&(u=0),null==a&&(a=0),null==c&&(c=1),null==i&&(i=0),null==f&&(f=0),null==h&&(h=0),null==g&&(g=1);const{r:d,g:b,b:k,a:w}=t,{r:R,g:O,b:A,a:y}=l;for(let e=0;e<n;e++){let t=d[e],l=b[e],n=k[e];R[e]=Math.floor(t*o+l*a+n*f),O[e]=Math.floor(t*s+l*c+n*h),A[e]=Math.floor(t*u+l*i+n*g),y[e]=w[e]}p?processResults(l,work,1-r):processResults(work,l,r)},"user-defined-legacy":function(e){let[t,l]=getInputAndOutputChannels(e),{opacity:n,lineOut:r}=e;null==n&&(n=1),copyOver(t,l),r?processResults(l,work,1-n):processResults(work,l,n)}};'],{type:"text/javascript"})),Filter=function(t={}){return this.makeName(t.name),this.register(),this.actions=[],this.set(t),this};let Se=Filter.prototype=Object.create(Object.prototype);Se.type="Filter",Se.lib="filter",Se.isArtefact=!1,Se.isAsset=!1,Se=ee(Se);Se.defs=_(Se.defs,{actions:null,method:"",lineIn:"",lineMix:"",lineOut:"",opacity:1,alpha:255,angle:0,areaAlphaLevels:null,asset:"",blend:"normal",blue:0,blueInBlue:0,blueInGreen:0,blueInRed:0,channelX:"red",channelY:"green",clamp:0,compose:"source-over",copyHeight:1,copyWidth:1,copyX:0,copyY:0,excludeAlpha:!0,excludeBlue:!1,excludeGreen:!1,excludeRed:!1,green:0,greenInBlue:0,greenInGreen:0,greenInRed:0,gutterHeight:1,gutterWidth:1,height:1,highBlue:255,highGreen:255,highRed:255,includeAlpha:!1,includeBlue:!0,includeGreen:!0,includeRed:!0,keepOnlyChangedAreas:!1,level:0,lowBlue:0,lowGreen:0,lowRed:0,offsetAlphaX:0,offsetAlphaY:0,offsetBlueX:0,offsetBlueY:0,offsetGreenX:0,offsetGreenY:0,offsetRedX:0,offsetRedY:0,offsetX:0,offsetY:0,opaqueAt:1,passes:1,postProcessResults:!0,processHorizontal:!0,processVertical:!0,radius:1,ranges:null,red:0,redInBlue:0,redInGreen:0,redInRed:0,scaleX:1,scaleY:1,smoothing:0,step:1,strength:1,tileHeight:1,tileWidth:1,tolerance:0,transparentAt:0,transparentEdges:!1,useNaturalGrayscale:!1,weights:null,width:1}),Se.kill=function(){let t=this.name;return Object.entries(h).forEach(([e,i])=>{let s=i.filters;s&&s.indexOf(t)>=0&&K(s,t)}),Object.entries(u).forEach(([e,i])=>{let s=i.filters;s&&s.indexOf(t)>=0&&K(s,t)}),Object.entries(a).forEach(([e,i])=>{let s=i.filters;s&&s.indexOf(t)>=0&&K(s,t)}),this.deregister(),this};Se.setters,Se.deltaSetters;Se.set=function(t={}){if(Object.keys(t).length){let e,i=this.setters,s=this.defs;Object.entries(t).forEach(([t,n])=>{t&&"name"!==t&&null!=n&&(e=i[t],e?e.call(this,n):void 0!==s[t]&&(this[t]=n))},this)}return this.method&&Oe[this.method]&&Oe[this.method](this),this},Se.setDelta=function(t={}){if(Object.keys(t).length){let e,i=this.deltaSetters,s=this.defs;Object.entries(t).forEach(([t,n])=>{t&&"name"!==t&&null!=n&&(e=i[t],e?e.call(this,n):void 0!==s[t]&&(this[t]=addStrings(this[t],n)))},this)}return this.method&&Oe[this.method]&&Oe[this.method](this),this};const Oe={alphaToChannels:function(t){t.actions=[{action:"alpha-to-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:null==t.includeRed||t.includeRed,includeGreen:null==t.includeGreen||t.includeGreen,includeBlue:null==t.includeBlue||t.includeBlue,excludeRed:null==t.excludeRed||t.excludeRed,excludeGreen:null==t.excludeGreen||t.excludeGreen,excludeBlue:null==t.excludeBlue||t.excludeBlue}]},areaAlpha:function(t){t.actions=[{action:"area-alpha",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,tileWidth:null!=t.tileWidth?t.tileWidth:1,tileHeight:null!=t.tileHeight?t.tileHeight:1,offsetX:null!=t.offsetX?t.offsetX:0,offsetY:null!=t.offsetY?t.offsetY:0,gutterWidth:null!=t.gutterWidth?t.gutterWidth:1,gutterHeight:null!=t.gutterHeight?t.gutterHeight:1,areaAlphaLevels:null!=t.areaAlphaLevels?t.areaAlphaLevels:[255,0,0,0]}]},binary:function(t){t.actions=[{action:"binary",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:null!=t.red?t.red:0,green:null!=t.green?t.green:0,blue:null!=t.blue?t.blue:0,alpha:null!=t.alpha?t.alpha:0}]},blend:function(t){t.actions=[{action:"blend",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",lineMix:null!=t.lineMix?t.lineMix:"",blend:null!=t.blend?t.blend:"normal",offsetX:null!=t.offsetX?t.offsetX:0,offsetY:null!=t.offsetY?t.offsetY:0,opacity:null!=t.opacity?t.opacity:1}]},blue:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,excludeRed:!0,excludeGreen:!0}]},blur:function(t){t.actions=[{action:"blur",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:null==t.includeRed||t.includeRed,includeGreen:null==t.includeGreen||t.includeGreen,includeBlue:null==t.includeBlue||t.includeBlue,includeAlpha:null!=t.includeAlpha&&t.includeAlpha,processHorizontal:null==t.processHorizontal||t.processHorizontal,processVertical:null==t.processVertical||t.processVertical,radius:null!=t.radius?t.radius:1,passes:null!=t.passes?t.passes:1,step:null!=t.step?t.step:1}]},brightness:function(t){let e=null!=t.level?t.level:1;t.actions=[{action:"modulate-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:e,green:e,blue:e}]},channelLevels:function(t){t.actions=[{action:"lock-channels-to-levels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:null!=t.red?t.red:[0],green:null!=t.green?t.green:[0],blue:null!=t.blue?t.blue:[0],alpha:null!=t.alpha?t.alpha:[255]}]},channels:function(t){t.actions=[{action:"modulate-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:null!=t.red?t.red:1,green:null!=t.green?t.green:1,blue:null!=t.blue?t.blue:1,alpha:null!=t.alpha?t.alpha:1}]},channelstep:function(t){t.actions=[{action:"step-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:null!=t.red?t.red:1,green:null!=t.green?t.green:1,blue:null!=t.blue?t.blue:1}]},channelsToAlpha:function(t){t.actions=[{action:"channels-to-alpha",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:null==t.includeRed||t.includeRed,includeGreen:null==t.includeGreen||t.includeGreen,includeBlue:null==t.includeBlue||t.includeBlue}]},chroma:function(t){t.actions=[{action:"chroma",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,ranges:null!=t.ranges?t.ranges:[]}]},chromakey:function(t){t.actions=[{action:"colors-to-alpha",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:null!=t.red?t.red:0,green:null!=t.green?t.green:255,blue:null!=t.blue?t.blue:0,transparentAt:null!=t.transparentAt?t.transparentAt:0,opaqueAt:null!=t.opaqueAt?t.opaqueAt:1}]},clampChannels:function(t){t.actions=[{action:"clamp-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,lowRed:null!=t.lowRed?t.lowRed:0,lowGreen:null!=t.lowGreen?t.lowGreen:0,lowBlue:null!=t.lowBlue?t.lowBlue:0,highRed:null!=t.highRed?t.highRed:255,highGreen:null!=t.highGreen?t.highGreen:255,highBlue:null!=t.highBlue?t.highBlue:255}]},compose:function(t){t.actions=[{action:"compose",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",lineMix:null!=t.lineMix?t.lineMix:"",compose:null!=t.compose?t.compose:"source-over",offsetX:null!=t.offsetX?t.offsetX:0,offsetY:null!=t.offsetY?t.offsetY:0,opacity:null!=t.opacity?t.opacity:1}]},cyan:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeGreen:!0,includeBlue:!0,excludeRed:!0}]},displace:function(t){t.actions=[{action:"displace",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",lineMix:null!=t.lineMix?t.lineMix:"",opacity:null!=t.opacity?t.opacity:1,channelX:null!=t.channelX?t.channelX:"red",channelY:null!=t.channelY?t.channelY:"green",offsetX:null!=t.offsetX?t.offsetX:0,offsetY:null!=t.offsetY?t.offsetY:0,scaleX:null!=t.scaleX?t.scaleX:1,scaleY:null!=t.scaleY?t.scaleY:1,transparentEdges:null!=t.transparentEdges&&t.transparentEdges}]},edgeDetect:function(t){t.actions=[{action:"matrix",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,width:3,height:3,offsetX:1,offsetY:1,includeRed:!0,includeGreen:!0,includeBlue:!0,includeAlpha:!1,weights:[0,1,0,1,-4,1,0,1,0]}]},emboss:function(t){const e=[];t.useNaturalGrayscale?e.push({action:"grayscale",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:"emboss-work"}):e.push({action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:"emboss-work",includeRed:!0,includeGreen:!0,includeBlue:!0}),t.clamp&&e.push({action:"clamp-channels",lineIn:"emboss-work",lineOut:"emboss-work",lowRed:0+t.clamp,lowGreen:0+t.clamp,lowBlue:0+t.clamp,highRed:255-t.clamp,highGreen:255-t.clamp,highBlue:255-t.clamp}),t.smoothing&&e.push({action:"blur",lineIn:"emboss-work",lineOut:"emboss-work",radius:t.smoothing,passes:2}),e.push({action:"emboss",lineIn:"emboss-work",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,angle:null!=t.angle?t.angle:0,strength:null!=t.strength?t.strength:1,tolerance:null!=t.tolerance?t.tolerance:0,keepOnlyChangedAreas:null!=t.keepOnlyChangedAreas&&t.keepOnlyChangedAreas,postProcessResults:null==t.postProcessResults||t.postProcessResults}),t.actions=e},flood:function(t){t.actions=[{action:"flood",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:null!=t.red?t.red:0,green:null!=t.green?t.green:0,blue:null!=t.blue?t.blue:0,alpha:null!=t.alpha?t.alpha:255}]},gray:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:!0,includeGreen:!0,includeBlue:!0}]},grayscale:function(t){t.actions=[{action:"grayscale",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1}]},green:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,excludeRed:!0,excludeBlue:!0}]},image:function(t){t.actions=[{action:"process-image",lineOut:null!=t.lineOut?t.lineOut:"",asset:null!=t.asset?t.asset:"",width:null!=t.width?t.width:1,height:null!=t.height?t.height:1,copyWidth:null!=t.copyWidth?t.copyWidth:1,copyHeight:null!=t.copyHeight?t.copyHeight:1,copyX:null!=t.copyX?t.copyX:0,copyY:null!=t.copyY?t.copyY:0}]},invert:function(t){t.actions=[{action:"invert-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:!0,includeGreen:!0,includeBlue:!0}]},magenta:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:!0,includeBlue:!0,excludeGreen:!0}]},matrix:function(t){t.actions=[{action:"matrix",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,width:3,height:3,offsetX:1,offsetY:1,includeRed:null==t.includeRed||t.includeRed,includeGreen:null==t.includeGreen||t.includeGreen,includeBlue:null==t.includeBlue||t.includeBlue,includeAlpha:null!=t.includeAlpha&&t.includeAlpha,weights:null!=t.weights?t.weights:[0,0,0,0,1,0,0,0,0]}]},matrix5:function(t){t.actions=[{action:"matrix",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,width:5,height:5,offsetX:2,offsetY:2,includeRed:null==t.includeRed||t.includeRed,includeGreen:null==t.includeGreen||t.includeGreen,includeBlue:null==t.includeBlue||t.includeBlue,includeAlpha:null!=t.includeAlpha&&t.includeAlpha,weights:null!=t.weights?t.weights:[0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0]}]},notblue:function(t){t.actions=[{action:"set-channel-to-level",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeBlue:!0,level:0}]},notgreen:function(t){t.actions=[{action:"set-channel-to-level",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeGreen:!0,level:0}]},notred:function(t){t.actions=[{action:"set-channel-to-level",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:!0,level:0}]},offset:function(t){t.actions=[{action:"offset",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,offsetRedX:null!=t.offsetX?t.offsetX:0,offsetRedY:null!=t.offsetY?t.offsetY:0,offsetGreenX:null!=t.offsetX?t.offsetX:0,offsetGreenY:null!=t.offsetY?t.offsetY:0,offsetBlueX:null!=t.offsetX?t.offsetX:0,offsetBlueY:null!=t.offsetY?t.offsetY:0,offsetAlphaX:null!=t.offsetX?t.offsetX:0,offsetAlphaY:null!=t.offsetY?t.offsetY:0}]},offsetChannels:function(t){t.actions=[{action:"offset",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,offsetRedX:null!=t.offsetRedX?t.offsetRedX:0,offsetRedY:null!=t.offsetRedY?t.offsetRedY:0,offsetGreenX:null!=t.offsetGreenX?t.offsetGreenX:0,offsetGreenY:null!=t.offsetGreenY?t.offsetGreenY:0,offsetBlueX:null!=t.offsetBlueX?t.offsetBlueX:0,offsetBlueY:null!=t.offsetBlueY?t.offsetBlueY:0,offsetAlphaX:null!=t.offsetAlphaX?t.offsetAlphaX:0,offsetAlphaY:null!=t.offsetAlphaY?t.offsetAlphaY:0}]},pixelate:function(t){t.actions=[{action:"pixelate",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,tileWidth:null!=t.tileWidth?t.tileWidth:1,tileHeight:null!=t.tileHeight?t.tileHeight:1,offsetX:null!=t.offsetX?t.offsetX:0,offsetY:null!=t.offsetY?t.offsetY:0,includeRed:null==t.includeRed||t.includeRed,includeGreen:null==t.includeGreen||t.includeGreen,includeBlue:null==t.includeBlue||t.includeBlue,includeAlpha:null!=t.includeAlpha&&t.includeAlpha}]},red:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,excludeGreen:!0,excludeBlue:!0}]},saturation:function(t){let e=null!=t.level?t.level:1;t.actions=[{action:"modulate-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,red:e,green:e,blue:e,saturation:!0}]},sepia:function(t){t.actions=[{action:"tint-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,redInRed:.393,redInGreen:.349,redInBlue:.272,greenInRed:.769,greenInGreen:.686,greenInBlue:.534,blueInRed:.189,blueInGreen:.168,blueInBlue:.131}]},sharpen:function(t){t.actions=[{action:"matrix",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,width:3,height:3,offsetX:1,offsetY:1,includeRed:!0,includeGreen:!0,includeBlue:!0,includeAlpha:!1,weights:[0,-1,0,-1,5,-1,0,-1,0]}]},threshold:function(t){let e=null!=t.lowRed?t.lowRed:0,i=null!=t.lowGreen?t.lowGreen:0,s=null!=t.lowBlue?t.lowBlue:0,n=null!=t.highRed?t.highRed:255,r=null!=t.highGreen?t.highGreen:255,o=null!=t.highBlue?t.highBlue:255,a=null!=t.low?t.low:[e,i,s],l=null!=t.high?t.high:[n,r,o];t.actions=[{action:"threshold",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,level:null!=t.level?t.level:128,low:a,high:l}]},tint:function(t){t.actions=[{action:"tint-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,redInRed:null!=t.redInRed?t.redInRed:1,redInGreen:null!=t.redInGreen?t.redInGreen:0,redInBlue:null!=t.redInBlue?t.redInBlue:0,greenInRed:null!=t.greenInRed?t.greenInRed:0,greenInGreen:null!=t.greenInGreen?t.greenInGreen:1,greenInBlue:null!=t.greenInBlue?t.greenInBlue:0,blueInRed:null!=t.blueInRed?t.blueInRed:0,blueInGreen:null!=t.blueInGreen?t.blueInGreen:0,blueInBlue:null!=t.blueInBlue?t.blueInBlue:1}]},userDefined:function(t){t.actions=[{action:"user-defined-legacy",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1}]},yellow:function(t){t.actions=[{action:"average-channels",lineIn:null!=t.lineIn?t.lineIn:"",lineOut:null!=t.lineOut?t.lineOut:"",opacity:null!=t.opacity?t.opacity:1,includeRed:!0,includeGreen:!0,excludeBlue:!0}]}},Pe=[],ve=function(){return Pe.length||Pe.push(new Worker(ke)),Pe.shift()},we=function(t){Pe.push(t)},xe=function(t,e){return new Promise((i,s)=>{t.onmessage=t=>{t&&t.data&&t.data.image?i(t.data.image):i(!1)},t.onerror=t=>{console.log("error",t.lineno,t.message),i(!1)},t.postMessage(e)})};O.Filter=Filter;const State=function(t={}){return this.set(this.defs),this.lineDash=[],this.set(t),this};let Ae=State.prototype=Object.create(Object.prototype);Ae.type="State",Ae=ee(Ae),Ae.defs={fillStyle:"rgba(0,0,0,1)",strokeStyle:"rgba(0,0,0,1)",globalAlpha:1,globalCompositeOperation:"source-over",lineWidth:1,lineCap:"butt",lineJoin:"miter",lineDash:null,lineDashOffset:0,miterLimit:10,shadowOffsetX:0,shadowOffsetY:0,shadowBlur:0,shadowColor:"rgba(0,0,0,0)",font:"12px sans-serif",textAlign:"left",textBaseline:"top",filter:"none"},Ae.processPacketOut=function(t,e,i){let s=!0;switch(t){case"lineDash":e.length||(s=i.indexOf("lineDash")>=0);break;default:i.indexOf(t)<0&&e===this.defs[t]&&(s=!1)}return s},Ae.finalizePacketOut=function(t,e){let i=t.fillStyle,s=t.strokeStyle;return i&&!i.substring&&(t.fillStyle=i.name),s&&!s.substring&&(t.strokeStyle=s.name),t},Ae.set=function(t={}){if(Object.keys(t).length){let e,i,s,n=Object.keys(t),r=this.defs;for(i=0,s=n.length;i<s;i++)e=n[i],"name"!==e&&void 0!==r[e]&&(this[e]=t[e])}return this},Ae.get=function(t){let e,i;return e=this.defs[t],void 0!==e?(i=this[t],void 0!==i?i:e):void 0};Ae.getters;let Ce=Ae.setters;Ae.deltaSetters;Ce.fillStyle=function(t){let e;U(t)&&"styles"===t.lib?this.fillStyle=t:(e=b[t],this.fillStyle=e||t)},Ce.strokeStyle=function(t){let e;U(t)&&"styles"===t.lib?this.strokeStyle=t:(e=b[t],this.strokeStyle=e||t)},Ae.allKeys=Object.keys(Ae.defs),Ae.mainKeys=["globalAlpha","globalCompositeOperation","shadowOffsetX","shadowOffsetY","shadowBlur","filter"],Ae.lineKeys=["lineWidth","lineCap","lineJoin","lineDash","lineDashOffset","miterLimit"],Ae.styleKeys=["fillStyle","strokeStyle","shadowColor"],Ae.textKeys=["font"],Ae.getChanges=function(t,e){let i,s,n,r,o,a,l,c,u,d=this.mainKeys,f=this.lineKeys,p=this.styleKeys,m=this.textKeys,g=this.defs,y={},b=function(t,e){return void 0!==t[e]?t[e]:g[e]};for(t.substring&&(t=h[t]),n=0,r=d.length;n<r;n++)i=d[n],c=b(this,i),u=b(e,i),u!==c&&(y[i]=c);if(this.lineWidth||e.lineWidth)for(n=0,r=f.length;n<r;n++)if(i=f[n],c=b(this,i),u=b(e,i),"lineDash"==i){if(c.length||u.length)if(c.length!=u.length)y.lineDash=c;else{for(l=!1,o=0,a=c.length;o<a;o++)if(c[o]!=u[o]){l=!0;break}l&&(y.lineDash=c)}}else"lineWidth"==i?t.scaleOutline?(s=(c||1)*(t.scale||1),s!==u&&(y.lineWidth=s)):c!==u&&(y.lineWidth=c):u!==c&&(y[i]=c);for(n=0,r=p.length;n<r;n++)i=p[n],u=b(e,i),c=b(this,i),c.substring&&u!==c?y[i]=c:"Color"===c.type?(c=c.getData(),u!==c&&(y[i]=c)):y[i]=c;if("Phrase"===t.type)for(n=0,r=m.length;n<r;n++)i=m[n],c=b(this,i),u=b(e,i),u!==c&&(y[i]=c);return y},Ae.setStateFromEngine=function(t){let e,i=this.allKeys;for(let s=0,n=i.length;s<n;s++)e=i[s],this[e]=t[e];return this.lineDash=J(t.lineDash)?t.lineDash:[],this.lineDashOffset=et(t.lineDashOffset,0),t.textAlign=this.textAlign="left",t.textBaseline=this.textBaseline="top",this};const De=function(t){return new State(t)};O.State=State;const Coordinate=function(t,e){let i=[0,0];return Object.setPrototypeOf(i,Coordinate.prototype),t&&i.set(t,e),i};let Re=Coordinate.prototype=Object.create(Array.prototype);Re.constructor=Coordinate,Re.type="Coordinate",Re.set=function(t,e){return J(t)&&("Coordinate"===t.type?this.setFromArray(t):"Vector"===t.type?this.setFromVector(t):"Quaternion"===t.type?this.setFromVector(t.v):Array.isArray(t)?this.setFromArray(t):J(e)&&this.setFromArray([t,e])),this},Re.setFromArray=function(t){return this[0]=t[0],this[1]=t[1],this},Re.setFromVector=function(t){let{x:e,y:i}=t;return this[0]=e,this[1]=i,this},Re.zero=function(){return this[0]=0,this[1]=0,this},Re.vectorAdd=function(t){let{x:e,y:i}=t;return this[0]+=e,this[1]+=i,this},Re.vectorSubtract=function(t){let{x:e,y:i}=t;return this[0]-=e,this[1]-=i,this},Re.add=function(t){let[e,i]=t;return this[0]+=e,this[1]+=i,this},Re.subtract=function(t){let[e,i]=t;return this[0]-=e,this[1]-=i,this},Re.multiply=function(t){let[e,i]=t;return this[0]*=e,this[1]*=i,this},Re.divide=function(t){let[e,i]=t;return e&&i&&(this[0]/=e,this[1]/=i),this},Re.scalarMultiply=function(t){return this[0]*=t,this[1]*=t,this},Re.scalarDivide=function(t){return t&&t.toFixed&&(this[0]/=t,this[1]/=t),this},Re.getMagnitude=function(){let t=this[0],e=this[1];return Math.sqrt(t*t+e*e)},Re.rotate=function(t){let e=[0,0],i=this[0],s=this[1];return e[0]=Math.atan2(s,i),e[0]+=.01745329251*t,e[1]=Math.sqrt(i*i+s*s),this[0]=e[1]*Math.cos(e[0]),this[1]=e[1]*Math.sin(e[0]),this},Re.reverse=function(){return this[0]=-this[0],this[1]=-this[1],this},Re.getDotProduct=function(t){return this[0]*t[0]+this[1]*t[1]},Re.normalize=function(){let t=this.getMagnitude();return t>0&&(this[0]/=t,this[1]/=t),this};const Ee=[],Fe=function(t,e){Ee.length||Ee.push(new Coordinate);let i=Ee.shift();return i.set(t,e),i},Te=function(t){t&&"Coordinate"===t.type&&Ee.push(t.zero())},He=function(t,e){return new Coordinate(t,e)};function Me(t={}){t.defs=_(t.defs,{sourceLoaded:!1,source:null,subscribers:null}),t.packetExclusions=Q(t.packetExclusions,["sourceLoaded","source","subscribers"]),t.finalizePacketOut=function(t,e){return this.subscribers&&this.subscribers.length&&(t.subscribers=this.subscribers.map(t=>t.name)),t},t.kill=function(t=!1){return t&&this.source&&this.source.remove(),this.deregister()};t.getters;let e=t.setters;t.deltaSetters;return e.source=function(t={}){t&&this.sourceLoaded&&this.notifySubscribers()},e.subscribers=B,t.assetConstructor=function(t={}){return this.makeName(t.name),this.register(),this.subscribers=[],this.set(this.defs),this.set(t),t.subscribe&&this.subscribers.push(t.subscribe),this},t.subscribe=function(t={}){if(t&&t.name){let e=t.name;this.subscribers.every(t=>t.name!==e)&&this.subscribeAction(t)}},t.subscribeAction=function(t={}){this.subscribers.push(t),t.asset=this,t.source=this.source,this.notifySubscriber(t)},t.unsubscribe=function(t={}){if(t.name){let e=t.name,i=this.subscribers.findIndex(t=>t.name===e);i>=0&&(t.source=null,t.asset=null,t.sourceNaturalHeight=0,t.sourceNaturalWidth=0,t.sourceLoaded=!1,this.subscribers.splice(i,1))}},t.notifySubscribers=function(){this.subscribers.forEach(t=>this.notifySubscriber(t),this)},t.notifySubscriber=function(t){t.sourceNaturalWidth=this.sourceNaturalWidth,t.sourceNaturalHeight=this.sourceNaturalHeight,t.sourceLoaded=this.sourceLoaded,t.source=this.source,t.dirtyImage=!0,t.dirtyCopyStart=!0,t.dirtyCopyDimensions=!0,t.dirtyImageSubscribers=!0},t}O.Coordinate=Coordinate;const ImageAsset=function(t={}){return this.assetConstructor(t)};let Ie=ImageAsset.prototype=Object.create(Object.prototype);Ie.type="Image",Ie.lib="asset",Ie.isArtefact=!1,Ie.isAsset=!0,Ie=ee(Ie),Ie=Me(Ie);Ie.defs=_(Ie.defs,{intrinsicDimensions:null}),Ie.saveAsPacket=function(){return[this.name,this.type,this.lib,{}]},Ie.stringifyFunction=B,Ie.processPacketOut=B,Ie.finalizePacketOut=B,Ie.clone=$;Ie.getters;let Be=Ie.setters;Ie.deltaSetters;Be.source=function(t={}){t&&(["IMG","PICTURE"].indexOf(t.tagName.toUpperCase())>=0&&(this.source=t,this.sourceNaturalWidth=t.naturalWidth,this.sourceNaturalHeight=t.naturalHeight,this.sourceLoaded=t.complete),this.sourceLoaded&&this.notifySubscribers())},Be.currentSrc=function(t){this.currentSrc=t,this.currentFile=this.currentSrc.split("/").pop()},Ie.checkSource=function(t,e){let i=this.source,s="element";if(this.sourceLoaded){let n=this.intrinsicDimensions[this.currentFile];switch(this.currentSrc!==i.currentSrc?(this.set({currentSrc:i.currentSrc}),n=this.intrinsicDimensions[this.currentFile],s=n?"intrinsic":"zero"):n&&(s="intrinsic"),s){case"zero":this.sourceNaturalWidth=0,this.sourceNaturalHeight=0,this.notifySubscribers();break;case"intrinsic":this.sourceNaturalWidth===n[0]&&this.sourceNaturalHeight===n[1]||(this.sourceNaturalWidth=n[0],this.sourceNaturalHeight=n[1],this.notifySubscribers());break;default:this.sourceNaturalWidth===i.naturalWidth&&this.sourceNaturalHeight===i.naturalHeight&&this.sourceNaturalWidth===t&&this.sourceNaturalHeight===e||(this.sourceNaturalWidth=i.naturalWidth,this.sourceNaturalHeight=i.naturalHeight,this.notifySubscribers())}}};const Le=[],$e=[],je=function(...t){let e=/.*\/(.*?)\./,i=[];return t.forEach(t=>{let s,n,r,o,a=!1,l=!1;if(t.substring){let i=e.exec(t);s=i&&i[1]?i[1]:"",n=t,r="",o=!1,l=!0}else(t=!!U(t)&&t)&&t.src&&(s=t.name||"",n=t.src,r=t.className||"",o=t.visibility||!1,t.parent&&(a=document.querySelector(t.parent)),l=!0);if(l){let t=Xe({name:s,intrinsicDimensions:{}}),e=document.createElement("img");e.name=s,e.className=r,e.crossorigin="anonymous",e.style.display=o?"block":"none",a&&a.appendChild(e),e.onload=()=>{t.set({source:e})},e.src=n,t.set({source:e}),i.push(s)}else i.push(!1)}),i},Ne=function(t){let e=/.*\/(.*?)\./;document.querySelectorAll(t).forEach(t=>{let i;if(["IMG","PICTURE"].indexOf(t.tagName.toUpperCase())>=0){if(t.id||t.name)i=t.id||t.name;else{let s=e.exec(t.src);i=s&&s[1]?s[1]:""}let s=t.dataset.dimensions||{};s.substring&&(s=JSON.parse(s));let n=Xe({name:i,source:t,intrinsicDimensions:s,currentSrc:t.currentSrc});t.onload=()=>{n.set({source:t})}}})},Xe=function(t){return new ImageAsset(t)};function Ye(t={}){t.defs=_(t.defs,{group:null,visibility:!0,order:0,start:null,handle:null,offset:null,dimensions:null,pivoted:null,mimicked:null,particle:null,lockTo:null,bringToFrontOnDrag:!0,scale:1,roll:0,noUserInteraction:!1,noPositionDependencies:!1,noCanvasEngineUpdates:!1,noFilters:!1,noPathUpdates:!1,purge:null}),t.packetExclusions=Q(t.packetExclusions,["pathObject","mimicked","pivoted"]),t.packetExclusionsByRegex=Q(t.packetExclusionsByRegex,["^(local|dirty|current)","Subscriber$"]),t.packetCoordinates=Q(t.packetCoordinates,["start","handle","offset"]),t.packetObjects=Q(t.packetObjects,["group"]),t.packetFunctions=Q(t.packetFunctions,[]),t.processPacketOut=function(t,e,i){let s=!0;switch(t){case"lockTo":"start"===e[0]&&"start"===e[1]&&(s=i.indexOf("lockTo")>=0);break;default:"entity"===this.lib?s=this.processEntityPacketOut(t,e,i):this.isArtefact&&(s=this.processDOMPacketOut(t,e,i))}return s},t.handlePacketAnchor=function(t,e){if(this.anchor){let i=JSON.parse(this.anchor.saveAsPacket(e))[3];t.anchor=i}return t},t.kill=function(t=!1,e=!1){let s=this.name;return Object.entries(u).forEach(([t,e])=>{e.artefacts.indexOf(s)>=0&&e.removeArtefacts(s)}),this.anchor&&this.demolishAnchor(),Object.entries(i).forEach(([t,e])=>{e.name!==s&&(e.pivot&&e.pivot.name===s&&e.set({pivot:!1}),e.mimic&&e.mimic.name===s&&e.set({mimic:!1}),e.path&&e.path.name===s&&e.set({path:!1}),e.generateAlongPath&&e.generateAlongPath.name===s&&e.set({generateAlongPath:!1}),e.generateInArea&&e.generateInArea.name===s&&e.set({generateInArea:!1}),e.artefact&&e.artefact.name===s&&e.set({artefact:!1}),Array.isArray(e.pins)&&e.pins.forEach((t,i)=>{U(t)&&t.name===s&&e.removePinAt(i)}))}),Object.entries(y).forEach(([t,e])=>{e.checkForTarget(s)&&e.removeFromTargets(this)}),this.factoryKill(t,e),this.deregister(),this},t.factoryKill=B;let e=t.getters,s=t.setters,n=t.deltaSetters;return e.positionX=function(){return this.currentStampPosition[0]},e.positionY=function(){return this.currentStampPosition[1]},e.position=function(){return[].concat(this.currentStampPosition)},e.startX=function(){return this.currentStart[0]},e.startY=function(){return this.currentStart[1]},e.start=function(){return[].concat(this.currentStart)},s.startX=function(t){null!=t&&(this.start[0]=t,this.dirtyStart=!0)},s.startY=function(t){null!=t&&(this.start[1]=t,this.dirtyStart=!0)},s.start=function(t,e){this.setCoordinateHelper("start",t,e),this.dirtyStart=!0},n.startX=function(t){let e=this.start;e[0]=H(e[0],t),this.dirtyStart=!0},n.startY=function(t){let e=this.start;e[1]=H(e[1],t),this.dirtyStart=!0},n.start=function(t,e){this.setDeltaCoordinateHelper("start",t,e),this.dirtyStart=!0},e.handleX=function(){return this.currentHandle[0]},e.handleY=function(){return this.currentHandle[1]},e.handle=function(){return[].concat(this.currentHandle)},s.handleX=function(t){null!=t&&(this.handle[0]=t,this.dirtyHandle=!0)},s.handleY=function(t){null!=t&&(this.handle[1]=t,this.dirtyHandle=!0)},s.handle=function(t,e){this.setCoordinateHelper("handle",t,e),this.dirtyHandle=!0},n.handleX=function(t){let e=this.handle;e[0]=H(e[0],t),this.dirtyHandle=!0},n.handleY=function(t){let e=this.handle;e[1]=H(e[1],t),this.dirtyHandle=!0},n.handle=function(t,e){this.setDeltaCoordinateHelper("handle",t,e),this.dirtyHandle=!0},e.offsetX=function(){return this.currentOffset[0]},e.offsetY=function(){return this.currentOffset[1]},e.offset=function(){return[].concat(this.currentOffset)},s.offsetX=function(t){null!=t&&(this.offset[0]=t,this.dirtyOffset=!0)},s.offsetY=function(t){null!=t&&(this.offset[1]=t,this.dirtyOffset=!0)},s.offset=function(t,e){this.setCoordinateHelper("offset",t,e),this.dirtyOffset=!0},n.offsetX=function(t){let e=this.offset;e[0]=H(e[0],t),this.dirtyOffset=!0},n.offsetY=function(t){let e=this.offset;e[1]=H(e[1],t),this.dirtyOffset=!0},n.offset=function(t,e){this.setDeltaCoordinateHelper("offset",t,e),this.dirtyOffset=!0},e.width=function(){return this.currentDimensions[0]},e.height=function(){return this.currentDimensions[1]},e.dimensions=function(){return[].concat(this.currentDimensions)},s.width=function(t){null!=t&&(this.dimensions[0]=t,this.dirtyDimensions=!0)},s.height=function(t){null!=t&&(this.dimensions[1]=t,this.dirtyDimensions=!0)},s.dimensions=function(t,e){this.setCoordinateHelper("dimensions",t,e),this.dirtyDimensions=!0},n.width=function(t){let e=this.dimensions;e[0]=H(e[0],t),this.dirtyDimensions=!0},n.height=function(t){let e=this.dimensions;e[1]=H(e[1],t),this.dirtyDimensions=!0},n.dimensions=function(t,e){this.setDeltaCoordinateHelper("dimensions",t,e),this.dirtyDimensions=!0},s.particle=function(t){Y(t)&&!t?(this.particle=null,"particle"===this.lockTo[0]&&(this.lockTo[0]="start"),"particle"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0):(this.particle=t,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)},s.lockTo=function(t){Array.isArray(t)?(this.lockTo[0]=t[0],this.lockTo[1]=t[1]):(this.lockTo[0]=t,this.lockTo[1]=t),this.dirtyLock=!0,this.dirtyStampPositions=!0},s.lockXTo=function(t){this.lockTo[0]=t,this.dirtyLock=!0,this.dirtyStampPositions=!0},s.lockYTo=function(t){this.lockTo[1]=t,this.dirtyLock=!0,this.dirtyStampPositions=!0},e.roll=function(){return this.currentRotation},s.roll=function(t){this.roll=t,this.dirtyRotation=!0},n.roll=function(t){this.roll+=t,this.dirtyRotation=!0},e.scale=function(){return this.currentScale},s.scale=function(t){this.scale=t,this.dirtyScale=!0},n.scale=function(t){this.scale+=t,this.dirtyScale=!0},s.host=function(t){if(t){let e=i[t];e&&e.here?this.host=e.name:this.host=t}else this.host="";this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyStart=!0,this.dirtyOffset=!0},s.group=function(t){let e;t&&(this.group&&"Group"===this.group.type&&this.group.removeArtefacts(this.name),t.substring?(e=u[t],this.group=e||t):this.group=t),this.group&&"Group"===this.group.type&&this.group.addArtefacts(this.name)},t.purgeArtefact=function(t){return t.substring&&(t="all"===t?["pivot","mimic","path","filter"]:[t]),Array.isArray(t)&&t.forEach(t=>function(t,e){switch(e){case"pivot":delete t.pivot,delete t.pivotCorner,delete t.pivotPin,delete t.addPivotHandle,delete t.addPivotOffset,delete t.addPivotRotation;break;case"mimic":delete t.mimic,delete t.useMimicDimensions,delete t.useMimicScale,delete t.useMimicStart,delete t.useMimicHandle,delete t.useMimicOffset,delete t.useMimicRotation,delete t.useMimicFlip,delete t.addOwnDimensionsToMimic,delete t.addOwnScaleToMimic,delete t.addOwnStartToMimic,delete t.addOwnHandleToMimic,delete t.addOwnOffsetToMimic,delete t.addOwnRotationToMimic;break;case"path":delete t.path,delete t.pathPosition,delete t.addPathHandle,delete t.addPathOffset,delete t.addPathRotation,delete t.constantPathSpeed;break;case"filter":delete t.filter,delete t.filters,delete t.isStencil}}(this,t)),this},t.initializePositions=function(){this.dimensions=He(),this.start=He(),this.handle=He(),this.offset=He(),this.currentDimensions=He(),this.currentStart=He(),this.currentHandle=He(),this.currentOffset=He(),this.currentDragOffset=He(),this.currentDragCache=He(),this.currentStartCache=He(),this.currentStampPosition=He(),this.currentStampHandlePosition=He(),this.delta={},this.lockTo=["start","start"],this.pivoted=[],this.mimicked=[],this.dirtyScale=!0,this.dirtyDimensions=!0,this.dirtyLock=!0,this.dirtyStart=!0,this.dirtyOffset=!0,this.dirtyHandle=!0,this.dirtyRotation=!0,this.isBeingDragged=!1,this.initializeDomPositions()},t.initializeDomPositions=B,t.setCoordinateHelper=function(t,e,i){let s=this[t];Array.isArray(e)?(s[0]=e[0],s[1]=e[1]):U(e)?it(e.x,e.y)?(s[0]=et(e.x,s[0]),s[1]=et(e.y,s[1])):(s[0]=et(e.width,e.w,s[0]),s[1]=et(e.height,e.h,s[1])):(s[0]=e,s[1]=i)},t.setDeltaCoordinateHelper=function(t,e,i){let s=this[t],n=s[0],r=s[1];Array.isArray(e)?(s[0]=H(n,e[0]),s[1]=H(r,e[1])):U(e)?it(e.x,e.y)?(s[0]=H(n,et(e.x,0)),s[1]=H(r,et(e.y,0))):(s[0]=H(n,et(e.width,e.w,0)),s[1]=H(r,et(e.height,e.h,0))):(s[0]=H(n,e),s[1]=H(r,i))},t.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=i[this.host];if(t)return this.currentHost=t,this.dirtyHost=!0,this.currentHost}return le},t.getHere=function(){let t=this.getHost();if(t){if(t.here&&Object.keys(t.here))return t.here;if(t.currentDimensions){let e=t.currentDimensions;if(e)return{w:e[0],h:e[1]}}}return le},t.cleanPosition=function(t,e,i){let s,n;for(let r=0;r<2;r++)s=e[r],n=i[r],s.toFixed?t[r]=s:t[r]="left"===s||"top"===s?0:"right"===s||"bottom"===s?n:"center"===s?n/2:parseFloat(s)/100*n},t.cleanScale=function(){this.dirtyScale=!1;let t,e=this.scale,i=this.mimic,s=this.currentScale;i&&this.useMimicScale?i.currentScale?(t=i.currentScale,this.addOwnScaleToMimic&&(t+=e)):(t=e,this.dirtyMimicScale=!0):t=e,this.currentScale=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,s!==this.currentScale&&(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicScale=!0)},t.cleanDimensions=function(){this.dirtyDimensions=!1;let t=this.getHost(),e=this.dimensions,i=this.currentDimensions;if(t){let s=t.currentDimensions?t.currentDimensions:[t.w,t.h],[n,r]=e,o=i[0],a=i[1];n.substring&&(n=parseFloat(n)/100*s[0]),r.substring&&(r="auto"===r?0:parseFloat(r)/100*s[1]);let l,h=this.mimic;h&&h.name&&this.useMimicDimensions&&(l=h.currentDimensions),l?(i[0]=this.addOwnDimensionsToMimic?l[0]+n:l[0],i[1]=this.addOwnDimensionsToMimic?l[1]+r:l[1]):(i[0]=n,i[1]=r),this.cleanDimensionsAdditionalActions(),this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyOffset=!0,o===i[0]&&a===i[1]||(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicDimensions=!0)}else this.dirtyDimensions=!0},t.cleanDimensionsAdditionalActions=B,t.cleanLock=function(){this.dirtyLock=!1,this.dirtyStart=!0,this.dirtyHandle=!0},t.cleanStart=function(){let t,e,i=this.getHost();i&&(this.dirtyStart=!1,tt(i.w,i.h)?(t=i.w,e=i.h):i.currentDimensions?[t,e]=i.currentDimensions:this.dirtyStart=!0),this.dirtyStart||(this.cleanPosition(this.currentStart,this.start,[t,e]),this.dirtyStampPositions=!0)},t.cleanOffset=function(){let t,e,i=this.getHost();i&&(this.dirtyOffset=!1,tt(i.w,i.h)?(t=i.w,e=i.h):i.currentDimensions?[t,e]=i.currentDimensions:this.dirtyOffset=!0),this.dirtyStart||(this.cleanPosition(this.currentOffset,this.offset,[t,e]),this.dirtyStampPositions=!0,this.mimicked&&this.mimicked.length&&(this.dirtyMimicOffset=!0))},t.cleanHandle=function(){this.dirtyHandle=!1;let t=this.currentHandle;this.cleanPosition(t,this.handle,this.currentDimensions),this.dirtyStampHandlePositions=!0,this.mimicked&&this.mimicked.length&&(this.dirtyMimicHandle=!0)},t.cleanRotation=function(){this.dirtyRotation=!1;let t,e=this.roll,i=this.currentRotation,s=this.path,n=this.mimic,r=this.pivot,o=this.lockTo;if(s&&o.indexOf("path")>=0){if(t=e,this.addPathRotation){let e=this.getPathData();e&&(t+=e.angle)}}else n&&this.useMimicRotation&&o.indexOf("mimic")>=0?J(n.currentRotation)?(t=n.currentRotation,this.addOwnRotationToMimic&&(t+=e)):this.dirtyMimicRotation=!0:(t=e,r&&this.addPivotRotation&&o.indexOf("pivot")>=0&&(J(r.currentRotation)?t+=r.currentRotation:this.dirtyPivotRotation=!0));this.currentRotation=t,t!==i&&(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicRotation=!0)},t.cleanStampPositions=function(){this.dirtyStampPositions=!1;let{currentStampPosition:t,currentStart:e,currentOffset:i,currentStartCache:s,currentDragOffset:n}=this,[r,o]=t;if(this.noPositionDependencies)t[0]=e[0],t[1]=e[1];else{let{isBeingDragged:r,lockTo:o,pivot:a,pivotCorner:l,pivotPin:h,addPivotOffset:c,path:u,addPathOffset:f,mimic:p,useMimicStart:m,useMimicOffset:g,addOwnStartToMimic:y,addOwnOffsetToMimic:b,particle:k}=this;const S={start:function(t){t.setFromArray(e).add(i)},path:function(t){w?(t.setFromVector(w),f||t.subtract(u.currentOffset)):t.setFromArray(e).add(i)},pivot:function(t){l&&a.getCornerCoordinate?t.setFromArray(a.getCornerCoordinate(l)):"Polyline"==a.type?t.setFromArray(a.getPinAt(h)):t.setFromArray(a.currentStampPosition),c||t.subtract(a.currentOffset),t.add(i)},mimic:function(t){m||g?(t.setFromArray(p.currentStampPosition),m&&y&&t.add(e),g&&b&&t.add(i),m||t.subtract(p.currentStart).add(e),g||t.subtract(p.currentOffset).add(i)):t.setFromArray(e).add(i)},particle:function(t){k.substring&&(k=d[k]),k?t.setFromVector(k.position):t.setFromArray(e).add(i)},mouse:function(t){t.setFromVector(v),r&&(s.setFromArray(t),t.add(n)),t.add(i)}};let O,P,v,w,x=Fe(),A=!1;if(x.length=0,r)x.push("mouse","mouse"),A=!0,this.getCornerCoordinate&&this.cleanPathObject();else for(O=0;O<2;O++)P=o[O],("pivot"!==P||a)&&("path"!==P||u)&&("mimic"!==P||p)&&("particle"!==P||d)||(P="start"),"mouse"===P&&(A=!0),x.push(P);A&&(v=this.getHere()),x.indexOf("path")>=0&&(w=this.getPathData());let[C,D]=x,R=Fe(),E=Fe();S[C](R),C==D?E.setFromArray(R):S[D](E),t[0]=R[0],t[1]=E[1],Te(x)}r===t[0]&&o===t[1]||(this.dirtyPositionSubscribers=!0)},t.cleanStampHandlePositions=function(){this.dirtyStampHandlePositions=!1;let t=this.currentStampHandlePosition,e=this.currentHandle,i=t[0],s=t[1];if(this.noPositionDependencies)t[0]=e[0],t[1]=e[1];else{let i,s,n,r=this.lockTo,o=this.pivot,a=this.path,l=this.mimic;for(s=0;s<2;s++){switch(i=r[s],"pivot"!==i||o||(i="start"),"path"!==i||a||(i="start"),"mimic"!==i||l||(i="start"),n=e[s],i){case"pivot":this.addPivotHandle&&(n+=o.currentHandle[s]);break;case"path":this.addPathHandle&&(n+=a.currentHandle[s]);break;case"mimic":this.useMimicHandle&&(n=l.currentHandle[s],this.addOwnHandleToMimic&&(n+=e[s]))}t[s]=n}}this.cleanStampHandlePositionsAdditionalActions(),i===t[0]&&s===t[1]||(this.dirtyPositionSubscribers=!0)},t.cleanStampHandlePositionsAdditionalActions=B,t.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let i=Array.isArray(t)?t:[t],s=!1;e||(e=ni(),s=!0);let n,r,o=e.engine,a=this.currentStampPosition,l=a[0],h=a[1];if(i.some(t=>{if(Array.isArray(t))n=t[0],r=t[1];else{if(!tt(t,t.x,t.y))return!1;n=t.x,r=t.y}return!(!n.toFixed||!r.toFixed||isNaN(n)||isNaN(r))&&(e.rotateDestination(o,l,h,this),o.isPointInPath(this.pathObject,n,r,this.winding))},this)){let t=this.checkHitReturn(n,r,e);return s&&ri(e),t}return s&&ri(e),!1},t.checkHitReturn=function(t,e,i){return{x:t,y:e,artefact:this}},t.pickupArtefact=function(t={}){let{x:e,y:i}=t;return tt(e,i)&&(this.isBeingDragged=!0,this.currentDragCache.set(this.currentDragOffset),"start"===this.lockTo[0]?this.currentDragOffset[0]=this.currentStart[0]-e:"pivot"===this.lockTo[0]&&this.pivot?this.currentDragOffset[0]=this.pivot.get("startX")-e:"mimic"===this.lockTo[0]&&this.mimic&&(this.currentDragOffset[0]=this.mimic.get("startX")-e),"start"===this.lockTo[1]?this.currentDragOffset[1]=this.currentStart[1]-i:"pivot"===this.lockTo[1]&&this.pivot?this.currentDragOffset[1]=this.pivot.get("startY")-i:"mimic"===this.lockTo[1]&&this.mimic&&(this.currentDragOffset[1]=this.mimic.get("startY")-i),this.bringToFrontOnDrag&&(this.order+=9999,this.group.batchResort=!0),J(this.dirtyPathObject)&&(this.dirtyPathObject=!0)),this},t.dropArtefact=function(){return this.start.set(this.currentStartCache).add(this.currentDragOffset),this.dirtyStart=!0,this.currentDragOffset.set(this.currentDragCache),this.bringToFrontOnDrag&&(this.order-=9999,this.order<0&&(this.order=0),this.group.batchResort=!0),J(this.dirtyPathObject)&&(this.dirtyPathObject=!0),this.isBeingDragged=!1,this},t.updatePositionSubscribers=function(){this.dirtyPositionSubscribers=!1,this.pivoted&&this.pivoted.length&&this.updatePivotSubscribers(),this.mimicked&&this.mimicked.length&&this.updateMimicSubscribers(),this.pathed&&this.pathed.length&&this.updatePathSubscribers()},t.updatePivotSubscribers=B,t.updateMimicSubscribers=B,t.updatePathSubscribers=B,t.updateImageSubscribers=B,t}function ze(t={}){let e={delta:null,noDeltaUpdates:!1};t.defs=_(t.defs,e),_(t,e);let i=t.setters;t.deltaSetters;return i.delta=function(t={}){t&&(this.delta=Z(this.delta,t))},t.updateByDelta=function(){return"kaliedoscope-clock-background"==this.name&&console.log(this.name,"updateByDelta"),this.setDelta(this.delta),this},t.reverseByDelta=function(){let t={};return Object.entries(this.delta).forEach(([e,i])=>{i=i.substring?-parseFloat(i)+"%":-i,t[e]=i}),this.setDelta(t),this},t.setDeltaValues=function(t={}){let e,i,s=this.delta;return Object.entries(t).forEach(([t,n])=>{if(J(s[t]))switch(i=n,e=s[t],i){case"reverse":e.toFixed&&(s[t]=-e);break;case"zero":e.toFixed&&(s[t]=0)}}),this},t}function Ge(t={}){let e={pivot:"",pivotCorner:"",pivotPin:0,addPivotHandle:!1,addPivotOffset:!0,addPivotRotation:!1};t.defs=_(t.defs,e),_(t,e),t.packetObjects=Q(t.packetObjects,["pivot"]);t.getters;let s=t.setters;t.deltaSetters;return s.pivot=function(t){if(Y(t)&&!t)this.pivot=null,"pivot"===this.lockTo[0]&&(this.lockTo[0]="start"),"pivot"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.pivot,s=this.name,r=t.substring?i[t]:t;r||(r=n[t],r&&"Cell"!==r.type&&(r=!1)),r&&r.name&&(e&&e.name!==r.name&&K(e.pivoted,s),Q(r.pivoted,s),this.pivot=r,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}},t.pivotCorners=["topLeft","topRight","bottomRight","bottomLeft"],s.pivotCorner=function(t){this.pivotCorners.indexOf(t)>=0&&(this.pivotCorner=t)},s.addPivotHandle=function(t){this.addPivotHandle=t,this.dirtyHandle=!0},s.addPivotOffset=function(t){this.addPivotOffset=t,this.dirtyOffset=!0},s.addPivotRotation=function(t){this.addPivotRotation=t,this.dirtyRotation=!0},t.updatePivotSubscribers=function(){this.pivoted.forEach(t=>{let e=i[t];e||(e=n[t],e&&"Cell"===e.type||(e=!1)),e&&(e.dirtyStart=!0,e.addPivotHandle&&(e.dirtyHandle=!0),e.addPivotOffset&&(e.dirtyOffset=!0),e.addPivotRotation&&(e.dirtyRotation=!0),"Polyline"===e.type?e.dirtyPins=!0:"Line"!==e.type&&"Quadratic"!==e.type&&"Bezier"!==e.type||e.dirtyPins.push(this.name))},this)},t}function We(t={}){let e={mimic:"",useMimicDimensions:!1,useMimicScale:!1,useMimicStart:!1,useMimicHandle:!1,useMimicOffset:!1,useMimicRotation:!1,useMimicFlip:!1,addOwnDimensionsToMimic:!1,addOwnScaleToMimic:!1,addOwnStartToMimic:!1,addOwnHandleToMimic:!1,addOwnOffsetToMimic:!1,addOwnRotationToMimic:!1};t.defs=_(t.defs,e),_(t,e),t.packetObjects=Q(t.packetObjects,["mimic"]);t.getters;let s=t.setters;t.deltaSetters;return s.mimic=function(t){if(Y(t)&&!t)this.mimic=null,"mimic"===this.lockTo[0]&&(this.lockTo[0]="start"),"mimic"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.mimic,s=this.name,r=t.substring?i[t]:t;r||(r=n[t],r&&"Cell"!==r.type&&(r=!1)),r&&r.name&&(e&&e.name!==r.name&&removeItem(e.mimicked,s),Q(r.mimicked,s),this.mimic=r,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}},s.useMimicDimensions=function(t){this.useMimicDimensions=t,this.dirtyDimensions=!0},s.useMimicScale=function(t){this.useMimicScale=t,this.dirtyScale=!0},s.useMimicStart=function(t){this.useMimicStart=t,this.dirtyStart=!0},s.useMimicHandle=function(t){this.useMimicHandle=t,this.dirtyHandle=!0},s.useMimicOffset=function(t){this.useMimicOffset=t,this.dirtyOffset=!0},s.useMimicRotation=function(t){this.useMimicRotation=t,this.dirtyRotation=!0},s.addOwnDimensionsToMimic=function(t){this.addOwnDimensionsToMimic=t,this.dirtyDimensions=!0},s.addOwnScaleToMimic=function(t){this.addOwnScaleToMimic=t,this.dirtyScale=!0},s.addOwnStartToMimic=function(t){this.addOwnStartToMimic=t,this.dirtyStart=!0},s.addOwnHandleToMimic=function(t){this.addOwnHandleToMimic=t,this.dirtyHandle=!0},s.addOwnOffsetToMimic=function(t){this.addOwnOffsetToMimic=t,this.dirtyOffset=!0},s.addOwnRotationToMimic=function(t){this.addOwnRotationToMimic=t,this.dirtyRotation=!0},t.updateMimicSubscribers=function(){let t=this.dirtyMimicHandle,e=this.dirtyMimicOffset,s=this.dirtyMimicRotation,r=this.dirtyMimicScale,o=this.dirtyMimicDimensions;this.mimicked.forEach(a=>{let l=i[a];l||(l=n[a],l&&"Cell"===l.type||(l=!1)),l&&(l.useMimicStart&&(l.dirtyStart=!0),t&&l.useMimicHandle&&(l.dirtyHandle=!0),e&&l.useMimicOffset&&(l.dirtyOffset=!0),s&&l.useMimicRotation&&(l.dirtyRotation=!0),r&&l.useMimicScale&&(l.dirtyScale=!0),o&&l.useMimicDimensions&&(l.dirtyDimensions=!0))}),this.dirtyMimicHandle=!1,this.dirtyMimicOffset=!1,this.dirtyMimicRotation=!1,this.dirtyMimicScale=!1,this.dirtyMimicDimensions=!1},t}function Ve(t={}){let e={path:"",pathPosition:0,addPathHandle:!1,addPathOffset:!0,addPathRotation:!1,constantPathSpeed:!1};t.defs=_(t.defs,e),_(t,e),t.packetObjects=Q(t.packetObjects,["path"]);let s=t.setters,n=t.deltaSetters;return s.path=function(t){if(Y(t)&&!t)this.path=null,"path"===this.lockTo[0]&&(this.lockTo[0]="start"),"path"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.path,s=t.substring?i[t]:t,n=this.name;s&&s.name&&s.useAsPath&&(e&&e.name!==s.name&&K(e.pathed,n),Q(s.pathed,n),this.path=s,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}},s.pathPosition=function(t){t<0&&(t=Math.abs(t)),t>1&&(t%=1),this.pathPosition=parseFloat(t.toFixed(6)),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0,this.currentPathData=!1},n.pathPosition=function(t){let e=this.pathPosition+t;e<0&&(e+=1),e>1&&(e%=1),this.pathPosition=parseFloat(e.toFixed(6)),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0,this.currentPathData=!1},s.addPathHandle=function(t){this.addPathHandle=t,this.dirtyHandle=!0},s.addPathOffset=function(t){this.addPathOffset=t,this.dirtyOffset=!0},s.addPathRotation=function(t){this.addPathRotation=t,this.dirtyRotation=!0},t.getPathData=function(){if(this.currentPathData)return this.currentPathData;let t,e=this.pathPosition,i=this.path;return!!i&&(t=i.getPathPositionData(e,this.constantPathSpeed),this.addPathRotation&&(this.dirtyRotation=!0),this.currentPathData=t,t)},t}O.ImageAsset=ImageAsset;const Anchor=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.build(),this};let Ue=Anchor.prototype=Object.create(Object.prototype);Ue.type="Anchor",Ue.lib="anchor",Ue.isArtefact=!1,Ue.isAsset=!1,Ue=ee(Ue);Ue.defs=_(Ue.defs,{host:null,description:"",download:"",href:"",hreflang:"",ping:"",referrerpolicy:"",rel:"noreferrer",target:"_blank",anchorType:"",clickAction:null,focusAction:!1,blurAction:!1}),Ue.packetExclusions=Q(Ue.packetExclusions,["domElement"]),Ue.packetObjects=Q(Ue.packetExclusions,["host"]),Ue.packetFunctions=Q(Ue.packetFunctions,["clickAction"]),Ue.demolish=function(){this.domElement&&this.hold&&this.hold.removeChild(this.domElement),this.deregister()};let qe=Ue.setters;qe.host=function(t){let e=t.substring?i[t]:t;e&&e.name&&(this.host=e)},qe.hold=function(t){G(t)&&(this.domElement&&this.hold&&this.hold.removeChild(this.domElement),this.hold=t,this.domElement&&this.hold.appendChild(this.domElement))},qe.download=function(t){this.download=t,this.domElement&&this.update("download")},qe.href=function(t){this.href=t,this.domElement&&this.update("href")},qe.hreflang=function(t){this.hreflang=t,this.domElement&&this.update("hreflang")},qe.ping=function(t){this.ping=t,this.domElement&&this.update("ping")},qe.referrerpolicy=function(t){this.referrerpolicy=t,this.domElement&&this.update("referrerpolicy")},qe.rel=function(t){this.rel=t,this.domElement&&this.update("rel")},qe.target=function(t){this.target=t,this.domElement&&this.update("target")},qe.anchorType=function(t){this.anchorType=t,this.domElement&&this.update("type")},qe.description=function(t){this.description=t,this.domElement&&(this.domElement.textContent=t)},qe.clickAction=function(t){W(t)&&(this.clickAction=t,this.domElement&&this.domElement.setAttribute("onclick",t()))},Ue.build=function(){this.domElement&&this.hold&&this.hold.removeChild(this.domElement);let t=document.createElement("a");t.id=this.name,this.download&&t.setAttribute("download",this.download),this.href&&t.setAttribute("href",this.href),this.hreflang&&t.setAttribute("hreflang",this.hreflang),this.ping&&t.setAttribute("ping",this.ping),this.referrerpolicy&&t.setAttribute("referrerpolicy",this.referrerpolicy),this.rel&&t.setAttribute("rel",this.rel),this.target&&t.setAttribute("target",this.target),this.anchorType&&t.setAttribute("type",this.anchorType),this.clickAction&&W(this.clickAction)&&t.setAttribute("onclick",this.clickAction()),this.description&&(t.textContent=this.description),this.focusAction&&t.addEventListener("focus",t=>this.host.onEnter(),!1),this.blurAction&&t.addEventListener("blur",t=>this.host.onLeave(),!1),this.domElement=t,this.hold&&this.hold.appendChild(t)},Ue.update=function(t){this.domElement&&this.domElement.setAttribute(t,this[t])},Ue.click=function(){if(this.hasBeenRecentlyClicked)return!1;{let t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});this.hasBeenRecentlyClicked=!0;let e=this;return setTimeout(()=>e.hasBeenRecentlyClicked=!1,200),this.domElement.dispatchEvent(t)}};function _e(t={}){t.defs=_(t.defs,{anchor:null}),t.demolishAnchor=function(){this.anchor&&this.anchor.demolish()};let e=t.getters,i=t.setters;t.deltaSetters;return e.anchorDescription=function(){return this.anchor?this.anchor.get("description"):""},i.anchorDescription=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.description(t)},e.anchorType=function(){return this.anchor?this.anchor.get("type"):""},i.anchorType=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.anchorType(t)},e.anchorTarget=function(){return this.anchor?this.anchor.get("target"):""},i.anchorTarget=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.target(t)},e.anchorRel=function(){return this.anchor?this.anchor.get("rel"):""},i.anchorRel=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.rel(t)},e.anchorReferrerPolicy=function(){return this.anchor?this.anchor.get("referrerpolicy"):""},i.anchorReferrerPolicy=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.referrerpolicy(t)},e.anchorPing=function(){return this.anchor?this.anchor.get("ping"):""},i.anchorPing=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.ping(t)},e.anchorHreflang=function(){return this.anchor?this.anchor.get("hreflang"):""},i.anchorHreflang=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.hreflang(t)},e.anchorHref=function(){return this.anchor?this.anchor.get("href"):""},i.anchorHref=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.href(t)},e.anchorDownload=function(){return this.anchor?this.anchor.get("download"):""},i.anchorDownload=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.download(t)},i.anchorFocusAction=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.focusAction(t)},i.anchorBlurAction=function(t){this.anchor||this.buildAnchor(),this.anchor&&this.anchor.setters.blurAction(t)},i.anchor=function(t={}){this.anchor?this.anchor.set(t):this.buildAnchor(t)},t.buildAnchor=function(t={}){this.anchor&&this.anchor.demolish(),t.name||(t.name=this.name+"-anchor"),t.description||(t.description=`Anchor link for ${this.name} ${this.type}`),t.host=this,t.hold=this.getAnchorHold(),this.anchor=function(t){return new Anchor(t)}(t)},t.getAnchorHold=function(){let t=this.currentHost;if(t){if("Canvas"===t.type)return t.navigation;if("Cell"===t.type){let e=t.currentHost?t.currentHost:o[t.host];if(e&&"Canvas"===e.type)return e.navigation}}return this.dirtyAnchorHold=!0,ss},t.rebuildAnchor=function(){this.anchor&&this.anchor.build()},t.clickAnchor=function(){this.anchor&&this.anchor.click()},t}function Ze(t={}){t.defs=_(t.defs,{groups:null,groupBuckets:null,batchResort:!0});let e=t.getters,i=t.setters;return e.groups=function(){return[].concat(this.groups)},i.groups=function(t){this.groups=[],this.addGroups(t)},t.sortGroups=function(t=!1){if(this.batchResort){this.batchResort=!1;let t,e,i=Math.floor,s=this.groups,n=[];s.forEach(s=>{t=u[s],e=t?i(t.order):0,n[e]||(n[e]=[]),n[e].push(t)}),this.groupBuckets=n.reduce((t,e)=>t.concat(e),[])}},t.initializeCascade=function(){this.groups=[],this.groupBuckets=[]},t.addGroups=function(...t){return t.forEach(t=>{t&&t.substring?Q(this.groups,t):u[t]&&Q(this.groups,t.name)},this),this.batchResort=!0,this},t.removeGroups=function(...t){return t.forEach(t=>{t&&t.substring?K(this.groups,t):u[t]&&K(this.groups,t.name)},this),this.batchResort=!0,this},t.cascadeAction=function(t,e){let i;return console.log("cascadeAction"),this.groups.forEach(s=>{i=u[s],i&&i[e](t)},this),this},t.updateArtefacts=function(t){return this.cascadeAction(t,"updateArtefacts"),this},t.setArtefacts=function(t){return this.cascadeAction(t,"setArtefacts"),this},t.addArtefactClasses=function(t){return this.cascadeAction(t,"addArtefactClasses"),this},t.removeArtefactClasses=function(t){return this.cascadeAction(t,"removeArtefactClasses"),this},t.updateByDelta=function(){return this.cascadeAction(!1,"updateByDelta"),this},t.reverseByDelta=function(){return this.cascadeAction(!1,"reverseByDelta"),this},t.getArtefactAt=function(t){if(t=et(t,this.here,!1)){let e,i;for(let s=this.groups.length-1;s>=0;s--)if(e=u[this.groups[s]],e&&(i=e.getArtefactAt(t),i))return i}return!1},t.getAllArtefactsAt=function(t){if(t=et(t,this.here,!1)){let e,i,s=[];for(let n=this.groups.length-1;n>=0;n--)e=u[this.groups[n]],e&&(i=e.getAllArtefactsAt(t),i&&(s=s.concat(i)));return s}return[]},t}function Qe(t={}){t.defs=_(t.defs,{repeat:"repeat",patternMatrix:null});let e=t.setters;return t.repeatValues=["repeat","repeat-x","repeat-y","no-repeat"],e.repeat=function(t){this.repeatValues.indexOf(t)>=0?this.repeat=t:this.repeat=this.defs.repeat},t.matrixNumberPosCheck=["a","b","c","d","e","f"],t.updateMatrixNumber=function(t,e){this.patternMatrix||(this.patternMatrix=new DOMMatrix),t=t.substring?parseFloat(t):t;let i=this.matrixNumberPosCheck.indexOf(e);V(t)&&i>=0&&(this.patternMatrix[e]=t)},e.matrixA=function(t){this.updateMatrixNumber(t,"a")},e.matrixB=function(t){this.updateMatrixNumber(t,"b")},e.matrixC=function(t){this.updateMatrixNumber(t,"c")},e.matrixD=function(t){this.updateMatrixNumber(t,"d")},e.matrixE=function(t){this.updateMatrixNumber(t,"e")},e.matrixF=function(t){this.updateMatrixNumber(t,"f")},e.patternMatrix=function(t){if(Array.isArray(t)){let e=this.updateMatrixNumber;e(t[0],"a"),e(t[1],"b"),e(t[2],"c"),e(t[3],"d"),e(t[4],"e"),e(t[5],"f")}},t.buildStyle=function(t={}){if(t){t.substring&&(t=a[t]);let e=this.source,i=this.sourceLoaded,s=this.repeat,n=t.engine;if("Cell"!==this.type&&"Noise"!==this.type||(e=this.element,i=!0),n&&i){let t=n.createPattern(e,s);return t.setTransform(this.patternMatrix),t}}return"rgba(0,0,0,0)"},t}function Ke(t={}){return t.defs=_(t.defs,{filters:null,isStencil:!1}),t.setters.filters=function(t){Array.isArray(this.filters)||(this.filters=[]),t&&(Array.isArray(t)?(this.filters=t,this.dirtyFilters=!0,this.dirtyImageSubscribers=!0):t.substring&&(Q(this.filters,t),this.dirtyFilters=!0,this.dirtyImageSubscribers=!0))},t.cleanFilters=function(){this.dirtyFilters=!1,this.filters||(this.filters=[]);let t,e,i=this.filters,s=Math.floor,n=[];i.forEach(i=>{t=c[i],t&&(e=s(t.order)||0,n[e]||(n[e]=[]),n[e].push(t))}),this.currentFilters=n.reduce((t,e)=>t.concat(e),[])},t.addFilters=function(...t){return Array.isArray(this.filters)||(this.filters=[]),t.forEach(t=>{t&&"Filter"===t.type&&(t=t.name),Q(this.filters,t)},this),this.dirtyFilters=!0,this.dirtyImageSubscribers=!0,this},t.removeFilters=function(...t){return Array.isArray(this.filters)||(this.filters=[]),t.forEach(t=>{t&&"Filter"===t.type&&(t=t.name),K(this.filters,t)},this),this.dirtyFilters=!0,this.dirtyImageSubscribers=!0,this},t.clearFilters=function(){return Array.isArray(this.filters)||(this.filters=[]),this.filters.length=0,this.dirtyFilters=!0,this.dirtyImageSubscribers=!0,this},t.preprocessFilters=function(t){t.forEach(t=>{t.actions.forEach(t=>{if("process-image"==t.action){let e=!0,i=n[t.asset];if(i){"Noise"===i.type&&i.checkSource();let s=i.sourceNaturalWidth||i.sourceNaturalDimensions[0]||i.currentDimensions[0],n=i.sourceNaturalHeight||i.sourceNaturalDimensions[1]||i.currentDimensions[1];if(s&&n){e=!1;let r=t.copyX||0,o=t.copyY||0,a=t.copyWidth||1,l=t.copyHeight||1,h=t.width||1,c=t.height||1;r.substring&&(r=parseFloat(r)/100*s),o.substring&&(o=parseFloat(o)/100*n),a.substring&&(a=parseFloat(a)/100*s),l.substring&&(l=parseFloat(l)/100*n),r=Math.abs(r),o=Math.abs(o),a=Math.abs(a),l=Math.abs(l),r>s&&(r=s-2,a=1),o>n&&(o=n-2,l=1),a>s&&(a=s-1,r=0),l>n&&(l=n-1,o=0),r+a>s&&(r=s-a-1),o+l>n&&(o=n-l-1);let u=ni(),d=u.engine,f=u.element;f.width=h,f.height=c,d.setTransform(1,0,0,1,0,0),d.globalCompositeOperation="source-over",d.globalAlpha=1;let p=i.source||i.element;d.drawImage(p,r,o,a,l,0,0,h,c),t.assetData=d.getImageData(0,0,h,c),ri(u)}}e&&(t.assetData={width:1,height:1,data:[0,0,0,0]})}})})},t}O.Anchor=Anchor;const Cell=function(t={}){if(this.makeName(t.name),t.isPool||this.register(),this.initializePositions(),this.initializeCascade(),!z(t.element)){let e=document.createElement("canvas");e.id=this.name,e.width=300,e.height=150,t.element=e}return this.installElement(t.element),t.isPool?this.set(this.poolDefs):this.set(this.defs),this.set(t),this.state.setStateFromEngine(this.engine),t.isPool||ci({name:this.name,host:this.name}),this.subscribers=[],this.sourceNaturalDimensions=He(),this.sourceLoaded=!0,this.here={},this};let Je=Cell.prototype=Object.create(Object.prototype);Je.type="Cell",Je.lib="cell",Je.isArtefact=!1,Je.isAsset=!0,Je=ee(Je),Je=Me(Je),Je=Ye(Je),Je=ze(Je),Je=Ge(Je),Je=We(Je),Je=Ve(Je),Je=_e(Je),Je=Ze(Je),Je=Qe(Je),Je=Ke(Je);Je.defs=_(Je.defs,{cleared:!0,compiled:!0,shown:!0,compileOrder:0,showOrder:0,backgroundColor:"",clearAlpha:0,alpha:1,composite:"source-over",scale:1,flipReverse:!1,flipUpend:!1,filter:"none",isBase:!1,controller:null}),delete Je.defs.source,delete Je.defs.sourceLoaded,Je.stringifyFunction=B,Je.processPacketOut=B,Je.finalizePacketOut=B,Je.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},Je.clone=$,Je.factoryKill=function(){let t=this.name;Object.entries(o).forEach(([e,i])=>{i.cells.indexOf(t)>=0&&i.removeCell(t),i.base&&i.base.name===t&&i.set({visibility:!1})}),Object.entries(i).forEach(([e,i])=>{if(i.name!==t){let e=i.state;if(e){let i=e.fillStyle,s=e.strokeStyle;i.name&&i.name===t&&(e.fillStyle=e.defs.fillStyle),s.name&&s.name===t&&(e.strokeStyle=e.defs.strokeStyle)}}}),u[t]&&u[t].kill()};let ti=Je.getters,ei=Je.setters,ii=Je.deltaSetters;Je.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},ti.width=function(){return this.currentDimensions[0]||this.element.getAttribute("width")},ei.width=function(t){this.dimensions[0]=t,this.dirtyDimensions=!0},ti.height=function(){return this.currentDimensions[1]||this.element.getAttribute("height")},ei.height=function(t){this.dimensions[1]=t,this.dirtyDimensions=!0},ei.source=function(){},ei.engine=function(t){},ei.state=function(t){},ei.element=function(t){z(t)&&this.installElement(t)},ei.cleared=function(t){this.cleared=t,this.updateControllerCells()},ei.compiled=function(t){this.compiled=t,this.updateControllerCells()},ei.shown=function(t){this.shown=t,this.updateControllerCells()},ei.compileOrder=function(t){this.compileOrder=t,this.updateControllerCells()},ei.showOrder=function(t){this.showOrder=t,this.updateControllerCells()},ei.stashX=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]),this.stashCoordinates[0]=t},ei.stashY=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]),this.stashCoordinates[1]=t},ei.stashWidth=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}this.stashDimensions[0]=t},ei.stashHeight=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}this.stashDimensions[1]=t},ii.stashX=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]);let e=this.stashCoordinates;e[0]=addStrings(e[0],t)},ii.stashY=function(t){this.stashCoordinates||(this.stashCoordinates=[0,0]);let e=this.stashCoordinates;e[1]=addStrings(e[1],t)},ii.stashWidth=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}let e=this.stashDimensions;e[0]=addStrings(e[0],t)},ii.stashHeight=function(t){if(!this.stashDimensions){let t=this.currentDimensions;this.stashDimensions=[t[0],t[1]]}let e=this.stashDimensions;e[1]=addStrings(e[1],t)},ei.clearAlpha=function(t){t.toFixed&&(t>1?t=1:t<0&&(t=0),this.clearAlpha=t)},ii.clearAlpha=function(t){t.toFixed&&((t+=this.clearAlpha)>1?t=1:t<0&&(t=0),this.clearAlpha=t)},Je.checkSource=function(t,e){this.currentDimensions[0]===t&&this.currentDimensions[1]===e||this.notifySubscribers()},Je.getData=function(t,e){return this.checkSource(this.sourceNaturalDimensions[0],this.sourceNaturalDimensions[1]),this.buildStyle(e)},Je.updateArtefacts=function(t={}){this.groupBuckets.forEach(e=>{e.artefactBuckets.forEach(e=>{t.dirtyScale&&(e.dirtyScale=!0),t.dirtyDimensions&&(e.dirtyDimensions=!0),t.dirtyLock&&(e.dirtyLock=!0),t.dirtyStart&&(e.dirtyStart=!0),t.dirtyOffset&&(e.dirtyOffset=!0),t.dirtyHandle&&(e.dirtyHandle=!0),t.dirtyRotation&&(e.dirtyRotation=!0),t.dirtyPathObject&&(e.dirtyPathObject=!0)})})},Je.cleanDimensionsAdditionalActions=function(){let t=this.element;if(t){let e=this.controller,i=this.currentDimensions,s=this.isBase;if(s&&e&&e.isComponent){let t=this.controller.currentDimensions,e=this.dimensions;e[0]=i[0]=t[0],e[1]=i[1]=t[1]}let[n,r]=i;t.width=n,t.height=r,this.setEngineFromState(this.engine),s&&e&&e.updateBaseHere(),this.groupBuckets&&this.updateArtefacts({dirtyDimensions:!0})}},Je.notifySubscriber=function(t){t.sourceNaturalDimensions||(t.sourceNaturalDimensions=[]),t.sourceNaturalWidth=this.currentDimensions[0],t.sourceNaturalHeight=this.currentDimensions[1],t.sourceLoaded=!0,t.dirtyImage=!0,t.dirtyCopyStart=!0,t.dirtyCopyDimensions=!0},Je.subscribeAction=function(t={}){this.subscribers.push(t),t.asset=this,t.source=this.element,this.notifySubscriber(t)},Je.installElement=function(t){return this.element=t,this.engine=this.element.getContext("2d"),this.state=De({engine:this.engine}),this},Je.updateControllerCells=function(){this.controller&&(this.controller.dirtyCells=!0)},Je.setEngineFromState=function(t){let e=this.state;return e.allKeys.forEach(i=>{"lineDash"===i?(t.lineDash=e.lineDash,t.setLineDash(t.lineDash)):t[i]=e[i]},e),t.textAlign=e.textAlign,t.textBaseline=e.textBaseline,this},Je.setToDefaults=function(){let t=this.state.defs,e=this.state,i=this.engine,s=Array.isArray;return Object.entries(t).forEach(([t,n])=>{"lineDash"===t?(s(i.lineDash)?i.lineDash.length=0:i.lineDash=[],s(e.lineDash)?e.lineDash.length=0:e.lineDash=[]):(i[t]=n,e[t]=n)}),i.textAlign=e.textAlign="left",i.textBaseline=e.textBaseline="top",this},Je.stylesArray=["Gradient","RadialGradient","Pattern"],Je.setEngine=function(t){let e,i,s=this.state,n=t.state.getChanges(t,s),r=this.setEngineActions,o=this.stylesArray;if(Object.keys(n).length)for(i in e=this.engine,n)r[i](n[i],e,o,t,this),s[i]=n[i];return t},Je.setEngineActions={fillStyle:function(t,e,i,s,n){if(t.substring){let i=!1;k.indexOf(t)>=0?i=b[t]:l.indexOf(t)>=0&&(i=a[t]),i?(s.state.fillStyle=i,e.fillStyle=i.getData(s,n)):e.fillStyle=t}else e.fillStyle=t.getData(s,n)},filter:function(t,e){e.filter=t},font:function(t,e){e.font=t},globalAlpha:function(t,e){e.globalAlpha=t},globalCompositeOperation:function(t,e){e.globalCompositeOperation=t},lineCap:function(t,e){e.lineCap=t},lineDash:function(t,e){e.lineDash=t,e.setLineDash&&e.setLineDash(t)},lineDashOffset:function(t,e){e.lineDashOffset=t},lineJoin:function(t,e){e.lineJoin=t},lineWidth:function(t,e){e.lineWidth=t},miterLimit:function(t,e){e.miterLimit=t},shadowBlur:function(t,e){e.shadowBlur=t},shadowColor:function(t,e){e.shadowColor=t},shadowOffsetX:function(t,e){e.shadowOffsetX=t},shadowOffsetY:function(t,e){e.shadowOffsetY=t},strokeStyle:function(t,e,i,s,n){if(t.substring){let i=!1;k.indexOf(t)>=0?i=b[t]:l.indexOf(t)>=0&&(i=a[t]),i?(s.state.strokeStyle=i,e.strokeStyle=i.getData(s,n)):e.strokeStyle=t}else e.strokeStyle=t.getData(s,n)}},Je.clearShadow=function(){return this.engine.shadowOffsetX=0,this.engine.shadowOffsetY=0,this.engine.shadowBlur=0,this.state.shadowOffsetX=0,this.state.shadowOffsetY=0,this.state.shadowBlur=0,this},Je.restoreShadow=function(t){let e=t.state;return this.engine.shadowOffsetX=e.shadowOffsetX,this.engine.shadowOffsetY=e.shadowOffsetY,this.engine.shadowBlur=e.shadowBlur,this.state.shadowOffsetX=e.shadowOffsetX,this.state.shadowOffsetY=e.shadowOffsetY,this.state.shadowBlur=e.shadowBlur,this},Je.setToClearShape=function(){return this.engine.fillStyle="rgba(0,0,0,0)",this.engine.strokeStyle="rgba(0,0,0,0)",this.engine.shadowColor="rgba(0,0,0,0)",this.state.fillStyle="rgba(0,0,0,0)",this.state.strokeStyle="rgba(0,0,0,0)",this.state.shadowColor="rgba(0,0,0,0)",this},Je.saveEngine=function(){return this.engine.save(),this},Je.restoreEngine=function(){return this.engine.restore(),this},Je.getComputedFontSizes=function(){let t=this.getHost();if(t&&t.domElement){let e=window.getComputedStyle(t.domElement),i=window.getComputedStyle(document.documentElement);return[parseFloat(e.fontSize),parseFloat(i.fontSize),window.innerWidth,window.innerHeight]}return!1},Je.clear=function(){let t=this;return new Promise(e=>{const{element:i,engine:s,backgroundColor:n,clearAlpha:r,currentDimensions:o}=t,[a,l]=o;if(t.prepareStamp(),s.setTransform(1,0,0,1,0,0),n){let t=s.fillStyle,e=s.globalCompositeOperation,i=s.globalAlpha;s.fillStyle=n,s.globalCompositeOperation="source-over",s.globalAlpha=1,s.fillRect(0,0,a,l),s.fillStyle=t,s.globalCompositeOperation=e,s.globalAlpha=i}else if(r){let t=ni(),{engine:e,element:i}=t;i.width=a,i.height=l;let n=s.getImageData(0,0,a,l);e.putImageData(n,0,0);let o=s.globalAlpha;s.clearRect(0,0,a,l),s.globalAlpha=r,s.drawImage(i,0,0),s.globalAlpha=o}else s.clearRect(0,0,a,l);e(!0)})},Je.compile=function(){this.stashOutput;this.sortGroups(),this.prepareStamp(),!this.dirtyFilters&&this.currentFilters||this.cleanFilters();let t=this,e=i=>new Promise((s,n)=>{let r=t.groupBuckets[i];r&&r.stamp?r.stamp().then(t=>{e(i+1).then(t=>{s(!0)}).catch(t=>n(t))}).catch(t=>n(t)):!t.noFilters&&t.filters&&t.filters.length?t.applyFilters().then(e=>t.stashOutputAction()).then(t=>s(!0)).catch(t=>n(t)):t.stashOutputAction().then(t=>s(!0)).catch(t=>n(t))});return e(0)},Je.show=function(){var t=this;return new Promise(e=>{let i=t.getHost(),s=!(!i||!i.engine)&&i.engine;if(s){let n=Math.floor,r=i.currentDimensions,o=n(r[0]),a=n(r[1]);o&&a||e(!1);let l,h=t.currentScale,c=t.currentDimensions,u=n(c[0]),d=n(c[1]),f=t.composite,p=t.alpha,m=t.controller,g=t.element;if(s.save(),s.setTransform(1,0,0,1,0,0),s.filter=t.filter,t.isBase){let e,i;switch(t.basePaste||(t.basePaste=[]),l=t.basePaste,t.prepareStamp(),s.globalCompositeOperation="source-over",s.globalAlpha=1,s.clearRect(0,0,o,a),s.globalCompositeOperation=f,s.globalAlpha=p,m?m.fit:"none"){case"contain":e=o/(u||1),i=a/(d||1),e>i?(l[0]=n((o-u*i)/2),l[1]=0,l[2]=n(u*i),l[3]=n(d*i)):(l[0]=0,l[1]=n((a-d*e)/2),l[2]=n(u*e),l[3]=n(d*e));break;case"cover":e=o/(u||1),i=a/(d||1),e<i?(l[0]=n((o-u*i)/2),l[1]=0,l[2]=n(u*i),l[3]=n(d*i)):(l[0]=0,l[1]=n((a-d*e)/2),l[2]=n(u*e),l[3]=n(d*e));break;case"fill":l[0]=0,l[1]=0,l[2]=n(o),l[3]=n(a);break;case"none":default:l[0]=n((o-u)/2),l[1]=n((a-d)/2),l[2]=u,l[3]=d}}else if(h>0){t.paste||(t.paste=[]),l=t.paste,t.noDeltaUpdates||t.setDelta(t.delta),t.prepareStamp(),s.globalCompositeOperation=f,s.globalAlpha=p;let e=t.currentStampHandlePosition,i=t.currentStampPosition;l[0]=n(-e[0]*h),l[1]=n(-e[1]*h),l[2]=n(u*h),l[3]=n(d*h),t.rotateDestination(s,i[0],i[1])}s.drawImage(g,0,0,u,d,...l),s.restore(),e(!0)}else e(!1)})},Je.applyFilters=function(){let t=this;return new Promise((function(e){let i,s,n=t.engine;i=n.getImageData(0,0,t.currentDimensions[0],t.currentDimensions[1]),s=ve(),t.preprocessFilters(t.currentFilters),xe(s,{image:i,filters:t.currentFilters}).then(t=>{we(s),t?(n.putImageData(t,0,0),e(!0)):e(!1)}).catch(t=>{we(s),e(!1)})}))},Je.stashOutputAction=function(){let t=this;return this.stashOutput?(this.stashOutput=!1,new Promise((e,i)=>{let[s,n]=t.currentDimensions,r=t.stashCoordinates,o=t.stashDimensions,a=r?r[0]:0,l=r?r[1]:0,h=o?o[0]:s,c=o?o[1]:n;if((h.substring||c.substring||a.substring||l.substring||a||l||h!==s||c!==n)&&(h.substring&&(h=parseFloat(h)/100*s),(isNaN(h)||h<=0)&&(h=1),h>s&&(h=s),c.substring&&(c=parseFloat(c)/100*n),(isNaN(c)||c<=0)&&(c=1),c>n&&(c=n),a.substring&&(a=parseFloat(a)/100*s),(isNaN(a)||a<0)&&(a=0),a+h>s&&(a=s-h),l.substring&&(l=parseFloat(l)/100*n),(isNaN(l)||l<0)&&(l=0),l+c>n&&(l=n-c)),t.engine.save(),t.engine.setTransform(1,0,0,1,0,0),t.stashedImageData=t.engine.getImageData(a,l,h,c),t.engine.restore(),t.stashOutputAsAsset){let e,i;if(t.stashOutputAsAsset=!1,i=ni(),e=i.element,e.width=h,e.height=c,i.engine.putImageData(t.stashedImageData,0,0),t.stashedImage)t.stashedImage.src=e.toDataURL();else{let i=t.stashedImage=document.createElement("img");i.id=t.name+"-image",i.onload=function(){is.appendChild(i),Ne("#"+i.id)},i.src=e.toDataURL()}ri(i)}e(!0)})):Promise.resolve(!1)},Je.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=n[this.host]||i[this.host];return t&&(this.currentHost=t),!!t&&this.currentHost}return!1},Je.updateBaseHere=function(t,e){if(this.isBase){this.here||(this.here={});let i=this.here,s=this.currentDimensions,n=t.active,r=t.localListener?t.originalWidth:t.w,o=t.localListener?t.originalHeight:t.h;if(s[0]!==r||s[1]!==o){this.basePaste||(this.basePaste=[]);let a,l,h=this.basePaste[0],c=s[0],u=s[1],d=r,f=o,p=t.x,m=t.y,g=c/d||1,y=u/f||1,b=Math.round;switch(i.w=c,i.h=u,e){case"contain":case"cover":h?(a=(d-c/y)/2,i.x=b((p-a)*y),i.y=b(m*y)):(l=(f-u/g)/2,i.x=b(p*g),i.y=b((m-l)*g));break;case"fill":i.x=b(p*g),i.y=b(m*y);break;case"none":default:a=(d-c)/2,l=(f-u)/2,i.x=b(p-a),i.y=b(m-l)}(i.x<0||i.x>c)&&(n=!1),(i.y<0||i.y>u)&&(n=!1),i.active=n}else i.x=t.x,i.y=t.y,i.w=r,i.h=o,i.active=n;t.baseActive=n}},Je.prepareStamp=function(){(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle)&&(this.dirtyPathObject=!0),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&(this.cleanDimensions(),this.dirtyAssetSubscribers=!0),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers(),this.dirtyAssetSubscribers&&(this.dirtyAssetSubscribers=!1,this.notifySubscribers())},Je.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=this.currentStampHandlePosition,i=this.currentScale,s=this.currentDimensions,n=-e[0]*i,r=-e[1]*i,o=s[0]*i,a=s[1]*i;t.rect(n,r,o,a)}},Je.updateHere=function(){this.here||(this.here={});let t=this.here,[e,i]=this.currentDimensions;t.w=e,t.h=i,t.x=-1e4,t.y=-1e4,t.active=!1;let s=this.currentHost;if(s){let e=s.here;if(e&&e.active){let{x:i,y:s,w:n,h:r}=e;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let o=ni(),a=o.engine,[l,h]=this.currentStampPosition;o.rotateDestination(a,l,h,this);let c=a.isPointInPath(this.pathObject,i,s);if(ri(o),t.active=c,c){let[e,n]=this.currentStampHandlePosition,{flipUpend:r,flipReverse:o,roll:a,scale:c}=this;if(c){let u=(i-l)/c,d=(s-h)/c;if(o&&(u=-u),r&&(d=-d),a){(o&&!r||!o&&r)&&(a=-a);let t=Fe(u,d);t.rotate(-a),[u,d]=t,Te(t)}u+=e,d+=n,t.x=u,t.y=d}}}}},Je.getEntityHits=function(){let t=[],e=[],i=[];return this.groupBuckets&&this.groupBuckets.forEach(t=>{t.visibility&&e.push(t.getAllArtefactsAt(this.here))},this),e.length&&(e=e.reduce((t,e)=>t.concat(e),[]),e.forEach(e=>{let s=e.artefact;s.visibility&&i.indexOf(s.name)<0&&(i.push(s.name),t.push(s))})),t},Je.rotateDestination=function(t,e,i,s){let n,r,o=s||this,a=o.mimic,l=o.pivot,h=o.currentRotation;if(a&&a.name&&o.useMimicFlip?(n=a.flipReverse?-1:1,r=a.flipUpend?-1:1):(n=o.flipReverse?-1:1,r=o.flipUpend?-1:1),a&&a.name&&o.useMimicRotation?h=a.currentRotation:l&&l.name&&o.addPivotRotation&&(h=l.currentRotation),h){h*=P;let s=Math.cos(h),o=Math.sin(h);t.setTransform(s*n,o*n,-o*r,s*r,e,i)}else t.setTransform(n,0,0,r,e,i);return this};const si=[];Je.poolDefs={element:null,engine:null,state:null,width:300,height:100,alpha:1,composite:"source-over"};const ni=function(){return si.length||si.push(oi({name:"pool_"+N(),isPool:!0})),si.shift()},ri=function(t){t&&"Cell"===t.type&&(t.engine.setTransform(1,0,0,1,0,0),si.push(t.setToDefaults()))},oi=function(t){return new Cell(t)};O.Cell=Cell;const Group=function(t={}){return this.makeName(t.name),this.register(),this.artefacts=[],this.artefactBuckets=[],this.set(this.defs),this.set(t),this};let ai=Group.prototype=Object.create(Object.prototype);ai.type="Group",ai.lib="group",ai.isArtefact=!1,ai.isAsset=!1,ai=ee(ai),ai=Ke(ai);ai.defs=_(ai.defs,{artefacts:null,order:0,visibility:!0,regionRadius:0}),ai.packetExclusions=Q(ai.packetExclusions,["artefactBuckets","batchResort"]),ai.postCloneAction=function(t,e){let s;return s=e.host?i[e.host]:this.currentHost?this.currentHost:!!this.host&&i[this.host],s&&(s.addGroups(t.name),t.host||(t.host=s.name)),t},ai.kill=function(t=!1){let e=this.name;return Object.entries(i).forEach(([t,i])=>{Array.isArray(i.groups)&&i.groups.indexOf(e)>=0&&(K(i.groups,e),i.batchResort=!0)}),Object.entries(a).forEach(([t,i])=>{Array.isArray(i.groups)&&i.groups.indexOf(e)>=0&&(K(i.groups,e),i.batchResort=!0)}),t&&this.artefactBuckets.forEach(t=>t.kill()),this.deregister()},ai.killArtefacts=function(){return this.artefactBuckets.forEach(t=>t.kill()),this};let li=ai.getters,hi=ai.setters;li.artefacts=function(){return[].concat(this.artefacts)},hi.artefacts=function(t){this.artefacts=[],this.addArtefacts(t)},hi.host=function(t){let e=this.getHost(t);e&&e.addGroups&&(this.host=t,e.addGroups(this.name),this.dirtyHost=!0)},hi.order=function(t){let e=this.getHost(this.host);this.order=t,e&&e.set({batchResort:!0})},ai.getHost=function(t){let e=this.currentHost;return!e||e.substring?i[t]||a[t]||i[e]||a[e]||null:e},ai.forceStamp=function(){var t=this;return new Promise(e=>{let i=t.visibility;t.visibility=!0,t.stamp().then(s=>{t.visibility=i,e(s)}).catch(s=>{t.visibility=i,e(s)})})},ai.stamp=function(){if(this.dirtyHost||!this.currentHost){this.dirtyHost=!1;let t=this.getHost(this.host);t?this.currentHost=t:this.dirtyHost=!0}let t=this;return new Promise((e,i)=>{if(t.visibility){let s=t.currentHost;if(s){t.sortArtefacts();let n=!!(t.stashOutput||!t.noFilters&&t.filters&&t.filters.length)&&ni();if(n&&n.element){let t=s.currentDimensions;t&&(n.element.width=t[0],n.element.height=t[1]),n.engine.save()}else s.engine&&s.engine.save();t.prepareStamp(n),t.stampAction(n).then(i=>{n?(n.engine.restore(),ri(n)):s.engine&&(s.engine.restore(),s.setEngineFromState(s.engine)),e(t.name)}).catch(t=>{n?(n.engine.restore(),ri(n)):s.engine&&(s.engine.restore(),s.setEngineFromState(s.engine)),i(t)})}else e(!1)}else e(!1)})},ai.sortArtefacts=function(){if(this.batchResort){this.batchResort=!1;let t=Math.floor,e=[];this.artefacts.forEach(s=>{let n=i[s],r=t(n.order)||0;e[r]||(e[r]=[]),e[r].push(n)}),this.artefactBuckets=e.reduce((t,e)=>t.concat(e),[])}},ai.prepareStamp=function(t){let e=this.currentHost;t&&(e=t),this.artefactBuckets.forEach(i=>{"entity"===i.lib&&(i.currentHost&&i.currentHost.name===e.name||(i.currentHost=e,t||(i.dirtyHost=!0))),i.noDeltaUpdates||i.updateByDelta(),i.prepareStamp()})},ai.stampAction=function(t){!this.currentHost||this.currentHost.stashOutput;!this.dirtyFilters&&this.currentFilters||this.cleanFilters();let e=this,i=s=>new Promise((n,r)=>{let o=e.artefactBuckets[s];if(o&&o.stamp)o.stamp().then(()=>{i(s+1).then(t=>n(!0)).catch(t=>r(t))}).catch(t=>r(t));else if(t)if(!e.noFilters&&e.filters&&e.filters.length)e.applyFilters(t).then(t=>e.stashAction(t)).then(t=>n(!0)).catch(t=>r(t));else if(e.stashOutput){let i=t.element,s=t.engine,o=!(!e.currentHost||!e.currentHost.engine)&&e.currentHost.engine;if(o){o.save(),o.globalCompositeOperation="source-over",o.globalAlpha=1,o.setTransform(1,0,0,1,0,0),o.drawImage(i,0,0),o.restore();let t=s.getImageData(0,0,i.width,i.height);e.stashAction(t).then(t=>n(!0)).catch(t=>r(t))}else r("Could not find real engine")}else n(!0);else n(!0)});return i(0)},ai.applyFilters=function(t){let e=this;return new Promise((i,s)=>{let n=e.currentHost,r=t;n&&r||s("Group.applyFilters - no host");let o=function(){we(d),l.save(),l.setTransform(1,0,0,1,0,0),l.drawImage(h,0,0),l.restore()},a=n.element,l=n.engine,h=r.element,c=r.engine;e.isStencil&&(c.save(),c.globalCompositeOperation="source-in",c.globalAlpha=1,c.setTransform(1,0,0,1,0,0),c.drawImage(a,0,0),c.restore()),c.setTransform(1,0,0,1,0,0);let u=c.getImageData(0,0,h.width,h.height),d=ve();e.preprocessFilters(e.currentFilters),xe(d,{image:u,filters:e.currentFilters}).then(t=>{if(!t)throw new Error("image issue");c.globalCompositeOperation="source-over",c.globalAlpha=1,c.setTransform(1,0,0,1,0,0),c.putImageData(t,0,0),o(),i(t)}).catch(t=>{o(),s(t)})})},ai.stashAction=function(t){if(!t)return Promise.reject("No image data supplied to stashAction");if(this.stashOutput){this.stashOutput=!1;let e=this;return new Promise((i,s)=>{let[n,r,o,a]=e.getCellCoverage(t),l=ni(),h=l.engine,c=l.element;if(c.width=o,c.height=a,h.putImageData(t,-n,-r),e.stashedImageData=h.getImageData(0,0,o,a),e.stashOutputAsAsset)if(e.stashOutputAsAsset=!1,e.stashedImage)e.stashedImage.src=c.toDataURL();else{let t=e.stashedImage=document.createElement("img");t.id=e.name+"-groupimage",t.onload=function(){is.appendChild(t),Ne("#"+t.id)},t.src=c.toDataURL()}ri(l),i(!0)})}return Promise.resolve(!1)},ai.getCellCoverage=function(t){let e,i,s=t.width,n=t.height,r=t.data,o=0,a=0,l=s,h=n,c=3;for(i=0;i<n;i++)for(e=0;e<s;e++)r[c]&&(l>e&&(l=e),o<e&&(o=e),h>i&&(h=i),a<i&&(a=i)),c+=4;return l<o&&h<a?[l,h,o-l,a-h]:[0,0,s,n]},ai.addArtefacts=function(...t){return t&&Array.isArray(t[0])&&(t=t[0]),t.forEach(t=>{t&&(t.substring?Q(this.artefacts,t):t.name&&Q(this.artefacts,t.name))},this),this.batchResort=!0,this},ai.removeArtefacts=function(...t){return t.forEach(t=>{t&&(t.substring?K(this.artefacts,t):t.name&&K(this.artefacts,t.name))},this),this.batchResort=!0,this},ai.moveArtefactsIntoGroup=function(...t){let e,s;return t.forEach(t=>{t&&(s=t.substring?i[t]:t,s&&s.isArtefact&&(e=s.group?s.group:!!s.host&&u[s.host]),e&&(e.removeArtefacts(t),e.batchResort=!0),Q(this.artefacts,t))},this),this.batchResort=!0,this},ai.clearArtefacts=function(){return this.artefacts.length=0,this.artefactBuckets.length=0,this.batchResort=!0,this},ai.updateArtefacts=function(t){return this.cascadeAction(t,"setDelta"),this},ai.setArtefacts=function(t){return this.cascadeAction(t,"set"),this},ai.updateByDelta=function(){return this.cascadeAction(!1,"updateByDelta"),this},ai.reverseByDelta=function(){return this.cascadeAction(!1,"reverseByDelta"),this},ai.addArtefactClasses=function(t){return this.cascadeAction(t,"addClasses"),this},ai.removeArtefactClasses=function(t){return this.cascadeAction(t,"removeClasses"),this},ai.cascadeAction=function(t,e){return this.artefacts.forEach(s=>{let n=i[s];n&&n[e]&&n[e](t)}),this},ai.setDeltaValues=function(t={}){return this.artefactBuckets.forEach(e=>e.setDeltaValues(t)),this},ai.addFiltersToEntitys=function(...t){return this.artefacts.forEach(e=>{let i=h[e];i&&i.addFilters&&i.addFilters(t)}),this},ai.removeFiltersFromEntitys=function(...t){return this.artefacts.forEach(e=>{let i=h[e];i&&i.removeFilters&&i.removeFilters(t)}),this},ai.clearFiltersFromEntitys=function(){return this.artefacts.forEach(t=>{let e=h[t];e&&e.clearFilters&&e.clearFilters()}),this},ai.getArtefactAt=function(t){let e=ni(),i=this.artefactBuckets;this.sortArtefacts();for(let s=i.length-1;s>=0;s--){let n=i[s];if(n){let i=n.checkHit(t,e);if(i)return ri(e),i}}return ri(e),!1},ai.getAllArtefactsAt=function(t){let e=ni(),i=this.artefactBuckets,s=[],n=[];this.sortArtefacts();for(let r=i.length-1;r>=0;r--){let o=i[r];if(o){let i=o.checkHit(t,e);if(i&&i.artefact){let t=i.artefact;s.indexOf(t.name)<0&&(s.push(t.name),n.push(i))}}}return ri(e),n},ai.getArtefactCollisions=function(t){if(!t||!t.isArtefact||!this.artefactBuckets.length)return[];if(t.substring&&(t=i[t]),!t.collides)return[];let e,s,n,r=this.artefactBuckets,o=[],[a,l]=t.cleanCollisionData();for(s=0,n=r.length;s<n;s++)e=r[s],e&&e.cleanCollisionData&&t.name!==e.name?o.push(e):o.push(!1);let h,c,u,d,f,[p,m]=t.currentStampPosition;for(s=0,n=o.length;s<n;s++)if(e=o[s],e){let[t,i]=e.currentStampPosition;c=e.cleanCollisionData(),h=a+c[0],u=p-t,d=m-i,f=Math.sqrt(u*u+d*d),f>h&&(o[s]=!1)}let g=ni();for(s=0,n=o.length;s<n;s++)e=o[s],e&&(o[s]=e.checkHit(l,g));return ri(g),o.filter(t=>!!t)};const ci=function(t){return new Group(t)};O.Group=Group;const Vector=function(t,e,i){return this.x=0,this.y=0,this.z=0,J(t)&&this.set(t,e,i),this};let ui=Vector.prototype=Object.create(Object.prototype);ui.type="Vector",ui.getXYCoordinate=function(){return[this.x,this.y]},ui.getXYZCoordinate=function(){return[this.x,this.y,this.z]},ui.setX=function(t){if(!J(t))throw new Error(`${this.name} Vector error - setX() arguments error: ${t}`);return this.x=t,this},ui.setY=function(t){if(!J(t))throw new Error(`${this.name} Vector error - setY() arguments error: ${t}`);return this.y=t,this},ui.setZ=function(t){if(!J(t))throw new Error(`${this.name} Vector error - setZ() arguments error: ${t}`);return this.z=t,this},ui.setXY=function(t,e){if(!tt(t,e))throw new Error(`${this.name} Vector error - setXY() arguments error: ${t}, ${e}`);return this.x=t,this.y=e,this},ui.set=function(t,e,i){return U(t)?this.setFromVector(t):Array.isArray(t)?this.setFromArray(t):tt(t,e)?this.setFromArray([t,e,i]):this},ui.setFromArray=function(t){if(!Array.isArray(t))throw new Error(`${this.name} Vector error - setFromArray() arguments error: ${t}`);let[e,i,s]=t;return V(e)&&(this.x=e),V(i)&&(this.y=i),V(s)&&(this.z=s),this},ui.setFromVector=function(t){if(!U(t))throw new Error(`${this.name} Vector error - setFromVector() arguments error: ${JSON.stringify(t)}`);let{x:e,y:i,z:s}=t;return V(e)&&(this.x=e),V(i)&&(this.y=i),V(s)&&(this.z=s),this},ui.zero=function(){return this.x=0,this.y=0,this.z=0,this},ui.vectorAdd=function(t={}){if(Array.isArray(t))return this.vectorAddArray(t);let{x:e,y:i,z:s}=t;return V(e)&&(this.x+=e),V(i)&&(this.y+=i),V(s)&&(this.z+=s),this},ui.vectorAddArray=function(t=[]){let[e,i,s]=t;return V(e)&&(this.x+=e),V(i)&&(this.y+=i),V(s)&&(this.z+=s),this},ui.vectorSubtract=function(t={}){if(Array.isArray(t))return this.vectorSubtractArray(t);let{x:e,y:i,z:s}=t;return V(e)&&(this.x-=e),V(i)&&(this.y-=i),V(s)&&(this.z-=s),this},ui.vectorSubtractArray=function(t){let[e,i,s]=t;return V(e)&&(this.x-=e),V(i)&&(this.y-=i),V(s)&&(this.z-=s),this},ui.scalarMultiply=function(t){if(!V(t))throw new Error(`${this.name} Vector error - scalarMultiply() argument not a number: ${t}`);return this.x*=t,this.y*=t,this.z*=t,this},ui.vectorMultiply=function(t={}){if(Array.isArray(t))return this.vectorMultiplyArray(t);let{x:e,y:i,z:s}=t;return V(e)&&(this.x*=e),V(i)&&(this.y*=i),V(s)&&(this.z*=s),this},ui.vectorMultiplyArray=function(t){let[e,i,s]=t;return V(e)&&(this.x*=e),V(i)&&(this.y*=i),V(s)&&(this.z*=s),this},ui.scalarDivide=function(t){if(!V(t))throw new Error(`${this.name} Vector error - scalarDivide() argument not a number: ${t}`);if(!t)throw new Error(`${this.name} Vector error - scalarDivide() division by zero: ${t}`);return this.x/=t,this.y/=t,this.z/=t,this},ui.getMagnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},ui.rotate=function(t){if(!V(t))throw new Error(`${this.name} Vector error - rotate() argument not a number: ${t}`);let e=Math.atan2(this.y,this.x);e+=.01745329251*t;let i=this.getMagnitude();return this.x=i*Math.cos(e),this.y=i*Math.sin(e),this},ui.reverse=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},ui.normalize=function(){let t=this.getMagnitude();return t>0&&(this.x/=t,this.y/=t,this.z/=t),this};const di=[],fi=function(t,e,i){di.length||di.push(new Vector);let s=di.shift();return s.set(t,e,i),s},pi=function(t){t&&"Vector"===t.type&&di.push(t.zero())},mi=function(t,e,i){return new Vector(t,e,i)};O.Vector=Vector;const Quaternion=function(t={}){return this.name=t.name||"generic",this.n=t.n||1,this.v=mi(),this.set(t),this};let gi=Quaternion.prototype=Object.create(Object.prototype);gi.type="Quaternion",gi.set=function(t={}){if(q(t))return this.setFromQuaternion(t);if(t&&t.type&&"Vector"===t.type)return this.setFromVector(t);if(it(t.pitch,t.yaw,t.roll))return this.setFromEuler(t);let e,i,s,n,r,o=this.v;return r=!(!J(t.vector)&&!J(t.v))&&(t.vector||t.v),n=!(!J(t.scalar)&&!J(t.n))&&(t.scalar||t.n||0),e=r?r.x||0:t.x||!1,i=r?r.y||0:t.y||!1,s=r?r.z||0:t.z||!1,this.n=V(n)?n:this.n,o.x=V(e)?e:o.x,o.y=V(i)?i:o.y,o.z=V(s)?s:o.z,this},gi.setFromQuaternion=function(t){if(!q(t))throw new Error(`${this.name} Quaternion error - setFromQuaternion() bad argument: ${t}`);let e=this.v,i=t.v;return this.n=t.n,e.x=i.x,e.y=i.y,e.z=i.z,this},gi.setFromEuler=function(t={}){let e,i,s,n,r,o,a,l,h,c=Math.cos,u=Math.sin,d=this.v;return e=(t.pitch||t.x||0)*P,i=(t.yaw||t.y||0)*P,s=(t.roll||t.z||0)*P,n=c(e/2),r=c(i/2),o=c(s/2),a=u(e/2),l=u(i/2),h=u(s/2),d.x=a*r*o+n*l*h,d.y=n*l*o+a*r*h,d.z=n*r*h-a*l*o,this.n=n*r*o-a*l*h,this},gi.zero=function(){let t=this.v;return this.n=1,t.x=0,t.y=0,t.z=0,this},gi.getMagnitude=function(){let t=this.v;return Math.sqrt(this.n*this.n+t.x*t.x+t.y*t.y+t.z*t.z)},gi.normalize=function(){let t=this.getMagnitude(),e=this.v;if(!t)throw new Error(`${this.name} Quaternion error - normalize() division by zero: ${t}`);return this.n/=t,this.n=this.n>-1e-6&&this.n<1e-6?0:this.n,e.x/=t,e.x=e.x>-1e-6&&e.x<1e-6?0:e.x,e.y/=t,e.y=e.y>-1e-6&&e.y<1e-6?0:e.y,e.z/=t,e.z=e.z>-1e-6&&e.z<1e-6?0:e.z,this},gi.quaternionMultiply=function(t){if(!q(t))throw new Error(`${this.name} Quaternion error - quaternionMultiply() bad argument: ${t}`);let e=this.v,i=t.v,s=this.n,n=e.x,r=e.y,o=e.z,a=t.n,l=i.x,h=i.y,c=i.z;return this.n=s*a-n*l-r*h-o*c,e.x=s*l+n*a+r*c-o*h,e.y=s*h+r*a+o*l-n*c,e.z=s*c+o*a+n*h-r*l,this},gi.getAngle=function(t){let e;return t=!!J(t)&&t,e=2*Math.acos(this.n),t&&(e*=1/P),e>-1e-6&&e<1e-6?0:e},gi.quaternionRotate=function(t){if(!q(t))throw new Error(`${this.name} Quaternion error - quaternionRotate() bad argument: ${t}`);let e=bi(t),i=bi(this);return this.setFromQuaternion(e.quaternionMultiply(i)),ki(e),ki(i),this};const yi=[],bi=function(t){yi.length||yi.push(Si({name:"pool"}));let e=yi.shift();return e.set(t),e},ki=function(t){t&&"Quaternion"===t.type&&yi.push(t.zero())},Si=function(t={}){return new Quaternion(t)};function Oi(t={}){(t=_e(t=Ve(t=We(t=Ge(t=ze(t=Ye(t))))))).defs=_(t.defs,{domElement:"",pitch:0,yaw:0,offsetZ:0,css:null,classes:"",position:"absolute",checkForResize:!1,trackHere:"",activePadding:5}),t.packetExclusions=Q(t.packetExclusions,["domElement","pathCorners","rotation"]),t.packetFunctions=Q(t.packetFunctions,["onEnter","onLeave","onDown","onUp"]),t.processDOMPacketOut=function(t,e,i){return this.processFactoryPacketOut(t,e,i)},t.processFactoryPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},t.finalizePacketOut=function(t,e){if(G(this.domElement)){let e=this.domElement,i=e.cloneNode(!0);i.querySelectorAll('[data-corner-div="sc"]').forEach(t=>i.removeChild(t)),t.outerHTML=i.outerHTML,t.host=e.parentElement.id}return t=this.handlePacketAnchor(t,e)},t.postCloneAction=function(t,e){return this.onEnter&&(t.onEnter=this.onEnter),this.onLeave&&(t.onLeave=this.onLeave),this.onDown&&(t.onDown=this.onDown),this.onUp&&(t.onUp=this.onUp),t};let e=t.setters,s=t.deltaSetters;e.trackHere=function(t){var e;J(t)&&(t?(Q(ne,this.name),"local"===t&&(U(e=this)&&(e.localMouseListener&&e.localMouseListener(),e.here||(e.here={}),e.here.originalWidth=e.currentDimensions[0],e.here.originalHeight=e.currentDimensions[1],e.localMouseListener=Lt("move",(function(t){e.here&&(e.here.x=Math.round(parseFloat(t.offsetX)),e.here.y=Math.round(parseFloat(t.offsetY)))}),e.domElement)))):(K(ne,this.name),function(t){U(t)&&(t.localMouseListener&&t.localMouseListener(),t.localMouseListener=!1)}(this)),this.trackHere=t)},e.position=function(t){this.position=t,this.dirtyPosition=!0},e.visibility=function(t){this.visibility=t,this.dirtyVisibility=!0},e.offsetZ=function(t){this.offsetZ=t,this.dirtyOffsetZ=!0},s.offsetZ=function(t){this.offsetZ+=t,this.dirtyOffsetZ=!0},e.roll=function(t){this.roll=this.checkRotationAngle(t),this.dirtyRotation=!0},s.roll=function(t){this.roll=this.checkRotationAngle(this.roll+t),this.dirtyRotation=!0},e.pitch=function(t){this.pitch=this.checkRotationAngle(t),this.dirtyRotation=!0},s.pitch=function(t){this.pitch=this.checkRotationAngle(this.pitch+t),this.dirtyRotation=!0},e.yaw=function(t){this.yaw=this.checkRotationAngle(t),this.dirtyRotation=!0},s.yaw=function(t){this.yaw=this.checkRotationAngle(this.yaw+t),this.dirtyRotation=!0},e.css=function(t){this.css=this.css?_(this.css,t):t,this.dirtyCss=!0},e.classes=function(t){this.classes=t,this.dirtyClasses=!0},e.domAttributes=function(t){this.updateDomAttributes(t)},t.checkRotationAngle=function(t){return(t<-180||t>180)&&(t+=t>0?-360:360),t},t.updateDomAttributes=function(t,e){if(this.domElement){let i=this.domElement;t.substring&&J(e)?e?i.setAttribute(t,e):i.removeAttribute(t):U(t)&&Object.entries(t).forEach(([t,e])=>{e?i.setAttribute(t,e):i.removeAttribute(t)})}return this},t.initializeDomLayout=function(t){let e=t.domElement,s=e.style;if(s.boxSizing="border-box",e&&t.setInitialDimensions){let n,r=e.getBoundingClientRect(),o=(e.style.transform,e.style.transformOrigin,!1);if(t&&t.host&&(o=t.host,o.substring&&i[o]&&(o=i[o])),this.currentDimensions[0]=r.width,this.currentDimensions[1]=r.height,t.width=r.width,t.height=r.height,e.className&&(t.classes=e.className),o&&o.domElement&&(n=o.domElement.getBoundingClientRect(),n&&(t.startX=r.left-n.left,t.startY=r.top-n.top)),"Stack"===this.type){J(t.perspective)||J(t.perspectiveZ)||(t.perspectiveZ=J(s.perspective)&&s.perspective?parseFloat(s.perspective):0);let e=s.perspectiveOrigin;e.length&&(e=e.split(" "),e.length>0&&!J(t.perspective)&&!J(t.perspectiveX)&&(t.perspectiveX=e[0]),J(t.perspective)||J(t.perspectiveY)||(e.length>1?t.perspectiveY=e[1]:t.perspectiveY=e[0]))}}},t.addClasses=function(t){if(t.substring){let e=this.classes;e+=" "+t,e=e.trim(),e=e.replace(/[\s\uFEFF\xA0]+/g," "),e!==this.classes&&(this.classes=e,this.dirtyClasses=!0)}return this},t.removeClasses=function(t){if(t.substring){let e,i=this.classes;t.split().forEach(t=>{e=new RegExp(" ?"+t+" ?"),i=i.replace(e," "),i=i.trim(),i=i.replace(/[\s\uFEFF\xA0]+/g," ")}),i!==this.classes&&(this.classes=i,this.dirtyClasses=!0)}return this},t.addPathCorners=function(){if(this.domElement&&!this.noUserInteraction){let t=function(){let t=document.createElement("div");return t.style.width=0,t.style.height=0,t.style.position="absolute",t},e=t(),i=t(),s=t(),n=t();e.style.top="0%",e.style.left="0%",e.setAttribute("data-corner-div","sc"),i.style.top="0%",i.style.left="100%",i.setAttribute("data-corner-div","sc"),s.style.top="100%",s.style.left="100%",s.setAttribute("data-corner-div","sc"),n.style.top="100%",n.style.left="0%",n.setAttribute("data-corner-div","sc");let r=this.domElement;r.appendChild(e),r.appendChild(i),r.appendChild(s),r.appendChild(n),this.pathCorners.push(e),this.pathCorners.push(i),this.pathCorners.push(s),this.pathCorners.push(n),this.currentCornersData||(this.currentCornersData=[])}return this},t.checkCornerPositions=function(t){let e=this.pathCorners;if(4===e.length){let i,s=this.getHere(),n=le.scrollX-(s.offsetX||0),r=le.scrollY-(s.offsetY||0),o=Math.round,a=[];const l=function(t){let e=t[0];e?(a.push(o(e.left+n)),a.push(o(e.top+r))):a.push(0,0)};switch(t){case"topLeft":return i=e[0].getClientRects(),l(i),a;case"topRight":return i=e[1].getClientRects(),l(i),a;case"bottomRight":return i=e[2].getClientRects(),l(i),a;case"bottomLeft":return i=e[3].getClientRects(),l(i),a;default:return e.forEach(t=>{G(t)&&(i=t.getClientRects(),l(i))}),a}}};const n=["topLeft","topRight","bottomRight","bottomLeft"];return t.getCornerCoordinate=function(t){return n.indexOf(t)>=0?this.checkCornerPositions(t):[].concat(this.currentStampPosition)},t.cleanPathObject=function(){if(this.dirtyPathObject=!1,this.domElement&&!this.noUserInteraction){this.pathCorners.length||this.addPathCorners(),this.currentCornersData||(this.currentCornersData=[]);let t=this.currentCornersData;t.length=0,t.push(...this.checkCornerPositions());let e=this.pathObject=new Path2D;e.moveTo(t[0],t[1]),e.lineTo(t[2],t[3]),e.lineTo(t[4],t[5]),e.lineTo(t[6],t[7]),e.closePath()}},t.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let i=Array.isArray(t)?t:[t],s=!1;e||(e=requestCell(),s=!0);let n,r,o=e.engine,a=this.currentStampPosition;a[0],a[1];return i.some(t=>{if(Array.isArray(t))n=t[0],r=t[1];else{if(!tt(t,t.x,t.y))return!1;n=t.x,r=t.y}return!(!n.toFixed||!r.toFixed||isNaN(n)||isNaN(r))&&o.isPointInPath(this.pathObject,n,r)},this)?(s&&releaseCell(e),{x:n,y:r,artefact:this}):(s&&releaseCell(e),!1)},t.cleanRotation=function(){this.dirtyRotation=!1,this.rotation&&q(this.rotation)||(this.rotation=Si()),this.currentRotation&&q(this.rotation)||(this.currentRotation=Si());let t=this.rotation;t.setFromEuler({pitch:this.pitch||0,yaw:this.yaw||0,roll:this.roll||0}),1!==t.getMagnitude()&&t.normalize();let e=bi(),i=this.path,s=this.mimic,n=this.pivot,r=this.lockTo;i&&r.indexOf("path")>=0?e.set(t):s&&this.useMimicRotation&&r.indexOf("mimic")>=0?J(s.currentRotation)?(e.set(s.currentRotation),this.addOwnRotationToMimic&&e.quaternionRotate(t)):this.dirtyMimicRotation=!0:(e.set(t),n&&this.addPivotRotation&&r.indexOf("pivot")>=0&&(J(n.currentRotation)?e.quaternionRotate(n.currentRotation):this.dirtyPivotRotation=!0)),this.currentRotation.set(e),ki(e),this.dirtyPositionSubscribers=!0,this.mimicked&&this.mimicked.length&&(this.dirtyMimicRotation=!0)},t.cleanOffsetZ=function(){this.dirtyOffsetZ=!1},t.cleanContent=function(){this.dirtyContent=!1,this.domElement&&(this.dirtyDimensions=!0)},t.cleanDisplayShape=B,t.cleanDisplayArea=B,t.prepareStamp=function(){(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle||this.dirtyRotation)&&(this.dirtyPathObject=!0),this.dirtyContent&&this.cleanContent(),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyDisplayArea&&this.cleanDisplayArea(),this.dirtyDisplayShape&&this.cleanDisplayShape(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyOffsetZ&&this.cleanOffsetZ(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.pivoted.length&&(this.dirtyStampPositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyPathObject&&this.cleanPathObject()},t.stamp=function(){let t=this;return new Promise((e,i)=>{t.domElement||i(!1);let s,n,r,o,a,[l,h]=t.currentStampPosition,[c,u]=t.currentStampHandlePosition,d=t.currentScale,f=t.currentRotation,p=`${c}px ${u}px 0`,m=`translate(${l-c}px,${h-u}px)`;(t.yaw||t.pitch||t.roll||t.pivot&&t.addPivotRotation||t.mimic&&t.useMimicRotation||t.path&&t.addPathRotation)&&(s=f.v,n=s.x,r=s.y,o=s.z,a=f.getAngle(!1),m+=` rotate3d(${n},${r},${o},${a}rad)`),t.offsetZ&&(m+=` translateZ(${t.offsetZ}px)`),1!==d&&(m+=` scale(${d},${d})`),m!==t.currentTransformString&&(t.currentTransformString=m,t.dirtyTransform=!0),p!==t.currentTransformOriginString&&(t.currentTransformOriginString=p,t.dirtyTransformOrigin=!0),(t.dirtyTransform||t.dirtyPerspective||t.dirtyPosition||t.dirtyDomDimensions||t.dirtyTransformOrigin||t.dirtyVisibility||t.dirtyCss||t.dirtyClasses||t.domShowRequired)&&(Ki(t.name),ts(!0)),t.dirtyPositionSubscribers&&t.updatePositionSubscribers(),(t.dirtyMimicRotation||t.dirtyPivotRotation)&&(t.dirtyMimicRotation=!1,t.dirtyPivotRotation=!1,t.dirtyRotation=!0),t.dirtyMimicScale&&(t.dirtyMimicScale=!1,t.dirtyScale=!0),e(!0)})},t.apply=function(){be(),this.prepareStamp();let t=this;this.stamp().then(()=>{es(t.name),t.dirtyPathObject=!0,t.cleanPathObject()}).catch(t=>console.log(t))},t}function Pi(t={}){let e={breakToBanner:3,breakToLandscape:1.5,breakToPortrait:.65,breakToSkyscraper:.35,actionBannerShape:null,actionLandscapeShape:null,actionRectangleShape:null,actionPortraitShape:null,actionSkyscraperShape:null,breakToSmallest:2e4,breakToSmaller:8e4,breakToLarger:18e4,breakToLargest:32e4,actionSmallestArea:null,actionSmallerArea:null,actionRegularArea:null,actionLargerArea:null,actionLargestArea:null};t.defs=_(t.defs,e),_(t,e),t.packetFunctions=Q(t.packetFunctions,["actionBannerShape","actionLandscapeShape","actionRectangleShape","actionPortraitShape","actionSkyscraperShape"]);let i=t.getters,s=t.setters;return i.displayShape=function(){return this.currentDisplayShape},i.displayShapeBreakpoints=function(){return{breakToBanner:this.breakToBanner,breakToLandscape:this.breakToLandscape,breakToPortrait:this.breakToPortrait,breakToSkyscraper:this.breakToSkyscraper,breakToSmallest:this.breakToSmallest,breakToSmaller:this.breakToSmaller,breakToLarger:this.breakToLarger,breakToLargest:this.breakToLargest}},s.displayShapeBreakpoints=function(t={}){for(let[e,i]of Object.entries(t))if(V(i))switch(e){case"breakToBanner":this.breakToBanner=i;break;case"breakToLandscape":this.breakToLandscape=i;break;case"breakToPortrait":this.breakToPortrait=i;break;case"breakToSkyscraper":this.breakToSkyscraper=i;break;case"breakToSmallest":this.breakToSmallest=i;break;case"breakToSmaller":this.breakToSmaller=i;break;case"breakToLarger":this.breakToLarger=i;break;case"breakToLargest":this.breakToLargest=i}this.dirtyDisplayShape=!0,this.dirtyDisplayArea=!0},t.setDisplayShapeBreakpoints=s.displayShapeBreakpoints,s.breakToBanner=function(t){V(t)&&(this.breakToBanner=t),this.dirtyDisplayShape=!0},s.breakToLandscape=function(t){V(t)&&(this.breakToLandscape=t),this.dirtyDisplayShape=!0},s.breakToPortrait=function(t){V(t)&&(this.breakToPortrait=t),this.dirtyDisplayShape=!0},s.breakToSkyscraper=function(t){V(t)&&(this.breakToSkyscraper=t),this.dirtyDisplayShape=!0},s.breakToSmallest=function(t){V(t)&&(this.breakToSmallest=t),this.dirtyDisplayArea=!0},s.breakToSmaller=function(t){V(t)&&(this.breakToSmaller=t),this.dirtyDisplayArea=!0},s.breakToLarger=function(t){V(t)&&(this.breakToLarger=t),this.dirtyDisplayArea=!0},s.breakToLargest=function(t){V(t)&&(this.breakToLargest=t),this.dirtyDisplayArea=!0},s.actionBannerShape=function(t){W(t)&&(this.actionBannerShape=t),this.dirtyDisplayShape=!0},t.setActionBannerShape=s.actionBannerShape,s.actionLandscapeShape=function(t){W(t)&&(this.actionLandscapeShape=t),this.dirtyDisplayShape=!0},t.setActionLandscapeShape=s.actionLandscapeShape,s.actionRectangleShape=function(t){W(t)&&(this.actionRectangleShape=t),this.dirtyDisplayShape=!0},t.setActionRectangleShape=s.actionRectangleShape,s.actionPortraitShape=function(t){W(t)&&(this.actionPortraitShape=t),this.dirtyDisplayShape=!0},t.setActionPortraitShape=s.actionPortraitShape,s.actionSkyscraperShape=function(t){W(t)&&(this.actionSkyscraperShape=t),this.dirtyDisplayShape=!0},t.setActionSkyscraperShape=s.actionSkyscraperShape,s.actionSmallestArea=function(t){W(t)&&(this.actionSmallestArea=t),this.dirtyDisplayArea=!0},t.setActionSmallestArea=s.actionSmallestArea,s.actionSmallerArea=function(t){W(t)&&(this.actionSmallerArea=t),this.dirtyDisplayArea=!0},t.setActionSmallerArea=s.actionSmallerArea,s.actionRegularArea=function(t){W(t)&&(this.actionRegularArea=t),this.dirtyDisplayArea=!0},t.setActionRegularArea=s.actionRegularArea,s.actionLargerArea=function(t){W(t)&&(this.actionLargerArea=t),this.dirtyDisplayArea=!0},t.setActionLargerArea=s.actionLargerArea,s.actionLargestArea=function(t){W(t)&&(this.actionLargestArea=t),this.dirtyDisplayArea=!0},t.setActionLargestArea=s.actionLargestArea,t.initializeDisplayShapeActions=function(){this.actionBannerShape=B,this.actionLandscapeShape=B,this.actionRectangleShape=B,this.actionPortraitShape=B,this.actionSkyscraperShape=B,this.currentDisplayShape="",this.dirtyDisplayShape=!0,this.actionSmallestArea=B,this.actionSmallerArea=B,this.actionRegularArea=B,this.actionLargerArea=B,this.actionLargestArea=B,this.currentDisplayArea="",this.dirtyDisplayArea=!0},t.cleanDisplayShape=function(){this.dirtyDisplayShape=!1;let[t,e]=this.currentDimensions;if(t>0&&e>0){let i=t/e,s=this.currentDisplayShape,n=this.breakToBanner,r=this.breakToLandscape,o=this.breakToPortrait,a=this.breakToSkyscraper;return i>n?"banner"!==s&&(this.currentDisplayShape="banner",this.actionBannerShape(),!0):i>r?"landscape"!==s&&(this.currentDisplayShape="landscape",this.actionLandscapeShape(),!0):i<a?"skyscraper"!==s&&(this.currentDisplayShape="skyscraper",this.actionSkyscraperShape(),!0):i<o?"portrait"!==s&&(this.currentDisplayShape="portrait",this.actionPortraitShape(),!0):"rectangle"!==s&&(this.currentDisplayShape="rectangle",this.actionRectangleShape(),!0)}return this.dirtyDisplayShape=!0,!1},t.cleanDisplayArea=function(){this.dirtyDisplayArea=!1;let[t,e]=this.currentDimensions;if(t>0&&e>0){let i=t*e,s=this.currentDisplayArea,n=this.breakToLargest,r=this.breakToLarger,o=this.breakToSmaller,a=this.breakToSmallest;return i>n?"largest"!==s&&(this.currentDisplayArea="largest",this.actionLargestArea(),!0):i>r?"larger"!==s&&(this.currentDisplayArea="larger",this.actionLargerArea(),!0):i<a?"smallest"!==s&&(this.currentDisplayArea="smallest",this.actionSmallestArea(),!0):i<o?"smaller"!==s&&(this.currentDisplayArea="smaller",this.actionSmallerArea(),!0):"regular"!==s&&(this.currentDisplayArea="regular",this.actionRegularArea(),!0)}return this.dirtyDisplayArea=!0,!1},t.updateDisplayShape=function(){this.currentDisplayShape="",this.dirtyDisplayShape=!0},t.updateDisplayArea=function(){this.currentDisplayArea="",this.dirtyDisplayArea=!0},t.updateDisplay=function(){this.updateDisplayShape(),this.updateDisplayArea()},t}O.Quaternion=Quaternion;const Canvas=function(t={}){let e;if(this.makeName(t.name),this.register(),this.initializePositions(),this.dimensions[0]=300,this.dimensions[1]=150,this.pathCorners=[],this.css={},this.here={},this.perspective={x:"50%",y:"50%",z:0},this.dirtyPerspective=!0,this.initializeDomLayout(t),this.set(this.defs),t.label||(t.label=this.name+" canvas element"),this.initializeDisplayShapeActions(),this.set(t),this.cleanDimensions(),e=this.domElement,e){this.engine=this.domElement.getContext("2d"),this.state=De({engine:this.engine}),this.cells=[],this.cellBatchesClear=[],this.cellBatchesCompile=[],this.cellBatchesShow=[];let t={name:this.name+"_base",element:!1,width:this.currentDimensions[0],height:this.currentDimensions[1],cleared:!0,compiled:!0,shown:!1,isBase:!0,host:this.name,controller:this,order:10};this.base=this.buildCell(t),Q(Bi,this.name),Li(),e.getAttribute("role")||e.setAttribute("role","img");let i=document.createElement("nav");i.id=this.name+"-navigation",i.style.width="0px",i.style.height="0px",i.style.maxWidth="0px",i.style.maxHeight="0px",i.style.border="0px",i.style.padding="0px",i.style.margin="0px",i.style.overflow="hidden",this.navigation=i,e.appendChild(i);let s=document.createElement("div");s.id=this.name+"-text-hold",s.style.width="0px",s.style.height="0px",s.style.maxWidth="0px",s.style.maxHeight="0px",s.style.border="0px",s.style.padding="0px",s.style.margin="0px",s.style.overflow="hidden",this.textHold=s,e.appendChild(s);let n=document.createElement("div");n.id=this.name+"-ARIA-label",n.textContent=this.label,this.ariaLabelElement=n,is.appendChild(n),e.setAttribute("aria-labelledby",n.id),e.setAttribute("aria-live","polite");let r=document.createElement("div");r.id=this.name+"-ARIA-description",r.textContent=this.description,this.ariaDescriptionElement=r,is.appendChild(r),e.setAttribute("aria-describedby",r.id),e.setAttribute("aria-live","polite"),this.cleanAria()}return this.dirtyCells=!0,this.apply(),this.dirtyDomDimensions=!0,t.setAsCurrentCanvas&&this.setAsCurrentCanvas(),this};let vi=Canvas.prototype=Object.create(Object.prototype);vi.type="Canvas",vi.lib="canvas",vi.isArtefact=!0,vi.isAsset=!1,vi=ee(vi),vi=Oi(vi),vi=Pi(vi);vi.defs=_(vi.defs,{position:"relative",trackHere:"subscribe",fit:"none",isComponent:!1,renderOnResize:!0,title:"",label:"",description:""}),vi.stringifyFunction=B,vi.processPacketOut=B,vi.finalizePacketOut=B,vi.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},vi.clone=$,vi.factoryKill=function(){let t,e,s=this.name,n=this.host;K(Bi,s),Li(),K(ne,s),n&&"root"!==n&&(t=this.currentHost?this.currentHost:i[n],t&&(t.removeGroups(s),e=u[t.name],e&&e.removeArtefacts(s))),u[s]&&u[s].kill(),this.base.kill(),this.navigation.remove(),this.textHold.remove(),this.ariaLabelElement.remove(),this.ariaDescriptionElement.remove(),this.domElement.remove()};let wi=vi.getters,xi=vi.setters,Ai=vi.deltaSetters;vi.fitDefaults=["fill","contain","cover"],xi.fit=function(t){this.fit=this.fitDefaults.indexOf(t)>=0?t:"none"},xi.title=function(t){this.title=t,this.dirtyAria=!0},xi.label=function(t){this.label=t,this.dirtyAria=!0},xi.description=function(t){this.description=t,this.dirtyAria=!0},wi.backgroundColor=function(){return this.base.backgroundColor},xi.backgroundColor=function(t){this.base&&this.base.set({backgroundColor:t})},wi.alpha=function(){return this.base.alpha},xi.alpha=function(t){this.base&&this.base.set({alpha:t})},Ai.alpha=function(t){this.base&&this.base.deltaSet({alpha:t})},wi.composite=function(){return this.base.composite},xi.composite=function(t){this.base&&this.base.set({composite:t})},vi.setAsCurrentCanvas=function(){return this.base&&Wi(this),this},vi.setBase=function(t){return this.base&&(this.base.set(t),this.setBaseHelper()),this},vi.deltaSetBase=function(t){return this.base&&(this.base.deltaSet(t),this.setBaseHelper()),this},vi.updateBaseHere=function(){this.base&&this.base.updateBaseHere(this.here,this.fit)},vi.setBaseHelper=function(){let t={};this.base.dirtyScale&&(t.dirtyScale=!0),this.base.dirtyDimensions&&(t.dirtyDimensions=!0),this.base.dirtyLock&&(t.dirtyLock=!0),this.base.dirtyStart&&(t.dirtyStart=!0),this.base.dirtyOffset&&(t.dirtyOffset=!0),this.base.dirtyHandle&&(t.dirtyHandle=!0),this.base.dirtyRotation&&(t.dirtyRotation=!0),this.cleanCells(),this.base.prepareStamp(),this.updateCells(t)},vi.updateCells=function(t={}){this.cells.forEach(e=>{let i=a[e];i&&(t.dirtyScale&&(i.dirtyScale=!0),t.dirtyDimensions&&(i.dirtyDimensions=!0),t.dirtyLock&&(i.dirtyLock=!0),t.dirtyStart&&(i.dirtyStart=!0),t.dirtyOffset&&(i.dirtyOffset=!0),t.dirtyHandle&&(i.dirtyHandle=!0),t.dirtyRotation&&(i.dirtyRotation=!0))})},vi.buildCell=function(t={}){t.host||!1||(t.host=this.base.name);let e=oi(t);return this.addCell(e),this.cleanCells(),e},vi.cleanDimensionsAdditionalActions=function(){this.cells&&this.updateCells({dirtyDimensions:!0}),this.dirtyDomDimensions=!0,this.dirtyDisplayShape=!0,this.dirtyDisplayArea=!0},vi.addCell=function(t){return(t=t.substring?t:t.name||!1)&&(Q(this.cells,t),a[t].prepareStamp(),this.dirtyCells=!0),t},vi.removeCell=function(t){return(t=t.substring?t:t.name||!1)&&(K(this.cells,t),this.dirtyCells=!0),this},vi.killCell=function(t){let e=t.substring?a[t]:t;return e&&e.kill(),this.dirtyCells=!0,this},vi.clear=function(){let t=this;t.dirtyCells&&t.cleanCells();let e=i=>new Promise((s,n)=>{let r=t.cellBatchesClear[i];r?r.clear().then(t=>{e(i+1).then(t=>s(!0)).catch(t=>n(t))}).catch(t=>n(t)):s(!0)});return e(0)},vi.compile=function(){let t=this;t.dirtyCells&&t.cleanCells();let e=i=>new Promise((s,n)=>{let r=t.cellBatchesCompile[i];r?r.compile().then(t=>{e(i+1).then(t=>s(!0)).catch(t=>n(t))}).catch(t=>n(t)):(t.prepareStamp(),t.stamp().then(t=>s(!0)).catch(t=>n(t)))});return e(0)},vi.show=function(){let t=this;t.dirtyCells&&t.cleanCells();let e=i=>new Promise((s,n)=>{let r=t.cellBatchesShow[i];r?r.show().then(t=>{e(i+1).then(t=>s(!0)).catch(t=>n(t))}).catch(t=>n(t)):(t.engine.clearRect(0,0,t.localWidth,t.localHeight),t.base.show().then(t=>{es(),this.dirtyAria&&this.cleanAria(),s(!0)}).catch(t=>n(t)))});return e(0)},vi.render=function(){let t=this;return new Promise(e=>{t.clear().then(()=>t.compile()).then(()=>t.show()).then(()=>e(!0)).catch(()=>e(!1))})},vi.cleanCells=function(){this.dirtyCells=!1;let t,e=[],i=[],s=[];this.cells.forEach(n=>{let r=a[n];r&&(r.cleared&&e.push(r),r.compiled&&(t=r.compileOrder,i[t]||(i[t]=[]),i[t].push(r)),r.shown&&(t=r.showOrder,s[t]||(s[t]=[]),s[t].push(r)))}),this.cellBatchesClear=[].concat(e),this.cellBatchesCompile=i.reduce((t,e)=>t.concat(e),[]),this.cellBatchesShow=s.reduce((t,e)=>t.concat(e),[])},vi.cascadeEventAction=function(t){this.currentActiveEntityNames||(this.currentActiveEntityNames=[]);let e=this.currentActiveEntityNames,s=[],n=[],r=[],o=[],l=[],h=[];this.cells.forEach(t=>{let e=a[t];e&&(e.shown||e.isBase)&&s.push(e.getEntityHits())}),s=s.reduce((t,e)=>t.concat(e),[]),s.forEach(t=>{let i=t.name;n.indexOf(i)<0&&(n.push(i),e.indexOf(i)<0?(r.push(t),o.push(i)):(l.push(t),h.push(i)))});let c=r.concat(l),u=function(){e.length&&(o.forEach(t=>K(e,t)),h.forEach(t=>K(e,t)),e.forEach(t=>{let e=i[t];e&&e.onLeave()}))};switch(t){case"down":c.forEach(t=>t.onDown());break;case"up":c.forEach(t=>t.onUp());break;case"enter":r.forEach(t=>t.onEnter());break;case"leave":u();break;case"move":u(),r.forEach(t=>t.onEnter())}return this.currentActiveEntityNames=o.concat(h),this.currentActiveEntityNames},vi.cleanAria=function(){this.dirtyAria=!1,this.domElement.setAttribute("title",this.title),this.ariaLabelElement.textContent=this.label,this.ariaDescriptionElement.textContent=this.description};const Ci=function(t){return new Canvas(t)};O.Canvas=Canvas;const Element=function(t={}){let e=t.domElement;return this.makeName(t.name),this.register(),e&&(t.text?e.textContent=t.text:t.content&&(e.innerHTML=t.content)),this.initializePositions(),this.dimensions[0]=this.dimensions[1]=100,this.pathCorners=[],this.css={},this.here={},this.initializeDomLayout(t),this.set(this.defs),this.set(t),e=this.domElement,e&&(e.id=this.name),this.apply(),this};let Di=Element.prototype=Object.create(Object.prototype);Di.type="Element",Di.lib="element",Di.isArtefact=!0,Di.isAsset=!1,Di=ee(Di),Di=Oi(Di),Di.factoryKill=function(){K(ne,this.name),this.domElement.remove()};let Ri=Di.setters;Ri.text=function(t){if(G(this.domElement)){let e=this.domElement,i=e.querySelectorAll('[data-corner-div="sc"]');e.textContent=t,i.forEach(t=>e.appendChild(t)),this.dirtyContent=!0}},Ri.content=function(t){if(this.domElement){let e=this.domElement,i=e.querySelectorAll('[data-corner-div="sc"]');e.innerHTML=t,i.forEach(t=>e.appendChild(t)),this.dirtyContent=!0}},Di.cleanDimensionsAdditionalActions=function(){this.dirtyDomDimensions=!0},Di.addCanvas=function(t={}){if(!this.canvas){let e=document.createElement("canvas"),i=this.domElement,s=i.getBoundingClientRect();window.getComputedStyle(i);i.parentNode.insertBefore(e,this.domElement);let n=Ci({name:this.name+"-canvas",domElement:e,position:"absolute",width:s.width,height:s.height,mimic:this.name,lockTo:"mimic",useMimicDimensions:!0,useMimicScale:!0,useMimicStart:!0,useMimicHandle:!0,useMimicOffset:!0,useMimicRotation:!0,addOwnDimensionsToMimic:!1,addOwnScaleToMimic:!1,addOwnStartToMimic:!1,addOwnHandleToMimic:!1,addOwnOffsetToMimic:!1,addOwnRotationToMimic:!1});return n.set(t),this.canvas=n,n}};const Ei=function(t){return new Element(t)};O.Element=Element;const Stack=function(t={}){let e,i;return this.makeName(t.name),this.register(),this.initializePositions(),this.initializeCascade(),this.dimensions[0]=300,this.dimensions[1]=150,this.pathCorners=[],this.css={},this.here={},this.perspective={x:"50%",y:"50%",z:0},this.dirtyPerspective=!0,this.initializeDomLayout(t),e=ci({name:this.name,host:this.name}),this.addGroups(e.name),this.set(this.defs),this.initializeDisplayShapeActions(),this.set(t),i=this.domElement,i&&"root"===i.getAttribute("data-group")&&(Q(Bi,this.name),Li()),this};let Fi=Stack.prototype=Object.create(Object.prototype);Fi.type="Stack",Fi.lib="stack",Fi.isArtefact=!0,Fi.isAsset=!1,Fi=ee(Fi),Fi=Ze(Fi),Fi=Oi(Fi),Fi=Pi(Fi);Fi.defs=_(Fi.defs,{position:"relative",perspective:null,trackHere:"subscribe",isResponsive:!1,containElementsInHeight:!1}),Fi.stringifyFunction=B,Fi.processPacketOut=B,Fi.finalizePacketOut=B,Fi.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},Fi.clone=$,Fi.factoryKill=function(){let t=this.name;K(Bi,t),Li(),K(ne,t),u[t]&&u[t].kill(),Object.entries(i).forEach(([e,i])=>{i.host===t&&i.kill()}),this.domElement.remove()};let Ti=Fi.getters,Hi=Fi.setters,Mi=Fi.deltaSetters;Ti.perspectiveX=function(){return this.perspective.x},Ti.perspectiveY=function(){return this.perspective.y},Ti.perspectiveZ=function(){return this.perspective.z},Hi.perspectiveX=function(t){this.perspective.x=t,this.dirtyPerspective=!0},Hi.perspectiveY=function(t){this.perspective.y=t,this.dirtyPerspective=!0},Hi.perspectiveZ=function(t){this.perspective.z=t,this.dirtyPerspective=!0},Hi.perspective=function(t={}){this.perspective.x=J(t.x)?t.x:this.perspective.x,this.perspective.y=J(t.y)?t.y:this.perspective.y,this.perspective.z=J(t.z)?t.z:this.perspective.z,this.dirtyPerspective=!0},Mi.perspectiveX=function(t){this.perspective.x=H(this.perspective.x,t),this.dirtyPerspective=!0},Mi.perspectiveY=function(t){this.perspective.y=H(this.perspective.y,t),this.dirtyPerspective=!0},Fi.updateArtefacts=function(t={}){this.groupBuckets.forEach(e=>{e.artefactBuckets.forEach(e=>{t.dirtyScale&&(e.dirtyScale=!0),t.dirtyDimensions&&(e.dirtyDimensions=!0),t.dirtyLock&&(e.dirtyLock=!0),t.dirtyStart&&(e.dirtyStart=!0),t.dirtyOffset&&(e.dirtyOffset=!0),t.dirtyHandle&&(e.dirtyHandle=!0),t.dirtyRotation&&(e.dirtyRotation=!0),t.dirtyPathObject&&(e.dirtyPathObject=!0)})})},Fi.cleanDimensionsAdditionalActions=function(){this.groupBuckets&&this.updateArtefacts({dirtyDimensions:!0,dirtyPath:!0,dirtyStart:!0,dirtyHandle:!0}),this.dirtyDomDimensions=!0,this.dirtyPath=!0,this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyDisplayShape=!0,this.dirtyDisplayArea=!0},Fi.cleanPerspective=function(){this.dirtyPerspective=!1;let t=this.perspective;this.domPerspectiveString=`perspective-origin: ${t.x} ${t.y}; perspective: ${t.z}px;`,this.domShowRequired=!0,this.groupBuckets&&this.updateArtefacts({dirtyHandle:!0,dirtyPathObject:!0})},Fi.checkResponsive=function(){this.isResponsive&&this.trackHere&&(this.currentVportWidth||(this.currentVportWidth=le.w),this.currentVportHeight||(this.currentVportHeight=le.h),this.dirtyHeight&&this.containElementsInHeight&&(console.log("stack height final fixes need to be done"),this.dirtyHeight=!1),this.currentVportWidth!==le.w&&(console.log("need to update for resized viewport width"),this.currentVportWidth=le.w,this.containElementsInHeight&&(this.dirtyHeight=!0)),this.currentVportHeight!==le.h&&(console.log("need to update for resized viewport height"),this.currentVportHeight=le.h))},Fi.clear=function(){return this.checkResponsive(),Promise.resolve(!0)},Fi.compile=function(){let t=this;return new Promise((e,i)=>{t.sortGroups(),t.prepareStamp(),t.stamp().then(()=>{let e=[];return t.groupBuckets.forEach(t=>e.push(t.stamp())),Promise.all(e)}).then(()=>e(!0)).catch(t=>i(!1))})},Fi.show=function(){return new Promise(t=>{es(),t(!0)})},Fi.render=function(){let t=this;return new Promise((e,i)=>{t.compile().then(()=>t.show()).then(()=>e(!0)).catch(t=>i(!1))})},Fi.addExistingDomElements=function(t){let e,i,s,n,r;if(J(t))for(e=t.substring?document.querySelectorAll(t):[].concat(t),n=0,r=e.length;n<r;n++)i=e[n],G(i)&&(s=Ei({name:i.id||i.name,domElement:i,group:this.name,host:this.name,position:"absolute",setInitialDimensions:!0}),s&&s.domElement&&this.domElement.appendChild(s.domElement));return this},Fi.addNewElement=function(t={}){if(t.tag){t.domElement=document.createElement(t.tag),t.domElement.setAttribute("data-group",this.name),J(t.group)||(t.group=this.name),t.host=this.name,t.position||(t.position="absolute"),J(t.width)||(t.width=100),J(t.height)||(t.height=100);let e=Ei(t);return e&&e.domElement&&(J(t.boxSizing)||(e.domElement.style.boxSizing="border-box"),this.domElement.appendChild(e.domElement)),e}return!1};const Ii=function(t){return new Stack(t)};O.Stack=Stack;let Bi=[],Li=()=>{ji=!0},$i=[],ji=!0;const Ni=function(t){let e=t.getAttribute("data-group"),i=t.id||t.getAttribute("name"),s="absolute";e||(t.setAttribute("data-group","root"),e="root",s="relative"),i||(i=N(),t.id=i);let n=Ii({name:i,domElement:t,group:e,host:e,position:s,setInitialDimensions:!0});return Xi(t,i),n},Xi=function(t,e){let i=t.getBoundingClientRect(),s=0;Array.from(t.children).forEach(t=>{if(null!=t.getAttribute("data-stack")||z(t)||"SCRIPT"===t.tagName)t.setAttribute("data-group",e);else{let n=t.getBoundingClientRect(),r=window.getComputedStyle(t),o=parseFloat(r.marginTop)+parseFloat(r.borderTopWidth)+parseFloat(r.paddingTop)+parseFloat(r.paddingBottom)+parseFloat(r.borderBottomWidth)+parseFloat(r.marginBottom);s=s||n.top-i.top;let a={name:t.id||t.getAttribute("name"),domElement:t,group:e,host:e,position:"absolute",width:n.width,height:n.height,startX:n.left-i.left,startY:s,classes:t.className?t.className:""};s+=o+n.height,Ei(a)}})},Yi=function(t){let e=t.getAttribute("data-group"),i=t.id||t.getAttribute("name"),s="absolute";return e||(t.setAttribute("data-group","root"),e="root",s=t.style.position),i||(i=N(),t.id=i),Ci({name:i,domElement:t,group:e,host:e,position:s,setInitialDimensions:!0})};let zi=null,Gi=null;const Wi=function(t){let e=!1;if(t)if(t.substring){let i=o[t];i&&(zi=i,e=!0)}else"Canvas"===t.type&&(zi=t,e=!0);if(e&&zi.base){let t=u[zi.base.name];t&&(Gi=t)}},Vi=function(...t){return _i(t),Zi("clear")},Ui=function(...t){return _i(t),Zi("compile")},qi=function(...t){return _i(t),Zi("show")},_i=function(t){t.length?$i=t:ji&&function(){let t=Math.floor;if(ji){ji=!1;let e,s,n=[];Bi.forEach(r=>{e=i[r],e&&(s=t(e.order)||0,n[s]||(n[s]=[]),n[s].push(e.name))}),$i=n.reduce((t,e)=>t.concat(e),[])}}()},Zi=function(t){return new Promise((e,s)=>{let n,r=[];$i.forEach(e=>{n=i[e],n&&n[t]&&r.push(n[t]())}),Promise.all(r).then(()=>e(!0)).catch(t=>s(t))})},Qi=[],Ki=function(t=""){if(!t)throw new Error("core/document addDomShowElement() error - false argument supplied: "+t);if(!t.substring)throw new Error("core/document addDomShowElement() error - argument not a string: "+t);Q(Qi,t)};let Ji=!1;const ts=function(t=!0){Ji=t},es=function(t=""){if(Ji||t){let e,s,n,r,o,a,l,h,c,u,d,f,p,m,g,y,b,k;for(t?e=[t]:(Ji=!1,e=[].concat(Qi),Qi.length=0),s=0,n=e.length;s<n;s++){if(r=e[s],o=i[r],!o)throw new Error("core/document domShow() error - artefact missing: "+r);if(a=o.domElement,!a)throw new Error("core/document domShow() error - DOM element missing: "+r);if(l=a.style,o.dirtyPerspective&&(o.dirtyPerspective=!1,h=o.perspective,l.perspectiveOrigin=`${h.x} ${h.y}`,l.perspective=h.z+"px"),o.dirtyPosition&&(o.dirtyPosition=!1,l.position=o.position),o.dirtyDomDimensions&&(o.dirtyDomDimensions=!1,c=o.currentDimensions,u=c[0],d=c[1],"Canvas"===o.type?(a.width=u,a.height=d,o.renderOnResize&&o.render().catch(t=>console.log(t))):(l.width=u+"px",l.height=d?d+"px":"auto")),o.dirtyTransformOrigin&&(o.dirtyTransformOrigin=!1,l.transformOrigin=o.currentTransformOriginString),o.dirtyTransform&&(o.dirtyTransform=!1,l.transform=o.currentTransformString),o.dirtyVisibility&&(o.dirtyVisibility=!1,l.display=o.visibility?"block":"none"),o.dirtyCss)for(o.dirtyCss=!1,m=o.css||{},g=Object.keys(m),f=0,p=g.length;f<p;f++)y=g[f],k=m[y],w.has(y)?(b=`${y[0].toUpperCase}${y.substr(1)}`,l["webkit"+b]=k,l["moz"+b]=k,l["ms"+b]=k,l["o"+b]=k,l[y]=k):v.has(y)&&(l[y]=k);o.dirtyClasses&&(o.dirtyClasses=!1,a.className.substring&&(a.className=o.classes))}}};let is=document.createElement("div");is.style.padding=0,is.style.border=0,is.style.margin=0,is.style.width="4500px",is.style.boxSizing="border-box",is.style.position="absolute",is.style.top="-5000px",is.style.left="-5000px",is.id="Scrawl-ARIA-default-hold",document.body.appendChild(is);let ss=document.createElement("nav");ss.style.position="absolute",ss.style.top="-5000px",ss.style.left="-5000px",ss.id="Scrawl-navigation-default-hold",document.body.prepend(ss);const RenderAnimation=function(t={}){let e;if(t.target){if(Array.isArray(t.target)){let e=[];return t.target.forEach(i=>{let s=Object.assign({},t);s.name=`${s.name}_${i.name}`,s.target=i,e.push(new RenderAnimation(s))}),e}e=t.target.substring?i[t.target]:t.target}else e={clear:Vi,compile:Ui,show:qi};if(!(e&&e.clear&&e.compile&&e.show))return!1;this.makeName(t.name),this.order=J(t.order)?t.order:this.defs.order,this.onRun=t.onRun||B,this.onHalt=t.onHalt||B,this.onKill=t.onKill||B,this.target=e,this.commence=t.commence||B,this.afterClear=t.afterClear||B,this.afterCompile=t.afterCompile||B,this.afterShow=t.afterShow||B,this.afterCreated=t.afterCreated||B,this.error=t.error||B,this.readyToInitialize=!0;let s=this;return this.fn=function(){return new Promise((t,e)=>{Promise.resolve(s.commence()).then(()=>s.target.clear()).then(()=>Promise.resolve(s.afterClear())).then(()=>s.target.compile()).then(()=>Promise.resolve(s.afterCompile())).then(()=>s.target.show()).then(()=>Promise.resolve(s.afterShow())).then(()=>{s.readyToInitialize&&(s.afterCreated(),s.readyToInitialize=!1),t(!0)}).catch(t=>{s.error(t),e(t)})})},this.register(),t.observer&&(this.observer=Bt(this,this.target)),t.delay||this.run(),this};let ns=RenderAnimation.prototype=Object.create(Object.prototype);ns.type="RenderAnimation",ns.lib="animation",ns.isArtefact=!1,ns.isAsset=!1,ns=ee(ns);ns.defs=_(ns.defs,{order:1,onRun:null,onHalt:null,onKill:null,commence:null,afterClear:null,afterCompile:null,afterShow:null,afterCreated:null,error:null,target:null}),ns.stringifyFunction=B,ns.processPacketOut=B,ns.finalizePacketOut=B,ns.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},ns.clone=$,ns.kill=function(){return this.onKill(),K(R,this.name),E(),this.deregister(),!0},ns.run=function(){return this.onRun(),Q(R,this.name),E(),this},ns.isRunning=function(){return R.indexOf(this.name)>=0},ns.halt=function(){return this.onHalt(),K(R,this.name),E(),this};const rs=function(t){return new RenderAnimation(t)};O.RenderAnimation=RenderAnimation;const UnstackedElement=function(t){let e=t.id||t.name;return this.makeName(e),this.register(),t.setAttribute("data-scrawl-name",this.name),this.domElement=t,this.elementComputedStyles=window.getComputedStyle(t),this.hostStyles={},this.canvasStartX=0,this.canvasStartY=0,this.canvasWidth=0,this.canvasHeight=0,this.canvasZIndex=0,this};let os=UnstackedElement.prototype=Object.create(Object.prototype);os.type="UnstackedElement",os.lib="unstackedelement",os.isArtefact=!1,os.isAsset=!1,os=ee(os);os.defs=_(os.defs,{canvasOnTop:!1});os.getters,os.setters,os.deltaSetters;os.demolish=function(t=!1){return!0},os.addCanvas=function(t={}){if(!this.canvas){let e=document.createElement("canvas"),i=this.domElement,s=i.style;"static"===s.position&&(s.position="relative"),i.prepend(e);let n=Ci({name:this.name+"-canvas",domElement:e,position:"absolute"});return this.canvas=n,n.set(t),this.updateCanvas(),n}},os.includedStyles=["width","height","zIndex","borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius"],os.mimickedStyles=["borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius"],os.checkElementStyleValues=function(){let t={},e=this.domElement,i=this.canvas;if(e&&i&&i.domElement){let s=this.hostStyles,n=this.elementComputedStyles,r=i.domElement,o=this.includedStyles,a=Math.max,{x:l,y:h,width:c,height:u}=e.getBoundingClientRect(),{x:d,y:f}=r.getBoundingClientRect();o.forEach(e=>{switch(e){case"width":let i=a(parseFloat(n.width),c);this.canvasWidth!==i&&(this.canvasWidth=i,this.dirtyDimensions=!0);break;case"height":let r=a(parseFloat(n.height),u);this.canvasHeight!==r&&(this.canvasHeight=r,this.dirtyDimensions=!0);break;case"zIndex":let o="auto"===n.zIndex?0:parseInt(n.zIndex,10);o=this.canvasOnTop?o+1:o-1,this.canvasZIndex!==o&&(this.canvasZIndex=o,this.dirtyZIndex=!0);break;default:let l=s[e],h=n[e];J(l)&&l===h||(s[e]=h,t[e]=h)}});let p=l-d,m=h-f;(p||m)&&(this.canvasStartX+=p,this.canvasStartY+=m,this.dirtyStart=!0)}return t},os.updateCanvas=function(){if(this.canvas&&this.canvas.domElement){let t=this.canvas,e=t.domElement.style,i=this.mimickedStyles,s=this.checkElementStyleValues();for(let[t,n]of Object.entries(s))i.indexOf(t)>=0&&(e[t]=n);if(this.dirtyStart&&(this.dirtyStart=!1,t.set({startX:this.canvasStartX,startY:this.canvasStartY})),this.dirtyDimensions){this.dirtyDimensions=!1;let e=this.canvasWidth,i=this.canvasHeight;t.set({width:e,height:i}),t.dirtyDimensions=!0,t.base.set({width:e,height:i}),t.base.dirtyDimensions=!0,t.cleanDimensions(),t.base.cleanDimensions()}this.dirtyZIndex&&(this.dirtyZIndex=!1,e.zIndex=this.canvasZIndex)}};O.UnstackedElement=UnstackedElement;const as=function(t,e,s,n){let r=i[t.id];if(!r)return!1;e.isComponent=!0;let o=r.addCanvas(e);s.name=r.name+"-animation",s.target=o;let a=rs(s),l=Bt(a,r,n);return{element:r,canvas:o,animation:a,demolish:()=>{l(),a.kill(),o.demolish(),r.demolish(!0)}}},ls=function(t,e,i,s,n){let r,o=t.id;o&&S[o]?r=S[o]:r=new UnstackedElement(t),e.isComponent=!0;let a=!!n&&r.addCanvas(e);i.name=r.name+"-animation",a&&(i.afterClear||(i.afterClear=()=>r.updateCanvas()),i.target=a);let l=rs(i),h=Bt(l,r,s);return{element:r,canvas:a,animation:l,demolish:()=>{h(),l.kill(),a&&a.demolish(),r.demolish(!0)}}},hs=["artefact","group","animation","tween","styles"],cs=t=>{if(t&&t.substring){let e;return!!hs.some(i=>(e=x[i][t],e))&&e}return!1};function us(t={}){t.defs=_(t.defs,{order:1,ticker:"",targets:null,time:0,action:null,reverseOnCycleEnd:!1,reversed:!1}),t.kill=function(){let t,i=this.ticker;return i===this.name+"_ticker"?(t=e[i],t&&t.kill()):i&&this.removeFromTicker(i),this.deregister(),!0};let i=t.getters,s=t.setters;return i.targets=function(){return[].concat(this.targets)},s.targets=function(t=[]){this.setTargets(t)},s.action=function(t){this.action=t,"function"!=typeof this.action&&(this.action=B)},t.calculateEffectiveTime=function(t){let i,s=et(t,this.time),n=M(s),r=n[1],o=n[0],a=0;return this.effectiveTime=0,"%"===o&&r<=100?this.ticker&&(i=e[this.ticker],i&&(a=i.effectiveDuration,this.effectiveTime=a*(r/100))):this.effectiveTime=r,this},t.addToTicker=function(t){let i;return J(t)&&(this.ticker&&this.ticker!==t&&this.removeFromTicker(this.ticker),i=e[t],J(i)&&(this.ticker=t,i.subscribe(this.name),this.calculateEffectiveTime())),this},t.removeFromTicker=function(t){let i;return(t=J(t)?t:this.ticker)&&(i=e[t],J(i)&&(this.ticker="",i.unsubscribe(this.name))),this},t.setTargets=function(t){t=[].concat(t);let e=[];return t.forEach(t=>{if(W(t))W(t.set)&&e.push(t);else if(U(t)&&J(t.name))e.push(t);else{let i=cs(t);i&&e.push(i)}}),this.targets=e,this},t.addToTargets=function(t){return(t=[].concat(t)).forEach(t=>{"function"==typeof t?"function"==typeof t.set&&this.targets.push(t):(result=cs(t),result&&this.targets.push(result))},this),this},t.removeFromTargets=function(t){t=[].concat(t);let e=[],i=[].concat(this.targets);return i.forEach(t=>{let i=t.type||"unknown",s=t.name||"unnamed";"unknown"!==i&&"unnamed"!==s&&e.push(`${i}_${s}`)}),t.forEach(t=>{let s;if(s="function"==typeof t?t:cs(t),s){let t=s.type||"unknown",n=s.name||"unnamed";if("unknown"!==t&&"unnamed"!==n){let s=`${t}_${n}`,r=e.indexOf(s);r>=0&&(i[r]=!1)}}}),this.targets=[],i.forEach(t=>{t&&this.targets.push(t)},this),this},t.checkForTarget=function(t){return!!t.substring&&this.targets.some(e=>e.name===t)},t}const Action=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.calculateEffectiveTime(),J(t.ticker)&&this.addToTicker(t.ticker),this};let ds=Action.prototype=Object.create(Object.prototype);ds.type="Action",ds.lib="tween",ds.isArtefact=!1,ds.isAsset=!1,ds=ee(ds),ds=us(ds);ds.defs=_(ds.defs,{revert:null}),ds.packetExclusions=Q(ds.packetExclusions,["targets"]),ds.packetFunctions=Q(ds.packetFunctions,["revert","action"]),ds.finalizePacketOut=function(t,e){return Array.isArray(this.targets)&&(t.targets=this.targets.map(t=>t.name)),t};let fs=ds.setters;fs.revert=function(t){this.revert=t,"function"!=typeof this.revert&&(this.revert=B)},fs.triggered=function(t){this.triggered!==t&&(t?this.action():this.revert(),this.triggered=t)},ds.set=function(t={}){if(Object.keys(t).length){let e,i=this.setters,s=this.defs,n=!!J(t.ticker)&&this.ticker;Object.entries(t).forEach(([t,n])=>{"name"!==t&&(e=i[t],e?e.call(this,n):void 0!==s[t]&&(this[t]=n))},this),n?(this.ticker=n,this.addToTicker(t.ticker)):J(t.time)&&this.calculateEffectiveTime()}return this},ds.getEndTime=function(){return this.effectiveTime},ds.update=function(t){let e=this.reversed,i=this.effectiveTime,s=this.triggered,n=(this.reverseOnCycleEnd,t.tick),r=t.reverseTick,o=t.willLoop;t.next;return e?r>=i?s||(this.action(),this.triggered=!0):s&&(this.revert(),this.triggered=!1):n>=i?s||(this.action(),this.triggered=!0):s&&(this.revert(),this.triggered=!1),o&&(this.triggered=!this.triggered),!0};function ps(t={}){(t=Ke(t=_e(t=Ve(t=We(t=Ge(t=ze(t=Ye(t)))))))).defs=_(t.defs,{method:"fill",pathObject:null,winding:"nonzero",flipReverse:!1,flipUpend:!1,scaleOutline:!0,lockFillStyleToEntity:!1,lockStrokeStyleToEntity:!1,onEnter:null,onLeave:null,onDown:null,onUp:null}),t.packetExclusions=Q(t.packetExclusions,["state"]),t.packetFunctions=Q(t.packetFunctions,["onEnter","onLeave","onDown","onUp"]),t.processEntityPacketOut=function(t,e,i){return this.processFactoryPacketOut(t,e,i)},t.processFactoryPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},t.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=_(t,i),t=this.handlePacketAnchor(t,e)},t.postCloneAction=function(t,e){return this.onEnter&&(t.onEnter=this.onEnter),this.onLeave&&(t.onLeave=this.onLeave),this.onDown&&(t.onDown=this.onDown),this.onUp&&(t.onUp=this.onUp),e.sharedState&&(t.state=this.state),e.anchor&&(e.anchor.host=t,J(e.anchor.focusAction)||(e.anchor.focusAction=this.anchor.focusAction),J(e.anchor.blurAction)||(e.anchor.blurAction=this.anchor.blurAction),t.buildAnchor(e.anchor),e.anchor.clickAction||(t.anchor.clickAction=this.anchor.clickAction)),t};let e=t.getters,i=t.setters;t.deltaSetters;return e.group=function(){return this.group?this.group.name:""},i.lockStylesToEntity=function(t){this.lockFillStyleToEntity=t,this.lockStrokeStyleToEntity=t},t.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):null)}},t.set=function(t={}){if(Object.keys(t).length){let e,i,s=this.setters,n=this.defs,r=this.state,o=r?r.setters:{},a=r?r.defs:{};Object.entries(t).forEach(([t,l])=>{t&&"name"!==t&&null!=l&&(e=s[t],i=!1,e||(e=o[t],i=!0),e?e.call(i?this.state:this,l):void 0!==n[t]?this[t]=l:void 0!==a[t]&&(r[t]=l))},this)}return this},t.setDelta=function(t={}){if(Object.keys(t).length){let e,i,s=this.deltaSetters,n=this.defs,r=this.state,o=r?r.deltaSetters:{},a=r?r.defs:{};Object.entries(t).forEach(([t,l])=>{t&&"name"!==t&&null!=l&&(e=s[t],i=!1,e||(e=o[t],i=!0),e?e.call(i?this.state:this,l):void 0!==n[t]?this[t]=H(this[t],l):void 0!==a[t]&&(r[t]=H(r[t],l)))},this)}return this},t.entityInit=function(t={}){this.makeName(t.name),this.register(),this.initializePositions(),this.set(this.defs),this.state=De(),t.group||(t.group=Gi),this.onEnter=B,this.onLeave=B,this.onDown=B,this.onUp=B,this.set(t),this.midInitActions(t),this.purge&&this.purgeArtefact(this.purge)},t.midInitActions=B,t.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1,this.dirtyDimensions=!0),(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle)&&(this.dirtyPathObject=!0),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers(),this.anchor&&this.dirtyAnchorHold&&(this.dirtyAnchorHold=!1,this.buildAnchor(this.anchor))},t.cleanPathObject=B,t.stamp=function(t=!1,e,i){let s=!(this.noFilters||!this.filters||!this.filters.length);return t?(e&&"Cell"===e.type&&(this.currentHost=e),i&&(this.set(i),this.prepareStamp()),s?this.filteredStamp():this.regularStamp()):this.visibility?this.stashOutput||s?this.filteredStamp():this.regularStamp():Promise.resolve("entity.stamp")},t.regularStamp=function(){let t=this;return new Promise((e,i)=>{t.currentHost&&(t.regularStampSynchronousActions(),e("entity.regularStamp resolving")),i("entity.regularStamp - no currentHost")})},t.filteredStamp=function(){!this.dirtyFilters&&this.currentFilters||this.cleanFilters();let t=this;return new Promise((e,i)=>{let s=function(){if(u&&we(u),o.save(),o.globalAlpha=t.state&&t.state.globalAlpha?t.state.globalAlpha:1,o.globalCompositeOperation=t.state&&t.state.globalCompositeOperation?t.state.globalCompositeOperation:"source-over",o.setTransform(1,0,0,1,0,0),o.drawImage(h,0,0),t.stashOutput){t.stashOutput=!1;let[e,i,s,n]=t.getCellCoverage(c.getImageData(0,0,h.width,h.height));if(t.stashedImageData=c.getImageData(e,i,s,n),t.stashOutputAsAsset)if(t.stashOutputAsAsset=!1,h.width=s,h.height=n,c.putImageData(t.stashedImageData,0,0),t.stashedImage)t.stashedImage.src=h.toDataURL();else{let e=t.stashedImage=document.createElement("img");e.id=t.name+"-image",e.onload=function(){is.appendChild(e),Ne("#"+e.id)},e.src=h.toDataURL()}}ri(l),o.restore(),t.currentHost=n,t.noCanvasEngineUpdates=m},n=t.currentHost,r=n.element,o=n.engine,a=n.currentDimensions,l=ni(),h=l.element,c=l.engine;t.currentHost=l;let u,d,f=h.width=a[0]||r.width,p=h.height=a[1]||r.height,m=t.noCanvasEngineUpdates;t.noCanvasEngineUpdates=!1,t.regularStampSynchronousActions(),!t.noFilters&&t.filters&&t.filters.length?(t.isStencil&&(c.save(),c.globalCompositeOperation="source-in",c.globalAlpha=1,c.setTransform(1,0,0,1,0,0),c.drawImage(r,0,0),c.restore()),c.setTransform(1,0,0,1,0,0),d=c.getImageData(0,0,f,p),u=ve(),t.preprocessFilters(t.currentFilters),xe(u,{image:d,filters:t.currentFilters}).then(t=>{if(!t)throw new Error("image issue");c.globalCompositeOperation="source-over",c.globalAlpha=1,c.setTransform(1,0,0,1,0,0),c.putImageData(t,0,0),s(),e(!0)}).catch(t=>{s(),i(t)})):(s(),e(!0))})},t.getCellCoverage=function(t){let e,i,s=t.width,n=t.height,r=t.data,o=0,a=0,l=s,h=n,c=3;for(i=0;i<n;i++)for(e=0;e<s;e++)r[c]&&(l>e&&(l=e),o<e&&(o=e),h>i&&(h=i),a<i&&(a=i)),c+=4;return l<o&&h<a?[l,h,o-l,a-h]:[0,0,s,n]},t.simpleStamp=function(t,e={}){t&&"Cell"===t.type&&(this.currentHost=t,this.set(e),this.prepareStamp(),this.regularStampSynchronousActions())},t.regularStampSynchronousActions=function(){let t=this.currentHost;if(t){let e=t.engine,i=this.currentStampPosition,s=i[0],n=i[1];t.rotateDestination(e,s,n,this),this.noCanvasEngineUpdates||t.setEngine(this),this[this.method](e)}},t.draw=function(t){t.stroke(this.pathObject)},t.fill=function(t){t.fill(this.pathObject,this.winding)},t.drawAndFill=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding)},t.fillAndDraw=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding),t.stroke(e)},t.drawThenFill=function(t){let e=this.pathObject;t.stroke(e),t.fill(e,this.winding)},t.fillThenDraw=function(t){let e=this.pathObject;t.fill(e,this.winding),t.stroke(e)},t.clip=function(t){t.clip(this.pathObject,this.winding)},t.clear=function(t){let e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fill(this.pathObject,this.winding),t.globalCompositeOperation=e},t.none=function(t){},t}O.Action=Action;const Block=function(t={}){return this.entityInit(t),t.dimensions||(t.width||(this.currentDimensions[0]=this.dimensions[0]=10),t.height||(this.currentDimensions[1]=this.dimensions[1]=10)),this};let ms=Block.prototype=Object.create(Object.prototype);ms.type="Block",ms.lib="entity",ms.isArtefact=!0,ms.isAsset=!1,ms=ee(ms),ms=ps(ms),ms.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=this.currentStampHandlePosition,i=this.currentScale,s=this.currentDimensions,n=-e[0]*i,r=-e[1]*i,o=s[0]*i,a=s[1]*i;t.rect(n,r,o,a)}};O.Block=Block;const gs={x:0,y:0},ys=function(t,e,i){t.x=e,t.y=i},bs=function(t,e){let i=Math.atan2(t.y,t.x);i+=.01745329251*e;let s=Math.sqrt(t.x*t.x+t.y*t.y);t.x=s*Math.cos(i),t.y=s*Math.sin(i)},ks=function(t,e,i){let s,n,r=[],o=[],a=[],l=[],h=0;if("linear"===t){let[t,e,a,l]=i;s=a-t,n=l-e,h=Math.sqrt(s*s+n*n),r=r.concat([t,a]),o=o.concat([e,l])}else if("bezier"===t||"quadratic"===t){let c,u,d,f,p,m,g="bezier"===t?"getBezierXY":"getQuadraticXY",y=!1,b=.25,k=0;for(;!y;){for(r.length=0,o.length=0,k=0,a.length=0,l.length=0,m=Ss[g](0,...i),c=m.x,u=m.y,r.push(c),o.push(u),p=b;p<=1;p+=b)m=Ss[g](p,...i),({x:d,y:f}=m),r.push(d),o.push(f),s=d-c,n=f-u,k+=Math.sqrt(s*s+n*n),c=d,u=f,a.push(k),l.push(p);k<h+e&&(y=!0),h=k,b/=2,b<.004&&(y=!0)}}return{length:h,xPoints:r,yPoints:o,positions:l,progression:a}},Ss={getBezierXY:function(t,e,i,s,n,r,o,a,l){let h=1-t;return{x:Math.pow(h,3)*e+3*t*Math.pow(h,2)*s+3*t*t*h*r+t*t*t*a,y:Math.pow(h,3)*i+3*t*Math.pow(h,2)*n+3*t*t*h*o+t*t*t*l}},getQuadraticXY:function(t,e,i,s,n,r,o){let a=1-t;return{x:a*a*e+2*a*t*s+t*t*r,y:a*a*i+2*a*t*n+t*t*o}}};function Os(t={}){(t=ps(t)).defs=_(t.defs,{species:"",useAsPath:!1,precision:10,constantPathSpeed:!1,pathDefinition:"",showBoundingBox:!1,boundingBoxColor:"rgba(0,0,0,0.5)",minimumBoundingBoxDimensions:20}),t.packetExclusions=Q(t.packetExclusions,["dimensions","pathed"]),t.packetExclusionsByRegex=Q(t.packetExclusionsByRegex,[]),t.packetCoordinates=Q(t.packetCoordinates,[]),t.packetObjects=Q(t.packetObjects,[]),t.packetFunctions=Q(t.packetFunctions,[]),t.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=_(t,i),t=this.handlePacketAnchor(t,e)};t.getters;let e=t.setters,s=t.deltaSetters;return e.species=function(t){J(t)&&(this.species=t,this.updateDirty())},e.precision=function(t){J(t)&&t.toFixed&&(this.precision=t,this.updateDirty())},e.constantPathSpeed=function(t){this.constantPathSpeed=t,this.updateDirty()},e.width=B,e.height=B,e.dimensions=B,s.width=B,s.height=B,s.dimensions=B,e.pathDefinition=function(t){t.substring&&(this.pathDefinition=t),this.dirtyPathObject=!0},t.updateDirty=function(){this.dirtySpecies=!0,this.dirtyPathObject=!0},t.midInitActions=function(t){this.set(t)},t.shapeInit=function(t){this.entityInit(t),this.units=[],this.unitLengths=[],this.unitPartials=[],this.pathed=[],this.localBox=[]},t.positionPointOnPath=function(t){let e=fi(t);e.vectorSubtract(this.currentStampHandlePosition),this.flipReverse&&(e.x=-e.x),this.flipUpend&&(e.y=-e.y),e.rotate(this.roll),e.vectorAdd(this.currentStampPosition);let i={x:e.x,y:e.y};return pi(e),i},t.getBezierXY=function(t,e,i,s,n,r,o,a,l){let h=1-t;return{x:Math.pow(h,3)*e+3*t*Math.pow(h,2)*s+3*t*t*h*r+t*t*t*a,y:Math.pow(h,3)*i+3*t*Math.pow(h,2)*n+3*t*t*h*o+t*t*t*l}},t.getQuadraticXY=function(t,e,i,s,n,r,o){let a=1-t;return{x:a*a*e+2*a*t*s+t*t*r,y:a*a*i+2*a*t*n+t*t*o}},t.getLinearXY=function(t,e,i,s,n){return{x:e+(s-e)*t,y:i+(n-i)*t}},t.getBezierAngle=function(t,e,i,s,n,r,o,a,l){let h=1-t,c=Math.pow(h,2)*(s-e)+2*t*h*(r-s)+t*t*(a-r),u=Math.pow(h,2)*(n-i)+2*t*h*(o-n)+t*t*(l-o);return(-Math.atan2(c,u)+.5*Math.PI)/P},t.getQuadraticAngle=function(t,e,i,s,n,r,o){let a=1-t,l=2*a*(s-e)+2*t*(r-s),h=2*a*(n-i)+2*t*(o-n);return(-Math.atan2(l,h)+.5*Math.PI)/P},t.getLinearAngle=function(t,e,i,s,n){let r=s-e,o=n-i;return(-Math.atan2(r,o)+.5*Math.PI)/P},t.getConstantPosition=function(t){if(!t||!t.toFixed||isNaN(t))return 0;if(t>=1)return.9999;let e=this.unitPositions;if(e&&e.length){let e,i,s,n,r,o,a,l=this.length,h=this.unitProgression,c=this.unitPositions,u=t*l,d=-1;for(let t=0,e=h.length;t<e;t++)if(u<=h[t]){d=t-1;break}return d<0?(e=h[0],n=u/e*c[0]):(e=h[d],i=d?h[d-1]:0,s=e-i,r=c[d],o=c[d+1],a=o-r,n=r+(u-e)/s*a),n}return t},t.buildPathPositionObject=function(t,e){if(t){let i,s,[n,...r]=t;switch(n){case"linear":i=this.positionPointOnPath(this.getLinearXY(e,...r)),s=this.getLinearAngle(e,...r);break;case"quadratic":i=this.positionPointOnPath(this.getQuadraticXY(e,...r)),s=this.getQuadraticAngle(e,...r);break;case"bezier":i=this.positionPointOnPath(this.getBezierXY(e,...r)),s=this.getBezierAngle(e,...r)}let o=0;return this.flipReverse&&o++,this.flipUpend&&o++,1===o&&(s=-s),s+=this.roll,i.angle=s,i}return!1},t.getPathPositionData=function(t,e=!1){if(this.useAsPath&&J(t)&&t.toFixed){let i,s,n,r,o,a,l=t%1,h=this.unitPartials,c=0;for(0===t?l=0:1===t&&(l=.9999),e&&(l=this.getConstantPosition(l)),n=0,r=h.length;n<r;n++)if(a=this.units[n][0],"move"!==a&&"close"!==a&&"unknown"!==a){if(i=h[n],l<=i){o=this.units[n],s=(l-c)/(i-c);break}c=i}return this.buildPathPositionObject(o,s)}return!1},t.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1),(this.dirtyScale||this.dirtySpecies||this.dirtyDimensions||this.dirtyStart||this.dirtyHandle)&&(this.dirtyPathObject=!0,(this.dirtyScale||this.dirtySpecies)&&(this.pathCalculatedOnce=!1)),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0),this.dirtyScale&&this.cleanScale(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyRotation&&this.cleanRotation(),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtySpecies&&this.cleanSpecies(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers()},t.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyOffset=!0},t.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){this.dirtyDimensions&&(this.cleanSpecies(),this.pathCalculatedOnce=!1),this.calculateLocalPath(this.pathDefinition),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyHandle&&this.cleanHandle(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions();let t=this.currentStampHandlePosition;this.pathObject=new Path2D(`m${-t[0]},${-t[1]}${this.localPath}`)}},t.calculateLocalPath=function(t,e){let i;if(this.pathCalculatedOnce||(i=function(t,e,i,s,n){let r,o,a,l,h=[],c=[],u="",d="",f=[],p=[],m=[],g=t.match(/([A-Za-z][0-9. ,\-]*)/g),y=0,b={},k=0,S=0,O=0,P=0,v=[],w=[],x=[],A=[],C=0,D=0,R=t=>{c.push({c:u.toLowerCase(),p:t||null,x:O,y:P,cx:k,cy:S,rx:C,ry:D}),s||(v.push(k),w.push(S)),O=k,P=S};for(r=0,o=g.length;r<o;r++)if(u=g[r][0],h=g[r].match(/(-?[0-9.]+\b)/g)||[],h.length){for(a=0,l=h.length;a<l;a++)h[a]=parseFloat(h[a]);switch(0===r?"M"===u&&(O=h[0]*e-i.x,P=h[1]*e-i.y,u="m"):(O=k,P=S),u){case"H":for(a=0,l=h.length;a<l;a++)h[a]=h[a]*e-O,k+=h[a],C=D=0,R(h.slice(a,a+1));break;case"V":for(a=0,l=h.length;a<l;a++)h[a]=h[a]*e-P,S+=h[a],C=D=0,R(h.slice(a,a+1));break;case"M":for(a=0,l=h.length;a<l;a+=2)h[a]=h[a]*e-O,h[a+1]=h[a+1]*e-P,k+=h[a],S+=h[a+1],C=D=0,R(h.slice(a,a+2));break;case"L":case"T":for(a=0,l=h.length;a<l;a+=2)h[a]=h[a]*e-O,h[a+1]=h[a+1]*e-P,k+=h[a],S+=h[a+1],"T"===u?(C=h[a]+O,D=h[a+1]+P):C=D=0,R(h.slice(a,a+2));break;case"Q":case"S":for(a=0,l=h.length;a<l;a+=4)h[a]=h[a]*e-O,h[a+1]=h[a+1]*e-P,h[a+2]=h[a+2]*e-O,h[a+3]=h[a+3]*e-P,k+=h[a+2],S+=h[a+3],C=h[a]+O,D=h[a+1]+P,R(h.slice(a,a+4));break;case"C":for(a=0,l=h.length;a<l;a+=6)h[a]=h[a]*e-O,h[a+1]=h[a+1]*e-P,h[a+2]=h[a+2]*e-O,h[a+3]=h[a+3]*e-P,h[a+4]=h[a+4]*e-O,h[a+5]=h[a+5]*e-P,k+=h[a+4],S+=h[a+5],C=h[a+2]+O,D=h[a+3]+P,R(h.slice(a,a+6));break;case"A":for(a=0,l=h.length;a<l;a+=7)h[a+5]=h[a+5]*e-O,h[a+6]=h[a+6]*e-P,k+=h[a+5],S+=h[a+6],C=D=0,R(h.slice(a,a+7));break;case"h":for(a=0,l=h.length;a<l;a++)h[a]*=e,k+=h[a],C=D=0,R(h.slice(a,a+1));break;case"v":for(a=0,l=h.length;a<l;a++)h[a]*=e,S+=h[a],C=D=0,R(h.slice(a,a+1));break;case"m":case"l":case"t":for(a=0,l=h.length;a<l;a+=2)h[a]*=e,h[a+1]*=e,k+=h[a],S+=h[a+1],"t"===u?(C=h[a]+O,D=h[a+1]+P):C=D=0,R(h.slice(a,a+2));break;case"q":case"s":for(a=0,l=h.length;a<l;a+=4)h[a]*=e,h[a+1]*=e,h[a+2]*=e,h[a+3]*=e,k+=h[a+2],S+=h[a+3],C=h[a]+O,D=h[a+1]+P,R(h.slice(a,a+4));break;case"c":for(a=0,l=h.length;a<l;a+=6)h[a]*=e,h[a+1]*=e,h[a+2]*=e,h[a+3]*=e,h[a+4]*=e,h[a+5]*=e,k+=h[a+4],S+=h[a+5],C=h[a+2]+O,D=h[a+3]+P,R(h.slice(a,a+6));break;case"a":for(a=0,l=h.length;a<l;a+=7)h[a]*=e,h[a+1]*=e,h[a+5]*=e,h[a+6]*=e,k+=h[a+5],S+=h[a+6],C=D=0,R(h.slice(a,a+7))}}else C=D=0,R();for(r=0,o=c.length;r<o;r++){let t=c[r],e=t.p;if(e){for(a=0,l=e.length;a<l;a++)e[a]=e[a].toFixed(1);for(d+=`${t.c}${t.p.join()}`,a=0,l=e.length;a<l;a++)e[a]=parseFloat(e[a])}else d+=""+t.c}if(b.localPath=d,s){let t=gs;for(r=0,o=c.length;r<o;r++){let e=c[r],i=r>0&&c[r-1],{c:s,p:n,x:o,y:a,cx:l,cy:h,rx:u,ry:d}=e;if(n)switch(s){case"h":f[r]=["linear",o,a,n[0]+o,a];break;case"v":f[r]=["linear",o,a,o,n[0]+a];break;case"m":f[r]=["move",o,a];break;case"l":f[r]=["linear",o,a,n[0]+o,n[1]+a];break;case"t":i&&(i.rx||i.ry)?(ys(t,i.rx-l,i.ry-h),bs(t,180),f[r]=["quadratic",o,a,t.x+l,t.y+h,n[0]+o,n[1]+a]):f[r]=["quadratic",o,a,o,a,n[0]+o,n[1]+a];break;case"q":f[r]=["quadratic",o,a,n[0]+o,n[1]+a,n[2]+o,n[3]+a];break;case"s":i&&(i.rx||i.ry)?(ys(t,i.rx-l,i.ry-h),bs(t,180),f[r]=["bezier",o,a,t.x+l,t.y+h,n[0]+o,n[1]+a,n[2]+o,n[3]+a]):f[r]=["bezier",o,a,o,a,n[0]+o,n[1]+a,n[2]+o,n[3]+a];break;case"c":f[r]=["bezier",o,a,n[0]+o,n[1]+a,n[2]+o,n[3]+a,n[4]+o,n[5]+a];break;case"a":f[r]=["linear",o,a,n[5]+o,n[6]+a];break;case"z":isNaN(o)&&(o=0),isNaN(a)&&(a=0),f[r]=["close",o,a];break;default:isNaN(o)&&(o=0),isNaN(a)&&(a=0),f[r]=["unknown",o,a]}else f[r]=["no-points-"+s,o,a]}for(b.units=f,r=0,o=f.length;r<o;r++){let t,[e,...i]=f[r];switch(e){case"linear":case"quadratic":case"bezier":t=ks(e,n,i),p[r]=t.length,v=v.concat(t.xPoints),w=w.concat(t.yPoints),x.push(t.progression),A.push(t.positions);break;default:p[r]=0}}y=p.reduce((t,e)=>t+e,0);let e=0;for(r=0,o=p.length;r<o;r++)e+=p[r]/y,m[r]=parseFloat(e.toFixed(6))}b.unitLengths=p,b.unitPartials=m,b.length=parseFloat(y.toFixed(1)),b.unitPositions=A,b.unitProgression=x;let E=Math.max(...v),F=Math.max(...w),T=Math.min(...v),H=Math.min(...w);return b.maxX=E,b.maxY=F,b.minX=T,b.minY=H,b.xRange=v,b.yRange=w,b}(t,this.currentScale,this.currentStart,this.useAsPath,this.precision),this.pathCalculatedOnce=!0),i){this.localPath=i.localPath,this.length=i.length;let t=i.maxX,s=i.maxY,n=i.minX,r=i.minY,o=this.dimensions,a=this.currentDimensions,l=this.localBox;if(o[0]=parseFloat((t-n).toFixed(1)),o[1]=parseFloat((s-r).toFixed(1)),o[0]===a[0]&&o[1]===a[1]||(a[0]=o[0],a[1]=o[1],this.dirtyHandle=!0),l.length=0,l.push(parseFloat(n.toFixed(1)),parseFloat(r.toFixed(1)),o[0],o[1]),this.useAsPath){const{units:t,unitLengths:e,unitPartials:s,unitProgression:n,unitPositions:r}=i;let o,a,l,h,c,u,d,f,p,m,g=0,y=[],b=[];for(c=0,u=e.length;c<u;c++)if(g+=e[c],l=n[c],l)for(a=s[c],o=s[c+1]-a,h=r[c],d=0,f=l.length;d<f;d++)p=g+l[d],y.push(parseFloat(p.toFixed(1))),m=a+h[d]*o,b.push(parseFloat(m.toFixed(6)));this.units=t,this.unitLengths=e,this.unitPartials=s,this.unitProgression=y,this.unitPositions=b}e||this.calculateLocalPathAdditionalActions()}},t.calculateLocalPathAdditionalActions=B,t.updatePathSubscribers=function(){this.pathed.forEach(t=>{let e=i[t];e&&(e.currentPathData=!1,e.dirtyStart=!0,e.addPathHandle&&(e.dirtyHandle=!0),e.addPathOffset&&(e.dirtyOffset=!0),e.addPathRotation&&(e.dirtyRotation=!0),"Polyline"===e.type?e.dirtyPins=!0:"Line"!==e.type&&"Quadratic"!==e.type&&"Bezier"!==e.type||e.dirtyPins.push(this.name))},this)},t.draw=function(t){t.stroke(this.pathObject),this.showBoundingBox&&this.drawBoundingBox(t)},t.fill=function(t){t.fill(this.pathObject,this.winding),this.showBoundingBox&&this.drawBoundingBox(t)},t.drawAndFill=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding),this.showBoundingBox&&this.drawBoundingBox(t)},t.fillAndDraw=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),t.fill(e,this.winding),t.stroke(e),this.showBoundingBox&&this.drawBoundingBox(t)},t.drawThenFill=function(t){let e=this.pathObject;t.stroke(e),t.fill(e,this.winding),this.showBoundingBox&&this.drawBoundingBox(t)},t.fillThenDraw=function(t){let e=this.pathObject;t.fill(e,this.winding),t.stroke(e),this.showBoundingBox&&this.drawBoundingBox(t)},t.clear=function(t){let e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fill(this.pathObject,this.winding),t.globalCompositeOperation=e,this.showBoundingBox&&this.drawBoundingBox(t)},t.drawBoundingBox=function(t){t.save(),t.strokeStyle=this.boundingBoxColor,t.lineWidth=1,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.strokeRect(...this.getBoundingBox()),t.restore()},t.getBoundingBox=function(){let t=Math.floor,e=Math.ceil,i=this.minimumBoundingBoxDimensions,[s,n,r,o]=this.localBox,[a,l]=this.currentStampHandlePosition,[h,c]=this.currentStampPosition;return r<i&&(r=i),o<i&&(o=i),[t(s-a),t(n-l),e(r),e(o),h,c]},t}const Ps=t=>"string"!=typeof t?"":t.charAt(0).toUpperCase()+t.slice(1);function vs(t={}){t.defs=_(t.defs,{end:null,endPivot:"",endPivotCorner:"",addEndPivotHandle:!1,addEndPivotOffset:!1,endPath:"",endPathPosition:0,addEndPathHandle:!1,addEndPathOffset:!0,endParticle:"",endLockTo:"",useStartAsControlPoint:!1}),t.packetExclusions=Q(t.packetExclusions,["controlledLineOffset"]),t.packetExclusionsByRegex=Q(t.packetExclusionsByRegex,[]),t.packetCoordinates=Q(t.packetCoordinates,["end"]),t.packetObjects=Q(t.packetObjects,["endPivot","endPath"]),t.packetFunctions=Q(t.packetFunctions,[]),t.factoryKill=function(){Object.entries(i).forEach(([t,e])=>{e.name!==this.name&&(e.startControlPivot&&e.startControlPivot.name===this.name&&e.set({startControlPivot:!1}),e.controlPivot&&e.controlPivot.name===this.name&&e.set({controlPivot:!1}),e.endControlPivot&&e.endControlPivot.name===this.name&&e.set({endControlPivot:!1}),e.endPivot&&e.endPivot.name===this.name&&e.set({endPivot:!1}),e.startControlPath&&e.startControlPath.name===this.name&&e.set({startControlPath:!1}),e.controlPath&&e.controlPath.name===this.name&&e.set({controlPath:!1}),e.endControlPath&&e.endControlPath.name===this.name&&e.set({endControlPath:!1}),e.endPath&&e.endPath.name===this.name&&e.set({endPath:!1}))})};t.getters;let e=t.setters,s=t.deltaSetters;return e.useStartAsControlPoint=function(t){if(this.useStartAsControlPoint=t,!t){let t=this.controlledLineOffset;t[0]=0,t[1]=0}this.updateDirty()},e.endPivot=function(t){this.setControlHelper(t,"endPivot","end"),this.updateDirty(),this.dirtyEnd=!0},e.endParticle=function(t){this.setControlHelper(t,"endParticle","end"),this.updateDirty(),this.dirtyEnd=!0},e.endPath=function(t){this.setControlHelper(t,"endPath","end"),this.updateDirty(),this.dirtyEnd=!0},e.endPathPosition=function(t){this.endPathPosition=t,this.dirtyEnd=!0,this.currentEndPathData=!1},s.endPathPosition=function(t){this.endPathPosition+=t,this.dirtyEnd=!0,this.currentEndPathData=!1},e.endX=function(t){null!=t&&(this.end[0]=t,this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1)},e.endY=function(t){null!=t&&(this.end[1]=t,this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1)},e.end=function(t,e){this.setCoordinateHelper("end",t,e),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},s.endX=function(t){let e=this.end;e[0]=H(e[0],t),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},s.endY=function(t){let e=this.end;e[1]=H(e[1],t),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},s.end=function(t,e){this.setDeltaCoordinateHelper("end",t,e),this.updateDirty(),this.dirtyEnd=!0,this.currentEndPathData=!1},e.endLockTo=function(t){this.endLockTo=t,this.updateDirty(),this.dirtyEndLock=!0,this.currentEndPathData=!1},t.curveInit=function(t){this.end=He(),this.currentEnd=He(),this.endLockTo="coord",this.dirtyEnd=!0,this.dirtyPins=[],this.controlledLineOffset=He()},t.setControlHelper=function(t,e,s){if(Y(t)&&!t)this[e]=null,"startControl"===s?this.dirtyStartControlLock=!0:"control"===s?this.dirtyControlLock=!0:"endControl"===s?this.dirtyEndControlLock=!0:this.dirtyEndLock=!0;else if(t){let n=this[e],r=t.substring?i[t]:t;e.indexOf("Pivot")>0?r&&r.isArtefact&&(n&&n.isArtefact&&K(n.pivoted,this.name),Q(r.pivoted,this.name),this[e]=r):e.indexOf("Path")>0?r&&r.isArtefact&&(n&&n.isArtefact&&K(n.pathed,this.name),Q(r.pathed,this.name),this[e]=r):e.indexOf("Particle")>0&&(r=t.substring?d[t]:t,r||(this.updateDirty(),"startControl"===s?this.dirtyStartControl=!0:"control"===s?this.dirtyControl=!0:"endControl"===s?this.dirtyEndControl=!0:this.dirtyEnd=!0,this[e]=t))}},t.buildPathPositionObject=function(t,e){if(t){let i,s,[n,...r]=t;switch(n){case"linear":i=this.positionPointOnPath(this.getLinearXY(e,...r)),s=this.getLinearAngle(e,...r);break;case"quadratic":i=this.positionPointOnPath(this.getQuadraticXY(e,...r)),s=this.getQuadraticAngle(e,...r);break;case"bezier":i=this.positionPointOnPath(this.getBezierXY(e,...r)),s=this.getBezierAngle(e,...r)}let o=0;this.flipReverse&&o++,this.flipUpend&&o++,1===o&&(s=-s),s+=this.roll;this.currentStampPosition;let a=this.controlledLineOffset;this.localBox;return i.x+=a[0],i.y+=a[1],i.angle=s,i}return!1},t.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1),this.dirtyPins.length&&this.preparePinsForStamp(),this.dirtyLock&&this.cleanLock(),this.dirtyStartControlLock&&this.cleanControlLock("startControl"),this.dirtyEndControlLock&&this.cleanControlLock("endControl"),this.dirtyControlLock&&this.cleanControlLock("control"),this.dirtyEndLock&&this.cleanControlLock("end"),(this.dirtyScale||this.dirtySpecies||this.dirtyDimensions||this.dirtyStart||this.dirtyStartControl||this.dirtyEndControl||this.dirtyControl||this.dirtyEnd||this.dirtyHandle)&&(this.dirtyPathObject=!0,this.useStartAsControlPoint&&this.dirtyStart&&(this.dirtySpecies=!0,this.pathCalculatedOnce=!1),(this.dirtyScale||this.dirtySpecies||this.dirtyStartControl||this.dirtyEndControl||this.dirtyControl||this.dirtyEnd)&&(this.pathCalculatedOnce=!1)),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0,this.useStartAsControlPoint&&(this.dirtySpecies=!0,this.dirtyPathObject=!0,this.pathCalculatedOnce=!1)),this.dirtyScale&&this.cleanScale(),this.dirtyStart&&this.cleanStart(),(this.dirtyStartControl||"particle"===this.startControlLockTo)&&this.cleanControl("startControl"),(this.dirtyEndControl||"particle"===this.endControlLockTo)&&this.cleanControl("endControl"),(this.dirtyControl||"particle"===this.controlLockTo)&&this.cleanControl("control"),(this.dirtyEnd||"particle"===this.endLockTo)&&this.cleanControl("end"),this.dirtyOffset&&this.cleanOffset(),this.dirtyRotation&&this.cleanRotation(),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtySpecies&&this.cleanSpecies(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&(this.updatePositionSubscribers(),this.updateControlPathSubscribers())},t.cleanControlLock=function(t){let e=Ps(t);this[`dirty${e}Lock`]=!1,this["dirty"+e]=!0},t.cleanControl=function(t){let e=Ps(t);this["dirty"+e]=!1;let s,n,r=t+"Path",o=t+"Particle",a=this[t+"Pivot"],l=this[r],h=this[o];a&&a.substring&&(s=i[a],s&&(a=s)),l&&l.substring&&(s=i[l],s&&(l=s)),h&&h.substring&&(s=d[h],s&&(h=s));let c,u,f,p,m,g,y,b=this[t+"LockTo"],k=this[t],S=this["current"+e];switch(("pivot"!==b||a&&!a.substring)&&("path"!==b||l&&!l.substring)&&("particle"!==b||h&&!h.substring)||(b="coord"),b){case"pivot":this.pivotCorner&&a.getCornerCoordinate?[c,u]=a.getCornerCoordinate(this[t+"PivotCorner"]):[c,u]=a.currentStampPosition,this.addPivotOffset||([f,p]=a.currentOffset,c-=f,u-=p);break;case"path":n=this.getControlPathData(l,t,e),c=n.x,u=n.y,this.addPathOffset||(c-=l.currentOffset[0],u-=l.currentOffset[1]);break;case"particle":c=h.position.x,u=h.position.y,this.pathCalculatedOnce=!1;break;case"mouse":m=this.getHere(),c=m.x||0,u=m.y||0;break;default:c=u=0,g=this.getHost(),g&&(y=g.currentDimensions,y&&(this.cleanPosition(S,k,y),[c,u]=S))}S[0]=c,S[1]=u,this.dirtySpecies=!0,this.dirtyPathObject=!0,this.dirtyPositionSubscribers=!0},t.getControlPathData=function(t,e,i){let s=this[`current${i}PathData`];if(s)return s;let n=this[e+"PathPosition"],r=n,o=t.getPathPositionData(n);if(n<0&&(n+=1),n>1&&(n%=1),n=parseFloat(n.toFixed(6)),n!==r&&(this[e+"PathPosition"]=n),o)return this[`current${i}PathData`]=o,o;{let t=this.getHost();if(t){let s=t.currentDimensions;if(s){let t=this["current"+i];return this.cleanPosition(t,this[e],s),{x:t[0],y:t[1]}}}return{x:0,y:0}}},t.updateControlPathSubscribers=function(){[].concat(this.endSubscriber,this.endControlSubscriber,this.controlSubscriber,this.startControlSubscriber).forEach(t=>{let e=i[t];e&&("Line"!==e.type&&"Quadratic"!==e.type&&"Bezier"!==e.type||("Quadratic"===e.type?(e.dirtyControl=!0,e.currentControlPathData=!1):"Bezier"===e.type&&(e.dirtyStartControl=!0,e.dirtyEndControl=!0,e.currentStartControlPathData=!1,e.currentEndControlPathData=!1),e.currentEndPathData=!1,e.dirtyEnd=!0),e.currentPathData=!1,e.dirtyStart=!0)})},t}const Bezier=function(t={}){return this.startControl=He(),this.endControl=He(),this.currentStartControl=He(),this.currentEndControl=He(),this.startControlLockTo="coord",this.endControlLockTo="coord",this.curveInit(t),this.shapeInit(t),this.dirtyStartControl=!0,this.dirtyEndControl=!0,this};let ws=Bezier.prototype=Object.create(Object.prototype);ws.type="Bezier",ws.lib="entity",ws.isArtefact=!0,ws.isAsset=!1,ws=ee(ws),ws=Os(ws),ws=vs(ws);ws.defs=_(ws.defs,{startControl:null,startControlPivot:"",startControlPivotCorner:"",addStartControlPivotHandle:!1,addStartControlPivotOffset:!1,startControlPath:"",startControlPathPosition:0,addStartControlPathHandle:!1,addStartControlPathOffset:!0,startControlParticle:"",endControl:null,endControlPivot:"",endControlPivotCorner:"",addEndControlPivotHandle:!1,addEndControlPivotOffset:!1,endControlPath:"",endControlPathPosition:0,addEndControlPathHandle:!1,addEndControlPathOffset:!0,endControlParticle:"",startControlLockTo:"",endControlLockTo:""}),ws.packetExclusions=Q(ws.packetExclusions,[]),ws.packetExclusionsByRegex=Q(ws.packetExclusionsByRegex,[]),ws.packetCoordinates=Q(ws.packetCoordinates,["startControl","endControl"]),ws.packetObjects=Q(ws.packetObjects,["startControlPivot","startControlPath","endControlPivot","endControlPath"]),ws.packetFunctions=Q(ws.packetFunctions,[]);ws.getters;let xs=ws.setters,As=ws.deltaSetters;xs.endControlPivot=function(t){this.setControlHelper(t,"endControlPivot","endControl"),this.updateDirty(),this.dirtyEndControl=!0},xs.endControlParticle=function(t){this.setControlHelper(t,"endControlParticle","endControl"),this.updateDirty(),this.dirtyEndControl=!0},xs.endControlPath=function(t){this.setControlHelper(t,"endControlPath","endControl"),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},xs.endControlPathPosition=function(t){this.endControlPathPosition=t,this.dirtyEndControl=!0,this.currentEndControlPathData=!1},As.endControlPathPosition=function(t){this.endControlPathPosition+=t,this.dirtyEndControl=!0,this.currentEndControlPathData=!1},xs.startControlPivot=function(t){this.setControlHelper(t,"startControlPivot","startControl"),this.updateDirty(),this.dirtyStartControl=!0},xs.startControlParticle=function(t){this.setControlHelper(t,"startControlParticle","startControl"),this.updateDirty(),this.dirtyStartControl=!0},xs.startControlPath=function(t){this.setControlHelper(t,"startControlPath","startControl"),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},xs.startControlPathPosition=function(t){this.startControlPathPosition=t,this.dirtyStartControl=!0,this.currentStartControlPathData=!1},As.startControlPathPosition=function(t){this.startControlPathPosition+=t,this.dirtyStartControl=!0,this.currentStartControlPathData=!1},xs.startControlX=function(t){null!=t&&(this.startControl[0]=t,this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1)},xs.startControlY=function(t){null!=t&&(this.startControl[1]=t,this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1)},xs.startControl=function(t,e){this.setCoordinateHelper("startControl",t,e),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},As.startControlX=function(t){let e=this.startControl;e[0]=H(e[0],t),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},As.startControlY=function(t){let e=this.startControl;e[1]=H(e[1],t),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},As.startControl=function(t,e){this.setDeltaCoordinateHelper("startControl",t,e),this.updateDirty(),this.dirtyStartControl=!0,this.currentStartControlPathData=!1},xs.endControlX=function(t){null!=t&&(this.endControl[0]=t,this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1)},xs.endControlY=function(t){null!=t&&(this.endControl[1]=t,this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1)},xs.endControl=function(t,e){this.setCoordinateHelper("endControl",t,e),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},As.endControlX=function(t){let e=this.endControl;e[0]=H(e[0],t),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},As.endControlY=function(t){let e=this.endControl;e[1]=H(e[1],t),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},As.endControl=function(t,e){this.setDeltaCoordinateHelper("endControl",t,e),this.updateDirty(),this.dirtyEndControl=!0,this.currentEndControlPathData=!1},xs.startControlLockTo=function(t){this.startControlLockTo=t,this.updateDirty(),this.dirtyStartControlLock=!0},xs.endControlLockTo=function(t){this.endControlLockTo=t,this.updateDirty(),this.dirtyEndControlLock=!0,this.currentEndControlPathData=!1},ws.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeBezierPath(),this.pathDefinition=t},ws.makeBezierPath=function(){let[t,e]=this.currentStampPosition,[i,s]=this.currentStartControl,[n,r]=this.currentEndControl,[o,a]=this.currentEnd;return`m0,0c${(i-t).toFixed(2)},${(s-e).toFixed(2)} ${(n-t).toFixed(2)},${(r-e).toFixed(2)} ${(o-t).toFixed(2)},${(a-e).toFixed(2)}`},ws.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyHandle=!0,this.dirtyOffset=!0,this.dirtyStart=!0,this.dirtyStartControl=!0,this.dirtyEndControl=!0,this.dirtyEnd=!0},ws.preparePinsForStamp=function(){let t=this.endPivot,e=this.endPath,i=this.startControlPivot,s=this.startControlPath,n=this.endControlPivot,r=this.endControlPath;this.dirtyPins.forEach(o=>{(i&&i.name===o||s&&s.name===o)&&(this.dirtyStartControl=!0,this.startControlLockTo.includes("path")&&(this.currentStartControlPathData=!1)),(n&&n.name===o||r&&r.name===o)&&(this.dirtyEndControl=!0,this.endControlLockTo.includes("path")&&(this.currentEndControlPathData=!1)),(t&&t.name===o||e&&e.name===o)&&(this.dirtyEnd=!0,this.endLockTo.includes("path")&&(this.currentEndPathData=!1))}),this.dirtyPins.length=0};O.Bezier=Bezier;const Cog=function(t={}){return this.shapeInit(t),this};let Cs=Cog.prototype=Object.create(Object.prototype);Cs.type="Cog",Cs.lib="entity",Cs.isArtefact=!0,Cs.isAsset=!1,Cs=ee(Cs),Cs=Os(Cs);Cs.defs=_(Cs.defs,{outerRadius:0,innerRadius:0,outerControlsDistance:0,innerControlsDistance:0,outerControlsOffset:0,innerControlsOffset:0,points:0,twist:0,curve:"bezier"});let Ds=Cs.setters,Rs=Cs.deltaSetters;Ds.outerRadius=function(t){this.outerRadius=t,this.updateDirty()},Rs.outerRadius=function(t){this.outerRadius+=t,this.updateDirty()},Ds.innerRadius=function(t){this.innerRadius=t,this.updateDirty()},Rs.innerRadius=function(t){this.innerRadius+=t,this.updateDirty()},Ds.outerControlsDistance=function(t){this.outerControlsDistance=t,this.updateDirty()},Rs.outerControlsDistance=function(t){this.outerControlsDistance+=t,this.updateDirty()},Ds.innerControlsDistance=function(t){this.innerControlsDistance=t,this.updateDirty()},Rs.innerControlsDistance=function(t){this.innerControlsDistance+=t,this.updateDirty()},Ds.outerControlsOffset=function(t){this.outerControlsOffset=t,this.updateDirty()},Rs.outerControlsOffset=function(t){this.outerControlsOffset+=t,this.updateDirty()},Ds.innerControlsOffset=function(t){this.innerControlsOffset=t,this.updateDirty()},Rs.innerControlsOffset=function(t){this.innerControlsOffset+=t,this.updateDirty()},Ds.points=function(t){this.points=t,this.updateDirty()},Rs.points=function(t){this.points+=t,this.updateDirty()},Ds.twist=function(t){this.twist=t,this.updateDirty()},Rs.twist=function(t){this.twist+=t,this.updateDirty()},Ds.curve=function(t){t&&["line","quadratic","bezier"].indexOf(t)>=0?(this.curve=t,this.updateDirty()):(this.curve="bezier",this.updateDirty())},Cs.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeCogPath(),this.pathDefinition=t},Cs.makeCogPath=function(){let t,e,i,s,n,r,o,{points:a,twist:l,outerRadius:h,innerRadius:c,outerControlsDistance:u,innerControlsDistance:d,outerControlsOffset:f,innerControlsOffset:p,curve:m}=this,g=360/a,y=[],b="";if(h.substring||c.substring||u.substring||d.substring||f.substring||p.substring){let t=this.getHost();if(t){let[e,i]=t.currentDimensions;h=h.substring?parseFloat(h)/100*e:h,c=c.substring?parseFloat(c)/100*e:c,u=u.substring?parseFloat(u)/100*e:u,d=d.substring?parseFloat(d)/100*e:d,f=f.substring?parseFloat(f)/100*e:f,p=p.substring?parseFloat(p)/100*e:p}}let k=fi({x:0,y:-h}),S=fi({x:0,y:-c}),O=fi({x:u+f,y:-h}),P=fi({x:-d+p,y:-c}),v=fi({x:d+p,y:-c}),w=fi({x:-u+f,y:-h});if(P.rotate(-g/2),P.rotate(l),S.rotate(-g/2),S.rotate(l),v.rotate(-g/2),v.rotate(l),t=k.x,e=k.y,y.push(t),"bezier"==m)for(o=0;o<a;o++)i=parseFloat((O.x-t).toFixed(1)),s=parseFloat((O.y-e).toFixed(1)),b+=`${i},${s} `,P.rotate(g),S.rotate(g),v.rotate(g),i=parseFloat((P.x-t).toFixed(1)),s=parseFloat((P.y-e).toFixed(1)),b+=`${i},${s} `,i=parseFloat((S.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((S.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,i=parseFloat((v.x-t).toFixed(1)),s=parseFloat((v.y-e).toFixed(1)),b+=`${i},${s} `,w.rotate(g),k.rotate(g),O.rotate(g),i=parseFloat((w.x-t).toFixed(1)),s=parseFloat((w.y-e).toFixed(1)),b+=`${i},${s} `,i=parseFloat((k.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((k.y-e).toFixed(1)),e+=s,b+=`${i},${s} `;else if("quadratic"==m)for(o=0;o<a;o++)i=parseFloat((O.x-t).toFixed(1)),s=parseFloat((O.y-e).toFixed(1)),b+=`${i},${s} `,S.rotate(g),v.rotate(g),i=parseFloat((S.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((S.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,i=parseFloat((v.x-t).toFixed(1)),s=parseFloat((v.y-e).toFixed(1)),b+=`${i},${s} `,k.rotate(g),O.rotate(g),i=parseFloat((k.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((k.y-e).toFixed(1)),e+=s,b+=`${i},${s} `;else for(o=0;o<a;o++)i=parseFloat((O.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((O.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,P.rotate(g),S.rotate(g),v.rotate(g),i=parseFloat((P.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((P.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,i=parseFloat((S.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((S.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,i=parseFloat((v.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((v.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,w.rotate(g),k.rotate(g),O.rotate(g),i=parseFloat((w.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((w.y-e).toFixed(1)),e+=s,b+=`${i},${s} `,i=parseFloat((k.x-t).toFixed(1)),t+=i,y.push(t),s=parseFloat((k.y-e).toFixed(1)),e+=s,b+=`${i},${s} `;return pi(k),n=Math.min(...y),r=Math.abs(n).toFixed(1),"bezier"==m?`m${r},0c${b}z`:"quadratic"==m?`m${r},0q${b}z`:`m${r},0l${b}z`};O.Cog=Cog;const Color=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),J(t.color)&&this.convert(t.color),t.random&&this.generateRandomColor(t),this.checkValues(),this};let Es=Color.prototype=Object.create(Object.prototype);Es.type="Color",Es.lib="styles",Es.isArtefact=!1,Es.isAsset=!1,Es=ee(Es);Es.defs=_(Es.defs,{r:0,g:0,b:0,a:1,rMax:255,gMax:255,bMax:255,aMax:1,rMin:0,gMin:0,bMin:0,aMin:0,rShift:0,gShift:0,bShift:0,aShift:0,rBounce:!1,gBounce:!1,bBounce:!1,aBounce:!1,opaque:!0,autoUpdate:!1,easing:"linear"}),Es.kill=function(){let t=this.name;return Object.entries(h).forEach(([e,i])=>{let s=i.state;if(s){let e=s.fillStyle,i=s.strokeStyle;U(e)&&e.name===t&&(s.fillStyle=s.defs.fillStyle),U(i)&&i.name===t&&(s.strokeStyle=s.defs.strokeStyle)}}),this.deregister(),this},Es.get=function(t){if(J(t)){if("random"===t)return this.generateRandomColor(),this.get();if(t.toFixed)return this.getRangeColor(t);{let e=this.getters[t];if(e)return e.call(this);{let e=this.defs[t];if(void 0!==e){let i=this[t];return void 0!==i?i:e}return undef}}}{let{r:t,g:e,b:i,a:s}=this;return this.opaque?`rgb(${t}, ${e}, ${i})`:`rgba(${t}, ${e}, ${i}, ${s})`}},Es.set=function(t={}){if(Object.keys(t).length){let e,i=this.setters,s=this.defs;Object.entries(t).forEach(([t,n])=>{"name"!==t&&(e=i[t],e?e.call(this,n):void 0!==s[t]&&(this[t]=n))},this)}return t.random?this.generateRandomColor(t):this.checkValues(),this};let Fs=Es.setters;Fs.color=function(t){this.convert(t)},Es.setColor=function(t){return this.convert(t),this},Fs.minimumColor=function(t){let{r:e,g:i,b:s,a:n}=this;this.convert(t),this.rMin=this.r,this.gMin=this.g,this.bMin=this.b,this.aMin=this.a,this.r=e,this.g=i,this.b=s,this.a=n},Es.setMinimumColor=function(t){let{r:e,g:i,b:s,a:n}=this;return this.convert(t),this.rMin=this.r,this.gMin=this.g,this.bMin=this.b,this.aMin=this.a,this.r=e,this.g=i,this.b=s,this.a=n,this},Fs.maximumColor=function(t){let{r:e,g:i,b:s,a:n}=this;this.convert(t),this.rMax=this.r,this.gMax=this.g,this.bMax=this.b,this.aMax=this.a,this.r=e,this.g=i,this.b=s,this.a=n},Es.setMaximumColor=function(t){let{r:e,g:i,b:s,a:n}=this;return this.convert(t),this.rMax=this.r,this.gMax=this.g,this.bMax=this.b,this.aMax=this.a,this.r=e,this.g=i,this.b=s,this.a=n,this},Es.getData=function(){return this.autoUpdate&&this.update(),this.checkValues(),this.get()},Es.generateRandomColor=function(t={}){let e=Math.round,i=Math.random,s=this.rMax=et(t.rMax,this.rMax,255),n=this.gMax=et(t.gMax,this.gMax,255),r=this.bMax=et(t.bMax,this.bMax,255),o=this.rMin=et(t.rMin,this.rMin,0),a=this.gMin=et(t.gMin,this.gMin,0),l=this.bMin=et(t.bMin,this.bMin,0);return this.r=t.r||e(i()*(s-o)+o),this.g=t.g||e(i()*(n-a)+a),this.b=t.b||e(i()*(r-l)+l),this.opaque||(aMax=this.aMax=et(t.aMax,this.aMax,1),aMin=this.aMin=et(t.aMin,this.aMin,0),this.a=t.a||i()*(aMax-aMin)+aMin),this.checkValues(),this},Es.getRangeColor=function(t){if(J(t)&&t.toFixed){let e=Math.floor,{rMin:i,gMin:s,bMin:n,aMin:r,rMax:o,gMax:a,bMax:l,aMax:h,easing:c}=this;if("linear"!==c)switch(c){case"easeOutSine":t=rt(t);break;case"easeInSine":t=ot(t);break;case"easeOutInSine":t=at(t);break;case"easeOutQuad":t=lt(t);break;case"easeInQuad":t=ht(t);break;case"easeOutInQuad":t=ct(t);break;case"easeOutCubic":t=ut(t);break;case"easeInCubic":t=dt(t);break;case"easeOutInCubic":t=ft(t);break;case"easeOutQuart":t=pt(t);break;case"easeInQuart":t=mt(t);break;case"easeOutInQuart":t=gt(t);break;case"easeOutQuint":t=yt(t);break;case"easeInQuint":t=bt(t);break;case"easeOutInQuint":t=kt(t);break;case"easeOutExpo":t=St(t);break;case"easeInExpo":t=Ot(t);break;case"easeOutInExpo":t=Pt(t);break;case"easeOutCirc":t=vt(t);break;case"easeInCirc":t=wt(t);break;case"easeOutInCirc":t=At(t);break;case"easeOutBack":t=Ct(t);break;case"easeInBack":t=Dt(t);break;case"easeOutInBack":t=Rt(t);break;case"easeOutElastic":t=Et(t);break;case"easeInElastic":t=Ft(t);break;case"easeOutInElastic":t=Tt(t);break;case"easeOutBounce":t=Ht(t);break;case"easeInBounce":t=Mt(t);break;case"easeOutInBounce":t=It(t)}t>1?t=1:t<0&&(t=0),isNaN(t)&&(t=1);let u=e(i+(o-i)*t),d=e(s+(a-s)*t),f=e(n+(l-n)*t),p=e(r+(h-r)*t);return this.opaque?`rgb(${u}, ${d}, ${f})`:`rgba(${u}, ${d}, ${f}, ${p})`}{let{r:t,g:e,b:i,a:s}=this;return this.opaque?`rgb(${t}, ${e}, ${i})`:`rgba(${t}, ${e}, ${i}, ${s})`}},Es.checkValues=function(){let t=Math.floor,e=t(this.r)||0,i=t(this.g)||0,s=t(this.b)||0,n=this.a;return this.r=e>255?255:e<0?0:e,this.g=i>255?255:i<0?0:i,this.b=s>255?255:s<0?0:s,this.a=n>1?1:n<0?0:n,this},Es.updateArray=["r","g","b","a"],Es.update=function(){J(this.rCurrent)||(this.rCurrent=this.r),J(this.gCurrent)||(this.gCurrent=this.g),J(this.bCurrent)||(this.bCurrent=this.b),J(this.aCurrent)||(this.aCurrent=this.a);let t=this.updateArray;return(this.rShift||this.gShift||this.bShift||this.aShift)&&t.forEach(t=>{let e=this[t+"Shift"];if(e){this[t+"Current"]+=e;let i=this[t],s=this[t+"Min"],n=this[t+"Max"],r=this[t+"Bounce"],o=this[t+"Current"],a=Math.floor(o+e);(a>n||a<s)&&(r?e=-e:(i=i>(n+s)/2?n:s,e=0)),this[t]=a,this[t+"Shift"]=e}},this),this},Es.updateByDelta=Es.update,Es.convert=function(t){let e,i,s,n,r,o=Math.round;return(t=t.substring?t:"").length&&(t.toLowerCase(),e=0,i=0,s=0,n=1,"#"===t[0]?4==t.length?(e=parseInt(t[1]+t[1],16),i=parseInt(t[2]+t[2],16),s=parseInt(t[3]+t[3],16)):5==t.length?(e=parseInt(t[1]+t[1],16),i=parseInt(t[2]+t[2],16),s=parseInt(t[3]+t[3],16),n=parseInt(t[4]+t[4],16)/255):7==t.length?(e=parseInt(t[1]+t[2],16),i=parseInt(t[3]+t[4],16),s=parseInt(t[5]+t[6],16)):9==t.length&&(e=parseInt(t[1]+t[2],16),i=parseInt(t[3]+t[4],16),s=parseInt(t[5]+t[6],16),n=parseInt(t[7]+t[8],16)/255):/rgb\(/.test(t)?(r=t.match(/([0-9.]+\b)/g),/%/.test(t)?(e=o(parseFloat(r[0])/100*255),i=o(parseFloat(r[1])/100*255),s=o(parseFloat(r[2])/100*255)):(e=o(parseFloat(r[0])),i=o(parseFloat(r[1])),s=o(parseFloat(r[2])))):/rgba\(/.test(t)?(r=t.match(/([0-9.]+\b)/g),/%/.test(t)?(e=o(parseFloat(r[0])/100*255),i=o(parseFloat(r[1])/100*255),s=o(parseFloat(r[2])/100*255),n=parseFloat(r[3])/100):(e=o(parseFloat(r[0])),i=o(parseFloat(r[1])),s=o(parseFloat(r[2])),n=r[3])):/hsl\(/.test(t)||/hsla\(/.test(t)?(r=t.match(/([0-9.]+\b)/g),this.setFromHSL(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3]))):"transparent"===t?(e=0,i=0,s=0,n=0):(r=this.colorLibrary[t],r&&(e=parseInt(r[0]+r[1],16),i=parseInt(r[2]+r[3],16),s=parseInt(r[4]+r[5],16),n=1)),this.r=e,this.g=i,this.b=s,this.a=n,this.checkValues()),this},Es.getHSLfromRGB=function(t,e,i){let s=Math.min(t,e,i),n=Math.max(t,e,i),r=(s+n)/2,o=0;s!==n&&(o=r<=.5?(n-s)/(n+s):(n-s)/(2-n-s));let a=0;return a=n===t?(e-i)/(n-s):n===e?2+(i-t)/(n-s):4+(t-e)/(n-s),a*=60,a<0&&(a+=360),[a,o,r]},Es.getHSL=function(){let{r:t,g:e,b:i}=this,s=Math.min(t,e,i),n=Math.max(t,e,i),r=(s+n)/2,o=0;s!==n&&(o=r<=.5?(n-s)/(n+s):(n-s)/(2-n-s));let a=0;return a=n===t?(e-i)/(n-s):n===e?2+(i-t)/(n-s):4+(t-e)/(n-s),a*=60,a<0&&(a+=360),[a,o,r]},Es.getRGBfromHSL=function(t,e,i,s){if(!e){let t=Math.floor(255*i);return[t,t,t]}let n=i<.5?i*(e+1):i+e-i*e,r=2*i-n;const o=function(t,e,i){return 6*t<1?i+6*(e-i)*t:2*t<1?e:2*t<2?i+6*(e-i)*(.666*t):i};let a=(t/=360)+.333,l=t,h=t-.333;a<0&&(a+=1),a>1&&(a-=1),l<0&&(l+=1),l>1&&(l-=1),h<0&&(h+=1),h>1&&(h-=1);let c=255*o(a,n,r),u=255*o(l,n,r),d=255*o(h,n,r);return null==s?[c,u,d]:[c,u,d,255*s]},Es.setFromHSL=function(t,e,i,s){if(!e){let t=Math.floor(255*i);return[t,t,t]}let n=i<.5?i*(e+1):i+e-i*e,r=2*i-n;const o=function(t,e,i){return 6*t<1?i+6*(e-i)*t:2*t<1?e:2*t<2?i+6*(e-i)*(.666*t):i};let a=(t/=360)+.333,l=t,h=t-.333;a<0&&(a+=1),a>1&&(a-=1),l<0&&(l+=1),l>1&&(l-=1),h<0&&(h+=1),h>1&&(h-=1),this.r=255*o(a,n,r),this.g=255*o(l,n,r),this.b=255*o(h,n,r),null!=s&&(this.a=255*s)},Es.colorLibrary={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffe4c4",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};const Ts=function(t){return new Color(t)};O.Color=Color;const ParticleHistory=function(t){let e=[];return Object.setPrototypeOf(e,ParticleHistory.prototype),t&&e.set(t),e};let Hs=ParticleHistory.prototype=Object.create(Array.prototype);Hs.constructor=ParticleHistory,Hs.type="ParticleHistory";const Ms=[],Is=function(t){t&&"ParticleHistory"===t.type&&(t.length=0,Ms.push(t),Ms.length>100&&(Ms.length=0))};O.ParticleHistory=ParticleHistory;const Particle=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.initializePositions(),this.set(t),this};let Bs=Particle.prototype=Object.create(Object.prototype);Bs.type="Particle",Bs.lib="particle",Bs.isArtefact=!1,Bs.isAsset=!1,Bs=ee(Bs);Bs.defs=_(Bs.defs,{position:null,velocity:null,load:null,history:null,historyLength:1,engine:"euler",forces:null,mass:1,fill:"#000000",stroke:"#000000"}),Bs.packetExclusions=Q(Bs.packetExclusions,[]),Bs.packetExclusionsByRegex=Q(Bs.packetExclusionsByRegex,["^(local|dirty|current)"]),Bs.packetCoordinates=Q(Bs.packetCoordinates,[]),Bs.packetObjects=Q(Bs.packetObjects,["position","velocity","acceleration"]),Bs.packetFunctions=Q(Bs.packetFunctions,[]),Bs.factoryKill=function(){this.history.forEach(t=>Is(t));let t=[];m.forEach(e=>{let i=p[e];(i.particleFrom&&i.particleFrom.name===this.name||i.particleTo&&i.particleTo.name===this.name)&&t.push[i]}),t.forEach(t=>t.kill())};let Ls=Bs.getters,$s=Bs.setters,js=Bs.deltaSetters;Ls.positionX=function(){return this.position.x},Ls.positionY=function(){return this.position.y},Ls.positionZ=function(){return this.position.z},Ls.position=function(){let t=this.position;return[t.x,t.y,t.z]},$s.positionX=function(t){this.position.x=t},$s.positionY=function(t){this.position.y=t},$s.positionZ=function(t){this.position.z=t},$s.position=function(t){this.position.set(t)},js.positionX=function(t){this.position.x+=t},js.positionY=function(t){this.position.y+=t},js.positionZ=function(t){this.position.z+=t},js.position=B,Ls.velocityX=function(){return this.velocity.x},Ls.velocityY=function(){return this.velocity.y},Ls.velocityZ=function(){return this.velocity.z},Ls.velocity=function(){let t=this.velocity;return[t.x,t.y,t.z]},$s.velocityX=function(t){this.velocity.x=t},$s.velocityY=function(t){this.velocity.y=t},$s.velocityZ=function(t){this.velocity.z=t},$s.velocity=function(t,e,i){this.velocity.set(t,e,i)},js.velocityX=function(t){this.velocity.x+=t},js.velocityY=function(t){this.velocity.y+=t},js.velocityZ=function(t){this.velocity.z+=t},js.velocity=B,$s.forces=function(t){t&&(Array.isArray(t)?(this.forces.length=0,this.forces=this.forces.concat(t)):this.forces.push(t))},$s.load=B,$s.history=B,js.load=B,Bs.initializePositions=function(){this.initialPosition=mi(),this.position=mi(),this.velocity=mi(),this.load=mi(),this.forces=[],this.history=[],this.isRunning=!1},Bs.applyForces=function(t,e){this.load.zero(),this.isBeingDragged||this.forces.forEach(i=>{let s=f[i];s&&s.action&&s.action(this,t,e)})},Bs.update=function(t,e){this.isBeingDragged?this.position.setFromVector(this.isBeingDragged).vectorAdd(this.dragOffset):Gs[this.engine].call(this,t*e.tickMultiplier)},Bs.manageHistory=function(t,e){let{history:i,remainingTime:s,position:n,historyLength:r,hasLifetime:o,distanceLimit:a,initialPosition:l,killBeyondCanvas:h}=this,c=!0,u=0;if(o)if(u=s-t,u<=0){let t=i.pop();Is(t),c=!1,i.length||(this.isRunning=!1)}else this.remainingTime=u;let d=i[i.length-1];if(d){let[t,i,s,n]=d;if(h){let t=e.element.width,i=e.element.height;(s<0||n<0||s>t||n>i)&&(c=!1,this.isRunning=!1)}if(a){let t=fi(l);t.vectorSubtractArray([s,n,i]),t.getMagnitude()>a&&(c=!1,this.isRunning=!1),pi(t)}}if(c){let{x:t,y:e,z:s}=n,o=(Ms.length||Ms.push(new ParticleHistory),Ms.shift());if(o.push(u,s,t,e),i.unshift(o),i.length>r){i.splice(r).forEach(t=>Is(t))}}},Bs.run=function(t,e,i){this.hasLifetime=!1,t&&(this.remainingTime=t,this.hasLifetime=!0),this.distanceLimit=0,e&&(this.initialPosition.set(this.position),this.distanceLimit=e),this.killBeyondCanvas=i,this.isRunning=!0};const Ns=function(t){return new Particle(t)};O.Particle=Particle;const Xs=[],Ys=function(t){Xs.length||Xs.push(new Particle);let e=Xs.shift();return e.set(t),e},zs=function(t){if(t&&"Particle"===t.type&&(t.history.forEach(t=>Is(t)),t.history.length=0,t.set(t.defs),Xs.push(t),Xs.length>50)){let t=[].concat(Xs);Xs.length=0,t.forEach(t=>t.kill())}},Gs={euler:function(t){let{position:e,velocity:i,load:s,mass:n}=this,r=fi(),o=fi(i);r.setFromVector(s).scalarDivide(n),o.vectorAdd(r.scalarMultiply(t)),i.setFromVector(o),e.vectorAdd(o.scalarMultiply(t)),pi(r)},"improved-euler":function(t){let{position:e,velocity:i,load:s,mass:n}=this,r=fi(),o=fi(),a=fi(),l=fi(i);r.setFromVector(s).scalarDivide(n).scalarMultiply(t),o.setFromVector(s).vectorAdd(r).scalarDivide(n).scalarMultiply(t),a.setFromVector(r).vectorAdd(o).scalarDivide(2),l.vectorAdd(a),i.setFromVector(l),e.vectorAdd(l.scalarMultiply(t)),pi(r)},"runge-kutta":function(t){let{position:e,velocity:i,load:s,mass:n}=this,r=fi(),o=fi(),a=fi(),l=fi(),h=fi(),c=fi(i);r.setFromVector(s).scalarDivide(n).scalarMultiply(t).scalarDivide(2),o.setFromVector(s).vectorAdd(r).scalarDivide(n).scalarMultiply(t).scalarDivide(2),a.setFromVector(s).vectorAdd(o).scalarDivide(n).scalarMultiply(t).scalarDivide(2),l.setFromVector(s).vectorAdd(a).scalarDivide(n).scalarMultiply(t).scalarDivide(2),o.scalarMultiply(2),a.scalarMultiply(2),h.setFromVector(r).vectorAdd(o).vectorAdd(a).vectorAdd(l).scalarDivide(6),c.vectorAdd(h),i.setFromVector(c),e.vectorAdd(c.scalarMultiply(t)),pi(r)}},Emitter=function(t={}){return this.makeName(t.name),this.register(),this.initializePositions(),this.set(this.defs),this.onEnter=B,this.onLeave=B,this.onDown=B,this.onUp=B,this.fillColorFactory=Ts({name:this.name+"-fillColorFactory"}),this.strokeColorFactory=Ts({name:this.name+"-strokeColorFactory"}),this.range=mi(),this.rangeFrom=mi(),this.preAction=B,this.stampAction=B,this.postAction=B,this.particleStore=[],this.deadParticles=[],this.liveParticles=[],t.group||(t.group=Gi),this.set(t),this.purge&&this.purgeArtefact(this.purge),this};let Ws=Emitter.prototype=Object.create(Object.prototype);Ws.type="Emitter",Ws.lib="entity",Ws.isArtefact=!0,Ws.isAsset=!1,Ws=ee(Ws),Ws=ps(Ws);Ws.defs=_(Ws.defs,{world:null,artefact:null,range:null,rangeFrom:null,generationRate:0,particleCount:0,generateAlongPath:!1,generateInArea:!1,generateFromExistingParticles:!1,generateFromExistingParticleHistories:!1,limitDirectionToAngleMultiples:0,generationChoke:15,killAfterTime:0,killAfterTimeVariation:0,killRadius:0,killRadiusVariation:0,killBeyondCanvas:!1,historyLength:1,forces:null,mass:1,massVariation:0,engine:"euler",hitRadius:10,showHitRadius:!1,hitRadiusColor:"#000000",resetAfterBlur:3}),Ws.packetExclusions=Q(Ws.packetExclusions,["forces","particleStore","deadParticles","liveParticles","fillColorFactory","strokeColorFactory"]),Ws.packetExclusionsByRegex=Q(Ws.packetExclusionsByRegex,[]),Ws.packetCoordinates=Q(Ws.packetCoordinates,[]),Ws.packetObjects=Q(Ws.packetObjects,["world","artefact","generateInArea","generateAlongPath"]),Ws.packetFunctions=Q(Ws.packetFunctions,["preAction","stampAction","postAction"]),Ws.finalizePacketOut=function(t,e){let i=e.forces||this.forces||!1;if(i){let e=[];i.forEach(t=>{t.substring?e.push(t):U(t)&&t.name&&e.push(t.name)}),t.forces=e}let s=[];return this.particleStore.forEach(t=>s.push(t.saveAsPacket())),t.particleStore=s,t},Ws.postCloneAction=function(t,e){return t},Ws.factoryKill=function(t,e){this.isRunning=!1,t&&this.artefact.kill(),e&&this.world.kill(),this.fillColorFactory.kill(),this.strokeColorFactory.kill(),this.deadParticles.forEach(t=>t.kill()),this.liveParticles.forEach(t=>t.kill()),this.particleStore.forEach(t=>t.kill())};Ws.getters;let Vs=Ws.setters,Us=Ws.deltaSetters;Vs.rangeX=function(t){this.range.x=t},Vs.rangeY=function(t){this.range.y=t},Vs.rangeZ=function(t){this.range.z=t},Vs.range=function(t){this.range.set(t)},Vs.rangeFromX=function(t){this.rangeFrom.x=t},Vs.rangeFromY=function(t){this.rangeFrom.y=t},Vs.rangeFromZ=function(t){this.rangeFrom.z=t},Vs.rangeFrom=function(t){this.rangeFrom.set(t)},Vs.preAction=function(t){W(t)&&(this.preAction=t)},Vs.stampAction=function(t){W(t)&&(this.stampAction=t)},Vs.postAction=function(t){W(t)&&(this.postAction=t)},Vs.world=function(t){let e;t.substring?e=g[t]:U(t)&&"World"===t.type&&(e=t),e&&(this.world=e)},Vs.artefact=function(t){let e;t.substring?e=i[t]:U(t)&&t.isArtefact&&(e=t),e&&(this.artefact=e)},Vs.generateAlongPath=function(t){let e;t.substring?e=i[t]:U(t)&&t.isArtefact&&(e=t),e&&e.useAsPath?this.generateAlongPath=e:this.generateAlongPath=!1},Vs.generateInArea=function(t){let e;t.substring?e=i[t]:U(t)&&t.isArtefact&&(e=t),this.generateInArea=e||!1},Vs.fillColor=function(t){this.fillColorFactory.set({color:t})},Vs.fillMinimumColor=function(t){this.fillColorFactory.set({minimumColor:t})},Vs.fillMaximumColor=function(t){this.fillColorFactory.set({maximumColor:t})},Vs.strokeColor=function(t){this.strokeColorFactory.set({color:t})},Vs.strokeMinimumColor=function(t){this.strokeColorFactory.set({minimumColor:t})},Vs.strokeMaximumColor=function(t){this.strokeColorFactory.set({maximumColor:t})},Vs.hitRadius=function(t){t.toFixed&&(this.hitRadius=t,this.width=this.height=2*t)},Us.hitRadius=function(t){t.toFixed&&(this.hitRadius+=t,this.width=this.height=2*this.hitRadius)},Vs.width=function(t){t.toFixed&&(this.hitRadius=t/2,this.width=this.height=t)},Us.width=function(t){t.toFixed&&(this.hitRadius=t/2,this.width=this.height=t)},Vs.height=Vs.width,Us.height=Us.width,Ws.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1,this.dirtyDimensions=!0),(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle)&&(this.dirtyPathObject=!0),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions();let t=Date.now(),{particleStore:e,deadParticles:i,liveParticles:s,particleCount:n,generationRate:r,generatorChoke:o,resetAfterBlur:a}=this;o||(this.generatorChoke=o=t),e.forEach(t=>{t.isRunning?s.push(t):i.push(t)}),e.length=0,i.forEach(t=>zs(t)),i.length=0,e.push(...s),s.length=0;let l=t-o;if(l/1e3>a&&(l=0,this.generatorChoke=t),l>0&&r){let i=Math.floor(r/1e3*l);if(n){let t=n-e.length;t<=0?i=0:t<i&&(i=t)}i&&(this.addParticles(i),this.generatorChoke=t)}},Ws.addParticles=function(t){const e=Math.random,i=function(t,i){return t+(e()*i*2-i)},s=function(t,i){return t+e()*i};let n,r,o,a,l=Date.now(),{historyLength:h,engine:c,forces:u,mass:d,massVariation:f,fillColorFactory:p,strokeColorFactory:m,range:g,rangeFrom:y,currentStampPosition:b,particleStore:k,killAfterTime:S,killAfterTimeVariation:O,killRadius:P,killRadiusVariation:v,killBeyondCanvas:w,currentRotation:x,generateAlongPath:A,generateInArea:C,generateFromExistingParticles:D,generateFromExistingParticleHistories:R,limitDirectionToAngleMultiples:E,generationChoke:F}=this,{x:T,y:H,z:M}=g,{x:I,y:B,z:L}=y;if(C){let g=this.currentHost;if(g){const y=g.element,{width:b,height:x}=y;C.pathObject&&!C.dirtyPathObject||C.cleanPathObject();const A=ni(),D=A.engine,R=Fe();let{pathObject:E,winding:$,currentStart:j}=C;[o,a]=j;const N=t=>D.isPointInPath(E,...t,$);A.rotateDestination(D,o,a,C);t:for(n=0;n<t;n++){let t=!1;for(;!t;){if(l+F<Date.now())break t;R.set(e()*b,e()*x),N(R)&&(t=!0)}r=Ys(),r.set({positionX:R[0],positionY:R[1],positionZ:0,velocityX:s(I,T),velocityY:s(B,H),velocityZ:s(L,M),historyLength:h,engine:c,forces:u,mass:i(d,f),fill:p.get("random"),stroke:m.get("random")});let n=Math.abs(i(S,O)),o=Math.abs(i(P,v));r.run(n,o,w),k.push(r)}ri(A),Te(R)}}else if(A){if(A.useAsPath){A.pathObject&&!A.dirtyPathObject||A.cleanPathObject();t:for(n=0;n<t;n++){let t=!1,n=!1;for(;!n;){if(l+F<Date.now())break t;t=A.getPathPositionData(e(),!0),t&&(n=!0)}r=Ys(),r.set({positionX:t.x,positionY:t.y,positionZ:0,velocityX:s(I,T),velocityY:s(B,H),velocityZ:s(L,M),historyLength:h,engine:c,forces:u,mass:i(d,f),fill:p.get("random"),stroke:m.get("random")});let o=Math.abs(i(S,O)),a=Math.abs(i(P,v));r.run(o,a,w),k.push(r)}}}else if(R){let e,o,a,l,g,y,A=k.length,C=fi();for(n=0;n<t;n++){A?(o=k[Math.floor(Math.random()*A)],a=o.history,a&&a.length>1?([l,g,...y]=a[Math.floor(Math.random()*a.length)],y?C.setFromArray(y):C.setFromVector(o.position)):C.setFromVector(o.position)):C.setFromArray(b),r=Ys(),r.set({positionX:C.x,positionY:C.y,positionZ:C.z,historyLength:h,engine:c,forces:u,mass:i(d,f),fill:p.get("random"),stroke:m.get("random")}),E?(C.zero(),e=Math.floor(360/E),C.x=s(I,T),C.rotate(Math.floor(Math.random()*e)*E),r.set({velocityX:C.x,velocityY:C.y,velocityZ:s(L,M)})):r.set({velocityX:s(I,T),velocityY:s(B,H),velocityZ:s(L,M)}),pi(C),r.velocity.rotate(x);let t=Math.abs(i(S,O)),n=Math.abs(i(P,v));r.run(t,n,w),k.push(r)}}else if(D){let e,o,a=k.length,l=fi();for(n=0;n<t;n++){a?(o=k[Math.floor(Math.random()*a)],l.setFromVector(o.position)):l.setFromArray(b),r=Ys(),r.set({positionX:l.x,positionY:l.y,positionZ:l.z,historyLength:h,engine:c,forces:u,mass:i(d,f),fill:p.get("random"),stroke:m.get("random")}),E?(l.zero(),e=Math.floor(360/E),l.x=s(I,T),l.rotate(Math.floor(Math.random()*e)*E),r.set({velocityX:l.x,velocityY:l.y,velocityZ:s(L,M)})):r.set({velocityX:s(I,T),velocityY:s(B,H),velocityZ:s(L,M)}),pi(l),r.velocity.rotate(x);let t=Math.abs(i(S,O)),n=Math.abs(i(P,v));r.run(t,n,w),k.push(r)}}else for([o,a]=b,n=0;n<t;n++){r=Ys(),r.set({positionX:o,positionY:a,positionZ:0,velocityX:s(I,T),velocityY:s(B,H),velocityZ:s(L,M),historyLength:h,engine:c,forces:u,mass:i(d,f),fill:p.get("random"),stroke:m.get("random")}),r.velocity.rotate(x);let t=Math.abs(i(S,O)),e=Math.abs(i(P,v));r.run(t,e,w),k.push(r)}},Ws.regularStampSynchronousActions=function(){let{world:t,artefact:e,particleStore:i,preAction:s,stampAction:n,postAction:r,lastUpdated:o,resetAfterBlur:a,showHitRadius:l,hitRadius:h,hitRadiusColor:c,currentStampPosition:u}=this,d=this.currentHost,f=.016,p=Date.now();if(o&&(f=(p-o)/1e3),f>a&&(i.forEach(t=>zs(t)),i.length=0,f=.016),i.forEach(e=>e.applyForces(t,d)),i.forEach(e=>e.update(f,t)),s.call(this,d),i.forEach(t=>{t.manageHistory(f,d),n.call(this,e,t,d)}),r.call(this,d),l){let t=d.engine;t.save(),t.lineWidth=1,t.strokeStyle=c,t.setTransform(1,0,0,1,0,0),t.beginPath(),t.arc(u[0],u[1],h,0,2*Math.PI),t.stroke(),t.restore()}this.lastUpdated=p},Ws.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;let i,s,n=Array.isArray(t)?t:[t],r=this.currentStampPosition,o=!1;if(n.some(t=>{if(Array.isArray(t))i=t[0],s=t[1];else{if(!tt(t,t.x,t.y))return!1;i=t.x,s=t.y}if(!i.toFixed||!s.toFixed||isNaN(i)||isNaN(s))return!1;let e=fi(r).vectorSubtract(t);return e.getMagnitude()<this.hitRadius&&(o=!0),pi(e),o},this)){return this.checkHitReturn(i,s,e)}return!1};O.Emitter=Emitter;const Force=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.action||(this.action=B),this};let qs=Force.prototype=Object.create(Object.prototype);qs.type="Force",qs.lib="force",qs.isArtefact=!1,qs.isAsset=!1,qs=ee(qs);qs.defs=_(qs.defs,{action:null}),qs.packetFunctions=Q(qs.packetFunctions,["action"]),qs.kill=function(){return this.deregister(),!0},qs.setters.action=function(t){W(t)?this.action=t:this.action=B};const _s=function(t){return new Force(t)};O.Force=Force,_s({name:"gravity",action:(t,e,i)=>{let{mass:s,load:n}=t,r=fi();r.setFromVector(e.gravity).scalarMultiply(s),n.vectorAdd(r),pi(r)}});const Palette=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.colors=t.colors||{"0 ":[0,0,0,1],"999 ":[255,255,255,1]},this.stops=Array(1e3),this.set(t),this.dirtyPalette=!0,this};let Zs=Palette.prototype=Object.create(Object.prototype);Zs.type="Palette",Zs.lib="palette",Zs.isArtefact=!1,Zs.isAsset=!1,Zs=ee(Zs);Zs.defs=_(Zs.defs,{colors:null,stops:null,cyclic:!1}),Zs.packetExclusions=Q(Zs.packetExclusions,["stops"]);Zs.getters;let Qs=Zs.setters;Qs.colors=function(t){if(U(t)){let e=this.factory;Object.entries(t).forEach(([i,s])=>{s.substring&&(e.convert(s),t[i]=[e.r,e.g,e.b,e.a])}),this.colors=t,this.dirtyPalette=!0}},Qs.stops=B,Zs.recalculateHold=[],Zs.recalculate=function(){let t,e,i,s,n,r,o,a,l,h,c,u,d,f,p,m=this.colors,g=this.stops,y=this.makeColorString,b=this.recalculateHold;for(t=Object.keys(m),t=t.map(t=>parseInt(t,10)),t.sort((t,e)=>t-e),g.fill("rgba(0,0,0,0)"),this.dirtyPalette=!1,e=0,i=t.length-1;e<i;e++)for(r=t[e],h=t[e+1],o=h-r,a=m[r+" "],l=m[h+" "],u=(l[0]-a[0])/o,d=(l[1]-a[1])/o,f=(l[2]-a[2])/o,p=(l[3]-a[3])/o,s=0,n=o;s<n;s++)b[0]=a[0]+u*s,b[1]=a[1]+d*s,b[2]=a[2]+f*s,b[3]=a[3]+p*s,g[r]=y(b),r++;if(g[r]=y(l),this.cyclic)for(r=t[t.length-1],h=t[0],o=h+1e3-r,a=m[r+" "],l=m[h+" "],u=(l[0]-a[0])/o,d=(l[1]-a[1])/o,f=(l[2]-a[2])/o,p=(l[3]-a[3])/o,s=0,n=o;s<n;s++)b[0]=a[0]+u*s,b[1]=a[1]+d*s,b[2]=a[2]+f*s,b[3]=a[3]+p*s,g[r]=y(b),r++,r>999&&(r-=1e3);else{if(r=t[0],r>0)for(c=g[r],e=0,i=r;e<i;e++)g[e]=c;if(r=t[t.length-1],r<999)for(c=g[r],e=r,i=1e3;e<i;e++)g[e]=c}},Zs.makeColorString=function(t){let e,i,s,n,r=Math.floor,o=(t,e,i)=>t=(t=t<e?e:t)>i?i:t;return e=o(r(t[0]),0,255),i=o(r(t[1]),0,255),s=o(r(t[2]),0,255),n=o(t[3],0,1),`rgba(${e},${i},${s},${n})`},Zs.updateColor=function(t,e){let i=this.factory;tt(t,e)&&(t=t.substring?parseInt(t,10):Math.floor(t))>=0&&t<=999&&(i.convert(e),t+=" ",this.colors[t]=[i.r,i.g,i.b,i.a],this.dirtyPalette=!0)},Zs.removeColor=function(t){J(t)&&(t=t.substring?parseInt(t,10):Math.floor(t))>=0&&t<=999&&(t+=" ",delete this.colors[t],this.dirtyPalette=!0)},Zs.addStopsToGradient=function(t,e,i,s){let n,r,o,a,l,h,c=this.stops,u=Object.keys(this.colors);if(t){if(u=u.map(t=>parseInt(t,10)),u.sort((t,e)=>t-e),tt(e,i)||(e=0,i=999),e===i)return c[e]||"rgba(0,0,0,0)";if(e<i)for(t.addColorStop(0,c[e]),t.addColorStop(1,c[i]),n=i-e,o=0,a=u.length;o<a;o++)l=u[o],l>e&&l<i&&(r=(l-e)/n,r>0&&r<1&&t.addColorStop(r,c[l]));else if(s)for(t.addColorStop(0,c[e]),t.addColorStop(1,c[i]),h=999-e,n=h+i,o=0,a=u.length;o<a;o++){if(l=u[o],l>e)r=(l-e)/n;else{if(!(l<i))continue;r=(l+h)/n}r>0&&r<1&&t.addColorStop(r,c[l])}else for(t.addColorStop(0,c[e]),t.addColorStop(1,c[i]),n=e-i,o=0,a=u.length;o<a;o++)l=u[o],l<e&&l>i&&(r=1-(l-i)/n,r>0&&r<1&&t.addColorStop(r,c[l]));return t}return"rgba(0,0,0,0)"},Zs.factory=Ts({name:"palette-factory-color-calculator",opaque:!1});function Ks(t={}){t.defs=_(t.defs,{start:null,end:null,palette:null,paletteStart:0,paletteEnd:999,cyclePalette:!1}),t.finalizePacketOut=function(t,e){return e.colors?t.colors=e.colors:this.palette&&this.palette.colors?t.colors=this.palette.colors:t.colors={"0 ":[0,0,0,1],"999 ":[255,255,255,1]},t},t.kill=function(){let t=this.name;return this.palette&&this.palette.kill&&this.palette.kill(),Object.entries(h).forEach(([e,i])=>{let s=i.state;if(s){let e=s.fillStyle,i=s.strokeStyle;U(e)&&e.name===t&&(s.fillStyle=s.defs.fillStyle),U(i)&&i.name===t&&(s.strokeStyle=s.defs.strokeStyle)}}),this.deregister(),this};let e=t.getters,i=t.setters,s=t.deltaSetters;return e.startX=function(){return this.currentStart[0]},e.startY=function(){return this.currentStart[1]},i.startX=function(t){null!=t&&(this.start[0]=t,this.dirtyStart=!0)},i.startY=function(t){null!=t&&(this.start[1]=t,this.dirtyStart=!0)},i.start=function(t,e){this.setCoordinateHelper("start",t,e),this.dirtyStart=!0},s.startX=function(t){let e=this.start;e[0]=H(e[0],t),this.dirtyStart=!0},s.startY=function(t){let e=this.start;e[1]=H(e[1],t),this.dirtyStart=!0},s.start=function(t,e){this.setDeltaCoordinateHelper("start",t,e),this.dirtyStart=!0},e.endX=function(){return this.currentEnd[0]},e.endY=function(){return this.currentEnd[1]},i.endX=function(t){null!=t&&(this.end[0]=t,this.dirtyEnd=!0)},i.endY=function(t){null!=t&&(this.end[1]=t,this.dirtyEnd=!0)},i.end=function(t,e){this.setCoordinateHelper("end",t,e),this.dirtyEnd=!0},s.endX=function(t){let e=this.end;e[0]=H(e[0],t),this.dirtyEnd=!0},s.endY=function(t){let e=this.end;e[1]=H(e[1],t),this.dirtyEnd=!0},s.end=function(t,e){this.setDeltaCoordinateHelper("end",t,e),this.dirtyEnd=!0},i.palette=function(t={}){"Palette"===t.type&&(this.palette=t)},i.paletteStart=function(t){t.toFixed&&(this.paletteStart=t,(t<0||t>999)&&(this.paletteStart=t>500?999:0))},s.paletteStart=function(t){let e;t.toFixed&&(e=this.paletteStart+t,(e<0||e>999)&&(e=this.cyclePalette?e>500?e-1e3:e+1e3:t>500?999:0),this.paletteStart=e)},i.paletteEnd=function(t){t.toFixed&&(this.paletteEnd=t,(t<0||t>999)&&(this.paletteEnd=t>500?999:0))},s.paletteEnd=function(t){let e;t.toFixed&&(e=this.paletteEnd+t,(e<0||e>999)&&(e=this.cyclePalette?e>500?e-1e3:e+1e3:t>500?999:0),this.paletteEnd=e)},i.colors=function(t){let e=this.palette;e&&e.colors&&e.set({colors:t})},i.delta=function(t={}){t&&(this.delta=Z(this.delta,t))},t.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.palette;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},t.set=function(t={}){if(Object.keys(t).length){let e=this.setters,i=this.defs,s=this.palette,n=s?s.setters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],l=!1;a||(a=n[t],l=!0),a?a.call(l?this.palette:this,o):void 0!==i[t]?this[t]=o:void 0!==r[t]&&(s[t]=o)}},this)}return this},t.setDelta=function(t={}){if(Object.keys(t).length){let e=this.deltaSetters,i=this.defs,s=this.palette,n=s?s.deltaSetters:{},r=s?s.defs:{};Object.entries(t).forEach(([t,o])=>{if(t&&"name"!==t&&null!=o){let a=e[t],l=!1;a||(a=n[t],l=!0),a?a.call(l?this.palette:this,o):void 0!==i[t]?this[t]=H(this[t],o):void 0!==r[t]&&(s[t]=H(this[t],o))}},this)}return this},t.setCoordinateHelper=function(t,e,i){let s=this[t];Array.isArray(e)?(s[0]=e[0],s[1]=e[1]):(s[0]=e,s[1]=i)},t.setDeltaCoordinateHelper=function(t,e,i){let s=this[t],n=s[0],r=s[1];Array.isArray(e)?(s[0]=H(n,e[0]),s[1]=H(r,e[1])):(s[0]=H(n,e),s[1]=H(r,i))},t.updateByDelta=function(){return this.setDelta(this.delta),this},t.stylesInit=function(t={}){this.makeName(t.name),this.register(),this.gradientArgs=[],this.start=He(),this.end=He(),this.currentStart=He(),this.currentEnd=He(),this.palette=function(t){return new Palette(t)}({name:this.name+"_palette"}),this.delta={},this.set(this.defs),this.set(t)},t.getData=function(t,e){return this.palette&&this.palette.dirtyPalette&&this.palette.recalculate(),this.cleanStyle(t,e),this.finalizeCoordinates(t),this.buildStyle(e)},t.cleanStyle=function(t={},e={}){let i,s,n,r;t.lockFillStyleToEntity||t.lockStrokeStyleToEntity?(i=t.currentDimensions,r=t.currentScale,s=i[0]*r,n=i[1]*r):(i=e.currentDimensions,s=i[0],n=i[1]),this.cleanPosition(this.currentStart,this.start,[s,n]),this.cleanPosition(this.currentEnd,this.end,[s,n]),this.cleanRadius(s)},t.cleanPosition=function(t,e,i){let s,n;for(let r=0;r<2;r++)s=e[r],n=i[r],s.toFixed?t[r]=s:t[r]="left"===s||"top"===s?0:"right"===s||"bottom"===s?n:"center"===s?n/2:parseFloat(s)/100*n},t.finalizeCoordinates=function(t={}){this.currentStart,this.currentEnd;let e,i,s=t.currentStampPosition,n=t.currentStampHandlePosition,r=t.currentScale;t.lockFillStyleToEntity||t.lockStrokeStyleToEntity?(e=-n[0]*r||0,i=-n[1]*r||0):(e=-s[0]||0,i=-s[1]||0),this.updateGradientArgs(e,i)},t.cleanRadius=B,t.buildStyle=function(t){return"rgba(0,0,0,0)"},t.addStopsToGradient=function(t,e,i,s){return this.palette?this.palette.addStopsToGradient(t,e,i,s):t},t.updateColor=function(t,e){return this.palette&&this.palette.updateColor(t,e),this},t.removeColor=function(t){return this.palette&&this.palette.removeColor(t),this},t}O.Palette=Palette;const Gradient=function(t={}){return this.stylesInit(t),this};let Js=Gradient.prototype=Object.create(Object.prototype);Js.type="Gradient",Js.lib="styles",Js.isArtefact=!1,Js.isAsset=!1,Js=ee(Js),Js=Ks(Js),Js.packetObjects=Q(Js.packetObjects,["palette"]),Js.buildStyle=function(t={}){if(t){let e=t.engine;if(e){let t=e.createLinearGradient(...this.gradientArgs);return this.addStopsToGradient(t,this.paletteStart,this.paletteEnd,this.cyclePalette)}}return"rgba(0,0,0,0)"},Js.updateGradientArgs=function(t,e){let i=this.gradientArgs,s=this.currentStart,n=this.currentEnd,r=s[0]+t,o=s[1]+e,a=n[0]+t,l=n[1]+e;r===a&&o===l&&a++,i.length=0,i.push(r,o,a,l)};O.Gradient=Gradient;const Grid=function(t={}){return this.tileFill=[],this.tileSources=[],this.entityInit(t),t.tileSources||(this.tileSources=[].concat([{type:"color",source:"#000000"},{type:"color",source:"#ffffff"}])),t.tileFill?Array.isArray(t.tileFill)&&this.tileFill.length===t.tileFill.length&&(this.tileFill=t.tileFill):(this.tileFill.length=this.columns*this.rows,this.tileFill.fill(0)),this.tilePaths=[],this.tileRealCoordinates=[],this.tileVirtualCoordinates=[],t.dimensions||(t.width||(this.currentDimensions[0]=this.dimensions[0]=20),t.height||(this.currentDimensions[1]=this.dimensions[1]=20)),this};let tn=Grid.prototype=Object.create(Object.prototype);tn.type="Grid",tn.lib="entity",tn.isArtefact=!0,tn.isAsset=!1,tn=ee(tn),tn=ps(tn);tn.defs=_(tn.defs,{columns:2,rows:2,columnGutterWidth:1,rowGutterWidth:1,tileSources:null,tileFill:null,gutterColor:"#808080"}),tn.packetExclusions=Q(tn.packetExclusions,["tileSources"]),tn.finalizePacketOut=function(t,e){let i=t.tileSources=[];this.tileSources.forEach(t=>{i.push({type:t.type,source:U(t.source)?t.source.name:t.source})}),U(t.gutterColor)&&(t.gutterColor=t.gutterColor.name);let s=JSON.parse(this.state.saveAsPacket(e))[3];return t=_(t,s),t=this.handlePacketAnchor(t,e)};tn.getters;let en=tn.setters,sn=tn.deltaSetters;en.columns=function(t){if(V(t)&&(Number.isInteger(t)||(t=parseInt(t,10)),t!==this.columns)){let e,i,s,n=this.tileFill,r=this.columns,o=[];for(this.columns=t,e=0,i=this.rows;e<i;e++)for(s=0;s<t;s++)s<r?o.push(n[e*r+s]):o.push(0);this.tileFill=o}this.dirtyPathObject=!0},sn.columns=B,en.rows=function(t){if(V(t)&&(Number.isInteger(t)||(t=parseInt(t,10)),t!==this.rows)){let e=this.rows;this.rows=t,this.tileFill.length=this.columns*t,e<t&&this.tileFill.fill(0,e*this.columns)}this.dirtyPathObject=!0},sn.rows=B,tn.setAllTilesTo=function(t){V(t)&&(Number.isInteger(t)||(t=parseInt(t,10)),this.tileFill.fill(t))},tn.setTilesTo=function(t,e){let i=this.tileFill;J(t)&&V(e)&&(Number.isInteger(e)||(e=parseInt(e,10)),V(t)?i[t]=e:Array.isArray(t)&&t.forEach(t=>{V(t)&&(i[t]=e)}))},tn.setTileSourceTo=function(t,e){V(t)&&U(e)&&e.type&&e.source&&(this.tileSources[t]=e)},tn.removeTileSource=function(t){V(t)&&t&&(this.tileSources[t]=null,this.tileFill=this.tileFill.map(e=>e===t?0:e))},tn.getTileSource=function(t,e){if(V(t))return V(e)?this.tileFill[t*this.rows+e]:this.tileFill[t]},tn.getTilesUsingSource=function(t){let e=[];return V(t)&&this.tileFill.forEach((i,s)=>i==t&&e.push(s)),e},tn.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=new Path2D,i=new Path2D,s=this.currentStampHandlePosition,n=this.currentScale,r=this.currentDimensions,o=-s[0]*n,a=-s[1]*n,l=r[0]*n,h=r[1]*n;t.rect(o,a,l,h);let c,u,d,f,p=this.columns,m=this.rows,g=l/p,y=h/m,b=this.tilePaths,k=this.tileRealCoordinates,S=this.tileVirtualCoordinates;for(e.moveTo(o,a),e.lineTo(o+l,a),c=1;c<=m;c++){let t=a+c*y;e.moveTo(o,t),e.lineTo(o+l,t)}for(this.rowLines=e,i.moveTo(o,a),i.lineTo(o,a+h),u=1;u<=p;u++){let t=o+u*g;i.moveTo(t,a),i.lineTo(t,a+h)}for(this.columnLines=i,b.length=0,k.length=0,S.length=0,c=0;c<m;c++)for(u=0;u<p;u++){let t=new Path2D;d=u*g,f=c*y,t.rect(o+d,a+f,g,y),b.push(t),S.push([d,f]),k.push([o+d,a+f])}this.currentTileWidth=g,this.currentTileHeight=y}},tn.performFill=function(t){t.save();let e,i=ni(),s=i.engine,n=i.element,r=this.tileSources,o=this.tileFill,a=this.tilePaths,l=this.tileRealCoordinates,c=this.tileVirtualCoordinates,u=this.winding,d=this.currentTileWidth,f=this.currentTileHeight,p=this.scale,m=this.currentDimensions;r.forEach((r,g)=>{if(r&&r.type)switch(r.type){case"color":t.fillStyle=r.source;break;case"cellGradient":this.lockFillStyleToEntity=!1,t.fillStyle=r.source.getData(this,this.currentHost);break;case"gridGradient":this.lockFillStyleToEntity=!0,t.fillStyle=r.source.getData(this,this.currentHost)}let y=o.map(t=>t===g);if(y.length)switch(r.type){case"gridPicture":e=r.source.substring?h[r.source]:r.source,e.simpleStamp&&(n.width=m[0]*p,n.height=m[1]*p,s.globalCompositeOperation="source-over",s.fillStyle="#000000",y.forEach((t,e)=>{t&&s.fillRect(c[e][0],c[e][1],d,f)}),s.globalCompositeOperation="source-in",e.simpleStamp(i,{startX:0,startY:0,width:m[0]*p,height:m[1]*p,method:"fill"}),t.drawImage(n,l[0][0],l[0][1]));break;case"tilePicture":e=r.source.substring?h[r.source]:r.source,e.simpleStamp&&(n.width=d,n.height=f,s.globalCompositeOperation="source-over",e.simpleStamp(i,{startX:0,startY:0,width:d,height:f,method:"fill"}),y.forEach((e,i)=>e&&t.drawImage(n,l[i][0],l[i][1])));break;default:y.forEach((e,i)=>e&&t.fill(a[i],u))}});let g,y=this.gutterColor,b=this.rowGutterWidth,k=this.columnGutterWidth;if(J(y)){switch(y.substring?g={type:"color",source:this.gutterColor}:U(y)?g=y:V(y)&&U(r[y])&&(g=r[y]),g.type){case"cellGradient":this.lockFillStyleToEntity=!1,t.strokeStyle=g.source.getData(this,this.currentHost);break;case"gridGradient":this.lockFillStyleToEntity=!0,t.strokeStyle=g.source.getData(this,this.currentHost);break;case"color":t.strokeStyle=g.source}switch(g.type){case"gridPicture":case"tilePicture":if((b||k)&&(e=g.source.substring?h[g.source]:g.source,e.simpleStamp)){let r=this.currentStampHandlePosition,o=this.currentScale,a=r[0]*o,h=r[1]*o;n.width=m[0]*o,n.height=m[1]*o,s.globalCompositeOperation="source-over",s.strokeStyle="#000000",s.translate(a,h),b&&(s.lineWidth=b,s.stroke(this.rowLines)),k&&(s.lineWidth=k,s.stroke(this.columnLines)),s.globalCompositeOperation="source-in",e.simpleStamp(i,{startX:0,startY:0,width:m[0]*o,height:m[1]*o,method:"fill"}),t.drawImage(n,l[0][0],l[0][1]),s.translate(0,0)}break;default:b&&(t.lineWidth=b,t.stroke(this.rowLines)),k&&(t.lineWidth=k,t.stroke(this.columnLines))}}ri(i),t.restore()},tn.fill=function(t){this.performFill(t)},tn.drawAndFill=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),this.performFill(t)},tn.fillAndDraw=function(t){let e=this.pathObject;t.stroke(e),this.currentHost.clearShadow(),this.performFill(t),t.stroke(e)},tn.drawThenFill=function(t){let e=this.pathObject;t.stroke(e),this.performFill(t)},tn.fillThenDraw=function(t){let e=this.pathObject;this.performFill(t),t.stroke(e)},tn.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;this.pathObject&&!this.dirtyPathObject||this.cleanPathObject();let i=Array.isArray(t)?t:[t],s=!1;e||(e=ni(),s=!0);let n,r,o,a=e.engine,l=this.currentStampPosition,h=l[0],c=l[1],u=new Set,d=this.tilePaths;const f=t=>{let e,i;if(Array.isArray(t))e=t[0],i=t[1];else{if(!tt(t,t.x,t.y))return[!1];e=t.x,i=t.y}return!e.toFixed||!i.toFixed||isNaN(e)||isNaN(i)?[!1]:[!0,e,i]};return e.rotateDestination(a,h,c,this),i.some(t=>([n,r,o]=f(t),!!n&&a.isPointInPath(this.pathObject,r,o,this.winding)),this)?(i.forEach(t=>{[n,r,o]=f(t),n&&d.some((t,e)=>!!a.isPointInPath(t,r,o,this.winding)&&(u.add(e),!0))}),s&&ri(e),{x:r,y:o,tiles:[...u],artefact:this}):(s&&ri(e),!1)};O.Grid=Grid;const Line=function(t={}){return this.curveInit(t),this.shapeInit(t),this};let nn=Line.prototype=Object.create(Object.prototype);nn.type="Line",nn.lib="entity",nn.isArtefact=!0,nn.isAsset=!1,nn=ee(nn),nn=Os(nn),nn=vs(nn),nn.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeLinePath(),this.pathDefinition=t},nn.makeLinePath=function(){let[t,e]=this.currentStampPosition,[i,s]=this.currentEnd;return`m0,0l${(i-t).toFixed(2)},${(s-e).toFixed(2)}`},nn.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyHandle=!0,this.dirtyOffset=!0,this.dirtyStart=!0,this.dirtyEnd=!0},nn.preparePinsForStamp=function(){let t=this.endPivot,e=this.endPath;this.dirtyPins.forEach(i=>{(t&&t.name===i||e&&e.name===i)&&(this.dirtyEnd=!0,this.endLockTo.includes("path")&&(this.currentEndPathData=!1))}),this.dirtyPins.length=0};O.Line=Line;const Loom=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.state=De(),t.group||(t.group=Gi),this.onEnter=B,this.onLeave=B,this.onDown=B,this.onUp=B,this.delta={},this.set(t),this.fromPathData=[],this.toPathData=[],this.watchFromPath=null,this.watchIndex=-1,this.engineInstructions=[],this.engineDeltaLengths=[],this};let rn=Loom.prototype=Object.create(Object.prototype);rn.type="Loom",rn.lib="entity",rn.isArtefact=!0,rn.isAsset=!1,rn=ee(rn),rn=_e(rn);rn.defs=_(rn.defs,{fromPath:null,toPath:null,fromPathStart:0,fromPathEnd:1,toPathStart:0,toPathEnd:1,synchronizePathCursors:!0,loopPathCursors:!0,constantPathSpeed:!0,isHorizontalCopy:!0,showBoundingBox:!1,boundingBoxColor:"#000000",source:null,sourceIsVideoOrSprite:!1,interferenceLoops:2,interferenceFactor:1.03,visibility:!0,order:0,delta:null,host:null,group:null,anchor:null,noCanvasEngineUpdates:!1,noDeltaUpdates:!1,onEnter:null,onLeave:null,onDown:null,onUp:null,noUserInteraction:!1,method:"fill"}),rn.packetExclusions=Q(rn.packetExclusions,["pathObject","state"]),rn.packetExclusionsByRegex=Q(rn.packetExclusionsByRegex,["^(local|dirty|current)","Subscriber$"]),rn.packetCoordinates=Q(rn.packetCoordinates,[]),rn.packetObjects=Q(rn.packetObjects,["group","fromPath","toPath","source"]),rn.packetFunctions=Q(rn.packetFunctions,["onEnter","onLeave","onDown","onUp"]),rn.processPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},rn.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=_(t,i),t=this.handlePacketAnchor(t,e)},rn.handlePacketAnchor=function(t,e){if(this.anchor){let i=JSON.parse(this.anchor.saveAsPacket(e))[3];t.anchor=i}return t},rn.clone=$;let on=rn.getters,an=rn.setters,ln=rn.deltaSetters;rn.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},rn.set=function(t={}){if(Object.keys(t).length){let e,i,s=this.setters,n=this.defs,r=this.state,o=r?r.setters:{},a=r?r.defs:{};Object.entries(t).forEach(([t,l])=>{t&&"name"!==t&&null!=l&&(e=s[t],i=!1,e||(e=o[t],i=!0),e?e.call(i?this.state:this,l):void 0!==n[t]?this[t]=l:void 0!==a[t]&&(r[t]=l))},this)}return this},rn.setDelta=function(t={}){if(Object.keys(t).length){let e,i,s=this.deltaSetters,n=this.defs,r=this.state,o=r?r.deltaSetters:{},a=r?r.defs:{};Object.entries(t).forEach(([t,l])=>{t&&"name"!==t&&null!=l&&(e=s[t],i=!1,e||(e=o[t],i=!0),e?e.call(i?this.state:this,l):void 0!==n[t]?this[t]=addStrings(this[t],l):void 0!==a[t]&&(r[t]=addStrings(r[t],l)))},this)}return this},an.host=function(t){if(t){let e=i[t];e&&e.here?this.host=e.name:this.host=t}else this.host=""},on.group=function(){return this.group?this.group.name:""},an.group=function(t){let e;t&&(this.group&&"Group"===this.group.type&&this.group.removeArtefacts(this.name),t.substring?(e=group[t],this.group=e||t):this.group=t),this.group&&"Group"===this.group.type&&this.group.addArtefacts(this.name)},rn.getHere=function(){return currentCorePosition},an.delta=function(t={}){t&&(this.delta=Z(this.delta,t))},an.fromPath=function(t){if(t){let e=this.fromPath,s=t.substring?i[t]:t,n=this.name;s&&s.name&&s.useAsPath&&(e&&e.name!==s.name&&removeItem(e.pathed,n),Q(s.pathed,n),this.fromPath=s,this.dirtyStart=!0)}},an.toPath=function(t){if(t){let e=this.toPath,s=t.substring?i[t]:t,n=this.name;s&&s.name&&s.useAsPath&&(e&&e.name!==s.name&&removeItem(e.pathed,n),Q(s.pathed,n),this.toPath=s,this.dirtyStart=!0)}},an.source=function(t){if((t=t.substring?i[t]:t)&&"Picture"===t.type){let e=this.source;e&&"Picture"===e.type&&e.imageUnsubscribe(this.name),this.source=t,t.imageSubscribe(this.name),this.dirtyInput=!0}},an.isHorizontalCopy=function(t){this.isHorizontalCopy=!!t,this.dirtyPathData=!0},an.synchronizePathCursors=function(t){this.synchronizePathCursors=!!t,t&&(this.toPathStart=this.fromPathStart,this.toPathEnd=this.fromPathEnd),this.dirtyPathData=!0},an.loopPathCursors=function(t){if(this.loopPathCursors=!!t,t){let t,e=Math.floor;t=this.fromPathStart,(t<0||t>1)&&(this.fromPathStart=t-e(t)),t=this.fromPathEnd,(t<0||t>1)&&(this.fromPathEnd=t-e(t)),t=this.toPathStart,(t<0||t>1)&&(this.toPathStart=t-e(t)),t=this.toPathEnd,(t<0||t>1)&&(this.toPathEnd=t-e(t))}this.dirtyOutput=!0},an.fromPathStart=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.fromPathStart=t,this.synchronizePathCursors&&(this.toPathStart=t),this.dirtyPathData=!0},ln.fromPathStart=function(t){let e=this.fromPathStart+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.fromPathStart=e,this.synchronizePathCursors&&(this.toPathStart=e),this.dirtyPathData=!0},an.fromPathEnd=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.fromPathEnd=t,this.synchronizePathCursors&&(this.toPathEnd=t),this.dirtyPathData=!0},ln.fromPathEnd=function(t){let e=this.fromPathEnd+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.fromPathEnd=e,this.synchronizePathCursors&&(this.toPathEnd=e),this.dirtyPathData=!0},an.toPathStart=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.toPathStart=t,this.synchronizePathCursors&&(this.fromPathStart=t),this.dirtyPathData=!0},ln.toPathStart=function(t){let e=this.toPathStart+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.toPathStart=e,this.synchronizePathCursors&&(this.fromPathStart=e),this.dirtyPathData=!0},an.toPathEnd=function(t){this.loopPathCursors&&(t<0||t>1)&&(t-=Math.floor(t)),this.toPathEnd=t,this.synchronizePathCursors&&(this.fromPathEnd=t),this.dirtyPathData=!0},ln.toPathEnd=function(t){let e=this.toPathEnd+=t;this.loopPathCursors&&(e<0||e>1)&&(e-=Math.floor(e)),this.toPathEnd=e,this.synchronizePathCursors&&(this.fromPathEnd=e),this.dirtyPathData=!0},rn.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=i[this.host];if(t)return this.currentHost=t,this.dirtyHost=!0,this.currentHost}return currentCorePosition},rn.updateByDelta=function(){return this.setDelta(this.delta),this},rn.reverseByDelta=function(){let t={};return Object.entries(this.delta).forEach(([e,i])=>{i=i.substring?-parseFloat(i)+"%":-i,t[e]=i}),this.setDelta(t),this},rn.setDeltaValues=function(t={}){let e,i,s=this.delta;return Object.entries(t).forEach(([t,n])=>{if(xt(s[t]))switch(i=n,e=s[t],i){case"reverse":e.toFixed&&(s[t]=-e);break;case"zero":e.toFixed&&(s[t]=0)}}),this},rn.midInitActions=B,rn.cleanCollisionData=function(){return[0,[]]},rn.getSensors=function(){return[]},rn.prepareStamp=function(){let t=this.fromPath,e=this.toPath,[i,s,n,r]=this.getBoundingBox();if(!this.dirtyPathData){let{x:i,y:s}=t.getPathPositionData(0),{x:n,y:r}=t.getPathPositionData(1),{x:o,y:a}=e.getPathPositionData(0),{x:l,y:h}=e.getPathPositionData(1),c=[i,s,n,r,o,a,l,h];this.pathTests&&!this.pathTests.some((t,e)=>t!==c[e])||(this.pathTests=c,this.dirtyPathData=!0)}if(this.dirtyPathData||!this.fromPathData.length){this.dirtyPathData=!1,this.watchIndex=-1,this.engineInstructions.length=0,this.engineDeltaLengths.length=0;let n=Math.ceil,r=Math.max,o=Math.min,a=this.fromPathData;a.length=0;let l=this.toPathData;if(l.length=0,t&&e){let h,c,u,d,f=n(t.length),p=n(e.length);h=this.setSourceDimension(r(f,p));let m,g,y,b=this.fromPathStart,k=this.fromPathEnd,S=this.toPathStart,O=this.toPathEnd,P=this.constantPathSpeed;m=b<k?k-b:k+(1-b),m<.005&&(m=.005),g=S<O?O-S:O+(1-S),g<.005&&(g=.005),y=n(o(m,g)),c=1/(h*(1/y));for(let n=0;n<=1;n+=c)({x:u,y:d}=t.getPathPositionData(n,P)),a.push([u-i,d-s]),({x:u,y:d}=e.getPathPositionData(n,P)),l.push([u-i,d-s]);this.fromPathSteps=m/y,this.toPathSteps=g/y,this.watchFromPath=1===this.fromPathSteps,this.dirtyOutput=!0}else this.dirtyPathData=!0}this.sourceIsVideoOrSprite&&(this.dirtyInput=!0)},rn.setSourceDimension=function(t){if(t)this.sourceDimension!==t&&(this.sourceDimension=t,this.dirtyInput=!0);else{let t=this.fromPath,e=this.toPath;if(t&&e){let i=Math.ceil,s=i(t.length),n=i(e.length),r=Math.max(s,n);this.sourceDimension!==r&&(this.sourceDimension=r)}else this.sourceDimension=0}return this.sourceDimension},rn.simpleStamp=function(t,e={}){t&&"Cell"===t.type&&(this.currentHost=t,e&&(this.set(e),this.prepareStamp()),this.regularStampSynchronousActions())},rn.stamp=function(t=!1,e,i){if(t)return e&&"Cell"===e.type&&(this.currentHost=e),i&&(this.set(i),this.prepareStamp()),this.regularStamp();if(this.visibility){let t=this,e=this.dirtyInput,i=this.dirtyOutput;return e?new Promise((e,i)=>{t.cleanInput().catch(i=>{console.log(t.name+" - cleanInput Error: source has a zero dimension"),e(!1)}).then(e=>(t.sourceImageData=e,t.cleanOutput())).then(e=>(t.output=e,t.regularStamp())).then(t=>{e(!0)}).catch(t=>{i(t)})}):i?new Promise((e,i)=>{t.cleanOutput().then(e=>(t.output=e,t.regularStamp())).then(t=>{e(!0)}).catch(t=>{i(t)})}):this.regularStamp()}return Promise.resolve(!1)},rn.cleanInput=function(){let t=this;return new Promise((e,i)=>{t.dirtyInput=!1,t.setSourceDimension();let s=t.sourceDimension;s||(t.dirtyInput=!0,i());let n=ni(),r=n.engine,o=n.element;o.width=s,o.height=s,r.setTransform(1,0,0,1,0,0),t.source.stamp(!0,n,{startX:0,startY:0,handleX:0,handleY:0,offsetX:0,offsetY:0,roll:0,scale:1,width:s,height:s,method:"fill"}).then(t=>{let i=r.getImageData(0,0,s,s);ri(n),e(i)}).catch(t=>{ri(n),i(t)})})},rn.cleanOutput=function(){let t=this;return new Promise((e,i)=>{t.dirtyOutput=!1,t.setSourceDimension();let s=t.sourceDimension,n=t.sourceImageData;if(s&&n){let i,r,o,a,l,h,c,u,d,f,p,m=Math.hypot,g=Math.floor,y=Math.ceil,b=Math.atan2,k=Math.cos,S=Math.sin,O=t.fromPathData,P=t.toPathData,v=O.length,w=t.fromPathStart*v,x=t.fromPathSteps||1,A=t.toPathStart*v,C=t.toPathSteps||1,D=.5*Math.PI,R=D-1.5708,E=t.isHorizontalCopy,F=t.loopPathCursors,T=t.watchFromPath,H=t.watchIndex,M=t.engineInstructions,I=t.engineDeltaLengths,[B,L,$,j]=t.getBoundingBox(),N=ni(),X=N.engine,Y=N.element;Y.width=s,Y.height=s,X.setTransform(1,0,0,1,0,0),X.putImageData(n,0,0);let z=ni(),G=z.engine,W=z.element;if(W.width=$,W.height=j,G.globalAlpha=t.state.globalAlpha,G.setTransform(1,0,0,1,0,0),!M.length){for(let t=0;t<s;t++)H<0&&(T&&w<1||!T&&A<1)&&(H=t),w<v&&A<v&&w>=0&&A>=0?([i,r]=O[g(w)],[o,a]=P[g(A)],l=o-i,h=a-r,c=m(l,h),E?(u=-b(l,h)+D,d=k(u),f=S(u),M.push([d,f,-f,d,i,r]),I.push(c)):(u=-b(l,h)+R,d=k(u),f=S(u),M.push([d,f,-f,d,i,r,c]),I.push(c))):(M.push(!1),I.push(!1)),w+=x,A+=C,F&&(w>=v&&(w-=v),A>=v&&(A-=v));H<0&&(H=0),t.watchIndex=H}if(E)for(let t=0;t<s;t++)p=M[H],p&&(G.setTransform(...p),G.drawImage(Y,0,H,s,1,0,0,I[H],1)),H++,H>=s&&(H=0);else for(let t=0;t<s;t++)p=M[H],p&&(G.setTransform(...p),G.drawImage(Y,H,0,1,s,0,0,1,I[H])),H++,H>=s&&(H=0);let V=t.interferenceFactor,U=t.interferenceLoops,q=y($*V),_=y(j*V);Y.width=q,Y.height=_,G.setTransform(1,0,0,1,0,0),X.setTransform(1,0,0,1,0,0);for(let t=0;t<U;t++)X.drawImage(W,0,0,$,j,0,0,q,_),G.drawImage(Y,0,0,q,_,0,0,$,j);let Z=G.getImageData(0,0,$,j);ri(N),ri(z),t.dirtyTargetImage=!0,e(Z)}else i(new Error(this.name+" - cleanOutput Error: source has a zero dimension, or no data"))})},rn.regularStamp=function(){let t=this;return new Promise((e,i)=>{t.currentHost&&(t.regularStampSynchronousActions(),e(!0)),i(new Error(t.name+" has no current host"))})},rn.regularStampSynchronousActions=function(){let t=this.currentHost;if(t){let e=t.engine;this.noCanvasEngineUpdates||t.setEngine(this),this[this.method](e)}},rn.getBoundingBox=function(){let t=this.fromPath,e=this.toPath;if(t&&e){if(this.dirtyStart)if(t.getBoundingBox&&e.getBoundingBox){this.dirtyStart=!1;let[i,s,n,r,o,a]=t.getBoundingBox(),[l,h,c,u,d,f]=e.getBoundingBox();(isNaN(i)||isNaN(s)||isNaN(n)||isNaN(r)||isNaN(o)||isNaN(a)||isNaN(l)||isNaN(h)||isNaN(c)||isNaN(u)||isNaN(d)||isNaN(f))&&(this.dirtyStart=!0),i==l&&s==h&&n==c&&r==u&&o==d&&a==f&&(this.dirtyStart=!0),i+=o,s+=a,l+=d,h+=f;let p=Math.min(i,l),m=Math.max(i+n,l+c),g=Math.min(s,h),y=Math.max(s+r,h+u);this.boundingBox=[p,g,m-p,y-g],this.dirtyPathData=!0}else this.boundingBox=[0,0,0,0]}else this.boundingBox=[0,0,0,0];return this.boundingBox},rn.fill=function(t){this.doFill(t),this.showBoundingBox&&this.drawBoundingBox(t)},rn.draw=function(t){this.doStroke(t),this.showBoundingBox&&this.drawBoundingBox(t)},rn.drawAndFill=function(t){this.doStroke(t),this.currentHost.clearShadow(),this.doFill(t),this.showBoundingBox&&this.drawBoundingBox(t)},rn.fillAndDraw=function(t){this.doFill(t),this.currentHost.clearShadow(),this.doStroke(t),this.showBoundingBox&&this.drawBoundingBox(t)},rn.drawThenFill=function(t){this.doStroke(t),this.doFill(t),this.showBoundingBox&&this.drawBoundingBox(t)},rn.fillThenDraw=function(t){this.doFill(t),this.doStroke(t),this.showBoundingBox&&this.drawBoundingBox(t)},rn.clear=function(t){let e=this.output,i=!!this.currentHost&&this.currentHost.element,s=t.globalCompositeOperation;if(e&&i){let i=ni(),n=i.engine,r=i.element,[o,a,l,h]=this.getBoundingBox();r.width=l,r.height=h,n.putImageData(e,0,0),t.setTransform(1,0,0,1,0,0),t.globalCompositeOperation="destination-out",t.drawImage(r,0,0,l,h,o,a,l,h),t.globalCompositeOperation=s,ri(i),this.showBoundingBox&&this.drawBoundingBox(t)}},rn.none=B,rn.doStroke=function(t){let e=this.fromPath,i=this.toPath;if(e&&e.getBoundingBox&&i&&i.getBoundingBox){let s=this.currentHost;if(s){let n=e.currentStampPosition,r=e.getPathPositionData(1),o=i.currentStampPosition,a=i.getPathPositionData(1);s.rotateDestination(t,n[0],n[1],e),t.stroke(e.pathObject),s.rotateDestination(t,o[0],o[1],e),t.stroke(i.pathObject),t.setTransform(1,0,0,1,0,0),t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(a.x,a.y),t.moveTo(...o),t.lineTo(...n),t.closePath(),t.stroke()}}},rn.doFill=function(t){let e=this.output,i=!!this.currentHost&&this.currentHost.element;if(e&&i){let i=ni(),s=i.engine,n=i.element,[r,o,a,l]=this.getBoundingBox();n.width=a,n.height=l,s.putImageData(e,0,0),t.setTransform(1,0,0,1,0,0),t.drawImage(n,0,0,a,l,r,o,a,l),ri(i)}},rn.drawBoundingBox=function(t){this.dirtyStart&&this.getBoundingBox(),t.save();let e=t.getTransform();t.setTransform(1,0,0,1,0,0),t.strokeStyle=this.boundingBoxColor,t.lineWidth=1,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.strokeRect(...this.boundingBox),t.restore(),t.setTransform(e)},rn.checkHit=function(t=[]){if(this.noUserInteraction)return!1;let e,i,s,n,r,o=Array.isArray(t)?t:[t],a=!(!this.output||!this.output.data)&&this.output.data;if(a){let[t,l,h,c]=this.getBoundingBox();if(o.some(o=>{if(Array.isArray(o))e=o[0],i=o[1];else{if(!tt(o,o.x,o.y))return!1;e=o.x,i=o.y}return!(!e.toFixed||!i.toFixed||isNaN(e)||isNaN(i))&&(s=e-t,n=i-l,!(s<0||s>h||n<0||n>c)&&(r=4*(n*h+s)+3,!!a&&a[r]>0))},this))return{x:e,y:i,artefact:this}}return!1};O.Loom=Loom;const hn=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.state=De(),t.group||(t.group=Gi),this.onEnter=B,this.onLeave=B,this.onDown=B,this.onUp=B,this.delta={},this.set(t),this.fromPathData=[],this.toPathData=[],this.watchFromPath=null,this.watchIndex=-1,this.engineInstructions=[],this.engineDeltaLengths=[],this};let cn=hn.prototype=Object.create(Object.prototype);cn.type="Mesh",cn.lib="entity",cn.isArtefact=!0,cn.isAsset=!1,cn=ee(cn),cn=_e(cn);cn.defs=_(cn.defs,{net:null,isHorizontalCopy:!0,source:null,sourceIsVideoOrSprite:!1,interferenceLoops:2,interferenceFactor:1.03,visibility:!0,order:0,delta:null,host:null,group:null,anchor:null,noCanvasEngineUpdates:!1,noDeltaUpdates:!1,onEnter:null,onLeave:null,onDown:null,onUp:null,noUserInteraction:!1,method:"fill"}),cn.packetExclusions=Q(cn.packetExclusions,["pathObject","state"]),cn.packetExclusionsByRegex=Q(cn.packetExclusionsByRegex,["^(local|dirty|current)","Subscriber$"]),cn.packetCoordinates=Q(cn.packetCoordinates,[]),cn.packetObjects=Q(cn.packetObjects,["group","net","source"]),cn.packetFunctions=Q(cn.packetFunctions,["onEnter","onLeave","onDown","onUp"]),cn.processPacketOut=function(t,e,i){let s=!0;return i.indexOf(t)<0&&e===this.defs[t]&&(s=!1),s},cn.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=_(t,i),t=this.handlePacketAnchor(t,e)},cn.handlePacketAnchor=function(t,e){if(this.anchor){let i=JSON.parse(this.anchor.saveAsPacket(e))[3];t.anchor=i}return t},cn.clone=$;let un=cn.getters,dn=cn.setters;cn.deltaSetters;cn.get=function(t){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}},cn.set=function(t={}){if(Object.keys(t).length){let e,i,s=this.setters,n=this.defs,r=this.state,o=r?r.setters:{},a=r?r.defs:{};Object.entries(t).forEach(([t,l])=>{t&&"name"!==t&&null!=l&&(e=s[t],i=!1,e||(e=o[t],i=!0),e?e.call(i?this.state:this,l):void 0!==n[t]?this[t]=l:void 0!==a[t]&&(r[t]=l))},this)}return this},cn.setDelta=function(t={}){if(Object.keys(t).length){let e,i,s=this.deltaSetters,n=this.defs,r=this.state,o=r?r.deltaSetters:{},a=r?r.defs:{};Object.entries(t).forEach(([t,l])=>{t&&"name"!==t&&null!=l&&(e=s[t],i=!1,e||(e=o[t],i=!0),e?e.call(i?this.state:this,l):void 0!==n[t]?this[t]=addStrings(this[t],l):void 0!==a[t]&&(r[t]=addStrings(r[t],l)))},this)}return this},dn.host=function(t){if(t){let e=i[t];e&&e.here?this.host=e.name:this.host=t}else this.host=""},un.group=function(){return this.group?this.group.name:""},dn.group=function(t){let e;t&&(this.group&&"Group"===this.group.type&&this.group.removeArtefacts(this.name),t.substring?(e=group[t],this.group=e||t):this.group=t),this.group&&"Group"===this.group.type&&this.group.addArtefacts(this.name)},cn.getHere=function(){return currentCorePosition},dn.delta=function(t={}){t&&(this.delta=Z(this.delta,t))},dn.net=function(t){t&&(t=t.substring?i[t]:t)&&"Net"===t.type&&(this.net=t,this.dirtyStart=!0)},dn.source=function(t){if((t=t.substring?i[t]:t)&&"Picture"===t.type){let e=this.source;e&&"Picture"===e.type&&e.imageUnsubscribe(this.name),this.source=t,t.imageSubscribe(this.name),this.dirtyInput=!0}},dn.isHorizontalCopy=function(t){this.isHorizontalCopy=!!t,this.dirtyPathData=!0},cn.getHost=function(){if(this.currentHost)return this.currentHost;if(this.host){let t=i[this.host];if(t)return this.currentHost=t,this.dirtyHost=!0,this.currentHost}return currentCorePosition},cn.updateByDelta=function(){return this.setDelta(this.delta),this},cn.reverseByDelta=function(){let t={};return Object.entries(this.delta).forEach(([e,i])=>{i=i.substring?-parseFloat(i)+"%":-i,t[e]=i}),this.setDelta(t),this},cn.setDeltaValues=function(t={}){let e,i,s=this.delta;return Object.entries(t).forEach(([t,n])=>{if(xt(s[t]))switch(i=n,e=s[t],i){case"reverse":e.toFixed&&(s[t]=-e);break;case"zero":e.toFixed&&(s[t]=0)}}),this},cn.midInitActions=B,cn.cleanCollisionData=function(){return[0,[]]},cn.getSensors=function(){return[]},cn.prepareStamp=function(){this.badNet=!0,this.dirtyParticles=!1;let{net:t,particlePositions:e}=this;if(t&&t.particleStore&&t.particleStore.length>3){let{rows:i,columns:s,particleStore:n}=t;if(i&&s){this.badNet=!1,this.rows=i,this.columns=s,e||(e=[]);let t=[];n.forEach(e=>{let i=e.position,{x:s,y:n}=i;t.push([s,n])});let r=t.join(",");e.join(",")!==r&&(this.particlePositions=t,this.dirtyInput=!0),this.sourceIsVideoOrSprite&&(this.dirtyInput=!0)}}},cn.setSourceDimension=function(){if(!this.badNet){const{columns:t,rows:e,particlePositions:i}=this,s=[],n=[],r=[],o=[],a=[],l=[],h=[],c=[],u=[];let d,f,p,m,g,y,b,k,S,O,P,v,w,x,A,C,D,R;for(p=0;p<e;p++){for(m=0,w=n[p]=[],y=c[p]=[],d=0,f=t-1;d<f;d++)g=p*t+d,[b,S]=i[g],[k,O]=i[g+1],y.push([b,S,k,O]),0===d?l.push([b,S]):d===f-1?h.push([k,O]):0===p?(a.push([b,S]),d===f-2&&a.push([k,O])):p===e-1&&(u.push([b,S]),d===f-2&&u.push([k,O])),r.push(b,k),o.push(S,O),P=k-b,v=O-S,x=Math.sqrt(P*P+v*v),m+=x,w.push(x);s.push(m)}this.sourceDimension=Math.max(...s);let E=this.currentHost||this.getHost();if(E){let t=Math.max(...E.currentDimensions);this.sourceDimension>t&&(this.sourceDimension=t)}for(A=0,C=n.length;A<C;A++)for(x=s[A],w=n[A],y=c[A],D=0,R=w.length;D<R;D++)x&&(w[D]=w[D]/x),y[D].push(w[D]);this.struts=c;let F=Math.min(...r),T=Math.min(...o),H=Math.max(...r),M=Math.max(...o);this.boundingBox=[F,T,H-F,M-T],l.reverse(),u.reverse();let I=`M${a[0][0]},${a[0][1]}L`;for(A=1,C=a.length;A<C;A++)[d,p]=a[A],I+=`${d},${p} `;for(A=0,C=h.length;A<C;A++)[d,p]=h[A],I+=`${d},${p} `;for(A=0,C=u.length;A<C;A++)[d,p]=u[A],I+=`${d},${p} `;for(A=0,C=l.length;A<C;A++)[d,p]=l[A],I+=`${d},${p} `;I+="z",this.pathObject=new Path2D(I)}},cn.simpleStamp=function(t,e={}){t&&"Cell"===t.type&&(this.currentHost=t,e&&(this.set(e),this.prepareStamp()),this.regularStampSynchronousActions())},cn.stamp=function(t=!1,e,i){if(t)return e&&"Cell"===e.type&&(this.currentHost=e),i&&(this.set(i),this.prepareStamp()),this.regularStamp();if(this.visibility){let t=this;return this.dirtyInput?new Promise((e,i)=>{t.cleanInput().catch(i=>{console.log(t.name+" - cleanInput Error: source has a zero dimension"),e(!1)}).then(e=>(t.sourceImageData=e,t.cleanOutput())).then(e=>(t.output=e,t.regularStamp())).then(t=>{e(!0)}).catch(t=>{i(t)})}):this.regularStamp()}return Promise.resolve(!1)},cn.cleanInput=function(){let t=this;return new Promise((e,i)=>{t.dirtyInput=!1,t.setSourceDimension();let s=t.sourceDimension;s||(t.dirtyInput=!0,i());let n=ni(),r=n.engine,o=n.element;o.width=s,o.height=s,r.setTransform(1,0,0,1,0,0),t.source.stamp(!0,n,{startX:0,startY:0,handleX:0,handleY:0,offsetX:0,offsetY:0,roll:0,scale:1,width:s,height:s,method:"fill"}).then(t=>{let i=r.getImageData(0,0,s,s);ri(n),e(i)}).catch(t=>{ri(n),i(t)})})},cn.cleanOutput=function(){let t=this;return new Promise((e,i)=>{const s=Math.PI/2;t.dirtyOutput=!1;let{sourceDimension:n,sourceImageData:r,columns:o,rows:a,struts:l,boundingBox:h}=t;if(n=Math.ceil(n),r&&a-1>0){let[i,c,u,d]=h;u+=i,d+=c;const f=ni(),p=f.engine,m=f.element;m.width=n,m.height=n,p.setTransform(1,0,0,1,0,0),p.putImageData(r,0,0);const g=ni(),y=g.engine,b=g.element;b.width=u,b.height=d,y.globalAlpha=t.state.globalAlpha,y.setTransform(1,0,0,1,0,0);const k=parseFloat((n/(a-1)).toFixed(4)),S=parseFloat((n/(o-1)).toFixed(4));let O,P,v,w,x,A,C,D,R,E,F,T,H,M,I,B,L,$,j,N,X,Y,z;for(X=0,Y=a-1;X<Y;X++)for(O=l[X],P=l[X+1],j=0,N=o-1;j<N;j++){let[t,e,i,r,o]=O[j],[a,l,h,c,u]=P[j];for(o*=n,u*=n,v=Math.max(o,u,S),w=S/v,x=(i-t)/v,A=(r-e)/v,C=(h-a)/v,D=(c-l)/v,z=0;z<v;z++){R=t+x*z,E=e+A*z,F=a+C*z,T=l+D*z,M=X*k,H=j*S+w*z,I=R-F,B=E-T,L=Math.sqrt(I*I+B*B),$=Math.atan2(B,I)+s,y.setTransform(1,0,0,1,R,E),y.rotate($);let i=M+k>n?n-M:k;y.drawImage(m,H,M,1,i,0,0,1,L)}}let G=t.interferenceFactor,W=t.interferenceLoops,V=Math.ceil(u*G),U=Math.ceil(d*G);m.width=V,m.height=U,y.setTransform(1,0,0,1,0,0),p.setTransform(1,0,0,1,0,0);for(let t=0;t<W;t++)p.drawImage(b,0,0,u,d,0,0,V,U),y.drawImage(m,0,0,V,U,0,0,u,d);let q=y.getImageData(0,0,u,d);ri(f),ri(g),t.dirtyTargetImage=!0,e(q)}else i(new Error(this.name+" - cleanOutput Error: source has a zero dimension, or no data"))})},cn.regularStamp=function(){let t=this;return new Promise((e,i)=>{t.currentHost&&(t.regularStampSynchronousActions(),e(!0)),i(new Error(t.name+" has no current host"))})},cn.regularStampSynchronousActions=function(){let t=this.currentHost;if(t){let e=t.engine;this.noCanvasEngineUpdates||t.setEngine(this),this[this.method](e)}},cn.fill=function(t){this.doFill(t)},cn.draw=function(t){this.doStroke(t)},cn.drawAndFill=function(t){this.doStroke(t),this.currentHost.clearShadow(),this.doFill(t)},cn.fillAndDraw=function(t){this.doFill(t),this.currentHost.clearShadow(),this.doStroke(t)},cn.drawThenFill=function(t){this.doStroke(t),this.doFill(t)},cn.fillThenDraw=function(t){this.doFill(t),this.doStroke(t)},cn.clear=function(t){let e=this.output,i=!!this.currentHost&&this.currentHost.element,s=t.globalCompositeOperation;if(e&&i){let n=ni(),r=n.engine,o=n.element,a=i.width,l=i.height;o.width=a,o.height=l,r.putImageData(e,0,0),t.setTransform(1,0,0,1,0,0),t.globalCompositeOperation="destination-out",t.drawImage(o,0,0),t.globalCompositeOperation=s,ri(n)}},cn.none=B,cn.doStroke=function(t){t.setTransform(1,0,0,1,0,0),t.stroke(this.pathObject)},cn.doFill=function(t){let e=this.output,i=!!this.currentHost&&this.currentHost.element;if(e&&i){let s=ni(),n=s.engine,r=s.element,o=i.width,a=i.height;r.width=o,r.height=a,n.putImageData(e,0,0),t.setTransform(1,0,0,1,0,0),t.drawImage(r,0,0),ri(s)}},cn.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;if(!this.pathObject)return!1;let i=Array.isArray(t)?t:[t],s=!1;e||(e=ni(),s=!0);let n,r,o=e.engine;if(i.some(t=>{if(Array.isArray(t))n=t[0],r=t[1];else{if(!tt(t,t.x,t.y))return!1;n=t.x,r=t.y}return!(!n.toFixed||!r.toFixed||isNaN(n)||isNaN(r))&&o.isPointInPath(this.pathObject,n,r,this.winding)},this)){let t={x:n,y:r,artefact:this};return s&&ri(e),t}return s&&ri(e),!1};O.Mesh=hn;const Spring=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.action||(this.action=B),this};let fn=Spring.prototype=Object.create(Object.prototype);fn.type="Spring",fn.lib="spring",fn.isArtefact=!1,fn.isAsset=!1,fn=ee(fn);fn.defs=_(fn.defs,{particleFrom:null,particleFromIsStatic:!1,particleTo:null,particleToIsStatic:!1,springConstant:50,damperConstant:10,restLength:1}),fn.packetObjects=Q(fn.packetObjects,["particleFrom","particleTo"]),fn.kill=function(){return this.deregister(),!0};let pn=fn.setters;pn.particleFrom=function(t){t.substring&&(t=d[t]),t&&"Particle"===t.type&&(this.particleFrom=t)},pn.particleTo=function(t){t.substring&&(t=d[t]),t&&"Particle"===t.type&&(this.particleTo=t)},fn.applySpring=function(){let{particleFrom:t,particleTo:e,particleFromIsStatic:i,particleToIsStatic:s,springConstant:n,damperConstant:r,restLength:o}=this;if(t&&e){let{position:a,velocity:l,load:h}=t,{position:c,velocity:u,load:d}=e,f=fi(u).vectorSubtract(l),p=fi(c).vectorSubtract(a),m=fi(p).normalize(),g=fi(m);m.scalarMultiply(n*(p.getMagnitude()-o)),f.vectorMultiply(g).scalarMultiply(r).vectorMultiply(g);let y=fi(m).vectorAdd(f);i||h.vectorAdd(y),s||d.vectorSubtract(y),pi(f)}};const mn=function(t){return new Spring(t)};O.Spring=Spring;const Net=function(t={}){return this.makeName(t.name),this.register(),this.initializePositions(),this.set(this.defs),this.onEnter=B,this.onLeave=B,this.onDown=B,this.onUp=B,this.generate=B,this.postGenerate=B,this.stampAction=B,this.particleStore=[],this.springs=[],t.group||(t.group=Gi),this.set(t),this.purge&&this.purgeArtefact(this.purge),this};let gn=Net.prototype=Object.create(Object.prototype);gn.type="Net",gn.lib="entity",gn.isArtefact=!0,gn.isAsset=!1,gn=ee(gn),gn=ps(gn);gn.defs=_(gn.defs,{world:null,artefact:null,historyLength:1,forces:null,mass:1,engine:"euler",springConstant:50,damperConstant:10,restLength:1,showSprings:!1,showSpringsColor:"#000000",rows:0,columns:0,rowDistance:0,columnDistance:0,shapeTemplate:null,precision:20,joinTemplateEnds:!1,particlesAreDraggable:!1,hitRadius:10,showHitRadius:!1,hitRadiusColor:"#000000",resetAfterBlur:3}),gn.packetExclusions=Q(gn.packetExclusions,["forces","springs","particleStore"]),gn.packetExclusionsByRegex=Q(gn.packetExclusionsByRegex,[]),gn.packetCoordinates=Q(gn.packetCoordinates,[]),gn.packetObjects=Q(gn.packetObjects,["world","artefact","shapeTemplate"]),gn.packetFunctions=Q(gn.packetFunctions,["generate","postGenerate","stampAction"]),gn.finalizePacketOut=function(t,e){let i=e.forces||this.forces||!1;if(i){let e=[];i.forEach(t=>{t.substring?e.push(t):U(t)&&t.name&&e.push(t.name)}),t.forces=e}let s=[];return this.particleStore.forEach(t=>s.push(t.saveAsPacket())),t.particleStore=s,t},gn.postCloneAction=function(t,e){return t},gn.factoryKill=function(t,e){this.isRunning=!1,t&&(this.artefact.kill(),this.shapeTemplate&&this.shapeTemplate.kill()),e&&this.world.kill(),this.purgeParticlesFromLibrary()},gn.purgeParticlesFromLibrary=function(){let{particleStore:t,springs:e}=this;s.forEach(t=>{let e=i[t];e&&(e.particle&&!e.particle.substring&&e.particle.name&&(e.particle=e.particle.name),"Polyline"===e.type&&e.useParticlesAsPins&&e.pins.forEach((t,i)=>{U(t)&&"Particle"===t.type&&(e.pins[i]=t.name,e.dirtyPins=!0)}))}),t.forEach(t=>t.kill()),t.length=0,e.forEach(t=>t.kill()),e.length=0};gn.getters;let yn=gn.setters;gn.deltaSetters;yn.generate=function(t){W(t)?this.generate=t:t.substring&&bn[t]&&(this.generate=bn[t])},yn.postGenerate=function(t){W(t)&&(this.postGenerate=t)},yn.stampAction=function(t){W(t)&&(this.stampAction=t)},yn.world=function(t){let e;t.substring?e=g[t]:U(t)&&"World"===t.type&&(e=t),e&&(this.world=e)},yn.artefact=function(t){let e;t.substring?e=i[t]:U(t)&&t.isArtefact&&(e=t),e&&(this.artefact=e)},yn.shapeTemplate=function(t){let e;t.substring?e=h[t]:U(t)&&t.isArtefact&&J(t.species)&&(e=t),e&&(this.shapeTemplate=e)},gn.regularStampSynchronousActions=function(){let{world:t,artefact:e,particleStore:i,springs:s,generate:n,postGenerate:r,stampAction:o,lastUpdated:a,resetAfterBlur:l,showSprings:h,showSpringsColor:c,showHitRadius:u,hitRadius:d,hitRadiusColor:f}=this,p=1,m="source-over";this.state&&(p=this.state.globalAlpha,m=this.state.globalCompositeOperation);let g=this.currentHost,y=.016,b=Date.now();if(a&&(y=(b-a)/1e3),y>l&&(this.purgeParticlesFromLibrary(),y=.016),i.length||(n.call(this,g),r.call(this)),i.forEach(e=>e.applyForces(t,g)),s.forEach(t=>t.applySpring()),i.forEach(e=>e.update(y,t)),h){let t=g.engine;t.save(),t.globalAlpha=p,t.globalCompositeOperation=m,t.strokeStyle=c,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.shadowColor="rgba(0,0,0,0)",t.lineWidth=1,t.setTransform(1,0,0,1,0,0),t.beginPath(),s.forEach(e=>{let{particleFrom:i,particleTo:s}=e;t.moveTo(i.position.x,i.position.y),t.lineTo(s.position.x,s.position.y)}),t.stroke(),t.restore()}if(i.forEach(t=>{t.manageHistory(y,g),o.call(this,e,t,g)}),u){let t=g.engine;t.save(),t.globalAlpha=p,t.globalCompositeOperation=m,t.lineWidth=1,t.strokeStyle=f,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.shadowColor="rgba(0,0,0,0)",t.setTransform(1,0,0,1,0,0),t.beginPath(),i.forEach(e=>{t.moveTo(e.position.x,e.position.y),t.arc(e.position.x,e.position.y,d,0,2*Math.PI)}),t.stroke(),t.restore()}this.lastUpdated=b},gn.restart=function(){return this.purgeParticlesFromLibrary(),this.lastUpdated=Date.now(),this},gn.checkHit=function(t=[],e){if(this.lastHitParticle=null,!this.particlesAreDraggable)return!1;if(this.noUserInteraction)return!1;let i,s,n,r,o,a=Array.isArray(t)?t:[t],l=this.particleStore,h=!1;if(a.some(t=>{if(Array.isArray(t))i=t[0],s=t[1];else{if(!tt(t,t.x,t.y))return!1;i=t.x,s=t.y}if(!i.toFixed||!s.toFixed||isNaN(i)||isNaN(s))return!1;let e=fi();for(n=0,r=l.length;n<r;n++)if(o=l[n],e.set(o.position).vectorSubtract(t),e.getMagnitude()<this.hitRadius){h=o;break}return pi(e),h},this)){let t=this.checkHitReturn(i,s,e,h);return this.lastHitParticle=h,t}return!1},gn.checkHitReturn=function(t,e,i,s){return{x:t,y:e,artefact:this,particle:s}},gn.pickupArtefact=function(t={}){let e=this.lastHitParticle;return tt(t,e)&&(e.isBeingDragged=t,e.dragOffset=fi(e.position).vectorSubtract(t),this.lastHitParticle),this},gn.dropArtefact=function(){return this.lastHitParticle.isBeingDragged=null,pi(this.lastHitParticle.dragOffset),this.lastHitParticle.dragOffset=null,this.lastHitParticle=null,this};const bn={"weak-net":function(t){let{particleStore:e,artefact:i,historyLength:s,engine:n,forces:r,springs:o,mass:a,rows:l,columns:h,rowDistance:c,columnDistance:u,showSprings:f,showSpringsColor:p,name:m,springConstant:g,damperConstant:y,restLength:b}=this;if(t&&l>0&&h>0){let f,p,k,S,O,[P,v]=this.currentStampPosition,[w,x]=t.currentDimensions,A=c.substring?parseFloat(c)/100*x:c,C=u.substring?parseFloat(u)/100*x:u;for(S=0;S<l;S++)for(p=A*S+v,O=0;O<h;O++)f=C*O+P,k=Ns({name:`${m}-${S}-${O}`,positionX:f,positionY:p,positionZ:0,velocityX:0,velocityY:0,velocityZ:0,historyLength:s,engine:n,forces:r,mass:a,fill:i.get("fillStyle"),stroke:i.get("strokeStyle")}),k.run(0,0,!1),e.push(k);const D=function(t,e,i){let s,n,r;s=fi(t.position).vectorSubtract(e.position),n=s.getMagnitude(),r=mn({name:i,particleFrom:t,particleTo:e,springConstant:g,damperConstant:y,restLength:n*b}),o.push(r),pi(s)};let R,E;for(S=0;S<l;S++)for(O=0;O<h-1;O++)R=d[`${m}-${S}-${O}`],E=d[`${m}-${S}-${O+1}`],D(R,E,`${m}-${S}-${O}~${m}-${S}-${O+1}`);for(S=0;S<h;S++)for(O=0;O<l-1;O++)R=d[`${m}-${O}-${S}`],E=d[`${m}-${O+1}-${S}`],D(R,E,`${m}-${O}-${S}~${m}-${O+1}-${S}`)}},"strong-net":function(t){let{particleStore:e,artefact:i,historyLength:s,engine:n,forces:r,springs:o,mass:a,rows:l,columns:h,rowDistance:c,columnDistance:u,showSprings:f,showSpringsColor:p,name:m,springConstant:g,damperConstant:y,restLength:b}=this;if(t&&l>0&&h>0){let f,p,k,S,O,[P,v]=this.currentStampPosition,[w,x]=t.currentDimensions,A=c.substring?parseFloat(c)/100*x:c,C=u.substring?parseFloat(u)/100*x:u;for(S=0;S<l;S++)for(p=A*S+v,O=0;O<h;O++)f=C*O+P,k=Ns({name:`${m}-${S}-${O}`,positionX:f,positionY:p,positionZ:0,velocityX:0,velocityY:0,velocityZ:0,historyLength:s,engine:n,forces:r,mass:a,fill:i.get("fillStyle"),stroke:i.get("strokeStyle")}),k.run(0,0,!1),e.push(k);const D=function(t,e,i){let s,n,r;s=fi(t.position).vectorSubtract(e.position),n=s.getMagnitude(),r=mn({name:i,particleFrom:t,particleTo:e,springConstant:g,damperConstant:y,restLength:n*b}),o.push(r),pi(s)};let R,E;for(S=0;S<l;S++)for(O=0;O<h-1;O++)R=d[`${m}-${S}-${O}`],E=d[`${m}-${S}-${O+1}`],D(R,E,`${m}-${S}-${O}~${m}-${S}-${O+1}`);for(S=0;S<h;S++)for(O=0;O<l-1;O++)R=d[`${m}-${O}-${S}`],E=d[`${m}-${O+1}-${S}`],D(R,E,`${m}-${O}-${S}~${m}-${O+1}-${S}`);for(S=0;S<h-1;S++)for(O=0;O<l-1;O++)R=d[`${m}-${O}-${S}`],E=d[`${m}-${O+1}-${S+1}`],D(R,E,`${m}-${O}-${S}~${m}-${O+1}-${S+1}`);for(S=0;S<h-1;S++)for(O=l-1;O>0;O--)R=d[`${m}-${O}-${S}`],E=d[`${m}-${O-1}-${S+1}`],D(R,E,`${m}-${O}-${S}~${m}-${O-1}-${S+1}`)}},"weak-shape":function(t){let{particleStore:e,artefact:i,historyLength:s,engine:n,forces:r,springs:o,mass:a,showSprings:l,showSpringsColor:h,name:c,springConstant:u,damperConstant:f,restLength:p,shapeTemplate:m,precision:g,joinTemplateEnds:y}=this;const b=function(t,e,i){let s,n,r;s=fi(t.position).vectorSubtract(e.position),n=s.getMagnitude(),r=mn({name:i,particleFrom:t,particleTo:e,springConstant:u,damperConstant:f,restLength:n*p}),o.push(r),pi(s)};let k,S,O,P;if(m&&g){for(k=0;k<g;k++){let t=m.getPathPositionData(k/g);S=Ns({name:`${c}-${k}`,positionX:t.x,positionY:t.y,positionZ:0,velocityX:0,velocityY:0,velocityZ:0,historyLength:s,engine:n,forces:r,mass:a,fill:i.get("fillStyle"),stroke:i.get("strokeStyle")}),S.run(0,0,!1),e.push(S)}for(k=0;k<g-1;k++)O=d[`${c}-${k}`],P=d[`${c}-${k+1}`],b(O,P,`${c}-${k}~${c}-${k+1}`);for(y&&(O=d[`${c}-${g-1}`],P=d[c+"-0"],b(O,P,`${c}-${g-1}~${c}-0`)),k=0;k<g-2;k++)O=d[`${c}-${k}`],P=d[`${c}-${k+2}`],b(O,P,`${c}-${k}~${c}-${k+2}`);for(y&&(O=d[`${c}-${g-2}`],P=d[c+"-0"],b(O,P,`${c}-${g-2}~${c}-0`),O=d[`${c}-${g-1}`],P=d[c+"-1"],b(O,P,`${c}-${g-1}~${c}-1`)),k=0;k<g-3;k++)O=d[`${c}-${k}`],P=d[`${c}-${k+3}`],b(O,P,`${c}-${k}~${c}-${k+3}`);y&&(O=d[`${c}-${g-3}`],P=d[c+"-0"],b(O,P,`${c}-${g-3}~${c}-0`),O=d[`${c}-${g-2}`],P=d[c+"-1"],b(O,P,`${c}-${g-2}~${c}-1`),O=d[`${c}-${g-1}`],P=d[c+"-2"],b(O,P,`${c}-${g-1}~${c}-2`))}},"strong-shape":function(t){let{particleStore:e,artefact:i,historyLength:s,engine:n,forces:r,springs:o,mass:a,showSprings:l,showSpringsColor:h,name:c,springConstant:u,damperConstant:f,restLength:p,shapeTemplate:m,precision:g,joinTemplateEnds:y}=this;const b=function(t,e,i){let s,n,r;s=fi(t.position).vectorSubtract(e.position),n=s.getMagnitude(),r=mn({name:i,particleFrom:t,particleTo:e,springConstant:u,damperConstant:f,restLength:n*p}),o.push(r),pi(s)};let k,S,O,P;if(m&&g){for(k=0;k<g;k++){let t=m.getPathPositionData(k/g);S=Ns({name:`${c}-${k}`,positionX:t.x,positionY:t.y,positionZ:0,velocityX:0,velocityY:0,velocityZ:0,historyLength:s,engine:n,forces:r,mass:a,fill:i.get("fillStyle"),stroke:i.get("strokeStyle")}),S.run(0,0,!1),e.push(S)}for(k=0;k<g-1;k++)O=d[`${c}-${k}`],P=d[`${c}-${k+1}`],b(O,P,`${c}-${k}~${c}-${k+1}`);for(y&&(O=d[`${c}-${g-1}`],P=d[c+"-0"],b(O,P,`${c}-${g-1}~${c}-0`)),k=0;k<g-2;k++)O=d[`${c}-${k}`],P=d[`${c}-${k+2}`],b(O,P,`${c}-${k}~${c}-${k+2}`);for(y&&(O=d[`${c}-${g-2}`],P=d[c+"-0"],b(O,P,`${c}-${g-2}~${c}-0`),O=d[`${c}-${g-1}`],P=d[c+"-1"],b(O,P,`${c}-${g-1}~${c}-1`)),k=0;k<g-3;k++)O=d[`${c}-${k}`],P=d[`${c}-${k+3}`],b(O,P,`${c}-${k}~${c}-${k+3}`);y&&(O=d[`${c}-${g-3}`],P=d[c+"-0"],b(O,P,`${c}-${g-3}~${c}-0`),O=d[`${c}-${g-2}`],P=d[c+"-1"],b(O,P,`${c}-${g-2}~${c}-1`),O=d[`${c}-${g-1}`],P=d[c+"-2"],b(O,P,`${c}-${g-1}~${c}-2`));let t=Math.floor(g/2);for(k=0;k<g-t;k++)O=d[`${c}-${k}`],k+t<g-1&&(P=d[`${c}-${k+t}`],b(O,P,`${c}-${k}~${c}-${k+t}`))}},"hub-spoke":function(t){let{shapeTemplate:e,precision:i}=this;if(e&&e.type&&i){let{particleStore:s,artefact:n,historyLength:r,engine:o,forces:a,springs:l,mass:h,showSprings:c,showSpringsColor:u,name:f,springConstant:p,damperConstant:m,restLength:g,joinTemplateEnds:y}=this;const b=function(t,e,i){let s,n,r;s=fi(t.position).vectorSubtract(e.position),n=s.getMagnitude(),r=mn({name:i,particleFrom:t,particleTo:e,springConstant:p,damperConstant:m,restLength:n*g}),l.push(r),pi(s)};let k,S,O,P,v;if(["Bezier","Line","Oval","Polygon","Polyline","Quadratic","Rectangle","Shape","Spiral","Star","Tetragon"].indexOf(e.type)>=0){for(k=0;k<i;k++){let t=e.getPathPositionData(k/i);S=Ns({name:`${f}-${k}`,positionX:t.x,positionY:t.y,positionZ:0,velocityX:0,velocityY:0,velocityZ:0,historyLength:r,engine:o,forces:a,mass:h,fill:n.get("fillStyle"),stroke:n.get("strokeStyle")}),S.run(0,0,!1),s.push(S)}for(k=0;k<i-1;k++)O=d[`${f}-${k}`],P=d[`${f}-${k+1}`],b(O,P,`${f}-${k}-${k+1}`);for(y&&(O=d[`${f}-${i-1}`],P=d[f+"-0"],b(O,P,`${f}-${i-1}-0`)),k=0;k<i-2;k++)O=d[`${f}-${k}`],P=d[`${f}-${k+2}`],b(O,P,`${f}-${k}~${f}-${k+2}`);y&&(O=d[`${f}-${i-2}`],P=d[f+"-0"],b(O,P,`${f}-${i-2}~${f}-0`),O=d[`${f}-${i-1}`],P=d[f+"-1"],b(O,P,`${f}-${i-1}~${f}-1`))}else["Block","Cell","Element","Grid","Phrase","Picture","Stack"].indexOf(t.type)>=0||t.type;let[w,x]=e.get("position");v=Ns({name:f+"-hub",positionX:w,positionY:x,positionZ:0,velocityX:0,velocityY:0,velocityZ:0,historyLength:r,engine:o,forces:a,mass:h,fill:n.get("fillStyle"),stroke:n.get("strokeStyle")}),v.run(0,0,!1),s.forEach((t,e)=>b(t,v,`${f}-${e}-hub`)),s.push(v)}}};O.Net=Net;const kn=function(t={}){this.makeName(t.name),this.register();let e=document.createElement("canvas");return e.id=this.name,this.installElement(e),this.perm=[],this.permMod8=[],this.values=[],this.grad=[],this.subscribers=[],this.colorFactory=Ts({name:this.name+"-color-factory",minimumColor:t.gradientStart||"red",maximumColor:t.gradientEnd||"green"}),this.set(this.defs),this.set(t),t.subscribe&&this.subscribers.push(t.subscribe),this.dirtyOutput=!0,this};let Sn=kn.prototype=Object.create(Object.prototype);Sn.type="Noise",Sn.lib="asset",Sn.isArtefact=!1,Sn.isAsset=!0,Sn=ee(Sn),Sn=Me(Sn),Sn=Qe(Sn);Sn.defs=_(Sn.defs,{width:300,height:150,color:"monochrome",monochromeStart:0,monochromeRange:255,gradientStart:"#ff0000",gradientEnd:"#00ff00",hueStart:0,hueRange:120,saturation:100,luminosity:50,noiseEngine:"simplex",seed:"any_random_string_will_do",size:256,scale:50,octaves:1,octaveFunction:"none",persistence:.5,lacunarity:2,smoothing:"quintic",sumFunction:"none",sineFrequencyCoeff:1,modularAmplitude:5}),delete Sn.defs.source,delete Sn.defs.sourceLoaded,Sn.stringifyFunction=B,Sn.processPacketOut=B,Sn.finalizePacketOut=B,Sn.saveAsPacket=function(){return`[${this.name}, ${this.type}, ${this.lib}, {}]`},Sn.clone=$;Sn.getters;let On=Sn.setters;Sn.deltaSetters;On.source=B,On.subscribers=B,On.octaveFunction=function(t){this.octaveFunction=this.octaveFunctions[t]||L,this.dirtyNoise=!0,this.dirtyOutput=!0},On.sumFunction=function(t){this.sumFunction=this.sumFunctions[t]||L,this.dirtyNoise=!0,this.dirtyOutput=!0},On.smoothing=function(t){this.smoothing=this.smoothingFunctions[t]||L,this.dirtyNoise=!0,this.dirtyOutput=!0},On.noiseEngine=function(t){this.noiseEngine=this.noiseEngines[t]||this.noiseEngines.simplex,this.dirtyNoise=!0,this.dirtyOutput=!0},On.octaves=function(t){t.toFixed&&(this.octaves=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.seed=function(t){t.substring&&(this.seed=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},Sn.supportedColorSchemes=["monochrome","gradient","hue"],On.color=function(t){this.supportedColorSchemes.indexOf(t)>=0&&(this.color=t,this.dirtyOutput=!0)},On.scale=function(t){t.toFixed&&(this.scale=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.size=function(t){t.toFixed&&(this.size=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.persistence=function(t){t.toFixed&&(this.persistence=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.lacunarity=function(t){t.toFixed&&(this.lacunarity=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.gradientStart=function(t){t.substring&&(this.colorFactory.setMinimumColor(t),this.dirtyOutput=!0)},On.gradientEnd=function(t){t.substring&&(this.colorFactory.setMaximumColor(t),this.dirtyOutput=!0)},On.monochromeStart=function(t){t.toFixed&&t>=0&&(this.monochromeStart=t%360,this.dirtyOutput=!0)},On.monochromeRange=function(t){t.toFixed&&t>=-255&&t<256&&(this.monochromeRange=Math.floor(t),this.dirtyOutput=!0)},On.hueStart=function(t){t.toFixed&&(this.hueStart=t,this.dirtyOutput=!0)},On.hueRange=function(t){t.toFixed&&(this.hueRange=t,this.dirtyOutput=!0)},On.saturation=function(t){t.toFixed&&t>=0&&t<=100&&(this.saturation=Math.floor(t),this.dirtyOutput=!0)},On.luminosity=function(t){t.toFixed&&t>=0&&t<=100&&(this.luminosity=Math.floor(t),this.dirtyOutput=!0)},On.sineFrequencyCoeff=function(t){t.toFixed&&(this.sineFrequencyCoeff=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.modularAmplitude=function(t){t.toFixed&&(this.modularAmplitude=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.width=function(t){t.toFixed&&(this.width=t,this.sourceNaturalWidth=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},On.height=function(t){t.toFixed&&(this.height=t,this.sourceNaturalHeight=t,this.dirtyNoise=!0,this.dirtyOutput=!0)},Sn.installElement=function(t){return this.element=t,this.engine=this.element.getContext("2d"),this},Sn.checkSource=function(t,e){this.notifySubscribers()},Sn.getData=function(t,e){return this.notifySubscribers(),this.buildStyle(e)},Sn.notifySubscribers=function(){(this.dirtyOutput||this.dirtyNoise)&&this.cleanOutput(),this.subscribers.forEach(t=>this.notifySubscriber(t),this)},Sn.notifySubscriber=function(t){t.sourceNaturalWidth=this.width,t.sourceNaturalHeight=this.height,t.sourceLoaded=!0,t.source=this.element,t.dirtyImage=!0,t.dirtyCopyStart=!0,t.dirtyCopyDimensions=!0,t.dirtyImageSubscribers=!0},Sn.cleanOutput=function(){this.dirtyNoise&&this.cleanNoise(),this.dirtyOutput&&this.paintCanvas()},Sn.cleanNoise=function(){if(this.dirtyNoise){this.dirtyNoise=!1;let{noiseEngine:t,seed:e,width:i,height:s,element:n,engine:r,octaves:o,lacunarity:a,persistence:l,scale:h,octaveFunction:c,sumFunction:u}=this;if(t&&t.init){this.rndEngine=function(t){return new nt(t)}(e),this.generatePermutationTable(),t.init.call(this);let n,r,d,f,p,m,g,y,b=[];for(r=0;r<s;r++)for(b[r]=[],n=0;n<i;n++)b[r][n]=[];let k=Math.pow(i,-h/100),S=-1e3,O=1e3;for(r=0;r<s;r++)for(n=0;n<i;n++){for(f=n*k,p=r*k,m=0,g=1,y=1,d=0;d<o;d++){let e=t.getNoiseValue.call(this,f*y,p*y);e=c(e,f,p,d+1),e*=g,m+=e,y*=a,g*=l}b[r][n]=m,O=Math.min(O,m),S=Math.max(S,m)}let P=S-O;for(r=0;r<s;r++)for(n=0;n<i;n++){f=n*k,p=r*k;let t=(b[r][n]-O)/P;b[r][n]=u.call(this,t,n*k,r*k)}this.noiseValues=b}else this.dirtyNoise=!0}},Sn.paintCanvas=function(){if(this.dirtyOutput){this.dirtyOutput=!1;let{noiseValues:t,element:e,engine:i,width:s,height:n,color:r,colorFactory:o,monochromeStart:a,monochromeRange:l,hueStart:h,hueRange:c,saturation:u,luminosity:d}=this;if(null!=t)switch(e.width=s,e.height=n,r){case"hue":for(let e=0;e<n;e++)for(let n=0;n<s;n++)i.fillStyle=`hsl(${(h+t[e][n]*c)%360}, ${u}%, ${d}%)`,i.fillRect(n,e,1,1);break;case"gradient":for(let e=0;e<n;e++)for(let n=0;n<s;n++)i.fillStyle=o.getRangeColor(t[e][n]),i.fillRect(n,e,1,1);break;default:l>0?a+l>255&&(l=255-a):l<0&&a-l<0&&(l=a);for(let e=0;e<n;e++)for(let n=0;n<s;n++){let s=Math.floor(a+t[e][n]*l);i.fillStyle=`rgb(${s}, ${s}, ${s})`,i.fillRect(n,e,1,1)}}else this.dirtyOutput=!0}},Sn.simplexConstantF=.5*(Math.sqrt(3)-1),Sn.simplexConstantG=(3-Math.sqrt(3))/6,Sn.simplexConstantDoubleG=(3-Math.sqrt(3))/6*2,Sn.perlinGrad=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]],Sn.noiseEngines={perlin:{init:function(){const{grad:t,size:e,rndEngine:i}=this;let s;t.length=0;for(let n=0;n<e;n++)t[n]=[2*i.random()-1,2*i.random()-1],s=Math.sqrt(t[n][0]*t[n][0]+t[n][1]*t[n][1]),t[n][0]/=s,t[n][1]/=s},getNoiseValue:function(t,e){const{size:i,perm:s,grad:n,smoothing:r}=this;let o,a,l,h,c=Math.floor(t)%i,u=(c+1)%i,d=t-Math.floor(t),f=d-1,p=Math.floor(e)%i,m=(p+1)%i,g=e-Math.floor(e),y=g-1,b=s[c],k=s[u],S=s[b+p],O=s[k+p],P=s[b+m],v=s[k+m],w=r(d),x=r(g);return l=d*n[S][0]+g*n[S][1],h=f*n[O][0]+g*n[O][1],o=X(w,l,h),l=d*n[P][0]+y*n[P][1],h=f*n[v][0]+y*n[v][1],a=X(w,l,h),.5*(1+X(x,o,a))}},"improved-perlin":{init:B,getNoiseValue:function(t,e){const{size:i,perm:s,permMod8:n,perlinGrad:r,smoothing:o}=this;let a,l,h,c,u=Math.floor(t)%i,d=(u+1)%i,f=t-Math.floor(t),p=f-1,m=Math.floor(e)%i,g=(m+1)%i,y=e-Math.floor(e),b=y-1,k=s[u],S=s[d],O=n[k+m],P=n[S+m],v=n[k+g],w=n[S+g],x=o(f),A=o(y);return h=f*r[O][0]+y*r[O][1],c=p*r[P][0]+y*r[P][1],a=X(x,h,c),h=f*r[v][0]+b*r[v][1],c=p*r[w][0]+b*r[w][1],l=X(x,h,c),.5*(1+X(A,a,l))}},simplex:{init:B,getNoiseValue:function(t,e){const i=function(t,e,i){let s=.5-t*t-e*e;if(s<0)return 0;let[n,r]=a[i];return s*s*(n*t+r*e)},{simplexConstantF:s,simplexConstantG:n,simplexConstantDoubleG:r,size:o,perlinGrad:a,perm:l,permMod8:h}=this;let c=(t+e)*s,u=Math.floor(t+c),d=Math.floor(e+c),f=(u+d)*n,p=t-(u-f),m=e-(d-f),g=u%o,y=d%o,b=h[g+l[y]],k=i(p,m,b);b=h[g+1+l[y+1]],k+=i(p-1+r,m-1+r,b);let S=0,O=1;return p>m&&(S=1,O=0),b=h[g+S+l[y+O]],k+=i(p-S+n,m-O+n,b),.5+35*k}},value:{init:function(){const{values:t,size:e,rndEngine:i}=this;t.length=0;for(let s=0;s<e;s++)t[s]=t[s+e]=i.random()},getNoiseValue:function(t,e){const{values:i,size:s,perm:n,smoothing:r}=this;let o=Math.floor(t)%s,a=Math.floor(e)%s,l=(o+1)%s,h=(a+1)%s,c=t-Math.floor(t),u=e-Math.floor(e),d=r(c),f=r(u),p=n[o],m=n[l],g=n[p+a],y=n[m+a],b=n[p+h],k=n[m+h],S=X(d,i[g],i[y]),O=X(d,i[b],i[k]);return X(f,S,O)}}},Sn.generatePermutationTable=function(){const{perm:t,permMod8:e,rndEngine:i,size:s}=this;let n,r,o;for(t.length=0,e.length=0,n=0;n<s;n++)t[n]=n;for(;--n;)r=Math.floor(i.random()*s),o=t[n],t[n]=t[r],t[r]=o;for(n=0;n<s;n++)t[n+s]=t[n],e[n]=e[n+s]=t[n]%8},Sn.octaveFunctions={none:L,absolute:function(t){return Math.abs(2*t-1)}},Sn.sumFunctions={none:L,"sine-x":function(t,e,i){return.5+Math.sin(e*this.sineFrequencyCoeff+t)/2},"sine-y":function(t,e,i){return.5+Math.sin(i*this.sineFrequencyCoeff+t)/2},sine:function(t,e,i){return.5+Math.sin(e*this.sineFrequencyCoeff+t)/4+Math.sin(i*this.sineFrequencyCoeff+t)/4},modular:function(t){let e=t*this.modularAmplitude;return e-Math.floor(e)}},Sn.smoothingFunctions={none:L,easeOutSine:rt,easeInSine:ot,easeOutInSine:at,easeOutQuad:lt,easeInQuad:ht,easeOutInQuad:ct,easeOutCubic:ut,easeInCubic:dt,easeOutInCubic:ft,easeOutQuart:pt,easeInQuart:mt,easeOutInQuart:gt,easeOutQuint:yt,easeInQuint:bt,easeOutInQuint:kt,easeOutExpo:St,easeInExpo:Ot,easeOutInExpo:Pt,easeOutCirc:vt,easeInCirc:wt,easeOutInCirc:At,easeOutBack:Ct,easeInBack:Dt,easeOutInBack:Rt,easeOutElastic:Et,easeInElastic:Ft,easeOutInElastic:Tt,easeOutBounce:Ht,easeInBounce:Mt,easeOutInBounce:It,cosine:function(t){return.5*(1+Math.cos((1-t)*Math.PI))},hermite:function(t){return t*t*(2*-t+3)},quintic:function(t){return t*t*t*(t*(6*t-15)+10)}};O.Noise=kn;const Oval=function(t={}){return this.shapeInit(t),this};let Pn=Oval.prototype=Object.create(Object.prototype);Pn.type="Oval",Pn.lib="entity",Pn.isArtefact=!0,Pn.isAsset=!1,Pn=ee(Pn),Pn=Os(Pn);Pn.defs=_(Pn.defs,{radiusX:5,radiusY:5,intersectX:.5,intersectY:.5,offshootA:.55,offshootB:0});let vn=Pn.setters,wn=Pn.deltaSetters;vn.radius=function(t){this.setRectHelper(t,["radiusX","radiusY"])},vn.radiusX=function(t){this.setRectHelper(t,["radiusX"])},vn.radiusY=function(t){this.setRectHelper(t,["radiusY"])},wn.radius=function(t){this.deltaRectHelper(t,["radiusX","radiusY"])},wn.radiusX=function(t){this.deltaRectHelper(t,["radiusX"])},wn.radiusY=function(t){this.deltaRectHelper(t,["radiusY"])},vn.offshootA=function(t){this.offshootA=t,this.updateDirty()},vn.offshootB=function(t){this.offshootB=t,this.updateDirty()},wn.offshootA=function(t){t.toFixed&&(this.offshootA+=t,this.updateDirty())},wn.offshootB=function(t){t.toFixed&&(this.offshootB+=t,this.updateDirty())},vn.intersectA=function(t){this.intersectA=t,this.updateDirty()},vn.intersectB=function(t){this.intersectB=t,this.updateDirty()},wn.intersectA=function(t){t.toFixed&&(this.intersectA+=t,this.updateDirty())},wn.intersectB=function(t){t.toFixed&&(this.intersectB+=t,this.updateDirty())},Pn.setRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=t},this)},Pn.deltaRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=addStrings(this[e],t)},this)},Pn.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeOvalPath(),this.pathDefinition=t},Pn.makeOvalPath=function(){let t,e,i=parseFloat(this.offshootA.toFixed(6)),s=parseFloat(this.offshootB.toFixed(6)),n=this.radiusX,r=this.radiusY;if(n.substring||r.substring){let i=this.getHost();if(i){let[s,o]=i.currentDimensions;t=2*(n.substring?parseFloat(n)/100*s:n),e=2*(r.substring?parseFloat(r)/100*o:r)}}else t=2*n,e=2*r;let o=parseFloat((t*this.intersectX).toFixed(2)),a=parseFloat((t-o).toFixed(2)),l=parseFloat((e*this.intersectY).toFixed(2)),h=parseFloat((e-l).toFixed(2)),c="m0,0";return c+=`c${a*i},${l*s} ${a-a*s},${l-l*i}, ${a},${l} `,c+=`${-a*s},${h*i} ${a*i-a},${h-h*s} ${-a},${h} `,c+=`${-o*i},${-h*s} ${o*s-o},${h*i-h} ${-o},${-h} `,c+=`${o*s},${-l*i} ${o-o*i},${l*s-l} ${o},${-l}z`,c},Pn.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};O.Oval=Oval;const VideoAsset=function(t={}){return this.assetConstructor(t)};let xn=VideoAsset.prototype=Object.create(Object.prototype);xn.type="Video",xn.lib="asset",xn.isArtefact=!1,xn.isAsset=!0,xn=ee(xn),xn=Me(xn),xn.saveAsPacket=function(){return[this.name,this.type,this.lib,{}]},xn.stringifyFunction=B,xn.processPacketOut=B,xn.finalizePacketOut=B,xn.clone=$;xn.getters;let An=xn.setters;xn.deltaSetters;An.source=function(t={}){t&&("VIDEO"===t.tagName.toUpperCase()&&(this.source=t,this.sourceNaturalWidth=t.videoWidth||0,this.sourceNaturalHeight=t.videoHeight||0,this.sourceLoaded=t.readyState>2),this.sourceLoaded&&this.notifySubscribers())},xn.checkSource=function(t,e){let i=this.source;i&&i.readyState>2?(this.sourceLoaded=!0,this.sourceNaturalWidth===i.videoWidth&&this.sourceNaturalHeight===i.videoHeight&&this.sourceNaturalWidth===t&&this.sourceNaturalHeight===e||(this.sourceNaturalWidth=i.videoWidth,this.sourceNaturalHeight=i.videoHeight,this.notifySubscribers())):this.sourceLoaded=!1},xn.addTextTrack=function(t,e,i){let s=this.source;s&&s.addTextTrack&&s.addTextTrack(t,e,i)},xn.captureStream=function(){let t=this.source;return!(!t||!t.captureStream)&&t.captureStream()},xn.canPlayType=function(t){let e=this.source;return e?e.canPlayType(t):"maybe"},xn.fastSeek=function(t){let e=this.source;e&&e.fastSeek&&e.fastSeek(t)},xn.load=function(){let t=this.source;t&&t.load()},xn.pause=function(){let t=this.source;t&&t.pause()},xn.play=function(){let t=this.source;return t?t.play().catch(t=>console.log(t.code,t.name,t.message)):Promise.reject("Source not defined")},xn.setMediaKeys=function(t){let e=this.source;return e?e.setMediaKeys?e.setMediaKeys(t):Promise.reject("setMediaKeys not supported"):Promise.reject("Source not defined")},xn.setSinkId=function(){let t=this.source;return t?t.setSinkId?t.setSinkId():Promise.reject("setSinkId not supported"):Promise.reject("Source not defined")};const Cn=["video_audioTracks","video_autoPlay","video_buffered","video_controller","video_controls","video_controlsList","video_crossOrigin","video_currentSrc","video_currentTime","video_defaultMuted","video_defaultPlaybackRate","video_disableRemotePlayback","video_duration","video_ended","video_error","video_loop","video_mediaGroup","video_mediaKeys","video_muted","video_networkState","video_paused","video_playbackRate","video_readyState","video_seekable","video_seeking","video_sinkId","video_src","video_srcObject","video_textTracks","video_videoTracks","video_volume"],Dn=["video_autoPlay","video_controller","video_controls","video_crossOrigin","video_currentTime","video_defaultMuted","video_defaultPlaybackRate","video_disableRemotePlayback","video_loop","video_mediaGroup","video_muted","video_playbackRate","video_src","video_srcObject","video_volume"],Rn=function(...t){let e=/.*\/(.*?)\./,i="";if(t.length){let s,n,r,o,a,l,h=!1,c=t[0];if(c.substring){let i=e.exec(c);s=i&&i[1]?i[1]:"",a=[...t],n="",r=!1,o=null,l="auto",h=!0}else c&&c.src&&(s=c.name||"",a=[...c.src],n=c.className||"",r=c.visibility||!1,o=document.querySelector(o),l=c.preload||"auto",h=!0);let u=En({name:s});if(h){let t=document.createElement("video");t.name=s,t.className=n,t.style.display=r?"block":"none",t.crossOrigin="anonymous",t.preload=l,a.forEach(e=>{let i=document.createElement("source");i.src=e,t.appendChild(i)}),t.onload=()=>{u.set({source:t}),o&&o.appendChild(t)},u.set({source:t}),i=s}}return i},En=function(t){return new VideoAsset(t)};O.VideoAsset=VideoAsset;const SpriteAsset=function(t={}){return this.assetConstructor(t),this};let Fn=SpriteAsset.prototype=Object.create(Object.prototype);Fn.type="Sprite",Fn.lib="asset",Fn.isArtefact=!1,Fn.isAsset=!0,Fn=ee(Fn),Fn=Me(Fn);Fn.defs=_(Fn.defs,{manifest:null}),Fn.saveAsPacket=function(){return[this.name,this.type,this.lib,{}]},Fn.stringifyFunction=B,Fn.processPacketOut=B,Fn.finalizePacketOut=B,Fn.clone=$;Fn.getters;let Tn=Fn.setters;Fn.deltaSetters;Tn.source=function(t=[]){if(t&&t[0]){this.sourceHold||(this.sourceHold={});let e=this.sourceHold;t.forEach(t=>{let i=t.id||t.name;i&&(e[i]=t)}),this.source=t[0],this.sourceNaturalWidth=t[0].naturalWidth,this.sourceNaturalHeight=t[0].naturalHeight,this.sourceLoaded=t[0].complete}},Fn.checkSource=B;const Hn=function(...t){let e=/.*\/(.*?)\./,i=/\.(jpeg|jpg|png|gif|webp|svg|JPEG|JPG|PNG|GIF|WEBP|SVG)/,s=[];return t.forEach(t=>{let n,r,o,a,l,h=!1,c=!1;if(t.substring){let s=e.exec(t);n=s&&s[1]?s[1]:"",r=[t],o="",a=!1,l=t.replace(i,".json"),c=!0}else U(t)&&t.imageSrc&&t.manifestSrc?(n=t.name||"",r=Array.isArray(t.imageSrc)?t.imageSrc:[t.imageSrc],l=t.manifestSrc,o=t.className||"",a=t.visibility||!1,h=document.querySelector(t.parent),c=!0):s.push(!1);if(c){let t=Mn({name:n});U(l)?t.manifest=l:fetch(l).then(t=>{if(200!==t.status)throw new Error("Failed to load manifest");return t.json()}).then(e=>t.manifest=e).catch(t=>console.log(t.message));let c=[];r.forEach(t=>{let s,r,l=document.createElement("img");i.test(t)&&(r=e.exec(t),s=r&&r[1]?r[1]:""),l.name=s||n,l.className=o,l.crossorigin="anonymous",l.style.display=a?"block":"none",h&&h.appendChild(l),l.src=t,c.push(l)}),t.set({source:c}),s.push(n)}else s.push(!1)}),s},Mn=function(t){return new SpriteAsset(t)};function In(t={}){t.defs=_(t.defs,{asset:null,removeAssetOnKill:!1,spriteIsRunning:!1,spriteLastFrameChange:0,spriteCurrentFrame:0,spriteTrack:"default",spriteForward:!0,spriteFrameDuration:100,spriteWillLoop:!0});let e=t.setters;return e.asset=function(t){let e=this.asset,i=t&&t.name?t.name:t;e&&!e.substring&&e.unsubscribe(this),this.asset=i,this.dirtyAsset=!0},e.imageSource=function(t){let e=je(t);if(e){let t=n[e[0]];if(t){let e=this.asset;e&&e.unsubscribe&&e.unsubscribe(this),t.subscribe(this)}}},e.videoSource=function(t){let e=Rn(t);if(e){let t=n[e];if(t){let e=this.asset;e&&e.unsubscribe&&e.unsubscribe(this),t.subscribe(this)}}},e.spriteSource=function(t){let e=Hn(t);if(e){let t=n[e];if(t){let e=this.asset;e&&e.unsubscribe&&e.unsubscribe(this),t.subscribe(this)}}},t.cleanAsset=function(){let t=this.asset;if(t&&t.substring){let e=n[t];e&&(this.dirtyAsset=!1,e.subscribe(this))}},t.videoAction=function(t,...e){let i=this.asset;if(i&&"Video"===i.type)return i[t](...e)},t.videoPromiseAction=function(t,...e){let i=this.asset;return i&&"Video"===i.type?i[t](...e):Promise.reject("Asset not a video")},t.videoAddTextTrack=function(t,e,i){return this.videoAction("addTextTrack",t,e,i)},t.videoCaptureStream=function(){return this.videoAction("captureStream")},t.videoCanPlayType=function(t){return this.videoAction("canPlayType",t)},t.videoFastSeek=function(t){return this.videoAction("fastSeek",t)},t.videoLoad=function(){return this.videoAction("load")},t.videoPause=function(){return this.videoAction("pause")},t.videoPlay=function(){return this.videoPromiseAction("play")},t.videoSetMediaKeys=function(t){return this.videoPromiseAction("setMediaKeys",t)},t.videoSetSinkId=function(){return this.videoPromiseAction("setSinkId")},t.checkSpriteFrame=function(){let t=this.asset;if(t&&"Sprite"===t.type){let e=this.copyArray;if(this.spriteIsRunning){let i=this.spriteLastFrameChange,s=this.spriteFrameDuration,n=Date.now();if(n>i+s){let i=t.manifest;if(i){let s=i[this.spriteTrack],r=s.length,o=this.spriteCurrentFrame,a=this.spriteWillLoop;o=this.spriteForward?o+1:o-1,o<0&&(o=a?r-1:0),o>=r&&(o=a?0:r-1);let[l,h,c,u,d]=s[o];if(e.length=0,e.push(h,c,u,d),this.dirtyCopyStart=!1,this.dirtyCopyDimensions=!1,l!==(this.source.id||this.source.name)){let e=t.sourceHold[l];e&&(this.source=e)}this.spriteCurrentFrame=o,this.spriteLastFrameChange=n}}}else{let[i,s,n,r,o]=t.manifest[this.spriteTrack][this.spriteCurrentFrame],[a,l,h,c]=e;a===s&&l===n&&h===r&&c===o||(e.length=0,e.push(s,n,r,o),this.dirtyCopyStart=!1,this.dirtyCopyDimensions=!1)}}},t.playSprite=function(t,e,i,s,n){J(t)&&(this.spriteFrameDuration=t),J(e)&&(this.spriteWillLoop=e),J(i)&&(this.spriteTrack=i),J(s)&&(this.spriteForward=s),J(n)&&(this.spriteCurrentFrame=n),this.spriteLastFrameChange=Date.now(),this.spriteIsRunning=!0},t.haltSprite=function(t,e,i,s,n){J(t)&&(this.spriteFrameDuration=t),J(e)&&(this.spriteWillLoop=e),J(i)&&(this.spriteTrack=i),J(s)&&(this.spriteForward=s),J(n)&&(this.spriteCurrentFrame=n),this.spriteIsRunning=!1},t}O.SpriteAsset=SpriteAsset;const Pattern=function(t={}){return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this};let Bn=Pattern.prototype=Object.create(Object.prototype);Bn.type="Pattern",Bn.lib="styles",Bn.isArtefact=!1,Bn.isAsset=!1,Bn=ee(Bn),Bn=Qe(Bn),Bn=In(Bn);Bn.defs=_(Bn.defs,{}),Bn.packetObjects=Q(Bn.packetObjects,["asset"]),Bn.finalizePacketOut=function(t,e){if(Array.isArray(e.patternMatrix))t.patternMatrix=e.patternMatrix;else{let e=this.patternMatrix;e&&(t.patternMatrix=[e.a,e.b,e.c,e.d,e.e,e.f])}return t},Bn.kill=function(){let{name:t,asset:e,removeAssetOnKill:i}=this;return U(e)&&e.unsubscribe(this),Object.entries(h).forEach(([e,i])=>{let s=i.state;if(s){let e=s.fillStyle,i=s.strokeStyle;U(e)&&e.name===t&&(s.fillStyle=s.defs.fillStyle),U(i)&&i.name===t&&(s.strokeStyle=s.defs.strokeStyle)}}),i&&(i.substring?e.kill(!0):e.kill()),this.deregister(),this},Bn.get=function(t){let e=this.source;if(0!==t.indexOf("video_")&&0!==t.indexOf("image_")||!e){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t];return void 0!==i?(e=this[t],void 0!==e?e:i):undef}}return Cn.indexOf(t)>=0||Le.indexOf(t)>=0?e[t.substring(6)]:void 0},Bn.set=function(t={}){if(Object.keys(t).length){let e,i=this.setters,s=this.defs,n=this.source;Object.entries(t).forEach(([t,r])=>{0!==t.indexOf("video_")&&0!==t.indexOf("image_")||!n?t&&"name"!==t&&null!=r&&(e=i[t],e?e.call(this,r):void 0!==s[t]&&(this[t]=r)):(Dn.indexOf(t)>=0||$e.indexOf(t)>=0)&&(n[t.substring(6)]=r)},this)}return this},Bn.getData=function(t,e){return this.dirtyAsset&&this.cleanAsset(),this.asset.checkSource(this.sourceNaturalWidth,this.sourceNaturalHeight),this.buildStyle(e)};O.Pattern=Pattern;const FontAttributes=function(t={}){return this.makeName(t.name),this.set(this.defs),this.set(t),this};let Ln=FontAttributes.prototype=Object.create(Object.prototype);Ln.type="FontAttributes",Ln.lib="fontattribute",Ln=ee(Ln);Ln.defs=_(Ln.defs,{style:"normal",variant:"normal",weight:"normal",stretch:"normal",sizeValue:12,sizeMetric:"px",family:"sans-serif"});let $n=Ln.getters,jn=Ln.setters;Ln.deltaSetters;$n.size=function(){return this.sizeValue?`${this.sizeValue}${this.sizeMetric}`:this.sizeMetric},jn.size=function(t){if(J(t)){let e,i,s,n=0,r="medium";t.indexOf("xx-small")>=0?r="xx-small":t.indexOf("x-small")>=0?r="x-small":t.indexOf("smaller")>=0?r="smaller":t.indexOf("small")>=0?r="small":t.indexOf("medium")>=0?r="medium":t.indexOf("xxx-large")>=0?r="xxx-large":t.indexOf("xx-large")>=0?r="xx-large":t.indexOf("x-large")>=0?r="x-large":t.indexOf("larger")>=0?r="larger":t.indexOf("large")>=0?r="large":(n=12,r="px");let o=t.match(/(\d+\.\d+|\d+|\.\d+)(rem|em|rlh|lh|ex|cap|ch|ic|%|vw|vh|vmax|vmin|vi|vb|in|cm|mm|Q|pc|pt|px)?/i);Array.isArray(o)?([e,i,s]=o,i&&s&&"."!=i&&(n=i,r=s)):(o=t.match(/\/(\d+\.\d+|\d+|\.\d+)(rem|em|rlh|lh|ex|cap|ch|ic|%|vw|vh|vmax|vmin|vi|vb|in|cm|mm|Q|pc|pt|px)?/i),Array.isArray(o)&&([e,i,s]=o,i&&s&&"."!=i&&(n=i,r=s))),n!==this.sizeValue&&(this.sizeValue=n,this.dirtyFont=!0),r!==this.sizeMetric&&(this.sizeMetric=r,this.dirtyFont=!0)}},jn.sizeValue=function(t){J(t)&&t!==this.sizeValue&&(this.sizeValue=t,this.dirtyFont=!0)},jn.sizeMetric=function(t){J(t)&&t!==this.sizeMetric&&(this.sizeMetric=t,this.dirtyFont=!0)},jn.font=function(t){J(t)&&(jn.style.call(this,t),jn.variant.call(this,t),jn.weight.call(this,t),jn.stretch.call(this,t),jn.size.call(this,t),jn.family.call(this,t))},jn.style=function(t){if(J(t)){let e="normal";e=t.indexOf("italic")>=0?"italic":e,e=t.indexOf("oblique")>=0?"oblique":e,e!==this.style&&(this.style=e,this.dirtyFont=!0)}},jn.variant=function(t){if(J(t)){let e="normal";e=t.indexOf("small-caps")>=0?"small-caps":e,e!==this.variant&&(this.variant=e,this.dirtyFont=!0)}},jn.weight=function(t){if(J(t)){let e="normal";t.toFixed?e=t:(e=t.indexOf("bold")>=0?"bold":e,e=t.indexOf("lighter")>=0?"lighter":e,e=t.indexOf("bolder")>=0?"bolder":e,e=t.indexOf(" 100 ")>=0?"100":e,e=t.indexOf(" 200 ")>=0?"200":e,e=t.indexOf(" 300 ")>=0?"300":e,e=t.indexOf(" 400 ")>=0?"400":e,e=t.indexOf(" 500 ")>=0?"500":e,e=t.indexOf(" 600 ")>=0?"600":e,e=t.indexOf(" 700 ")>=0?"700":e,e=t.indexOf(" 800 ")>=0?"800":e,e=t.indexOf(" 900 ")>=0?"900":e,e=/^\d00$/.test(t)?t:e),e!==this.weight&&(this.weight=e,this.dirtyFont=!0)}},jn.stretch=function(t){if(J(t)){let e="normal";e=t.indexOf("semi-condensed")>=0?"semi-condensed":e,e=t.indexOf("condensed")>=0?"condensed":e,e=t.indexOf("extra-condensed")>=0?"extra-condensed":e,e=t.indexOf("ultra-condensed")>=0?"ultra-condensed":e,e=t.indexOf("semi-expanded")>=0?"semi-expanded":e,e=t.indexOf("expanded")>=0?"expanded":e,e=t.indexOf("extra-expanded")>=0?"extra-expanded":e,e=t.indexOf("ultra-expanded")>=0?"ultra-expanded":e,e!==this.stretch&&(this.stretch=e,this.dirtyFont=!0)}},Ln.rfsTestArray1=["italic","oblique","small-caps","normal","bold","lighter","bolder","ultra-condensed","extra-condensed","semi-condensed","condensed","ultra-expanded","extra-expanded","semi-expanded","expanded","xx-small","x-small","small","medium","xxx-large","xx-large","x-large","large"],Ln.rfsTestArray2=["0","1","2","3","4","5","6","7","8","9"],jn.family=function(t){if(J(t)){let e="sans-serif",i=t.split(" "),s=i.length;1===s&&(e=t);let n=0,r=!0;for(;r;)if(n===s)r=!1;else{let t=i[n];t.length?this.rfsTestArray1.indexOf(t)>=0||this.rfsTestArray2.indexOf(t[0])>=0?n++:r=!1:n++}n<s&&(e=i.slice(n).join(" ")),e!==this.family&&(this.family=e,this.dirtyFont=!0)}},Ln.getFontString=function(){return!this.dirtyFont&&this.temperedFontString?this.temperedFontString:this.buildFont()},Ln.updateMetadata=function(t,e,i){t&&t.toFixed&&t>0&&t!==this.scale&&(this.scale=t,this.dirtyFont=!0),e&&e.toFixed&&e>0&&e!==this.lineHeight&&(this.lineHeight=e,this.dirtyFont=!0);let s=this.host&&this.host.type&&"Cell"===this.host.type?this.host.name:"";i&&i.type&&"Cell"===i.type&&i.name!==s&&(this.host=i,this.dirtyFont=!0)},Ln.calculateSize=function(){if(this.host){let t,e,i,s,{scale:n,lineHeight:r,host:o,sizeValue:a,sizeMetric:l}=this;if(o.getComputedFontSizes())[t,e,i,s]=o.getComputedFontSizes();else if(["in","cm","mm","Q","pc","pt","px"].indexOf(l)<0)return this.dirtyFont=!0,"12px";isNaN(a)&&(a=12);let h=t;switch(l){case"rem":h=e*a;break;case"em":h=t*a;break;case"rlh":h=e*r*a;break;case"lh":h=t*r*a;break;case"ex":h=t/2*a;break;case"cap":case"ch":case"ic":h=t*a;break;case"%":h=t/100*a;break;case"vw":h=i/100*a;break;case"vh":h=s/100*a;break;case"vmax":h=Math.max(i,s)/100*a;break;case"vmin":h=Math.min(i,s)/100*a;break;case"vi":h=i/100*a;break;case"vb":h=s/100*a;break;case"in":h=96*a;break;case"cm":h=37.8*a;break;case"mm":h=3.78*a;break;case"Q":h=.95*a;break;case"pc":h=16*a;break;case"pt":h=1.33*a;break;case"px":h=a;break;case"xx-small":h=.6*t;break;case"x-small":h=.75*t;break;case"smaller":h=.8*t;break;case"small":h=.89*t;break;case"xxx-large":h=3*t;break;case"xx-large":h=2*t;break;case"x-large":h=1.5*t;break;case"larger":h=1.3*t;break;case"large":h=1.2*t}return h*n+"px"}return"12px"},Ln.buildFont=function(){this.dirtyFont=!1;let t="";"normal"!==this.style&&(t+=this.style+" "),"normal"!==this.variant&&(t+=this.variant+" "),"normal"!==this.weight&&(t+=this.weight+" "),"normal"!==this.stretch&&(t+=this.stretch+" "),t+=this.calculateSize()+" ",t+=""+this.family;let e=ni();return e.engine.font=t,t=e.engine.font,ri(e),this.temperedFontString=t,t},Ln.update=function(t){return t&&this.set(t),this.getFontString()};O.FontAttributes=FontAttributes;const Nn=document.createElement("div");Nn.style.padding=0,Nn.style.border=0,Nn.style.margin=0,Nn.style.height="auto",Nn.style.lineHeight=1,Nn.style.boxSizing="border-box",Nn.innerHTML="|/}qwertyd0123456789QWERTY",Nn.setAttribute("aria-hidden","true"),is.appendChild(Nn);const Xn=document.createElement("textarea"),Yn=(t,e)=>(t=parseFloat(t),V(t)||(t=0),V(e)||(e=0),parseFloat(t.toFixed(e))),zn=(t,e)=>(t=parseFloat(t),V(t)||(t=0),V(e)||(e=0),Math.abs(parseFloat(t.toFixed(e)))),Phrase=function(t={}){return this.fontAttributes=function(t){return new FontAttributes(t)}(t),delete t.font,delete t.style,delete t.variant,delete t.weight,delete t.stretch,delete t.size,delete t.sizeValue,delete t.sizeMetric,delete t.family,this.entityInit(t),this.sectionStyles=[],this.sectionClasses={DEFAULTS:{defaults:!0},BOLD:{weight:"bold"},ITALIC:{style:"italic"},"SMALL-CAPS":{variant:"small-caps"},HIGHLIGHT:{highlight:!0},UNDERLINE:{underline:!0},OVERLINE:{overline:!0},"/BOLD":{weight:"normal"},"/ITALIC":{style:"normal"},"/SMALL-CAPS":{variant:"normal"},"/HIGHLIGHT":{highlight:!1},"/UNDERLINE":{underline:!1},"/OVERLINE":{overline:!1}},this.dirtyDimensions=!0,this.dirtyText=!0,this.dirtyFont=!0,this.dirtyPathObject=!0,this};let Gn=Phrase.prototype=Object.create(Object.prototype);Gn.type="Phrase",Gn.lib="entity",Gn.isArtefact=!0,Gn.isAsset=!1,Gn=ee(Gn),Gn=ps(Gn);Gn.defs=_(Gn.defs,{text:"",width:"auto",exposeText:!0,lineHeight:1.15,letterSpacing:0,justify:"left",sectionClassMarker:"",sectionClasses:null,overlinePosition:-.1,overlineStyle:"rgb(250,0,0)",underlinePosition:.6,underlineStyle:"rgb(250,0,0)",highlightStyle:"rgba(250,218,94,0.4)",boundingBoxColor:"rgba(0,0,0,0.5)",showBoundingBox:!1,textPath:"",textPathPosition:0,textPathLoop:!0,addTextPathRoll:!0,textPathDirection:"ltr",treatWordAsGlyph:!1}),Gn.packetExclusions=Q(Gn.packetExclusions,["textPositions","textLines","textLineWidths","textLineWords","textGlyphs","textGlyphWidths","fontAttributes"]),Gn.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];t=_(t,i);let s=JSON.parse(this.fontAttributes.saveAsPacket(e))[3];return delete s.name,t=_(t,s),t=this.handlePacketAnchor(t,e)},Gn.factoryKill=function(){this.exposedTextHold&&this.exposedTextHold.remove()};let Wn=Gn.getters,Vn=Gn.setters,Un=Gn.deltaSetters;Vn.handleX=function(t){null!=t&&(this.handle[0]=t,this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0)},Vn.handleY=function(t){null!=t&&(this.handle[1]=t,this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0)},Vn.handle=function(t,e){this.setCoordinateHelper("handle",t,e),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},Un.handleX=function(t){let e=this.handle;e[0]=addStrings(e[0],t),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},Un.handleY=function(t){let e=this.handle;e[1]=addStrings(e[1],t),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},Un.handle=function(t,e){this.setDeltaCoordinateHelper("handle",t,e),this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},Wn.text=function(){return this.currentText||this.text||""},Vn.text=function(t){var e;this.text=(e=t).substring?e:e.toString,this.dirtyText=!0,this.dirtyPathObject=!0,this.dirtyDimensions=!0},Gn.permittedJustifications=["left","right","center","full"],Vn.justify=function(t){this.permittedJustifications.indexOf(t)>=0&&(this.justify=t),this.dirtyText=!0,this.dirtyPathObject=!0},Vn.width=function(t){this.dimensions[0]=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyPathObject=!0,this.dirtyText=!0},Un.width=function(t){let e=this.dimensions;e[0]=addStrings(e[0],t),this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyPathObject=!0,this.dirtyText=!0},Vn.scale=function(t){this.scale=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyFont=!0,this.dirtyPathObject=!0,this.dirtyScale=!0},Un.scale=function(t){this.scale+=t,this.dirtyDimensions=!0,this.dirtyHandle=!0,this.dirtyFont=!0,this.dirtyPathObject=!0,this.dirtyScale=!0},Vn.lineHeight=function(t){this.lineHeight=zn(t,3),this.lineHeight<.5&&(this.lineHeight=.5),this.dirtyPathObject=!0,this.dirtyText=!0},Un.lineHeight=function(t){this.lineHeight+=Yn(t,3),this.lineHeight<.5&&(this.lineHeight=.5),this.dirtyPathObject=!0,this.dirtyText=!0},Vn.letterSpacing=function(t){this.letterSpacing=zn(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},Un.letterSpacing=function(t){this.letterSpacing+=Yn(t,3),this.letterSpacing<0&&(this.letterSpacing=0),this.dirtyPathObject=!0,this.dirtyText=!0},Vn.overlinePosition=function(t){this.overlinePosition=Yn(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},Un.overlinePosition=function(t){this.overlinePosition+=Yn(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},Vn.underlinePosition=function(t){this.underlinePosition=Yn(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},Un.underlinePosition=function(t){this.underlinePosition+=Yn(t,3),this.dirtyPathObject=!0,this.dirtyText=!0},Vn.textPath=function(t){this.textPath=t,this.dirtyHandle=!0,this.dirtyText=!0,this.dirtyPathObject=!0},Vn.textPathPosition=function(t){this.textPathLoop?(t<0&&(t=Math.abs(t)),t>1&&(t%=1),this.textPathPosition=parseFloat(t.toFixed(6))):this.textPathPosition=t},Un.textPathPosition=function(t){let e=this.textPathPosition+t;this.textPathLoop?(e<0&&(e+=1),e>1&&(e%=1),this.textPathPosition=parseFloat(e.toFixed(6))):this.textPathPosition=e},Wn.font=function(){return this.fontAttributes.get("font")},Vn.font=function(t){this.fontAttributes.set({font:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.style=function(){return this.fontAttributes.get("style")},Vn.style=function(t){this.fontAttributes.set({style:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.variant=function(){return this.fontAttributes.get("variant")},Vn.variant=function(t){this.fontAttributes.set({variant:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.weight=function(){return this.fontAttributes.get("weight")},Vn.weight=function(t){this.fontAttributes.set({weight:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.stretch=function(){return this.fontAttributes.get("stretch")},Vn.stretch=function(t){this.fontAttributes.set({stretch:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.size=function(){return this.fontAttributes.get("size")},Vn.size=function(t){this.fontAttributes.set({size:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.sizeValue=function(){return this.fontAttributes.get("sizeValue")},Vn.sizeValue=function(t){this.fontAttributes.set({sizeValue:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Un.sizeValue=function(t){this.fontAttributes.deltaSet({sizeValue:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.sizeMetric=function(){return this.fontAttributes.get("sizeMetric")},Vn.sizeMetric=function(t){this.fontAttributes.set({sizeMetric:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Wn.family=function(){return this.fontAttributes.get("family")},Vn.family=function(t){this.fontAttributes.set({family:t}),this.dirtyFont=!0,this.dirtyPathObject=!0},Gn.cleanDimensionsAdditionalActions=function(){if(this.fontAttributes.dirtyFont=!0,this.fontAttributes.updateMetadata(this.scale,this.lineHeight,this.getHost()),"auto"===this.dimensions[0]){this.buildText();let t=ni(),e=t.engine;e.font=this.fontAttributes.getFontString(),this.currentDimensions[0]=Math.ceil(e.measureText(this.currentText).width/this.scale),ri(t)}this.textLines?this.currentDimensions[1]=Math.ceil(this.textHeight*this.textLines.length*this.lineHeight/this.scale):this.dirtyDimensions=!0},Gn.setSectionStyles=function(t){let e,i,s,n=new RegExp(this.sectionClassMarker),r=t.split(n),o=this.sectionStyles,a=this.sectionClasses,l="";return o.length=0,r.forEach(t=>{e=a[t],e?(i=l.length,s=o[i],s?Object.assign(s,e):o[i]=Object.assign({},e)):J(t)&&(l+=t)}),l},Gn.addSectionClass=function(t,e){return tt(t,e)&&t.substring&&U(e)&&(this.sectionClasses[t]=e),this.dirtyText=!0,this.dirtyPathObject=!0,this},Gn.removeSectionClass=function(t){return delete this.sectionClasses[t],this.dirtyText=!0,this.dirtyPathObject=!0,this},Gn.getTextPath=function(){let t=this.textPath;return t&&t.substring&&(t=this.textPath=i[this.textPath],"Shape"===t.type&&t.useAsPath?t.pathed.push(this.name):t=this.path=!1),t},Gn.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){this.dirtyFont&&this.fontAttributes&&(this.dirtyFont=!1,this.dirtyText=!0,this.dirtyMimicDimensions=!0,this.dirtyPositionSubscribers=!0),this.dirtyText&&this.buildText(),this.dirtyHandle&&this.cleanHandle();let t=this.pathObject=new Path2D,e=this.currentHandle,i=this.currentDimensions,s=this.currentScale,n=-e[0]*s,r=-e[1]*s,o=i[0]*s,a=i[1]*s;this.boxStartValues=[n,r],t.rect(n,r,o,a)}},Gn.buildText=function(){this.dirtyText=!1;let t=this.convertTextEntityCharacters(this.text);if(t=this.setSectionStyles(t),this.currentText=t,isNaN(this.currentDimensions[0]))this.dirtyText=!0;else if(this.calculateTextPositions(t),this.exposeText){if(!this.exposedTextHold){let t=document.createElement("div");t.id=this.name+"-text-hold",t.setAttribute("aria-live","polite"),this.exposedTextHold=t,this.exposedTextHoldAttached=!1}this.exposedTextHold.textContent=t,this.exposedTextHoldAttached||this.currentHost&&this.currentHost.controller&&this.currentHost.controller.textHold&&(this.currentHost.controller.textHold.appendChild(this.exposedTextHold),this.exposedTextHoldAttached=!0)}},Gn.convertTextEntityCharacters=function(t){let e=t.trim();return e=e.replace(/[\s\uFEFF\xA0]+/g," "),Xn.innerHTML=e,Xn.value},Gn.calculateTextPositions=function(t){const e=function(t){if(!H)return T.dirtyPathObject=!0,T.dirtyText=!0,"black";if(t.substring){let e=!1;if(k.indexOf(t)>=0?e=b[t]:l.indexOf(t)>=0&&(e=a[t]),e)return e}return t};let i,s,n,r,o,h,c,u,d,f,p,m,g,y,S,O,P,v,w,x,A,C,D,R,E=ni(),F=E.engine,T=this,H=!(!this.group||!this.group.getHost)&&this.group.getHost(),M=[],I=[],B=[],L=[],$=[],j=[],N=[],X=this.getTextPath(),Y=this.fontAttributes,z=Y.clone({}),G=this.sectionStyles,W=this.state,V={},U=[],q=this.currentScale,_=this.currentDimensions,Z=_[0]*q,Q=this.treatWordAsGlyph,K=this.lineHeight,tt=this.justify;Y.updateMetadata(q,K,H),z.updateMetadata(q,K,H);let et=Y.getFontString(),it=e(W.fillStyle),st=e(W.strokeStyle),nt=this.letterSpacing*q,rt=et,ot=it,at=st,lt=nt,ht=(!!this.highlightStyle&&e(this.highlightStyle),!1),ct=(!!this.underlineStyle&&e(this.underlineStyle),this.underlinePosition,!1),ut=(!!this.overlineStyle&&e(this.overlineStyle),this.overlinePosition,!1),dt=0;for(i=Q?t.split(" "):t.split(""),U.push(rt),f=0,p=i.length;f<p;f++)r=i[f],$[f]=[,,,,,,r,0,0,0];for(G[0]||(G[0]={family:z.family,size:z.sizeValue?`${z.sizeValue}${z.sizeMetric}`:z.sizeMetric,stretch:z.stretch,style:z.style,variant:z.variant,weight:z.weight}),f=0,p=G.length;f<p;f++)s=G[f],s&&(n=$[f],n&&(0===f&&(n[0]=rt,n[3]=ht,n[4]=ct,n[5]=ut),s.defaults&&(rt=z.update(Y),at=st,ot=it,lt=nt,n[0]=rt,n[1]=at,n[2]=ot,n[3]=ht,n[4]=ct,n[5]=ut),r=s.stroke,r&&r!==at&&(at=e(s.stroke),n[1]=at),r=s.fill,r&&r!==ot&&(ot=e(s.fill),n[2]=ot),r=s.space,J(r)&&r!==lt&&(lt=r*q),r=s.highlight,J(r)&&r!==ht&&(ht=r,n[3]=ht),r=s.underline,J(r)&&r!==ct&&(ct=r,n[4]=ct),r=s.overline,J(r)&&r!==ut&&(ut=r,n[5]=ut),0!==f&&(s.variant||s.weight||s.style||s.stretch||s.size||s.sizeValue||s.sizeMetric||s.family||s.font)&&(r=z.update(s),r!==rt&&(rt=r,n[0]=rt,U.indexOf(rt)<0&&U.push(rt))))),M[f]=lt;for(f=0,p=i.length;f<p;f++)J(M[f])&&(lt=M[f]),M[f]=lt;for(U.forEach(t=>{Nn.style.font=t,r=Nn.clientHeight,V[t]=r}),dt=Math.max(...Object.values(V)),A=x=o=h=0,f=0,p=$.length;f<p;f++)O=$[f],P=O[6],O[0]&&(F.font=O[0]),j.push(F.measureText(P).width),v=$[f+1],v=!(Q||!v)&&v[6],S=!!v&&F.measureText(`${P}${v}`).width,N.push(S);for(f=0,p=N.length;f<p;f++)P=N[f],P&&(S=j[f]+j[f+1],n=$[f+1],S>P&&!n[0]&&(j[f]-=S-P));for(f=0,p=$.length;f<p;f++)O=$[f],P=O[6],w=j[f]+M[f],M[f]=w,(Q||" "===P)&&(h=f),x+=w,A+=w,x>=Z&&o<h&&(y=i.slice(o,h).join(""),I.push(y),S=Q?y.split(" ").length-1:y.split(" ").length,L.push(S),S=M.slice(o,h).reduce((t,e)=>t+e,0),B.push(S),x-=S,o=h+1),f+1===p&&(x===A?(y=t,I.push(y),L.push(Q?y.split(" ").length-1:y.split(" ").length),B.push(A)):(y=i.slice(o).join(""),I.push(y),S=Q?y.split(" ").length-1:y.split(" ").length,L.push(S),S=M.slice(o).reduce((t,e)=>t+e,0),B.push(S))),J(O[3])&&(ht=O[3]),J(O[4])&&(ct=O[4]),J(O[5])&&(ut=O[5]),O[3]=ht,O[4]=ct,O[5]=ut;if(q<=0&&(q=1),_[1]=Math.ceil(dt*I.length*K/q),this.cleanHandle(),this.dirtyHandle=!1,C=this.currentHandle,D=-C[0]*q,R=-C[1]*q,!X)if("full"===tt)for(c=0,u=R,f=0,p=B.length;f<p;f++){for(S=D,d=L[f]>1?(Z-B[f])/(L[f]-1):0,m=0,g=I[f].length;m<g;m++)r=$[c]," "===r[6]&&(M[c]+=d),r[7]=Math.floor(S),r[8]=Math.floor(u),r[9]=M[c],S+=M[c],c++;c++,u+=dt*K}else for(c=0,u=R,f=0,p=B.length;f<p;f++){for(S="right"===tt?Z-B[f]+D:"center"===tt?(Z-B[f])/2+D:D,m=0,g=I[f].length;m<g;m++)r=$[c],r&&(r[7]=Math.floor(S),r[8]=Math.floor(u),r[9]=M[c]),S+=M[c],c++;c++,u+=dt*K}this.textGlyphs=i,this.textGlyphWidths=M,this.textLines=I,this.textLineWidths=B,this.textLineWords=L,this.textPositions=$,this.textHeight=dt,this.textLength=A,this.fontLibrary=V,ri(E)},Gn.regularStampSynchronousActions=function(){let t,e,i,s,n,r=this.currentHost,o=this.method,a=this.preStamper,l=this.stamper;if(r)if(t=r.engine,"none"===this.method)this.performRotation(t);else if("clip"===this.method)this.performRotation(t),t.clip(this.pathObject,this.winding);else if(this.textPath){this.noCanvasEngineUpdates||r.setEngine(this),this.getTextPath(),this.calculateGlyphPathPositions(),s=this.textPositions;let h,c,u=this.addTextPathRoll,d=this.addPathRotation,f=this.currentRotation,p=this.currentHandle;for(this.addPathRotation=u,e=0,i=s.length;e<i;e++)h=s[e],c=h[10],c&&(this.currentPathData=c,u&&(this.currentRotation=c.angle),r.rotateDestination(t,c.x,c.y,this),t.translate(-p[0],-p[1]),n=a(r,t,this,h),l[o](t,this,n));this.addPathRotation=d,this.currentRotation=f}else{for(this.performRotation(t),this.noCanvasEngineUpdates||r.setEngine(this),s=this.textPositions||[],e=0,i=s.length;e<i;e++)n=a(r,t,this,s[e]),l[o](t,this,n);this.showBoundingBox&&this.drawBoundingBox(t)}},Gn.calculateGlyphPathPositions=function(){let t,e,i,s,n,r=this.getTextPath(),o=r.length,a=this.textPositions,l=this.textGlyphWidths,h="ltr"===this.textPathDirection,c=this.textPathPosition,u=this.justify,d=this.textPathLoop,f=this.constantPathSpeed;for(e=0,i=a.length;e<i;e++){switch(t=a[e],s=l[e],u){case"center":n=c+s/2/o,t[7]=-s/2;break;case"right":n=c+s/o,t[7]=-s;break;default:n=c}d&&(n>1||n<0)&&(n=n>.5?n-1:n+1),t[10]=n<=1&&n>=0&&r.getPathPositionData(n,f),t[9]=s,h?c+=s/o:c-=s/o,d&&(c>1||c<0)&&(c=c>.5?c-1:c+1)}},Gn.preStamper=function(t,e,i,s){const n=function(e){return e.getData?e.getData(i,t):e};let[r,o,a,l,h,c,...u]=s;if(r&&(e.font=r),l||h||c){let t=i.highlightStyle,s=i.textHeight,r=i.underlineStyle,o=i.underlinePosition,a=i.overlineStyle,d=i.overlinePosition;e.save(),l&&(e.fillStyle=n(t),e.fillRect(u[1],u[2],u[3],s)),h&&(e.strokeStyle=n(r),e.strokeRect(u[1],u[2]+s*o,u[3],1)),c&&(e.strokeStyle=n(a),e.strokeRect(u[1],u[2]+s*d,u[3],1)),e.restore()}return o&&(e.strokeStyle=n(o)),a&&(e.fillStyle=n(a)),u},Gn.stamper={draw:function(t,e,i){t.strokeText(...i)},fill:function(t,e,i){t.fillText(...i)},drawAndFill:function(t,e,i){t.strokeText(...i),e.currentHost.clearShadow(),t.fillText(...i),e.currentHost.restoreShadow(e)},fillAndDraw:function(t,e,i){t.strokeText(...i),e.currentHost.clearShadow(),t.fillText(...i),t.strokeText(...i),e.currentHost.restoreShadow(e)},drawThenFill:function(t,e,i){t.strokeText(...i),t.fillText(...i)},fillThenDraw:function(t,e,i){t.fillText(...i),t.strokeText(...i)},clear:function(t,e,i){let s=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fillText(...i),t.globalCompositeOperation=s}},Gn.drawBoundingBox=function(t){t.save(),t.strokeStyle=this.boundingBoxColor,t.lineWidth=1,t.globalCompositeOperation="source-over",t.globalAlpha=1,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.stroke(this.pathObject),t.restore()},Gn.performRotation=function(t){let e=this.currentHost;if(e){let[i,s]=this.currentStampPosition;e.rotateDestination(t,i,s,this)}};O.Phrase=Phrase;const Picture=function(t={}){return this.copyStart=He(),this.currentCopyStart=He(),this.copyDimensions=He(),this.currentCopyDimensions=He(),this.copyArray=[],this.pasteArray=[],this.entityInit(t),t.copyStart||(t.copyStartX||(this.copyStart[0]=0),t.copyStartY||(this.copyStart[1]=0)),t.copyDimensions||(t.copyWidth||(this.copyDimensions[0]=1),t.copyHeight||(this.copyDimensions[1]=1)),this.imageSubscribers=[],this.dirtyCopyStart=!0,this.dirtyCopyDimensions=!0,this.dirtyImage=!0,this};let qn=Picture.prototype=Object.create(Object.prototype);qn.type="Picture",qn.lib="entity",qn.isArtefact=!0,qn.isAsset=!1,qn=ee(qn),qn=ps(qn),qn=In(qn);qn.defs=_(qn.defs,{copyStart:null,copyDimensions:null,checkHitIgnoreTransparency:!1}),qn.packetCoordinates=Q(qn.packetCoordinates,["copyStart","copyDimensions"]),qn.packetObjects=Q(qn.packetObjects,["asset"]),qn.factoryKill=function(t=!1){let{asset:e,removeAssetOnKill:i}=this;U(e)&&e.unsubscribe(this),i&&(i.substring?e.kill(!0):e.kill())};let _n=qn.getters,Zn=qn.setters,Qn=qn.deltaSetters;_n.copyStartX=function(){return this.currentCopyStart[0]},_n.copyStartY=function(){return this.currentCopyStart[1]},Zn.copyStartX=function(t){null!=t&&(this.copyStart[0]=t,this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0)},Zn.copyStartY=function(t){null!=t&&(this.copyStart[1]=t,this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0)},Zn.copyStart=function(t,e){this.setCoordinateHelper("copyStart",t,e),this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0},Qn.copyStartX=function(t){let e=this.copyStart;e[0]=H(e[0],t),this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0},Qn.copyStartY=function(t){let e=this.copyStart;e[1]=H(e[1],t),this.dirtyCopyStart=!0},Qn.copyStart=function(t,e){this.setDeltaCoordinateHelper("copyStart",t,e),this.dirtyCopyStart=!0,this.dirtyImageSubscribers=!0},_n.copyWidth=function(){return this.currentCopyDimensions[0]},_n.copyHeight=function(){return this.currentCopyDimensions[1]},Zn.copyWidth=function(t){null!=t&&(this.copyDimensions[0]=t,this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0)},Zn.copyHeight=function(t){null!=t&&(this.copyDimensions[1]=t,this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0)},Zn.copyDimensions=function(t,e){this.setCoordinateHelper("copyDimensions",t,e),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},Qn.copyWidth=function(t){let e=this.copyDimensions;e[0]=H(e[0],t),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},Qn.copyHeight=function(t){let e=this.copyDimensions;e[1]=H(e[1],t),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},Qn.copyDimensions=function(t,e){this.setDeltaCoordinateHelper("copyDimensions",t,e),this.dirtyCopyDimensions=!0,this.dirtyImageSubscribers=!0},Zn.checkHitIgnoreTransparency=function(t){this.checkHitIgnoreTransparency=t,t&&(this.stashOutput=!0)},qn.get=function(t){let e=this.source;if(0!==t.indexOf("video_")&&0!==t.indexOf("image_")||!e){let e=this.getters[t];if(e)return e.call(this);{let e,i=this.defs[t],s=this.state;return void 0!==i?(e=this[t],void 0!==e?e:i):(i=s.defs[t],void 0!==i?(e=s[t],void 0!==e?e:i):undef)}}return Cn.indexOf(t)>=0||Le.indexOf(t)>=0?e[t.substring(6)]:void 0},qn.set=function(t={}){if(Object.keys(t).length){let e,i,s=this.setters,n=this.defs,r=this.state,o=this.source,a=r?r.setters:{},l=r?r.defs:{};Object.entries(t).forEach(([t,h])=>{0!==t.indexOf("video_")&&0!==t.indexOf("image_")||!o?t&&"name"!==t&&null!=h&&(e=s[t],i=!1,e||(e=a[t],i=!0),e?e.call(i?this.state:this,h):void 0!==n[t]?this[t]=h:void 0!==l[t]&&(r[t]=h)):(Dn.indexOf(t)>=0||$e.indexOf(t)>=0)&&(o[t.substring(6)]=h)},this)}return this},qn.updateImageSubscribers=function(){this.dirtyImageSubscribers=!1,this.imageSubscribers.length&&this.imageSubscribers.forEach(t=>{let e=i[t];e&&(e.dirtyInput=!0)})},qn.imageSubscribe=function(t){t&&t.substring&&Q(this.imageSubscribers,t)},qn.imageUnsubscribe=function(t){t&&t.substring&&K(this.imageSubscribers,t)},qn.cleanImage=function(){let t=this.sourceNaturalWidth,e=this.sourceNaturalHeight;if(tt(t,e)){this.dirtyImage=!1;let i=this.currentCopyStart,s=i[0],n=i[1],r=this.currentCopyDimensions,o=r[0],a=r[1];s+o>t&&(i[0]=t-o),n+a>e&&(i[1]=e-a);let l=this.copyArray;l.length=0,l.push(i[0],i[1],o,a)}},qn.cleanCopyStart=function(){let t=this.sourceNaturalWidth,e=this.sourceNaturalHeight;if(tt(t,e)){this.dirtyCopyStart=!1,this.cleanPosition(this.currentCopyStart,this.copyStart,[t,e]);let i=this.currentCopyStart,s=i[0],n=i[1];(s<0||s>t)&&(i[0]=s<0?0:t-1),(n<0||n>e)&&(i[1]=n<0?0:e-1),this.dirtyImage=!0}},qn.cleanCopyDimensions=function(){let t=this.sourceNaturalWidth,e=this.sourceNaturalHeight;if(tt(t,e)){this.dirtyCopyDimensions=!1;let i=this.copyDimensions,s=this.currentCopyDimensions,n=i[0],r=i[1];n.substring?s[0]=parseFloat(n)/100*t:s[0]=n,r.substring?s[1]=parseFloat(r)/100*e:s[1]=r;let o=s[0],a=s[1];(o<=0||o>t)&&(s[0]=o<=0?1:t),(a<=0||a>e)&&(s[1]=a<=0?1:e),this.dirtyImage=!0}},qn.prepareStamp=function(){this.dirtyAsset&&this.cleanAsset(),this.asset&&("Sprite"===this.asset.type?this.checkSpriteFrame(this):this.asset.checkSource?this.asset.checkSource(this.sourceNaturalWidth,this.sourceNaturalHeight):this.dirtyAsset=!0),(this.dirtyDimensions||this.dirtyHandle||this.dirtyScale)&&(this.dirtyPaste=!0),(this.dirtyScale||this.dirtyDimensions||this.dirtyStart||this.dirtyOffset||this.dirtyHandle)&&(this.dirtyPathObject=!0),this.dirtyScale&&this.cleanScale(),this.dirtyDimensions&&this.cleanDimensions(),this.dirtyLock&&this.cleanLock(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyHandle&&this.cleanHandle(),this.dirtyRotation&&this.cleanRotation(),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtyStampHandlePositions&&this.cleanStampHandlePositions(),this.dirtyCopyStart&&this.cleanCopyStart(),this.dirtyCopyDimensions&&this.cleanCopyDimensions(),this.dirtyImage&&this.cleanImage(),this.dirtyPaste&&this.preparePasteObject(),this.dirtyPathObject&&this.cleanPathObject(),this.dirtyPositionSubscribers&&this.updatePositionSubscribers(),this.dirtyImageSubscribers&&this.updateImageSubscribers()},qn.preparePasteObject=function(){this.dirtyPaste=!1;let t=this.currentStampHandlePosition,e=this.currentDimensions,i=this.currentScale,s=-t[0]*i,n=-t[1]*i,r=e[0]*i,o=e[1]*i,a=this.pasteArray;a.length=0,a.push(s,n,r,o),this.dirtyPathObject=!0},qn.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){this.pasteArray||this.preparePasteObject(),(this.pathObject=new Path2D).rect(...this.pasteArray)}},qn.draw=function(t){t.stroke(this.pathObject)},qn.fill=function(t){let[e,i,s,n]=this.copyArray;this.source&&s&&n&&t.drawImage(this.source,...this.copyArray,...this.pasteArray)},qn.drawAndFill=function(t){t.stroke(this.pathObject);let[e,i,s,n]=this.copyArray;this.source&&s&&n&&(this.currentHost.clearShadow(),t.drawImage(this.source,...this.copyArray,...this.pasteArray))},qn.fillAndDraw=function(t){t.stroke(this.pathObject);let[e,i,s,n]=this.copyArray;this.source&&s&&n&&(this.currentHost.clearShadow(),t.drawImage(this.source,...this.copyArray,...this.pasteArray)),t.stroke(this.pathObject)},qn.drawThenFill=function(t){t.stroke(this.pathObject);let[e,i,s,n]=this.copyArray;this.source&&s&&n&&t.drawImage(this.source,...this.copyArray,...this.pasteArray)},qn.fillThenDraw=function(t){let[e,i,s,n]=this.copyArray;this.source&&s&&n&&t.drawImage(this.source,...this.copyArray,...this.pasteArray),t.stroke(this.pathObject)},qn.checkHitReturn=function(t,e,i){if(this.checkHitIgnoreTransparency&&i&&i.engine){let[s,n,r,o]=this.copyArray,[a,l,h,c]=this.pasteArray,[u,d]=this.currentStampPosition,f=4*((e-d)*h+(t-u))+3;return!!i.engine.getImageData(s,n,r,o).data[f]&&{x:t,y:e,artefact:this}}return{x:t,y:e,artefact:this}};O.Picture=Picture;const Polygon=function(t={}){return this.shapeInit(t),this};let Kn=Polygon.prototype=Object.create(Object.prototype);Kn.type="Polygon",Kn.lib="entity",Kn.isArtefact=!0,Kn.isAsset=!1,Kn=ee(Kn),Kn=Os(Kn);Kn.defs=_(Kn.defs,{sides:0,radius:0});let Jn=Kn.setters,tr=Kn.deltaSetters;Jn.sides=function(t){this.sides=t,this.updateDirty()},tr.sides=function(t){this.sides+=t,this.updateDirty()},Jn.radius=function(t){this.radius=t,this.updateDirty()},tr.radius=function(t){this.radius+=t,this.updateDirty()},Kn.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makePolygonPath(),this.pathDefinition=t},Kn.makePolygonPath=function(){let t,e,i,s=this.radius,n=this.sides,r=360/n,o="",a=[],l=0,h=fi({x:0,y:-s});for(let t=0;t<n;t++)h.rotate(r),l+=h.y,a.push(l),o+=`${h.x.toFixed(1)},${h.y.toFixed(1)} `;return pi(h),e=Math.min(...a),t=Math.max(...a),i=((Math.abs(e)+Math.abs(t)-s)/2).toFixed(1),o=`m0,${i}l${o}z`,o};O.Polygon=Polygon;const Polyline=function(t={}){return this.pins=[],this.currentPins=[],this.controlledLineOffset=He(),this.shapeInit(t),this};let er=Polyline.prototype=Object.create(Object.prototype);er.type="Polyline",er.lib="entity",er.isArtefact=!0,er.isAsset=!1,er=ee(er),er=Os(er);er.defs=_(er.defs,{pins:null,tension:0,closed:!1,mapToPins:!1,useParticlesAsPins:!1}),er.packetExclusions=Q(er.packetExclusions,["controlledLineOffset"]),er.packetExclusionsByRegex=Q(er.packetExclusionsByRegex,[]),er.packetCoordinates=Q(er.packetCoordinates,[]),er.packetObjects=Q(er.packetObjects,[]),er.packetFunctions=Q(er.packetFunctions,[]),er.finalizePacketOut=function(t,e){let i=JSON.parse(this.state.saveAsPacket(e))[3];return t=_(t,i),t=this.handlePacketAnchor(t,e),Object.keys(t).forEach(e=>{if("pins"===e){let e=[];t.pins.forEach(t=>{U(t)?e.push(t.name):Array.isArray(t)?e.push([].concat(t)):e.push(t)}),t.pins=e}}),t};let ir=er.getters,sr=er.setters,nr=er.deltaSetters;ir.pins=function(t){return J(t)?this.getPinAt(t):this.currentPins.concat()},sr.pins=function(t){if(J(t)){let e=this.pins;if(Array.isArray(t))e.forEach((t,e)=>this.removePinAt(e)),e.length=0,e.push(...t),this.updateDirty();else if(U(t)&&J(t.index)){let i=e[t.index];Array.isArray(i)&&(J(t.x)&&(i[0]=t.x),J(t.y)&&(i[1]=t.y),this.updateDirty())}}},nr.pins=function(t){if(J(t)){let e=this.pins;if(U(t)&&J(t.index)){let i=e[t.index];Array.isArray(i)&&(J(t.x)&&(i[0]=addStrings(i[0],t.x)),J(t.y)&&(i[1]=addStrings(i[1],t.y)),this.updateDirty())}}},sr.tension=function(t){t.toFixed&&(this.tension=t,this.updateDirty())},nr.tension=function(t){t.toFixed&&(this.tension+=t,this.updateDirty())},sr.closed=function(t){this.closed=t,this.updateDirty()},sr.mapToPins=function(t){this.mapToPins=t,this.updateDirty()},sr.flipUpend=function(t){this.flipUpend=t,this.updateDirty()},sr.flipReverse=function(t){this.flipReverse=t,this.updateDirty()},sr.useAsPath=function(t){this.useAsPath=t,this.updateDirty()},sr.pivot=function(t){if(Y(t)&&!t)this.pivot=null,"pivot"===this.lockTo[0]&&(this.lockTo[0]="start"),"pivot"===this.lockTo[1]&&(this.lockTo[1]="start"),this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0;else{let e=this.pivot,s=t.substring?i[t]:t,n=this.name;s&&s.name&&(e&&e.name!==s.name&&K(e.pivoted,n),Q(s.pivoted,n),this.pivot=s,this.dirtyStampPositions=!0,this.dirtyStampHandlePositions=!0)}this.updateDirty()},er.updateDirty=function(){this.dirtySpecies=!0,this.dirtyPathObject=!0,this.dirtyPins=!0},er.getPinAt=function(t){let e=Math.floor(t);if(this.useAsPath){let t=this.getPathPositionData(this.unitPartials[e]);return[t.x,t.y]}{let t,i,s=this.currentPins,n=s[e],[r,o,a,l]=this.localBox,[h,c]=n,[u,d]=s[0],[f,p]=this.localOffset,[m,g]=this.currentStampPosition;return this.mapToPins?(t=h-u+r,i=c-u+o):(t=h-f,i=c-p),[m+t,g+i]}},er.updatePinAt=function(t,e){if(tt(t,e)){e=Math.floor(e);let i=this.pins;if(e<i.length&&e>=0){let s=i[e];U(s)&&s.pivoted&&K(s.pivoted,this.name),i[e]=t,this.updateDirty()}}},er.removePinAt=function(t){t=Math.floor(t);let e=this.pins;if(t<e.length&&t>=0){let i=e[t];U(i)&&i.pivoted&&K(i.pivoted,this.name),e[t]=null,this.updateDirty()}},er.prepareStamp=function(){this.dirtyHost&&(this.dirtyHost=!1),this.useParticlesAsPins&&(this.dirtyPins=!0),(this.dirtyPins||this.dirtyLock)&&(this.dirtySpecies=!0),(this.dirtyScale||this.dirtySpecies||this.dirtyDimensions||this.dirtyStart||this.dirtyHandle)&&(this.dirtyPathObject=!0,(this.dirtyScale||this.dirtySpecies)&&(this.pathCalculatedOnce=!1)),(this.isBeingDragged||this.lockTo.indexOf("mouse")>=0||this.lockTo.indexOf("particle")>=0)&&(this.dirtyStampPositions=!0),this.dirtyScale&&this.cleanScale(),this.dirtyStart&&this.cleanStart(),this.dirtyOffset&&this.cleanOffset(),this.dirtyRotation&&this.cleanRotation(),this.dirtyStampPositions&&this.cleanStampPositions(),this.dirtySpecies&&this.cleanSpecies(),this.dirtyPathObject&&(this.cleanPathObject(),this.updatePathSubscribers()),this.dirtyPositionSubscribers&&this.updatePositionSubscribers()},er.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makePolylinePath(),this.pathDefinition=t},er.getPathParts=function(t,e,i,s,n,r,o){let a=Math.sqrt,l=Math.pow,h=a(l(i-t,2)+l(s-e,2)),c=a(l(n-i,2)+l(r-s,2)),u=o*h/(h+c),d=o*c/(h+c);return[i-u*(n-t),s-u*(r-e),i,s,i+d*(n-t),s+d*(r-e)]},er.buildLine=function(t,e,i){let s="m0,0l";for(let n=2;n<i.length;n+=6)s+=`${I(i[n]-t)},${I(i[n+1]-e)} `,t=i[n],e=i[n+1];return s},er.buildCurve=function(t,e,i){let s="m0,0c",n=0;for(let r=0;r<i.length;r+=2)s+=`${I(i[r]-t)},${I(i[r+1]-e)} `,n++,n>2&&(t=i[r],e=i[r+1],n=0);return s},er.cleanCoordinate=function(t,e){return t.toFixed?t:"left"===t||"top"===t?0:"right"===t||"bottom"===t?e:"center"===t?e/2:parseFloat(t)/100*e},er.cleanPinsArray=function(){this.dirtyPins=!1;let t=this.pins,e=this.currentPins;if(e.length=0,this.useParticlesAsPins)t.forEach((i,s)=>{let n;i&&i.substring?(n=d[i],n&&(t[s]=n)):n=i;let r=!(!n||!n.position)&&n.position;r&&e.push([r.x,r.y])}),e.length||(this.dirtyPins=!0);else{let s,n,r,o=1,a=1,l=this.getHost(),h=this.cleanCoordinate;l&&(r=l.currentDimensions,r&&([o,a]=r)),t.forEach((r,l)=>{let c;if(r&&r.substring?(c=i[r],t[l]=c):c=r,c)if(Array.isArray(c))[s,n]=c,e.push([h(s,o),h(n,a)]);else if(U(c)&&c.currentStart){let t=this.name;c.pivoted.indexOf(t)<0&&Q(c.pivoted,t),e.push([...c.currentStampPosition])}})}if(e.length){let t=e[0][0],i=e[0][1];e.forEach(e=>{e[0]<t&&(t=e[0]),e[1]<i&&(i=e[1])}),this.localOffset=[t,i],this.updatePivotSubscribers()}},er.makePolylinePath=function(){let t=this.getPathParts,e=this.buildLine,i=this.buildCurve,s=(this.pins,this.currentPins),n=this.tension,r=this.closed;if(this.dirtyPins&&this.cleanPinsArray(),s.length){let o=s.length,a=s[0],l=s[o-1],h=[],c="m0,0";if(r){let r=[].concat(...t(...l,...a,...s[1],n));for(let e=0;e<o-2;e++)h=h.concat(...t(...s[e],...s[e+1],...s[e+2],n));h=h.concat(...t(...s[o-2],...l,...a,n)),h.unshift(r[4],r[5]),h.push(r[0],r[1],r[2],r[3]),c=n?i(a[0],a[1],h)+"z":e(a[0],a[1],h)+"z"}else{h.push(a[0],a[1]);for(let e=0;e<o-2;e++)h=h.concat(...t(...s[e],...s[e+1],...s[e+2],n));h.push(l[0],l[1],l[0],l[1]),c=n?i(a[0],a[1],h):e(a[0],a[1],h)}return c}return"m0,0"},er.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox,n=this.pathDefinition;this.mapToPins?this.set({start:this.currentPins[0]}):this.pathDefinition=n.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)},er.updatePathSubscribers=function(){this.pathed.forEach(t=>{let e=i[t];e&&(e.dirtyStart=!0)})};O.Polyline=Polyline;const Quadratic=function(t={}){return this.control=He(),this.currentControl=He(),this.controlLockTo="coord",this.curveInit(t),this.shapeInit(t),this.dirtyControl=!0,this};let rr=Quadratic.prototype=Object.create(Object.prototype);rr.type="Quadratic",rr.lib="entity",rr.isArtefact=!0,rr.isAsset=!1,rr=ee(rr),rr=Os(rr),rr=vs(rr);rr.defs=_(rr.defs,{control:null,controlPivot:"",controlPivotCorner:"",addControlPivotHandle:!1,addControlPivotOffset:!1,controlPath:"",controlPathPosition:0,addControlPathHandle:!1,addControlPathOffset:!0,controlParticle:"",controlLockTo:""}),rr.packetExclusions=Q(rr.packetExclusions,[]),rr.packetExclusionsByRegex=Q(rr.packetExclusionsByRegex,[]),rr.packetCoordinates=Q(rr.packetCoordinates,["control"]),rr.packetObjects=Q(rr.packetObjects,["controlPivot","controlPath"]),rr.packetFunctions=Q(rr.packetFunctions,[]);rr.getters;let or=rr.setters,ar=rr.deltaSetters;or.controlPivot=function(t){this.setControlHelper(t,"controlPivot","control"),this.updateDirty(),this.dirtyControl=!0},or.controlParticle=function(t){this.setControlHelper(t,"controlParticle","control"),this.updateDirty(),this.dirtyControl=!0},or.controlPath=function(t){this.setControlHelper(t,"controlPath","control"),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},or.controlPathPosition=function(t){this.controlPathPosition=t,this.dirtyControl=!0,this.currentControlPathData=!1},ar.controlPathPosition=function(t){this.controlPathPosition+=t,this.dirtyControl=!0,this.currentControlPathData=!1},or.controlX=function(t){null!=t&&(this.control[0]=t,this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1)},or.controlY=function(t){null!=t&&(this.control[1]=t,this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1)},or.control=function(t,e){this.setCoordinateHelper("control",t,e),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},ar.controlX=function(t){let e=this.control;e[0]=H(e[0],t),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},ar.controlY=function(t){let e=this.control;e[1]=H(e[1],t),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},ar.control=function(t,e){this.setDeltaCoordinateHelper("control",t,e),this.updateDirty(),this.dirtyControl=!0,this.currentControlPathData=!1},or.controlLockTo=function(t){this.controlLockTo=t,this.updateDirty(),this.dirtyControlLock=!0,this.currentControlPathData=!1},rr.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeQuadraticPath(),this.pathDefinition=t},rr.makeQuadraticPath=function(){let[t,e]=this.currentStampPosition,[i,s]=this.currentControl,[n,r]=this.currentEnd;return`m0,0q${(i-t).toFixed(2)},${(s-e).toFixed(2)} ${(n-t).toFixed(2)},${(r-e).toFixed(2)}`},rr.cleanDimensions=function(){this.dirtyDimensions=!1,this.dirtyHandle=!0,this.dirtyOffset=!0,this.dirtyStart=!0,this.dirtyControl=!0,this.dirtyEnd=!0},rr.preparePinsForStamp=function(){let t=this.endPivot,e=this.endPath,i=this.controlPivot,s=this.controlPath;this.dirtyPins.forEach(n=>{(i&&i.name===n||s&&s.name===n)&&(this.dirtyControl=!0,this.controlLockTo.includes("path")&&(this.currentControlPathData=!1)),(t&&t.name===n||e&&e.name===n)&&(this.dirtyEnd=!0,this.endLockTo.includes("path")&&(this.currentEndPathData=!1))}),this.dirtyPins.length=0};O.Quadratic=Quadratic;const RadialGradient=function(t={}){return this.stylesInit(t),this};let lr=RadialGradient.prototype=Object.create(Object.prototype);lr.type="RadialGradient",lr.lib="styles",lr.isArtefact=!1,lr.isAsset=!1,lr=ee(lr),lr=Ks(lr);lr.defs=_(lr.defs,{startRadius:0,endRadius:0}),lr.packetObjects=Q(lr.packetObjects,["palette"]);let hr=lr.getters,cr=lr.setters,ur=lr.deltaSetters;hr.startRadius=function(t){return this.currentStartRadius},hr.endRadius=function(t){return this.currentEndRadius},cr.startRadius=function(t){this.startRadius=t,this.dirtyStyle=!0},cr.endRadius=function(t){this.endRadius=t,this.dirtyStyle=!0},ur.startRadius=function(t){this.startRadius=H(this.startRadius,t),this.dirtyStyle=!0},ur.endRadius=function(t){this.endRadius=H(this.endRadius,t),this.dirtyStyle=!0},lr.cleanRadius=function(t){const e=(t,e)=>{if(V(t))return t;switch(t){case"top":case"left":return 0;case"bottom":case"right":return e;case"center":return e/2;default:return t=parseFloat(t),V(t)?t/100*e:0}};this.currentStartRadius=t?e(this.startRadius,t):this.defs.startRadius,this.currentEndRadius=t?e(this.endRadius,t):this.defs.endRadius},lr.buildStyle=function(t={}){if(t){let e=t.engine;if(e){let t=e.createRadialGradient(...this.gradientArgs);return this.addStopsToGradient(t,this.paletteStart,this.paletteEnd,this.cyclePalette)}}return"rgba(0,0,0,0)"},lr.updateGradientArgs=function(t,e){let i=this.gradientArgs,s=this.currentStart,n=this.currentEnd,r=this.currentStartRadius,o=this.currentEndRadius,a=s[0]+t,l=s[1]+e,h=n[0]+t,c=n[1]+e;a===h&&l===c&&r===o&&o++,i.length=0,i.push(a,l,r,h,c,o)};O.RadialGradient=RadialGradient;const Rectangle=function(t={}){return this.shapeInit(t),this.currentRectangleWidth=1,this.currentRectangleHeight=1,this};let dr=Rectangle.prototype=Object.create(Object.prototype);dr.type="Rectangle",dr.lib="entity",dr.isArtefact=!0,dr.isAsset=!1,dr=ee(dr),dr=Os(dr);dr.defs=_(dr.defs,{rectangleWidth:10,rectangleHeight:10,radiusTLX:0,radiusTLY:0,radiusTRX:0,radiusTRY:0,radiusBRX:0,radiusBRY:0,radiusBLX:0,radiusBLY:0,offshootA:.55,offshootB:0});let fr=dr.setters,pr=dr.deltaSetters;fr.radius=function(t){this.setRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX","radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},fr.radiusX=function(t){this.setRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX"])},fr.radiusY=function(t){this.setRectHelper(t,["radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},fr.radiusT=function(t){this.setRectHelper(t,["radiusTLX","radiusTLY","radiusTRX","radiusTRY"])},fr.radiusB=function(t){this.setRectHelper(t,["radiusBRX","radiusBRY","radiusBLX","radiusBLY"])},fr.radiusL=function(t){this.setRectHelper(t,["radiusTLX","radiusTLY","radiusBLX","radiusBLY"])},fr.radiusR=function(t){this.setRectHelper(t,["radiusTRX","radiusTRY","radiusBRX","radiusBRY"])},fr.radiusTX=function(t){this.setRectHelper(t,["radiusTLX","radiusTRX"])},fr.radiusBX=function(t){this.setRectHelper(t,["radiusBRX","radiusBLX"])},fr.radiusLX=function(t){this.setRectHelper(t,["radiusTLX","radiusBLX"])},fr.radiusRX=function(t){this.setRectHelper(t,["radiusTRX","radiusBRX"])},fr.radiusTY=function(t){this.setRectHelper(t,["radiusTLY","radiusTRY"])},fr.radiusBY=function(t){this.setRectHelper(t,["radiusBRY","radiusBLY"])},fr.radiusLY=function(t){this.setRectHelper(t,["radiusTLY","radiusBLY"])},fr.radiusRY=function(t){this.setRectHelper(t,["radiusTRY","radiusBRY"])},fr.radiusTL=function(t){this.setRectHelper(t,["radiusTLX","radiusTLY"])},fr.radiusTR=function(t){this.setRectHelper(t,["radiusTRX","radiusTRY"])},fr.radiusBL=function(t){this.setRectHelper(t,["radiusBLX","radiusBLY"])},fr.radiusBR=function(t){this.setRectHelper(t,["radiusBRX","radiusBRY"])},fr.radiusTLX=function(t){this.setRectHelper(t,["radiusTLX"])},fr.radiusTLY=function(t){this.setRectHelper(t,["radiusTLY"])},fr.radiusTRX=function(t){this.setRectHelper(t,["radiusTRX"])},fr.radiusTRY=function(t){this.setRectHelper(t,["radiusTRY"])},fr.radiusBRX=function(t){this.setRectHelper(t,["radiusBRX"])},fr.radiusBRY=function(t){this.setRectHelper(t,["radiusBRY"])},fr.radiusBLX=function(t){this.setRectHelper(t,["radiusBLX"])},fr.radiusBLY=function(t){this.setRectHelper(t,["radiusBLY"])},pr.radius=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX","radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},pr.radiusX=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTRX","radiusBRX","radiusBLX","radiusX"])},pr.radiusY=function(t){this.deltaRectHelper(t,["radiusTLY","radiusTRY","radiusBRY","radiusBLY","radiusY"])},pr.radiusT=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTLY","radiusTRX","radiusTRY"])},pr.radiusB=function(t){this.deltaRectHelper(t,["radiusBRX","radiusBRY","radiusBLX","radiusBLY"])},pr.radiusL=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTLY","radiusBLX","radiusBLY"])},pr.radiusR=function(t){this.deltaRectHelper(t,["radiusTRX","radiusTRY","radiusBRX","radiusBRY"])},pr.radiusTX=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTRX"])},pr.radiusBX=function(t){this.deltaRectHelper(t,["radiusBRX","radiusBLX"])},pr.radiusLX=function(t){this.deltaRectHelper(t,["radiusTLX","radiusBLX"])},pr.radiusRX=function(t){this.deltaRectHelper(t,["radiusTRX","radiusBRX"])},pr.radiusTY=function(t){this.deltaRectHelper(t,["radiusTLY","radiusTRY"])},pr.radiusBY=function(t){this.deltaRectHelper(t,["radiusBRY","radiusBLY"])},pr.radiusLY=function(t){this.deltaRectHelper(t,["radiusTLY","radiusBLY"])},pr.radiusRY=function(t){this.deltaRectHelper(t,["radiusTRY","radiusBRY"])},pr.radiusTL=function(t){this.deltaRectHelper(t,["radiusTLX","radiusTLY"])},pr.radiusTR=function(t){this.deltaRectHelper(t,["radiusTRX","radiusTRY"])},pr.radiusBL=function(t){this.deltaRectHelper(t,["radiusBLX","radiusBLY"])},pr.radiusBR=function(t){this.deltaRectHelper(t,["radiusBRX","radiusBRY"])},pr.radiusTLX=function(t){this.deltaRectHelper(t,["radiusTLX"])},pr.radiusTLY=function(t){this.deltaRectHelper(t,["radiusTLY"])},pr.radiusTRX=function(t){this.deltaRectHelper(t,["radiusTRX"])},pr.radiusTRY=function(t){this.deltaRectHelper(t,["radiusTRY"])},pr.radiusBRX=function(t){this.deltaRectHelper(t,["radiusBRX"])},pr.radiusBRY=function(t){this.deltaRectHelper(t,["radiusBRY"])},pr.radiusBLX=function(t){this.deltaRectHelper(t,["radiusBLX"])},pr.radiusBLY=function(t){this.deltaRectHelper(t,["radiusBLY"])},fr.offshootA=function(t){this.offshootA=t,this.updateDirty()},fr.offshootB=function(t){this.offshootB=t,this.updateDirty()},pr.offshootA=function(t){t.toFixed&&(this.offshootA+=t,this.updateDirty())},pr.offshootB=function(t){t.toFixed&&(this.offshootB+=t,this.updateDirty())},fr.rectangleWidth=function(t){null!=t&&(this.rectangleWidth=t,this.dirtyDimensions=!0)},fr.rectangleHeight=function(t){null!=t&&(this.rectangleHeight=t,this.dirtyDimensions=!0)},pr.rectangleWidth=function(t){this.rectangleWidth=H(this.rectangleWidth,t),this.dirtyDimensions=!0},pr.rectangleHeight=function(t){this.rectangleHeight=H(this.rectangleHeight,t),this.dirtyDimensions=!0},dr.setRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=t},this)},dr.deltaRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=H(this[e],t)},this)},dr.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeRectanglePath(),this.pathDefinition=t},dr.cleanDimensions=function(){let t=this.getHost();if(t){let e=t.currentDimensions?t.currentDimensions:[t.w,t.h],i=this.rectangleWidth,s=this.rectangleHeight,n=this.currentRectangleWidth||1,r=this.currentRectangleHeight||1;i.substring&&(i=parseFloat(i)/100*e[0]),s.substring&&(s=parseFloat(s)/100*e[1]);let o,a=this.mimic;a&&a.name&&this.useMimicDimensions&&(o=a.currentDimensions),o?(this.currentRectangleWidth=this.addOwnDimensionsToMimic?o[0]+i:o[0],this.currentRectangleHeight=this.addOwnDimensionsToMimic?o[1]+s:o[1]):(this.currentRectangleWidth=i,this.currentRectangleHeight=s),this.currentDimensions[0]=this.currentRectangleWidth,this.currentDimensions[1]=this.currentRectangleHeight,this.dirtyStart=!0,this.dirtyHandle=!0,this.dirtyOffset=!0,n===this.currentRectangleWidth&&r===this.currentRectangleHeight||(this.dirtyPositionSubscribers=!0),this.mimicked&&this.mimicked.length&&(this.dirtyMimicDimensions=!0)}else this.dirtyDimensions=!0},dr.makeRectanglePath=function(){this.dirtyDimensions&&this.cleanDimensions();let t=this.currentRectangleWidth,e=this.currentRectangleHeight,i=this.offshootA,s=this.offshootB,n=this.radiusTLX,r=this.radiusTLY,o=this.radiusTRX,a=this.radiusTRY,l=this.radiusBRX,h=this.radiusBRY,c=this.radiusBLX,u=this.radiusBLY;(n.substring||r.substring||o.substring||a.substring||l.substring||h.substring||c.substring||u.substring)&&(n=n.substring?parseFloat(n)/100*t:n,r=r.substring?parseFloat(r)/100*e:r,o=o.substring?parseFloat(o)/100*t:o,a=a.substring?parseFloat(a)/100*e:a,l=l.substring?parseFloat(l)/100*t:l,h=h.substring?parseFloat(h)/100*e:h,c=c.substring?parseFloat(c)/100*t:c,u=u.substring?parseFloat(u)/100*e:u);let d="m0,0";return t-n-o!=0&&(d+="h"+(t-n-o)),o+a!==0&&(d+=`c${o*i},${a*s} ${o-o*s},${a-a*i}, ${o},${a}`),e-a-h!=0&&(d+="v"+(e-a-h)),l+h!==0&&(d+=`c${-l*s},${h*i} ${l*i-l},${h-h*s} ${-l},${h}`),-t+c+l!==0&&(d+="h"+(-t+c+l)),c+u!==0&&(d+=`c${-c*i},${-u*s} ${c*s-c},${u*i-u} ${-c},${-u}`),-e+r+u!==0&&(d+="v"+(-e+r+u)),n+r!==0&&(d+=`c${n*s},${-r*i} ${n-n*i},${r*s-r} ${n},${-r}`),d+="z",d},dr.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};O.Rectangle=Rectangle;const Shape=function(t={}){return this.shapeInit(t),this};let mr=Shape.prototype=Object.create(Object.prototype);mr.type="Shape",mr.lib="entity",mr.isArtefact=!0,mr.isAsset=!1,mr=ee(mr),mr=Os(mr);mr.defs=_(mr.defs,{}),mr.cleanSpecies=function(){this.dirtySpecies=!1},mr.cleanStampHandlePositionsAdditionalActions=function(){let t=this.localBox,e=this.currentStampHandlePosition;e[0]+=t[0],e[1]+=t[1]};O.Shape=Shape;const Spiral=function(t={}){return this.shapeInit(t),this};let gr=Spiral.prototype=Object.create(Object.prototype);gr.type="Spiral",gr.lib="entity",gr.isArtefact=!0,gr.isAsset=!1,gr=ee(gr),gr=Os(gr);gr.defs=_(gr.defs,{loops:1,loopIncrement:1,drawFromLoop:0});let yr=gr.setters,br=gr.deltaSetters;yr.loops=function(t){this.loops=t,this.updateDirty()},br.loops=function(t){this.loops+=t,this.updateDirty()},yr.loopIncrement=function(t){this.loopIncrement=t,this.updateDirty()},br.loopIncrement=function(t){this.loopIncrement+=t,this.updateDirty()},yr.drawFromLoop=function(t){this.drawFromLoop=Math.floor(t),this.updateDirty()},br.drawFromLoop=function(t){this.drawFromLoop=Math.floor(this.drawFromLoop+t),this.updateDirty()},gr.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeSpiralPath(),this.pathDefinition=t},gr.firstTurn=[[.043,0,.082,-.035,.088,-.088],[.007,-.057,-.024,-.121,-.088,-.162],[-.07,-.045,-.169,-.054,-.265,-.015],[-.106,.043,-.194,.138,-.235,.265],[-.044,.139,-.026,.3,.058,.442],[.091,.153,.25,.267,.442,.308],[.206,.044,.431,-.001,.619,-.131],[.2,-.139,.34,-.361,.381,-.619]],gr.subsequentTurns=[[0,-.27,-.11,-.52,-.29,-.71],[-.19,-.19,-.44,-.29,-.71,-.29],[-.27,0,-.52,.11,-.71,.29],[-.19,.19,-.29,.44,-.29,.71],[0,.27,.11,.52,.29,.71],[.19,.19,.44,.29,.71,.29],[.27,0,.52,-.11,.71,-.29],[.19,-.19,.29,-.44,.29,-.71]],gr.makeSpiralPath=function(){let t,e,i,s,n,r,o,a,l,h,c,u,d=Math.floor(this.loops),f=this.loopIncrement,p=Math.floor(this.drawFromLoop),m=this.firstTurn,g=this.subsequentTurns,y=[];for(let o=0;o<m.length;o++)[t,e,i,s,n,r]=m[o],y.push([t*f,e*f,i*f,s*f,n*f,r*f]);let b="m0,0";for(let m=0;m<d;m++)for(let d=0;d<y.length;d++)[t,e,i,s,n,r]=y[d],m>=p&&(b+=`c${t},${e} ${i},${s} ${n},${r}`),[o,a,l,h,c,u]=g[d],y[d]=[t+o*f,e+a*f,i+l*f,s+h*f,n+c*f,r+u*f];return b},gr.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox,n=this.scale;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t/n},${-e/n}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};O.Spiral=Spiral;const Star=function(t={}){return this.shapeInit(t),this};let kr=Star.prototype=Object.create(Object.prototype);kr.type="Star",kr.lib="entity",kr.isArtefact=!0,kr.isAsset=!1,kr=ee(kr),kr=Os(kr);kr.defs=_(kr.defs,{radius1:0,radius2:0,points:0,twist:0});let Sr=kr.setters,Or=kr.deltaSetters;Sr.radius1=function(t){this.radius1=t,this.updateDirty()},Or.radius1=function(t){this.radius1+=t,this.updateDirty()},Sr.radius2=function(t){this.radius2=t,this.updateDirty()},Or.radius2=function(t){this.radius2+=t,this.updateDirty()},Sr.points=function(t){this.points=t,this.updateDirty()},Or.points=function(t){this.points+=t,this.updateDirty()},Sr.twist=function(t){this.twist=t,this.updateDirty()},Or.twist=function(t){this.twist+=t,this.updateDirty()},kr.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeStarPath(),this.pathDefinition=t},kr.makeStarPath=function(){let t,e,i,s,n,r,o,a=this.points,l=this.twist,h=this.radius1,c=this.radius2,u=360/a,d=[],f="";if(h.substring||c.substring){let t=this.getHost();if(t){let[e,i]=t.currentDimensions;h=h.substring?parseFloat(h)/100*e:h,c=c.substring?parseFloat(c)/100*e:c}}let p=fi({x:0,y:-h}),m=fi({x:0,y:-c});for(t=p.x,e=p.y,d.push(t),m.rotate(-u/2),m.rotate(l),o=0;o<a;o++)m.rotate(u),i=parseFloat((m.x-t).toFixed(1)),t+=i,d.push(t),s=parseFloat((m.y-e).toFixed(1)),e+=s,f+=`${i},${s} `,p.rotate(u),i=parseFloat((p.x-t).toFixed(1)),t+=i,d.push(t),s=parseFloat((p.y-e).toFixed(1)),e+=s,f+=`${i},${s} `;return pi(p),pi(m),n=Math.min(...d),r=Math.abs(n).toFixed(1),f=`m${r},0l${f}z`,f};O.Star=Star;const Tetragon=function(t={}){return this.shapeInit(t),this};let Pr=Tetragon.prototype=Object.create(Object.prototype);Pr.type="Tetragon",Pr.lib="entity",Pr.isArtefact=!0,Pr.isAsset=!1,Pr=ee(Pr),Pr=Os(Pr);Pr.defs=_(Pr.defs,{radiusX:5,radiusY:5,intersectX:.5,intersectY:.5});let vr=Pr.setters,wr=Pr.deltaSetters;vr.radius=function(t){this.setRectHelper(t,["radiusX","radiusY"])},vr.radiusX=function(t){this.setRectHelper(t,["radiusX"])},vr.radiusY=function(t){this.setRectHelper(t,["radiusY"])},wr.radius=function(t){this.deltaRectHelper(t,["radiusX","radiusY"])},wr.radiusX=function(t){this.deltaRectHelper(t,["radiusX"])},wr.radiusY=function(t){this.deltaRectHelper(t,["radiusY"])},vr.intersectA=function(t){this.intersectA=t,this.updateDirty()},vr.intersectB=function(t){this.intersectB=t,this.updateDirty()},wr.intersectA=function(t){t.toFixed&&(this.intersectA+=t,this.updateDirty())},wr.intersectB=function(t){t.toFixed&&(this.intersectB+=t,this.updateDirty())},Pr.setRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=t},this)},Pr.deltaRectHelper=function(t,e){this.updateDirty(),e.forEach(e=>{this[e]=addStrings(this[e],t)},this)},Pr.cleanSpecies=function(){this.dirtySpecies=!1;let t="M0,0";t=this.makeTetragonPath(),this.pathDefinition=t},Pr.makeTetragonPath=function(){let t,e,i=this.radiusX,s=this.radiusY;if(i.substring||s.substring){let n=this.getHost();if(n){let[r,o]=n.currentDimensions;t=2*(i.substring?parseFloat(i)/100*r:i),e=2*(s.substring?parseFloat(s)/100*o:s)}}else t=2*i,e=2*s;let n=parseFloat((t*this.intersectX).toFixed(2)),r=parseFloat((t-n).toFixed(2)),o=parseFloat((e*this.intersectY).toFixed(2)),a=parseFloat((e-o).toFixed(2)),l="m0,0";return l+=`l${r},${o} ${-r},${a} ${-n},${-a} ${n},${-o}z`,l},Pr.calculateLocalPathAdditionalActions=function(){let[t,e,i,s]=this.localBox;this.pathDefinition=this.pathDefinition.replace("m0,0",`m${-t},${-e}`),this.pathCalculatedOnce=!1,this.calculateLocalPath(this.pathDefinition,!0)};O.Tetragon=Tetragon;const Ticker=function(t={}){return this.makeName(t.name),this.register(),this.subscribers=[],this.subscriberObjects=[],this.set(this.defs),this.set(t),this.cycleCount=0,this.active=!1,this.effectiveDuration=0,this.startTime=0,this.currentTime=0,this.tick=0,this.lastEvent=0,t.subscribers&&this.subscribe(t.subscribers),this.setEffectiveDuration(),this};let xr=Ticker.prototype=Object.create(Object.prototype);xr.type="Ticker",xr.lib="animationtickers",xr.isArtefact=!1,xr.isAsset=!1,xr=ee(xr);xr.defs=_(xr.defs,{order:1,duration:0,subscribers:null,killOnComplete:!1,cycles:1,eventChoke:0,onRun:null,onHalt:null,onReverse:null,onResume:null,onSeekTo:null,onSeekFor:null,onComplete:null,onReset:null}),xr.packetExclusions=Q(xr.packetExclusions,["subscribers"]),xr.packetFunctions=Q(xr.packetFunctions,["onRun","onHalt","onReverse","onResume","onSeekTo","onSeekFor","onComplete","onReset"]),xr.kill=function(){return this.active&&this.halt(),K(Dr,this.name),Rr=!0,this.deregister(),!0},xr.killTweens=function(t=!1){let e,i,s;for(e=0,i=this.subscribers.length;e<i;e++)s=y[this.subscribers[e]],s.completeAction(),s.kill();return t?(this.kill(),!0):this};let Ar=xr.getters,Cr=xr.setters;Ar.subscribers=function(){return[].concat(this.subscribers)},Cr.subscribers=function(t){this.subscribers=[],this.subscribe(t)},Cr.order=function(t){this.order=t,this.active&&(Rr=!0)},Cr.cycles=function(t){this.cycles=t,this.cycles||(this.cycleCount=0)},Cr.duration=function(t){let e,i,s,n=this.subscribers;if(this.duration=t,this.setEffectiveDuration(),J(n))for(e=0,i=n.length;e<i;e++)s=y[n[e]],s&&(s.calculateEffectiveTime(),"Tween"===s.type&&s.calculateEffectiveDuration())},xr.subscribe=function(t){let e,i,s,n,r=[].concat(t);for(e=0,i=r.length;e<i;e++)s=r[e],null!=s&&(n=s.substring?s:!(!U(s)||!s.name)&&s.name,n&&Q(this.subscribers,n));return r.length&&(this.sortSubscribers(),this.recalculateEffectiveDuration()),this},xr.unsubscribe=function(t){var e,i,s,n,r=[].concat(t);for(e=0,i=r.length;e<i;e++)(n=(s=t[e]).substring?s:!(!U(s)||!s.name)&&s.name)&&K(this.subscribers,n);return r.length&&(this.sortSubscribers(),this.recalculateEffectiveDuration()),this},xr.repopulateSubscriberObjects=function(){let t,e=this.subscriberObjects,i=this.subscribers;e.length=0,i.forEach(i=>{t=y[i],t&&e.push(t)})},xr.getSubscriberObjects=function(){return this.subscribers.length&&!this.subscriberObjects.length&&this.repopulateSubscriberObjects(),this.subscriberObjects},xr.sortSubscribers=function(){let t=this.subscribers;if(t.length>1){let e=[].concat(t),i=Math.floor,s=[];e.forEach(t=>{let e=i(t.effectiveTime)||0;s[e]||(s[e]=[]),s[e].push(t)}),this.subscribers=s.reduce((t,e)=>t.concat(e),[])}this.repopulateSubscriberObjects()},xr.updateSubscribers=function(t,e){e=!!J(e)&&e;let i,s,n=this.getSubscriberObjects();if(e)for(i=n.length-1;i>=0;i--)n[i].set(t);else for(i=0,s=n.length;i<s;i++)n[i].set(t);return this},xr.changeSubscriberDirection=function(){return this.getSubscriberObjects().forEach(t=>t.reversed=!t.reversed),this},xr.makeTickerUpdateEvent=function(){return new CustomEvent("tickerupdate",{detail:{name:this.name,type:"Ticker",tick:this.tick,reverseTick:this.effectiveDuration-this.tick},bubbles:!0,cancelable:!0})},xr.recalculateEffectiveDuration=function(){let t,e=this.getSubscriberObjects(),i=0;return this.duration?this.setEffectiveDuration():(e.forEach(e=>{t=e.getEndTime(),t>i&&(i=t)}),this.effectiveDuration=i),this},xr.setEffectiveDuration=function(){let t;return this.duration&&(t=M(this.duration),"%"===t[0]?(this.duration=0,this.recalculateEffectiveDuration()):this.effectiveDuration=t[1]),this},xr.fn=function(t){let e=Fr();t=!!J(t)&&t;let i,s,n,r,o,a,l,h,c=this.active,u=this.startTime,d=this.cycles,f=this.cycleCount,p=this.effectiveDuration,m=this.eventChoke;if(c&&u&&(!d||f<d)){if(l=this.currentTime=Date.now(),h=this.tick=l-u,!d||f+1<d?(h>=p?(h=this.tick=0,this.startTime=this.currentTime,e.tick=p,e.reverseTick=0,e.willLoop=!0,d&&(f++,this.cycleCount=f)):(e.tick=h,e.reverseTick=p-h),e.next=!0):h>=p?(e.tick=p,e.reverseTick=0,c=this.active=!1,d&&(f++,this.cycleCount=f)):(e.tick=h,e.reverseTick=p-h,e.next=!0),n=this.getSubscriberObjects(),t)for(i=n.length-1;i>=0;i--)n[i].update(e);else for(i=0,s=n.length;i<s;i++)n[i].update(e);m&&(r=this.lastEvent+m,o=Date.now(),r<o&&(a=this.makeTickerUpdateEvent(),window.dispatchEvent(a),this.lastEvent=o)),c||this.halt(),this.killOnComplete&&f>=d&&this.killTweens(!0)}Tr(e)},xr.run=function(){return this.active||(this.startTime=this.currentTime=Date.now(),this.cycleCount=0,this.updateSubscribers({reversed:!1}),this.active=!0,Q(Dr,this.name),Rr=!0,"function"==typeof this.onRun&&this.onRun()),this},xr.isRunning=function(){return this.active},xr.reset=function(){return this.active&&this.halt(),this.startTime=this.currentTime=Date.now(),this.cycleCount=0,this.updateSubscribers({reversed:!1}),this.active=!0,this.fn(!0),this.active=!1,"function"==typeof this.onReset&&this.onReset(),this},xr.complete=function(){return this.active&&this.halt(),this.startTime=this.currentTime=Date.now(),this.cycleCount=0,this.updateSubscribers({reversed:!0}),this.active=!0,this.fn(),this.active=!1,"function"==typeof this.onComplete&&this.onComplete(),this},xr.reverse=function(t=!1){let e;return t=et(t,!1),this.active&&this.halt(),e=this.currentTime-this.startTime,this.startTime=this.currentTime-(this.effectiveDuration-e),this.changeSubscriberDirection(),this.active=!0,this.fn(),this.active=!1,"function"==typeof this.onReverse&&this.onReverse(),t&&this.resume(),this},xr.halt=function(){return this.active=!1,Q(Dr,this.name),Rr=!0,"function"==typeof this.onHalt&&this.onHalt(),this},xr.resume=function(){let t,e,i;return this.active||(t=Date.now(),e=this.currentTime,i=this.startTime,this.startTime=t-(e-i),this.currentTime=t,this.active=!0,Q(Dr,this.name),Rr=!0,"function"==typeof this.onResume&&this.onResume()),this},xr.seekTo=function(t,e=!1){let i=!1;return t=et(t,0),this.active&&this.halt(),this.cycles&&this.cycleCount>=this.cycles&&(this.cycleCount=this.cycles-1),t<this.tick&&(i=!0),this.currentTime=Date.now(),this.startTime=this.currentTime-t,this.active=!0,this.fn(i),this.active=!1,"function"==typeof this.onSeekTo&&this.onSeekTo(),e&&this.resume(),this},xr.seekFor=function(t,e=!1){let i=!1;return t=__xtGet(t,0),this.active&&this.halt(),this.cycles&&this.cycleCount>=this.cycles&&(this.cycleCount=this.cycles-1),this.startTime-=t,t<0&&(i=!0),this.active=!0,this.fn(i),this.active=!1,"function"==typeof this.onSeekFor&&this.onSeekFor(),e&&this.resume(),this};let Dr=[],Rr=!0;se({name:"coreTickersAnimation",order:0,fn:function(){return new Promise(t=>{if(Rr){Rr=!1;let t=[].concat(Dr),i=Math.floor,s=[];t.forEach(t=>{let n=e[t];if(J(n)){let t=i(n.order)||0;s[t]||(s[t]=[]),s[t].push(n.name)}}),Dr=s.reduce((t,e)=>t.concat(e),[])}Dr.forEach(t=>{let i=e[t];i&&i.fn&&i.fn()}),t(!0)})}});const Er=[],Fr=function(){return Er.length||Er.push({tick:0,reverseTick:0,willLoop:!1,next:!1}),Er.shift()},Tr=function(t){t&&(t.tick=0,t.reverseTick=0,t.willLoop=!1,t.next=!1,Er.push(t))},Hr=function(t){return new Ticker(t)};O.Ticker=Ticker;const Tracer=function(t={}){return this.makeName(t.name),this.register(),this.initializePositions(),this.set(this.defs),this.onEnter=B,this.onLeave=B,this.onDown=B,this.onUp=B,this.stampAction=B,this.trace=Ns(t),t.group||(t.group=Gi),this.set(t),this.purge&&this.purgeArtefact(this.purge),this};let Mr=Tracer.prototype=Object.create(Object.prototype);Mr.type="Tracer",Mr.lib="entity",Mr.isArtefact=!0,Mr.isAsset=!1,Mr=ee(Mr),Mr=ps(Mr);Mr.defs=_(Mr.defs,{artefact:null,historyLength:1,hitRadius:10,showHitRadius:!1,hitRadiusColor:"#000000"}),Mr.packetExclusions=Q(Mr.packetExclusions,[]),Mr.packetExclusionsByRegex=Q(Mr.packetExclusionsByRegex,[]),Mr.packetCoordinates=Q(Mr.packetCoordinates,[]),Mr.packetObjects=Q(Mr.packetObjects,["artefact","particle"]),Mr.packetFunctions=Q(Mr.packetFunctions,["stampAction"]),Mr.finalizePacketOut=function(t,e){return t},Mr.postCloneAction=function(t,e){return t.trace=Ns({name:t.name,historyLength:e.historyLength||this.historyLength||1}),t},Mr.factoryKill=function(t){t&&this.artefact.kill(),this.trace.kill()};Mr.getters;let Ir=Mr.setters;Mr.deltaSetters;Ir.stampAction=function(t){W(t)&&(this.stampAction=t)},Ir.artefact=function(t){let e;t.substring?e=i[t]:U(t)&&t.isArtefact&&(e=t),e&&(this.artefact=e)},Mr.regularStampSynchronousActions=function(){let{artefact:t,trace:e,stampAction:i,showHitRadius:s,hitRadius:n,hitRadiusColor:r,currentStampPosition:o}=this,a=this.currentHost;if(e.set({position:o}),e.manageHistory(0,a),i.call(this,t,e,a),s){let t=a.engine;t.save(),t.lineWidth=1,t.strokeStyle=r,t.setTransform(1,0,0,1,0,0),t.beginPath(),t.arc(o[0],o[1],n,0,2*Math.PI),t.stroke(),t.restore()}},Mr.checkHit=function(t=[],e){if(this.noUserInteraction)return!1;let i,s,n=Array.isArray(t)?t:[t],r=this.currentStampPosition,o=!1;if(n.some(t=>{if(Array.isArray(t))i=t[0],s=t[1];else{if(!tt(t,t.x,t.y))return!1;i=t.x,s=t.y}if(!i.toFixed||!s.toFixed||isNaN(i)||isNaN(s))return!1;let e=fi(r).vectorSubtract(t);return e.getMagnitude()<this.hitRadius&&(o=!0),pi(e),o},this)){return this.checkHitReturn(i,s,e)}return!1};O.Tracer=Tracer;const Tween=function(t={}){let i;return this.makeName(t.name),this.register(),this.set(this.defs),this.set(t),this.setDefinitionsValues(),this.status=-1,this.calculateEffectiveTime(),this.calculateEffectiveDuration(),e[t.ticker]?this.addToTicker(t.ticker):(i=this.name+"_ticker",Hr({name:i,order:this.order,subscribers:this.name,duration:this.effectiveDuration,eventChoke:et(t.eventChoke,0),cycles:et(t.cycles,1),killOnComplete:et(t.killOnComplete,!1)}),this.ticker=i,e[i].recalculateEffectiveDuration()),this};let Br=Tween.prototype=Object.create(Object.prototype);Br.type="Tween",Br.lib="tween",Br.isArtefact=!1,Br.isAsset=!1,Br=ee(Br),Br=us(Br);Br.defs=_(Br.defs,{definitions:null,duration:0,killOnComplete:!1,commenceAction:null,onRun:null,onHalt:null,onResume:null,onReverse:null,onSeekTo:null,onSeekFor:null,completeAction:null}),Br.packetExclusions=Q(Br.packetExclusions,["definitions","targets"]),Br.packetFunctions=Q(Br.packetFunctions,["commenceAction","completeAction","onRun","onHalt","onResume","onReverse","onSeekTo","onSeekFor","action"]),Br.finalizePacketOut=function(t,e){return Array.isArray(this.targets)&&(t.targets=this.targets.map(t=>t.name)),Array.isArray(this.definitions)&&(t.definitions=this.definitions.map(t=>{let e={};if(e.attribute=t.attribute,e.start=t.start,e.end=t.end,t.engine&&t.engine.substring)e.engine=t.engine.substring;else if(J(t.engine)&&null!==t.engine){let i=this.stringifyFunction(t.engine);i&&(e.engine=i,e.engineIsFunction=!0)}return e})),t},Br.postCloneAction=function(t,i){if(i.useNewTicker){let s=e[this.ticker];J(i.cycles)?t.cycles=i.cycles:t.cycles=s?s.cycles:1;let n=e[t.ticker];n.cycles=t.cycles,J(i.duration)&&(t.duration=i.duration,t.calculateEffectiveDuration(),n&&n.recalculateEffectiveDuration())}return Array.isArray(t.definitions)&&t.definitions.forEach((t,e)=>{t.engineIsFunction&&(t.engine=this.definitions[e].engine)}),t};let Lr=Br.getters,$r=Br.setters;Lr.definitions=function(){return[].concat(this.definitions)},$r.definitions=function(t){this.definitions=[].concat(t),this.setDefinitionsValues()},$r.commenceAction=function(t){this.commenceAction=t,"function"!=typeof this.commenceAction&&(this.commenceAction=B)},$r.completeAction=function(t){this.completeAction=t,"function"!=typeof this.completeAction&&(this.completeAction=B)},Br.set=function(t={}){if(Object.keys(t).length){let e,i,s,n,r=this.setters,o=Object.keys(t),a=this.defs,l=!!J(t.ticker)&&this.ticker;for(i=0,s=o.length;i<s;i++)e=o[i],"name"!==e&&(n=r[e],n?n.call(this,t[e]):void 0!==a[e]&&(this[e]=t[e]));l?(this.ticker=l,this.addToTicker(t.ticker)):it(t.time,t.duration)&&(this.calculateEffectiveTime(),this.calculateEffectiveDuration())}return this},Br.getEndTime=function(){return this.effectiveTime+this.effectiveDuration},Br.calculateEffectiveDuration=function(t){let i,s=et(t,this.duration),n=M(s),r=n[1],o=n[0],a=this.ticker,l=0;return this.effectiveDuration=0,"%"===o?a&&(i=e[a],i&&(l=i.effectiveDuration,this.effectiveDuration=l*(r/100))):this.effectiveDuration=r,this},Br.update=function(t={}){let e,i,s=t.tick||0,n=t.reverseTick||0,r=0,o=this.effectiveTime,a=this.effectiveDuration,l=this.reversed;l?(e=o+a,i=o,n>e?r=1:n<i&&(r=-1)):(e=o,i=o+a,s<e?r=-1:s>i&&(r=1)),a?r&&r==this.status||(this.status=r,this.doSimpleUpdate(t),t.next||(this.status=l?-1:1)):r!=this.status&&(this.status=r,this.doSimpleUpdate(t),t.next||(this.status=l?-1:1)),t.willLoop&&(this.reverseOnCycleEnd?this.reversed=!l:this.status=-1)},Br.doSimpleUpdate=function(t={}){let e,i,s,n,r,o,a,l,h,c,u,d,f,p,m=this.effectiveTime,g=this.engineActions,y=this.effectiveDuration,b=this.status,k=this.definitions,S=this.targets,O=this.action,P=this.setObj||{},v=Math.round;for(e=this.reversed?t.reverseTick-m:t.tick-m,o=y&&!b?e/y:b>0?1:0,i=0,s=k.length;i<s;i++)a=k[i],l=a.engine,c=a.effectiveStart,u=a.effectiveChange,d=a.integer,f=a.suffix,p=a.attribute,h=l.substring?g[l](c,u,o):l(c,u,o),d&&(h=v(h)),f&&(h+=f),P[p]=h;for(n=0,r=S.length;n<r;n++)S[n].set(P);this.setObj=P,O&&O()},Br.engineActions={out:function(t,e,i){return t+e+Math.cos(90*i*P)*-e},in:function(t,e,i){return t+Math.sin(90*i*P)*e},easeIn:function(t,e,i){let s=1-i;return t+e+s*s*-e},easeIn3:function(t,e,i){let s=1-i;return t+e+s*s*s*-e},easeIn4:function(t,e,i){let s=1-i;return t+e+s*s*s*s*-e},easeIn5:function(t,e,i){let s=1-i;return t+e+s*s*s*s*s*-e},easeOutIn:function(t,e,i){let s=1-i;return i<.5?t+i*i*e*2:t+e+s*s*-e*2},easeOutIn3:function(t,e,i){let s=1-i;return i<.5?t+i*i*i*e*4:t+e+s*s*s*-e*4},easeOutIn4:function(t,e,i){let s=1-i;return i<.5?t+i*i*i*i*e*8:t+e+s*s*s*s*-e*8},easeOutIn5:function(t,e,i){let s=1-i;return i<.5?t+i*i*i*i*i*e*16:t+e+s*s*s*s*s*-e*16},easeOut:function(t,e,i){return t+i*i*e},easeOut3:function(t,e,i){return t+i*i*i*e},easeOut4:function(t,e,i){return t+i*i*i*i*e},easeOut5:function(t,e,i){return t+i*i*i*i*i*e},linear:function(t,e,i){return t+i*e},easeOutSine:function(t,e,i){return t+e*rt(i)},easeInSine:function(t,e,i){return t+e*ot(i)},easeOutInSine:function(t,e,i){return t+e*at(i)},easeOutQuad:function(t,e,i){return t+e*lt(i)},easeInQuad:function(t,e,i){return t+e*ht(i)},easeOutInQuad:function(t,e,i){return t+e*ct(i)},easeOutCubic:function(t,e,i){return t+e*ut(i)},easeInCubic:function(t,e,i){return t+e*dt(i)},easeOutInCubic:function(t,e,i){return t+e*ft(i)},easeOutQuart:function(t,e,i){return t+e*pt(i)},easeInQuart:function(t,e,i){return t+e*mt(i)},easeOutInQuart:function(t,e,i){return t+e*gt(i)},easeOutQuint:function(t,e,i){return t+e*yt(i)},easeInQuint:function(t,e,i){return t+e*bt(i)},easeOutInQuint:function(t,e,i){return t+e*kt(i)},easeOutExpo:function(t,e,i){return t+e*St(i)},easeInExpo:function(t,e,i){return t+e*Ot(i)},easeOutInExpo:function(t,e,i){return t+e*Pt(i)},easeOutCirc:function(t,e,i){return t+e*vt(i)},easeInCirc:function(t,e,i){return t+e*wt(i)},easeOutInCirc:function(t,e,i){return t+e*At(i)},easeOutBack:function(t,e,i){return t+e*Ct(i)},easeInBack:function(t,e,i){return t+e*Dt(i)},easeOutInBack:function(t,e,i){return t+e*Rt(i)},easeOutElastic:function(t,e,i){return t+e*Et(i)},easeInElastic:function(t,e,i){return t+e*Ft(i)},easeOutInElastic:function(t,e,i){return t+e*Tt(i)},easeOutBounce:function(t,e,i){return t+e*Ht(i)},easeInBounce:function(t,e,i){return t+e*Mt(i)},easeOutInBounce:function(t,e,i){return t+e*It(i)}},Br.setDefinitionsValues=function(){let t,e,i,s,n=this.parseDefinitionsValue,r=this.definitions;for(t=0,e=r.length;t<e;t++)s=r[t],s&&(i=n(s.start),s.effectiveStart=i[1],s.suffix=i[0],i=n(s.end),s.effectiveEnd=i[1],J(s.engine)||(s.engine="linear"),s.effectiveChange=s.effectiveEnd-s.effectiveStart);return this},Br.parseDefinitionsValue=function(t){let e,i=["",0];return J(t)&&(t.toFixed?i[1]=t:t.substring&&(e=t.match(/^-?\d+\.?\d*(\D*)/),J(e[0])&&(i[1]=parseFloat(e)),J(e[1])&&(i[0]=e[1]))),i},Br.run=function(){let t=e[this.ticker];return t&&(this.commenceAction(),t.run(),"function"==typeof this.onRun&&this.onRun()),this},Br.isRunning=function(){let t=e[this.ticker];return!!t&&t.isRunning()},Br.halt=function(){let t=e[this.ticker];return t&&(t.halt(),"function"==typeof this.onHalt&&this.onHalt()),this},Br.reverse=function(){let t=e[this.ticker];return t&&(t.reverse(),"function"==typeof this.onReverse&&this.onReverse()),this},Br.resume=function(){let t=e[this.ticker];return t&&(t.resume(),"function"==typeof this.onResume&&this.onResume()),this},Br.seekTo=function(t){let i=e[this.ticker];return i&&(i.seekTo(t),"function"==typeof this.onSeekTo&&this.onSeekTo()),this},Br.seekFor=function(t){let i=e[this.ticker];return i&&(i.seekFor(t),"function"==typeof this.onSeekFor&&this.onSeekFor()),this};O.Tween=Tween;const jr=(t,e)=>(t=parseFloat(t),V(t)||(t=0),V(e)||(e=0),parseFloat(t.toFixed(e))),Wheel=function(t={}){return it(t.dimensions,t.width,t.height,t.radius)||(t.radius=5),this.entityInit(t),this};let Nr=Wheel.prototype=Object.create(Object.prototype);Nr.type="Wheel",Nr.lib="entity",Nr.isArtefact=!0,Nr.isAsset=!1,Nr=ee(Nr),Nr=ps(Nr);Nr.defs=_(Nr.defs,{radius:5,startAngle:0,endAngle:360,clockwise:!0,includeCenter:!1,closed:!0});Nr.getters;let Xr=Nr.setters,Yr=Nr.deltaSetters;Xr.width=function(t){if(null!=t){let e=this.dimensions;e[0]=e[1]=t,this.dimensionsHelper()}},Yr.width=function(t){let e=this.dimensions;e[0]=e[1]=addStrings(e[0],t),this.dimensionsHelper()},Xr.height=function(t){if(null!=t){let e=this.dimensions;e[0]=e[1]=t,this.dimensionsHelper()}},Yr.height=function(t){let e=this.dimensions;e[0]=e[1]=addStrings(e[0],t),this.dimensionsHelper()},Xr.dimensions=function(t,e){this.setCoordinateHelper("dimensions",t,e),this.dimensionsHelper()},Yr.dimensions=function(t,e){this.setDeltaCoordinateHelper("dimensions",t,e),this.dimensionsHelper()},Xr.radius=function(t){this.radius=t,this.radiusHelper()},Yr.radius=function(t){this.radius=addStrings(this.radius,t),this.radiusHelper()},Xr.startAngle=function(t){this.startAngle=jr(t,4),this.dirtyPathObject=!0},Yr.startAngle=function(t){this.startAngle+=jr(t,4),this.dirtyPathObject=!0},Xr.endAngle=function(t){this.endAngle=jr(t,4),this.dirtyPathObject=!0},Yr.endAngle=function(t){this.endAngle+=jr(t,4),this.dirtyPathObject=!0},Xr.closed=function(t){J(t)&&(this.closed=!!t,this.dirtyPathObject=!0)},Xr.includeCenter=function(t){J(t)&&(this.includeCenter=!!t,this.dirtyPathObject=!0)},Xr.clockwise=function(t){J(t)&&(this.clockwise=!!t,this.dirtyPathObject=!0)},Nr.dimensionsHelper=function(){let t=this.dimensions[0];t.substring?this.radius=parseFloat(t)/2+"%":this.radius=t/2,this.dirtyDimensions=!0},Nr.radiusHelper=function(){let t=this.radius,e=this.dimensions;t.substring?e[0]=e[1]=2*parseFloat(t)+"%":e[0]=e[1]=2*t,this.dirtyDimensions=!0},Nr.cleanDimensionsAdditionalActions=function(){let t=this.radius,e=this.currentDimensions,i=t.substring?parseFloat(t)/100*e[0]:t;e[0]!==2*i?(e[1]=e[0],this.currentRadius=e[0]/2):this.currentRadius=i},Nr.cleanPathObject=function(){if(this.dirtyPathObject=!1,!this.noPathUpdates||!this.pathObject){let t=this.pathObject=new Path2D,e=this.currentStampHandlePosition,i=this.currentScale,s=this.currentRadius*i,n=s-e[0]*i,r=s-e[1]*i,o=this.startAngle*P,a=this.endAngle*P;t.arc(n,r,s,o,a,!this.clockwise),this.includeCenter?(t.lineTo(n,r),t.closePath()):this.closed&&t.closePath()}};O.Wheel=Wheel;const World=function(t={}){this.makeName(t.name),this.register(),this.set(this.defs);let e=t.keytypes||{};return e.gravity||(e.gravity="Vector"),t.gravity||(t.gravity=[0,9.81,0]),t.userAttributes&&t.userAttributes.forEach(t=>{this.addAttribute(t),t.type&&(e[t.key]=t.type)}),this.initializeAttributes(e),this.set(t),this};let zr=World.prototype=Object.create(Object.prototype);zr.type="World",zr.lib="world",zr.isArtefact=!1,zr.isAsset=!1,zr=ee(zr);zr.defs=_(zr.defs,{gravity:null,tickMultiplier:1,keytypes:null}),zr.kill=function(){return this.deregister(),!0};let Gr=zr.getters,Wr=zr.setters,Vr=zr.deltaSetters;Wr.gravityX=function(t){this.gravity&&J(t)&&this.gravity.setX(t)},Wr.gravityY=function(t){this.gravity&&J(t)&&this.gravity.setY(t)},Wr.gravityZ=function(t){this.gravity&&J(t)&&this.gravity.setZ(t)},Wr.gravity=function(t){this.gravity&&J(t)&&this.gravity.set(t)},zr.addAttribute=function(t={}){let{key:e,defaultValue:i,setter:s,deltaSetter:n,getter:r}=t;return e&&e.substring&&(this.defs[e]=J(i)?i:null,this[e]=J(i)?i:null,W(s)&&(Wr[e]=s),W(n)&&(Vr[e]=n),W(r)&&(Gr[e]=r)),this},zr.removeAttribute=function(t){return t&&t.substring&&(delete this.defs[t],delete this[t],delete Gr[t],delete Wr[t],delete Vr[t]),this},zr.initializeAttributes=function(t){for(let[e,i]of Object.entries(t))switch(i){case"Quaternion":this[e]=Si();break;case"Vector":this[e]=mi();break;case"Coordinate":this[e]=He()}};O.World=World;window.scrawlEnvironmentTouchSupported=!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch),window.scrawlEnvironmentOffscreenCanvasSupported="OffscreenCanvas"in window,document.querySelectorAll("[data-stack]").forEach(t=>Ni(t)),function(){let t;document.querySelectorAll("canvas").forEach((e,i)=>{t=Yi(e),i||Wi(t)})}(),T(),be(),ce(),oe=!0,ge();var Ur={library:x,startCoreAnimationLoop:T,stopCoreAnimationLoop:function(){A=!1},currentCorePosition:le,startCoreListeners:ge,stopCoreListeners:function(){re=!1,oe=!1,me.halt(),ye("removeEventListener")},observeAndUpdate:function(t={}){if(!tt(t.event,t.origin,t.updates))return!1;let e=t.target.substring&&t.targetLibrarySection?x[t.targetLibrarySection][t.target]:t.target;if(!e)return!1;let i=t.event,s=t.origin,n=t.useNativeListener?Yt:Lt,r=t.useNativeListener?zt:$t,o=B;t.preventDefault&&(o=t=>{t.preventDefault(),t.returnValue=!1});let a=function(i){o(i);let s=!(!i||!i.target)&&i.target.id;if(s){let n=t.updates[s];if(n){let t,s=n[0],r=n[1],o=i.target.value,a=!0;switch(r){case"float":t=parseFloat(o);break;case"int":t=parseInt(o,10);break;case"round":t=Math.round(o);break;case"roundDown":t=Math.floor(o);break;case"roundUp":t=Math.ceil(o);break;case"raw":t=o;break;case"string":t=""+o;break;case"boolean":t=!!J(o)&&(o.substring?"true"===o.toLowerCase()||"false"!==o.toLowerCase()&&!!parseFloat(o):!!o);break;default:r.substring?t=`${parseFloat(o)}${r}`:a=!1}a&&("Group"===e.type?e.setArtefacts({[s]:t}):e.set({[s]:t}))}}};return n(i,a,s),function(){r(i,a,s)}},makeDragZone:function(t={}){let{zone:e,coordinateSource:i,collisionGroup:s,startOn:n,endOn:r,updateOnStart:o,updateOnEnd:a,exposeCurrentArtefact:l}=t;if(!e)return new Error("dragZone constructor - no zone supplied");if(e.substring&&(e=artefact[e]),!e||["Canvas","Stack"].indexOf(e.type)<0)return new Error("dragZone constructor - zone object is not a Stack or Canvas wrapper");let h=e.domElement;if(!h)return new Error("dragZone constructor - zone does not contain a target DOM element");if(s?s.substring&&(s=u[s]):s="Canvas"===e.type?u[e.base.name]:u[e.name],!s||"Group"!==s.type)return new Error("dragZone constructor - unable to recover collisionGroup group");if(i?i.here?i=i.here:tt(i.x,i.y)||(i=!1):i="Canvas"===e.type?e.base.here:e.here,!i)return new Error("dragZone constructor - unable to discover a usable coordinateSource object");Array.isArray(n)||(n=["down"]),Array.isArray(r)||(r=["up"]);let c=!1;U(o)&&(o=function(){c.artefact.set(t.updateOnStart)}),W(o)||(o=B),U(a)&&(a=function(){c.artefact.set(t.updateOnEnd)}),W(a)||(a=B),Y(l)||(l=!1);const d=function(t){t.cancelable&&(t.preventDefault(),t.returnValue=!1)},f=function(t){d(t);let e=t.type;"touchstart"!==e&&"touchcancel"!==e||de(t),c=s.getArtefactAt(i),c&&(c.artefact.pickupArtefact(i),o())};let p=function(t){d(t),c&&(c.artefact.dropArtefact(),a(),c=!1)};const m=function(){$t(n,f,h),$t(r,p,h)};return Lt(n,f,h),Lt(r,p,h),l?function(t=!1){if(!t)return c;m()}:m},makeComponent:function(t){let e=!!G(t.domElement)&&t.domElement,s=U(t.animationHooks)?t.animationHooks:{},n=U(t.canvasSpecs)?t.canvasSpecs:{},r=U(t.observerSpecs)?t.observerSpecs:{},o=!Y(t.includeCanvas)||t.includeCanvas;return e&&e.id&&i[e.id]?as(e,n,s,r):ls(e,n,s,r,o)},addStack:function(t={}){let e,s,n,r,o,a,l="absolute";return e=t.element&&t.element.substring?document.querySelector(t.element):G(t.element)?t.element:document.createElement("div"),t.host&&t.host.substring?(s=document.querySelector(t.host),s||(s=document.body)):s=G(t.host)?t.host:J(e.parentElement)?e.parentElement:document.body,J(t.width)&&(e.style.width=t.width.toFixed?t.width+"px":t.width),J(t.height)&&(e.style.height=t.height.toFixed?t.height+"px":t.height),a=t.name||e.id||e.getAttribute("name")||"",a||(a=N()),e.id=a,e.setAttribute("data-stack","data-stack"),s&&null!=s.getAttribute("data-stack")?(n=i[s.id],o=n?n.name:"root"):o="root",e.setAttribute("data-group",o),"root"===o&&(l="relative"),e.parentElement&&s.id===e.parentElement.id||s.appendChild(e),r=Ii({name:a,domElement:e,group:o,host:o,position:l,setInitialDimensions:!0}),Xi(e,a),Array.from(e.childNodes).forEach(t=>{t.id&&Bi.indexOf(t.id)>=0&&K(Bi,t.id)}),delete t.name,delete t.element,delete t.host,delete t.width,delete t.height,r.set(t),ji=!0,r},getStack:function(t){let e,i=document.querySelector(t);return i&&(e=Ni(i)),e},addCanvas:function(t={}){let e=document.createElement("canvas"),s=t.name?t.name:N(),n=t.host,r="root",o=t.width||300,a=t.height||150,l="relative";if(n.substring){let t=i[n];!t&&n?(n=document.querySelector(n),n&&(r=n.id)):n=t}n?"Stack"===n.type?(r=n.name,l="absolute",n=n.domElement):G(n)||(n=document.body):n=document.body,e.id=s,e.setAttribute("data-group",r),e.width=o,e.height=a,e.style.position=l,n.appendChild(e);let h=Ci({name:s,domElement:e,group:r,host:r,position:l,setInitialDimensions:!1,setAsCurrentCanvas:!J(t.setAsCurrentCanvas)||t.setAsCurrentCanvas,trackHere:J(t.trackHere)?t.trackHere:"subscribe"});return delete t.group,delete t.host,delete t.name,delete t.element,delete t.position,delete t.setInitialDimensions,delete t.setAsCurrentCanvas,delete t.trackHere,h.set(t),h},getCanvas:function(t){let e=document.querySelector(t),i=!1;return e&&(i=Yi(e)),Wi(i),i},setCurrentCanvas:Wi,clear:Vi,compile:Ui,show:qi,render:function(...t){return _i(t),Zi("render")},addListener:Lt,removeListener:$t,addNativeListener:Yt,removeNativeListener:zt,makeAnimationObserver:Bt,reducedMotionActions:_t,setReduceMotionAction:t=>Ut=t,setNoPreferenceMotionAction:t=>qt=t,colorSchemeActions:te,setColorSchemeDarkAction:t=>Kt=t,setColorSchemeLightAction:t=>Jt=t,makeAction:function(t){return new Action(t)},makeAnimation:se,makeBezier:function(t={}){return t.species="bezier",new Bezier(t)},makeBlock:function(t){return new Block(t)},makeCog:function(t={}){return t.species="cog",new Cog(t)},makeColor:Ts,requestCoordinate:Fe,releaseCoordinate:Te,makeEmitter:function(t){return new Emitter(t)},makeFilter:function(t){return new Filter(t)},makeForce:_s,makeGradient:function(t){return new Gradient(t)},makeGrid:function(t){return new Grid(t)},makeGroup:ci,importImage:je,importDomImage:Ne,createImageFromCell:function(t,e=!1){let i=t.substring?a[t]||o[t]:t;"Canvas"===i.type&&(i=i.base),"Cell"===i.type&&(i.stashOutput=!0,e&&(i.stashOutputAsAsset=!0))},createImageFromGroup:function(t,e=!1){let i;t&&!t.substring?"Group"===t.type?i=t:"Cell"===t.type?i=u[t.name]:"Canvas"===t.type&&(i=u[t.base.name]):t&&t.substring&&(i=u[t]),i&&(i.stashOutput=!0,e&&(i.stashOutputAsAsset=!0))},createImageFromEntity:function(t,e=!1){let s=t.substring?i[t]:t;s.isArtefact&&(s.stashOutput=!0,e&&(s.stashOutputAsAsset=!0))},makeLine:function(t={}){return t.species="line",new Line(t)},makeLoom:function(t){return new Loom(t)},makeMesh:function(t){return new hn(t)},makeNet:function(t){return new Net(t)},makeNoise:function(t){return new kn(t)},makeOval:function(t={}){return t.species="oval",new Oval(t)},makePattern:function(t){return new Pattern(t)},makePhrase:function(t){return new Phrase(t)},makePicture:function(t){return new Picture(t)},makePolygon:function(t={}){return t.species="polygon",new Polygon(t)},makePolyline:function(t={}){return t.species="polyline",new Polyline(t)},makeQuadratic:function(t={}){return t.species="quadratic",new Quadratic(t)},requestQuaternion:bi,releaseQuaternion:ki,makeRadialGradient:function(t){return new RadialGradient(t)},makeRectangle:function(t={}){return t.species="rectangle",new Rectangle(t)},makeRender:rs,makeShape:function(t){return new Shape(t)},makeSpiral:function(t={}){return t.species="spiral",new Spiral(t)},makeSpring:mn,importSprite:Hn,makeStar:function(t={}){return t.species="star",new Star(t)},makeTetragon:function(t={}){return t.species="tetragon",new Tetragon(t)},makeTicker:Hr,makeTracer:function(t){return new Tracer(t)},makeTween:function(t){return new Tween(t)},requestVector:fi,releaseVector:pi,importDomVideo:function(t){let e=/.*\/(.*?)\./;document.querySelectorAll(t).forEach(t=>{let i;if("VIDEO"===t.tagName.toUpperCase()){if(t.id||t.name)i=t.id||t.name;else{let s=e.exec(t.src);i=s&&s[1]?s[1]:""}let s=En({name:i,source:t});t.readyState<=2&&(t.oncanplay=()=>{s.set({source:t})})}})},importVideo:Rn,importMediaStream:function(t={}){let e={};e.audio=!J(t.audio)||t.audio,e.video={};let i=e.video.width={};t.minWidth&&(i.min=t.minWidth),t.maxWidth&&(i.max=t.maxWidth),i.ideal=t.width?t.width:1280;let s=e.video.height={};t.minHeight&&(s.min=t.minHeight),t.maxHeight&&(s.max=t.maxHeight),s.ideal=t.height?t.height:720,t.facing&&(e.video.facingMode=t.facing);let n=t.name||N(),r=document.createElement("video"),o=En({name:n,source:r});return new Promise((t,i)=>{navigator&&navigator.mediaDevices?navigator.mediaDevices.getUserMedia(e).then(e=>{let i,s=e.getVideoTracks();Array.isArray(s)&&s[0]&&(i=s[0].getConstraints()),r.id=o.name,i&&(r.width=i.width,r.height=i.height),r.srcObject=e,r.onloadedmetadata=function(t){r.play()},t(o)}).catch(e=>{console.log(e.message),t(o)}):i("Navigator.mediaDevices object not found")})},makeWheel:function(t){return new Wheel(t)},makeWorld:function(t){return new World(t)}};export default Ur;
